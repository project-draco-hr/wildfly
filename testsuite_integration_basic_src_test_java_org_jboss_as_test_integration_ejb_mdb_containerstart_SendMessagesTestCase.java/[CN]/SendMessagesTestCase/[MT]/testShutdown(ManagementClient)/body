{
  Connection connection=null;
  try {
    deployer.deploy("mdb");
    ConnectionFactory cf=(ConnectionFactory)ctx.lookup("jms/RemoteConnectionFactory");
    Queue queue=(Queue)ctx.lookup(QUEUE_SEND);
    connection=cf.createConnection("guest","guest");
    Session session=connection.createSession(false,Session.AUTO_ACKNOWLEDGE);
    Queue replyQueue=session.createTemporaryQueue();
    MessageProducer sender=session.createProducer(queue);
    MessageConsumer receiver=session.createConsumer(replyQueue);
    connection.start();
    Set<String> expected=new TreeSet<String>();
    sendMessage(session,sender,replyQueue,"await");
    expected.add("Reply: await");
    int awaitInt=awaitSingleton("first test");
    log.debug("testsuite: awaitSingleton() returned: " + awaitInt);
    Future<?> undeployed=executor.submit(undeployTask());
    Thread.sleep(THREAD_WAIT_MS);
    for (int i=0; i < 50; i++) {
      String msg="Do not lose! (" + i + ")";
      sendMessage(session,sender,replyQueue,msg);
      expected.add("Reply: " + msg);
    }
    undeployed.get(UNDEPLOYED_WAIT_S,SECONDS);
    final ModelNode deployAddr=new ModelNode();
    deployAddr.get(ClientConstants.OP_ADDR).add("deployment",MBEAN + ".jar");
    deployAddr.get(ClientConstants.OP).set("deploy");
    applyUpdate(deployAddr,managementClient.getControllerClient());
    for (int i=0; i < 10; i++) {
      String msg="Some more (" + i + ")";
      sendMessage(session,sender,replyQueue,msg);
      expected.add("Reply: " + msg);
    }
    log.debug("Some more messages sent");
    Set<String> received=new TreeSet<String>();
    for (int i=0; i < (1 + 50 + 10+ 1); i++) {
      Message msg=receiver.receive(SECONDS.toMillis(RECEIVE_WAIT_S));
      assertNotNull("did not receive message " + i,msg);
      String text=((TextMessage)msg).getText();
      received.add(text);
      log.info(i + ": " + text);
    }
    assertNull(receiver.receiveNoWait());
    assertEquals(expected,received);
  }
  finally {
    if (connection != null) {
      connection.close();
    }
    deployer.undeploy("mdb");
  }
}
