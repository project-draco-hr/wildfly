{
  Deployment deployment=DeploymentAttachment.getDeploymentAttachment(context);
  BundleInfo info=BundleInfoAttachment.getBundleInfoAttachment(context);
  if (deployment == null && info != null) {
    deployment=DeploymentFactory.createDeployment(info);
    deployment.addAttachment(BundleInfo.class,info);
    DeploymentAttachment.attachDeployment(context,deployment);
  }
  OSGiMetaData metadata=OSGiMetaDataAttachment.getOSGiMetaDataAttachment(context);
  if (deployment == null && metadata != null) {
    VirtualFile virtualFile=VirtualFileAttachment.getVirtualFileAttachment(context);
    String location=virtualFile.getPathName();
    String symbolicName=metadata.getBundleSymbolicName();
    Version version=metadata.getBundleVersion();
    deployment=DeploymentFactory.createDeployment(AbstractVFS.adapt(virtualFile),location,symbolicName,version);
    deployment.addAttachment(OSGiMetaData.class,metadata);
    DeploymentAttachment.attachDeployment(context,deployment);
  }
  XModule resModule=XModuleAttachment.getXModuleAttachment(context);
  if (deployment == null && resModule != null) {
    VirtualFile virtualFile=VirtualFileAttachment.getVirtualFileAttachment(context);
    String location=virtualFile.getPathName();
    String symbolicName=resModule.getName();
    Version version=resModule.getVersion();
    deployment=DeploymentFactory.createDeployment(AbstractVFS.adapt(virtualFile),location,symbolicName,version);
    deployment.addAttachment(XModule.class,resModule);
    DeploymentAttachment.attachDeployment(context,deployment);
  }
  if (deployment != null) {
    MountHandle mount=context.getAttachment(MountHandle.ATTACHMENT_KEY);
    deployment.addAttachment(MountHandle.class,mount);
    OSGiDeploymentService.addService(context);
  }
}
