{
  final PatchContentLoader loader=PatchContentLoader.create(workDir);
  final PatchContentProvider provider=new PatchContentProvider(){
    @Override public PatchContentLoader getLoader(    String patchId){
      return loader;
    }
    @Override public void cleanup(){
    }
  }
;
  try {
    final File patchXml=new File(workDir,PatchXml.PATCH_XML);
    final InputStream patchIS=new FileInputStream(patchXml);
    final Patch patch;
    try {
      patch=PatchXml.parse(patchIS);
      patchIS.close();
    }
  finally {
      safeClose(patchIS);
    }
    final InstallationManager.InstallationModification modification=manager.modifyInstallation(runner);
    return runner.applyPatch(patch,provider,policy,modification);
  }
 catch (  Exception e) {
    throw IdentityPatchRunner.rethrowException(e);
  }
}
