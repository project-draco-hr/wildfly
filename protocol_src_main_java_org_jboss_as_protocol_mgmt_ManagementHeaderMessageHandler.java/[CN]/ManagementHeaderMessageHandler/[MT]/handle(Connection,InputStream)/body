{
  final ManagementRequestHeader requestHeader;
  final MessageHandler handler;
  ByteDataInput input=null;
  int workingVersion=1;
  int responseId=ManagementProtocol.REMOTE_EXCEPTION;
  try {
    input=new SimpleByteDataInput(dataStream);
    requestHeader=new ManagementRequestHeader(input);
    workingVersion=Math.min(ManagementProtocol.VERSION,requestHeader.getVersion());
    byte handlerId=requestHeader.getOperationHandlerId();
    if (handlerId == -1) {
      throw new IOException("Management request failed.  Invalid handler id");
    }
    handler=getHandlerForId(handlerId);
    if (handler == null) {
      String msg="Management request failed.  No handler found for id " + handlerId;
      throw new IOException(msg);
    }
    connection.setMessageHandler(handler);
    responseId=requestHeader.getRequestId();
  }
 catch (  IOException e) {
    throw e;
  }
catch (  Throwable t) {
    throw new IOException("Failed to read request header",t);
  }
 finally {
    safeClose(input);
    safeClose(dataStream);
    writeResponseHeader(connection,workingVersion,responseId);
  }
}
