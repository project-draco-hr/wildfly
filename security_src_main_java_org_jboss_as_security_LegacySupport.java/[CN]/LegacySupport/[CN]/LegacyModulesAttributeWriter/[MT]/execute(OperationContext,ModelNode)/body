{
  Resource existing=context.readResource(PathAddress.EMPTY_ADDRESS);
  OperationStepHandler addHandler=context.getResourceRegistration().getSubModel(PathAddress.EMPTY_ADDRESS.append(newKeyName)).getOperationHandler(PathAddress.EMPTY_ADDRESS,"add");
  List<ModelNode> modules=new ArrayList<ModelNode>(operation.get(VALUE).asList());
  Collections.reverse(modules);
  for (  ModelNode module : modules) {
    ModelNode addModuleOp=module.clone();
    String code=addModuleOp.get(Constants.CODE).asString();
    PathElement relativePath=PathElement.pathElement(newKeyName,code);
    PathAddress address=PathAddress.pathAddress(operation.get(OP_ADDR)).append(relativePath);
    addModuleOp.get(OP_ADDR).set(address.toModelNode());
    addModuleOp.get(OP).set(ADD);
    context.addStep(addModuleOp,addHandler,OperationContext.Stage.IMMEDIATE);
  }
  for (  Resource.ResourceEntry entry : existing.getChildren(newKeyName)) {
    PathAddress address=PathAddress.pathAddress(operation.get(OP_ADDR)).append(entry.getPathElement());
    ModelNode removeModuleOp=Util.createRemoveOperation(address);
    context.addStep(removeModuleOp,new SecurityDomainReloadRemoveHandler(),OperationContext.Stage.IMMEDIATE);
  }
  context.stepCompleted();
}
