{
  if (deploymentUnit.getParent() != null) {
    deploymentUnit=deploymentUnit.getParent();
  }
synchronized (deploymentUnit) {
    Map<String,PersistenceProviderAdaptor> map=deploymentUnit.getAttachment(providerAdaptorMapKey);
    PersistenceProviderAdaptor current=map.get(adaptorModule);
    if (current == null) {
      map.put(adaptorModule,adaptor);
      current=adaptor;
    }
    return current;
  }
}
