{
  final ModuleLoader moduleLoader=Module.getBootModuleLoader();
  PersistenceProviderAdaptor persistenceProviderAdaptor=null;
  if (adapterModule == null) {
    adapterModule=Configuration.ADAPTER_MODULE_DEFAULT;
  }
  if (persistenceProviderClass == null) {
    persistenceProviderClass=Configuration.PROVIDER_CLASS_DEFAULT;
  }
  try {
    Module module=moduleLoader.loadModule(ModuleIdentifier.fromString(adapterModule));
    final ServiceLoader<PersistenceProviderAdaptor> serviceLoader=module.loadService(PersistenceProviderAdaptor.class);
    if (serviceLoader != null) {
      for (      PersistenceProviderAdaptor adaptor : serviceLoader) {
        if (persistenceProviderAdaptor != null) {
          throw new DeploymentUnitProcessingException("persistence provider adapter module has more than one adapters " + adapterModule);
        }
        persistenceProviderAdaptor=adaptor;
        log.debugf("loaded persistence provider adapter %s",adapterModule);
      }
      if (persistenceProviderAdaptor != null) {
        persistenceProviderAdaptor.setJtaManager(JtaManagerImpl.getInstance());
        PersistenceProviderAdapterRegistry.putPersistenceProviderAdaptor(persistenceProviderClass,persistenceProviderAdaptor);
        PersistenceProviderAdapterRegistry.putPersistenceProviderAdaptor(persistenceProviderClass,adapterModule,persistenceProviderAdaptor);
      }
    }
  }
 catch (  ModuleLoadException e) {
    throw new DeploymentUnitProcessingException("persistence provider adapter module load error" + adapterModule + "(class "+ persistenceProviderClass+ ")",e);
  }
  return persistenceProviderAdaptor;
}
