{
  if (puList.size() > 0) {
    final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
    final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
    final EEModuleDescription eeModuleDescription=deploymentUnit.getAttachment(org.jboss.as.ee.component.Attachments.EE_MODULE_DESCRIPTION);
    final Collection<ComponentDescription> components=eeModuleDescription.getComponentDescriptions();
    if (module == null)     throw MESSAGES.failedToGetModuleAttachment(phaseContext.getDeploymentUnit());
    final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
    final ModuleClassLoader classLoader=module.getClassLoader();
    PersistenceProviderDeploymentHolder persistenceProviderDeploymentHolder=deploymentUnit.getAttachment(JpaAttachments.DEPLOYED_PERSISTENCE_PROVIDER);
    if (persistenceProviderDeploymentHolder == null && deploymentUnit.getParent() != null) {
      persistenceProviderDeploymentHolder=deploymentUnit.getParent().getAttachment(JpaAttachments.DEPLOYED_PERSISTENCE_PROVIDER);
    }
    for (    PersistenceUnitMetadataHolder holder : puList) {
      setAnnotationIndexes(holder,deploymentUnit);
      for (      PersistenceUnitMetadata pu : holder.getPersistenceUnits()) {
        String jpaContainerManaged=pu.getProperties().getProperty(Configuration.JPA_CONTAINER_MANAGED);
        boolean deployPU=(jpaContainerManaged == null ? true : Boolean.parseBoolean(jpaContainerManaged));
        if (deployPU) {
          deployPersistenceUnit(phaseContext,deploymentUnit,eeModuleDescription,components,serviceTarget,classLoader,persistenceProviderDeploymentHolder,pu);
        }
 else {
          JPA_LOGGER.tracef("persistence unit %s in deployment %s is not container managed (%s is set to false)",pu.getPersistenceUnitName(),deploymentUnit.getName(),Configuration.JPA_CONTAINER_MANAGED);
        }
      }
    }
  }
}
