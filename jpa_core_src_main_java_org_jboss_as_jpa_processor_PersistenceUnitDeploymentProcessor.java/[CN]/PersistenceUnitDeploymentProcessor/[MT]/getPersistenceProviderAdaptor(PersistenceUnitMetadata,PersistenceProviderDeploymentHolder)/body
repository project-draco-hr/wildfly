{
  String adaptorModule=pu.getProperties().getProperty(Configuration.ADAPTER_MODULE);
  PersistenceProviderAdaptor adaptor=null;
  if (persistenceProviderDeploymentHolder != null) {
    adaptor=persistenceProviderDeploymentHolder.getAdapter();
  }
  if (adaptor == null) {
    try {
      if (adaptorModule == null && (pu.getPersistenceProviderClassName() == null || pu.getPersistenceProviderClassName().equals(Configuration.PROVIDER_CLASS_DEFAULT))) {
        adaptorModule=Configuration.ADAPTER_MODULE_DEFAULT;
      }
      adaptor=PersistenceProviderAdaptorLoader.loadPersistenceAdapterModule(adaptorModule);
    }
 catch (    ModuleLoadException e) {
      throw new DeploymentUnitProcessingException("persistence provider adapter module load error " + adaptorModule,e);
    }
  }
  if (adaptor == null) {
    throw MESSAGES.failedToGetAdapter(pu.getPersistenceProviderClassName());
  }
  return adaptor;
}
