{
  boolean completeStepCalled=false;
  try {
    context.completeStep(new OperationContext.ResultHandler(){
      @Override public void handleResult(      OperationContext.ResultAction resultAction,      OperationContext context,      ModelNode operation){
        boolean txCompleted=false;
        try {
          ModelController.OperationTransaction tx=txRef.get();
          try {
            if (resultAction == OperationContext.ResultAction.KEEP) {
              tx.commit();
            }
 else {
              tx.rollback();
            }
          }
  finally {
            txCompleted=true;
          }
        }
  finally {
          if (!txCompleted && txRef.get() != null) {
            txRef.get().rollback();
          }
        }
      }
    }
);
    completeStepCalled=true;
  }
  finally {
    if (!completeStepCalled && txRef.get() != null) {
      txRef.get().rollback();
    }
  }
}
