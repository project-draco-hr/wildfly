{
  InetAddress callbackAddress=ourAddress;
  if (ourAddress.isAnyLocalAddress()) {
    byte[] masterBytes=master.getAddress();
    callbackAddress=null;
    InetAddress first=null;
    InetAddress firstPublic=null;
    InetAddress mostBytes=null;
    int byteMatch=8;
    try {
      for (Enumeration<NetworkInterface> e=NetworkInterface.getNetworkInterfaces(); e.hasMoreElements(); ) {
        NetworkInterface intf=e.nextElement();
        try {
          if (!intf.isUp() || !master.isReachable(intf,0,5000))           continue;
        }
 catch (        IOException e1) {
          continue;
        }
        for (Enumeration<InetAddress> ea=intf.getInetAddresses(); ea.hasMoreElements(); ) {
          InetAddress addr=ea.nextElement();
          if (first == null)           first=addr;
          if (firstPublic == null && !addr.isLoopbackAddress()) {
            firstPublic=addr;
          }
          byte[] addrBytes=addr.getAddress();
          if (addrBytes.length == masterBytes.length) {
            int i=0;
            for (; i < addrBytes.length; i++) {
              if (addrBytes[i] != masterBytes[i])               break;
            }
            if (i > byteMatch) {
              byteMatch=i;
              mostBytes=addr;
            }
          }
        }
      }
    }
 catch (    SocketException e) {
    }
    if (callbackAddress == null) {
      callbackAddress=mostBytes != null ? mostBytes : (firstPublic != null ? firstPublic : first);
    }
    if (callbackAddress == null) {
      try {
        callbackAddress=InetAddress.getLocalHost();
      }
 catch (      UnknownHostException e) {
        throw new RuntimeException(e);
      }
    }
  }
  return callbackAddress;
}
