{
  Security.addProvider(saslProvider);
  txOperationHandler=new TransactionalModelControllerOperationHandler(executor,controller);
  ProtocolChannelClient<ManagementChannel> client;
  try {
    ProtocolChannelClient.Configuration<ManagementChannel> configuration=new ProtocolChannelClient.Configuration<ManagementChannel>();
    configuration.setEndpoint(endpointInjector.getValue());
    configuration.setUri(new URI("remote://" + host.getHostAddress() + ":"+ port));
    configuration.setChannelFactory(new ManagementChannelFactory(txOperationHandler));
    client=ProtocolChannelClient.create(configuration);
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  try {
    CallbackHandler handler=null;
    CallbackHandlerFactory handlerFactory=callbackFactoryInjector.getOptionalValue();
    if (handlerFactory != null) {
      handler=handlerFactory.getCallbackHandler(name);
    }
    client.connect(handler);
    this.channelClient=client;
    if (connected.get()) {
      unregister();
    }
    ManagementChannel channel=client.openChannel(RemotingServices.DOMAIN_CHANNEL);
    this.channel=channel;
    channel.addCloseHandler(new CloseHandler<Channel>(){
      public void handleClose(      final Channel closed,      final IOException exception){
        connectionClosed();
      }
    }
);
    channel.startReceiving();
    masterProxy=new ExistingChannelModelControllerClient(channel);
  }
 catch (  IOException e) {
    log.warnf("Could not connect to remote domain controller %s:%d",host.getHostAddress(),port);
    e.printStackTrace();
    throw new IllegalStateException(e);
  }
  try {
    final String error=new RegisterModelControllerRequest().executeForResult(executor,ManagementClientChannelStrategy.create(channel));
    if (error != null) {
      throw new Exception(error);
    }
  }
 catch (  Exception e) {
    log.warnf("Error retrieving domain model from remote domain controller %s:%d: %s",host.getHostAddress(),port,e.getMessage());
    throw new IllegalStateException(e);
  }
}
