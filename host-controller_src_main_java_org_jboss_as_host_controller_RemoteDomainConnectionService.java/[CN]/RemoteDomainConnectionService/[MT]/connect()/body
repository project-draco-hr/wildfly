{
  ProtocolChannelClient<ManagementChannel> client;
  ProtocolChannelClient.Configuration<ManagementChannel> configuration=new ProtocolChannelClient.Configuration<ManagementChannel>();
  configuration.setEndpointName("endpoint");
  configuration.setUriScheme("remote");
  this.handler=new TransactionalModelControllerOperationHandler(controller,executor);
  try {
    configuration.setUri(new URI("remote://" + host.getHostAddress() + ":"+ port));
    configuration.setChannelFactory(new ManagementChannelFactory(null));
    client=ProtocolChannelClient.create(configuration);
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  try {
    CallbackHandler handler=null;
    CallbackHandlerFactory handlerFactory=callbackFactoryInjector.getOptionalValue();
    if (handlerFactory != null) {
      handler=handlerFactory.getCallbackHandler(name);
    }
    client.connect(handler);
    this.channelClient=client;
    channel=client.openChannel(ManagementRemotingServices.DOMAIN_CHANNEL);
    channel.addCloseHandler(new CloseHandler<Channel>(){
      public void handleClose(      final Channel closed,      final IOException exception){
        connectionClosed();
      }
    }
);
    channel.receiveMessage(ManagementChannelReceiver.createDelegating(this.handler));
    masterProxy=new ExistingChannelModelControllerClient(channel);
  }
 catch (  IOException e) {
    log.warnf("Could not connect to remote domain controller %s:%d",host.getHostAddress(),port);
    throw new IllegalStateException(e);
  }
  SlaveRegistrationError error=null;
  try {
    error=new RegisterModelControllerRequest().executeForResult(handler,channel,null);
  }
 catch (  Exception e) {
    log.warnf("Error retrieving domain model from remote domain controller %s:%d: %s",host.getHostAddress(),port,e.getMessage());
    throw new IllegalStateException(e);
  }
  if (error != null) {
    if (error.getErrorCode() == ErrorCode.HOST_ALREADY_EXISTS) {
      throw new HostAlreadyExistsException(error.getErrorMessage());
    }
    throw new IllegalStateException(error.getErrorMessage());
  }
}
