{
  addCloseHandler(request,responseHandler);
  responseReceiver.registerResponseHandler(request.getCurrentRequestId(),responseHandler);
  final FlushableDataOutputImpl output=FlushableDataOutputImpl.create(this.writeMessage());
  try {
    final ManagementRequestHeader managementRequestHeader=new ManagementRequestHeader(ManagementProtocol.VERSION,request.getCurrentRequestId(),request.getBatchId(),request.getRequestCode());
    managementRequestHeader.write(output);
    request.writeRequest(this,output);
  }
 catch (  Exception e) {
    responseHandler.removeCloseHandler();
    if (e instanceof RuntimeException)     throw (RuntimeException)e;
    if (e instanceof IOException)     throw (IOException)e;
    throw new IOException(e);
  }
 finally {
    IoUtils.safeClose(output);
  }
}
