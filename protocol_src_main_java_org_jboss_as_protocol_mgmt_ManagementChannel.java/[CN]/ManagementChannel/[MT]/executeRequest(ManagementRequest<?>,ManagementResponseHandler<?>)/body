{
  responseReceiver.registerResponseHandler(request.getCurrentRequestId(),responseHandler);
  final FlushableDataOutputImpl output=FlushableDataOutputImpl.create(this.writeMessage());
  try {
    final CloseHandler<Channel> closeHandler=request.getRequestCloseHandler();
    if (closeHandler != null) {
      final Key closeKey=addCloseHandler(closeHandler);
      request.setCloseKey(closeKey);
    }
    final ManagementRequestHeader managementRequestHeader=new ManagementRequestHeader(ManagementProtocol.VERSION,request.getCurrentRequestId(),request.getBatchId(),request.getRequestCode());
    managementRequestHeader.write(output);
    request.writeRequest(this,output);
  }
  finally {
    IoUtils.safeClose(output);
  }
}
