{
  responseReceiver.registerResponseHandler(request.getCurrentRequestId(),responseHandler);
  FlushableDataOutputImpl output=FlushableDataOutputImpl.create(this.writeMessage());
  Key closeKey=null;
  try {
    CloseHandler<Channel> closeHandler=request.getRequestCloseHandler();
    if (closeHandler != null) {
      closeKey=addCloseHandler(closeHandler);
    }
    final ManagementRequestHeader managementRequestHeader=new ManagementRequestHeader(ManagementProtocol.VERSION,request.getCurrentRequestId(),request.getBatchId(),request.getRequestCode());
    managementRequestHeader.write(output);
    request.writeRequest(this,output);
  }
  finally {
    IoUtils.safeClose(output);
    if (closeKey != null) {
      closeKey.remove();
    }
  }
}
