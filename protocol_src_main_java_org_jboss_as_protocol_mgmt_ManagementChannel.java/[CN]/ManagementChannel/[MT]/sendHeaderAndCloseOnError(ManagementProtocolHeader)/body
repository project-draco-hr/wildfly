{
  boolean ok=false;
  try {
    SimpleDataOutput out=new SimpleDataOutput(Marshalling.createByteOutput(writeMessage()));
    try {
      header.write(out);
      ok=true;
    }
  finally {
      IoUtils.safeClose(out);
    }
  }
 catch (  IOException ingore) {
  }
 finally {
    if (!ok) {
      log.tracef("Error sending %X on %s, closing channel",header.getType(),this);
      IoUtils.safeClose(this);
    }
  }
}
