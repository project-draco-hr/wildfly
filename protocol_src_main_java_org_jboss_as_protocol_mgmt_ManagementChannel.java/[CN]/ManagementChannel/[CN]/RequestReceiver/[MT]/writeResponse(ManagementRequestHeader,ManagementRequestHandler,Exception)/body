{
  ROOT_LOGGER.tracef("%s writing response %d",ManagementChannel.this,requestHeader.getBatchId());
  final FlushableDataOutputImpl output;
  try {
    output=FlushableDataOutputImpl.create(writeMessage());
  }
 catch (  Exception e) {
    ROOT_LOGGER.tracef(e,"%s could not open output stream for request %d",ManagementChannel.this,requestHeader.getBatchId());
    return;
  }
  try {
    writeResponseHeader(requestHeader,output,error);
    if (error == null && requestHandler != null) {
      requestHandler.writeResponse(output);
    }
    output.writeByte(ManagementProtocol.RESPONSE_END);
  }
 catch (  Exception e) {
    ROOT_LOGGER.tracef(e,"%s finished writing response %d with error",ManagementChannel.this,requestHeader.getBatchId());
  }
 finally {
    ROOT_LOGGER.tracef("%s finished writing response %d",ManagementChannel.this,requestHeader.getBatchId());
    IoUtils.safeClose(output);
  }
}
