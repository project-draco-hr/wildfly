{
  log.tracef("%s handling request %d(%d)",ManagementChannel.this,header.getBatchId());
  final FlushableDataOutputImpl output=FlushableDataOutputImpl.create(writeMessage());
  Exception error=null;
  try {
    final ManagementRequestHandler requestHandler;
    try {
      requestHandler=getRequestHandler(header);
      requestHandler.setContext(new ManagementRequestContext(ManagementChannel.this,header));
      requestHandler.readRequest(input);
      expectHeader(input,ManagementProtocol.REQUEST_END);
    }
 catch (    Exception e) {
      error=e;
      throw e;
    }
 finally {
      writeResponseHeader(header,output,error);
      if (error != null) {
        output.writeByte(ManagementProtocol.RESPONSE_END);
      }
    }
    requestHandler.writeResponse(output);
    output.writeByte(ManagementProtocol.RESPONSE_END);
  }
 catch (  Exception e) {
    throwFormattedException(e);
  }
 finally {
    log.tracef("%s finished request %d",ManagementChannel.this);
    IoUtils.safeClose(output);
  }
}
