{
  TransactionSynchronizationRegistry txSyncRegistry=(TransactionSynchronizationRegistry)lookup(TRANSACTION_SYNCHRONIZATION_REGISTRY_LOOKUP);
  boolean inTx=txSyncRegistry.getTransactionStatus() == Status.STATUS_ACTIVE;
  if (inTx) {
    Object resource=txSyncRegistry.getResource(TRANSACTION_KEY);
    if (resource != null) {
      return (JMSContext)resource;
    }
 else {
      final JMSContext transactedContext=create(info,inTx);
      txSyncRegistry.putResource(TRANSACTION_KEY,transactedContext);
      txSyncRegistry.registerInterposedSynchronization(new Synchronization(){
        @Override public void beforeCompletion(){
        }
        @Override public synchronized void afterCompletion(        int status){
          transactedContext.close();
          inTransaction=false;
        }
      }
);
      return transactedContext;
    }
  }
 else {
    if (delegate == null) {
      try {
        delegate=create(info,inTx);
      }
 catch (      Exception e) {
        throw new RuntimeException(e);
      }
    }
    return delegate;
  }
}
