{
  Throwable error=null;
  final boolean readOnly=true;
  boolean shouldAuditLog=false;
  try {
    Set<ObjectInstance> result=new HashSet<ObjectInstance>();
    if (delegates.size() > 0) {
      for (      MBeanServerPlugin delegate : delegates) {
        if (name == null || (name.getDomain() != null && delegate.accepts(name))) {
          if (!delegate.shouldAuthorize() || authorizeSensitiveOperation(QUERY_MBEANS,true,false)) {
            result.addAll(delegate.queryMBeans(name,query));
            if (delegate.shouldAuditLog()) {
              shouldAuditLog=true;
            }
          }
        }
      }
    }
    if (!rootMBeanServer.shouldAuthorize() || authorizeSensitiveOperation(QUERY_MBEANS,true,false)) {
      result.addAll(rootMBeanServer.queryMBeans(name,query));
      shouldAuditLog=true;
    }
    return result;
  }
 catch (  Exception e) {
    error=e;
    throw makeRuntimeException(e);
  }
 finally {
    if (error != null || shouldAuditLog) {
      new MBeanServerAuditLogRecordFormatter(this,error,readOnly).queryMBeans(name,query);
    }
  }
}
