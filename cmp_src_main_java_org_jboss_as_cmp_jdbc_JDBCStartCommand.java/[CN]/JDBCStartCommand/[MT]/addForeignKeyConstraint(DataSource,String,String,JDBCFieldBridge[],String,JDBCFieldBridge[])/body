{
  if (!manager.hasCreateTable(tableName)) {
    return;
  }
  JDBCFunctionMappingMetaData fkConstraint=manager.getMetaData().getTypeMapping().getFkConstraintTemplate();
  if (fkConstraint == null) {
    throw new IllegalStateException("Foreign key constraint is not allowed for this type of datastore");
  }
  String a=SQLUtil.getColumnNamesClause(fields,new StringBuffer(50)).toString();
  String b=SQLUtil.getColumnNamesClause(referencesFields,new StringBuffer(50)).toString();
  String[] args=new String[]{tableName,SQLUtil.fixConstraintName("fk_" + tableName + "_"+ cmrFieldName,dataSource),a,referencesTableName,b};
  String sql=fkConstraint.getFunctionSql(args,new StringBuffer(100)).toString();
  TransactionManager tm=manager.getComponent().getTransactionManager();
  Transaction oldTransaction;
  try {
    oldTransaction=tm.suspend();
  }
 catch (  Exception e) {
    throw new RuntimeException(COULDNT_SUSPEND + "alter table create foreign key.",e);
  }
  try {
    Connection con=null;
    Statement statement=null;
    try {
      if (log.isDebugEnabled()) {
        log.debug("Executing SQL: " + sql);
      }
      con=dataSource.getConnection();
      statement=con.createStatement();
      statement.executeUpdate(sql);
    }
  finally {
      JDBCUtil.safeClose(statement);
      JDBCUtil.safeClose(con);
    }
  }
 catch (  Exception e) {
    log.warn("Could not add foreign key constraint: table=" + tableName);
    throw new RuntimeException("Error while adding foreign key constraint",e);
  }
 finally {
    try {
      if (oldTransaction != null) {
        tm.resume(oldTransaction);
      }
    }
 catch (    Exception e) {
      throw new RuntimeException(COULDNT_REATTACH + "create table");
    }
  }
}
