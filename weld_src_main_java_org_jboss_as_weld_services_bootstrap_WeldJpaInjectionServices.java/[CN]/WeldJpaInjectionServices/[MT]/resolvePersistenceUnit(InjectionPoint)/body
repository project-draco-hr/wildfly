{
  final PersistenceUnit context=injectionPoint.getAnnotated().getAnnotation(PersistenceUnit.class);
  if (context == null) {
    throw new RuntimeException("Could not find @PersistenceUnit annotation on " + injectionPoint.getMember());
  }
  final String scopedPuName=getScopedPUName(deploymentUnit,context.unitName());
  final ServiceName persistenceUnitServiceName=PersistenceUnitServiceImpl.getPUServiceName(scopedPuName);
  final ServiceController<?> serviceController=serviceRegistry.getRequiredService(persistenceUnitServiceName);
  PersistenceUnitServiceImpl persistenceUnitService=(PersistenceUnitServiceImpl)serviceController.getValue();
  return persistenceUnitService.getEntityManagerFactory();
}
