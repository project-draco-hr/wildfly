{
  if (digestMd5Supported()) {
    Builder builder=OptionMap.builder();
    builder.set(SASL_MECHANISMS,Sequence.of("DIGEST-MD5"));
    Sequence<Property> properties;
    if (contains(DigestHashCallback.class,realm.getCallbackHandler().getSupportedCallbacks())) {
      properties=Sequence.of(Property.of(REALM_PROPERTY,realm.getName()),Property.of(PRE_DIGESTED_PROPERTY,Boolean.TRUE.toString()));
    }
 else {
      properties=Sequence.of(Property.of(REALM_PROPERTY,realm.getName()));
    }
    builder.set(SASL_PROPERTIES,properties);
    return builder.getMap();
  }
  if (plainSupported()) {
    if (true)     throw new IllegalStateException("PLAIN not enabled until SSL supported for Native Interface");
    return OptionMap.create(Options.SASL_MECHANISMS,Sequence.of(PLAIN),SASL_POLICY_NOPLAINTEXT,false);
  }
  if (realm == null) {
    return OptionMap.create(SASL_MECHANISMS,Sequence.of(ANONYMOUS),SASL_POLICY_NOANONYMOUS,Boolean.FALSE);
  }
  throw new IllegalStateException("A security realm has been specified but no supported mechanism identified.");
}
