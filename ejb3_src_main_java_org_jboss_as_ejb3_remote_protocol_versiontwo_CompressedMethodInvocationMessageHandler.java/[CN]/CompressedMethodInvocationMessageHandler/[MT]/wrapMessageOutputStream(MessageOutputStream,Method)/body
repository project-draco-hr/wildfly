{
  CompressionHint compressionHint=invokedMethod.getAnnotation(CompressionHint.class);
  if (compressionHint == null) {
    compressionHint=invokedMethod.getDeclaringClass().getAnnotation(CompressionHint.class);
  }
  if (compressionHint != null && compressionHint.compressResponse()) {
    final int compressionLevel=compressionHint.compressionLevel();
    messageOutputStream.write(HEADER_COMPRESSED_MESSAGE);
    final Deflater deflater=new Deflater(compressionLevel);
    final DeflaterOutputStream deflaterOutputStream=new DeflaterOutputStream(messageOutputStream,deflater);
    if (EjbLogger.EJB3_INVOCATION_LOGGER.isTraceEnabled()) {
      EjbLogger.EJB3_INVOCATION_LOGGER.trace("Using a compressing stream with compression level = " + compressionLevel + " for response data for EJB invocation on method "+ invokedMethod);
    }
    return new DataOutputStream(deflaterOutputStream);
  }
  return new DataOutputStream(messageOutputStream);
}
