{
  final Manifest manifest=ManifestUtils.getOrCreateManifest(testDeployment.getApplicationArchive());
  final Archive<?> appArchive=testDeployment.getApplicationArchive();
  final Collection<Archive<?>> auxArchives=testDeployment.getAuxiliaryArchives();
  if (BundleInfo.isValidateBundleManifest(manifest)) {
    merge(appArchive,auxArchives);
  }
 else {
    if (appArchive instanceof WebArchive) {
      final ArchivePath webInfLib=ArchivePaths.create("WEB-INF","lib");
      for (      Archive<?> aux : auxArchives) {
        if (!excludedAuxillaryArchives.contains(aux.getName())) {
          appArchive.add(aux,webInfLib);
        }
      }
    }
 else {
      merge(appArchive,auxArchives);
    }
  }
  return appArchive;
}
