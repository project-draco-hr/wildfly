{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final String contextName=deploymentUnit.getName();
  final ServiceRegistry serviceRegistry=phaseContext.getServiceRegistry();
  BundleInfo info=BundleInfoAttachment.getBundleInfo(deploymentUnit);
  ServiceController<Deployment> deploymentController=DeploymentHolderService.getDeployment(serviceRegistry,contextName);
  if (info != null || deploymentController != null)   return;
  Manifest manifest=deploymentUnit.getAttachment(Attachments.OSGI_MANIFEST);
  if (manifest == null)   return;
  try {
    VirtualFile virtualFile=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
    info=BundleInfo.createBundleInfo(AbstractVFS.adapt(virtualFile),contextName);
    BundleInfoAttachment.attachBundleInfo(deploymentUnit,info);
  }
 catch (  BundleException ex) {
    throw new DeploymentUnitProcessingException(MESSAGES.cannotCreateBundleDeployment(deploymentUnit));
  }
}
