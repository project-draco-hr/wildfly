{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  BundleInfo info=BundleInfoAttachment.getBundleInfo(deploymentUnit);
  if (info != null)   return;
  VirtualFile virtualFile=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
  Manifest manifest=deploymentUnit.getAttachment(Attachments.OSGI_MANIFEST);
  if (manifest == null)   return;
  try {
    ServiceRegistry serviceRegistry=phaseContext.getServiceRegistry();
    String location=DeploymentHolderService.getLocation(serviceRegistry,deploymentUnit.getName());
    info=BundleInfo.createBundleInfo(AbstractVFS.adapt(virtualFile),location);
    BundleInfoAttachment.attachBundleInfo(deploymentUnit,info);
  }
 catch (  BundleException ex) {
    throw new DeploymentUnitProcessingException("Cannot create bundle deployment from: " + virtualFile);
  }
}
