{
  final SecurityManager sm=getSecurityManager();
  if (sm == null) {
    return getenv(name);
  }
  if (sm instanceof WildFlySecurityManager) {
    final ThreadLocal<Boolean> checking=WildFlySecurityManager.CHECKING;
    if (checking.get() != TRUE) {
      return def(getenv(name),def);
    }
    checkEnvPropertyReadPermission(getCallerClass(2).getProtectionDomain(),name);
    checking.set(FALSE);
    try {
      return def(getenv(name),def);
    }
  finally {
      checking.set(TRUE);
    }
  }
 else {
    checkEnvPropertyReadPermission(doPrivileged(new GetProtectionDomainAction(getCallerClass(2))),name);
    return doPrivileged(new ReadEnvironmentPropertyAction(name,def));
  }
}
