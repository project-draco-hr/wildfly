{
  DeploymentProvider deploymentManager=injectedDeploymentManager.getValue();
  Deployment dep=deploymentManager.createDeployment(bundle.getLocation(),rootFile);
  dep.addAttachment(Bundle.class,bundle);
  dep.setAutoStart(false);
  String runtimeName=getRuntimeName(dep);
  putDeployment(runtimeName,dep);
  try {
    InputStream input=dep.getRoot().openStream();
    try {
      ServerDeploymentHelper server=new ServerDeploymentHelper(serverDeploymentManager);
      server.deploy(runtimeName,input);
    }
  finally {
      VFSUtils.safeClose(input);
    }
  }
 catch (  RuntimeException rte) {
    throw rte;
  }
catch (  Exception ex) {
    throw MESSAGES.cannotDeployBundleRevision(ex,dep);
  }
}
