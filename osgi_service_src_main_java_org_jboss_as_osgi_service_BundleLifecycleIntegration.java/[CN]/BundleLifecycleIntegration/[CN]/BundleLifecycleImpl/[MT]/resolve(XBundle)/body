{
  bundleManager.resolveBundle(bundle);
  Deployment deployment=bundle.adapt(Deployment.class);
  DeploymentUnit depUnit=deployment.getAttachment(BundleDeploymentProcessor.DEPLOYMENT_UNIT_KEY);
  if (depUnit == null) {
    ModuleIdentifier identifier=bundle.getBundleRevision().getModuleIdentifier();
    ServiceName moduleServiceName=ServiceModuleLoader.moduleServiceName(identifier);
    ServiceRegistry serviceRegistry=bundleManager.getServiceContainer();
    ServiceController<?> controller=serviceRegistry.getRequiredService(moduleServiceName);
    FutureServiceValue<?> future=new FutureServiceValue(controller);
    try {
      future.get(2,TimeUnit.SECONDS);
    }
 catch (    Exception ex) {
      throw FrameworkMessages.MESSAGES.illegalStateCannotLoadModule(ex,identifier);
    }
  }
}
