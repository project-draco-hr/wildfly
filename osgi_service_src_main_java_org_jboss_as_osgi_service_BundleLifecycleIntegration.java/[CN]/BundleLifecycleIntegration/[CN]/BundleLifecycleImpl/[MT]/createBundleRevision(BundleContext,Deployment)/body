{
  if (OperationAssociation.INSTANCE.getAssociation() != null) {
    LOGGER.warnCannotDeployBundleFromManagementOperation(dep);
    return bundleManager.createBundleRevision(context,dep,null,null);
  }
 else {
    LOGGER.debugf("Install deployment: %s",dep);
    String runtimeName=getRuntimeName(dep);
    putDeployment(runtimeName,dep);
    try {
      InputStream input=dep.getRoot().openStream();
      try {
        ServerDeploymentHelper server=new ServerDeploymentHelper(serverDeploymentManager);
        server.deploy(runtimeName,input);
      }
  finally {
        VFSUtils.safeClose(input);
      }
    }
 catch (    RuntimeException rte) {
      throw rte;
    }
catch (    Exception ex) {
      throw MESSAGES.cannotDeployBundleRevision(ex,dep);
    }
    ServiceName serviceName=bundleManager.getServiceName(dep);
    ServiceController<?> controller=bundleManager.getServiceContainer().getService(serviceName);
    return (ServiceController<? extends XBundleRevision>)controller;
  }
}
