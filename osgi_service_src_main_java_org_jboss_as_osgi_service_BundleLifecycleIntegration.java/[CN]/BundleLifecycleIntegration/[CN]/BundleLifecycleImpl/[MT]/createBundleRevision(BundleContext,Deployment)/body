{
  if (OperationAssociation.INSTANCE.getAssociation() != null) {
    LOGGER.warnCannotDeployBundleFromManagementOperation(deployment);
    return bundleManager.createBundleRevision(context,deployment,null);
  }
  if (!deployment.isBundleUpdate() && bundleManager.getBundleByLocation(deployment.getLocation()) != null) {
    return bundleManager.createBundleRevision(context,deployment,null);
  }
  LOGGER.debugf("Install deployment: %s",deployment);
  String runtimeName=getRuntimeName(deployment);
  putDeployment(runtimeName,deployment);
  try {
    InputStream input=deployment.getRoot().openStream();
    try {
      ServerDeploymentHelper server=new ServerDeploymentHelper(serverDeploymentManager);
      server.deploy(runtimeName,input);
    }
  finally {
      VFSUtils.safeClose(input);
    }
  }
 catch (  RuntimeException rte) {
    throw rte;
  }
catch (  Exception ex) {
    throw MESSAGES.cannotDeployBundleRevision(ex,deployment);
  }
  DeploymentUnit depUnit=deployment.getAttachment(BundleDeploymentProcessor.DEPLOYMENT_UNIT_KEY);
  XBundleRevision brev=depUnit.getAttachment(OSGiConstants.BUNDLE_REVISION_KEY);
  return brev;
}
