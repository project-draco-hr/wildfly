{
  if (OperationAssociation.INSTANCE.getAssociation() != null) {
    LOGGER.warnCannotDeployBundleFromManagementOperation(dep);
    return bundleManager.createBundleRevision(context,dep,null);
  }
 else {
    LOGGER.debugf("Install deployment: %s",dep);
    String runtimeName=getRuntimeName(dep);
    putDeployment(runtimeName,dep);
    try {
      InputStream input=dep.getRoot().openStream();
      try {
        ServerDeploymentHelper server=new ServerDeploymentHelper(serverDeploymentManager);
        server.deploy(runtimeName,input);
      }
  finally {
        VFSUtils.safeClose(input);
      }
    }
 catch (    RuntimeException rte) {
      throw rte;
    }
catch (    Exception ex) {
      throw MESSAGES.cannotDeployBundleRevision(ex,dep);
    }
    DeploymentUnit depUnit=dep.getAttachment(BundleDeploymentProcessor.DEPLOYMENT_UNIT_KEY);
    XBundleRevision brev=depUnit.getAttachment(OSGiConstants.BUNDLE_REVISION_KEY);
    return brev;
  }
}
