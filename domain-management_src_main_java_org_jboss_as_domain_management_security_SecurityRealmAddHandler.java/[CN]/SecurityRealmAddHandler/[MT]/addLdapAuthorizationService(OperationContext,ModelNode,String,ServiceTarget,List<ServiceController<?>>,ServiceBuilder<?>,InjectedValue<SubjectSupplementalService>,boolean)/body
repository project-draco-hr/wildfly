{
  ServiceName ldapName=LdapSubjectSupplementalService.ServiceUtil.createServiceName(realmName);
  LdapSearcher<LdapEntry,String> userSearcher=null;
  boolean forceUserDnSearch=false;
  ModelNode userCache=null;
  if (ldap.hasDefined(USERNAME_TO_DN)) {
    ModelNode usernameToDn=ldap.require(USERNAME_TO_DN);
    if (usernameToDn.hasDefined(USERNAME_IS_DN)) {
      ModelNode usernameIsDn=usernameToDn.require(USERNAME_IS_DN);
      userCache=usernameIsDn.get(CACHE);
      forceUserDnSearch=UserIsDnResourceDefintion.FORCE.resolveModelAttribute(context,usernameIsDn).asBoolean();
      userSearcher=LdapUserSearcherFactory.createForUsernameIsDn();
    }
 else     if (usernameToDn.hasDefined(USERNAME_FILTER)) {
      ModelNode usernameFilter=usernameToDn.require(USERNAME_FILTER);
      userCache=usernameFilter.get(CACHE);
      forceUserDnSearch=UserSearchResourceDefintion.FORCE.resolveModelAttribute(context,usernameFilter).asBoolean();
      String baseDn=UserSearchResourceDefintion.BASE_DN.resolveModelAttribute(context,usernameFilter).asString();
      boolean recursive=UserSearchResourceDefintion.RECURSIVE.resolveModelAttribute(context,usernameFilter).asBoolean();
      String userDnAttribute=UserSearchResourceDefintion.USER_DN_ATTRIBUTE.resolveModelAttribute(context,usernameFilter).asString();
      String usernameAttribute=UserSearchResourceDefintion.ATTRIBUTE.resolveModelAttribute(context,usernameFilter).asString();
      userSearcher=LdapUserSearcherFactory.createForUsernameFilter(baseDn,recursive,userDnAttribute,usernameAttribute,null);
    }
 else     if (usernameToDn.hasDefined(ADVANCED_FILTER)) {
      ModelNode advancedFilter=usernameToDn.require(ADVANCED_FILTER);
      userCache=advancedFilter.get(CACHE);
      forceUserDnSearch=AdvancedUserSearchResourceDefintion.FORCE.resolveModelAttribute(context,advancedFilter).asBoolean();
      String baseDn=AdvancedUserSearchResourceDefintion.BASE_DN.resolveModelAttribute(context,advancedFilter).asString();
      boolean recursive=AdvancedUserSearchResourceDefintion.RECURSIVE.resolveModelAttribute(context,advancedFilter).asBoolean();
      String userDnAttribute=AdvancedUserSearchResourceDefintion.USER_DN_ATTRIBUTE.resolveModelAttribute(context,advancedFilter).asString();
      String filter=AdvancedUserSearchResourceDefintion.FILTER.resolveModelAttribute(context,advancedFilter).asString();
      userSearcher=LdapUserSearcherFactory.createForAdvancedFilter(baseDn,recursive,userDnAttribute,filter,null);
    }
  }
  if (userSearcher != null) {
    LdapCacheService<LdapEntry,String> userSearcherCache=createCacheService(context,userSearcher,userCache);
    ServiceName userSearcherCacheName=LdapSearcherCache.ServiceUtil.createServiceName(false,true,realmName);
    ServiceController<LdapSearcherCache<LdapEntry,String>> userSearcherController=serviceTarget.addService(userSearcherCacheName,userSearcherCache).setInitialMode(ON_DEMAND).install();
    controllers.add(userSearcherController);
  }
  ModelNode groupSearch=ldap.require(GROUP_SEARCH);
  LdapSearcher<LdapEntry[],LdapEntry> groupSearcher;
  boolean iterative=false;
  GroupName groupName=GroupName.DISTINGUISHED_NAME;
  ModelNode groupCache=null;
  if (groupSearch.hasDefined(GROUP_TO_PRINCIPAL)) {
    ModelNode groupToPrincipal=groupSearch.require(GROUP_TO_PRINCIPAL);
    groupCache=groupToPrincipal.get(CACHE);
    String baseDn=GroupToPrincipalResourceDefinition.BASE_DN.resolveModelAttribute(context,groupToPrincipal).asString();
    String groupDnAttribute=GroupToPrincipalResourceDefinition.GROUP_DN_ATTRIBUTE.resolveModelAttribute(context,groupToPrincipal).asString();
    groupName=GroupName.valueOf(GroupToPrincipalResourceDefinition.GROUP_NAME.resolveModelAttribute(context,groupToPrincipal).asString());
    String groupNameAttribute=GroupToPrincipalResourceDefinition.GROUP_NAME_ATTRIBUTE.resolveModelAttribute(context,groupToPrincipal).asString();
    iterative=GroupToPrincipalResourceDefinition.ITERATIVE.resolveModelAttribute(context,groupToPrincipal).asBoolean();
    String principalAttribute=GroupToPrincipalResourceDefinition.PRINCIPAL_ATTRIBUTE.resolveModelAttribute(context,groupToPrincipal).asString();
    boolean recursive=GroupToPrincipalResourceDefinition.RECURSIVE.resolveModelAttribute(context,groupToPrincipal).asBoolean();
    GroupName searchBy=GroupName.valueOf(GroupToPrincipalResourceDefinition.SEARCH_BY.resolveModelAttribute(context,groupToPrincipal).asString());
    groupSearcher=LdapGroupSearcherFactory.createForGroupToPrincipal(baseDn,groupDnAttribute,groupNameAttribute,principalAttribute,recursive,searchBy);
  }
 else {
    ModelNode principalToGroup=groupSearch.require(PRINCIPAL_TO_GROUP);
    groupCache=principalToGroup.get(CACHE);
    String groupAttribute=PrincipalToGroupResourceDefinition.GROUP_ATTRIBUTE.resolveModelAttribute(context,principalToGroup).asString();
    String groupDnAttribute=PrincipalToGroupResourceDefinition.GROUP_DN_ATTRIBUTE.resolveModelAttribute(context,principalToGroup).asString();
    groupName=GroupName.valueOf(PrincipalToGroupResourceDefinition.GROUP_NAME.resolveModelAttribute(context,principalToGroup).asString());
    String groupNameAttribute=PrincipalToGroupResourceDefinition.GROUP_NAME_ATTRIBUTE.resolveModelAttribute(context,principalToGroup).asString();
    iterative=PrincipalToGroupResourceDefinition.ITERATIVE.resolveModelAttribute(context,principalToGroup).asBoolean();
    groupSearcher=LdapGroupSearcherFactory.createForPrincipalToGroup(groupAttribute,groupNameAttribute);
  }
  LdapCacheService<LdapEntry[],LdapEntry> groupCacheService=createCacheService(context,groupSearcher,groupCache);
  ServiceName groupCacheServiceName=LdapSearcherCache.ServiceUtil.createServiceName(false,false,realmName);
  ServiceController<LdapSearcherCache<LdapEntry[],LdapEntry>> groupSearcherCacheController=serviceTarget.addService(groupCacheServiceName,groupCacheService).setInitialMode(ON_DEMAND).install();
  controllers.add(groupSearcherCacheController);
  String connectionName=LdapAuthorizationResourceDefinition.CONNECTION.resolveModelAttribute(context,ldap).asString();
  LdapSubjectSupplementalService service=new LdapSubjectSupplementalService(realmName,shareConnection,forceUserDnSearch,iterative,groupName);
  ServiceBuilder<SubjectSupplementalService> ldapBuilder=serviceTarget.addService(ldapName,service).setInitialMode(ON_DEMAND);
  LdapConnectionManagerService.ServiceUtil.addDependency(ldapBuilder,service.getConnectionManagerInjector(),connectionName,false);
  if (userSearcher != null) {
    LdapSearcherCache.ServiceUtil.addDependency(ldapBuilder,LdapSearcherCache.class,service.getLdapUserSearcherInjector(),false,true,realmName);
  }
  LdapSearcherCache.ServiceUtil.addDependency(ldapBuilder,LdapSearcherCache.class,service.getLdapGroupSearcherInjector(),false,false,realmName);
  controllers.add(ldapBuilder.install());
  SubjectSupplementalService.ServiceUtil.addDependency(realmBuilder,injector,ldapName,false);
}
