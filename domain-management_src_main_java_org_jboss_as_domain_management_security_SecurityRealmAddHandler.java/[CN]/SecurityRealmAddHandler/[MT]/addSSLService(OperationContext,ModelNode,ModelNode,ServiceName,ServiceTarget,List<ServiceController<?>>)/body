{
  ServiceName sslServiceName=realmServiceName.append(SSLIdentityService.SERVICE_SUFFIX);
  ServiceName keystoreServiceName=null;
  KeyPair pair=null;
  if (ssl != null && ssl.hasDefined(KEYSTORE_PATH)) {
    keystoreServiceName=realmServiceName.append(FileKeystoreService.KEYSTORE_SUFFIX);
    pair=addFileKeystoreService(context,ssl,keystoreServiceName,serviceTarget,newControllers);
  }
  ServiceName truststoreServiceName=null;
  if (trustStore != null) {
    truststoreServiceName=realmServiceName.append(FileKeystoreService.TRUSTSTORE_SUFFIX);
    addFileKeystoreService(context,trustStore,truststoreServiceName,serviceTarget,newControllers);
  }
  String protocol="TLS";
  if (ssl != null && ssl.hasDefined(PROTOCOL)) {
    protocol=ssl.get(PROTOCOL).asString();
  }
  SSLIdentityService sslIdentityService=new SSLIdentityService(protocol,pair == null ? null : pair.keystorePassword,pair == null ? null : pair.keyPassword);
  ServiceBuilder<?> sslBuilder=serviceTarget.addService(sslServiceName,sslIdentityService);
  if (keystoreServiceName != null) {
    sslBuilder.addDependency(keystoreServiceName,KeyStore.class,sslIdentityService.getKeyStoreInjector());
  }
  if (truststoreServiceName != null) {
    sslBuilder.addDependency(truststoreServiceName,KeyStore.class,sslIdentityService.getTrustStoreInjector());
  }
  final ServiceController<?> serviceController=sslBuilder.setInitialMode(ON_DEMAND).install();
  if (newControllers != null) {
    newControllers.add(serviceController);
  }
  return sslServiceName;
}
