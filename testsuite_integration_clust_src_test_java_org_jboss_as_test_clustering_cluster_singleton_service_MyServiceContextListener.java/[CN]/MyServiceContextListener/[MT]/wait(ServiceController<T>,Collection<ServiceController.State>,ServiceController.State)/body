{
  if (controller.getState() != targetState) {
    ServiceListener<T> listener=new NotifyingServiceListener<T>();
    controller.addListener(listener);
    try {
synchronized (controller) {
        while (expectedStates.contains(controller.getState())) {
          System.out.println(String.format("Service controller state is %s, waiting for transition to %s",controller.getState(),targetState));
          controller.wait();
        }
      }
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
    }
    controller.removeListener(listener);
    ServiceController.State state=controller.getState();
    if (state != targetState) {
      throw new IllegalStateException(String.format("Failed to wait for state to transition to %s.  Current state is %s",targetState,state),controller.getStartException());
    }
  }
}
