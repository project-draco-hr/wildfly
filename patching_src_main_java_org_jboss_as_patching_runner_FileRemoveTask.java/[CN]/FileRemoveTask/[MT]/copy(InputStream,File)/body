{
  if (!target.getParentFile().exists()) {
    target.getParentFile().mkdirs();
  }
  final OutputStream os=new FileOutputStream(target);
  try {
    final DigestOutputStream dos=new DigestOutputStream(os,DIRECTORY);
    byte[] nh=PatchUtils.copyAndGetHash(is,dos);
    dos.close();
    return nh;
  }
  finally {
    PatchUtils.safeClose(os);
  }
}
