{
  BundleContext context=bundle.getBundleContext();
  ConfigurationAdmin configAdmin=getConfigurationAdmin(context);
  Configuration config=configAdmin.getConfiguration(PID_A);
  Assert.assertNotNull("Config not null",config);
  Assert.assertNull("Config is empty, but was: " + config.getProperties(),config.getProperties());
  try {
    Dictionary<String,String> configProps=new Hashtable<String,String>();
    configProps.put("foo","bar");
    config.update(configProps);
    ConfiguredService service=new ConfiguredService();
    Dictionary<String,String> serviceProps=new Hashtable<String,String>();
    serviceProps.put(Constants.SERVICE_PID,PID_A);
    context.registerService(new String[]{ConfiguredService.class.getName(),ManagedService.class.getName()},service,serviceProps);
    Assert.assertTrue(service.awaitUpdate(3,TimeUnit.SECONDS));
    Assert.assertEquals("bar",service.getProperties().get("foo"));
  }
  finally {
    config.delete();
  }
}
