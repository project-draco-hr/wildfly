{
  isInTx=TransactionUtil.getInstance().isInTx();
  if (isInTx) {
    EntityManager existing=TransactionUtil.getInstance().getTransactionScopedEntityManager(puScopedName);
    if (existing != null && existing != this) {
      throw new EJBException("Found extended persistence context in SFSB invocation call stack but that cannot be used " + "because the transaction already has a transactional context associated with it.  " + "This can be avoided by changing application code, either eliminate the extended "+ "persistence context or the transactional context.  See JPA spec 2.0 section 7.6.3.1.  "+ "Scoped persistence unit name=" + puScopedName + ", persistence context already in transaction ="+ existing+ ", extended persistence context ="+ this);
    }
 else     if (existing == null) {
      TransactionUtil.getInstance().registerExtendedUnderlyingWithTransaction(puScopedName,this,underlyingEntityManager);
    }
  }
  return underlyingEntityManager;
}
