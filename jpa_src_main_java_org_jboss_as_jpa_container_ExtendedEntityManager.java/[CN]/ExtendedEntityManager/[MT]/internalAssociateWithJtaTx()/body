{
  isInTx=TransactionUtil.isInTx();
  if (isInTx) {
    EntityManager existing=TransactionUtil.getTransactionScopedEntityManager(puScopedName);
    if (existing != null && existing != this) {
      throw MESSAGES.cannotUseExtendedPersistenceTransaction(puScopedName,existing,this);
    }
 else     if (existing == null) {
      if (SynchronizationType.SYNCHRONIZED.equals(synchronizationType)) {
        underlyingEntityManager.joinTransaction();
      }
      TransactionUtil.putEntityManagerInTransactionRegistry(puScopedName,this);
    }
  }
}
