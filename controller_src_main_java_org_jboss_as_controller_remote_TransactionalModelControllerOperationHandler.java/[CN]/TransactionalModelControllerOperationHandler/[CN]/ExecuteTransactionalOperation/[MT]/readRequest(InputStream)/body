{
  expectHeader(inputStream,TRANSACTION_ID);
  txId=new ModelNode();
  txId.readExternal(inputStream);
  expectHeader(inputStream,ModelControllerClientProtocol.PARAM_OPERATION);
  builder=OperationBuilder.Factory.create(readNode(inputStream));
  int cmd=inputStream.read();
  if (cmd == ModelControllerClientProtocol.PARAM_REQUEST_END) {
    return;
  }
  if (cmd != ModelControllerClientProtocol.PARAM_INPUT_STREAM) {
    throw new IllegalArgumentException("Expected " + ModelControllerClientProtocol.PARAM_INPUT_STREAM + " received "+ cmd);
  }
  while (cmd == ModelControllerClientProtocol.PARAM_INPUT_STREAM) {
    int length=StreamUtils.readInt(inputStream);
    ByteArrayOutputStream bout=new ByteArrayOutputStream();
    for (int i=0; i < length; i++) {
      int b=inputStream.read();
      if (b == -1) {
        throw new IllegalArgumentException("Unexpected end of file");
      }
      bout.write(b);
    }
    builder.addInputStream(new ByteArrayInputStream(bout.toByteArray()));
    cmd=inputStream.read();
  }
}
