{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final String contextName=depUnit.getName();
  Deployment deployment=BundleInstallIntegration.removeDeployment(contextName);
  if (deployment != null) {
    deployment.setAutoStart(false);
  }
  BundleInfo info=depUnit.getAttachment(OSGiConstants.BUNDLE_INFO_KEY);
  if (deployment == null && info != null) {
    deployment=DeploymentFactory.createDeployment(info);
    deployment.addAttachment(BundleInfo.class,info);
    OSGiMetaData metadata=info.getOSGiMetadata();
    deployment.setAutoStart(!metadata.isFragment());
    AnnotationInstance slAware=getAnnotation(depUnit,"org.jboss.arquillian.osgi.StartLevelAware");
    if (slAware != null) {
      int startLevel=slAware.value("startLevel").asInt();
      deployment.setStartLevel(startLevel);
      deployment.setAutoStart(false);
    }
    AnnotationInstance marker=getAnnotation(depUnit,"org.jboss.as.arquillian.api.DeploymentMarker");
    if (marker != null && !marker.value("autoStart").asBoolean()) {
      deployment.setAutoStart(false);
    }
  }
  if (deployment != null) {
    ModuleIdentifier identifier=depUnit.getAttachment(Attachments.MODULE_IDENTIFIER);
    deployment.addAttachment(ModuleIdentifier.class,identifier);
    if (allowAdditionalModuleDependencies(depUnit)) {
      ModuleSpecification moduleSpec=depUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
      deployment.addAttachment(ModuleSpecification.class,moduleSpec);
    }
 else {
      ModuleSpecification moduleSpec=depUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
      moduleSpec.setPrivateModule(true);
    }
    depUnit.putAttachment(OSGiConstants.DEPLOYMENT_KEY,deployment);
  }
}
