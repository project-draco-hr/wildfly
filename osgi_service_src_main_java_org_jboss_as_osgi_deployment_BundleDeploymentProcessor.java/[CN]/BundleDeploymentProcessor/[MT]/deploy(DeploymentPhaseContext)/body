{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final String contextName=depUnit.getName();
  Deployment deployment=BundleInstallIntegration.removeDeployment(contextName);
  if (deployment != null) {
    deployment.setAutoStart(false);
  }
  BundleInfo info=depUnit.getAttachment(OSGiConstants.BUNDLE_INFO_KEY);
  if (deployment == null && info != null) {
    deployment=DeploymentFactory.createDeployment(info);
    deployment.addAttachment(BundleInfo.class,info);
    DotName runWithName=DotName.createSimple("org.junit.runner.RunWith");
    CompositeIndex compositeIndex=depUnit.getAttachment(Attachments.COMPOSITE_ANNOTATION_INDEX);
    List<AnnotationInstance> runWithList=compositeIndex.getAnnotations(runWithName);
    deployment.setAutoStart(runWithList.isEmpty());
  }
  if (deployment != null) {
    phaseContext.getServiceRegistry().getRequiredService(Services.FRAMEWORK_ACTIVE).setMode(Mode.ACTIVE);
    phaseContext.addDependency(IntegrationServices.AUTOINSTALL_COMPLETE,AttachmentKey.create(Object.class));
    phaseContext.addDeploymentDependency(Services.BUNDLE_MANAGER,OSGiConstants.BUNDLE_MANAGER_KEY);
    depUnit.putAttachment(OSGiConstants.DEPLOYMENT_KEY,deployment);
  }
}
