{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final String contextName=depUnit.getName();
  Deployment deployment=BundleInstallIntegration.removeDeployment(contextName);
  if (deployment != null) {
    deployment.setAutoStart(false);
  }
  BundleInfo info=depUnit.getAttachment(OSGiConstants.BUNDLE_INFO_KEY);
  if (deployment == null && info != null) {
    deployment=DeploymentFactory.createDeployment(info);
    deployment.addAttachment(BundleInfo.class,info);
    OSGiMetaData metadata=info.getOSGiMetadata();
    deployment.setAutoStart(!metadata.isFragment());
    for (    AnnotationInstance marker : getAnnotationList(depUnit,DeploymentMarker.class)) {
      if (marker.value("autoStart").asBoolean() == false) {
        deployment.setAutoStart(false);
        break;
      }
    }
  }
  if (deployment != null) {
    ModuleIdentifier identifier=depUnit.getAttachment(Attachments.MODULE_IDENTIFIER);
    deployment.addAttachment(ModuleIdentifier.class,identifier);
    if (allowAdditionalModuleDependencies(depUnit)) {
      ModuleSpecification moduleSpec=depUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
      deployment.addAttachment(ModuleSpecification.class,moduleSpec);
    }
    depUnit.putAttachment(OSGiConstants.DEPLOYMENT_KEY,deployment);
  }
}
