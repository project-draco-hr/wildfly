{
  if (controller.isStarted(CONTAINER))   controller.stop(CONTAINER);
  if (doCleanup) {
    if (IoUtils.recursiveDelete(tempDir)) {
      tempDir.deleteOnExit();
    }
  }
  final boolean success=CliUtilsForPatching.rollbackAll();
  boolean ok=false;
  try {
    if (!success) {
      Assert.fail("failed to rollback all patches " + CliUtilsForPatching.info(false));
    }
    assertPatchElements(new File(MODULES_PATH),null);
    ok=true;
  }
  finally {
    if (!ok) {
      final File home=new File(PatchingTestUtil.AS_DISTRIBUTION);
      PatchingTestUtil.resetInstallationState(home,BASE_MODULE_DIRECTORY);
    }
  }
}
