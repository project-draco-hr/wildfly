{
  final Class<?> type;
  if (targetType != null) {
    type=targetType;
  }
 else   if (targetTypeName != null) {
    final DeploymentClassIndex index=phaseContext.getDeploymentUnit().getAttachment(org.jboss.as.server.deployment.Attachments.CLASS_INDEX);
    try {
      type=index.classIndex(targetTypeName).getModuleClass();
    }
 catch (    ClassNotFoundException e) {
      throw new RuntimeException("Could not load EJB type " + targetTypeName,e);
    }
  }
 else {
    type=null;
  }
  injector.inject(new ManagedReferenceFactory(){
    @Override public ManagedReference getReference(){
      try {
        final Object value=new InitialContext().lookup(lookup);
        return new ManagedReference(){
          @Override public void release(){
          }
          @Override public Object getInstance(){
            if (type != null) {
              return PortableRemoteObject.narrow(value,type);
            }
 else {
              return value;
            }
          }
        }
;
      }
 catch (      NamingException e) {
        throw new RuntimeException(e);
      }
    }
  }
);
}
