{
synchronized (lock) {
    if (sender != this) {
      return;
    }
    sender=null;
    lock.notify();
    if (writeDone)     throw new IOException("Write channel closed");
    if (readDone) {
      readExecutor.execute(new Runnable(){
        public void run(){
          safeHandleFinished();
        }
      }
);
    }
    log.tracef("Sending end of message");
    out.write(CHUNK_END);
  }
}
