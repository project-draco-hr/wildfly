{
  final MessageOutputStream os;
synchronized (lock) {
    if (writeDone) {
      throw new IOException("Writes are already shut down");
    }
    while (sender != null) {
      try {
        lock.wait();
      }
 catch (      InterruptedException e) {
        Thread.currentThread().interrupt();
        throw new InterruptedIOException();
      }
    }
    boolean ok=false;
    try {
      sender=os=new MessageOutputStream();
      ok=true;
    }
  finally {
      if (!ok) {
        lock.notify();
      }
    }
  }
  return os;
}
