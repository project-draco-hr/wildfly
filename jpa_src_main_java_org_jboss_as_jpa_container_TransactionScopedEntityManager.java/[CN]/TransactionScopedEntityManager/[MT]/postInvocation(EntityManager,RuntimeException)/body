{
  try {
    if (!isInTx()) {
      underlyingEntityManager.close();
    }
  }
 catch (  RuntimeException closeError) {
    if (exceptionWasAlreadyThrown != null) {
      log.error("failure occurred while checking for active transaction or closing underlying entity manager." + "Original error was: " + exceptionWasAlreadyThrown.getMessage(),closeError);
    }
 else {
      throw closeError;
    }
  }
  if (exceptionWasAlreadyThrown != null) {
    throw exceptionWasAlreadyThrown;
  }
}
