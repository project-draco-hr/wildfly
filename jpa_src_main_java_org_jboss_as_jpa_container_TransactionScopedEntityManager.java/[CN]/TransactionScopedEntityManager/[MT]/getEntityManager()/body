{
  EntityManager result=null;
  isExtendedPersistenceContext=false;
  isInTx=TransactionUtil.getInstance().isInTx();
  if (isInTx) {
    result=TransactionUtil.getInstance().getTransactionScopedEntityManager(emf,puScopedName,properties);
  }
 else {
    result=EntityManagerUtil.createEntityManager(emf,properties);
  }
  setMetadata(puScopedName,false);
  return result;
}
