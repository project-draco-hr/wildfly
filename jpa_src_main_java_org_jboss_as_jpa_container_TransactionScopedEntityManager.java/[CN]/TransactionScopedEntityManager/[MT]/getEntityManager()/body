{
  EntityManager result=null;
  boolean isInTx;
  isInTx=TransactionUtil.getInstance().isInTx();
  if (isInTx && (result=SFSBCallStack.findPersistenceContext(puScopedName,sfsbxpcMap)) != null) {
    EntityManager existing=TransactionUtil.getInstance().getTransactionScopedEntityManager(puScopedName);
    if (existing != null && existing != result) {
      throw new EJBException("Found extended persistence context in SFSB invocation call stack but that cannot be used " + "because the transaction already has a transactional context associated with it.  " + "This can be avoided by changing application code, either eliminate the extended "+ "persistence context or the transactional context.  See JPA spec 2.0 section 7.6.3.1.  "+ "Scoped persistence unit name=" + puScopedName + ", persistence context already in transaction ="+ existing+ ", extended persistence context ="+ result);
    }
 else     if (existing == null) {
      TransactionUtil.getInstance().registerExtendedWithTransaction(puScopedName,result);
    }
  }
 else {
    if (isInTx) {
      result=TransactionUtil.getInstance().getOrCreateTransactionScopedEntityManager(emf,puScopedName,properties);
    }
 else {
      result=NonTxEmCloser.get(puScopedName);
      if (result == null) {
        result=EntityManagerUtil.createEntityManager(emf,properties);
        NonTxEmCloser.add(puScopedName,result);
      }
    }
  }
  return result;
}
