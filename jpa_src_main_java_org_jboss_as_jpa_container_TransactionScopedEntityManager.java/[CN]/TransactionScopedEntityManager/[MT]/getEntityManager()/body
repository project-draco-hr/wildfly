{
  EntityManager result;
  if ((result=SFSBCallStack.findPersistenceContext(puScopedName)) != null) {
    isExtendedPersistenceContext=true;
    isInTx=TransactionUtil.getInstance().isInTx();
    if (isInTx) {
      EntityManager existing=TransactionUtil.getInstance().getTransactionScopedEntityManager(puScopedName);
      if (existing != result) {
        throw new EJBException("Found extended persistence context in SFSB invocation call stack but that cannot be used " + "because the transaction already has a transactional context associated with it.  " + "This can be avoided by changing application code, either eliminate the extended "+ "persistence context or the transactional context.  See JPA spec 2.0 section 7.6.3.1.  "+ "Scoped persistence unit name="+ puScopedName);
      }
      TransactionUtil.getInstance().registerExtendedWithTransaction(puScopedName,result);
    }
  }
 else {
    isExtendedPersistenceContext=false;
    isInTx=TransactionUtil.getInstance().isInTx();
    if (isInTx) {
      result=TransactionUtil.getInstance().getOrCreateTransactionScopedEntityManager(emf,puScopedName,properties);
    }
 else {
      result=EntityManagerUtil.createEntityManager(emf,properties);
    }
  }
  return result;
}
