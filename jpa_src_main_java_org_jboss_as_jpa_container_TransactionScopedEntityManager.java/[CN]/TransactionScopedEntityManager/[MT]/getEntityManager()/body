{
  EntityManager result=null;
  if (TransactionUtil.getInstance().isInTx()) {
    result=TransactionUtil.getInstance().getTransactionScopedEntityManager(emf,puScopedName,properties);
  }
 else {
    result=EntityManagerUtil.createEntityManager(emf,properties);
  }
  setMetadata(puScopedName,false);
  return result;
}
