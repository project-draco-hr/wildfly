{
  final OSGiMetaData metadata=reg.metadata;
  final Module module=reg.module;
  LOGGER.infoRegisterModule(module.getIdentifier());
  XBundleRevisionBuilderFactory factory=new XBundleRevisionBuilderFactory(){
    @Override public XBundleRevision createResource(){
      return new AbstractBundleRevisionAdaptor(context,module);
    }
  }
;
  try {
    XResourceBuilder builder=XBundleRevisionBuilderFactory.create(factory);
    if (metadata != null) {
      builder.loadFrom(metadata);
    }
 else {
      builder.loadFrom(module);
    }
    reg.brev=(XBundleRevision)builder.getResource();
    env.installResources(reg.brev);
  }
 catch (  Throwable th) {
    throw MESSAGES.illegalStateFailedToRegisterModule(th,module);
  }
  return reg.brev;
}
