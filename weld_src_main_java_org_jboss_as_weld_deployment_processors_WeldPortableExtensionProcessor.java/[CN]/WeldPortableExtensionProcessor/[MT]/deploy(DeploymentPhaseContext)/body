{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (PrivateSubDeploymentMarker.isPrivate(deploymentUnit)) {
    if (!WeldDeploymentMarker.isPartOfWeldDeployment(deploymentUnit)) {
      return;
    }
  }
 else   if (deploymentUnit.getParent() == null) {
    if (!WeldDeploymentMarker.isPartOfWeldDeployment(deploymentUnit)) {
      return;
    }
  }
 else {
    if (!WeldDeploymentMarker.isPartOfWeldDeployment(deploymentUnit.getParent())) {
      return;
    }
  }
  final DeploymentUnit topLevelDeployment=deploymentUnit.getParent() == null ? deploymentUnit : deploymentUnit.getParent();
  final ServicesAttachment services=deploymentUnit.getAttachment(Attachments.SERVICES);
  final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
  ClassLoader oldCl=SecurityActions.getContextClassLoader();
  try {
    SecurityActions.setContextClassLoader(module.getClassLoader());
    loadAttachments(services,module,deploymentUnit,topLevelDeployment);
  }
  finally {
    SecurityActions.setContextClassLoader(oldCl);
  }
}
