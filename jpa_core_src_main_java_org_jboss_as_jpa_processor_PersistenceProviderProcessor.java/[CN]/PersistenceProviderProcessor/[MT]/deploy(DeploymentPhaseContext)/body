{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
  final ServicesAttachment servicesAttachment=deploymentUnit.getAttachment(Attachments.SERVICES);
  if (module != null && servicesAttachment != null) {
    final ModuleClassLoader deploymentModuleClassLoader=module.getClassLoader();
    PersistenceProvider provider=null;
    final List<String> providerNames=servicesAttachment.getServiceImplementations(PersistenceProvider.class.getName());
    if (providerNames.size() > 1) {
      throw MESSAGES.onlyOnePersistenceProviderAllowed(providerNames);
    }
    for (    String providerName : providerNames) {
      try {
        final Class<? extends PersistenceProvider> providerClass=deploymentModuleClassLoader.loadClass(providerName).asSubclass(PersistenceProvider.class);
        final Constructor<? extends PersistenceProvider> constructor=providerClass.getConstructor();
        provider=constructor.newInstance();
        ROOT_LOGGER.debugf("Deployment has its own Persistence Provider %s ",providerClass);
      }
 catch (      Exception e) {
        throw MESSAGES.cannotDeployApp(e,providerName);
      }
    }
    if (provider != null) {
      final String adapterClass=deploymentUnit.getAttachment(JpaAttachments.ADAPTOR_CLASS_NAME);
      PersistenceProviderAdaptor adaptor=null;
      if (adapterClass != null) {
        try {
          adaptor=(PersistenceProviderAdaptor)deploymentModuleClassLoader.loadClass(adapterClass).newInstance();
          adaptor.injectJtaManager(JtaManagerImpl.getInstance());
        }
 catch (        InstantiationException e) {
          throw MESSAGES.cannotCreateAdapter(e,adapterClass);
        }
catch (        IllegalAccessException e) {
          throw MESSAGES.cannotCreateAdapter(e,adapterClass);
        }
catch (        ClassNotFoundException e) {
          throw MESSAGES.cannotCreateAdapter(e,adapterClass);
        }
      }
      deploymentUnit.putAttachment(JpaAttachments.DEPLOYED_PERSISTENCE_PROVIDER,new PersistenceProviderDeploymentHolder(provider,adaptor));
    }
  }
}
