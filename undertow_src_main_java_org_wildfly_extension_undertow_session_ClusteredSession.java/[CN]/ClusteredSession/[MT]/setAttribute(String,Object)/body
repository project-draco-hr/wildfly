{
  if (name == null)   throw MESSAGES.expiredSession();
  if (value == null) {
    return removeAttribute(name);
  }
  if (!isValidInternal()) {
    throw MESSAGES.expiredSession();
  }
  if (canAttributeBeReplicated(value) == false) {
    throw MESSAGES.failToReplicateAttribute(name,value.getClass().getCanonicalName());
  }
  if (value instanceof HttpSessionActivationListener)   hasActivationListener=Boolean.TRUE;
  Object old=setAttributeInternal(name,value);
  if (old == null) {
    manager.getSessionListeners().attributeAdded(this,name,value);
  }
 else {
    manager.getSessionListeners().attributeUpdated(this,name,value,old);
  }
  return old;
}
