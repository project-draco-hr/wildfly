{
  String patchID=randomString();
  String patchElementId=randomString();
  File patchDir=mkdir(tempDir,patchID);
  File baseModuleDir=newFile(new File(PatchingTestUtil.AS_DISTRIBUTION),MODULES,SYSTEM,LAYERS,BASE);
  String moduleName="module-test";
  Module module=new Module.Builder(moduleName).miscFile(new ResourceItem("resource-test","new resource in the module".getBytes())).build();
  File moduleDir=module.writeToDisk(new File(MODULES_PATH));
  ContentModification moduleModified=ContentModificationUtils.modifyModule(patchDir,patchElementId,HashUtils.hashFile(moduleDir),module);
  String fileName="file-test.txt";
  File miscFile=touch(new File(PatchingTestUtil.AS_DISTRIBUTION,"bin"),fileName);
  dump(miscFile,"original script to run standalone AS7");
  byte[] originalFileHash=HashUtils.hashFile(miscFile);
  ContentModification fileModified=ContentModificationUtils.modifyMisc(patchDir,patchID,"updated script",miscFile,"bin",fileName);
  File baseBundleDir=newFile(new File(PatchingTestUtil.AS_DISTRIBUTION),BUNDLES,SYSTEM,LAYERS,BASE);
  String bundleName="bundle-test";
  File bundleDir=createBundle0(baseBundleDir,bundleName,"bundle content");
  ContentModification bundleModified=ContentModificationUtils.modifyBundle(patchDir,patchElementId,bundleDir,"updated bundle content");
  Patch patch=PatchBuilder.create().setPatchId(patchID).setDescription(randomString()).upgradeIdentity(productConfig.getProductName(),productConfig.getProductVersion(),productConfig.getProductVersion() + "CP1").getParent().addContentModification(fileModified).upgradeElement(patchElementId,"base",false).addContentModification(moduleModified).addContentModification(bundleModified).getParent().build();
  createPatchXMLFile(patchDir,patch);
  File zippedPatch=createZippedPatchFile(patchDir,patch.getPatchId());
  assertPatchElements(baseModuleDir,null);
  assertPatchElements(baseBundleDir,null);
  controller.start(CONTAINER);
  CommandContext ctx=CLITestUtil.getCommandContext();
  try {
    ctx.connectController();
    ctx.handle("patch apply " + zippedPatch.getAbsolutePath() + " --distribution="+ PatchingTestUtil.AS_DISTRIBUTION);
  }
 catch (  Exception e) {
    ctx.terminateSession();
    throw e;
  }
 finally {
    controller.stop(CONTAINER);
  }
  assertPatchElements(baseModuleDir,new String[]{patchElementId});
  assertPatchElements(baseBundleDir,new String[]{patchElementId});
  byte[] patch1FileHash=HashUtils.hashFile(miscFile);
  assertNotEqual(originalFileHash,patch1FileHash);
  final String patchID2=randomString();
  final String patchElementId2=randomString();
  final File patchedModule=newFile(baseModuleDir,".overlays",patchElementId,moduleName);
  final File patchedBundle=newFile(baseBundleDir,".overlays",patchElementId,bundleName);
  Module modifiedModule=new Module.Builder(moduleName).miscFile(new ResourceItem("resource-test","another module update".getBytes())).build();
  ContentModification fileModified2=ContentModificationUtils.modifyMisc(patchDir,patchID2,"another file update",miscFile,"bin",fileName);
  ContentModification moduleModified2=ContentModificationUtils.modifyModule(patchDir,patchElementId2,HashUtils.hashFile(patchedModule),modifiedModule);
  ContentModification bundleModified2=ContentModificationUtils.modifyBundle(patchDir,patchElementId2,patchedBundle,"another bundle update");
  Patch patch2=PatchBuilder.create().setPatchId(patchID2).setDescription(randomString()).upgradeIdentity(productConfig.getProductName(),productConfig.getProductVersion(),productConfig.getProductName() + "CP2").getParent().addContentModification(fileModified2).upgradeElement(patchElementId2,"base",false).addContentModification(moduleModified2).addContentModification(bundleModified2).getParent().build();
  createPatchXMLFile(patchDir,patch2);
  File zippedPatch2=createZippedPatchFile(patchDir,patch2.getPatchId());
  controller.start(CONTAINER);
  try {
    ctx.handle("patch apply " + zippedPatch2.getAbsolutePath() + " --distribution="+ PatchingTestUtil.AS_DISTRIBUTION);
  }
 catch (  Exception e) {
    e.printStackTrace();
    ctx.terminateSession();
    throw e;
  }
 finally {
    controller.stop(CONTAINER);
  }
  assertPatchElements(baseModuleDir,new String[]{patchElementId,patchElementId2});
  assertPatchElements(baseBundleDir,new String[]{patchElementId,patchElementId2});
  byte[] patch2FileHash=HashUtils.hashFile(miscFile);
  assertNotEqual(patch1FileHash,patch2FileHash);
  assertNotEqual(originalFileHash,patch2FileHash);
  controller.start(CONTAINER);
  try {
    ctx.handle("patch rollback --reset-configuration=false --distribution=" + PatchingTestUtil.AS_DISTRIBUTION);
  }
 catch (  Exception e) {
    ctx.terminateSession();
    throw e;
  }
 finally {
    controller.stop(CONTAINER);
  }
  assertPatchElements(baseModuleDir,new String[]{patchElementId});
  assertPatchElements(baseBundleDir,new String[]{patchElementId});
  byte[] curFileHash=HashUtils.hashFile(miscFile);
  assertNotEqual(curFileHash,patch2FileHash);
  assertArrayEquals(curFileHash,patch1FileHash);
  assertNotEqual(curFileHash,originalFileHash);
  controller.start(CONTAINER);
  try {
    ctx.handle("patch rollback --reset-configuration=false --distribution=" + PatchingTestUtil.AS_DISTRIBUTION);
  }
 catch (  Exception e) {
    ctx.terminateSession();
    throw e;
  }
 finally {
    ctx.terminateSession();
    controller.stop(CONTAINER);
  }
  assertPatchElements(baseModuleDir,null);
  assertPatchElements(baseBundleDir,null);
  curFileHash=HashUtils.hashFile(miscFile);
  assertNotEqual(curFileHash,patch2FileHash);
  assertNotEqual(curFileHash,patch1FileHash);
  assertArrayEquals(curFileHash,originalFileHash);
}
