{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final List<ResourceRoot> childRoots=deploymentUnit.getAttachment(Attachments.RESOURCE_ROOTS);
  if (childRoots != null) {
    final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
    for (    final ResourceRoot childRoot : childRoots) {
      if (!ResourceRootTypeMarker.isSubDeployment(childRoot)) {
        continue;
      }
      final SubDeploymentUnitService service=new SubDeploymentUnitService(childRoot,deploymentUnit);
      final ServiceName serviceName=deploymentUnit.getServiceName().append(childRoot.getRootName());
      serviceTarget.addService(serviceName,service).addDependency(Services.JBOSS_DEPLOYMENT_CHAINS,DeployerChains.class,service.getDeployerChainsInjector()).setInitialMode(ServiceController.Mode.ACTIVE).install();
      deploymentUnit.addToAttachmentList(Attachments.SUB_DEPLOYMENTS,serviceName);
    }
  }
}
