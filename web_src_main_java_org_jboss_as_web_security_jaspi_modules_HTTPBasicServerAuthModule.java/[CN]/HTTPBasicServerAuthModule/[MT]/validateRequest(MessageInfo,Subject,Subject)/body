{
  Request request=(Request)messageInfo.getRequestMessage();
  Response response=(Response)messageInfo.getResponseMessage();
  Principal principal;
  context=request.getContext();
  LoginConfig config=context.getLoginConfig();
  String username=null;
  String password=null;
  MessageBytes authorization=request.getCoyoteRequest().getMimeHeaders().getValue("authorization");
  if (authorization != null) {
    authorization.toBytes();
    ByteChunk authorizationBC=authorization.getByteChunk();
    if (authorizationBC.startsWithIgnoreCase("basic ",0)) {
      authorizationBC.setOffset(authorizationBC.getOffset() + 6);
      CharChunk authorizationCC=authorization.getCharChunk();
      Base64.decode(authorizationBC,authorizationCC);
      int colon=authorizationCC.indexOf(':');
      if (colon < 0) {
        username=authorizationCC.toString();
      }
 else {
        char[] buf=authorizationCC.getBuffer();
        username=new String(buf,0,colon);
        password=new String(buf,colon + 1,authorizationCC.getEnd() - colon - 1);
      }
      authorizationBC.setOffset(authorizationBC.getOffset() - 6);
    }
    principal=context.getRealm().authenticate(username,password);
    if (principal != null) {
      registerWithCallbackHandler(principal,username,password);
      return AuthStatus.SUCCESS;
    }
  }
  MessageBytes authenticate=response.getCoyoteResponse().getMimeHeaders().addValue(AUTHENTICATE_BYTES,0,AUTHENTICATE_BYTES.length);
  CharChunk authenticateCC=authenticate.getCharChunk();
  try {
    authenticateCC.append("Basic realm=\"");
    if (config.getRealmName() == null) {
      authenticateCC.append(request.getServerName());
      authenticateCC.append(':');
      authenticateCC.append(Integer.toString(request.getServerPort()));
    }
 else {
      authenticateCC.append(config.getRealmName());
    }
    authenticateCC.append('\"');
    authenticate.toChars();
    response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
  }
 catch (  IOException e) {
  }
  return AuthStatus.FAILURE;
}
