{
  if (cri != null && cri.getClass() != WrappedConnectionRequestInfo.class)   throw new ResourceException("Wrong kind of ConnectionRequestInfo: " + cri.getClass());
  Properties props=new Properties();
  props.putAll(connectionProps);
  if (subject != null) {
    if (SubjectActions.addMatchingProperties(subject,props,this))     return props;
    throw new ResourceException("No matching credentials in Subject!");
  }
  WrappedConnectionRequestInfo lcri=(WrappedConnectionRequestInfo)cri;
  if (lcri != null) {
    props.setProperty("user",(lcri.getUserName() == null) ? "" : lcri.getUserName());
    props.setProperty("password",(lcri.getPassword() == null) ? "" : lcri.getPassword());
    return props;
  }
  if (userName != null) {
    props.setProperty("user",userName);
    props.setProperty("password",(password == null) ? "" : password);
  }
  return props;
}
