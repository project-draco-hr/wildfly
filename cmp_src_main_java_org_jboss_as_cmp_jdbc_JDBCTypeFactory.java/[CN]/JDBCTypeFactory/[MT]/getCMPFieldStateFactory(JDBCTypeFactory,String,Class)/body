{
  CMPFieldStateFactory stateFactory;
  if (implClassName == null) {
    JDBCUserTypeMappingMetaData userMapping=(JDBCUserTypeMappingMetaData)factory.userTypeMappings.get(clazz.getName());
    if (userMapping != null) {
      implClassName=userMapping.getStateFactory();
    }
  }
  if (implClassName != null) {
    try {
      Class implClass=TCLAction.UTIL.getContextClassLoader().loadClass(implClassName);
      stateFactory=(CMPFieldStateFactory)implClass.newInstance();
    }
 catch (    Exception e) {
      throw MESSAGES.failedToCreateFieldStateFactory(implClassName,e);
    }
  }
 else   if (Map.class.isAssignableFrom(clazz)) {
    stateFactory=MAP;
  }
 else   if (List.class.isAssignableFrom(clazz)) {
    stateFactory=LIST;
  }
 else   if (Set.class.isAssignableFrom(clazz)) {
    stateFactory=SET;
  }
 else   if (clazz.isArray()) {
    stateFactory=ARRAY;
  }
 else   if (usedWithEqualsStateFactory(clazz)) {
    stateFactory=EQUALS;
  }
 else {
    stateFactory=INVALID_UNLESS_NULL;
  }
  return stateFactory;
}
