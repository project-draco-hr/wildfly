{
  this.container.start(CONTAINER);
  final ModelControllerClient client=TestSuiteEnvironment.getModelControllerClient();
  ManagementClient managementClient=new ManagementClient(client,TestSuiteEnvironment.getServerAddress(),TestSuiteEnvironment.getServerPort(),"http-remoting");
  try {
    this.deployer.deploy(DEP1);
    RemoteLatch latch=(RemoteLatch)context.lookup("ejb:/dep1/LatchBean!" + RemoteLatch.class.getName());
    final ModelNode op=new ModelNode();
    op.get(ModelDescriptionConstants.ADDRESS);
    op.get(ModelDescriptionConstants.OP_ADDR).set(new ModelNode());
    op.get(ModelDescriptionConstants.OP).set(ModelDescriptionConstants.SHUTDOWN);
    ManagementOperations.executeOperation(client,op);
    Thread.sleep(1000);
    Assert.assertEquals("Real hello",latch.getEchoMessage());
    final RemoteLatch asynchronousProxy=EJBClient.asynchronous(latch);
    asynchronousProxy.testDone();
    while (managementClient.isServerInRunningState()) {
      Thread.sleep(50);
    }
  }
  finally {
    try {
      if (!managementClient.isServerInRunningState()) {
        container.start(CONTAINER);
      }
      this.deployer.undeploy(DEP1);
      this.container.stop(CONTAINER);
    }
 catch (    Exception e) {
      logger.warn("Exception during container shutdown",e);
    }
    client.close();
  }
}
