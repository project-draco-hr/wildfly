{
  for (  AttributeDefinition def : DeploymentAttributes.SERVER_GROUP_REPLACE_DEPLOYMENT_ATTRIBUTES.values()) {
    def.validateOperation(operation);
  }
  String name=DeploymentAttributes.SERVER_GROUP_REPLACE_DEPLOYMENT_ATTRIBUTES.get(NAME).resolveModelAttribute(context,operation).asString();
  String toReplace=DeploymentAttributes.SERVER_GROUP_REPLACE_DEPLOYMENT_ATTRIBUTES.get(TO_REPLACE).resolveModelAttribute(context,operation).asString();
  if (name.equals(toReplace)) {
    throw operationFailed(MESSAGES.cannotUseSameValueForParameters(OPERATION_NAME,NAME,TO_REPLACE,ServerGroupDeploymentRedeployHandler.OPERATION_NAME,DeploymentFullReplaceHandler.OPERATION_NAME));
  }
  final PathElement deploymentPath=PathElement.pathElement(DEPLOYMENT,name);
  final PathElement replacePath=PathElement.pathElement(DEPLOYMENT,toReplace);
  Resource domainDeployment;
  try {
    domainDeployment=context.readResourceFromRoot(PathAddress.EMPTY_ADDRESS.append(deploymentPath));
  }
 catch (  NoSuchElementException e) {
    throw operationFailed(MESSAGES.noDeploymentContentWithName(name));
  }
  final ModelNode deployment=domainDeployment.getModel();
  for (  ModelNode content : deployment.require(CONTENT).asList()) {
    if ((content.hasDefined(HASH))) {
      byte[] hash=content.require(HASH).asBytes();
      fileRepository.getDeploymentFiles(hash);
    }
  }
  final Resource serverGroup=context.readResourceForUpdate(PathAddress.EMPTY_ADDRESS);
  if (!serverGroup.hasChild(replacePath)) {
    throw operationFailed(MESSAGES.noDeploymentContentWithName(toReplace));
  }
  final Resource replaceResource=context.readResourceForUpdate(PathAddress.EMPTY_ADDRESS.append(replacePath));
  final Resource deploymentResource;
  if (!serverGroup.hasChild(deploymentPath)) {
    final Resource resource=context.createResource(PathAddress.EMPTY_ADDRESS.append(deploymentPath));
    final ModelNode deployNode=resource.getModel();
    deployNode.set(deployment);
    deployNode.remove("content");
    deployNode.get(ENABLED).set(true);
  }
 else {
    deploymentResource=context.readResourceForUpdate(PathAddress.EMPTY_ADDRESS.append(deploymentPath));
    if (deploymentResource.getModel().get(ENABLED).asBoolean()) {
      throw operationFailed(MESSAGES.deploymentAlreadyStarted(toReplace));
    }
    deploymentResource.getModel().get(ENABLED).set(true);
  }
  replaceResource.getModel().get(ENABLED).set(false);
  context.stepCompleted();
}
