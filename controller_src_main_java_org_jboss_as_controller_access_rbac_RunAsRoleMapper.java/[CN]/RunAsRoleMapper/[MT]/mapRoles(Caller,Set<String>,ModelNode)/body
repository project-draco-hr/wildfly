{
  Set<String> result=currentRoles;
  ModelNode headers=operation.get(ModelDescriptionConstants.OPERATION_HEADERS);
  if (headers.isDefined() && headers.hasDefined("roles")) {
    ModelNode rolesNode=headers.get("roles");
    Set<String> roleSet=new HashSet<String>();
    if (rolesNode.getType() == ModelType.STRING) {
      String requestedRole=getRoleFromText(rolesNode.asString());
      if (canRunAs(currentRoles,requestedRole)) {
        roleSet.add(requestedRole);
      }
    }
 else {
      for (      ModelNode role : headers.get("roles").asList()) {
        String requestedRole=getRoleFromText(role.asString());
        if (canRunAs(currentRoles,requestedRole)) {
          roleSet.add(requestedRole);
        }
      }
    }
    if (roleSet.isEmpty() == false) {
      result=Collections.unmodifiableSet(roleSet);
      if (ACCESS_LOGGER.isTraceEnabled()) {
        StringBuilder sb=new StringBuilder("User '").append(caller.getName()).append("' Mapped to requested roles { ");
        for (        String current : result) {
          sb.append("'").append(current).append("' ");
        }
        sb.append("}");
        ACCESS_LOGGER.trace(sb.toString());
      }
    }
  }
  return result;
}
