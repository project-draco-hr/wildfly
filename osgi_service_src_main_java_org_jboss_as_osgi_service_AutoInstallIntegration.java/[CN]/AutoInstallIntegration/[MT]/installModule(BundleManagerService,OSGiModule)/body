{
  ModuleIdentifier identifier=moduleMetaData.getIdentifier();
  Integer startLevel=moduleMetaData.getStartLevel();
  File modulesFile=getRepositoryEntry(bundlesDir,identifier);
  if (modulesFile != null) {
    URL url=modulesFile.toURI().toURL();
    return installBundleFromURL(bundleManager,url,startLevel);
  }
  modulesFile=getRepositoryEntry(modulesDir,identifier);
  if (modulesFile != null) {
    URL url=modulesFile.toURI().toURL();
    VirtualFile virtualFile=AbstractVFS.toVirtualFile(url);
    if (BundleInfo.isValidBundle(virtualFile)) {
      log.warnf("Found OSGi bundle in modules hirachy: %s",modulesFile);
      return installBundleFromURL(bundleManager,url,startLevel);
    }
  }
  ModuleLoader moduleLoader=Module.getBootModuleLoader();
  Module module=moduleLoader.loadModule(identifier);
  OSGiMetaData metadata=getModuleMetadata(module);
  return bundleManager.registerModule(serviceTarget,module,metadata);
}
