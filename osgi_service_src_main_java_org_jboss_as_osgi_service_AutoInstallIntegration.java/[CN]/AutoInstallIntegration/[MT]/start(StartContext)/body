{
  serviceController=context.getController();
  log.debugf("Starting: %s in mode %s",serviceController.getName(),serviceController.getMode());
  final Map<ServiceName,OSGiModule> pendingServices=new LinkedHashMap<ServiceName,OSGiModule>();
  try {
    final BundleManagerService bundleManager=injectedBundleManager.getValue();
    final ServiceContainer serviceContainer=serviceController.getServiceContainer();
    serviceTarget=context.getChildTarget();
    final File modulesDir=injectedEnvironment.getValue().getModulesDir();
    bundlesDir=new File(modulesDir.getPath() + "/../bundles").getCanonicalFile();
    if (bundlesDir.isDirectory() == false)     throw new IllegalStateException("Cannot find bundles directory: " + bundlesDir);
    injectedSubsystemState.getValue().addObserver(this);
    for (    OSGiModule moduleMetaData : injectedSubsystemState.getValue().getModules()) {
      ServiceName serviceName=installModule(bundleManager,moduleMetaData);
      pendingServices.put(serviceName,moduleMetaData);
    }
    ServiceName servicesInstalled=Services.AUTOINSTALL_PROVIDER.append("INSTALLED");
    ServiceBuilder<Void> builder=serviceTarget.addService(servicesInstalled,new AbstractService<Void>(){
      public void start(      StartContext context) throws StartException {
        log.debugf("Auto bundles installed");
      }
    }
);
    builder.addDependencies(pendingServices.keySet());
    builder.install();
    builder=serviceTarget.addService(Services.AUTOINSTALL_PROVIDER_COMPLETE,new AbstractService<Void>(){
      public void start(      StartContext context) throws StartException {
        for (        ServiceName serviceName : pendingServices.keySet()) {
          OSGiModule moduleMetaData=pendingServices.get(serviceName);
          startBundle(serviceContainer,serviceName,moduleMetaData);
        }
        log.debugf("Auto bundles bundles started");
      }
    }
);
    builder.addDependencies(servicesInstalled);
    builder.install();
  }
 catch (  Exception ex) {
    throw new StartException("Failed to create auto install list",ex);
  }
}
