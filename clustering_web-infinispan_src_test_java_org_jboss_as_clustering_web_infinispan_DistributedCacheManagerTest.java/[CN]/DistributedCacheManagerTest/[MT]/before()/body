{
  ConfigurationBuilder builder=new ConfigurationBuilder();
  builder.clustering().cacheMode(CacheMode.DIST_SYNC);
  KeyAffinityServiceFactory affinityFactory=mock(KeyAffinityServiceFactory.class);
  @SuppressWarnings("rawtypes") ArgumentCaptor<KeyGenerator> capturedKeyGenerator=ArgumentCaptor.forClass(KeyGenerator.class);
  when(this.cache.getCacheConfiguration()).thenReturn(builder.build());
  when(affinityFactory.createService(same(this.cache),capturedKeyGenerator.capture())).thenReturn(this.affinity);
  this.manager=new DistributedCacheManager<OutgoingDistributableSessionData>(this.sessionManager,this.cache,this.registry,this.lockManager,this.storage,this.batchingManager,this.invoker,affinityFactory);
  assertSame(this.manager,capturedKeyGenerator.getValue());
  reset(this.cache);
}
