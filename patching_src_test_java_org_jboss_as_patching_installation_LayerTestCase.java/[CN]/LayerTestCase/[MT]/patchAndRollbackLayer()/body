{
  String layerName=randomString();
  installLayer(env.getModuleRoot(),env.getInstalledImage().getLayersConf(),layerName);
  InstalledIdentity installedIdentity=loadInstalledIdentity();
  PatchableTarget.TargetInfo identityInfo=installedIdentity.getIdentity().loadTargetInfo();
  assertEquals(BASE,identityInfo.getCumulativePatchID());
  assertTrue(identityInfo.getPatchIDs().isEmpty());
  String patchID=randomString();
  File patchDir=mkdir(tempDir,patchID);
  String layerPatchId="mylayerPatchID";
  String moduleName=randomString();
  ContentModification moduleAdded=ContentModificationUtils.addModule(patchDir,layerPatchId,moduleName);
  ContentModification fileAdded=ContentModificationUtils.addMisc(patchDir,patchID,"new file resource","bin","my-new-standalone.sh");
  Patch patch=PatchBuilder.create().setPatchId(patchID).oneOffPatchIdentity(installedIdentity.getIdentity().getName(),installedIdentity.getIdentity().getVersion()).getParent().oneOffPatchElement(layerPatchId,layerName,false).addContentModification(moduleAdded).getParent().addContentModification(fileAdded).build();
  createPatchXMLFile(patchDir,patch);
  File zippedPatch=createZippedPatchFile(patchDir,patchID);
  Identity identityBeforePatch=loadInstalledIdentity().getIdentity();
  PatchingResult patchResult=executePatch(zippedPatch);
  assertPatchHasBeenApplied(patchResult,patch);
  InstalledIdentity patchedInstalledIdentity=InstalledIdentity.load(env.getInstalledImage().getJbossHome(),productConfig,env.getInstalledImage().getModulesDir());
  assertInstallationIsPatched(patch,patchedInstalledIdentity.getIdentity().loadTargetInfo());
  assertFileExists(env.getInstalledImage().getJbossHome(),"bin",fileAdded.getItem().getName());
  DirectoryStructure layerDirStructure=patchedInstalledIdentity.getLayers().get(0).loadTargetInfo().getDirectoryStructure();
  File modulesPatchDir=layerDirStructure.getModulePatchDirectory(layerPatchId);
  assertDirExists(modulesPatchDir);
  assertDefinedModule(modulesPatchDir,moduleName,moduleAdded.getItem().getContentHash());
  PatchingResult rollbackResult=rollback(patchID);
  assertPatchHasBeenRolledBack(rollbackResult,identityBeforePatch);
  InstalledIdentity rolledBackInstalledIdentity=InstalledIdentity.load(env.getInstalledImage().getJbossHome(),productConfig,env.getInstalledImage().getModulesDir());
  PatchingAssert.assertFileDoesNotExist(env.getInstalledImage().getJbossHome(),"bin",fileAdded.getItem().getName());
  if (File.separatorChar != '\\') {
    assertDirDoesNotExist(rolledBackInstalledIdentity.getLayers().get(0).loadTargetInfo().getDirectoryStructure().getModulePatchDirectory(layerPatchId));
  }
}
