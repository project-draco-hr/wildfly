{
  final Enumeration<NetworkInterface> networkInterfaces=NetworkInterface.getNetworkInterfaces();
  while (networkInterfaces.hasMoreElements()) {
    final NetworkInterface networkInterface=networkInterfaces.nextElement();
    final Enumeration<InetAddress> interfaceAddresses=networkInterface.getInetAddresses();
    while (interfaceAddresses.hasMoreElements()) {
      final InetAddress address=interfaceAddresses.nextElement();
      if (preferIPv4Stack && !preferIPv6Stack && !(address instanceof Inet4Address)) {
        continue;
      }
 else       if (preferIPv6Stack && !preferIPv4Stack && !(address instanceof Inet6Address)) {
        continue;
      }
      if (criteria.isAcceptable(networkInterface,address)) {
        return new NetworkInterfaceBinding(Collections.singleton(networkInterface),address);
      }
    }
  }
  return null;
}
