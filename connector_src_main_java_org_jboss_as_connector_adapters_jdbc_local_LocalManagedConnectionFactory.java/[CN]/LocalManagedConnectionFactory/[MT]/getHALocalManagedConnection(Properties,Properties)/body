{
  boolean trace=log.isTraceEnabled();
  for (int i=0; i < urlSelector.getCustomSortedUrls().size(); ++i) {
    String url=(String)urlSelector.getUrlObject();
    if (trace) {
      log.trace("Trying to create a connection to " + url);
    }
    Connection con=null;
    try {
      Driver d=getDriver(url);
      con=d.connect(url,copy);
      if (con == null) {
        log.warn("Wrong driver class [" + d.getClass() + "] for this connection URL: "+ url);
        urlSelector.failedUrlObject(url);
      }
 else {
        return new LocalManagedConnection(this,con,props,transactionIsolation,preparedStatementCacheSize);
      }
    }
 catch (    Exception e) {
      if (con != null) {
        try {
          con.close();
        }
 catch (        Throwable ignored) {
        }
      }
      log.warn("Failed to create connection for " + url + ": "+ e.getMessage());
      urlSelector.failedUrlObject(url);
    }
  }
  throw new ResourceException("Could not create connection using any of the URLs: " + urlSelector.getAllUrlObjects());
}
