{
  try {
    final File patchXml=new File(workDir,PatchXml.PATCH_XML);
    final InputStream patchIS=new FileInputStream(patchXml);
    final Patch patch;
    try {
      patch=PatchXml.parse(patchIS);
      patchIS.close();
    }
  finally {
      PatchUtils.safeClose(patchIS);
    }
    final List<String> appliesTo=patch.getAppliesTo();
    if (!appliesTo.contains(patchInfo.getVersion())) {
      throw PatchMessages.MESSAGES.doesNotApply(appliesTo,patchInfo.getVersion());
    }
    final PatchingContext context=PatchingContext.create(patch,patchInfo,structure,policy,workDir);
    try {
      return executeTasks(patch,context);
    }
 catch (    Exception e) {
      context.undo();
      throw rethrowException(e);
    }
  }
 catch (  IOException e) {
    throw new PatchingException(e);
  }
catch (  XMLStreamException e) {
    throw new PatchingException(e);
  }
}
