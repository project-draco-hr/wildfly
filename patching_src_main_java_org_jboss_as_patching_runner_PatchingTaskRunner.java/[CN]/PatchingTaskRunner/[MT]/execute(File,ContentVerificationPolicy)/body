{
  try {
    final File patchXml=new File(workDir,PatchXml.PATCH_XML);
    final InputStream patchIS=new FileInputStream(patchXml);
    final Patch patch;
    try {
      patch=PatchXml.parse(patchIS);
      patchIS.close();
    }
  finally {
      safeClose(patchIS);
    }
    final String patchId=patch.getPatchId();
    final List<String> appliesTo=patch.getAppliesTo();
    if (!appliesTo.contains(patchInfo.getVersion())) {
      throw PatchMessages.MESSAGES.doesNotApply(appliesTo,patchInfo.getVersion());
    }
    if (patchInfo.getCumulativeID().equals(patchId)) {
      throw PatchMessages.MESSAGES.alreadyApplied(patchId);
    }
    if (patchInfo.getPatchIDs().contains(patchId)) {
      throw PatchMessages.MESSAGES.alreadyApplied(patchId);
    }
    final PatchingContext context=PatchingContext.create(patch,patchInfo,structure,policy,workDir);
    final PatchingContext.TaskFinishCallback task=new PatchingApplyCallback(patch,patchId,structure);
    try {
      return applyPatch(patch,context,task);
    }
 catch (    Exception e) {
      try {
        context.undo();
      }
  finally {
        task.rollbackCallback();
      }
      throw rethrowException(e);
    }
  }
 catch (  IOException e) {
    throw new PatchingException(e);
  }
catch (  XMLStreamException e) {
    throw new PatchingException(e);
  }
}
