{
  final InputStream source=this.source;
  final String processName=ManagedProcess.this.processName;
  try {
    final BufferedReader reader=new BufferedReader(new InputStreamReader(new BufferedInputStream(source)));
    final OutputStreamWriter writer=new OutputStreamWriter(target);
    String s;
    String prevEscape="";
    while ((s=reader.readLine()) != null) {
      int i=s.lastIndexOf('\033');
      int j=i != -1 ? s.indexOf('m',i) : 0;
synchronized (target) {
        writer.write('[');
        writer.write(processName);
        writer.write("] ");
        writer.write(prevEscape);
        writer.write(s);
        if (j != 0 || prevEscape != "") {
          writer.write("\033[0m");
        }
        writer.write('\n');
        writer.flush();
      }
      if (j != 0) {
        String escape=s.substring(i,j + 1);
        if (!"\033[0m".equals(escape)) {
          prevEscape=escape;
        }
 else {
          prevEscape="";
        }
      }
    }
    source.close();
  }
 catch (  IOException e) {
    log.streamProcessingFailed(processName,e);
  }
 finally {
    StreamUtils.safeClose(source);
  }
}
