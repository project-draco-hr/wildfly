{
  deployer.undeploy(DEPLOYMENT_2);
  controller.stop(CONTAINER_2);
  DefaultHttpClient client=org.jboss.as.test.http.util.HttpClientUtils.relaxedCookieHttpClient();
  String url1=baseURL1.toString() + "count";
  String url2=baseURL2.toString() + "count";
  System.out.println("URLs are: " + url1 + ", "+ url2);
  try {
    this.establishView(client,baseURL1,NODE_1);
    assertEquals(20010101,this.queryCount(client,url1));
    assertEquals(20020202,this.queryCount(client,url1));
    controller.start(CONTAINER_2);
    deployer.deploy(DEPLOYMENT_2);
    this.establishView(client,baseURL1,NODE_1,NODE_2);
    assertEquals(20030303,this.queryCount(client,url1));
    assertEquals(20040404,this.queryCount(client,url1));
    assertEquals(20050505,this.queryCount(client,url2));
    assertEquals(20060606,this.queryCount(client,url2));
    controller.stop(CONTAINER_2);
    this.establishView(client,baseURL1,NODE_1);
    assertEquals(20070707,this.queryCount(client,url1));
    assertEquals(20080808,this.queryCount(client,url1));
    controller.start(CONTAINER_2);
    this.establishView(client,baseURL1,NODE_1,NODE_2);
    assertEquals(20090909,this.queryCount(client,url1));
    assertEquals(20101010,this.queryCount(client,url1));
    assertEquals(20111111,this.queryCount(client,url2));
    assertEquals(20121212,this.queryCount(client,url2));
    controller.stop(CONTAINER_1);
    this.establishView(client,baseURL2,NODE_2);
    assertEquals(20131313,this.queryCount(client,url2));
    assertEquals(20141414,this.queryCount(client,url2));
    controller.start(CONTAINER_1);
    this.establishView(client,baseURL2,NODE_1,NODE_2);
    assertEquals(20151515,this.queryCount(client,url1));
    assertEquals(20161616,this.queryCount(client,url1));
    assertEquals(20171717,this.queryCount(client,url1));
    assertEquals(20181818,this.queryCount(client,url1));
  }
  finally {
    HttpClientUtils.closeQuietly(client);
    this.cleanup(DEPLOYMENT_1,CONTAINER_1);
    this.cleanup(DEPLOYMENT_2,CONTAINER_2);
  }
}
