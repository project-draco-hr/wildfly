{
  pushSingleResponse(responseQueue,new StreamedResponse((byte)DomainClientProtocol.RETURN_DEPLOYMENT_PLAN_ID,plan.getId()));
  List<DeploymentSetPlan> setPlans=plan.getDeploymentSetPlans();
  List<DeploymentSetUpdates> updateSets=new ArrayList<DeploymentSetUpdates>(setPlans.size());
  for (  DeploymentSetPlan setPlan : setPlans) {
    try {
      updateSets.add(createDeploymentSetUpdates(setPlan,getDomainModel(),setPlan.getDeploymentActions()));
    }
 catch (    InvalidDeploymentPlanException e) {
      logger.errorf(e,"Deployment plan %s is invalid",plan.getId());
      pushSingleResponse(responseQueue,new StreamedResponse((byte)DomainClientProtocol.RETURN_DEPLOYMENT_PLAN_INVALID,e,true));
      return;
    }
  }
  List<DeploymentSetUpdates> rollbackSets=new ArrayList<DeploymentSetUpdates>(setPlans.size());
  boolean ok=true;
  boolean rollbackFailed=false;
  for (  DeploymentSetUpdates updateSet : updateSets) {
    if (ok) {
      try {
        ok=executeDeploymentSet(updateSet,responseQueue);
        if (ok) {
          rollbackSets.add(0,updateSet);
        }
 else {
          logger.debugf("Deployment set %s did not succeed",updateSet.setPlan.getId());
        }
      }
 catch (      RollbackFailedException e) {
        ok=false;
        rollbackFailed=true;
        logger.errorf("Rollback of deployment set %s did not succeed",updateSet.setPlan.getId());
      }
    }
 else {
      cancelDeploymentSet(updateSet,false,responseQueue);
    }
  }
  if (plan.isGlobalRollback()) {
    if (!ok && !rollbackFailed) {
      for (Iterator<DeploymentSetUpdates> iter=rollbackSets.iterator(); iter.hasNext(); ) {
        DeploymentSetUpdates updateSet=iter.next();
        try {
          rollbackDeploymentSet(updateSet,responseQueue);
          iter.remove();
        }
 catch (        RollbackFailedException e) {
          rollbackFailed=true;
          logger.errorf("Rollback of deployment set %s did not succeed",updateSet.setPlan.getId());
          break;
        }
      }
    }
    if (rollbackFailed) {
      for (      DeploymentSetUpdates updateSet : rollbackSets) {
        cancelDeploymentSet(updateSet,true,responseQueue);
      }
    }
  }
  pushSingleResponse(responseQueue,new StreamedResponse((byte)DomainClientProtocol.RETURN_DEPLOYMENT_PLAN_COMPLETE,null,true));
}
