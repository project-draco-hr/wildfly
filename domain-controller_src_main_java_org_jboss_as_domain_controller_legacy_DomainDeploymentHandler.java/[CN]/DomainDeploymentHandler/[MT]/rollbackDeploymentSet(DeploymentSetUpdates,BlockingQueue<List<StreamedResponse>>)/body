{
  logger.debugf("Rolling back deployment set %s",updateSet.setPlan.getId());
  List<DomainUpdateApplierResponse> rsps=domainController.applyUpdatesToModel(updateSet.getDomainRollbacks());
  pushSingleResponse(responseQueue,new StreamedResponse((byte)DomainClientProtocol.RETURN_DEPLOYMENT_SET_ROLLBACK,updateSet.setPlan.getId()));
  DeploymentAction lastResponseAction=null;
  for (int i=0; i < rsps.size(); i++) {
    DomainUpdateApplierResponse duar=rsps.get(i);
    if (duar.getDomainFailure() != null || duar.getHostFailures().size() > 0 || updateSet.isLastDomainRollbackForAction(i)) {
      DeploymentAction action=updateSet.getDeploymentActionForDomainUpdate(i);
      if (action != lastResponseAction) {
        List<StreamedResponse> rspList=new ArrayList<StreamedResponse>(2);
        rspList.add(new StreamedResponse((byte)DomainClientProtocol.RETURN_DEPLOYMENT_ACTION_ID,action.getId()));
        rspList.add(new StreamedResponse((byte)DomainClientProtocol.RETURN_DEPLOYMENT_ACTION_MODEL_RESULT,duar));
        responseQueue.put(rspList);
        lastResponseAction=action;
      }
    }
  }
  DomainUpdateApplierResponse last=rsps.get(rsps.size() - 1);
  if (last.getDomainFailure() != null || last.getHostFailures().size() > 0) {
    throw new RollbackFailedException();
  }
  Runnable r=getServerUpdateTask(updateSet,rsps,true,responseQueue);
  r.run();
  for (  ServerUpdatePolicy policy : updateSet.rollbackPolicies.values()) {
    if (policy.isFailed()) {
      throw new RollbackFailedException();
    }
  }
}
