{
  boolean inContainer=true;
  Run run=testClass.getAnnotation(Run.class);
  if (run != null) {
    inContainer=run.value() == RunModeType.IN_CONTAINER;
  }
  if (inContainer) {
    final Manifest manifest=getOrCreateManifest(applicationArchive);
    Attributes attributes=manifest.getMainAttributes();
    attributes.putValue("Arquillian-deployment","true");
    ((ManifestContainer<?>)applicationArchive).setManifest(new Asset(){
      public InputStream openStream(){
        try {
          manifest.write(System.out);
          ByteArrayOutputStream baos=new ByteArrayOutputStream();
          manifest.write(baos);
          return new ByteArrayInputStream(baos.toByteArray());
        }
 catch (        IOException ex) {
          throw new IllegalStateException("Cannot write manifest",ex);
        }
      }
    }
);
  }
}
