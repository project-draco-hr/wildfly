{
  final String opName=operation.require(OP).asString();
  final PathAddress address=PathAddress.pathAddress(operation.require(OP_ADDR));
  final ModelNode result=new ModelNode();
  final ModelNode profile=context.readModel(PathAddress.EMPTY_ADDRESS);
  result.setEmptyList();
  final ImmutableManagementResourceRegistration registry=context.getResourceRegistration();
  final AtomicReference<ModelNode> failureRef=new AtomicReference<ModelNode>();
  final ModelNode subsystemResults=new ModelNode().setEmptyList();
  final Map<String,ModelNode> includeResults=new HashMap<String,ModelNode>();
  context.addStep(new OperationStepHandler(){
    @Override public void execute(    OperationContext context,    ModelNode operation) throws OperationFailedException {
      boolean failed=false;
      if (failureRef.get() != null) {
        context.getFailureDescription().set(failureRef.get());
        failed=true;
      }
 else {
        for (        ModelNode includeRsp : includeResults.values()) {
          if (includeRsp.hasDefined(FAILURE_DESCRIPTION)) {
            context.getFailureDescription().set(includeRsp.get(FAILURE_DESCRIPTION));
            failed=true;
            break;
          }
          ModelNode includeResult=includeRsp.get(RESULT);
          if (includeResult.isDefined()) {
            for (            ModelNode op : includeResult.asList()) {
              result.add(op);
            }
          }
        }
      }
      if (!failed) {
        for (        ModelNode subsysRsp : subsystemResults.asList()) {
          result.add(subsysRsp);
        }
        context.getResult().set(result);
      }
      context.stepCompleted();
    }
  }
,OperationContext.Stage.IMMEDIATE);
  if (profile.hasDefined(SUBSYSTEM)) {
    for (    final String subsystemName : profile.get(SUBSYSTEM).keys()) {
      final ModelNode subsystemRsp=new ModelNode();
      PathElement pe=PathElement.pathElement(SUBSYSTEM,subsystemName);
      PathAddress fullAddress=address.append(pe);
      final ModelNode subsystemAddress=fullAddress.toModelNode();
      final ModelNode newOp=operation.clone();
      newOp.get(OP_ADDR).set(subsystemAddress);
      PathAddress relativeAddress=PathAddress.pathAddress(pe);
      OperationStepHandler subsysHandler=registry.getOperationHandler(relativeAddress,opName);
      if (subsysHandler == null) {
        String errMsg;
        ImmutableManagementResourceRegistration child=registry.getSubModel(relativeAddress);
        if (child == null) {
          errMsg=ControllerMessages.MESSAGES.noSuchResourceType(fullAddress);
        }
 else {
          errMsg=ControllerMessages.MESSAGES.noHandlerForOperation(opName,fullAddress);
        }
        throw new OperationFailedException(new ModelNode(errMsg));
      }
      context.addStep(new OperationStepHandler(){
        @Override public void execute(        OperationContext context,        ModelNode operation) throws OperationFailedException {
          if (failureRef.get() == null) {
            if (subsystemRsp.hasDefined(FAILURE_DESCRIPTION)) {
              failureRef.set(subsystemRsp.get(FAILURE_DESCRIPTION));
            }
 else             if (subsystemRsp.hasDefined(RESULT)) {
              for (              ModelNode op : subsystemRsp.require(RESULT).asList()) {
                subsystemResults.add(op);
              }
            }
          }
          context.stepCompleted();
        }
      }
,OperationContext.Stage.IMMEDIATE);
      context.addStep(subsystemRsp,newOp,subsysHandler,OperationContext.Stage.IMMEDIATE);
    }
  }
  if (profile.hasDefined(INCLUDES)) {
    for (    ModelNode include : profile.get(INCLUDES).asList()) {
      final String includeName=include.asString();
      final ModelNode includeRsp=new ModelNode();
      includeResults.put(includeName,includeRsp);
      final ModelNode includeAddress=address.subAddress(0,address.size() - 1).append(PathElement.pathElement(PROFILE,includeName)).toModelNode();
      final ModelNode newOp=operation.clone();
      newOp.get(OP_ADDR).set(includeAddress);
      context.addStep(includeRsp,newOp,INSTANCE,OperationContext.Stage.IMMEDIATE);
    }
  }
  context.stepCompleted();
}
