{
synchronized (parent) {
    if (parent.hasChild(element)) {
      if (desired == null) {
        return parent.requireChild(element);
      }
 else {
        throw new IllegalStateException();
      }
    }
 else {
      Resource toRegister=desired;
      if (toRegister == null) {
        toRegister=Resource.Factory.create();
      }
      parent.registerChild(element,toRegister);
      return toRegister;
    }
  }
}
