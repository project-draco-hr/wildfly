{
  final DataOutputStream outputStream;
  final MessageOutputStream messageOutputStream;
  try {
    messageOutputStream=channelAssociation.acquireChannelMessageOutputStream();
  }
 catch (  Exception e) {
    throw EjbMessages.MESSAGES.failedToOpenMessageOutputStream(e);
  }
  outputStream=new DataOutputStream(messageOutputStream);
  final ClusterTopologyWriter clusterTopologyWriter=new ClusterTopologyWriter();
  try {
    if (EjbLogger.ROOT_LOGGER.isDebugEnabled()) {
      EjbLogger.ROOT_LOGGER.debug("Following " + addedNodes.size() + " nodes added to cluster "+ clusterName+ ", writing a protocol message to channel "+ this.channelReceiver.channelAssociation.getChannel());
      final StringBuffer sb=new StringBuffer();
      for (      final String nodeName : addedNodes.keySet()) {
        sb.append(nodeName);
        sb.append("\n");
      }
      EjbLogger.ROOT_LOGGER.debug(sb.toString());
    }
    clusterTopologyWriter.writeNewNodesAdded(outputStream,clusterName,addedNodes);
  }
  finally {
    channelAssociation.releaseChannelMessageOutputStream(messageOutputStream);
    outputStream.close();
  }
}
