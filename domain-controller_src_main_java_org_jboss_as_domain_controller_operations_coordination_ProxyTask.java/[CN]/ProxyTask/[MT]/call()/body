{
  boolean trace=PrepareStepHandler.isTraceEnabled();
  if (trace) {
    PrepareStepHandler.log.trace("Sending " + operation + " to "+ host);
  }
  OperationMessageHandler messageHandler=new DelegatingMessageHandler(context);
  final AtomicReference<ModelController.OperationTransaction> txRef=new AtomicReference<ModelController.OperationTransaction>();
  final AtomicReference<ModelNode> preparedResultRef=new AtomicReference<ModelNode>();
  final AtomicReference<ModelNode> finalResultRef=new AtomicReference<ModelNode>();
  final ProxyController.ProxyOperationControl proxyControl=new ProxyController.ProxyOperationControl(){
    @Override public void operationPrepared(    ModelController.OperationTransaction transaction,    ModelNode result){
      txRef.set(transaction);
      preparedResultRef.set(result);
    }
    @Override public void operationFailed(    ModelNode response){
      finalResultRef.set(response);
    }
    @Override public void operationCompleted(    ModelNode response){
      finalResultRef.set(response);
    }
  }
;
  proxyController.execute(operation,messageHandler,proxyControl,new DelegatingOperationAttachments(context));
  ModelController.OperationTransaction remoteTransaction=null;
  ModelNode result=finalResultRef.get();
  if (result != null) {
    if (trace) {
      PrepareStepHandler.log.trace("Received final result " + result + " from "+ host);
    }
  }
 else {
    result=preparedResultRef.get();
    if (trace) {
      PrepareStepHandler.log.trace("Received prepared result " + result + " from "+ host);
    }
    remoteTransaction=txRef.get();
  }
synchronized (uncommittedResultRef) {
    uncommittedResultRef.set(result);
    uncommittedResultRef.notifyAll();
  }
  if (remoteTransaction != null) {
    if (cancelRemoteTransaction) {
      remoteTransaction.rollback();
    }
 else {
synchronized (transactionAction) {
        while (transactionAction.get() == null) {
          try {
            transactionAction.wait();
          }
 catch (          InterruptedException ie) {
            transactionAction.set(Boolean.FALSE);
          }
        }
        if (transactionAction.get().booleanValue()) {
          remoteTransaction.commit();
        }
 else {
          remoteTransaction.rollback();
        }
      }
    }
  }
  return finalResultRef.get();
}
