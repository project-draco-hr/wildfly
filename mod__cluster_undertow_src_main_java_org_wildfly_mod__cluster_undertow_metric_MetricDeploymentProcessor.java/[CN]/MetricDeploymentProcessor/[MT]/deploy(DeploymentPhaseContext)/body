{
  DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  List<HandlerWrapper> handlerAttachment=deploymentUnit.getAttachment(UndertowAttachments.UNDERTOW_INITIAL_HANDLER_CHAIN_WRAPPERS);
  if (handlerAttachment == null) {
    handlerAttachment=new LinkedList<HandlerWrapper>();
    deploymentUnit.putAttachment(UndertowAttachments.UNDERTOW_INITIAL_HANDLER_CHAIN_WRAPPERS,handlerAttachment);
  }
  if (isMetricEnabled(RequestCountLoadMetric.class)) {
    handlerAttachment.add(new HandlerWrapper(){
      @Override public HttpHandler wrap(      final HttpHandler handler){
        return new RequestCountHttpHandler(handler);
      }
    }
);
  }
  if (isMetricEnabled(SendTrafficLoadMetric.class)) {
    handlerAttachment.add(new HandlerWrapper(){
      @Override public HttpHandler wrap(      final HttpHandler handler){
        return new BytesSentHttpHandler(handler);
      }
    }
);
  }
  if (isMetricEnabled(ReceiveTrafficLoadMetric.class)) {
    handlerAttachment.add(new HandlerWrapper(){
      @Override public HttpHandler wrap(      final HttpHandler handler){
        return new BytesReceivedHttpHandler(handler);
      }
    }
);
  }
  if (isMetricEnabled(BusyConnectorsLoadMetric.class)) {
    List<HandlerWrapper> outerHandlerAttachment=deploymentUnit.getAttachment(UndertowAttachments.UNDERTOW_OUTER_HANDLER_CHAIN_WRAPPERS);
    if (outerHandlerAttachment == null) {
      outerHandlerAttachment=new LinkedList<HandlerWrapper>();
      deploymentUnit.putAttachment(UndertowAttachments.UNDERTOW_OUTER_HANDLER_CHAIN_WRAPPERS,outerHandlerAttachment);
    }
    outerHandlerAttachment.add(new HandlerWrapper(){
      @Override public HttpHandler wrap(      final HttpHandler handler){
        return new RunningRequestsHttpHandler(handler);
      }
    }
);
  }
}
