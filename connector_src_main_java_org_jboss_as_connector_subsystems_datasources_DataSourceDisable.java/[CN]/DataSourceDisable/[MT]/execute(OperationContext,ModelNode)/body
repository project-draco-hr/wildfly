{
  final ModelNode model=context.readResourceForUpdate(PathAddress.EMPTY_ADDRESS).getModel();
  model.get(ENABLED).set(false);
  if (context.getType() == OperationContext.Type.SERVER) {
    context.addStep(new OperationStepHandler(){
      public void execute(      final OperationContext context,      ModelNode operation) throws OperationFailedException {
        final ModelNode address=operation.require(OP_ADDR);
        final String dsName=PathAddress.pathAddress(address).getLastElement().getValue();
        final ServiceRegistry registry=context.getServiceRegistry(true);
        final ServiceName dataSourceServiceName=AbstractDataSourceService.SERVICE_NAME_BASE.append(dsName);
        final ServiceController<?> dataSourceController=registry.getService(dataSourceServiceName);
        if (dataSourceController != null) {
          if (ServiceController.State.UP.equals(dataSourceController.getState())) {
            dataSourceController.setMode(ServiceController.Mode.NEVER);
          }
 else {
            throw new OperationFailedException(new ModelNode().set(MESSAGES.serviceNotEnabled("Data-source",dsName)));
          }
        }
 else {
          throw new OperationFailedException(new ModelNode().set(MESSAGES.serviceNotAvailable("Data-source",dsName)));
        }
        final ServiceName referenceServiceName=DataSourceReferenceFactoryService.SERVICE_NAME_BASE.append(dsName);
        final ServiceController<?> referenceController=registry.getService(referenceServiceName);
        if (referenceController != null && ServiceController.State.UP.equals(referenceController.getState())) {
          referenceController.setMode(ServiceController.Mode.NEVER);
        }
        final ServiceName binderServiceName=ContextNames.bindInfoFor(dsName).getBinderServiceName();
        final ServiceController<?> binderController=registry.getService(binderServiceName);
        if (binderController != null && ServiceController.State.UP.equals(binderController.getState())) {
          binderController.setMode(ServiceController.Mode.NEVER);
        }
        context.completeStep();
      }
    }
,OperationContext.Stage.RUNTIME);
  }
  context.completeStep();
}
