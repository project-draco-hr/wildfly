{
  final InvocationType marker=context.getPrivateData(InvocationType.class);
  if (!alwaysActivate && (marker == null || !INVOCATION_TYPES.contains(marker))) {
    return context.proceed();
  }
  if (requestContext == null) {
    final WeldContainer weldContainer=(WeldContainer)CurrentServiceContainer.getServiceContainer().getRequiredService(weldContainerServiceName).getValue();
    final BeanManagerImpl beanManager=(BeanManagerImpl)weldContainer.getBeanManager();
    final Bean<?> bean=beanManager.resolve(beanManager.getBeans(EjbRequestContext.class,EjbLiteral.INSTANCE));
    final CreationalContext<?> ctx=beanManager.createCreationalContext(bean);
    requestContext=(EjbRequestContext)beanManager.getReference(bean,EjbRequestContext.class,ctx);
  }
  try {
    requestContext.associate(context.getInvocationContext());
    requestContext.activate();
    return context.proceed();
  }
  finally {
    requestContext.deactivate();
    requestContext.dissociate(context.getInvocationContext());
  }
}
