{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final EEModuleConfiguration moduleConfiguration=deploymentUnit.getAttachment(Attachments.EE_MODULE_CONFIGURATION);
  final EEModuleDescription moduleDescription=deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
  if (moduleConfiguration == null) {
    return;
  }
  final Map<ServiceName,BindingConfiguration> existingBindings=new HashMap<ServiceName,BindingConfiguration>();
  final Map<ServiceName,BindingConfiguration> deploymentDescriptorBindings=new HashMap<ServiceName,BindingConfiguration>();
  final Set<BindingConfiguration> bindingConfigurations=new HashSet<BindingConfiguration>(moduleConfiguration.getBindingConfigurations());
  for (  BindingConfiguration binding : bindingConfigurations) {
    final ServiceName serviceName=ContextNames.serviceNameOfEnvEntry(moduleConfiguration.getApplicationName(),moduleConfiguration.getModuleName(),null,false,binding.getName());
    final BindingConfiguration existingConfiguration=existingBindings.get(serviceName);
    if (existingConfiguration != null && !existingConfiguration.equals(binding)) {
      throw new DeploymentUnitProcessingException("Multiple module level bindings with the same name at " + binding.getName() + " "+ binding+ " and "+ existingConfiguration);
    }
    existingBindings.put(serviceName,binding);
    deploymentDescriptorBindings.put(serviceName,binding);
    addJndiBinding(moduleConfiguration,binding,phaseContext,serviceName);
  }
  boolean bindDefaultInterceptorsToModuleContext=false;
  for (  final ComponentConfiguration componentConfiguration : moduleConfiguration.getComponentConfigurations()) {
    final Set<BindingConfiguration> componentLevelBindings=new HashSet(componentConfiguration.getBindingConfigurations());
    for (    BindingConfiguration binding : componentLevelBindings) {
      final String bindingName=binding.getName();
      final boolean compBinding=bindingName.startsWith("java:comp") || !bindingName.startsWith("java:");
      if (componentConfiguration.getComponentDescription().getNamingMode() == ComponentNamingMode.CREATE && compBinding) {
        continue;
      }
      if (!componentConfiguration.getComponentDescription().isExcludeDefaultInterceptors()) {
        bindDefaultInterceptorsToModuleContext=true;
      }
      final ServiceName serviceName=ContextNames.serviceNameOfEnvEntry(moduleConfiguration.getApplicationName(),moduleConfiguration.getModuleName(),null,false,binding.getName());
      final BindingConfiguration existingConfiguration=existingBindings.get(serviceName);
      if (existingConfiguration != null && !existingConfiguration.equals(binding)) {
        throw new DeploymentUnitProcessingException("Multiple module level bindings with the same name at " + binding.getName() + " "+ binding+ " and "+ existingConfiguration);
      }
      existingBindings.put(serviceName,binding);
      deploymentDescriptorBindings.put(serviceName,binding);
      addJndiBinding(moduleConfiguration,binding,phaseContext,serviceName);
    }
  }
  final Set<String> handledClasses=new HashSet<String>();
  if (bindDefaultInterceptorsToModuleContext) {
    for (    final InterceptorDescription defaultInterceptor : moduleDescription.getDefaultInterceptors()) {
      final EEModuleClassConfiguration classConfig=moduleConfiguration.getClassConfiguration(defaultInterceptor.getInterceptorClassName());
      processClassConfigurations(phaseContext,moduleConfiguration,existingBindings,deploymentDescriptorBindings,handledClasses,ComponentNamingMode.USE_MODULE,Collections.singleton(classConfig));
    }
  }
  for (  final ComponentConfiguration componentConfiguration : moduleConfiguration.getComponentConfigurations()) {
    final Set<EEModuleClassConfiguration> classConfigurations=new HashSet<EEModuleClassConfiguration>();
    classConfigurations.add(componentConfiguration.getModuleClassConfiguration());
    for (    final InterceptorDescription interceptor : componentConfiguration.getComponentDescription().getAllInterceptors().values()) {
      final EEModuleClassConfiguration interceptorClass=moduleConfiguration.getClassConfiguration(interceptor.getInterceptorClassName());
      if (interceptorClass != null) {
        classConfigurations.add(interceptorClass);
      }
    }
    processClassConfigurations(phaseContext,moduleConfiguration,existingBindings,deploymentDescriptorBindings,handledClasses,componentConfiguration.getComponentDescription().getNamingMode(),classConfigurations);
  }
}
