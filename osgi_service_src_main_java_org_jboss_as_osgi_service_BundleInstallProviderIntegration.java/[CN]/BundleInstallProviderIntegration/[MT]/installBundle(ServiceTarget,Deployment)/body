{
  ROOT_LOGGER.tracef("Install deployment: %s",dep);
  try {
    String contextName=DeploymentHolderService.getContextName(dep);
    DeploymentHolderService.addService(serviceTarget,contextName,dep);
    InputStream inputStream=dep.getRoot().openStream();
    try {
      DeploymentPlanBuilder builder=deploymentManager.newDeploymentPlan();
      builder=builder.add(contextName,inputStream).andDeploy();
      DeploymentPlan plan=builder.build();
      DeploymentAction deployAction=builder.getLastAction();
      executeDeploymentPlan(plan,deployAction);
    }
  finally {
      if (inputStream != null)       try {
        inputStream.close();
      }
 catch (      IOException e) {
        ROOT_LOGGER.debugf(e,"Failed to close resource %s",inputStream);
      }
    }
  }
 catch (  RuntimeException rte) {
    throw rte;
  }
catch (  BundleException ex) {
    throw ex;
  }
catch (  Exception ex) {
    throw new BundleException(MESSAGES.cannotDeployBundle(dep),ex);
  }
}
