{
  final Patch patch=builder.build();
  final File installation=new File(tempDir,JBOSS_INSTALLATION);
  try {
    assertions.before(installation,patch,installationManager);
  }
 catch (  IOException e) {
    throw new PatchingException(e);
  }
  FileOutputStream os=null;
  try {
    os=new FileOutputStream(new File(builder.getPatchDir(),PatchXml.PATCH_XML));
    PatchXml.marshal(os,patch);
  }
 catch (  Exception e) {
    throw new PatchingException(e);
  }
 finally {
    IoUtils.safeClose(os);
  }
  final PatchTool patchTool=PatchTool.Factory.create(installationManager);
  final PatchingResult result=patchTool.applyPatch(builder.getPatchDir(),verificationPolicy);
  result.commit();
  try {
    assertions.after(installation,patch,installationManager);
  }
 catch (  IOException e) {
    throw new PatchingException(e);
  }
  return result;
}
