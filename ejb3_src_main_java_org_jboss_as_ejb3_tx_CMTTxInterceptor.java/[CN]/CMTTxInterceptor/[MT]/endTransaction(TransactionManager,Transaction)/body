{
  try {
    if (tx != tm.getTransaction()) {
      throw new IllegalStateException("Wrong tx on thread: expected " + tx + ", actual "+ tm.getTransaction());
    }
    if (tx.getStatus() == Status.STATUS_MARKED_ROLLBACK) {
      tm.rollback();
    }
 else {
      tm.commit();
    }
  }
 catch (  RollbackException e) {
    handleEndTransactionException(e);
  }
catch (  HeuristicMixedException e) {
    handleEndTransactionException(e);
  }
catch (  HeuristicRollbackException e) {
    handleEndTransactionException(e);
  }
catch (  SystemException e) {
    handleEndTransactionException(e);
  }
}
