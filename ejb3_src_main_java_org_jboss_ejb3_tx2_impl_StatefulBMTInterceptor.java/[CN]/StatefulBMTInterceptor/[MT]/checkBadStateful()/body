{
  int status=Status.STATUS_NO_TRANSACTION;
  TransactionManager tm=this.getTransactionManager();
  try {
    status=tm.getStatus();
  }
 catch (  SystemException ex) {
    log.error("Failed to get status",ex);
  }
switch (status) {
case Status.STATUS_COMMITTING:
case Status.STATUS_MARKED_ROLLBACK:
case Status.STATUS_PREPARING:
case Status.STATUS_ROLLING_BACK:
    try {
      tm.rollback();
    }
 catch (    Exception ex) {
      log.error("Failed to rollback",ex);
    }
  String msg="BMT stateful bean '" + getComponentName() + "' did not complete user transaction properly status="+ statusAsString(status);
log.error(msg);
}
}
