{
  SystemExiter.initialize(new NoopExiter());
  String[] args=command.toArray(new String[command.size()]);
  ServerManagerEnvironment config=Main.determineEnvironment(args,System.getProperties(),stdin,stdout,stderr);
  if (config == null) {
    throw new RuntimeException("Could not determine SM environment");
  }
 else {
    TestServerManagerProcess manager=new TestServerManagerProcess(managed,config);
    manager.start();
    DomainModel domain=ConfigParser.parseDomain(new File(System.getProperty(ServerManagerEnvironment.DOMAIN_CONFIG_DIR)));
    manager.setDomain(domain);
    return manager;
  }
}
