{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (!DeploymentTypeMarker.isType(DeploymentType.WAR,deploymentUnit)) {
    return;
  }
  final Map<String,ComponentDescription> componentByClass=new HashMap<String,ComponentDescription>();
  final Map<String,ComponentInstantiator> webComponents=new HashMap<String,ComponentInstantiator>();
  final EEModuleDescription moduleDescription=deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
  final String applicationName=deploymentUnit.getParent() == null ? deploymentUnit.getName() : deploymentUnit.getParent().getName();
  if (moduleDescription == null) {
    return;
  }
  for (  ComponentDescription component : moduleDescription.getComponentDescriptions()) {
    componentByClass.put(component.getComponentClassName(),component);
  }
  final WarMetaData warMetaData=deploymentUnit.getAttachment(WarMetaData.ATTACHMENT_KEY);
  final TldsMetaData tldsMetaData=deploymentUnit.getAttachment(TldsMetaData.ATTACHMENT_KEY);
  final Set<String> classes=getAllComponentClasses(warMetaData,tldsMetaData);
  for (  String clazz : classes) {
    ComponentDescription description=componentByClass.get(clazz);
    if (description != null) {
      if (!(description.getViewClassNames().size() == 1)) {
        throw new RuntimeException(clazz + " has the wrong component type, is cannot be used as a web component");
      }
      ManagedBeanComponentInstantiator instantiator=new ManagedBeanComponentInstantiator(deploymentUnit,description);
      webComponents.put(clazz,instantiator);
    }
 else {
      description=new WebComponentDescription(clazz,clazz,moduleDescription);
      moduleDescription.addComponent(description);
      webComponents.put(clazz,new WebComponentInstantiator(deploymentUnit,description));
    }
  }
  deploymentUnit.putAttachment(WebAttachments.WEB_COMPONENT_INSTANTIATORS,webComponents);
}
