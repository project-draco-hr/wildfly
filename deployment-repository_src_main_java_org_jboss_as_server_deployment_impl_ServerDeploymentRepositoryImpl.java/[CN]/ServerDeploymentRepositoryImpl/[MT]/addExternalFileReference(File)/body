{
  byte[] sha1Bytes=null;
  final String fileName=file.getAbsolutePath();
  final MessageDigest messageDigest=this.messageDigest;
synchronized (messageDigest) {
    messageDigest.reset();
    if (!file.exists()) {
      throw new FileNotFoundException(fileName);
    }
    final OutputStream os=new OutputStream(){
      public void write(      int b) throws IOException {
      }
    }
;
    final DigestOutputStream dos=new DigestOutputStream(os,messageDigest);
    calculateHash(file,dos);
    sha1Bytes=messageDigest.digest();
  }
  final File content=getExternalFileReference(sha1Bytes,true);
  final OutputStream os=new FileOutputStream(content);
  try {
    os.write(fileName.getBytes());
    os.flush();
    os.close();
  }
  finally {
    safeClose(os);
  }
  return sha1Bytes;
}
