{
  context.addStep(new OperationStepHandler(){
    @Override public void execute(    OperationContext context,    ModelNode operation) throws OperationFailedException {
      ServiceTarget target=context.getServiceTarget();
      RegisterMBeanServerDelegateService mbeanServerService=new RegisterMBeanServerDelegateService();
      newControllers.add(target.addService(RegisterMBeanServerDelegateService.SERVICE_NAME,mbeanServerService).addDependency(MBeanServerService.SERVICE_NAME,PluggableMBeanServer.class,mbeanServerService.injectedMbeanServer).addDependency(Services.JBOSS_SERVER_CONTROLLER,ModelController.class,mbeanServerService.injectedController).addListener(verificationHandler).setInitialMode(Mode.ACTIVE).install());
      RegisterManagementEJBService managementEjbService=new RegisterManagementEJBService();
      newControllers.add(target.addService(RegisterManagementEJBService.SERVICE_NAME,managementEjbService).addDependency(DeploymentRepository.SERVICE_NAME,DeploymentRepository.class,managementEjbService.deploymentRepositoryValue).addDependency(MBeanServerService.SERVICE_NAME,MBeanServer.class,managementEjbService.mbeanServerValue).addDependency(DefaultEjbClientContextService.DEFAULT_SERVICE_NAME,EJBClientContext.class,managementEjbService.ejbClientContextValue).addDependency(TCCLEJBClientContextSelectorService.TCCL_BASED_EJB_CLIENT_CONTEXT_SELECTOR_SERVICE_NAME,TCCLEJBClientContextSelectorService.class,managementEjbService.ejbClientContextSelectorValue).addListener(verificationHandler).setInitialMode(Mode.ACTIVE).install());
      final ContextNames.BindInfo bindInfo=ContextNames.bindInfoFor(JNDI_NAME);
      final BinderService binderService=new BinderService(bindInfo.getBindName(),null);
      final InjectedValue<ClassLoader> viewClassLoader=new InjectedValue<ClassLoader>();
      viewClassLoader.setValue(Values.immediateValue(ManagementHome.class.getClassLoader()));
      newControllers.add(target.addService(bindInfo.getBinderServiceName(),binderService).addInjection(binderService.getManagedObjectInjector(),new RemoteViewManagedReferenceFactory(APP_NAME,MODULE_NAME,DISTINCT_NAME,EJB_NAME,ManagementHome.class.getName(),false,viewClassLoader)).addDependency(bindInfo.getParentContextServiceName(),ServiceBasedNamingStore.class,binderService.getNamingStoreInjector()).addListener(verificationHandler).setInitialMode(Mode.ACTIVE).install());
      context.completeStep(OperationContext.RollbackHandler.NOOP_ROLLBACK_HANDLER);
    }
  }
,Stage.RUNTIME);
}
