{
  if (component instanceof EJBComponent == false) {
    throw new IllegalStateException("Unexpected component type: " + component.getClass() + " expected: "+ EJBComponent.class);
  }
  final EJBComponent ejbComponent=(EJBComponent)component;
  final SimpleSecurityManager securityManager=ejbComponent.getSecurityManager();
  final EJBSecurityMetaData securityMetaData=ejbComponent.getSecurityMetaData();
  final String securityDomain=securityMetaData.getSecurityDomain();
  if (securityDomain == null) {
    throw new IllegalStateException("EJB " + ejbComponent.getComponentName() + " is enabled for security but doesn't have a security domain set");
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Using security domain: " + securityDomain + " for EJB "+ ejbComponent.getComponentName());
  }
  final String runAs=securityMetaData.getRunAs();
  final String runAsPrincipal=securityMetaData.getRunAsPrincipal();
  final SecurityRolesMetaData securityRoles=securityMetaData.getSecurityRoles();
  Set<String> extraRoles=null;
  if (securityRoles != null)   extraRoles=securityRoles.getSecurityRoleNamesByPrincipal(runAsPrincipal);
  return new SecurityContextInterceptor(securityManager,securityDomain,runAs,runAsPrincipal,extraRoles);
}
