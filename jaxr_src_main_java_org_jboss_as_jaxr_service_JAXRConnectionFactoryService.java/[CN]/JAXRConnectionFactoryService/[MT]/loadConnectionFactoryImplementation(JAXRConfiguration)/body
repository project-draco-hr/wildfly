{
  ConnectionFactory jaxrFactory=null;
  String factoryName=SecurityActions.getSystemProperty(JAXRConstants.JAXR_FACTORY_IMPLEMENTATION,null);
  if (factoryName != null)   JAXR_LOGGER.factoryNameFromSystemProperty(JAXRConstants.JAXR_FACTORY_IMPLEMENTATION,factoryName);
 else   factoryName=config.getConnectionFactoryImplementation();
  if (factoryName != null)   JAXR_LOGGER.factoryNameFromJBossConfig(JAXRConstants.JAXR_FACTORY_IMPLEMENTATION,factoryName);
 else {
    ServiceLoader<ConnectionFactory> factoryLoader=ServiceLoader.load(ConnectionFactory.class);
    if (factoryLoader != null) {
      for (      ConnectionFactory factory : factoryLoader) {
        JAXR_LOGGER.factoryNameFromServiceLoader(factory.getClass().getName());
        return factory;
      }
    }
  }
  if (factoryName == null)   factoryName=JAXRConstants.DEFAULT_JAXR_FACTORY_IMPL;
  JAXR_LOGGER.factoryNameFromDefault(JAXRConstants.DEFAULT_JAXR_FACTORY_IMPL);
  ClassLoader loader=Thread.currentThread().getContextClassLoader();
  Class<?> factoryClass;
  try {
    try {
      factoryClass=loader.loadClass(factoryName);
    }
 catch (    ClassNotFoundException e) {
      factoryClass=this.getClass().getClassLoader().loadClass(factoryName);
    }
    jaxrFactory=(ConnectionFactory)factoryClass.newInstance();
  }
 catch (  Throwable e) {
    throw MESSAGES.couldNotInstantiateJAXRFactory(factoryName);
  }
  return jaxrFactory;
}
