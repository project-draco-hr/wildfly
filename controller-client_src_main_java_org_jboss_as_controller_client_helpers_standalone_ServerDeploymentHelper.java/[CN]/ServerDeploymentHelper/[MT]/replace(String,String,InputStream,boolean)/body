{
  ServerDeploymentPlanResult planResult;
  List<DeploymentAction> actions=new ArrayList<DeploymentAction>();
  try {
    DeploymentPlanBuilder builder=deploymentManager.newDeploymentPlan();
    AddDeploymentPlanBuilder addBuilder=builder.add(runtimeName,input);
    actions.add(addBuilder.getLastAction());
    ReplaceDeploymentPlanBuilder replaceBuilder=addBuilder.andReplace(replaceName);
    actions.add(replaceBuilder.getLastAction());
    if (removeUndeployed) {
      builder=replaceBuilder.andRemoveUndeployed();
      actions.add(builder.getLastAction());
    }
 else {
      builder=replaceBuilder;
    }
    DeploymentPlan plan=builder.build();
    Future<ServerDeploymentPlanResult> future=deploymentManager.execute(plan);
    planResult=future.get();
  }
 catch (  Exception ex) {
    throw new ServerDeploymentException(ex);
  }
  for (  DeploymentAction action : actions) {
    ServerDeploymentActionResult actionResult=planResult.getDeploymentActionResult(action.getId());
    if (actionResult.getDeploymentException() != null)     throw new ServerDeploymentException(actionResult);
  }
  return runtimeName;
}
