{
  final Archive<?> appArchive=testDeployment.getApplicationArchive();
  final Collection<Archive<?>> auxArchives=testDeployment.getAuxiliaryArchives();
  generateArquillianServiceArchive(appArchive,auxArchives);
  final Manifest manifest=ManifestUtils.getOrCreateManifest(testDeployment.getApplicationArchive());
  if (BundleInfo.isValidateBundleManifest(manifest) == false) {
    if (WebArchive.class.isAssignableFrom(appArchive.getClass())) {
      final ArchivePath webInfLib=ArchivePaths.create("WEB-INF","lib");
      for (      Archive<?> aux : auxArchives) {
        if (!excludedAuxillaryArchives.contains(aux.getName())) {
          appArchive.add(aux,webInfLib,ZipExporter.class);
        }
      }
    }
 else {
      for (      Archive<?> aux : auxArchives) {
        if (!excludedAuxillaryArchives.contains(aux.getName())) {
          appArchive.merge(aux);
        }
      }
    }
  }
  return appArchive;
}
