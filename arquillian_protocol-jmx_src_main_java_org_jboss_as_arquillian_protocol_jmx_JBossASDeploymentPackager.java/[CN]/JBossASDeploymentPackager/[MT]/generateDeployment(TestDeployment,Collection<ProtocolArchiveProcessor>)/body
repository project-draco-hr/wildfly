{
  final Collection<Archive<?>> auxArchives=testDeployment.getAuxiliaryArchives();
  generateArquillianServiceArchive(auxArchives);
  final Archive<?> appArchive=testDeployment.getApplicationArchive();
  final Manifest manifest=ManifestUtils.getOrCreateManifest(appArchive);
  if (BundleInfo.isValidBundleManifest(manifest) == false) {
    if (WebArchive.class.isAssignableFrom(appArchive.getClass())) {
      final ArchivePath webInfLib=ArchivePaths.create("WEB-INF","lib");
      for (      Archive<?> aux : auxArchives) {
        if (!excludedAuxillaryArchives.contains(aux.getName())) {
          appArchive.add(aux,webInfLib,ZipExporter.class);
        }
      }
    }
 else {
      for (      Archive<?> aux : auxArchives) {
        if (!excludedAuxillaryArchives.contains(aux.getName())) {
          appArchive.merge(aux);
        }
      }
    }
  }
  log.debugf("Archive content: %s\n%s",appArchive.getName(),appArchive.toString(true));
  return appArchive;
}
