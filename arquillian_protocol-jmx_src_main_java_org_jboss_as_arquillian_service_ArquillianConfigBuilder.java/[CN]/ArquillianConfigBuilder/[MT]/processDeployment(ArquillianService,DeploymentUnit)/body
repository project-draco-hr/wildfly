{
  final Set<String> testClasses=depUnit.getAttachment(CLASSES);
  if (testClasses == null || testClasses.isEmpty()) {
    return null;
  }
  ArquillianConfig arqConfig=new ArquillianConfig(arqService,depUnit,testClasses);
  ServiceController<?> service=arqService.getServiceContainer().getService(arqConfig.getServiceName());
  if (service != null) {
    service.setMode(ServiceController.Mode.REMOVE);
    final StabilityMonitor monitor=new StabilityMonitor();
    monitor.addController(service);
    try {
      monitor.awaitStability(20,TimeUnit.SECONDS);
    }
 catch (    InterruptedException e) {
      throw new RuntimeException(e);
    }
 finally {
      monitor.removeController(service);
    }
  }
  depUnit.putAttachment(ArquillianConfig.KEY,arqConfig);
  return arqConfig;
}
