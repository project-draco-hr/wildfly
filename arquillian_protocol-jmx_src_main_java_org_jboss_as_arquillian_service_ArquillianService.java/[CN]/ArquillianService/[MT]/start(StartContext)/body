{
  log.debugf("Starting Arquillian Test Runner");
  final MBeanServer mbeanServer=injectedMBeanServer.getValue();
  serviceContainer=context.getController().getServiceContainer();
  serviceTarget=context.getChildTarget();
  try {
    jmxTestRunner=new ExtendedJMXTestRunner();
    jmxTestRunner.registerMBean(mbeanServer);
  }
 catch (  Throwable t) {
    throw new StartException("Failed to start Arquillian Test Runner",t);
  }
  final ArquillianService arqService=this;
  listener=new AbstractServiceListener<Object>(){
    @Override public void transition(    ServiceController<? extends Object> serviceController,    ServiceController.Transition transition){
switch (transition) {
case STARTING_to_UP:
{
          ServiceName serviceName=serviceController.getName();
          String simpleName=serviceName.getSimpleName();
          if (JBOSS_DEPLOYMENT.isParentOf(serviceName) && simpleName.equals(Phase.INSTALL.toString())) {
            ServiceName parentName=serviceName.getParent();
            ServiceController<?> parentController=serviceContainer.getService(parentName);
            DeploymentUnit depUnit=(DeploymentUnit)parentController.getValue();
            ArquillianConfig arqConfig=ArquillianConfigBuilder.processDeployment(arqService,depUnit);
            if (arqConfig != null) {
              log.infof("Arquillian deployment detected: %s",arqConfig);
              ServiceBuilder<ArquillianConfig> builder=arqConfig.buildService(serviceTarget,serviceController);
              FrameworkActivationProcessor.process(serviceContainer,builder,arqConfig);
              builder.install();
            }
          }
        }
    }
  }
}
;
serviceContainer.addListener(listener);
}
