{
  log.debugf("Starting Arquillian Test Runner");
  final MBeanServer mbeanServer=injectedMBeanServer.getValue();
  serviceContainer=context.getController().getServiceContainer();
  serviceTarget=context.getChildTarget();
  try {
    jmxTestRunner=new ExtendedJMXTestRunner();
    jmxTestRunner.registerMBean(mbeanServer);
  }
 catch (  Throwable t) {
    throw new StartException("Failed to start Arquillian Test Runner",t);
  }
  final ArquillianService arqService=this;
  listener=new AbstractServiceListener<Object>(){
    @Override public void transition(    ServiceController<? extends Object> serviceController,    ServiceController.Transition transition){
switch (serviceController.getState()) {
case UP:
{
          ServiceName serviceName=serviceController.getName();
          String simpleName=serviceName.getSimpleName();
          if (JBOSS_DEPLOYMENT.isParentOf(serviceName) && simpleName.equals(Phase.INSTALL.toString())) {
            ServiceName parentName=serviceName.getParent();
            ServiceController<?> parentController=serviceContainer.getService(parentName);
            DeploymentUnit depUnit=(DeploymentUnit)parentController.getValue();
            ArquillianConfig arqConfig=ArquillianConfigBuilder.processDeployment(arqService,depUnit);
            if (arqConfig != null) {
              log.infof("Arquillian deployment detected: %s",arqConfig);
              ServiceBuilder<ArquillianConfig> builder=arqConfig.buildService(serviceTarget,serviceController);
              FrameworkActivationProcessor.process(serviceContainer,builder,arqConfig);
              builder.install();
            }
          }
        }
case STARTING:
{
        ServiceName serviceName=serviceController.getName();
        String simpleName=serviceName.getSimpleName();
        if (JBOSS_DEPLOYMENT.isParentOf(serviceName) && simpleName.equals(Phase.DEPENDENCIES.toString())) {
          ServiceName parentName=serviceName.getParent();
          ServiceController<?> parentController=serviceContainer.getService(parentName);
          DeploymentUnit depUnit=(DeploymentUnit)parentController.getValue();
          ArquillianConfigBuilder.handleParseAnnotations(depUnit);
        }
      }
  }
}
}
;
serviceContainer.addListener(listener);
}
