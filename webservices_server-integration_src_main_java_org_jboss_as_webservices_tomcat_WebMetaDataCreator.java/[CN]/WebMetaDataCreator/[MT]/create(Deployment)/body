{
  final DeploymentUnit unit=WSHelper.getRequiredAttachment(dep,DeploymentUnit.class);
  WarMetaData warMD=ASHelper.getOptionalAttachment(unit,WarMetaData.ATTACHMENT_KEY);
  JBossWebMetaData jbossWebMD=warMD != null ? warMD.getMergedJBossWebMetaData() : null;
  if (warMD == null) {
    warMD=new WarMetaData();
  }
  if (jbossWebMD == null) {
    jbossWebMD=new JBossWebMetaData();
    warMD.setMergedJBossWebMetaData(jbossWebMD);
    unit.putAttachment(WarMetaData.ATTACHMENT_KEY,warMD);
    DeploymentUnit parent=unit.getParent();
    if (parent != null) {
      final EarMetaData earMetaData=parent.getAttachment(org.jboss.as.ee.structure.Attachments.EAR_METADATA);
      if (earMetaData != null) {
        SecurityRolesMetaData earSecurityRolesMetaData=earMetaData.getSecurityRoles();
        if (earSecurityRolesMetaData != null) {
          jbossWebMD.setSecurityRoles(new SecurityRolesMetaData());
          SecurityRolesMetaDataMerger.merge(jbossWebMD.getSecurityRoles(),jbossWebMD.getSecurityRoles(),earSecurityRolesMetaData);
        }
      }
    }
  }
  createWebAppDescriptor(dep,jbossWebMD);
  createJBossWebAppDescriptor(dep,jbossWebMD);
  dep.addAttachment(JBossWebMetaData.class,jbossWebMD);
}
