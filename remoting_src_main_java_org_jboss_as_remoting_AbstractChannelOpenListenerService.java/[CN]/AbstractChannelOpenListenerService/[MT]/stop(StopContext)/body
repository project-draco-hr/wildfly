{
  if (!closed.compareAndSet(false,true)) {
    return;
  }
  if (registration != null) {
    registration.close();
  }
synchronized (channels) {
    final Set<T> copy=new HashSet<T>(channels);
    for (    T channel : copy) {
      closeChannelOnShutdown(channel);
    }
  }
}
