{
  if (runOnce.get()) {
    final ServiceName serviceName;
    if (deploymentUnit.getParent() == null) {
      serviceName=deploymentUnit.getServiceName();
    }
 else {
      serviceName=deploymentUnit.getParent().getServiceName();
    }
    ServiceController<?> controller=context.getController().getServiceContainer().getRequiredService(serviceName);
    controller.addListener(new AbstractServiceListener<Object>(){
      @Override public void transition(      final ServiceController<?> controller,      final ServiceController.Transition transition){
        if (transition.getAfter().equals(ServiceController.Substate.DOWN)) {
          controller.setMode(Mode.ACTIVE);
          controller.removeListener(this);
        }
      }
    }
);
    controller.setMode(Mode.NEVER);
    return;
  }
  runOnce.set(true);
  final DeployerChains chains=deployerChainsInjector.getValue();
  final DeploymentUnit deploymentUnit=this.deploymentUnit;
  final List<RegisteredDeploymentUnitProcessor> list=chains.getChain(phase);
  final ListIterator<RegisteredDeploymentUnitProcessor> iterator=list.listIterator();
  final ServiceContainer container=context.getController().getServiceContainer();
  final ServiceTarget serviceTarget=context.getChildTarget().subTarget();
  final Phase nextPhase=phase.next();
  final String name=deploymentUnit.getName();
  final DeploymentUnit parent=deploymentUnit.getParent();
  final ServiceBuilder<?> phaseServiceBuilder;
  final DeploymentUnitPhaseService<?> phaseService;
  if (nextPhase != null) {
    final ServiceName serviceName=DeploymentUtils.getDeploymentUnitPhaseServiceName(deploymentUnit,nextPhase);
    phaseService=DeploymentUnitPhaseService.create(deploymentUnit,nextPhase);
    phaseServiceBuilder=serviceTarget.addService(serviceName,phaseService);
  }
 else {
    phaseServiceBuilder=null;
    phaseService=null;
  }
  final DeploymentPhaseContext processorContext=new DeploymentPhaseContextImpl(serviceTarget,new DelegatingServiceRegistry(container),phaseServiceBuilder,deploymentUnit,phase);
  for (  AttachedDependency attachedDependency : injectedAttachedDependencies) {
    final Attachable target;
    if (attachedDependency.isDeploymentUnit()) {
      target=deploymentUnit;
    }
 else {
      target=processorContext;
    }
    if (attachedDependency.getAttachmentKey() instanceof ListAttachmentKey) {
      target.addToAttachmentList((AttachmentKey)attachedDependency.getAttachmentKey(),attachedDependency.getValue().getValue());
    }
 else {
      target.putAttachment((AttachmentKey)attachedDependency.getAttachmentKey(),attachedDependency.getValue().getValue());
    }
  }
  while (iterator.hasNext()) {
    final RegisteredDeploymentUnitProcessor processor=iterator.next();
    try {
      if (shouldRun(deploymentUnit,processor)) {
        processor.getProcessor().deploy(processorContext);
      }
    }
 catch (    Throwable e) {
      while (iterator.hasPrevious()) {
        final RegisteredDeploymentUnitProcessor prev=iterator.previous();
        safeUndeploy(deploymentUnit,phase,prev);
      }
      throw ServerMessages.MESSAGES.deploymentPhaseFailed(phase,deploymentUnit,e);
    }
  }
  if (nextPhase != null) {
    phaseServiceBuilder.addDependency(Services.JBOSS_DEPLOYMENT_CHAINS,DeployerChains.class,phaseService.getDeployerChainsInjector());
    phaseServiceBuilder.addDependency(context.getController().getName());
    final List<ServiceName> nextPhaseDeps=processorContext.getAttachment(Attachments.NEXT_PHASE_DEPS);
    if (nextPhaseDeps != null) {
      phaseServiceBuilder.addDependencies(nextPhaseDeps);
    }
    final List<AttachableDependency> nextPhaseAttachableDeps=processorContext.getAttachment(Attachments.NEXT_PHASE_ATTACHABLE_DEPS);
    if (nextPhaseAttachableDeps != null) {
      for (      AttachableDependency attachableDep : nextPhaseAttachableDeps) {
        AttachedDependency result=new AttachedDependency(attachableDep.getAttachmentKey(),attachableDep.isDeploymentUnit());
        phaseServiceBuilder.addDependency(attachableDep.getServiceName(),result.getValue());
        phaseService.injectedAttachedDependencies.add(result);
      }
    }
    if (parent != null) {
      phaseServiceBuilder.addDependencies(Services.deploymentUnitName(parent.getName(),nextPhase));
    }
    List<DeploymentUnit> subDeployments=deploymentUnit.getAttachmentList(Attachments.SUB_DEPLOYMENTS);
    for (    DeploymentUnit du : subDeployments) {
      phaseServiceBuilder.addDependencies(du.getServiceName().append(phase.name()));
    }
    List<String> deferredModules=DeploymentUtils.getDeferredModules(deploymentUnit);
    if (nextPhase == Phase.FIRST_MODULE_USE) {
      Mode initialMode=getDeferableInitialMode(deploymentUnit,deferredModules);
      if (initialMode != Mode.ACTIVE) {
        DEPLOYMENT_LOGGER.infoDeferDeploymentPhase(nextPhase,name,initialMode);
        phaseServiceBuilder.setInitialMode(initialMode);
      }
    }
    phaseServiceBuilder.install();
  }
}
