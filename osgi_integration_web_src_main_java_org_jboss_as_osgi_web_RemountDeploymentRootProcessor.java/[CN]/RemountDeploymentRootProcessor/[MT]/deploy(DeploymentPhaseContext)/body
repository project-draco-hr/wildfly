{
  DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  Manifest manifest=depUnit.getAttachment(Attachments.OSGI_MANIFEST);
  if (manifest == null || MountExplodedMarker.isMountExploded(depUnit))   return;
  if (!WebApplicationBundleUtils.isWebApplicationBundle(depUnit))   return;
  ResourceRoot resourceRoot=depUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  Closeable handle=resourceRoot.getMountHandle();
  VFSUtils.safeClose(handle);
  VirtualFile deploymentContents=depUnit.getAttachment(Attachments.DEPLOYMENT_CONTENTS);
  DeploymentMountProvider deploymentMountProvider=depUnit.getAttachment(Attachments.SERVER_DEPLOYMENT_REPOSITORY);
  VirtualFile deploymentRoot=VFS.getChild("content/" + depUnit.getName());
  MountHandle mountHandle;
  try {
    handle=deploymentMountProvider.mountDeploymentContent(deploymentContents,deploymentRoot,MountType.EXPANDED);
    mountHandle=new MountHandle(handle);
  }
 catch (  IOException e) {
    VFSUtils.safeClose(handle);
    throw ServerMessages.MESSAGES.deploymentMountFailed(e);
  }
  resourceRoot=new ResourceRoot(deploymentRoot,mountHandle);
  resourceRoot.putAttachment(Attachments.MANIFEST,manifest);
  ModuleRootMarker.mark(resourceRoot);
  depUnit.putAttachment(Attachments.DEPLOYMENT_ROOT,resourceRoot);
}
