{
  if (context.getType() == NewOperationContext.Type.SERVER) {
    context.addStep(new NewStepHandler(){
      public void execute(      NewOperationContext context,      ModelNode operation) throws OperationFailedException {
        final EnumMap<Phase,Set<RegisteredProcessor>> deployerMap=DEPLOYERS.get();
        if (deployerMap == null) {
          throw new IllegalStateException("No deployers set");
        }
        final EnumMap<Phase,List<DeploymentUnitProcessor>> finalDeployers=new EnumMap<Phase,List<DeploymentUnitProcessor>>(Phase.class);
        final List<DeploymentUnitProcessor> processorList=new ArrayList<DeploymentUnitProcessor>(256);
        for (        Phase phase : Phase.values()) {
          processorList.clear();
          final Set<RegisteredProcessor> processorSet=deployerMap.get(phase);
          for (          RegisteredProcessor processor : processorSet) {
            processorList.add(processor.getProcessor());
          }
          finalDeployers.put(phase,Arrays.asList(processorList.toArray(new DeploymentUnitProcessor[processorList.size()])));
        }
        final ServiceVerificationHandler verificationHandler=new ServiceVerificationHandler();
        DeployerChainsService.addService(context.getServiceTarget(),finalDeployers,verificationHandler);
        context.addStep(verificationHandler,NewOperationContext.Stage.VERIFY);
        if (context.completeStep() == NewOperationContext.ResultAction.ROLLBACK) {
          context.removeService(Services.JBOSS_DEPLOYMENT_CHAINS);
        }
      }
    }
,NewOperationContext.Stage.VERIFY);
  }
  context.completeStep();
}
