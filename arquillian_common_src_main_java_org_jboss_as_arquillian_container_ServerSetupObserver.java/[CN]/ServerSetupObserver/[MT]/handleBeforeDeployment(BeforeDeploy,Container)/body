{
  final ClassContext classContext=classContextInstance.get();
  if (classContext == null) {
    return;
  }
  final Class<?> currentClass=classContext.getActiveId();
  final ContainerClassHolder holder=new ContainerClassHolder(container.getName(),currentClass);
  if (alreadyRun.contains(holder)) {
    return;
  }
  alreadyRun.add(holder);
  ServerSetup setup=currentClass.getAnnotation(ServerSetup.class);
  if (setup == null) {
    return;
  }
  if (current == null) {
    Constructor<? extends ServerSetupTask> ctor=setup.value().getDeclaredConstructor();
    ctor.setAccessible(true);
    current=ctor.newInstance();
  }
 else   if (current.getClass() != setup.value()) {
    throw new RuntimeException("Mismatched ServerSetupTask current is " + current + " but "+ currentClass+ " is expecting "+ setup.value());
  }
  final Archive<?> archive=event.getDeployment().getArchive();
  if (archive instanceof LibraryContainer) {
    JavaArchive jar=ShrinkWrap.create(JavaArchive.class,"jbossSetupObserverExtensionSupportClasses.jar");
    jar.addClasses(ServerSetup.class,ServerSetupTask.class,ManagementClient.class);
    ((LibraryContainer)archive).addAsLibrary(jar);
  }
 else   if (archive instanceof ClassContainer) {
    ((ClassContainer)archive).addClasses(ServerSetup.class,ServerSetupTask.class,ManagementClient.class);
  }
  final ManagementClient client=managementClient.get();
  current.setup(client);
  active.add(client);
}
