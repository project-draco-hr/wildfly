{
  final ModelControllerClient client=ctx.getModelControllerClient();
  final ParsedCommandLine args=ctx.getParsedCommandLine();
  assertNotPresent(allServerGroups,args);
  assertNotPresent(wildcards,args);
  final String name=this.name.getValue(args,true);
  if (name == null) {
    throw new CommandFormatException(this.name + " is missing value.");
  }
  final String contentStr=content.getValue(args);
  final String deploymentStr=deployments.getValue(args);
  final String sgStr=serverGroups.getValue(args);
  final List<String> sg;
  if (sgStr == null) {
    if (allRelevantServerGroups.isPresent(args)) {
      sg=Util.getServerGroupsReferencingOverlay(name,client);
    }
 else {
      sg=null;
    }
  }
 else {
    sg=Arrays.asList(sgStr.split(",+"));
    if (sg.isEmpty()) {
      throw new CommandFormatException(serverGroups.getFullName() + " is missing value.");
    }
  }
  final ModelNode composite=new ModelNode();
  composite.get(Util.OPERATION).set(Util.COMPOSITE);
  composite.get(Util.ADDRESS).setEmptyList();
  final ModelNode steps=composite.get(Util.STEPS);
  if (deploymentStr != null || contentStr == null) {
    if (ctx.isDomainMode()) {
      if (deploymentStr == null) {
        final List<String> sgNames=sg == null ? Util.getServerGroups(client) : sg;
        for (        String sgName : sgNames) {
          final List<String> deployments=loadLinkedDeployments(client,name,sgName);
          if (!deployments.isEmpty()) {
            addRemoveDeploymentSteps(name,sgName,deployments,steps);
            final ModelNode op=new ModelNode();
            final ModelNode addr=op.get(Util.ADDRESS);
            addr.add(Util.SERVER_GROUP,sgName);
            addr.add(Util.DEPLOYMENT_OVERLAY,name);
            op.get(Util.OPERATION).set(Util.REMOVE);
            steps.add(op);
          }
        }
      }
 else {
        if (ctx.isDomainMode() && sg == null) {
          throw new CommandFormatException(serverGroups.getFullName() + " or " + allRelevantServerGroups.getFullName()+ " is required.");
        }
        final List<String> deployments=Arrays.asList(deploymentStr.split(",+"));
        for (        String group : sg) {
          addRemoveDeploymentSteps(name,group,deployments,steps);
        }
      }
    }
 else {
      final List<String> overlays;
      if (deploymentStr == null) {
        overlays=loadLinkedDeployments(client,name,null);
      }
 else {
        overlays=Arrays.asList(deploymentStr.split(",+"));
      }
      addRemoveDeploymentSteps(name,null,overlays,steps);
    }
  }
  if (contentStr != null || deploymentStr == null && sg == null) {
    final List<String> contentList;
    if (contentStr == null) {
      contentList=loadContentFor(client,name);
    }
 else {
      contentList=java.util.Arrays.asList(contentStr.split(",+"));
    }
    for (    String content : contentList) {
      final ModelNode op=new ModelNode();
      ModelNode addr=op.get(Util.ADDRESS);
      addr.add(Util.DEPLOYMENT_OVERLAY,name);
      addr.add(Util.CONTENT,content);
      op.get(Util.OPERATION).set(Util.REMOVE);
      steps.add(op);
    }
  }
  if (contentStr == null && deploymentStr == null && sg == null) {
    final ModelNode op=new ModelNode();
    op.get(Util.ADDRESS).add(Util.DEPLOYMENT_OVERLAY,name);
    op.get(Util.OPERATION).set(Util.REMOVE);
    steps.add(op);
  }
  try {
    final ModelNode result=client.execute(composite);
    if (!Util.isSuccess(result)) {
      ctx.printLine("request: " + composite.toString());
      ctx.printLine("response: " + result.toString());
      throw new CommandFormatException(Util.getFailureDescription(result));
    }
  }
 catch (  IOException e) {
    throw new CommandFormatException("Failed to remove overlay",e);
  }
}
