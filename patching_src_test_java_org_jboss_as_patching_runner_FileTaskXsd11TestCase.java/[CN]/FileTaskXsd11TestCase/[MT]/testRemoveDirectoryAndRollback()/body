{
  PatchInfo info=new LocalPatchInfo(randomString(),PatchInfo.BASE,Collections.<String>emptyList(),env);
  File test=mkdir(env.getInstalledImage().getJbossHome(),"test");
  String one="one";
  String two="two";
  File fileOne=touch(test,one);
  touch(fileOne);
  dump(fileOne,randomString());
  File fileTwo=touch(test,two);
  touch(fileTwo);
  dump(fileTwo,randomString());
  File subDirOne=mkdir(test,"sub");
  File subOne=touch(subDirOne,one);
  touch(subOne);
  dump(subOne,randomString());
  File subTwo=touch(subDirOne,two);
  touch(subTwo);
  dump(subTwo,randomString());
  byte[] existingHash=hashFile(test);
  ContentModification fileRemoved=new ContentModification(new MiscContentItem("test",new String[0],NO_CONTENT),existingHash,REMOVE);
  PatchBuilder1_1 builder=PatchBuilder1_1.create().setPatchId(randomString()).setDescription(randomString()).setIdentity(new IdentityImpl("eap",info.getVersion())).setNoUpgrade();
  PatchElementImpl element=new PatchElementImpl("patch element 01");
  builder.addElement(element);
  element.setDescription("patch element 01 description");
  element.setNoUpgrade();
  PatchElementProviderImpl provider=new PatchElementProviderImpl("base","4.5.6",false);
  provider.require("patch element 02");
  element.setProvider(provider);
  element.addContentModification(fileRemoved);
  Patch patch=builder.build();
  File patchDir=mkdir(tempDir,patch.getPatchId());
  createPatchXMLFile(patchDir,patch);
  File zippedPatch=createZippedPatchFile(patchDir,patch.getPatchId());
  PatchingResult result=executePatch(info,zippedPatch);
  assertFalse(test.exists());
  result=rollback(result.getPatchInfo(),patch.getPatchId());
  assertTrue(test.exists());
  assertTrue(fileOne.isFile());
  assertTrue(fileTwo.isFile());
  assertTrue(subOne.isFile());
  assertTrue(subTwo.isFile());
}
