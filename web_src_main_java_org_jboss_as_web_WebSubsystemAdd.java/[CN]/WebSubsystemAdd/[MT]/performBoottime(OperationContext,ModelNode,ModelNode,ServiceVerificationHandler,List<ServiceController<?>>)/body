{
  ModelNode fullModel=Resource.Tools.readModel(context.readResource(PathAddress.EMPTY_ADDRESS));
  final ModelNode config=resolveConfiguration(context,fullModel.get(Constants.CONFIGURATION));
  final String defaultVirtualServer=WebDefinition.DEFAULT_VIRTUAL_SERVER.resolveModelAttribute(context,fullModel).asString();
  final boolean useNative=WebDefinition.NATIVE.resolveModelAttribute(context,fullModel).asBoolean();
  final ModelNode instanceIdModel=WebDefinition.INSTANCE_ID.resolveModelAttribute(context,fullModel);
  final String instanceId=instanceIdModel.isDefined() ? instanceIdModel.asString() : null;
  context.addStep(new AbstractDeploymentChainStep(){
    @Override protected void execute(    DeploymentProcessorTarget processorTarget){
      final SharedWebMetaDataBuilder sharedWebBuilder=new SharedWebMetaDataBuilder(config.clone());
      final SharedTldsMetaDataBuilder sharedTldsBuilder=new SharedTldsMetaDataBuilder(config.clone());
      processorTarget.addDeploymentProcessor(Phase.STRUCTURE,Phase.STRUCTURE_WAR_DEPLOYMENT_INIT,new WarDeploymentInitializingProcessor());
      processorTarget.addDeploymentProcessor(Phase.STRUCTURE,Phase.STRUCTURE_WAR,new WarStructureDeploymentProcessor(sharedWebBuilder.create(),sharedTldsBuilder));
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_WEB_DEPLOYMENT,new WebParsingDeploymentProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_WEB_DEPLOYMENT_FRAGMENT,new WebFragmentParsingDeploymentProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_JSF_VERSION,new JsfVersionProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_JBOSS_WEB_DEPLOYMENT,new JBossWebParsingDeploymentProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_TLD_DEPLOYMENT,new TldParsingDeploymentProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_ANNOTATION_WAR,new WarAnnotationDeploymentProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_WEB_COMPONENTS,new WebComponentProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_EAR_CONTEXT_ROOT,new EarContextRootProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_WEB_MERGE_METADATA,new WarMetaDataProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.POST_MODULE_JSF_MANAGED_BEANS,new JsfManagedBeanProcessor());
      processorTarget.addDeploymentProcessor(Phase.PARSE,Phase.PARSE_WEB_INITIALIZE_IN_ORDER,new WebInitializeInOrderProcessor(defaultVirtualServer));
      processorTarget.addDeploymentProcessor(Phase.DEPENDENCIES,Phase.DEPENDENCIES_WAR_MODULE,new WarClassloadingDependencyProcessor());
      processorTarget.addDeploymentProcessor(Phase.POST_MODULE,Phase.POST_MODULE_JSF_MANAGED_BEANS,new JsfManagedBeanProcessor());
      processorTarget.addDeploymentProcessor(Phase.INSTALL,Phase.INSTALL_SERVLET_INIT_DEPLOYMENT,new ServletContainerInitializerDeploymentProcessor());
      processorTarget.addDeploymentProcessor(Phase.INSTALL,Phase.INSTALL_JSF_ANNOTATIONS,new JsfAnnotationProcessor());
      processorTarget.addDeploymentProcessor(Phase.INSTALL,Phase.INSTALL_WAR_DEPLOYMENT,new WarDeploymentProcessor(defaultVirtualServer));
    }
  }
,OperationContext.Stage.RUNTIME);
  final WebServerService service=new WebServerService(defaultVirtualServer,useNative,instanceId,TEMP_DIR);
  newControllers.add(context.getServiceTarget().addService(WebSubsystemServices.JBOSS_WEB,service).addDependency(PathManagerService.SERVICE_NAME,PathManager.class,service.getPathManagerInjector()).addDependency(DependencyType.OPTIONAL,ServiceName.JBOSS.append("mbean","server"),MBeanServer.class,service.getMbeanServer()).setInitialMode(Mode.ON_DEMAND).install());
}
