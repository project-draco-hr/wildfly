{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final DeploymentUnit topLevelDeployment=deploymentUnit.getParent() == null ? deploymentUnit : deploymentUnit.getParent();
  final ResourceRoot mainRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  if (mainRoot == null)   return;
  final ModuleSpecification moduleSpec=deploymentUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
  final List<ResourceRoot> resourceRoots=new ArrayList<ResourceRoot>();
  if (ModuleRootMarker.isModuleRoot(mainRoot)) {
    resourceRoots.add(mainRoot);
  }
  final List<ResourceRoot> additionalRoots=deploymentUnit.getAttachmentList(Attachments.RESOURCE_ROOTS);
  for (  final ResourceRoot additionalRoot : additionalRoots) {
    if (ModuleRootMarker.isModuleRoot(additionalRoot) && !SubDeploymentMarker.isSubDeployment(additionalRoot)) {
      resourceRoots.add(additionalRoot);
    }
  }
  final ModuleIdentifier moduleIdentifier=deploymentUnit.getAttachment(Attachments.MODULE_IDENTIFIER);
  if (moduleIdentifier == null) {
    throw ServerMessages.MESSAGES.noModuleIdentifier(deploymentUnit.getName());
  }
  final List<AdditionalModuleSpecification> additionalModules=topLevelDeployment.getAttachmentList(Attachments.ADDITIONAL_MODULES);
  final ServiceName moduleServiceName=createModuleService(phaseContext,deploymentUnit,resourceRoots,moduleSpec,moduleIdentifier);
  phaseContext.addDeploymentDependency(moduleServiceName,Attachments.MODULE);
  for (  final DeploymentUnit subDeployment : deploymentUnit.getAttachmentList(Attachments.SUB_DEPLOYMENTS)) {
    ModuleIdentifier moduleId=subDeployment.getAttachment(Attachments.MODULE_IDENTIFIER);
    if (moduleId != null) {
      phaseContext.addToAttachmentList(Attachments.NEXT_PHASE_DEPS,ServiceModuleLoader.moduleSpecServiceName(moduleId));
    }
  }
  if (deploymentUnit.getParent() != null) {
    return;
  }
  for (  final AdditionalModuleSpecification module : additionalModules) {
    addAllDependenciesAndPermissions(moduleSpec,module);
    List<ResourceRoot> roots=module.getResourceRoots();
    ServiceName serviceName=createModuleService(phaseContext,deploymentUnit,roots,module,module.getModuleIdentifier());
    phaseContext.addToAttachmentList(Attachments.NEXT_PHASE_DEPS,serviceName);
  }
}
