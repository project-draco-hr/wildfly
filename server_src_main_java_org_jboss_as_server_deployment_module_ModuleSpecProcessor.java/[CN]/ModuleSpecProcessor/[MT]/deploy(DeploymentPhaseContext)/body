{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (deploymentUnit.getAttachment(MARKER) != null) {
    return;
  }
  deploymentUnit.putAttachment(MARKER,true);
  if (deploymentUnit.hasAttachment(Attachments.OSGI_MANIFEST)) {
    return;
  }
  final ResourceRoot mainRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  final List<ResourceRoot> additionalRoots=deploymentUnit.getAttachmentList(Attachments.RESOURCE_ROOTS);
  if (mainRoot == null) {
    return;
  }
  final List<ResourceRoot> resourceRoots=new ArrayList<ResourceRoot>();
  if (ModuleRootMarker.isModuleRoot(mainRoot)) {
    resourceRoots.add(mainRoot);
  }
  for (  final ResourceRoot additionalRoot : additionalRoots) {
    if (ModuleRootMarker.isModuleRoot(additionalRoot) && !SubDeploymentMarker.isSubDeployment(additionalRoot)) {
      resourceRoots.add(additionalRoot);
    }
  }
  final ModuleSpecification moduleSpecification=deploymentUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
  final ModuleIdentifier moduleIdentifier=deploymentUnit.getAttachment(Attachments.MODULE_IDENTIFIER);
  if (moduleIdentifier == null) {
    throw ServerMessages.MESSAGES.noModuleIdentifier(deploymentUnit.getName());
  }
  final ServiceName moduleServiceName=createModuleService(phaseContext,deploymentUnit,resourceRoots,moduleSpecification,moduleIdentifier);
  phaseContext.addDeploymentDependency(moduleServiceName,Attachments.MODULE);
  for (  final DeploymentUnit subDeployment : deploymentUnit.getAttachmentList(Attachments.SUB_DEPLOYMENTS)) {
    ModuleIdentifier moduleId=subDeployment.getAttachment(Attachments.MODULE_IDENTIFIER);
    if (moduleId != null) {
      phaseContext.addToAttachmentList(Attachments.NEXT_PHASE_DEPS,ServiceModuleLoader.moduleSpecServiceName(moduleId));
    }
  }
  final List<AdditionalModuleSpecification> additionalModules=deploymentUnit.getAttachment(Attachments.ADDITIONAL_MODULES);
  if (additionalModules == null) {
    return;
  }
  for (  final AdditionalModuleSpecification module : additionalModules) {
    addSystemDependencies(moduleSpecification,module);
    final ServiceName additionalModuleServiceName=createModuleService(phaseContext,deploymentUnit,module.getResourceRoots(),module,module.getModuleIdentifier());
    phaseContext.addToAttachmentList(Attachments.NEXT_PHASE_DEPS,additionalModuleServiceName);
  }
}
