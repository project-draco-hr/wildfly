{
  if (path.startsWith("/"))   return getPersistenceUnit(getTopLevel(current),path.substring(1));
  if (path.startsWith("./"))   return getPersistenceUnit(current,path.substring(2));
  if (path.startsWith("../"))   return getPersistenceUnit(current.getParent(),path.substring(3));
  int i=path.indexOf('/');
  String name;
  if (i == -1)   name=path;
 else   name=path.substring(0,i);
  List<ResourceRoot> resourceRoots=current.getAttachmentList(Attachments.RESOURCE_ROOTS);
  for (  ResourceRoot resourceRoot : resourceRoots) {
    PersistenceUnitMetadataHolder holder=resourceRoot.getAttachment(PersistenceUnitMetadataHolder.PERSISTENCE_UNITS);
    if (holder != null) {
      for (      PersistenceUnitMetadata pu : holder.getPersistenceUnits()) {
        if (traceEnabled) {
          log.tracef("getPersistenceUnit check '%s' against pu '%s'",name,pu.getPersistenceUnitName());
        }
        if (pu.getPersistenceUnitName().equals(name)) {
          if (traceEnabled) {
            log.tracef("getPersistenceUnit matched '%s' against pu '%s'",name,pu.getPersistenceUnitName());
          }
          return pu;
        }
      }
    }
  }
  throw new IllegalArgumentException("Can't find a deployment unit named " + name + " at "+ current);
}
