{
  if (!allowScoped && isScoped(unit))   return null;
  final ResourceRoot deploymentRoot=unit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  PersistenceUnitMetadataHolder holder=deploymentRoot.getAttachment(PersistenceUnitMetadataHolder.PERSISTENCE_UNITS);
  if (holder == null || holder.getPersistenceUnits() == null)   return null;
  for (  PersistenceUnitMetadata persistenceUnit : holder.getPersistenceUnits()) {
    if (traceEnabled) {
      log.tracef("findWithinModule check '%s' against pu '%s'",persistenceUnitName,persistenceUnit.getPersistenceUnitName());
    }
    if (persistenceUnitName == null || persistenceUnitName.length() == 0 || persistenceUnit.getPersistenceUnitName().equals(persistenceUnitName)) {
      if (traceEnabled) {
        log.tracef("findWithinModule matched '%s' against pu '%s'",persistenceUnitName,persistenceUnit.getPersistenceUnitName());
      }
      return persistenceUnit;
    }
  }
  return null;
}
