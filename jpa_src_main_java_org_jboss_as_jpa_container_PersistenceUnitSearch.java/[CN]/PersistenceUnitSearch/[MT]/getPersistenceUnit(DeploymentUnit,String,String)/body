{
  final String path;
  if (absolutePath.startsWith("../")) {
    path=absolutePath.substring(3);
  }
 else {
    path=absolutePath;
  }
  final VirtualFile parent=current.getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot().getParent();
  final VirtualFile resolvedPath=parent.getChild(path);
  List<ResourceRoot> resourceRoots=DeploymentUtils.allResourceRoots(getTopLevel(current));
  for (  ResourceRoot resourceRoot : resourceRoots) {
    if (resourceRoot.getRoot().equals(resolvedPath)) {
      PersistenceUnitMetadataHolder holder=resourceRoot.getAttachment(PersistenceUnitMetadataHolder.PERSISTENCE_UNITS);
      if (holder != null) {
        for (        PersistenceUnitMetadata pu : holder.getPersistenceUnits()) {
          if (traceEnabled) {
            log.tracef("getPersistenceUnit check '%s' against pu '%s'",puName,pu.getPersistenceUnitName());
          }
          if (pu.getPersistenceUnitName().equals(puName)) {
            if (traceEnabled) {
              log.tracef("getPersistenceUnit matched '%s' against pu '%s'",puName,pu.getPersistenceUnitName());
            }
            return pu;
          }
        }
      }
    }
  }
  throw new IllegalArgumentException("Can't find a deployment unit named " + absolutePath + "#"+ puName+ " at "+ current);
}
