{
  int i=(persistenceUnitName == null ? -1 : persistenceUnitName.indexOf('#'));
  if (i != -1) {
    String path=persistenceUnitName.substring(0,i);
    PersistenceUnitMetadata pu=getPersistenceUnit(deploymentUnit,path);
    return pu.getScopedPersistenceUnitName();
  }
 else {
    String name=findPersistenceUnitSupplier(deploymentUnit,persistenceUnitName);
    if (name == null)     throw new IllegalArgumentException("Can't find a persistence unit named '" + persistenceUnitName + "' in "+ deploymentUnit);
    return name;
  }
}
