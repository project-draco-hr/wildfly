{
  final Class<?> type=callback.getType();
synchronized (type) {
    Map<BeanState,List<Callback>> states=map.get(type);
    if (states != null) {
      List<Callback> callbacks=states.get(callback.getState());
      if (callbacks != null) {
        callbacks.remove(callback);
        if (callbacks.isEmpty())         states.remove(callback.getState());
      }
      if (states.isEmpty())       map.remove(type);
    }
    if (map == uncallbacks) {
      try {
        callback.dispatch();
      }
 catch (      Throwable t) {
        log.warn("Error invoking uncallback: " + callback,t);
      }
    }
  }
}
