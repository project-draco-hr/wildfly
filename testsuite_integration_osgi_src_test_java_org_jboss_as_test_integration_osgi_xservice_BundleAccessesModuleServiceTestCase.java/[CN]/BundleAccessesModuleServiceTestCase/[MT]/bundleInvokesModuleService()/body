{
  deployer.deploy(TARGET_MODULE_NAME);
  try {
    ServiceName targetService=ServiceName.parse("jboss.osgi.example.target.service");
    assertServiceState(serviceContainer,targetService,State.UP,5000);
    InputStream input=deployer.getDeployment(CLIENT_BUNDLE_NAME);
    Bundle clientBundle=context.installBundle(CLIENT_BUNDLE_NAME,input);
    assertEquals("Bundle INSTALLED",Bundle.INSTALLED,clientBundle.getState());
    try {
      clientBundle.start();
      assertEquals("Bundle ACTIVE",Bundle.ACTIVE,clientBundle.getState());
      BundleContext context=clientBundle.getBundleContext();
      ServiceReference<StringBuffer> sref=context.getServiceReference(StringBuffer.class);
      StringBuffer service=context.getService(sref);
      assertEquals("hello world",service.toString());
    }
  finally {
      clientBundle.uninstall();
    }
  }
  finally {
    deployer.undeploy(TARGET_MODULE_NAME);
  }
}
