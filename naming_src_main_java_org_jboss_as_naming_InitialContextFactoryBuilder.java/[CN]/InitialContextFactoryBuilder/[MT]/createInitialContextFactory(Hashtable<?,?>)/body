{
  final String factoryClassName=(String)environment.get(Context.INITIAL_CONTEXT_FACTORY);
  if (factoryClassName == null || InitialContextFactory.class.getName().equals(factoryClassName)) {
    return DEFAULT_FACTORY;
  }
  final ClassLoader classLoader=getContextClassLoader();
  try {
    final Class<?> factoryClass=classLoader.loadClass(factoryClassName);
    return (javax.naming.spi.InitialContextFactory)factoryClass.newInstance();
  }
 catch (  Exception e) {
    throw new NamingException("Failed instantiate InitialContextFactory " + factoryClassName + " from classloader "+ classLoader);
  }
}
