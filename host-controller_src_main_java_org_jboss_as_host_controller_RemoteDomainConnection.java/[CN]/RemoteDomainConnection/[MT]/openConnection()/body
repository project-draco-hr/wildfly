{
  CallbackHandler callbackHandler=null;
  SSLContext sslContext=null;
  if (realm != null) {
    sslContext=realm.getSSLContext();
    CallbackHandlerFactory handlerFactory=realm.getSecretCallbackHandlerFactory();
    if (handlerFactory != null) {
      String username=this.username != null ? this.username : localHostName;
      callbackHandler=handlerFactory.getCallbackHandler(username);
    }
  }
  final ProtocolConnectionConfiguration config=ProtocolConnectionConfiguration.copy(configuration);
  config.setCallbackHandler(callbackHandler);
  config.setSslContext(sslContext);
  config.setUri(uri);
  return ProtocolConnectionUtils.connectSync(config);
}
