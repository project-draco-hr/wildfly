{
  Set<String> mappedRoles=new HashSet<String>();
  HashMap<String,Role> rolesToCheck;
  if (useRealmRoles) {
    rolesToCheck=new HashMap<String,Role>(roles);
    Set<String> realmRoles=caller.getAssociatedRoles();
    for (    String current : realmRoles) {
      String roleName=current.toUpperCase();
      if (rolesToCheck.containsKey(roleName)) {
        Role role=rolesToCheck.remove(roleName);
        if (role.isExcluded(caller) == false) {
          mappedRoles.add(roleName);
        }
      }
 else {
        mappedRoles.add(roleName);
      }
    }
  }
 else {
    rolesToCheck=roles;
  }
  for (  Role current : rolesToCheck.values()) {
    if (current.isIncluded(caller) && (current.isExcluded(caller) == false)) {
      mappedRoles.add(current.getName());
    }
  }
  return Collections.unmodifiableSet(mappedRoles);
}
