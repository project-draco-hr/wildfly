{
  final String productVersion=productConfig.resolveVersion();
  final String productName=productConfig.getProductName();
  final Identity identity=new AbstractIdentity(){
    @Override public String getName(){
      return productName;
    }
    @Override public String getVersion(){
      return productVersion;
    }
    @Override public InstalledImage getInstalledImage(){
      return image;
    }
  }
;
  final InstalledConfiguration conf=createInstalledConfig(image);
  final ProcessedLayers processedLayers=process(conf,moduleRoots,bundleRoots);
  final InstalledConfiguration config=processedLayers.getConf();
  final List<Layer> layers=new ArrayList<Layer>();
  for (  final LayerPathConfig layer : processedLayers.getLayers().values()) {
    final String name=layer.name;
    layers.add(createPatchableTarget(name,layer,config.getLayerMetadataDir(name),image));
  }
  final Collection<AddOn> addOns=new ArrayList<AddOn>();
  for (  final LayerPathConfig addOn : processedLayers.getAddOns().values()) {
    final String name=addOn.name;
    addOns.add(createPatchableTarget(name,addOn,config.getAddOnMetadataDir(name),image));
  }
  return new InstalledIdentity(){
    @Override public Collection<AddOn> getAddOns(){
      return addOns;
    }
    @Override public List<Layer> getLayers(){
      return layers;
    }
    @Override public Identity getIdentity(){
      return identity;
    }
  }
;
}
