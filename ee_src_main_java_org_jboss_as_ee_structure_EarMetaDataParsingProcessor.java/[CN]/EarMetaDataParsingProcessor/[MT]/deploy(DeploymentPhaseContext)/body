{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (!DeploymentTypeMarker.isType(DeploymentType.EAR,deploymentUnit)) {
    return;
  }
  final ResourceRoot deploymentRoot=deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.DEPLOYMENT_ROOT);
  final VirtualFile deploymentFile=deploymentRoot.getRoot();
  final VirtualFile applicationXmlFile=deploymentFile.getChild(APPLICATION_XML);
  if (!applicationXmlFile.exists()) {
    return;
  }
  InputStream inputStream=null;
  try {
    inputStream=applicationXmlFile.openStream();
    final XMLInputFactory inputFactory=XMLInputFactory.newInstance();
    inputFactory.setXMLResolver(NoopXmlResolver.create());
    XMLStreamReader xmlReader=inputFactory.createXMLStreamReader(inputStream);
    final EarMetaData earMetaData=EarMetaDataParser.parse(xmlReader);
    if (earMetaData != null) {
      deploymentUnit.putAttachment(Attachments.EAR_METADATA,earMetaData);
      if (earMetaData instanceof Ear6xMetaData) {
        Ear6xMetaData metaData=(Ear6xMetaData)earMetaData;
        if (metaData.getEarEnvironmentRefsGroup() != null) {
          final DeploymentDescriptorEnvironment bindings=new DeploymentDescriptorEnvironment("java:app/env/",((Ear6xMetaData)earMetaData).getEarEnvironmentRefsGroup());
          deploymentUnit.putAttachment(org.jboss.as.ee.component.Attachments.MODULE_DEPLOYMENT_DESCRIPTOR_ENVIRONMENT,bindings);
        }
      }
    }
  }
 catch (  Exception e) {
    throw new DeploymentUnitProcessingException("Failed to parse " + applicationXmlFile,e);
  }
 finally {
    VFSUtils.safeClose(inputStream);
  }
}
