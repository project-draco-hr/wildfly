{
  Subject subject=new Subject();
  Set<Principal> principals=subject.getPrincipals();
  principals.add(new User(userName,realm));
  for (  String current : groups) {
    principals.add(new Group(current,realm));
  }
  if (addRole) {
    principals.add(new Role(roleName));
  }
  Subject.doAs(subject,new PrivilegedAction<Void>(){
    @Override public Void run(){
      assertIsCallerInRole(roleName,expectedOutcome);
      return null;
    }
  }
);
}
