{
  final ModelNode model=Resource.Tools.readModel(context.readResource(PathAddress.EMPTY_ADDRESS));
  context.removeResource(PathAddress.EMPTY_ADDRESS);
  RbacSanityCheckOperation.addOperation(context);
  context.addStep(new OperationStepHandler(){
    @Override public void execute(    OperationContext context,    ModelNode operation) throws OperationFailedException {
      final boolean reloadRequired=ManagementUtil.isSecurityRealmReloadRequired(context,operation);
      final String realmName=ManagementUtil.getSecurityRealmName(operation);
      if (reloadRequired) {
        context.reloadRequired();
      }
 else {
        removeServices(context,realmName,model);
      }
      context.completeStep(new OperationContext.RollbackHandler(){
        @Override public void handleRollback(        OperationContext context,        ModelNode operation){
          if (reloadRequired) {
            context.revertReloadRequired();
          }
 else {
            recoverServices(context,realmName,model);
          }
        }
      }
);
    }
  }
,OperationContext.Stage.RUNTIME);
  context.completeStep(OperationContext.RollbackHandler.NOOP_ROLLBACK_HANDLER);
}
