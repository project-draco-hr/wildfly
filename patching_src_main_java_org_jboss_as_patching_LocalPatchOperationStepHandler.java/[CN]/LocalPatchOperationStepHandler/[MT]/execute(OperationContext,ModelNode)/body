{
  context.acquireControllerLock();
  final PatchInfoService service=(PatchInfoService)context.getServiceRegistry(false).getRequiredService(PatchInfoService.NAME).getValue();
  final PatchInfo info=service.getPatchInfo();
  final DirectoryStructure structure=service.getStructure();
  final PatchingTaskRunner runner=new PatchingTaskRunner(info,structure);
  final InputStream is=context.getAttachmentStream(0);
  try {
    final PatchingResult result=runner.executeDirect(is);
    final PatchInfo newInfo=result.getPatchInfo();
    service.setPatchInfo(info,newInfo);
    context.completeStep(new OperationContext.RollbackHandler(){
      @Override public void handleRollback(      OperationContext context,      ModelNode operation){
        result.rollback();
      }
    }
);
  }
 catch (  PatchingException e) {
    throw new OperationFailedException(e.getMessage(),e);
  }
}
