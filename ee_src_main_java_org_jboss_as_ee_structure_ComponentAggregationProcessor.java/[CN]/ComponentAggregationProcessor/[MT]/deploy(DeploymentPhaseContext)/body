{
  DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final EEApplicationDescription applicationDescription=new EEApplicationDescription();
  if (deploymentUnit.getAttachment(Attachments.DEPLOYMENT_TYPE) == DeploymentType.EAR) {
    final List<DeploymentUnit> subdeployments=deploymentUnit.getAttachmentList(SUB_DEPLOYMENTS);
    for (    DeploymentUnit subdeployment : subdeployments) {
      final EEModuleDescription moduleDescription=subdeployment.getAttachment(EE_MODULE_DESCRIPTION);
      if (moduleDescription == null) {
        continue;
      }
      for (      AbstractComponentDescription componentDescription : moduleDescription.getComponentDescriptions()) {
        applicationDescription.addComponent(componentDescription);
      }
      subdeployment.putAttachment(EE_APPLICATION_DESCRIPTION,applicationDescription);
    }
  }
 else   if (deploymentUnit.getParent() == null) {
    final EEModuleDescription moduleDescription=deploymentUnit.getAttachment(EE_MODULE_DESCRIPTION);
    if (moduleDescription == null) {
      return;
    }
    for (    AbstractComponentDescription componentDescription : moduleDescription.getComponentDescriptions()) {
      applicationDescription.addComponent(componentDescription);
    }
    deploymentUnit.putAttachment(EE_APPLICATION_DESCRIPTION,applicationDescription);
  }
}
