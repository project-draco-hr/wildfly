{
  this.container.start(DEFAULT_JBOSSAS);
  try {
    this.deployer.deploy(DEFAULT_AS_DEPLOYMENT);
    this.container.start(JBOSSAS_WITH_REMOTE_OUTBOUND_CONNECTION);
    this.deployer.deploy(DEPLOYMENT_WITH_JBOSS_EJB_CLIENT_XML);
    final NodeNameEcho nonClusteredBean=(NodeNameEcho)this.context.lookup("ejb:/" + MODULE_NAME + "//"+ NonClusteredStatefulNodeNameEcho.class.getSimpleName()+ "!"+ NodeNameEcho.class.getName()+ "?stateful");
    final String nodeNameBeforeShutdown=nonClusteredBean.getNodeName(true);
    Assert.assertEquals("EJB invocation ended up on unexpected node",DEFAULT_JBOSSAS_NODE_NAME,nodeNameBeforeShutdown);
    this.container.stop(DEFAULT_JBOSSAS);
    final String nodeNameAfterShutdown=nonClusteredBean.getNodeName(false);
    Assert.assertEquals("EJB invocation ended up on unexpected node after shutdown",JBOSSAS_WITH_OUTBOUND_CONNECTION_NODE_NAME,nodeNameAfterShutdown);
  }
  finally {
    try {
      this.deployer.undeploy(DEPLOYMENT_WITH_JBOSS_EJB_CLIENT_XML);
      this.container.stop(JBOSSAS_WITH_REMOTE_OUTBOUND_CONNECTION);
    }
 catch (    Exception e) {
      logger.debug("Exception during container shutdown",e);
    }
    try {
      if (!this.container.isStarted(DEFAULT_JBOSSAS)) {
        this.container.start(DEFAULT_JBOSSAS);
      }
      this.deployer.undeploy(DEFAULT_AS_DEPLOYMENT);
      this.container.stop(DEFAULT_JBOSSAS);
    }
 catch (    Exception e) {
      logger.debug("Exception during container shutdown",e);
    }
  }
}
