{
  exchange.addResponseWrapper(new ConduitWrapper<StreamSinkConduit>(){
    @Override public StreamSinkConduit wrap(    final ConduitFactory<StreamSinkConduit> factory,    final HttpServerExchange exchange){
      ServletRequestContext requestContext=exchange.getAttachment(ServletRequestContext.ATTACHMENT_KEY);
      String applicationIdentifier=buildApplicationIdentifier(requestContext);
      if (!wasAuthExceptionThrown()) {
        ROOT_LOGGER.debugf("secureResponse for layer [%s] and applicationContextIdentifier [%s].",JASPI_HTTP_SERVLET_LAYER,applicationIdentifier);
        sam.secureResponse(messageInfo,new Subject(),JASPI_HTTP_SERVLET_LAYER,applicationIdentifier,cbh);
        ServletRequestContext servletRequestContext=exchange.getAttachment(ServletRequestContext.ATTACHMENT_KEY);
        servletRequestContext.setServletRequest((HttpServletRequest)messageInfo.getRequestMessage());
        servletRequestContext.setServletResponse((HttpServletResponse)messageInfo.getResponseMessage());
      }
      return factory.create();
    }
  }
);
}
