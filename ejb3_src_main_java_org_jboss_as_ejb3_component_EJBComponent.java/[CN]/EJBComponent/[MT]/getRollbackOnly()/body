{
  if (isBeanManagedTransaction()) {
    throw new IllegalStateException("EJB 3.1 FR 13.6.1 Only beans with container-managed transaction demarcation " + "can use getRollbackOnly.");
  }
  try {
    TransactionManager tm=this.getTransactionManager();
    if (tm.getTransaction() == null) {
      throw new IllegalStateException("getRollbackOnly() not allowed without a transaction.");
    }
    int status=tm.getStatus();
    if (log.isTraceEnabled()) {
      log.trace("Current transaction status is " + status);
    }
switch (status) {
case Status.STATUS_COMMITTED:
case Status.STATUS_ROLLEDBACK:
      throw new IllegalStateException("getRollbackOnly() not allowed after transaction is completed (EJBTHREE-1445)");
case Status.STATUS_MARKED_ROLLBACK:
case Status.STATUS_ROLLING_BACK:
    return true;
}
return false;
}
 catch (SystemException se) {
log.warn("failed to get tx manager status; ignoring",se);
return true;
}
}
