{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (!EarDeploymentMarker.isEarDeployment(deploymentUnit)) {
    return;
  }
  List<ResourceRoot> potentialSubDeployments=deploymentUnit.getAttachment(Attachments.RESOURCE_ROOTS);
  for (  ResourceRoot resourceRoot : potentialSubDeployments) {
    if (ModuleRootMarker.isModuleRoot(resourceRoot)) {
      continue;
    }
    VirtualFile ejbJarFile=resourceRoot.getRoot().getChild("META-INF/ejb-jar.xml");
    if (ejbJarFile.exists()) {
      SubDeploymentMarker.markRoot(resourceRoot);
    }
 else {
      final Index index=resourceRoot.getAttachment(Attachments.ANNOTATION_INDEX);
      if (index != null) {
        if (!index.getAnnotations(STATEFULL).isEmpty() || !index.getAnnotations(STATELESS).isEmpty() || !index.getAnnotations(MESSAGE_DRIVEN).isEmpty()|| !index.getAnnotations(SINGLETON).isEmpty()) {
          SubDeploymentMarker.markRoot(resourceRoot);
        }
      }
    }
  }
}
