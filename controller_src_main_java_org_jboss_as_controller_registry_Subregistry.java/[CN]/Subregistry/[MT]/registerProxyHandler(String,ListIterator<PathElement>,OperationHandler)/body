{
  OperationRegistry registry;
  registry=childRegistriesUpdater.get(this,elementValue);
  if (registry == null) {
    final boolean last=!iterator.hasNext();
    final OperationRegistry newRegistry=last ? new ProxyOperationRegistry(elementValue,this,handler) : new ConcreteOperationRegistry(elementValue,this);
    final OperationRegistry appearingRegistry=childRegistriesUpdater.putIfAbsent(this,elementValue,newRegistry);
    if (appearingRegistry == null && last) {
      return;
    }
    registry=appearingRegistry;
  }
  registry.registerProxyHandler(iterator,handler);
}
