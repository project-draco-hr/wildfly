{
  final Resource root=context.readResourceForUpdate(PathAddress.EMPTY_ADDRESS);
  final String hostName=operation.get(HOST).asString();
  final List<ModelNode> modelDescription=describeAsNodeList(root);
  ModelNode op=new ModelNode();
  op.get(OP).set(ApplyRemoteMasterDomainModelHandler.OPERATION_NAME);
  op.get(OP_ADDR).setEmptyList();
  op.get(DOMAIN_MODEL).set(modelDescription);
  final ProxyController proxy=registry.popChannelAndCreateProxy(hostName);
  final AtomicReference<ModelNode> failedRef=new AtomicReference<ModelNode>();
  final AtomicReference<ModelNode> preparedRef=new AtomicReference<ModelNode>();
  final AtomicReference<OperationTransaction> txRef=new AtomicReference<OperationTransaction>();
  ProxyController.ProxyOperationControl control=new ProxyController.ProxyOperationControl(){
    @Override public void operationFailed(    ModelNode response){
      failedRef.set(response);
    }
    @Override public void operationPrepared(    OperationTransaction transaction,    ModelNode result){
      txRef.set(transaction);
      preparedRef.set(result);
    }
    @Override public void operationCompleted(    ModelNode response){
    }
  }
;
  proxy.execute(op,OperationMessageHandler.logging,control,null);
  if (failedRef.get() != null) {
    final ModelNode failed=failedRef.get();
    context.getResult().set(failed.get(RESULT));
    context.getFailureDescription().set(failed.get(FAILURE_DESCRIPTION));
    context.completeStep();
  }
 else {
    final ModelNode preparedResult=preparedRef.get();
    context.getResult().set(preparedResult.get(RESULT));
    if (preparedResult.hasDefined(FAILURE_DESCRIPTION)) {
      context.getFailureDescription().set(preparedResult.get(FAILURE_DESCRIPTION));
    }
    OperationContext.ResultAction resultAction=context.completeStep();
    ModelController.OperationTransaction tx=txRef.get();
    if (tx != null) {
      if (resultAction == OperationContext.ResultAction.KEEP) {
        tx.commit();
        domainController.registerRemoteHost(proxy);
      }
 else {
        tx.rollback();
      }
    }
  }
}
