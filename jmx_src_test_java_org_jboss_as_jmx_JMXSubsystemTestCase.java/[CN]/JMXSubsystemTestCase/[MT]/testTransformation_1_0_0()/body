{
  String subsystemXml="<subsystem xmlns=\"" + Namespace.CURRENT.getUriString() + "\">"+ "   <show-resolved-model domain-name=\"jboss.RESOLVED\"/>"+ "   <show-expression-model domain-name=\"jboss.EXPRESSION\"/>"+ "   <remoting-connector />"+ "</subsystem>";
  ModelVersion oldVersion=ModelVersion.create(1,0,0);
  KernelServicesBuilder builder=createKernelServicesBuilder(new BaseAdditionalInitalization()).setSubsystemXml(subsystemXml);
  builder.createLegacyKernelServicesBuilder(null,oldVersion).setExtensionClassName(JMXExtension.class.getName()).addMavenResourceURL("org.jboss.as:jboss-as-jmx:7.1.2.Final");
  KernelServices mainServices=builder.build();
  KernelServices legacyServices=mainServices.getLegacyServices(oldVersion);
  Assert.assertNotNull(legacyServices);
  ModelNode legacyModel=legacyServices.readWholeModel();
  ModelNode legacySubsystem=legacyModel.get(SUBSYSTEM,mainSubsystemName);
  check_1_0_0_Model(legacySubsystem,true,true);
  checkSubsystemTransformer(mainServices,legacySubsystem,oldVersion);
  ModelNode op=createOperation(WRITE_ATTRIBUTE_OPERATION,CommonAttributes.SHOW_MODEL,CommonAttributes.EXPRESSION);
  op.get(NAME).set(CommonAttributes.DOMAIN_NAME);
  op.get(VALUE).set("discarded");
  TransformedOperation transformedOp=mainServices.transformOperation(oldVersion,op);
  Assert.assertNull(transformedOp.getTransformedOperation());
  op=createOperation(READ_ATTRIBUTE_OPERATION,CommonAttributes.SHOW_MODEL,CommonAttributes.EXPRESSION);
  op.get(NAME).set(CommonAttributes.DOMAIN_NAME);
  transformedOp=mainServices.transformOperation(oldVersion,op);
  Assert.assertNull(transformedOp.getTransformedOperation());
  op=createOperation(ADD,CommonAttributes.SHOW_MODEL,CommonAttributes.EXPRESSION);
  transformedOp=mainServices.transformOperation(oldVersion,op);
  Assert.assertNull(transformedOp.getTransformedOperation());
  op=createOperation(REMOVE,CommonAttributes.SHOW_MODEL,CommonAttributes.EXPRESSION);
  transformedOp=mainServices.transformOperation(oldVersion,op);
  Assert.assertNull(transformedOp.getTransformedOperation());
  op=createOperation(WRITE_ATTRIBUTE_OPERATION,CommonAttributes.SHOW_MODEL,CommonAttributes.RESOLVED);
  op.get(NAME).set(CommonAttributes.DOMAIN_NAME);
  op.get(VALUE).set("discarded");
  final TransformedOperation operation=mainServices.transformOperation(oldVersion,op);
  Assert.assertNotNull(operation);
  Assert.assertNull(operation.getTransformedOperation());
  op=createOperation(READ_ATTRIBUTE_OPERATION,CommonAttributes.SHOW_MODEL,CommonAttributes.RESOLVED);
  op.get(NAME).set(CommonAttributes.DOMAIN_NAME);
  transformedOp=mainServices.transformOperation(oldVersion,op);
  Assert.assertNull(transformedOp.getTransformedOperation());
  Assert.assertEquals(CommonAttributes.DEFAULT_RESOLVED_DOMAIN,mainServices.executeOperation(oldVersion,transformedOp).get(RESULT).asString());
  op=createOperation(REMOVE,CommonAttributes.SHOW_MODEL,CommonAttributes.RESOLVED);
  transformedOp=mainServices.transformOperation(oldVersion,op);
  mainServices.executeOperation(oldVersion,transformedOp).get(RESULT).asString();
  legacyModel=legacyServices.readWholeModel();
  legacySubsystem=legacyModel.get(SUBSYSTEM,mainSubsystemName);
  check_1_0_0_Model(legacySubsystem,true,false);
  mainServices.executeOperation(op);
  checkSubsystemTransformer(mainServices,legacySubsystem,oldVersion);
  op=createOperation(ADD,CommonAttributes.SHOW_MODEL,CommonAttributes.RESOLVED);
  transformedOp=mainServices.transformOperation(oldVersion,op);
  mainServices.executeOperation(oldVersion,transformedOp).get(RESULT).asString();
  legacyModel=legacyServices.readWholeModel();
  legacySubsystem=legacyModel.get(SUBSYSTEM,mainSubsystemName);
  check_1_0_0_Model(legacySubsystem,true,true);
  mainServices.executeOperation(op);
  checkSubsystemTransformer(mainServices,legacySubsystem,oldVersion);
}
