{
  String cache_type=properties.getProperty(CACHE_TYPE);
  String container=properties.getProperty(CONTAINER);
  EmbeddedCacheManager embeddedCacheManager;
  ServiceName serviceName;
  if (CACHE_PRIVATE.equals(cache_type)) {
    String name=properties.getProperty(NAME);
    serviceName=ServiceName.JBOSS.append(DEFAULT_CACHE_CONTAINER,(name != null) ? name : UUID.randomUUID().toString());
    ServiceContainer target=CurrentServiceContainer.getServiceContainer();
    InjectedValue<EmbeddedCacheManager> manager=new InjectedValue<EmbeddedCacheManager>();
    ServiceBuilder<EmbeddedCacheManager> builder=target.addService(serviceName,new ValueService<EmbeddedCacheManager>(manager)).addDependency(EmbeddedCacheManagerService.getServiceName(container),EmbeddedCacheManager.class,manager).setInitialMode(ServiceController.Mode.ACTIVE);
    embeddedCacheManager=ServiceContainerHelper.getValue(builder.install());
  }
 else {
    serviceName=EmbeddedCacheManagerService.getServiceName(container);
    ServiceRegistry registry=CurrentServiceContainer.getServiceContainer();
    embeddedCacheManager=(EmbeddedCacheManager)registry.getRequiredService(serviceName).getValue();
  }
  return new CacheWrapper(embeddedCacheManager,serviceName);
}
