{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (isEarDeployment(deploymentUnit)) {
    return;
  }
  final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
  final ServiceName moduleContextServiceName=ContextServiceNameBuilder.module(deploymentUnit);
  final RootContextService contextService=new RootContextService();
  serviceTarget.addService(moduleContextServiceName,contextService).install();
  final BinderService<String> moduleNameBinder=new BinderService<String>("ModuleName",Values.immediateValue(getModuleName(deploymentUnit)));
  serviceTarget.addService(moduleContextServiceName.append("ModuleName"),moduleNameBinder).addDependency(moduleContextServiceName,Context.class,moduleNameBinder.getContextInjector()).install();
  final ContextService envContextService=new ContextService("env");
  serviceTarget.addService(moduleContextServiceName.append("env"),envContextService).addDependency(moduleContextServiceName,Context.class,envContextService.getParentContextInjector()).install();
  phaseContext.getDeploymentUnit().putAttachment(Attachments.MODULE_CONTEXT_CONFIG,new NamingContextConfig(moduleContextServiceName));
}
