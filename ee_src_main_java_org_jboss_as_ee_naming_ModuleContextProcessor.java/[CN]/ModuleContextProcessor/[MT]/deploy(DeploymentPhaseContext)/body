{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (isEarDeployment(deploymentUnit)) {
    return;
  }
  final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
  final ServiceName moduleContextServiceName=ContextServiceNameBuilder.module(deploymentUnit);
  final RootContextService contextService=new RootContextService();
  serviceTarget.addService(moduleContextServiceName,contextService).install();
  final BinderService<String> moduleNameBinder=new BinderService<String>("ModuleName",Values.immediateValue(getModuleName(deploymentUnit)));
  serviceTarget.addService(moduleContextServiceName.append("ModuleName"),moduleNameBinder).addDependency(moduleContextServiceName,Context.class,moduleNameBinder.getContextInjector()).install();
  final ContextService envContextService=new ContextService("env");
  serviceTarget.addService(moduleContextServiceName.append("env"),envContextService).addDependency(moduleContextServiceName,Context.class,envContextService.getParentContextInjector()).install();
  final ServiceName appContextServiceName=deploymentUnit.getAttachment(Attachments.APPLICATION_CONTEXT_CONFIG);
  if (appContextServiceName != null) {
    final ContextService appModuleContextService=new ContextService(deploymentUnit.getName());
    serviceTarget.addService(appContextServiceName.append(deploymentUnit.getName()),appModuleContextService).addDependency(appContextServiceName,Context.class,appModuleContextService.getParentContextInjector()).install();
  }
  deploymentUnit.putAttachment(Attachments.MODULE_CONTEXT_CONFIG,moduleContextServiceName);
  ServiceName appNs=ContextServiceNameBuilder.app(deploymentUnit);
  ServiceName namespaceSelectorServiceName=deploymentUnit.getServiceName().append(NamespaceSelectorService.NAME);
  NamespaceSelectorService namespaceSelector=new NamespaceSelectorService();
  serviceTarget.addService(namespaceSelectorServiceName,namespaceSelector).addDependency(appNs,Context.class,namespaceSelector.getApp()).addDependency(moduleContextServiceName,Context.class,namespaceSelector.getModule()).addDependency(moduleContextServiceName,Context.class,namespaceSelector.getComp()).install();
}
