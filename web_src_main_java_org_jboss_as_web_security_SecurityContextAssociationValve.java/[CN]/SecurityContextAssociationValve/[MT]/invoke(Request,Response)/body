{
  final WarMetaData warMetaData=deploymentUnit.getAttachment(WarMetaData.ATTACHMENT_KEY);
  JBossWebMetaData metaData=warMetaData.getMergedJBossWebMetaData();
  activeRequest.set(request);
  Session session=null;
  Principal caller=request.getPrincipal();
  JBossGenericPrincipal principal=null;
  HttpSession hsession=request.getSession(false);
  WebLogger.WEB_SECURITY_LOGGER.tracef("Begin invoke, caller=" + caller);
  boolean createdSecurityContext=false;
  SecurityContext sc=SecurityActions.getSecurityContext();
  if (sc == null) {
    createdSecurityContext=true;
    String securityDomain=SecurityUtil.unprefixSecurityDomain(metaData.getSecurityDomain());
    if (securityDomain == null)     securityDomain=SecurityConstants.DEFAULT_WEB_APPLICATION_POLICY;
    sc=SecurityActions.createSecurityContext(securityDomain);
    SecurityActions.setSecurityContextOnAssociation(sc);
  }
  try {
    Wrapper servlet=null;
    try {
      servlet=request.getWrapper();
      if (servlet != null) {
        String name=servlet.getName();
        RunAsIdentityMetaData identity=metaData.getRunAsIdentity(name);
        RunAsIdentity runAsIdentity=null;
        if (identity != null) {
          WebLogger.WEB_SECURITY_LOGGER.tracef(name + ", runAs: " + identity);
          runAsIdentity=new RunAsIdentity(identity.getRoleName(),identity.getPrincipalName(),identity.getRunAsRoles());
        }
        SecurityActions.pushRunAsIdentity(runAsIdentity);
      }
      Manager manager=container.getManager();
      if (manager != null && hsession != null) {
        try {
          session=manager.findSession(hsession.getId());
        }
 catch (        IOException ignore) {
        }
      }
      if (caller == null || !(caller instanceof JBossGenericPrincipal)) {
        if (session != null) {
          principal=(JBossGenericPrincipal)session.getPrincipal();
        }
        if (principal == null) {
          Session sessionInternal=request.getSessionInternal(false);
          if (sessionInternal != null) {
            principal=(JBossGenericPrincipal)sessionInternal.getNote(Constants.FORM_PRINCIPAL_NOTE);
          }
        }
      }
 else {
        principal=(JBossGenericPrincipal)caller;
      }
      if (principal != null) {
        WebLogger.WEB_SECURITY_LOGGER.tracef("Restoring principal info from cache");
        if (createdSecurityContext) {
          sc.getUtil().createSubjectInfo(principal.getUserPrincipal(),principal.getCredentials(),principal.getSubject());
        }
      }
    }
 catch (    Throwable e) {
      WebLogger.WEB_SECURITY_LOGGER.debug("Failed to determine servlet",e);
    }
    String contextId=deploymentUnit.getName();
    if (deploymentUnit.getParent() != null)     contextId=deploymentUnit.getParent().getName() + "!" + contextId;
    PolicyContext.setContextID(contextId);
    getNext().invoke(request,response);
    if (servlet != null) {
      SecurityActions.popRunAsIdentity();
    }
  }
  finally {
    WebLogger.WEB_SECURITY_LOGGER.tracef("End invoke, caller=" + caller);
    SecurityActions.clearSecurityContext();
    SecurityRolesAssociation.setSecurityRoles(null);
    PolicyContext.setContextID(null);
    activeRequest.set(null);
  }
}
