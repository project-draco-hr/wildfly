{
  if (modulePath == null || modulePath.isDirectory() == false)   throw new IllegalArgumentException("Invalid module path: " + modulePath);
  String oldClassPath=SecurityActions.getSystemProperty("java.class.path");
  try {
    SecurityActions.clearSystemProperty("java.class.path");
    SecurityActions.setSystemProperty("module.path",modulePath.getAbsolutePath());
    StringBuffer packages=new StringBuffer("org.jboss.modules");
    if (systemPackages != null) {
      for (      String packageName : systemPackages)       packages.append("," + packageName);
    }
    SecurityActions.setSystemProperty("jboss.modules.system.pkgs",packages.toString());
    ModuleLoader moduleLoader=Module.getSystemModuleLoader();
    try {
      ModuleClassLoader classLoader=moduleLoader.loadModule(ModuleIdentifier.SYSTEM).getClassLoader();
      classLoader.loadClass(InitialModuleLoaderFactory.class.getName());
      throw new IllegalStateException("Cannot initialize module system. There was probably a previous usage.");
    }
 catch (    ModuleLoadException e) {
    }
catch (    ClassNotFoundException ex) {
    }
    return moduleLoader;
  }
  finally {
    SecurityActions.setSystemProperty("java.class.path",oldClassPath);
  }
}
