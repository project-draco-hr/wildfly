{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
  if (module == null) {
    return;
  }
  final ServicesAttachment services=deploymentUnit.getAttachment(Attachments.SERVICES);
  final List<String> implementations=services.getServiceImplementations(ExpressionFactory.class.getName());
  if (implementations != null && implementations.size() > 0) {
    FactoryFinderCache.addCacheEntry(module.getClassLoader(),FACTORY_ID,implementations.get(0));
  }
  try {
    String javah=System.getProperty("java.home");
    String configFile=javah + File.separator + "lib"+ File.separator+ "el.properties";
    File f=new File(configFile);
    if (f.exists()) {
      Properties props=new Properties();
      props.load(new FileInputStream(f));
      String factoryClassName=props.getProperty(FACTORY_ID);
      FactoryFinderCache.addCacheEntry(module.getClassLoader(),FACTORY_ID,factoryClassName);
    }
  }
 catch (  Exception ex) {
  }
  try {
    String systemProp=System.getProperty(FACTORY_ID);
    if (systemProp != null) {
      FactoryFinderCache.addCacheEntry(module.getClassLoader(),FACTORY_ID,systemProp);
    }
  }
 catch (  SecurityException se) {
  }
  try {
    FactoryFinderCache.addCacheEntry(module.getClassLoader(),FACTORY_ID,"org.apache.el.ExpressionFactoryImpl");
  }
 catch (  Throwable t) {
  }
}
