{
  SecurityContext sc=exchange.getAttachment(UndertowSecurityAttachments.SECURITY_CONTEXT_ATTACHMENT);
  String previousContextID=null;
  String identity=null;
  try {
    SecurityActions.setSecurityContextOnAssociation(sc);
    ServletChain servlet=exchange.getAttachment(ServletAttachments.ATTACHMENT_KEY).getCurrentServlet();
    identity=servlet.getManagedServlet().getServletInfo().getRunAs();
    RunAsIdentity runAsIdentity=null;
    if (identity != null) {
      UndertowLogger.ROOT_LOGGER.tracef("%s, runAs: %s",servlet.getManagedServlet().getServletInfo().getName(),identity);
      final Set<String> roles=principleVsRoleMap.get(identity);
      runAsIdentity=new RunAsIdentity(identity,identity,roles == null ? Collections.<String>emptySet() : roles);
    }
    SecurityActions.pushRunAsIdentity(runAsIdentity);
    previousContextID=setContextID(contextId);
    next.handleRequest(exchange);
  }
  finally {
    if (identity != null) {
      SecurityActions.popRunAsIdentity();
    }
    SecurityActions.clearSecurityContext();
    SecurityRolesAssociation.setSecurityRoles(null);
    setContextID(previousContextID);
  }
}
