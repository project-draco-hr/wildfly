{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  BundleInfo info=BundleInfoAttachment.getBundleInfoAttachment(deploymentUnit);
  if (info != null)   return;
  VirtualFile virtualFile=phaseContext.getDeploymentUnit().getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
  Manifest manifest=phaseContext.getAttachment(Attachments.MANIFEST);
  if (manifest == null) {
    try {
      manifest=VFSUtils.getManifest(virtualFile);
      if (manifest != null)       phaseContext.putAttachment(Attachments.MANIFEST,manifest);
    }
 catch (    IOException ex) {
      throw new DeploymentUnitProcessingException("Cannot read manifest from: " + virtualFile);
    }
  }
  if (BundleInfo.isValidateBundleManifest(manifest)) {
    try {
      String location=InstallBundleInitiatorService.getLocation(serviceRegistry,deploymentUnit.getName());
      info=BundleInfo.createBundleInfo(AbstractVFS.adapt(virtualFile),location);
      BundleInfoAttachment.attachBundleInfo(deploymentUnit,info);
    }
 catch (    BundleException ex) {
      throw new DeploymentUnitProcessingException("Cannot create bundle deployment from: " + virtualFile);
    }
  }
}
