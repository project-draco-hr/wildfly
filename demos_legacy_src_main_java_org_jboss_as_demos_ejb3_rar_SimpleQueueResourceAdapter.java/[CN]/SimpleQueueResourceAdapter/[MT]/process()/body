{
  if (endpointFactories.size() == 0)   return;
  MessageEndpoint endpoint=endpointFactories.get(0).createEndpoint(null);
  try {
    while (!queue.isEmpty()) {
      try {
        String message=queue.poll(30,SECONDS);
        try {
          ((PostmanPat)endpoint).deliver(message);
        }
 catch (        Throwable t) {
          log.error("Failed to deliver message " + message,t);
        }
      }
 catch (      InterruptedException e) {
        return;
      }
    }
  }
  finally {
    endpoint.release();
  }
}
