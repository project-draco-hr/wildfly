{
  Module module=new Module.Builder("module-test").miscFile(new ResourceItem("resource-test",("module resource").getBytes())).build();
  File moduleDir=module.writeToDisk(new File(MODULES_PATH));
  byte[] targetHash=HashUtils.hashFile(moduleDir);
  targetHash=applyCP("cp0",targetHash);
  targetHash=applyCP("cp1",targetHash);
  targetHash=applyOneOff("oneoff1",targetHash);
  targetHash=applyOneOff("oneoff2",targetHash);
  controller.start(CONTAINER);
  try {
    client=createClient();
    assertPatched(client,new String[]{"oneoff2","oneoff1","cp1","cp0"},new boolean[]{false,false,true,true});
    ageoutHistory(client);
    assertPatched(client,new String[]{"oneoff2","oneoff1","cp1"},new boolean[]{false,false,true});
  }
  finally {
    controller.stop(CONTAINER);
  }
}
