{
  final PatchContentProvider contentProvider=PatchContentProvider.DefaultContentProvider.create(workDir);
  final File patchXml=new File(workDir,PatchXml.PATCH_XML);
  final InputStream patchIS=new FileInputStream(patchXml);
  final PatchMetadataResolver patchResolver;
  try {
    patchResolver=PatchXml.parse(patchIS);
    patchIS.close();
  }
  finally {
    safeClose(patchIS);
  }
  final InstallationManager.InstallationModification modification=manager.modifyInstallation(callback);
  try {
    return runner.applyPatch(patchResolver,contentProvider,contentPolicy,modification);
  }
 catch (  Exception e) {
    modification.cancel();
    throw rethrowException(e);
  }
}
