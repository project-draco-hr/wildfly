{
  final PatchContentProvider contentProvider=PatchContentProvider.DefaultContentProvider.create(workDir);
  final File patchXml=new File(workDir,PatchXml.PATCH_XML);
  final InputStream patchIS=new FileInputStream(patchXml);
  final Patch patch;
  try {
    patch=PatchXml.parse(patchIS);
    patchIS.close();
  }
  finally {
    safeClose(patchIS);
  }
  final InstallationManager.InstallationModification modification=manager.modifyInstallation(runner);
  try {
    return runner.applyPatch(patch,contentProvider,contentPolicy,modification);
  }
 catch (  Exception e) {
    modification.cancel();
    throw rethrowException(e);
  }
}
