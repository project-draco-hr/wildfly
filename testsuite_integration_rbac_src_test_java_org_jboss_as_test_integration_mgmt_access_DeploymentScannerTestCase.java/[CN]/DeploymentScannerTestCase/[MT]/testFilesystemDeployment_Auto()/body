{
  final JavaArchive archive=ShrinkWrap.create(JavaArchive.class,"test-deployment.sar").addPackage(Simple.class.getPackage()).addAsManifestResource(Simple.class.getPackage(),"jboss-service.xml","jboss-service.xml");
  final File dir=new File("target/archives");
  dir.mkdirs();
  final File file=new File(dir,"test-deployment.sar");
  archive.as(ZipExporter.class).exportTo(file,true);
  ModelControllerClient client=managementClient.getControllerClient();
  final File target=new File(deployDir,"test-deployment.sar");
  final File deployed=new File(deployDir,"test-deployment.sar.deployed");
  Assert.assertFalse(target.exists());
  testDeployments(new DeploymentExecutor(){
    @Override public void initialDeploy() throws IOException {
      final InputStream in=new BufferedInputStream(new FileInputStream(file));
      try {
        final OutputStream out=new BufferedOutputStream(new FileOutputStream(target));
        try {
          int i=in.read();
          while (i != -1) {
            out.write(i);
            i=in.read();
          }
        }
  finally {
          StreamUtils.safeClose(out);
        }
      }
  finally {
        StreamUtils.safeClose(in);
      }
      Assert.assertTrue(file.exists());
      long start=System.currentTimeMillis();
      while (!deployed.exists() && System.currentTimeMillis() - start < 10000) {
        try {
          Thread.sleep(50);
        }
 catch (        InterruptedException e) {
          throw new RuntimeException(e);
        }
      }
      if (!deployed.exists()) {
        Assert.fail("deploy step did not complete in a reasonably timely fashion");
      }
    }
    @Override public void undeploy(){
      final File isdeploying=new File(deployDir,"test-deployment.sar.isdeploying");
      for (int i=0; i < 500; i++) {
        if (!isdeploying.exists() && deployed.exists()) {
          break;
        }
        try {
          Thread.sleep(10);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          break;
        }
      }
      if (!deployed.exists()) {
        Assert.fail("undeploy step did not complete in a reasonably timely fashion");
      }
      target.delete();
    }
  }
);
}
