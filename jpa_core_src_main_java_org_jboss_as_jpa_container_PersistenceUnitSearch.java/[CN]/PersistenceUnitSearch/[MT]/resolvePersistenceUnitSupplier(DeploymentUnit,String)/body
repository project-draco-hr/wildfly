{
  if (traceEnabled) {
    ROOT_LOGGER.tracef("pu search for name '%s' inside of %s",persistenceUnitName,deploymentUnit.getName());
  }
  int scopeSeparatorCharacter=(persistenceUnitName == null ? -1 : persistenceUnitName.indexOf('#'));
  if (scopeSeparatorCharacter != -1) {
    final String path=persistenceUnitName.substring(0,scopeSeparatorCharacter);
    final String name=persistenceUnitName.substring(scopeSeparatorCharacter + 1);
    PersistenceUnitMetadata pu=getPersistenceUnit(deploymentUnit,path,name);
    if (traceEnabled) {
      ROOT_LOGGER.tracef("pu search found %s",pu.getScopedPersistenceUnitName());
    }
    return pu;
  }
 else {
    if (persistenceUnitName == null) {
      PersistenceUnitCount counter=getTopLevel(deploymentUnit).getAttachment(PersistenceUnitCount.PERSISTENCE_UNIT_COUNT);
      if (counter.get() > 1) {
        throw MESSAGES.noPUnitNameSpecifiedAndMultiplePersistenceUnits(counter.get(),getTopLevel(deploymentUnit));
      }
      ROOT_LOGGER.tracef("pu searching with empty unit name, application %s has %d persistence unit definitions",getTopLevel(deploymentUnit).getName(),counter.get());
    }
    PersistenceUnitMetadata name=findPersistenceUnitSupplier(deploymentUnit,persistenceUnitName);
    if (traceEnabled) {
      if (name != null) {
        ROOT_LOGGER.tracef("pu search found %s",name.getScopedPersistenceUnitName());
      }
    }
    return name;
  }
}
