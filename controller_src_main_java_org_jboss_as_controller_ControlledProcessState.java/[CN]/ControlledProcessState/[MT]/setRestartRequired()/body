{
  AtomicStampedReference<State> stateRef=state;
  int newStamp=stamp.incrementAndGet();
  int[] receiver=new int[1];
  for (; ; ) {
    State was=stateRef.get(receiver);
    if (was == State.STARTING || was == State.STOPPING) {
      break;
    }
synchronized (service) {
      if (stateRef.compareAndSet(was,State.RESTART_REQUIRED,receiver[0],newStamp)) {
        restartRequiredFlag=true;
        service.stateChanged(State.RESTART_REQUIRED);
        break;
      }
    }
  }
  return Integer.valueOf(newStamp);
}
