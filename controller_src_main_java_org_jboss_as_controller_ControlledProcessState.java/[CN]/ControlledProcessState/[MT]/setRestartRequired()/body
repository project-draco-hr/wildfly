{
  AtomicStampedReference<State> stateRef=state;
  int newStamp=stamp.incrementAndGet();
  int[] receiver=new int[1];
  for (; ; ) {
    State was=stateRef.get(receiver);
    if (was == State.STARTING || was == State.STOPPING) {
      break;
    }
    if (stateRef.compareAndSet(was,State.RESTART_REQUIRED,receiver[0],newStamp)) {
      break;
    }
  }
  return Integer.valueOf(newStamp);
}
