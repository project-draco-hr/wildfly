{
  long deadline=unit.toMillis(timeout) + System.currentTimeMillis();
  lock.lock();
  try {
    while (!done) {
      long remaining=deadline - System.currentTimeMillis();
      if (remaining <= 0) {
        throw new TimeoutException();
      }
      hasValue.await(remaining,TimeUnit.MILLISECONDS);
    }
    return value;
  }
  finally {
    lock.unlock();
  }
}
