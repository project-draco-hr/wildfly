{
  final ContextSelector<EJBClientContext> previousSelector=EJBClientContextSelector.setup("cluster/ejb3/stateful/failover/sfsb-failover-jboss-ejb-client.properties");
  boolean container1Stopped=false;
  boolean container2Stopped=false;
  try {
    final RemoteCounter remoteCounter=context.lookupStateful(CounterBean.class,RemoteCounter.class);
    final DestructionCounterRemote destructionCounter=context.lookupSingleton(DestructionCounterSingleton.class,DestructionCounterRemote.class);
    final int NUM_TIMES=25;
    for (int i=0; i < NUM_TIMES; i++) {
      final CounterResult result=remoteCounter.increment();
      logger.info("Counter incremented to " + result.getCount() + " on node "+ result.getNodeName());
    }
    final CounterResult result=remoteCounter.getCount();
    Assert.assertNotNull("Result from remote stateful counter was null",result);
    Assert.assertEquals("Unexpected count from remote counter",NUM_TIMES,result.getCount());
    Assert.assertEquals("Nothing should have been destroyed yet",0,destructionCounter.getCDIDestructionCount());
    Assert.assertEquals("Nothing should have been destroyed yet",0,destructionCounter.getSFSBDestructionCount());
    final int totalCountBeforeShuttingDownANode=result.getCount();
    final String previousInvocationNodeName=result.getNodeName();
    if (previousInvocationNodeName.equals(NODE_1)) {
      undeploy(DEPLOYMENT_1);
      if (!undeployOnly) {
        stop(CONTAINER_1);
      }
      container1Stopped=true;
    }
 else {
      undeploy(DEPLOYMENT_2);
      if (!undeployOnly) {
        stop(CONTAINER_2);
      }
      container2Stopped=true;
    }
    CounterResult resultAfterShuttingDownANode=remoteCounter.increment();
    Assert.assertNotNull("Result from remote stateful counter, after shutting down a node was null",resultAfterShuttingDownANode);
    Assert.assertEquals("Unexpected count from remote counter, after shutting down a node",totalCountBeforeShuttingDownANode + 1,resultAfterShuttingDownANode.getCount());
    Assert.assertFalse("Result was received from an unexpected node, after shutting down a node",previousInvocationNodeName.equals(resultAfterShuttingDownANode.getNodeName()));
    final int countBeforeDecrementing=resultAfterShuttingDownANode.getCount();
    final String aliveNode=resultAfterShuttingDownANode.getNodeName();
    for (int i=NUM_TIMES; i > 0; i--) {
      resultAfterShuttingDownANode=remoteCounter.decrement();
      Assert.assertNotNull("Result from remote stateful counter, after shutting down a node was null",resultAfterShuttingDownANode);
      Assert.assertEquals("Result was received from an unexpected node, after shutting down a node",aliveNode,resultAfterShuttingDownANode.getNodeName());
      logger.info("Counter decremented to " + resultAfterShuttingDownANode.getCount() + " on node "+ resultAfterShuttingDownANode.getNodeName());
    }
    final CounterResult finalResult=remoteCounter.getCount();
    Assert.assertNotNull("Result from remote stateful counter, after shutting down a node was null",finalResult);
    final int finalCount=finalResult.getCount();
    final String finalNodeName=finalResult.getNodeName();
    Assert.assertEquals("Result was received from an unexpected node, after shutting down a node",aliveNode,finalNodeName);
    Assert.assertEquals("Unexpected count from remote counter, after shutting down a node",countBeforeDecrementing - NUM_TIMES,finalCount);
    Assert.assertEquals("Nothing should have been destroyed yet",0,destructionCounter.getCDIDestructionCount());
    Assert.assertEquals("Nothing should have been destroyed yet",0,destructionCounter.getSFSBDestructionCount());
    remoteCounter.remove();
    Assert.assertEquals("CDI bean was not destroyed",1,destructionCounter.getCDIDestructionCount());
    Assert.assertEquals("SFSB was not destroyed",1,destructionCounter.getSFSBDestructionCount());
  }
  finally {
    if (previousSelector != null) {
      EJBClientContext.setSelector(previousSelector);
    }
    if (container1Stopped) {
      if (undeployOnly) {
        undeploy(DEPLOYMENT_2);
        deploy(DEPLOYMENTS);
      }
 else {
        undeploy(DEPLOYMENT_2);
        start(CONTAINER_1);
        deploy(DEPLOYMENTS);
      }
    }
    if (container2Stopped) {
      if (undeployOnly) {
        undeploy(DEPLOYMENT_1);
        deploy(DEPLOYMENTS);
      }
 else {
        undeploy(DEPLOYMENT_1);
        start(CONTAINER_2);
        deploy(DEPLOYMENTS);
      }
    }
  }
}
