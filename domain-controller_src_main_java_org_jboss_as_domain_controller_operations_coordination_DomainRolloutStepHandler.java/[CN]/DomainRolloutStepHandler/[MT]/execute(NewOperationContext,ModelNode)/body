{
  if (context.hasFailureDescription()) {
    context.setRollbackOnly();
    context.completeStep();
    return;
  }
  boolean pushToServers=!domainOperationContext.hasHostLevelFailures();
  if (pushToServers) {
    ModelNode ourResult=domainOperationContext.getCoordinatorResult();
    if (ourResult.has(FAILURE_DESCRIPTION)) {
      System.out.println("coordinator failed: " + ourResult);
      pushToServers=false;
      domainOperationContext.setCompleteRollback(true);
    }
 else {
      System.out.println("coordinator succeeded: " + ourResult);
      for (      ModelNode hostResult : domainOperationContext.getHostControllerResults().values()) {
        if (hostResult.has(FAILURE_DESCRIPTION)) {
          System.out.println("host failed: " + hostResult);
          pushToServers=false;
          domainOperationContext.setCompleteRollback(true);
          break;
        }
      }
    }
  }
  if (pushToServers) {
    domainOperationContext.setCompleteRollback(false);
    final Map<ServerIdentity,ProxyTask> tasks=new HashMap<ServerIdentity,ProxyTask>();
    final Map<ServerIdentity,Future<ModelNode>> futures=new HashMap<ServerIdentity,Future<ModelNode>>();
    try {
      pushToServers(context,tasks,futures);
      context.completeStep();
    }
  finally {
      boolean completeRollback=domainOperationContext.isCompleteRollback();
      for (      Map.Entry<ServerIdentity,ProxyTask> entry : tasks.entrySet()) {
        boolean rollback=completeRollback || domainOperationContext.isServerGroupRollback(entry.getKey().getServerGroupName());
        entry.getValue().finalizeTransaction(!rollback);
      }
      boolean interrupted=false;
      try {
        for (        Map.Entry<ServerIdentity,Future<ModelNode>> entry : futures.entrySet()) {
          Future<ModelNode> future=entry.getValue();
          try {
            ModelNode finalResult=future.isCancelled() ? getCancelledResult() : future.get();
            domainOperationContext.addServerResult(entry.getKey(),finalResult);
          }
 catch (          InterruptedException e) {
            interrupted=true;
            log.warnf("Interrupted awaiting final response from server %s on host %s",entry.getKey().getServerName(),entry.getKey().getHostName());
          }
catch (          ExecutionException e) {
            log.warnf(e.getCause(),"Caught exception awaiting final response from server %s on host %s",entry.getKey().getServerName(),entry.getKey().getHostName());
          }
        }
      }
  finally {
        if (interrupted) {
          Thread.currentThread().interrupt();
        }
      }
    }
  }
 else {
    reportHostFailures(context,operation);
    context.completeStep();
  }
}
