{
  if (rolloutPlan == null || !rolloutPlan.isDefined()) {
    rolloutPlan=getDefaultRolloutPlan(opsByGroup);
  }
 else {
    Set<String> found=new HashSet<String>();
    if (rolloutPlan.hasDefined(IN_SERIES)) {
      for (      ModelNode series : rolloutPlan.get(IN_SERIES).asList()) {
        if (series.hasDefined(CONCURRENT_GROUPS)) {
          for (          Property prop : series.get(CONCURRENT_GROUPS).asPropertyList()) {
            validateServerGroupPlan(found,prop);
          }
        }
 else         if (series.hasDefined(SERVER_GROUP)) {
          Property prop=series.get(SERVER_GROUP).asProperty();
          validateServerGroupPlan(found,prop);
        }
 else {
          throw new OperationFailedException(new ModelNode().set(String.format("Invalid rollout plan. %s is not a valid child of node %s",series,IN_SERIES)));
        }
      }
    }
    Set<String> groups=new HashSet<String>(opsByGroup.keySet());
    groups.removeAll(found);
    if (!groups.isEmpty()) {
      throw new OperationFailedException(new ModelNode().set(String.format("Invalid rollout plan. Plan operations affect server groups %s that are not reflected in the rollout plan",groups)));
    }
  }
  return rolloutPlan;
}
