{
  final List<DeploymentUnit> subDeployments=getSubDeployments(deploymentUnit);
  final String loggingProfile=findLoggingProfile(root);
  if (loggingProfile != null) {
    final LoggingProfileContextSelector loggingProfileContext=LoggingProfileContextSelector.getInstance();
    if (loggingProfileContext.exists(loggingProfile)) {
      final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
      final LogContext logContext=loggingProfileContext.get(loggingProfile);
      LoggingLogger.ROOT_LOGGER.tracef("Registering log context '%s' on '%s' for profile '%s'",logContext,root,loggingProfile);
      registerLogContext(deploymentUnit,module,logContext);
      for (      DeploymentUnit subDeployment : subDeployments) {
        if (subDeployment.hasAttachment(Attachments.MODULE)) {
          if (subDeployment.hasAttachment(Attachments.DEPLOYMENT_ROOT)) {
            processDeployment(phaseContext,subDeployment,subDeployment.getAttachment(Attachments.DEPLOYMENT_ROOT));
          }
          if (!hasRegisteredLogContext(subDeployment)) {
            final Module subDeploymentModule=subDeployment.getAttachment(Attachments.MODULE);
            LoggingLogger.ROOT_LOGGER.tracef("Registering log context '%s' on '%s' for profile '%s'",logContext,subDeployment.getAttachment(Attachments.DEPLOYMENT_ROOT),loggingProfile);
            registerLogContext(subDeployment,subDeploymentModule,logContext);
          }
        }
      }
    }
 else {
      LoggingLogger.ROOT_LOGGER.loggingProfileNotFound(loggingProfile,root);
    }
  }
 else {
    for (    DeploymentUnit subDeployment : subDeployments) {
      if (subDeployment.hasAttachment(Attachments.MODULE) && subDeployment.hasAttachment(Attachments.DEPLOYMENT_ROOT)) {
        processDeployment(phaseContext,subDeployment,subDeployment.getAttachment(Attachments.DEPLOYMENT_ROOT));
      }
    }
  }
}
