{
  final PathAddress consoleAddress=createConsoleHandlerAddress("CONSOLE");
  final ModelNode consoleHandler=legacyModel.get(consoleAddress.getElement(0).getKey(),consoleAddress.getElement(0).getValue(),consoleAddress.getElement(1).getKey(),consoleAddress.getElement(1).getValue());
  String formatPattern=consoleHandler.get(CommonAttributes.FORMATTER.getName()).asString();
  Assert.assertFalse("Pattern (" + formatPattern + ") contains a color attribute not supported in legacy models.",COLOR_PATTERN.matcher(formatPattern).find());
  ModelNode op=SubsystemOperations.createWriteAttributeOperation(consoleAddress.toModelNode(),CommonAttributes.FORMATTER,"%K{level}" + formatPattern);
  executeTransformOperation(mainServices,modelVersion,op);
  validateLegacyFormatter(mainServices,modelVersion,consoleAddress.toModelNode());
  op=SubsystemOperations.createOperation(AbstractHandlerDefinition.UPDATE_OPERATION_NAME,consoleAddress.toModelNode());
  op.get(CommonAttributes.FORMATTER.getName()).set("%K{level}" + formatPattern);
  executeTransformOperation(mainServices,modelVersion,op);
  validateLegacyFormatter(mainServices,modelVersion,consoleAddress.toModelNode());
  final String filterExpression="not(match(\"ARJUNA\\\\d\"))";
  op=SubsystemOperations.createWriteAttributeOperation(consoleAddress.toModelNode(),CommonAttributes.FILTER_SPEC,filterExpression);
  executeTransformOperation(mainServices,modelVersion,op);
  validateLegacyFilter(mainServices,modelVersion,consoleAddress.toModelNode(),filterExpression);
  op=SubsystemOperations.createOperation(AbstractHandlerDefinition.UPDATE_OPERATION_NAME,consoleAddress.toModelNode());
  op.get(CommonAttributes.FILTER_SPEC.getName()).set(filterExpression);
  executeTransformOperation(mainServices,modelVersion,op);
  validateLegacyFilter(mainServices,modelVersion,consoleAddress.toModelNode(),filterExpression);
  final PathAddress loggerAddress=createLoggerAddress("org.jboss.as.logging");
  op=SubsystemOperations.createReadResourceOperation(loggerAddress.toModelNode());
  if (!SubsystemOperations.isSuccessfulOutcome(mainServices.executeOperation(op))) {
    op=SubsystemOperations.createAddOperation(loggerAddress.toModelNode());
    executeTransformOperation(mainServices,modelVersion,op);
  }
  op=SubsystemOperations.createWriteAttributeOperation(loggerAddress.toModelNode(),CommonAttributes.FILTER_SPEC,filterExpression);
  executeTransformOperation(mainServices,modelVersion,op);
  validateLegacyFilter(mainServices,modelVersion,loggerAddress.toModelNode(),filterExpression);
  final PathAddress handlerAddress=createFileHandlerAddress("fh");
  op=SubsystemOperations.createAddOperation(handlerAddress.toModelNode());
  op.get(CommonAttributes.FILE.getName(),PathResourceDefinition.RELATIVE_TO.getName()).set("jboss.server.log.dir");
  op.get(CommonAttributes.FILE.getName(),PathResourceDefinition.PATH.getName()).set("fh.log");
  op.get(CommonAttributes.AUTOFLUSH.getName()).set(true);
  executeTransformOperation(mainServices,modelVersion,op);
  final PathAddress rootLoggerAddress=createRootLoggerAddress();
  final String handlerName=handlerAddress.getLastElement().getValue();
  addRemoveHandler(mainServices,modelVersion,rootLoggerAddress.toModelNode(),CommonAttributes.HANDLERS,handlerName);
  addRemoveHandler(mainServices,modelVersion,loggerAddress.toModelNode(),CommonAttributes.HANDLERS,handlerName);
  final PathAddress asyncHandlerAddress=createAsyncHandlerAddress("async");
  addRemoveHandler(mainServices,modelVersion,asyncHandlerAddress.toModelNode(),AsyncHandlerResourceDefinition.SUBHANDLERS,handlerName);
  final CompositeOperationBuilder compositeOperationBuilder=CompositeOperationBuilder.create();
  final ModelNode compositeLoggerAddress=createLoggerAddress("compositeLogger").toModelNode();
  compositeOperationBuilder.addStep(SubsystemOperations.createAddOperation(compositeLoggerAddress));
  compositeOperationBuilder.addStep(SubsystemOperations.createRemoveOperation(handlerAddress.toModelNode()));
  op=SubsystemOperations.createAddOperation(handlerAddress.toModelNode());
  op.get(CommonAttributes.FILE.getName(),PathResourceDefinition.RELATIVE_TO.getName()).set("jboss.server.log.dir");
  op.get(CommonAttributes.FILE.getName(),PathResourceDefinition.PATH.getName()).set("fh.log");
  op.get(CommonAttributes.AUTOFLUSH.getName()).set(true);
  op.get(CommonAttributes.ENABLED.getName()).set(true);
  compositeOperationBuilder.addStep(op);
  compositeOperationBuilder.addStep(SubsystemOperations.createAddOperation(createAddress(CommonAttributes.LOGGING_PROFILE,"composite-profile").toModelNode()));
  final ModelNode composite=compositeOperationBuilder.build().getOperation();
  final TransformedOperation transformedOp=mainServices.transformOperation(modelVersion,composite);
  op=transformedOp.getTransformedOperation();
  final List<ModelNode> steps=op.get(ClientConstants.STEPS).asList();
  Assert.assertEquals("Logging profile step should not have been removed",4,steps.size());
  ModelNode stepOp=steps.get(0);
  Assert.assertTrue("category attribute should have been added",stepOp.hasDefined(LoggerResourceDefinition.CATEGORY.getName()));
  stepOp=steps.get(2);
  Assert.assertFalse("enabled attribute should have been removed",stepOp.hasDefined(CommonAttributes.ENABLED.getName()));
  ModelTestUtils.checkFailed(mainServices.executeOperation(modelVersion,transformedOp));
  final ModelNode success=new ModelNode();
  success.get(OUTCOME).set(SUCCESS);
  Assert.assertTrue(transformedOp.rejectOperation(success));
  final List<ModelNode> newSteps=new ArrayList<ModelNode>(steps);
  newSteps.remove(3);
  final ModelNode newComposite=composite.clone();
  newComposite.get(STEPS).set(newSteps);
  final TransformedOperation newTransformedOperation=mainServices.transformOperation(modelVersion,newComposite);
  Assert.assertFalse(newTransformedOperation.rejectOperation(success));
}
