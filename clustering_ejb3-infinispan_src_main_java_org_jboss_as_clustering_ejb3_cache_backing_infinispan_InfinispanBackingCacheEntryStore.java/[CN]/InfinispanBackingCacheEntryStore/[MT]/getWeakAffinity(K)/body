{
  String local=this.registry.getLocalEntry().getKey();
  if (!this.hasAffinity(key)) {
    Set<String> nodes=this.registry.locate(key).keySet();
    if (!nodes.contains(local)) {
      return new NodeAffinity(new ArrayList<String>(nodes).get(this.random.nextInt(nodes.size())));
    }
  }
  return new NodeAffinity(local);
}
