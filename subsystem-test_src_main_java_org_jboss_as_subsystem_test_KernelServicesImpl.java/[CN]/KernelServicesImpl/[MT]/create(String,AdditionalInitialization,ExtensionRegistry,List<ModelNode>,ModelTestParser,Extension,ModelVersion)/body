{
  ControllerInitializer controllerInitializer=additionalInit.createControllerInitializer();
  PathManagerService pathManager=new PathManagerService(){
  }
;
  controllerInitializer.setPathManger(pathManager);
  additionalInit.setupController(controllerInitializer);
  ServiceContainer container=ServiceContainer.Factory.create("test" + counter.incrementAndGet());
  ServiceTarget target=container.subTarget();
  List<ModelNode> extraOps=controllerInitializer.initializeBootOperations();
  List<ModelNode> allOps=new ArrayList<ModelNode>();
  if (extraOps != null) {
    allOps.addAll(extraOps);
  }
  allOps.addAll(bootOperations);
  StringConfigurationPersister persister=new StringConfigurationPersister(allOps,testParser);
  controllerExtensionRegistry.setWriterRegistry(persister);
  controllerExtensionRegistry.setPathManager(pathManager);
  ModelTestModelControllerService svc=TestModelControllerService.create(mainExtension,controllerInitializer,additionalInit,controllerExtensionRegistry,persister,additionalInit.isValidateOperations());
  ServiceBuilder<ModelController> builder=target.addService(Services.JBOSS_SERVER_CONTROLLER,svc);
  builder.addDependency(PathManagerService.SERVICE_NAME);
  builder.install();
  target.addService(PathManagerService.SERVICE_NAME,pathManager).install();
  additionalInit.addExtraServices(target);
  svc.waitForSetup();
  ModelController controller=svc.getValue();
  KernelServicesImpl kernelServices=new KernelServicesImpl(container,controller,persister,svc.getRootRegistration(),new OperationValidator(svc.getRootRegistration()),mainSubsystemName,controllerExtensionRegistry,legacyModelVersion,svc.isSuccessfulBoot(),svc.getBootError());
  return kernelServices;
}
