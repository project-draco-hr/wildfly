{
  final int cmd=readUnsignedByte(dataStream);
  if (cmd != Protocol.AUTH) {
    SERVER_LOGGER.receivedUnknownGreetingCode(Integer.valueOf(cmd),connection.getPeerAddress());
    connection.close();
    return;
  }
  final int version=StreamUtils.readUnsignedByte(dataStream);
  if (version < 1) {
    SERVER_LOGGER.receivedInvalidVersion(connection.getPeerAddress());
    connection.close();
    return;
  }
  final byte[] authCode=new byte[16];
  StreamUtils.readFully(dataStream,authCode);
  final ManagedProcess process=processController.getServerByAuthCode(authCode);
  if (process == null) {
    SERVER_LOGGER.receivedUnknownCredentials(connection.getPeerAddress());
    StreamUtils.safeClose(connection);
    return;
  }
  SERVER_LOGGER.tracef("Received authentic connection from %s",connection.getPeerAddress());
  connection.setMessageHandler(new ConnectedMessageHandler(processController,process.isPrivileged()));
  processController.addManagedConnection(connection);
  dataStream.close();
  process.resetRespawnCount();
}
