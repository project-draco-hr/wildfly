{
  final ModuleConfig moduleConfig=context.getAttachment(ModuleConfig.ATTACHMENT_KEY);
  if (moduleConfig == null)   return;
  final DeploymentModuleLoader deploymentModuleLoader=DeploymentModuleLoaderSelector.CURRENT_MODULE_LOADER.get();
  if (deploymentModuleLoader == null)   return;
  final ModuleSpec.Builder specBuilder=ModuleSpec.build(moduleConfig.getIdentifier());
  for (  ModuleConfig.ResourceRoot resource : moduleConfig.getResources()) {
    try {
      specBuilder.addRoot(resource.getRootName(),new VFSResourceLoader(specBuilder.getIdentifier(),resource.getRoot()));
    }
 catch (    IOException e) {
      throw new DeploymentUnitProcessingException("Failed to create VFSResourceLoader for root [" + resource.getRootName() + "]",e,null);
    }
  }
  final ModuleConfig.Dependency[] dependencies=moduleConfig.getDependencies();
  for (  ModuleConfig.Dependency dependency : dependencies) {
    specBuilder.addDependency(dependency.getIdentifier()).setExport(dependency.isExport()).setOptional(dependency.isOptional());
  }
  final ModuleSpec moduleSpec=specBuilder.create();
  deploymentModuleLoader.addModuleSpec(moduleSpec);
}
