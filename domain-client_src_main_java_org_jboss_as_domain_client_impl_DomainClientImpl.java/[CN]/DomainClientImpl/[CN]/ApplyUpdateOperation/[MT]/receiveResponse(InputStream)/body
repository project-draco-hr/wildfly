{
  try {
    final Unmarshaller unmarshaller=getUnmarshaller();
    unmarshaller.start(createByteInput(input));
    expectHeader(unmarshaller,DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT);
    byte resultCode=unmarshaller.readByte();
    if (resultCode == (byte)DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION) {
      final UpdateFailedException updateFailedException=unmarshaller.readObject(UpdateFailedException.class);
      return new DomainUpdateApplierResponse(updateFailedException);
    }
 else     if (resultCode == (byte)DomainClientProtocol.APPLY_UPDATE_RESULT_DOMAIN_MODEL_SUCCESS) {
      Map<String,UpdateFailedException> hostFailures=null;
      List<ServerIdentity> servers=null;
      expectHeader(unmarshaller,DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_HOST_FAILURE_COUNT);
      int hostFailureCount=unmarshaller.readInt();
      if (hostFailureCount > 0) {
        hostFailures=new HashMap<String,UpdateFailedException>();
        for (int j=0; j < hostFailureCount; j++) {
          expectHeader(unmarshaller,DomainClientProtocol.PARAM_HOST_NAME);
          final String hostName=unmarshaller.readUTF();
          expectHeader(unmarshaller,DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
          final UpdateFailedException updateFailedException=unmarshaller.readObject(UpdateFailedException.class);
          hostFailures.put(hostName,updateFailedException);
        }
      }
      expectHeader(unmarshaller,DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_SERVER_COUNT);
      int serverResultCount=unmarshaller.readInt();
      if (serverResultCount > 0) {
        servers=new ArrayList<ServerIdentity>();
        for (int j=0; j < hostFailureCount; j++) {
          expectHeader(unmarshaller,DomainClientProtocol.PARAM_HOST_NAME);
          final String hostName=unmarshaller.readUTF();
          expectHeader(unmarshaller,DomainClientProtocol.PARAM_SERVER_GROUP_NAME);
          final String serverGroupName=unmarshaller.readUTF();
          expectHeader(unmarshaller,DomainClientProtocol.PARAM_SERVER_NAME);
          final String serverName=unmarshaller.readUTF();
          ServerIdentity identity=new ServerIdentity(hostName,serverGroupName,serverName);
          servers.add(identity);
        }
      }
      unmarshaller.finish();
      return new DomainUpdateApplierResponse(hostFailures,servers);
    }
 else {
      throw new IOException("Invalid byte token.  Expecting '" + DomainClientProtocol.APPLY_UPDATE_RESULT_DOMAIN_MODEL_SUCCESS + "' or '"+ DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION+ "' received '"+ resultCode+ "'");
    }
  }
 catch (  Exception e) {
    throw new RuntimeException("Failed to read update responses",e);
  }
}
