{
  final InstalledConfiguration conf=createInstalledConfig(image);
  final ProcessedLayers processedLayers=process(conf,moduleRoots,bundleRoots);
  final InstalledConfiguration config=processedLayers.getConf();
  final List<Layer> layers=new ArrayList<Layer>();
  final Collection<AddOn> addOns=new ArrayList<AddOn>();
  final BaseLayer base=createPatchableTarget(BASE,processedLayers.getBase(),config.getBaseMetadataDir());
  for (  final LayerPathConfig layer : processedLayers.getLayers().values()) {
    final String name=layer.name;
    layers.add(createPatchableTarget(name,layer,config.getLayerMetadataDir(name)));
  }
  for (  final LayerPathConfig addOn : processedLayers.getAddOns().values()) {
    final String name=addOn.name;
    layers.add(createPatchableTarget(name,addOn,config.getAddOnMetadataDir(name)));
  }
  return new InstalledIdentity(){
    @Override public Collection<AddOn> getAddOns(){
      return addOns;
    }
    @Override public List<Layer> getLayers(){
      return layers;
    }
    @Override public BaseLayer getBaseLayer(){
      return base;
    }
  }
;
}
