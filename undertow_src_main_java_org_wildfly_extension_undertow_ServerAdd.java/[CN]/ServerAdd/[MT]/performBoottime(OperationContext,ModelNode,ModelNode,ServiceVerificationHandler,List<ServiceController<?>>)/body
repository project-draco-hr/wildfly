{
  final PathAddress address=PathAddress.pathAddress(operation.get(OP_ADDR));
  final PathAddress parentAddress=address.subAddress(0,address.size() - 1);
  final ModelNode subsystemModel=Resource.Tools.readModel(context.readResourceFromRoot(parentAddress));
  final String name=address.getLastElement().getValue();
  final String defaultHost=ServerDefinition.DEFAULT_HOST.resolveModelAttribute(context,model).asString();
  final String servletContainer=ServerDefinition.SERVLET_CONTAINER.resolveModelAttribute(context,model).asString();
  final String defaultServerName=UndertowRootDefinition.DEFAULT_SERVER.resolveModelAttribute(context,subsystemModel).asString();
  final ServiceName serverName=UndertowService.SERVER.append(name);
  final Server service=new Server(name,defaultHost);
  final ServiceBuilder<Server> builder=context.getServiceTarget().addService(serverName,service).addDependency(UndertowService.SERVLET_CONTAINER.append(servletContainer),ServletContainerService.class,service.getServletContainerInjector()).addDependency(UndertowService.UNDERTOW,UndertowService.class,service.getUndertowServiceInjector());
  builder.setInitialMode(ServiceController.Mode.ACTIVE);
  builder.addListener(verificationHandler);
  boolean isDefaultServer=name.equals(defaultServerName);
  if (isDefaultServer) {
    builder.addAliases(UndertowService.DEFAULT_SERVER);
    WebServerService commonWebServer=new WebServerService();
    final ServiceBuilder<WebServerService> commonServerBuilder=context.getServiceTarget().addService(CommonWebServer.SERVICE_NAME,commonWebServer).addDependency(serverName,Server.class,commonWebServer.getServerInjectedValue()).setInitialMode(ServiceController.Mode.PASSIVE);
    addCommonHostListenerDeps(context,commonServerBuilder,UndertowExtension.HTTP_LISTENER_PATH);
    addCommonHostListenerDeps(context,commonServerBuilder,UndertowExtension.AJP_LISTENER_PATH);
    addCommonHostListenerDeps(context,commonServerBuilder,UndertowExtension.HTTPS_LISTENER_PATH);
    final ServiceController<WebServerService> commonServerController=commonServerBuilder.install();
    if (verificationHandler != null) {
      commonServerController.addListener(verificationHandler);
    }
    if (newControllers != null) {
      newControllers.add(commonServerController);
    }
  }
  final ServiceController<Server> serviceController=builder.install();
  if (newControllers != null) {
    newControllers.add(serviceController);
  }
}
