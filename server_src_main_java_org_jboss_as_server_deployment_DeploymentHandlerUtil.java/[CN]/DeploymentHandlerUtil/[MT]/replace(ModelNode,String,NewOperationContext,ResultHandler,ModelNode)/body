{
  if (context instanceof NewRuntimeOperationContext) {
    NewRuntimeOperationContext updateContext=(NewRuntimeOperationContext)context;
    final ServiceController<?> controller=updateContext.getServiceRegistry().getService(Services.JBOSS_DEPLOYMENT_UNIT.append(toReplace));
    if (controller != null) {
      controller.addListener(new AbstractServiceListener<Object>(){
        @Override public void serviceRemoved(        ServiceController<? extends Object> serviceController){
          deploy(deploymentModel,context,resultHandler,compensatingOp);
        }
      }
);
      controller.setMode(ServiceController.Mode.REMOVE);
    }
 else {
      deploy(deploymentModel,context,resultHandler,compensatingOp);
    }
  }
 else {
    resultHandler.handleResultComplete(compensatingOp);
  }
}
