{
  final CountDownLatch latch=new CountDownLatch(serviceNames.length);
  final AtomicInteger ticket=new AtomicInteger(serviceNames.length);
  for (  final ServiceName serviceName : serviceNames) {
    final ServiceController<?> controller=serviceRegistry.getService(serviceName);
    if (controller != null) {
      controller.addListener(new AbstractServiceListener<Object>(){
        @Override public void serviceRemoved(        ServiceController<? extends Object> serviceController){
          controller.removeListener(this);
          latch.countDown();
          if (ticket.decrementAndGet() == 0)           action.run();
        }
      }
);
    }
 else {
      latch.countDown();
      if (ticket.decrementAndGet() == 0)       action.run();
    }
  }
}
