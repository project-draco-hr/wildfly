{
  if (operationContext.getRuntimeContext() != null) {
    final ServiceController<?> controller=operationContext.getRuntimeContext().getServiceRegistry().getService(Services.JBOSS_DEPLOYMENT_UNIT.append(toReplace));
    if (controller != null) {
      controller.addListener(new AbstractServiceListener<Object>(){
        public void listenerAdded(        ServiceController<? extends Object> serviceController){
          controller.setMode(ServiceController.Mode.REMOVE);
        }
        public void serviceRemoved(        ServiceController<? extends Object> serviceController){
          try {
            deploy(deploymentModel,operationContext,resultHandler,compensatingOp);
          }
 catch (          OperationFailedException e) {
            throw new RuntimeException(e);
          }
        }
      }
);
    }
 else {
      deploy(deploymentModel,operationContext,resultHandler,compensatingOp);
    }
  }
 else {
    resultHandler.handleResultComplete();
  }
}
