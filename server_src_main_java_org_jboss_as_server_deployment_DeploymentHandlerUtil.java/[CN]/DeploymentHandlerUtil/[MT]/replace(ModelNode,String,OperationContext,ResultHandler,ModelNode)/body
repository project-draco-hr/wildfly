{
  if (operationContext instanceof RuntimeOperationContext) {
    RuntimeOperationContext.class.cast(operationContext).executeRuntimeTask(new RuntimeTask(){
      public void execute(      RuntimeTaskContext context,      final ResultHandler resultHandler) throws OperationFailedException {
        final ServiceController<?> controller=context.getServiceRegistry().getService(Services.JBOSS_DEPLOYMENT_UNIT.append(toReplace));
        if (controller != null) {
          controller.addListener(new AbstractServiceListener<Object>(){
            public void listenerAdded(            ServiceController<? extends Object> serviceController){
              controller.setMode(ServiceController.Mode.REMOVE);
            }
            public void serviceRemoved(            ServiceController<? extends Object> serviceController){
              try {
                deploy(deploymentModel,operationContext,resultHandler,compensatingOp);
              }
 catch (              OperationFailedException e) {
                throw new RuntimeException(e);
              }
            }
          }
);
        }
 else {
          deploy(deploymentModel,operationContext,resultHandler,compensatingOp);
        }
      }
    }
,resultHandler);
  }
 else {
    resultHandler.handleResultComplete();
  }
}
