{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (!DeploymentTypeMarker.isType(DeploymentType.EAR,deploymentUnit)) {
    return;
  }
  ResourceRoot deploymentRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  List<ResourceRoot> potentialSubDeployments=deploymentUnit.getAttachmentList(Attachments.RESOURCE_ROOTS);
  for (  ResourceRoot resourceRoot : potentialSubDeployments) {
    if (IgnoreMetaInfMarker.isIgnoreMetaInf(resourceRoot))     continue;
    String pathName=resourceRoot.getRoot().getPathNameRelativeTo(deploymentRoot.getRoot());
    if (pathName.startsWith("lib/"))     continue;
    Manifest manifest=ManifestAttachmentProcessor.getManifest(resourceRoot);
    if (OSGiManifestBuilder.isValidBundleManifest(manifest)) {
      SubDeploymentMarker.mark(resourceRoot);
    }
  }
}
