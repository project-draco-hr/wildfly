{
  final int updateCount=updates.size();
  log.debugf("Applying %s domain updates",updateCount);
  List<DomainUpdateApplierResponse> result=new ArrayList<DomainUpdateApplierResponse>(updateCount);
  boolean ok=true;
  final List<AbstractDomainModelUpdate<?>> rollbacks=new ArrayList<AbstractDomainModelUpdate<?>>();
  for (  final AbstractDomainModelUpdate<?> update : updates) {
    if (ok) {
      try {
        final AbstractDomainModelUpdate<?> rollback=update.getCompensatingUpdate(domainModel);
        domainModel.update(update);
        rollbacks.add(0,rollback);
        result.add(new DomainUpdateApplierResponse(false));
      }
 catch (      final UpdateFailedException e) {
        log.debugf(e,"Failed applying %s",update);
        ok=false;
        result.add(new DomainUpdateApplierResponse(e));
      }
    }
 else {
      result.add(new DomainUpdateApplierResponse(true));
    }
  }
  if (!ok) {
    for (int i=0; i < rollbacks.size(); i++) {
      final AbstractDomainModelUpdate<?> rollback=rollbacks.get(i);
      try {
        domainModel.update(rollback);
      }
 catch (      final UpdateFailedException e) {
      }
    }
  }
 else {
    log.debug("Domain updates applied successfully locally; pushing to host controllers");
    configPersister.persistConfiguration(domainModel);
    result=applyUpdatesToHostControllers(updates,rollbacks);
  }
  return result;
}
