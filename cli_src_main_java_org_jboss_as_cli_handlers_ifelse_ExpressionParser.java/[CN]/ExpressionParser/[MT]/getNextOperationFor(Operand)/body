{
  if (firstOperand == null) {
    firstOperand=parseOperand();
    if (firstOperand == null) {
      return null;
    }
  }
  if (isEOL()) {
    return null;
  }
  final BaseOperation op;
  if (lookedAheadOp != null) {
    op=lookedAheadOp;
    lookedAheadOp=null;
  }
 else   if (input.startsWith(AND,pos)) {
    op=new AndOperation();
  }
 else   if (input.startsWith(OR,pos)) {
    op=new OrOperation();
  }
 else {
    throw new IllegalStateException("Unrecognized operation at " + pos + ": "+ input);
  }
  op.addOperand(firstOperand);
  while (input.startsWith(op.getName(),pos) && input.length() >= pos + op.getName().length()) {
    pos+=op.getName().length();
    Operand operand=parseOperand();
    if (operand == null) {
      return op;
    }
    if (!isEOL()) {
      if (input.startsWith(AND,pos)) {
        lookedAheadOp=new AndOperation();
      }
 else       if (input.startsWith(OR,pos)) {
        lookedAheadOp=new OrOperation();
      }
 else {
        throw new IllegalStateException("Unrecognized operation at " + pos + ": "+ input);
      }
      if (lookedAheadOp.getPriority() > op.getPriority()) {
        operand=getNextOperationFor(operand);
      }
    }
    op.addOperand(operand);
  }
  return op;
}
