{
  cli.sendLine("batch");
  cli.sendLine("deploy " + warFiles[0].getAbsolutePath());
  cli.sendLine("deploy " + warFiles[2].getAbsolutePath());
  assertTrue(checkUndeployed(getBaseURL(url) + "deployment0/SimpleServlet"));
  assertTrue(checkUndeployed(getBaseURL(url) + "deployment2/SimpleServlet"));
  cli.sendLine("run-batch",true);
  String line=cli.readOutput();
  String expectedErrorCode=ControllerLogger.ROOT_LOGGER.compositeOperationFailed();
  expectedErrorCode=expectedErrorCode.substring(0,expectedErrorCode.indexOf(':'));
  assertTrue("Batch did not fail.",line.contains(expectedErrorCode));
  assertTrue(checkUndeployed(getBaseURL(url) + "deployment0/SimpleServlet"));
  assertTrue(checkUndeployed(getBaseURL(url) + "deployment2/SimpleServlet"));
  cli.sendLine("discard-batch");
  cli.sendLine("deploy " + warFiles[0].getAbsolutePath());
  String response=HttpRequest.get(getBaseURL(url) + "deployment0/SimpleServlet",1000,10,TimeUnit.SECONDS);
  assertTrue("Invalid response: " + response,response.indexOf("SimpleServlet") >= 0);
  cli.sendLine("undeploy deployment0.war");
  assertTrue(checkUndeployed(getBaseURL(url) + "deployment0/SimpleServlet"));
}
