{
  CacheMode mode=local ? CacheMode.LOCAL : (totalReplication ? CacheMode.REPL_SYNC : CacheMode.DIST_SYNC);
  GlobalConfigurationBuilder globalBuilder=new GlobalConfigurationBuilder();
  globalBuilder.transport().transport(mode.isClustered() ? new JGroupsTransport() : null).clusterName("test").globalJmxStatistics().cacheManagerName("container" + containerIndex++).disable();
  ConfigurationBuilder builder=new ConfigurationBuilder().read(CacheAdd.getDefaultConfiguration(mode));
  builder.transaction().syncCommitPhase(true).syncRollbackPhase(true).transactionMode(TransactionMode.TRANSACTIONAL).transactionManagerLookup(new TransactionManagerProvider(BatchModeTransactionManager.getInstance())).invocationBatching().enable();
  if (passivationDir != null) {
    builder.loaders().passivation(true).preload(!purgeCacheLoader).addFileCacheStore().location(passivationDir).fetchPersistentState(mode.isReplicated()).purgeOnStartup(purgeCacheLoader).purgeSynchronously(true);
  }
  final EmbeddedCacheManager container=new DefaultEmbeddedCacheManager(new DefaultCacheManager(globalBuilder.build(),builder.build(),false),CacheContainer.DEFAULT_CACHE_NAME);
  container.defineConfiguration(JVM_ROUTE_CACHE_NAME,builder.build());
  return container;
}
