{
  final ManagedReference existing=referenceReference.get();
  if (existing == null) {
    final ManagedReference reference=componentFactory.create(context);
    boolean ok=false;
    try {
      referenceReference.set(reference);
      if (setTarget) {
        context.setTarget(reference.getInstance());
      }
      Object result=context.proceed();
      ok=true;
      return result;
    }
  finally {
      if (!ok) {
        reference.release();
        referenceReference.set(null);
      }
    }
  }
 else {
    return context.proceed();
  }
}
