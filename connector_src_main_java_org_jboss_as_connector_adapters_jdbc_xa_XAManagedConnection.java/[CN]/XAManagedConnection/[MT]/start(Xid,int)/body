{
  lock();
  try {
    try {
      checkState();
    }
 catch (    SQLException e) {
      getLog().warn("Error setting state ",e);
    }
    try {
      xaResource.start(xid,flags);
    }
 catch (    XAException e) {
      if (isFailedXA(e.errorCode)) {
        broadcastConnectionError(e);
      }
      throw e;
    }
synchronized (stateLock) {
      currentXid=xid;
      inManagedTransaction=true;
    }
  }
  finally {
    unlock();
  }
}
