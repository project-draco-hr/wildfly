{
  lock();
  try {
    try {
      xaResource.end(xid,flags);
    }
 catch (    XAException e) {
      broadcastConnectionError(e);
      throw e;
    }
synchronized (stateLock) {
      if (currentXid != null && currentXid.equals(xid)) {
        inManagedTransaction=false;
        currentXid=null;
      }
    }
  }
  finally {
    unlock();
  }
}
