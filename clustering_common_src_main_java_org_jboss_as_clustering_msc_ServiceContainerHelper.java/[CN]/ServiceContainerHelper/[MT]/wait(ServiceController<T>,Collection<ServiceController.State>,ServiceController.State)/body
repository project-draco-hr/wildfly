{
  if (controller.getState() == targetState)   return true;
  ServiceListener<T> listener=new NotifyingServiceListener<T>(controller);
  controller.addListener(listener);
  try {
synchronized (controller) {
      ServiceController.State state=controller.getState();
      while (expectedStates.contains(state)) {
        log.tracef("Waiting for %s transition from %s to %s, unavailable dependencies: %s",controller.getName(),state,targetState,controller.getImmediateUnavailableDependencies());
        controller.wait();
        state=controller.getState();
        log.tracef("%s state is now %s",controller.getName(),state);
      }
    }
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
  }
  controller.removeListener(listener);
  return controller.getState() == targetState;
}
