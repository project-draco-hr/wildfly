{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (isEarDeployment(deploymentUnit)) {
    List<PersistenceUnitMetadataHolder> listPUHolders=new ArrayList<PersistenceUnitMetadataHolder>(1);
    final ResourceRoot deploymentRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
    VirtualFile persistence_xml=deploymentRoot.getRoot().getChild(META_INF_PERSISTENCE_XML);
    parse(persistence_xml,listPUHolders,deploymentUnit);
    PersistenceUnitMetadataHolder holder=normalize(listPUHolders);
    deploymentRoot.putAttachment(PersistenceUnitMetadataHolder.PERSISTENCE_UNITS,holder);
    markDU(holder,deploymentUnit);
    log.trace("parsed persistence unit definitions for ear " + deploymentRoot.getRootName());
  }
}
