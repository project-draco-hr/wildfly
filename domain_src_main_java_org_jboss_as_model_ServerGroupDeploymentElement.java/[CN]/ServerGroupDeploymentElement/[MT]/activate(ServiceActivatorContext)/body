{
  final String deploymentName=key.getName().replace('.','_');
  log.infof("Activating deployment: %s",key.getName());
  final VirtualFile deploymentRoot=VFS.getChild(getFullyQualifiedDeploymentPath(key.getName()));
  if (!deploymentRoot.exists())   throw new RuntimeException("Deployment root does not exist." + deploymentRoot);
  Closeable handle=null;
  try {
    try {
      if (deploymentRoot.isFile())       handle=VFS.mountZip(deploymentRoot,deploymentRoot,TempFileProviderService.provider());
    }
 catch (    IOException e) {
      throw new RuntimeException("Failed to mount deployment archive",e);
    }
    final BatchBuilder batchBuilder=context.getBatchBuilder();
    final ServiceName deploymentServiceName=DeploymentService.SERVICE_NAME.append(deploymentName);
    BatchServiceBuilder<Void> serviceBuilder=batchBuilder.addService(deploymentServiceName,new DeploymentService());
    final BatchBuilder deploymentSubBatch=batchBuilder.subBatchBuilder();
    deploymentSubBatch.addDependency(deploymentServiceName);
    deploymentSubBatch.addListener(new DeploymentFailureListener(deploymentServiceName));
    final DeploymentUnitContext deploymentUnitContext=new DeploymentUnitContextImpl(deploymentName,deploymentSubBatch,serviceBuilder);
    attachVirtualFile(deploymentUnitContext,deploymentRoot);
    deploymentUnitContext.putAttachment(MountHandle.ATTACHMENT_KEY,new MountHandle(handle));
    final DeploymentChainProvider deploymentChainProvider=DeploymentChainProvider.INSTANCE;
    final DeploymentChain deploymentChain=deploymentChainProvider.determineDeploymentChain(deploymentRoot);
    log.debugf("Executing deployment '%s' with chain: %s",key.getName(),deploymentChain);
    if (deploymentChain == null)     throw new RuntimeException("Failed determine the deployment chain for deployment root: " + deploymentRoot);
    try {
      deploymentChain.processDeployment(deploymentUnitContext);
    }
 catch (    DeploymentUnitProcessingException e) {
      throw new RuntimeException("Failed to process deployment chain.",e);
    }
  }
 catch (  Throwable t) {
    VFSUtils.safeClose(handle);
    throw new RuntimeException("Failed to activate deployment unit " + key.getName(),t);
  }
}
