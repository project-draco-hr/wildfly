{
  final ServiceContainer sc;
  final ControlledProcessState ps;
synchronized (this) {
    down=true;
    sc=container;
    ps=processState;
  }
  try {
    if (ps != null) {
      ps.setStopping();
    }
  }
  finally {
    if (sc != null) {
      final CountDownLatch latch=new CountDownLatch(1);
      sc.addTerminateListener(new ServiceContainer.TerminateListener(){
        @Override public void handleTermination(        Info info){
          latch.countDown();
        }
      }
);
      sc.shutdown();
      for (; ; ) {
        try {
          latch.await();
          break;
        }
 catch (        InterruptedException e) {
        }
      }
    }
  }
}
