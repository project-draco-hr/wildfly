{
  String name=null;
  String path=null;
  boolean usePhysicalCodeSource=false;
  final Set<Attribute> required=EnumSet.of(Attribute.PATH);
  final int count=reader.getAttributeCount();
  for (int i=0; i < count; i++) {
    final Attribute attribute=Attribute.of(reader.getAttributeName(i));
    required.remove(attribute);
switch (attribute) {
case NAME:
      name=reader.getAttributeValue(i);
    break;
case PATH:
  path=reader.getAttributeValue(i);
break;
case USE_PHYSICAL_CODE_SOURCE:
usePhysicalCodeSource=Boolean.parseBoolean(reader.getAttributeValue(i));
break;
default :
throw unexpectedContent(reader);
}
}
if (!required.isEmpty()) {
throw missingAttributes(reader.getLocation(),required);
}
if (name == null) name=path;
final List<FilterSpecification> resourceFilters=new ArrayList<FilterSpecification>();
final Set<Element> encountered=EnumSet.noneOf(Element.class);
while (reader.hasNext()) {
switch (reader.nextTag()) {
case XMLStreamConstants.END_ELEMENT:
{
try {
final ResourceRoot deploymentRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
final VirtualFile deploymentRootFile=deploymentRoot.getRoot();
final VirtualFile child=deploymentRootFile.getChild(path);
Map<String,MountedDeploymentOverlay> overlays=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_OVERLAY_LOCATIONS);
MountedDeploymentOverlay overlay=overlays.get(path);
Closeable closable=null;
if (overlay != null) {
overlay.remountAsZip(false);
}
 else if (child.isFile()) {
closable=VFS.mountZip(child,child,TempFileProviderService.provider());
}
final MountHandle mountHandle=new MountHandle(closable);
final ResourceRoot resourceRoot=new ResourceRoot(name,child,mountHandle);
for (final FilterSpecification filter : resourceFilters) {
resourceRoot.getExportFilters().add(filter);
}
resourceRoot.setUsePhysicalCodeSource(usePhysicalCodeSource);
specBuilder.addResourceRoot(resourceRoot);
}
 catch (IOException e) {
throw new XMLStreamException(e);
}
return;
}
case XMLStreamConstants.START_ELEMENT:
{
final Element element=Element.of(reader.getName());
if (!encountered.add(element)) throw unexpectedContent(reader);
switch (element) {
case FILTER:
parseFilterList(reader,resourceFilters);
break;
default :
throw unexpectedContent(reader);
}
break;
}
default :
{
throw unexpectedContent(reader);
}
}
}
}
