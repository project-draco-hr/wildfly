{
  System.setProperty("log4j.defaultInitOverride","true");
  new BridgeRepositorySelector().start();
  final InputStream initialInput=System.in;
  final PrintStream initialError=System.err;
  StdioContext.install();
  final StdioContext context=StdioContext.create(new NullInputStream(),new LoggingOutputStream(org.jboss.logmanager.Logger.getLogger("stdout"),Level.INFO),new LoggingOutputStream(org.jboss.logmanager.Logger.getLogger("stderr"),Level.ERROR));
  StdioContext.setStdioContextSelector(new SimpleStdioContextSelector(context));
  final byte[] authKey=new byte[16];
  try {
    StreamUtils.readFully(initialInput,authKey);
  }
 catch (  IOException e) {
    e.printStackTrace();
    System.exit(1);
    throw new IllegalStateException();
  }
  final MarshallerFactory factory=Marshalling.getMarshallerFactory("river",DomainServerMain.class.getClassLoader());
  final Unmarshaller unmarshaller;
  final ByteInput byteInput;
  final AsyncFuture<ServiceContainer> containerFuture;
  try {
    Module.registerURLStreamHandlerFactoryModule(Module.getBootModuleLoader().loadModule(ModuleIdentifier.create("org.jboss.vfs")));
    final MarshallingConfiguration configuration=new MarshallingConfiguration();
    configuration.setVersion(2);
    configuration.setClassResolver(new SimpleClassResolver(DomainServerMain.class.getClassLoader()));
    unmarshaller=factory.createUnmarshaller(configuration);
    byteInput=Marshalling.createByteInput(initialInput);
    unmarshaller.start(byteInput);
    final ServerTask task=unmarshaller.readObject(ServerTask.class);
    unmarshaller.finish();
    containerFuture=task.run(Arrays.<ServiceActivator>asList(new ServiceActivator(){
      @Override public void activate(      final ServiceActivatorContext serviceActivatorContext){
      }
    }
));
  }
 catch (  Exception e) {
    e.printStackTrace(initialError);
    System.exit(1);
    throw new IllegalStateException();
  }
 finally {
  }
  for (; ; )   try {
    String hostName=StreamUtils.readUTFZBytes(initialInput);
    int port=StreamUtils.readInt(initialInput);
    final CountDownLatch latch=new CountDownLatch(2);
    final UninstallListener connectionListener=new UninstallListener(latch,HostControllerConnectionService.SERVICE_NAME);
    final UninstallListener clientListener=new UninstallListener(latch,HostControllerServerClient.SERVICE_NAME);
    final ServiceContainer container=containerFuture.get();
    final ServiceController<?> client=container.getRequiredService(HostControllerServerClient.SERVICE_NAME);
    final String name=((HostControllerServerClient)client.getValue()).getServerName();
    client.addListener(clientListener);
    client.setMode(ServiceController.Mode.REMOVE);
    final ServiceController<?> connection=container.getRequiredService(HostControllerConnectionService.SERVICE_NAME);
    connection.addListener(connectionListener);
    connection.setMode(ServiceController.Mode.REMOVE);
    latch.await();
    client.removeListener(clientListener);
    connection.removeListener(connectionListener);
    addCommunicationServices(container,name,authKey,new InetSocketAddress(InetAddress.getByName(hostName),port));
  }
 catch (  InterruptedIOException e) {
    Thread.interrupted();
  }
catch (  EOFException e) {
    break;
  }
catch (  Exception e) {
    e.printStackTrace();
    break;
  }
  System.exit(0);
  throw new IllegalStateException();
}
