{
  File tgt=new File(directory,file.getName());
  if (tgt.exists()) {
    if (!tgt.delete()) {
      throw new IllegalStateException("Could not delete file " + tgt.getAbsolutePath());
    }
  }
  final InputStream in=new BufferedInputStream(new FileInputStream(file));
  try {
    final OutputStream out=new BufferedOutputStream(new FileOutputStream(tgt));
    try {
      int i=in.read();
      while (i != -1) {
        out.write(i);
        i=in.read();
      }
    }
  finally {
      IoUtils.safeClose(out);
    }
  }
  finally {
    IoUtils.safeClose(in);
  }
}
