{
  configurationPersistence.prepare();
  context.completeStep(new ResultHandler(){
    @Override public void handleResult(    final ResultAction resultAction,    final OperationContext context,    final ModelNode operation){
      if (resultAction == ResultAction.KEEP) {
        configurationPersistence.commit();
        if (!LoggingProfileOperations.isLoggingProfileAddress(getAddress(operation))) {
          if (context.getAttachment(WRITTEN_KEY) == null) {
            context.attachIfAbsent(WRITTEN_KEY,Boolean.TRUE);
            if (persistConfig) {
              configurationPersistence.writeConfiguration(context);
            }
          }
        }
      }
 else       if (resultAction == ResultAction.ROLLBACK) {
        configurationPersistence.rollback();
      }
    }
  }
);
}
