{
  PersistenceUnitMetadata pu=getPersistenceUnit(deploymentUnit,annotation,classDescription);
  if (pu == null) {
    return null;
  }
  String scopedPuName=pu.getScopedPersistenceUnitName();
  ServiceName puServiceName=getPuServiceName(scopedPuName);
  if (isPersistenceContext(annotation)) {
    if (pu.getTransactionType() == PersistenceUnitTransactionType.RESOURCE_LOCAL) {
      classDescription.setInvalid(MESSAGES.cannotInjectResourceLocalEntityManager());
      return null;
    }
    AnnotationValue pcType=annotation.value("type");
    PersistenceContextType type=(pcType == null || PersistenceContextType.TRANSACTION.name().equals(pcType.asString())) ? PersistenceContextType.TRANSACTION : PersistenceContextType.EXTENDED;
    AnnotationValue stType=annotation.value("synchronizationType");
    SynchronizationType synchronizationType=(stType == null || SynchronizationType.SYNCHRONIZED.name().equals(stType.asString())) ? SynchronizationType.SYNCHRONIZED : SynchronizationType.UNSYNCHRONIZED;
    Map properties;
    AnnotationValue value=annotation.value("properties");
    AnnotationInstance[] props=value != null ? value.asNestedArray() : null;
    if (props != null) {
      properties=new HashMap();
      for (int source=0; source < props.length; source++) {
        properties.put(props[source].value("name"),props[source].value("value"));
      }
    }
 else {
      properties=null;
    }
    return new PersistenceContextInjectionSource(type,synchronizationType,properties,puServiceName,deploymentUnit,scopedPuName,injectionTypeName,pu);
  }
 else {
    return new PersistenceUnitInjectionSource(puServiceName,deploymentUnit,injectionTypeName,pu);
  }
}
