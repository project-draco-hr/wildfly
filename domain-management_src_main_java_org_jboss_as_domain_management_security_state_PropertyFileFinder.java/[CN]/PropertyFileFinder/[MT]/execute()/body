{
  stateValues.setKnownRoles(new HashMap<String,String>());
  String jbossHome=stateValues.getJBossHome();
  if (jbossHome == null) {
    return new ErrorState(theConsole,MESSAGES.jbossHomeNotSet(),null,stateValues);
  }
  List<File> foundFiles=new ArrayList<File>(2);
  final String fileName=stateValues.isManagement() ? MGMT_USERS_PROPERTIES : APPLICATION_USERS_PROPERTIES;
  if (!findFiles(jbossHome,foundFiles,fileName)) {
    return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(fileName),null,stateValues);
  }
  if (!stateValues.isManagement()) {
    List<File> foundRoleFiles=new ArrayList<File>(2);
    if (!findFiles(jbossHome,foundRoleFiles,APPLICATION_ROLES_PROPERTIES)) {
      return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(APPLICATION_ROLES_PROPERTIES),null,stateValues);
    }
    stateValues.setRoleFiles(foundRoleFiles);
    try {
      stateValues.setKnownRoles(loadAllRoles(foundRoleFiles));
    }
 catch (    Exception e) {
      return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(APPLICATION_ROLES_PROPERTIES),null,stateValues);
    }
  }
  stateValues.setUserFiles(foundFiles);
  String realmName=null;
  Set<String> foundUsers=new HashSet<String>();
  for (  File current : stateValues.getUserFiles()) {
    PropertiesFileLoader pfl=null;
    try {
      pfl=loadUsersFile(current);
      foundUsers.addAll(pfl.getProperties().stringPropertyNames());
      if (realmName == null) {
        realmName=pfl.getRealmName();
      }
 else {
        String nextRealm=pfl.getRealmName();
        if (realmName.equals(nextRealm) == false) {
          return new ErrorState(theConsole,MESSAGES.multipleRealmsDetected(realmName,nextRealm),null,stateValues);
        }
      }
      pfl.stop(null);
      pfl=null;
    }
 catch (    IOException e) {
      return new ErrorState(theConsole,MESSAGES.unableToLoadUsers(current.getAbsolutePath(),e.getMessage()),null,stateValues);
    }
 finally {
      if (pfl != null) {
        pfl.stop(null);
        pfl=null;
      }
    }
  }
  if (realmName != null) {
    if (stateValues.getRealmMode() == RealmMode.USER_SUPPLIED && realmName.equals(stateValues.getRealm()) == false) {
      return new ErrorState(theConsole,MESSAGES.userRealmNotMatchDiscovered(stateValues.getRealm(),realmName),null,stateValues);
    }
    stateValues.setRealm(realmName);
    stateValues.setRealmMode(RealmMode.DISCOVERED);
  }
  stateValues.setKnownUsers(foundUsers);
  return stateValues.isInteractive() ? new PromptRealmState(theConsole,stateValues) : new PromptNewUserState(theConsole,stateValues);
}
