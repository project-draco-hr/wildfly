{
  stateValues.setKnownRoles(new HashMap<String,String>());
  String jbossHome=stateValues.getJBossHome();
  if (jbossHome == null) {
    return new ErrorState(theConsole,MESSAGES.jbossHomeNotSet(),null,stateValues);
  }
  List<File> foundFiles=new ArrayList<File>(2);
  final String fileName=stateValues.isManagement() ? MGMT_USERS_PROPERTIES : APPLICATION_USERS_PROPERTIES;
  if (!findFiles(jbossHome,foundFiles,fileName)) {
    return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(fileName),null,stateValues);
  }
  if (!stateValues.isManagement()) {
    List<File> foundRoleFiles=new ArrayList<File>(2);
    if (!findFiles(jbossHome,foundRoleFiles,APPLICATION_ROLES_PROPERTIES)) {
      return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(APPLICATION_ROLES_PROPERTIES),null,stateValues);
    }
    stateValues.setRoleFiles(foundRoleFiles);
    try {
      stateValues.setKnownRoles(loadAllRoles(foundRoleFiles));
    }
 catch (    Exception e) {
      return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(APPLICATION_ROLES_PROPERTIES),null,stateValues);
    }
  }
  stateValues.setPropertiesFiles(foundFiles);
  Set<String> foundUsers=new HashSet<String>();
  for (  File current : stateValues.getPropertiesFiles()) {
    try {
      foundUsers.addAll(loadUserNames(current));
    }
 catch (    IOException e) {
      return new ErrorState(theConsole,MESSAGES.unableToLoadUsers(current.getAbsolutePath(),e.getMessage()),null,stateValues);
    }
  }
  stateValues.setKnownUsers(foundUsers);
  return stateValues.isInteractive() ? new PromptRealmState(theConsole,stateValues) : new PromptNewUserState(theConsole,stateValues);
}
