{
  Request request=(Request)messageInfo.getRequestMessage();
  Response response=(Response)messageInfo.getResponseMessage();
  Principal principal;
  context=request.getContext();
  X509Certificate[] certs=(X509Certificate[])request.getAttribute(CERTIFICATES_ATTR);
  if ((certs == null) || (certs.length < 1)) {
    request.getCoyoteRequest().action(ActionCode.ACTION_REQ_SSL_CERTIFICATE,null);
    certs=(X509Certificate[])request.getAttribute(CERTIFICATES_ATTR);
  }
  if ((certs == null) || (certs.length < 1)) {
    WebLogger.WEB_SECURITY_LOGGER.debugf("No certificates included with this request");
    try {
      response.sendError(HttpServletResponse.SC_UNAUTHORIZED,CatalinaMessages.MESSAGES.missingRequestCertificate());
    }
 catch (    IOException e) {
    }
    return (AuthStatus.FAILURE);
  }
  principal=context.getRealm().authenticate(certs);
  if (principal == null) {
    WebLogger.WEB_SECURITY_LOGGER.debugf("Realm.authenticate() returned false");
    try {
      response.sendError(HttpServletResponse.SC_UNAUTHORIZED,CatalinaMessages.MESSAGES.certificateAuthenticationFailure());
    }
 catch (    IOException e) {
    }
    return (AuthStatus.FAILURE);
  }
  registerWithCallbackHandler(principal,principal.getName(),null);
  return (AuthStatus.SUCCESS);
}
