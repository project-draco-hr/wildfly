{
  ServiceController<?> serviceController=context.getController();
  LOGGER.tracef("Starting: %s in mode %s",serviceController.getName(),serviceController.getMode());
  final ServerEnvironment serverenv=injectedServerEnvironment.getValue();
  final File storageDir=new File(serverenv.getServerDataDir().getPath() + File.separator + "repository");
  RepositoryStorageFactory factory=new RepositoryStorageFactory(){
    @Override public RepositoryStorage create(    XRepository repository){
      return new FileBasedRepositoryStorage(repository,storageDir){
        @Override public XResource addResource(        XResource res) throws RepositoryStorageException {
          if (res.getCapabilities(MODULE_IDENTITY_NAMESPACE).isEmpty()) {
            return super.addResource(res);
          }
 else {
            return res;
          }
        }
      }
;
    }
  }
;
  BundleContext syscontext=injectedSystemContext.getValue();
  XRepositoryBuilder builder=XRepositoryBuilder.create(syscontext);
  builder.addRepository(new ModuleIdentityRepository(serverenv));
  builder.addRepositoryStorage(factory);
  repository=builder.addDefaultRepositories();
}
