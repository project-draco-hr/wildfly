{
  File file=getFile(obj.getId());
  file.deleteOnExit();
  log.tracef("Storing state to %s",file);
  try {
    Marshaller marshaller=this.marshallerFactory.createMarshaller(this.configuration);
    FileOutputStream outputStream=null;
    try {
      outputStream=FOSAction.open(file);
      marshaller.start(Marshalling.createByteOutput(outputStream));
      try {
        marshaller.writeObject(obj);
        marshaller.finish();
      }
  finally {
        marshaller.close();
      }
    }
  finally {
      safeClose(outputStream);
    }
  }
 catch (  IOException e) {
    throw EjbMessages.MESSAGES.passivationFailed(e,obj.getId());
  }
}
