{
  File file=getFile(obj.getId());
  file.deleteOnExit();
  log.tracef("Storing state to %s",file);
  try {
    Marshaller marshaller=this.marshallerFactory.createMarshaller(this.configuration);
    marshaller.start(Marshalling.createByteOutput(FOSAction.open(file)));
    try {
      marshaller.writeObject(obj);
      marshaller.finish();
    }
  finally {
      marshaller.close();
    }
  }
 catch (  IOException e) {
    throw EjbMessages.MESSAGES.passivationFailed(e,obj.getId());
  }
}
