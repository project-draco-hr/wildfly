{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (!WeldDeploymentMarker.isWeldDeployment(deploymentUnit)) {
    return;
  }
  final DeploymentUnit topLevelDeployment=deploymentUnit.getParent() == null ? deploymentUnit : deploymentUnit.getParent();
  final EEModuleDescription eeModuleDescription=deploymentUnit.getAttachment(org.jboss.as.ee.component.Attachments.EE_MODULE_DESCRIPTION);
  final ServiceName weldServiceName=topLevelDeployment.getServiceName().append(WeldService.SERVICE_NAME);
  for (  ComponentDescription component : eeModuleDescription.getComponentDescriptions()) {
    final String beanName;
    if (component instanceof SessionBeanComponentDescription) {
      beanName=component.getComponentName();
    }
 else {
      beanName=null;
    }
    component.getConfigurators().addFirst(new ComponentConfigurator(){
      @Override public void configure(      final DeploymentPhaseContext context,      final ComponentDescription description,      final ComponentConfiguration configuration) throws DeploymentUnitProcessingException {
        final Class<?> componentClass=configuration.getModuleClassConfiguration().getModuleClass();
        final DeploymentUnit deploymentUnit=context.getDeploymentUnit();
        final ModuleClassLoader classLoader=deploymentUnit.getAttachment(Attachments.MODULE).getClassLoader();
        final EEApplicationDescription applicationDescription=deploymentUnit.getAttachment(org.jboss.as.ee.component.Attachments.EE_APPLICATION_DESCRIPTION);
        final Set<Class<?>> interceptorClasses=new HashSet<Class<?>>();
        for (        InterceptorDescription interceptorDescription : description.getAllInterceptors()) {
          EEModuleClassConfiguration clazz=applicationDescription.getClassConfiguration(interceptorDescription.getInterceptorClassName());
          if (clazz != null) {
            interceptorClasses.add(clazz.getModuleClass());
          }
        }
        addWeldInstantiator(context.getServiceTarget(),configuration,componentClass,beanName,weldServiceName,interceptorClasses,classLoader,description.getBeanDeploymentArchiveId());
        configuration.addPostConstructInterceptor(new WeldInjectionInterceptor.Factory(configuration,interceptorClasses),InterceptorOrder.ComponentPostConstruct.WELD_INJECTION);
      }
    }
);
  }
}
