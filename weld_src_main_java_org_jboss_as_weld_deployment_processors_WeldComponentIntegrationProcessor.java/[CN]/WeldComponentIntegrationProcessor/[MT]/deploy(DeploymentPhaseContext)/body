{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final DeploymentClassIndex classIndex=deploymentUnit.getAttachment(Attachments.CLASS_INDEX);
  if (!WeldDeploymentMarker.isWeldDeployment(deploymentUnit)) {
    return;
  }
  final DeploymentUnit topLevelDeployment=deploymentUnit.getParent() == null ? deploymentUnit : deploymentUnit.getParent();
  final EEModuleDescription eeModuleDescription=deploymentUnit.getAttachment(org.jboss.as.ee.component.Attachments.EE_MODULE_DESCRIPTION);
  final ServiceName weldServiceName=topLevelDeployment.getServiceName().append(WeldService.SERVICE_NAME);
  for (  ComponentDescription component : eeModuleDescription.getComponentDescriptions()) {
    final String beanName;
    if (component instanceof EJBComponentDescription) {
      beanName=component.getComponentName();
    }
 else {
      beanName=null;
    }
    component.getConfigurators().addFirst(new ComponentConfigurator(){
      @Override public void configure(      final DeploymentPhaseContext context,      final ComponentDescription description,      final ComponentConfiguration configuration) throws DeploymentUnitProcessingException {
        final Class<?> componentClass=configuration.getComponentClass();
        final DeploymentUnit deploymentUnit=context.getDeploymentUnit();
        final ModuleClassLoader classLoader=deploymentUnit.getAttachment(Attachments.MODULE).getClassLoader();
        final Set<Class<?>> interceptorClasses=new HashSet<Class<?>>();
        for (        InterceptorDescription interceptorDescription : description.getAllInterceptors()) {
          try {
            final ClassIndex index=classIndex.classIndex(interceptorDescription.getInterceptorClassName());
            interceptorClasses.add(index.getModuleClass());
          }
 catch (          ClassNotFoundException e) {
            throw new RuntimeException("Could not load interceptor class",e);
          }
        }
        addWeldIntegration(context.getServiceTarget(),configuration,description,componentClass,beanName,weldServiceName,interceptorClasses,classLoader,description.getBeanDeploymentArchiveId());
        configuration.addPostConstructInterceptor(new WeldInjectionInterceptor.Factory(configuration,interceptorClasses),InterceptorOrder.ComponentPostConstruct.WELD_INJECTION);
      }
    }
);
    if (component instanceof EJBComponentDescription) {
      for (      final ViewDescription view : component.getViews()) {
        final EJBViewDescription ejbView=(EJBViewDescription)view;
        if (ejbView.getMethodIntf() == MethodIntf.REMOTE) {
          ejbView.getConfigurators().add(new ViewConfigurator(){
            @Override public void configure(            final DeploymentPhaseContext context,            final ComponentConfiguration componentConfiguration,            final ViewDescription description,            final ViewConfiguration configuration) throws DeploymentUnitProcessingException {
              final Module module=context.getDeploymentUnit().getAttachment(Attachments.MODULE);
              final EjbRequestScopeActivationInterceptor.Factory requestFactory=new EjbRequestScopeActivationInterceptor.Factory(module.getClassLoader(),weldServiceName);
              configuration.addViewInterceptor(requestFactory,InterceptorOrder.View.CDI_REQUEST_SCOPE);
            }
          }
);
        }
      }
    }
  }
}
