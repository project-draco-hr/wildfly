{
  File tmpFile=File.createTempFile("jsr88_deployment_",".zip");
  ROOT_LOGGER.debugf("temporary deployment file: %s",tmpFile);
  tmpFiles.add(tmpFile);
  JarInputStream jis=new JarInputStream(moduleArchive);
  JarOutputStream jos;
  FileOutputStream fos=new FileOutputStream(tmpFile);
  Manifest manifest=jis.getManifest();
  if (manifest != null)   jos=new JarOutputStream(fos,manifest);
 else   jos=new JarOutputStream(fos);
  ModuleType moduleType=null;
  JarEntry entry=jis.getNextJarEntry();
  while (entry != null) {
    String entryName=entry.getName();
    if (entryName.endsWith("/") == false) {
      moduleType=ifNotNull(determineModuleType(entryName),moduleType);
      if (entryName.endsWith(".jar") || entryName.endsWith(".war")) {
        File tmpSubModule=processSubModule(entryName,jis);
        FileInputStream fis=new FileInputStream(tmpSubModule);
        JarUtils.addJarEntry(jos,entryName,fis);
        fis.close();
      }
 else {
        if (getDescriptorFile("!/" + entryName) == null)         JarUtils.addJarEntry(jos,entryName,jis);
 else         ROOT_LOGGER.debugf("Skip entry found in deployment plan: %s",entryName);
      }
    }
    entry=jis.getNextJarEntry();
  }
  String moduleName=getDeploymentMetaData().getDeploymentName();
  if (moduleType == null) {
    if (moduleName.endsWith(ModuleType.EAR.getModuleExtension()))     moduleType=ModuleType.EAR;
 else     if (moduleName.endsWith(ModuleType.WAR.getModuleExtension()))     moduleType=ModuleType.WAR;
 else     if (moduleName.endsWith(ModuleType.RAR.getModuleExtension()))     moduleType=ModuleType.RAR;
 else     throw new RuntimeException(MESSAGES.cannotObtainModuleType(moduleName));
  }
  String depname=getDeploymentMetaData().getDeploymentName();
  TargetModuleInfo moduleInfo=new TargetModuleInfo(depname,moduleType,tmpFile);
  addDeploymentPlanEntry(jos,null);
  jos.close();
  return moduleInfo;
}
