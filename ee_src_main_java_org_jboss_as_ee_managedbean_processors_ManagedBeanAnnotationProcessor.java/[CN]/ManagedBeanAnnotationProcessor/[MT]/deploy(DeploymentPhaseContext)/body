{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final EEResourceReferenceProcessorRegistry registry=deploymentUnit.getAttachment(org.jboss.as.ee.component.Attachments.RESOURCE_REFERENCE_PROCESSOR_REGISTRY);
  final EEModuleDescription moduleDescription=deploymentUnit.getAttachment(org.jboss.as.ee.component.Attachments.EE_MODULE_DESCRIPTION);
  final CompositeIndex compositeIndex=deploymentUnit.getAttachment(Attachments.COMPOSITE_ANNOTATION_INDEX);
  if (compositeIndex == null) {
    return;
  }
  final List<AnnotationInstance> instances=compositeIndex.getAnnotations(MANAGED_BEAN_ANNOTATION_NAME);
  if (instances == null || instances.isEmpty()) {
    return;
  }
  for (  AnnotationInstance instance : instances) {
    AnnotationTarget target=instance.target();
    if (!(target instanceof ClassInfo)) {
      throw MESSAGES.classOnlyAnnotation("@ManagedBean",target);
    }
    final ClassInfo classInfo=(ClassInfo)target;
    if (!assertManagedBeanClassValidity(classInfo)) {
      continue;
    }
    final String beanClassName=classInfo.name().toString();
    final AnnotationValue nameValue=instance.value();
    final String beanName=nameValue == null || nameValue.asString().isEmpty() ? beanClassName : nameValue.asString();
    final ManagedBeanComponentDescription componentDescription=new ManagedBeanComponentDescription(beanName,beanClassName,moduleDescription,deploymentUnit.getServiceName());
    ViewDescription viewDescription=new ViewDescription(componentDescription,beanClassName);
    viewDescription.getConfigurators().addFirst(new ViewConfigurator(){
      public void configure(      final DeploymentPhaseContext context,      final ComponentConfiguration componentConfiguration,      final ViewDescription description,      final ViewConfiguration configuration) throws DeploymentUnitProcessingException {
        final Object contextKey=new Object();
        configuration.addClientPostConstructInterceptor(new ManagedBeanCreateInterceptorFactory(contextKey),InterceptorOrder.ClientPostConstruct.INSTANCE_CREATE);
        final ManagedBeanAssociatingInterceptorFactory associatingInterceptorFactory=new ManagedBeanAssociatingInterceptorFactory(contextKey);
        configuration.addClientInterceptor(associatingInterceptorFactory,InterceptorOrder.Client.ASSOCIATING_INTERCEPTOR);
        configuration.addClientPreDestroyInterceptor(new ManagedBeanDestroyInterceptorFactory(contextKey),InterceptorOrder.ClientPreDestroy.INSTANCE_DESTROY);
        final ClassLoader classLoader=componentConfiguration.getModuleClassLoader();
        if (WildFlySecurityManager.isChecking()) {
          configuration.addViewInterceptor(PrivilegedInterceptor.getFactory(),InterceptorOrder.View.PRIVILEGED_INTERCEPTOR);
        }
        configuration.addViewInterceptor(AccessCheckingInterceptor.getFactory(),InterceptorOrder.View.CHECKING_INTERCEPTOR);
        configuration.addViewInterceptor(new ImmediateInterceptorFactory(new ContextClassLoaderInterceptor(classLoader)),InterceptorOrder.View.TCCL_INTERCEPTOR);
      }
    }
);
    viewDescription.getBindingNames().addAll(Arrays.asList("java:module/" + beanName,"java:app/" + moduleDescription.getModuleName() + "/"+ beanName));
    componentDescription.getViews().add(viewDescription);
    moduleDescription.addComponent(componentDescription);
    registry.registerResourceReferenceProcessor(new ManagedBeanResourceReferenceProcessor(beanClassName));
  }
}
