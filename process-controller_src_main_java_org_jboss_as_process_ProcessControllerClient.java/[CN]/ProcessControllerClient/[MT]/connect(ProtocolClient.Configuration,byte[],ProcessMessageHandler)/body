{
  if (configuration == null) {
    throw MESSAGES.nullVar("configuration");
  }
  if (authCode == null) {
    throw MESSAGES.nullVar("authCode");
  }
  if (messageHandler == null) {
    throw MESSAGES.nullVar("messageHandler");
  }
  configuration.setMessageHandler(new MessageHandler(){
    public void handleMessage(    final Connection connection,    final InputStream dataStream) throws IOException {
      final ProcessControllerClient client=(ProcessControllerClient)connection.getAttachment();
      final int cmd=readUnsignedByte(dataStream);
switch (cmd) {
case Protocol.PROCESS_ADDED:
{
          final String processName=readUTFZBytes(dataStream);
          dataStream.close();
          CLIENT_LOGGER.tracef("Received process_added for process %s",processName);
          messageHandler.handleProcessAdded(client,processName);
          break;
        }
case Protocol.PROCESS_STARTED:
{
        final String processName=readUTFZBytes(dataStream);
        dataStream.close();
        CLIENT_LOGGER.tracef("Received process_started for process %s",processName);
        messageHandler.handleProcessStarted(client,processName);
        break;
      }
case Protocol.PROCESS_STOPPED:
{
      final String processName=readUTFZBytes(dataStream);
      final long uptimeMillis=readLong(dataStream);
      dataStream.close();
      CLIENT_LOGGER.tracef("Received process_stopped for process %s",processName);
      messageHandler.handleProcessStopped(client,processName,uptimeMillis);
      break;
    }
case Protocol.PROCESS_REMOVED:
{
    final String processName=readUTFZBytes(dataStream);
    dataStream.close();
    CLIENT_LOGGER.tracef("Received process_removed for process %s",processName);
    messageHandler.handleProcessRemoved(client,processName);
    break;
  }
case Protocol.PROCESS_INVENTORY:
{
  final int cnt=readInt(dataStream);
  final Map<String,ProcessInfo> inventory=new HashMap<String,ProcessInfo>();
  for (int i=0; i < cnt; i++) {
    final String processName=readUTFZBytes(dataStream);
    final byte[] processAuthCode=new byte[16];
    readFully(dataStream,processAuthCode);
    final boolean processRunning=StreamUtils.readBoolean(dataStream);
    final boolean processStopping=StreamUtils.readBoolean(dataStream);
    inventory.put(processName,new ProcessInfo(processName,processAuthCode,processRunning,processStopping));
  }
  dataStream.close();
  CLIENT_LOGGER.tracef("Received process_inventory");
  messageHandler.handleProcessInventory(client,inventory);
  break;
}
case Protocol.OPERATION_FAILED:
{
final int operationType=readUnsignedByte(dataStream);
final ProcessMessageHandler.OperationType type=ProcessMessageHandler.OperationType.fromCode(operationType);
final String processName=readUTFZBytes(dataStream);
dataStream.close();
CLIENT_LOGGER.tracef("Received operation_failed for process %s",processName);
messageHandler.handleOperationFailed(client,type,processName);
break;
}
default :
{
CLIENT_LOGGER.receivedUnknownMessageCode(Integer.valueOf(cmd));
dataStream.close();
break;
}
}
}
public void handleShutdown(final Connection connection) throws IOException {
final ProcessControllerClient client=(ProcessControllerClient)connection.getAttachment();
messageHandler.handleConnectionShutdown(client);
}
public void handleFailure(final Connection connection,final IOException cause) throws IOException {
final ProcessControllerClient client=(ProcessControllerClient)connection.getAttachment();
messageHandler.handleConnectionFailure(client,cause);
}
public void handleFinished(final Connection connection) throws IOException {
final ProcessControllerClient client=(ProcessControllerClient)connection.getAttachment();
messageHandler.handleConnectionFinished(client);
}
}
);
final ProtocolClient client=new ProtocolClient(configuration);
final Connection connection=client.connect();
boolean ok=false;
try {
final OutputStream os=connection.writeMessage();
try {
os.write(Protocol.AUTH);
os.write(1);
os.write(authCode);
final ProcessControllerClient processControllerClient=new ProcessControllerClient(connection);
connection.attach(processControllerClient);
CLIENT_LOGGER.trace("Sent initial greeting message");
os.close();
ok=true;
return processControllerClient;
}
  finally {
safeClose(os);
}
}
  finally {
if (!ok) {
safeClose(connection);
}
}
}
