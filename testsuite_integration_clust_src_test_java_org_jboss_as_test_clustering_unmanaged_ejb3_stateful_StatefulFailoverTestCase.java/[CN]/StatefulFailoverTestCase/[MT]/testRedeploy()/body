{
  controller.start(CONTAINER_1);
  deployer.deploy(DEPLOYMENT_1);
  DefaultHttpClient client=new DefaultHttpClient();
  String url1="http://127.0.0.1:8080/stateful/count";
  String url2="http://127.0.0.1:8180/stateful/count";
  try {
    assertQueryCount(20010101,client,url1);
    assertQueryCount(20020202,client,url1);
    controller.start(CONTAINER_2);
    deployer.deploy(DEPLOYMENT_2);
    assertQueryCount(20030303,client,url1);
    assertQueryCount(20040404,client,url1);
    assertQueryCount(20050505,client,url2);
    assertQueryCount(20060606,client,url2);
    deployer.undeploy(DEPLOYMENT_2);
    assertQueryCount(20070707,client,url1);
    assertQueryCount(20080808,client,url1);
    deployer.deploy(DEPLOYMENT_2);
    assertQueryCount(20090909,client,url1);
    assertQueryCount(20101010,client,url1);
    assertQueryCount(20111111,client,url2);
    assertQueryCount(20121212,client,url2);
    deployer.undeploy(DEPLOYMENT_1);
    assertQueryCount(20131313,client,url2);
    assertQueryCount(20141414,client,url2);
    deployer.deploy(DEPLOYMENT_1);
    assertQueryCount(20151515,client,url1);
    assertQueryCount(20161616,client,url1);
    assertQueryCount(20171717,client,url2);
    assertQueryCount(20181818,client,url2);
  }
  finally {
    client.getConnectionManager().shutdown();
    this.cleanup(DEPLOYMENT_1,CONTAINER_1);
    this.cleanup(DEPLOYMENT_2,CONTAINER_2);
  }
}
