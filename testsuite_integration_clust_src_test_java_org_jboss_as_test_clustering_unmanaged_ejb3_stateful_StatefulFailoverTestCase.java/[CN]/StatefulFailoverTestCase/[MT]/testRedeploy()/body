{
  controller.start(CONTAINER1);
  deployer.deploy(DEPLOYMENT1);
  DefaultHttpClient client=new DefaultHttpClient();
  String url1="http://127.0.0.1:8080/stateful/count";
  String url2="http://127.0.0.1:8180/stateful/count";
  try {
    assertQueryCount(1,client,url1);
    assertQueryCount(2,client,url1);
    controller.start(CONTAINER2);
    deployer.deploy(DEPLOYMENT2);
    assertQueryCount(3,client,url1);
    assertQueryCount(4,client,url1);
    assertQueryCount(5,client,url2);
    assertQueryCount(6,client,url2);
    deployer.undeploy(DEPLOYMENT2);
    assertQueryCount(7,client,url1);
    assertQueryCount(8,client,url1);
    deployer.deploy(DEPLOYMENT2);
    assertQueryCount(9,client,url1);
    assertQueryCount(10,client,url1);
    assertQueryCount(11,client,url2);
    assertQueryCount(12,client,url2);
    deployer.undeploy(DEPLOYMENT1);
    assertQueryCount(13,client,url2);
    assertQueryCount(14,client,url2);
    deployer.deploy(DEPLOYMENT1);
    assertQueryCount(15,client,url1);
    assertQueryCount(16,client,url1);
    assertQueryCount(17,client,url2);
    assertQueryCount(18,client,url2);
  }
  finally {
    client.getConnectionManager().shutdown();
    this.cleanup(DEPLOYMENT1,CONTAINER1);
    this.cleanup(DEPLOYMENT2,CONTAINER2);
  }
}
