{
  controller.start(CONTAINER1);
  deployer.deploy(DEPLOYMENT1);
  DefaultHttpClient client=new DefaultHttpClient();
  String url1="http://127.0.0.1:8080/stateful/count";
  String url2="http://127.0.0.1:8180/stateful/count";
  try {
    assertEquals(1,this.queryCount(client,url1));
    assertEquals(2,this.queryCount(client,url1));
    controller.start(CONTAINER2);
    deployer.deploy(DEPLOYMENT2);
    Thread.sleep(GRACE_TIME_TO_MEMBERSHIP_CHANGE);
    assertEquals(3,this.queryCount(client,url1));
    assertEquals(4,this.queryCount(client,url1));
    Thread.sleep(GRACE_TIME_TO_REPLICATE);
    assertEquals(5,this.queryCount(client,url2));
    assertEquals(6,this.queryCount(client,url2));
    deployer.undeploy(DEPLOYMENT2);
    Thread.sleep(GRACE_TIME_TO_MEMBERSHIP_CHANGE);
    assertEquals(7,this.queryCount(client,url1));
    assertEquals(8,this.queryCount(client,url1));
    deployer.deploy(DEPLOYMENT2);
    Thread.sleep(GRACE_TIME_TO_MEMBERSHIP_CHANGE);
    assertEquals(9,this.queryCount(client,url1));
    assertEquals(10,this.queryCount(client,url1));
    Thread.sleep(GRACE_TIME_TO_REPLICATE);
    assertEquals(11,this.queryCount(client,url2));
    assertEquals(12,this.queryCount(client,url2));
    deployer.undeploy(DEPLOYMENT1);
    Thread.sleep(GRACE_TIME_TO_MEMBERSHIP_CHANGE);
    assertEquals(13,this.queryCount(client,url2));
    assertEquals(14,this.queryCount(client,url2));
    deployer.deploy(DEPLOYMENT1);
    Thread.sleep(GRACE_TIME_TO_MEMBERSHIP_CHANGE);
    assertEquals(15,this.queryCount(client,url1));
    assertEquals(16,this.queryCount(client,url1));
    Thread.sleep(GRACE_TIME_TO_REPLICATE);
    assertEquals(17,this.queryCount(client,url2));
    assertEquals(18,this.queryCount(client,url2));
  }
  finally {
    client.getConnectionManager().shutdown();
    this.cleanup(DEPLOYMENT1,CONTAINER1);
    this.cleanup(DEPLOYMENT2,CONTAINER2);
  }
}
