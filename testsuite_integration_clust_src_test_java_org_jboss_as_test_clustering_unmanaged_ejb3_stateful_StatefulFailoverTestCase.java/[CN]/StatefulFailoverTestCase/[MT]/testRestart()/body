{
  controller.start(CONTAINER1);
  deployer.deploy(DEPLOYMENT1);
  DefaultHttpClient client=new DefaultHttpClient();
  String url1="http://127.0.0.1:8080/stateful/count";
  String url2="http://127.0.0.1:8180/stateful/count";
  try {
    assertQueryCount(101,client,url1);
    assertQueryCount(202,client,url1);
    controller.start(CONTAINER2);
    deployer.deploy(DEPLOYMENT2);
    assertQueryCount(303,client,url1);
    assertQueryCount(404,client,url1);
    assertQueryCount(505,client,url2);
    assertQueryCount(606,client,url2);
    controller.stop(CONTAINER2);
    assertQueryCount(707,client,url1);
    assertQueryCount(808,client,url1);
    controller.start(CONTAINER2);
    assertQueryCount(909,client,url1);
    assertQueryCount(1010,client,url1);
    assertQueryCount(1111,client,url2);
    assertQueryCount(1212,client,url2);
    controller.stop(CONTAINER1);
    assertQueryCount(1313,client,url2);
    assertQueryCount(1414,client,url2);
    controller.start(CONTAINER1);
    assertQueryCount(1515,client,url1);
    assertQueryCount(1616,client,url1);
    assertQueryCount(1717,client,url1);
    assertQueryCount(1818,client,url1);
  }
  finally {
    client.getConnectionManager().shutdown();
    this.cleanup(DEPLOYMENT1,CONTAINER1);
    this.cleanup(DEPLOYMENT2,CONTAINER2);
  }
}
