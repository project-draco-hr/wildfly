{
  if (closed.get()) {
    throw new IllegalStateException();
  }
synchronized (this) {
    if (isConnected()) {
      return connection;
    }
    connection=client.connectSync(callbackHandler,Collections.<String,String>emptyMap(),null);
    connection.addCloseHandler(new CloseHandler<Connection>(){
      @Override public void handleClose(      Connection old,      IOException exception){
synchronized (DomainTestConnection.this) {
          if (connection == old) {
            connection=null;
          }
          DomainTestConnection.this.notifyAll();
        }
      }
    }
);
    return connection;
  }
}
