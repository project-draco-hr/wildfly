{
  ClassLoader loader=Thread.currentThread().getContextClassLoader();
  try {
    NamingEnumeration<?> ne=ctx.list("");
    while (ne.hasMore()) {
      NameClassPair pair=(NameClassPair)ne.next();
      String name=pair.getName();
      String className=pair.getClassName();
      boolean recursive=false;
      boolean isLinkRef=false;
      boolean isProxy=false;
      Class<?> c=null;
      try {
        c=loader.loadClass(className);
        if (Context.class.isAssignableFrom(c))         recursive=true;
        if (LinkRef.class.isAssignableFrom(c))         isLinkRef=true;
        isProxy=Proxy.isProxyClass(c);
      }
 catch (      ClassNotFoundException cnfe) {
        if (className.startsWith("$Proxy")) {
          isProxy=true;
          try {
            Object p=ctx.lookup(name);
            c=p.getClass();
          }
 catch (          NamingException e) {
            Throwable t=e.getRootCause();
            if (t instanceof ClassNotFoundException) {
              String msg=t.getMessage();
              if (msg != null) {
                className=msg;
              }
            }
          }
        }
      }
      buffer.append(indent + " +- " + name);
      if (isLinkRef) {
        try {
          Object obj=ctx.lookupLink(name);
          LinkRef link=(LinkRef)obj;
          buffer.append("[link -> ");
          buffer.append(link.getLinkName());
          buffer.append(']');
        }
 catch (        Throwable t) {
          buffer.append("invalid]");
        }
      }
      if (isProxy) {
        buffer.append(" (proxy: " + pair.getClassName());
        if (c != null) {
          Class<?>[] ifaces=c.getInterfaces();
          buffer.append(" implements ");
          for (int i=0; i < ifaces.length; i++) {
            buffer.append(ifaces[i]);
            buffer.append(',');
          }
          buffer.setCharAt(buffer.length() - 1,')');
        }
 else {
          buffer.append(" implements " + className + ")");
        }
      }
 else       if (verbose) {
        buffer.append(" (class: " + pair.getClassName() + ")");
      }
      buffer.append('\n');
      if (recursive) {
        try {
          Object value=ctx.lookup(name);
          if (value instanceof Context) {
            Context subctx=(Context)value;
            list(subctx,indent + " |  ",buffer,verbose);
          }
 else {
            buffer.append(indent + " |   NonContext: " + value);
            buffer.append('\n');
          }
        }
 catch (        Throwable t) {
          buffer.append("Failed to lookup: " + name + ", errmsg="+ t.getMessage());
          buffer.append('\n');
        }
      }
    }
    ne.close();
  }
 catch (  NamingException ne) {
    buffer.append("error while listing context " + ctx.toString() + ": "+ ne.toString(true));
    formatException(buffer,ne);
  }
}
