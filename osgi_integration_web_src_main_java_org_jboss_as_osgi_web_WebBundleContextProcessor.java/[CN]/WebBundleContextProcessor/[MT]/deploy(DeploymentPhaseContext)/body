{
  DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  WarMetaData warMetaData=depUnit.getAttachment(WarMetaData.ATTACHMENT_KEY);
  OSGiMetaData metadata=depUnit.getAttachment(OSGiConstants.OSGI_METADATA_KEY);
  if (warMetaData == null || metadata == null)   return;
  FilterMetaData filterMetaData=new FilterMetaData();
  filterMetaData.setFilterClass(WebBundleContextFilter.class.getName());
  filterMetaData.setFilterName("Filter forbidden resources");
  FilterMappingMetaData filterMappingMetaData=new FilterMappingMetaData();
  filterMappingMetaData.setFilterName(filterMetaData.getName());
  filterMappingMetaData.setUrlPatterns(Arrays.asList("/OSGI-INF/*","/OSGI-OPT/*"));
  JBossWebMetaData jbossWebMetaData=warMetaData.getMergedJBossWebMetaData();
  FiltersMetaData filters=jbossWebMetaData.getFilters();
  if (filters == null) {
    filters=new FiltersMetaData();
    jbossWebMetaData.setFilters(filters);
  }
  filters.add(filterMetaData);
  List<FilterMappingMetaData> filterMappings=jbossWebMetaData.getFilterMappings();
  if (filterMappings == null) {
    filterMappings=new ArrayList<FilterMappingMetaData>();
    jbossWebMetaData.setFilterMappings(filterMappings);
  }
  filterMappings.add(filterMappingMetaData);
}
