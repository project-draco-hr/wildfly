{
  ManagementOperationHandler operationHandler=getOperationHandler(header);
  FlushableDataOutputImpl output;
  try {
    output=FlushableDataOutputImpl.create(getChannel().writeMessage());
  }
 catch (  IOException e) {
    throw new IOException("Error handling " + header.getRequestId(),e);
  }
  try {
    expectHeader(input,ManagementProtocol.REQUEST_OPERATION);
    ManagementRequestHandler requestHandler=getRequestHandler(operationHandler,input);
    expectHeader(input,ManagementProtocol.REQUEST_START);
    expectHeader(input,ManagementProtocol.REQUEST_BODY);
    requestHandler.setChannel(getChannel());
    requestHandler.readRequest(input);
    expectHeader(input,ManagementProtocol.REQUEST_END);
    writeResponseHeader(header,output);
    output.writeByte(ManagementProtocol.RESPONSE_START);
    output.writeByte(ManagementProtocol.RESPONSE_BODY);
    requestHandler.writeResponse(output);
    output.writeByte(ManagementProtocol.RESPONSE_END);
  }
 catch (  Exception e) {
    e.printStackTrace();
    if (e instanceof IOException) {
      throw (IOException)e;
    }
    throw new IOException(e);
  }
 finally {
    IoUtils.safeClose(output);
  }
}
