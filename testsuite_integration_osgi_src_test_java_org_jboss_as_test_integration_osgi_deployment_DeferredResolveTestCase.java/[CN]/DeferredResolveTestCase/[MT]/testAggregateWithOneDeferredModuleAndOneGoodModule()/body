{
  deployer.deploy(DEFERRED_AGGREGATE_B);
  try {
    Bundle bundleA=packageAdmin.getBundles(DEFERRED_BUNDLE_A,null)[0];
    Assert.assertEquals("Bundle INSTALLED",Bundle.INSTALLED,bundleA.getState());
    deployer.deploy(DEFERRED_BUNDLE_B);
    try {
      Bundle bundleB=packageAdmin.getBundles(DEFERRED_BUNDLE_B,null)[0];
      Assert.assertEquals("Bundle INSTALLED",Bundle.INSTALLED,bundleA.getState());
      Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundleB.getState());
      packageAdmin.resolveBundles(new Bundle[]{bundleA});
      Assert.assertEquals("Bundle RESOLVED",Bundle.RESOLVED,bundleA.getState());
      Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundleB.getState());
      bundleA.start();
      Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundleA.getState());
    }
  finally {
      deployer.undeploy(DEFERRED_BUNDLE_B);
    }
  }
  finally {
    deployer.undeploy(DEFERRED_AGGREGATE_B);
  }
}
