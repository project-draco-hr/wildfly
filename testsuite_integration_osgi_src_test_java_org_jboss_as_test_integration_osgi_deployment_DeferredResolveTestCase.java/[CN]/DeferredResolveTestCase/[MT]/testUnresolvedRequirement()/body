{
  deployer.deploy(DEFERRED_BUNDLE_A);
  try {
    Bundle bundleA=context.getBundle(DEFERRED_BUNDLE_A);
    Assert.assertEquals("Bundle INSTALLED",Bundle.INSTALLED,bundleA.getState());
    deployer.deploy(DEFERRED_BUNDLE_B);
    try {
      Bundle bundleB=context.getBundle(DEFERRED_BUNDLE_B);
      Assert.assertEquals("Bundle INSTALLED",Bundle.INSTALLED,bundleA.getState());
      Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundleB.getState());
      FrameworkWiring frameworkWiring=context.getBundle().adapt(FrameworkWiring.class);
      frameworkWiring.resolveBundles(Arrays.asList(bundleA));
      Assert.assertEquals("Bundle RESOLVED",Bundle.RESOLVED,bundleA.getState());
      Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundleB.getState());
      bundleA.start();
      Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundleA.getState());
    }
  finally {
      deployer.undeploy(DEFERRED_BUNDLE_B);
    }
  }
  finally {
    deployer.undeploy(DEFERRED_BUNDLE_A);
  }
}
