{
  final InputStream socketIn=socketConnection.getInputStream();
  final OutputStream socketOut=socketConnection.getOutputStream();
  try {
    final SimpleDataInput input=new SimpleDataInput(Marshalling.createByteInput(socketIn));
    final SimpleDataOutput output=new SimpleDataOutput(Marshalling.createByteOutput(socketOut));
    final ManagementRequestProtocolHeader requestHeader=new ManagementRequestProtocolHeader(input);
    int workingVersion=Math.min(ManagementProtocol.VERSION,requestHeader.getVersion());
    final ManagementResponseProtocolHeader responseHeader=new ManagementResponseProtocolHeader(workingVersion,requestHeader.getRequestId());
    responseHeader.write(output);
    output.flush();
    byte handlerId=requestHeader.getOperationHandlerId();
    if (handlerId == -1) {
      throw new ManagementOperationException("Management request failed.  Invalid handler id");
    }
    final ManagementOperationHandler handler=handlers.get(handlerId);
    if (handler == null) {
      throw new ManagementOperationException("Management request failed.  NO handler found for id" + handlerId);
    }
    handler.handleRequest(workingVersion,input,output);
  }
 catch (  Exception e) {
    log.error("Failed to process management request",e);
  }
 finally {
    socketConnection.close();
  }
}
