{
  try {
    final ByteDataInput input=new SimpleByteDataInput(socketConnection.getInputStream());
    final ByteDataOutput output=new SimpleByteDataOutput(socketConnection.getOutputStream());
    final ManagementRequestHeader requestHeader=new ManagementRequestHeader(input);
    int workingVersion=Math.min(ManagementProtocol.VERSION,requestHeader.getVersion());
    final ManagementResponseHeader responseHeader=new ManagementResponseHeader(workingVersion,requestHeader.getRequestId());
    responseHeader.write(output);
    output.flush();
    byte handlerId=requestHeader.getOperationHandlerId();
    if (handlerId == -1) {
      throw new ManagementException("Management request failed.  Invalid handler id");
    }
    final ManagementOperationHandler handler=handlers.get(handlerId);
    if (handler == null) {
      throw new ManagementException("Management request failed.  NO handler found for id" + handlerId);
    }
    handler.handleRequest(workingVersion,input,output);
  }
 catch (  Exception e) {
    log.error("Failed to process management request",e);
  }
 finally {
    socketConnection.close();
  }
}
