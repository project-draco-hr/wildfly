{
  final PathAddress address=PathAddress.pathAddress(operation.get(OP_ADDR));
  final PathAddress parent=address.subAddress(0,address.size() - 1);
  final String name=address.getLastElement().getValue();
  List<String> aliases=HostDefinition.ALIAS.unwrap(context,model);
  String defaultWebModule=HostDefinition.DEFAULT_WEB_MODULE.resolveModelAttribute(context,model).asString();
  Resource resource=context.readResource(PathAddress.EMPTY_ADDRESS);
  Resource accessLog=resource.getChild(UndertowExtension.PATH_ACCESS_LOG);
  final String serverName=parent.getLastElement().getValue();
  final ServiceName virtualHostServiceName=UndertowService.virtualHostName(serverName,name);
  final ServiceName accessLogServiceName=UndertowService.accessLogServiceName(serverName,name);
  Host service=new Host(name,aliases == null ? new LinkedList<String>() : aliases,defaultWebModule);
  final ServiceBuilder<Host> builder=context.getServiceTarget().addService(virtualHostServiceName,service).addDependency(UndertowService.SERVER.append(serverName),Server.class,service.getServerInjection()).addDependency(UndertowService.UNDERTOW,UndertowService.class,service.getUndertowService()).addDependency(accessLog != null ? REQUIRED : OPTIONAL,accessLogServiceName,AccessLogService.class,service.getAccessLogService());
  builder.addListener(verificationHandler);
  builder.setInitialMode(Mode.ON_DEMAND);
  final ServiceController<WebHost> commonController=addCommonHost(context,verificationHandler,name,aliases,serverName,virtualHostServiceName,parent);
  final ServiceController<Host> serviceController=builder.install();
  final ServiceName consoleRedirectName=UndertowService.consoleRedirectServiceName(serverName,name);
  final ServiceController<ConsoleRedirectService> consoleServiceServiceController;
  if (context.getProcessType() == ProcessType.STANDALONE_SERVER) {
    final ConsoleRedirectService redirectService=new ConsoleRedirectService();
    final ServiceBuilder<ConsoleRedirectService> redirectBuilder=context.getServiceTarget().addService(consoleRedirectName,redirectService).addDependency(UndertowHttpManagementService.SERVICE_NAME,HttpManagement.class,redirectService.getHttpManagementInjector()).addDependency(virtualHostServiceName,Host.class,redirectService.getHostInjector()).setInitialMode(Mode.PASSIVE);
    consoleServiceServiceController=redirectBuilder.install();
  }
 else {
    final ConsoleRedirectService redirectService=new ConsoleRedirectService();
    final ServiceBuilder<ConsoleRedirectService> redirectBuilder=context.getServiceTarget().addService(consoleRedirectName,redirectService).addDependency(virtualHostServiceName,Host.class,redirectService.getHostInjector()).setInitialMode(Mode.PASSIVE);
    consoleServiceServiceController=redirectBuilder.install();
  }
  if (newControllers != null) {
    newControllers.add(serviceController);
    newControllers.add(consoleServiceServiceController);
    newControllers.add(commonController);
  }
}
