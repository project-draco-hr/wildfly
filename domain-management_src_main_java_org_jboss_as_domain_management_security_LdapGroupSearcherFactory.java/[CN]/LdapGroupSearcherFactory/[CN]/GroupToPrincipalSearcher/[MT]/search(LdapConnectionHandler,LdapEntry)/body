{
  SearchControls searchControls=createSearchControl(recursive,attributeArray);
  Set<LdapEntry> foundEntries=new HashSet<LdapEntry>();
  LdapConnectionHandler connectionHandler=originalConnectionHandler;
  URI referralAddress=null;
  if ((referralAddress=entry.getReferralUri()) != null && preferOriginalConnection == false) {
    connectionHandler=connectionHandler.findForReferral(referralAddress);
    if (connectionHandler == null) {
      SECURITY_LOGGER.tracef("Unable to obtain connection handler for referral URI %s",referralAddress);
      return foundEntries.toArray(new LdapEntry[foundEntries.size()]);
    }
  }
 else {
    referralAddress=null;
  }
  Object[] searchParameter=getSearchParameter(entry);
  boolean trace=SECURITY_LOGGER.isTraceEnabled();
  if (trace) {
    SECURITY_LOGGER.tracef("Performing search baseDn=%s, filterString=%s, searchParameter=%s",baseDn,filterString,Arrays.toString(searchParameter));
  }
  NamingEnumeration<SearchResult> searchResults=connectionHandler.getConnection().search(baseDn,filterString,searchParameter,searchControls);
  if (trace && searchResults.hasMore() == false) {
    SECURITY_LOGGER.trace("No search results found.");
  }
  while (searchResults.hasMore()) {
    SearchResult current=searchResults.next();
    Attributes attributes=current.getAttributes();
    if (attributes != null) {
      LdapEntry newEntry=convertToLdapEntry(current,attributes,referralAddress);
      SECURITY_LOGGER.tracef("Adding %s",newEntry);
      foundEntries.add(newEntry);
    }
 else {
      SECURITY_LOGGER.tracef("No attributes found for %s",current);
    }
  }
  return foundEntries.toArray(new LdapEntry[foundEntries.size()]);
}
