{
  try {
    JPA_LOGGER.startingService("Persistence Unit",pu.getScopedPersistenceUnitName());
    pu.setTempClassLoaderFactory(new TempClassLoaderFactoryImpl(classLoader));
    pu.setJtaDataSource(jtaDataSource.getOptionalValue());
    pu.setNonJtaDataSource(nonJtaDataSource.getOptionalValue());
    WritableServiceBasedNamingStore.pushOwner(context.getController().getServiceContainer().subTarget());
    this.entityManagerFactory=createContainerEntityManagerFactory();
  }
  finally {
    pu.setTempClassLoaderFactory(null);
    WritableServiceBasedNamingStore.popOwner();
  }
}
