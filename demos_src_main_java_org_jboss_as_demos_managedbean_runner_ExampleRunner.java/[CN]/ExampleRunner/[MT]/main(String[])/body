{
  DeploymentUtils utils=null;
  try {
    EnterpriseArchive ear=ShrinkWrap.create(EnterpriseArchive.class,"managedbean-example.ear");
    JavaArchive sar=ShrinkWrap.create(JavaArchive.class,"managedbean-mbean.sar");
    sar.addManifestResource("archives/managedbean-mbean.sar/META-INF/MANIFEST.MF","MANIFEST.MF");
    sar.addManifestResource("archives/managedbean-mbean.sar/META-INF/jboss-service.xml","jboss-service.xml");
    sar.addPackage(TestMBean.class.getPackage());
    ear.add(sar,"/");
    JavaArchive jar=ShrinkWrap.create(JavaArchive.class,"managedbean-example.jar");
    jar.addManifestResource("archives/managedbean-example.jar/META-INF/MANIFEST.MF","MANIFEST.MF");
    jar.addManifestResource("archives/managedbean-example.jar/META-INF/services/org.jboss.msc.service.ServiceActivator","services/org.jboss.msc.service.ServiceActivator");
    jar.addManifestResource(EmptyAsset.INSTANCE,"beans.xml");
    jar.addPackage(SimpleManagedBean.class.getPackage());
    ear.add(jar,"/");
    utils=new DeploymentUtils(ear);
    utils.deploy();
    ObjectName objectName=new ObjectName("jboss:name=test,type=managedbean");
    MBeanServerConnection mbeanServer=utils.getConnection();
    System.out.println("Calling echo(\"Hello\")");
    Object o=mbeanServer.invoke(objectName,"echo",new Object[]{"Hello"},new String[]{"java.lang.String"});
    System.out.println("echo returned " + o);
  }
  finally {
    utils.undeploy();
    safeClose(utils);
  }
}
