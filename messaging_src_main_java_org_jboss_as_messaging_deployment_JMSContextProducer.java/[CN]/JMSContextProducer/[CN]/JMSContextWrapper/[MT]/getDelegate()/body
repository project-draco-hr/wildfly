{
  if (delegate == null) {
    Context ctx=null;
    try {
      ctx=new InitialContext();
      TransactionSynchronizationRegistry registry=(TransactionSynchronizationRegistry)ctx.lookup(TRANSACTION_SYNCHRONIZATION_REGISTRY_LOOKUP);
      boolean inTx=registry.getTransactionStatus() == Status.STATUS_ACTIVE;
      delegate=create(info,inTx,ctx);
      if (inTx) {
        registry.registerInterposedSynchronization(new Synchronization(){
          @Override public void beforeCompletion(){
          }
          @Override public synchronized void afterCompletion(          int status){
            delegate.close();
            delegate=null;
            inTransaction=false;
          }
        }
);
      }
    }
 catch (    Exception e) {
      throw new RuntimeException(e);
    }
 finally {
      if (ctx != null) {
        try {
          ctx.close();
        }
 catch (        NamingException e) {
        }
      }
    }
  }
  return delegate;
}
