{
  if (cumulativeID == null) {
    throw new IllegalStateException();
  }
  IoUtils.mkdir(structure.getInstallationInfo().getParentFile());
  final List<String> consolidate=new ArrayList<String>();
  consolidate.addAll(patches);
  if (!Constants.BASE.equals(cumulativeID)) {
    consolidate.add(cumulativeID);
  }
  if (structure.getModuleRoot() != null) {
    final File overlays=new File(structure.getModuleRoot(),Constants.OVERLAYS);
    final File refs=new File(overlays,Constants.OVERLAYS);
    PatchUtils.writeRefs(refs,consolidate);
  }
  properties.put(Constants.CUMULATIVE,cumulativeID);
  properties.put(Constants.PATCHES,PatchUtils.asString(patches));
  PatchUtils.writeProperties(structure.getInstallationInfo(),properties);
}
