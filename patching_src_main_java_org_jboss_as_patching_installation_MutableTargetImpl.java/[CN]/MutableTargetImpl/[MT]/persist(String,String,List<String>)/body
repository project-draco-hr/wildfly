{
  if (releaseID == null || cumulativeID == null) {
    throw new IllegalStateException();
  }
  IoUtils.mkdir(structure.getInstallationInfo().getParentFile());
  final List<String> consolidate=new ArrayList<String>();
  consolidate.addAll(patches);
  if (!Constants.BASE.equals(cumulativeID)) {
    consolidate.add(cumulativeID);
  }
  if (!Constants.BASE.equals(releaseID)) {
    consolidate.add(releaseID);
  }
  if (structure.getModuleRoot() != null) {
    final File overlays=new File(structure.getModuleRoot(),Constants.PATCHES);
    final File refs=new File(overlays,Constants.PATCHES);
    PatchUtils.writeRefs(refs,consolidate);
  }
  properties.put(Constants.RELEASE_PATCH_ID,releaseID);
  properties.put(Constants.CUMULATIVE,cumulativeID);
  properties.put(Constants.PATCHES,PatchUtils.asString(patches));
  PatchUtils.writeProperties(structure.getInstallationInfo(),properties);
}
