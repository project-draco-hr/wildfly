{
  deployer.deploy(STOMPLET_SERVER_PROVIDER);
  Long providerId=getBundleId(STOMPLET_SERVER_PROVIDER,null);
  Assert.assertNotNull("Bundle installed",providerId);
  Assert.assertTrue("Bundle started",bundleStart(providerId));
  Long stompletId=getBundleId(STOMPLET_NAME,null);
  Assert.assertNotNull("Bundle installed",stompletId);
  Assert.assertTrue("Bundle started",bundleStart(stompletId));
  StompClient client=new StompClient("stomp://" + url.getHost());
  client.connect();
  final Set<String> outbound=new HashSet<String>();
  final CountDownLatch outboundLatch=new CountDownLatch(2);
  SubscriptionBuilder builder=client.subscribe(DESTINATION_QUEUE_ONE);
  builder.withMessageHandler(new MessageHandler(){
    public void handle(    StompMessage message){
      String content=message.getContentAsString();
      outbound.add(content);
      outboundLatch.countDown();
    }
  }
);
  ClientSubscription subscription=builder.start();
  client.send(StompMessages.createStompMessage(DESTINATION_QUEUE_ONE,"msg1"));
  client.send(StompMessages.createStompMessage(DESTINATION_QUEUE_ONE,"msg2"));
  Assert.assertTrue("No latch timeout",outboundLatch.await(10,TimeUnit.SECONDS));
  Assert.assertTrue("Contains msg1",outbound.contains("msg1"));
  Assert.assertTrue("Contains msg2",outbound.contains("msg2"));
  subscription.unsubscribe();
  client.disconnect();
  deployer.undeploy(STOMPLET_SERVER_PROVIDER);
}
