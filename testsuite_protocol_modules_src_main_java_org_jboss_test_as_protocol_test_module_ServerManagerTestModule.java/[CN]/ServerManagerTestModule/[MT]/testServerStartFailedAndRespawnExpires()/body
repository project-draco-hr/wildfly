{
  setDomainConfigDir("standard");
  TestProcessHandlerFactory processHandlerFactory=new TestProcessHandlerFactory(true,false);
  final TestProcessManager pm=TestProcessManager.create(processHandlerFactory,InetAddress.getLocalHost(),0);
  pm.pollAddedProcess(3);
  pm.pollStartedProcess(3);
  MockServerProcess svr1=assertGetServer(processHandlerFactory,"Server:server-one");
  MockServerProcess svr2=assertGetServer(processHandlerFactory,"Server:server-two");
  sendMessageToServerManager(ServerToServerManagerProtocolCommand.SERVER_AVAILABLE,svr1,svr2);
  Assert.assertEquals("server-one",assertReadStartCommand(svr1).getServerName());
  Assert.assertEquals("server-two",assertReadStartCommand(svr2).getServerName());
  managerAlive(svr1.getSmAddress(),svr1.getSmPort());
  managerAlive(svr1.getPmAddress(),svr1.getPmPort());
  svr2.sendMessageToManager(ServerToServerManagerProtocolCommand.SERVER_STARTED);
  final int addCount=pm.getAddCount();
  final int removeCount=pm.getRemoveCount();
  int stopCount=pm.getStopCount();
  int startCount=pm.getStartCount();
  for (int i=0; i <= 14; i++) {
    svr1.sendMessageToManager(ServerToServerManagerProtocolCommand.SERVER_START_FAILED);
    pm.pollStoppedProcess(1);
    Assert.assertEquals(++stopCount,pm.getStopCount());
    if (i < 14) {
      pm.pollStartedProcess(1);
      Assert.assertEquals(++startCount,pm.getStartCount());
      svr1=assertGetServer(processHandlerFactory,"Server:server-one");
      svr1.sendMessageToManager(ServerToServerManagerProtocolCommand.SERVER_AVAILABLE);
      Assert.assertEquals("server-one",assertReadStartCommand(svr1).getServerName());
      Assert.assertEquals(addCount,pm.getAddCount());
      Assert.assertEquals(removeCount,pm.getRemoveCount());
    }
  }
  pm.pollRemovedProcess(1);
  Assert.assertEquals(removeCount + 1,pm.getRemoveCount());
  shutdownProcessManagerNoWait(pm);
}
