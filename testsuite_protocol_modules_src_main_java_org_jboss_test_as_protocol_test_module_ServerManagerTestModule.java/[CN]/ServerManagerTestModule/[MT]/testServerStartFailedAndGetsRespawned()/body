{
  setDomainConfigDir("standard");
  TestProcessHandlerFactory processHandlerFactory=new TestProcessHandlerFactory(true,false);
  final TestProcessManager pm=TestProcessManager.create(processHandlerFactory,InetAddress.getLocalHost(),0);
  pm.pollAddedProcess(3);
  pm.pollStartedProcess(3);
  MockServerProcess svr1=assertGetServer(processHandlerFactory,"Server:server-one");
  MockServerProcess svr2=assertGetServer(processHandlerFactory,"Server:server-two");
  sendMessageToServerManager(ServerManagerProtocolCommand.SERVER_AVAILABLE,svr1,svr2);
  Assert.assertEquals("server-one",assertReadStartCommand(svr1).getServerName());
  Assert.assertEquals("server-two",assertReadStartCommand(svr2).getServerName());
  managerAlive(svr1.getSmAddress(),svr1.getSmPort());
  managerAlive(svr1.getPmAddress(),svr1.getPmPort());
  svr1.sendMessageToManager(ServerManagerProtocolCommand.SERVER_STARTED);
  final int addCount=pm.getAddCount();
  final int removeCount=pm.getRemoveCount();
  int stopCount=pm.getStopCount();
  int startCount=pm.getStartCount();
  for (int i=0; i <= 4; i++) {
    if (i < 4) {
      svr2.sendMessageToManager(ServerManagerProtocolCommand.SERVER_START_FAILED);
      pm.pollStoppedProcess(1);
      pm.pollStartedProcess(1);
      Assert.assertEquals(++stopCount,pm.getStopCount());
      Assert.assertEquals(++startCount,pm.getStartCount());
      svr2=assertGetServer(processHandlerFactory,"Server:server-two");
    }
 else {
      svr2=assertGetServer(processHandlerFactory,"Server:server-two");
      sendMessageToServerManager(ServerManagerProtocolCommand.SERVER_AVAILABLE,svr2);
      Assert.assertEquals("server-two",assertReadStartCommand(svr2).getServerName());
      svr2.sendMessageToManager(ServerManagerProtocolCommand.SERVER_STARTED);
    }
  }
  Assert.assertEquals(addCount,pm.getAddCount());
  Assert.assertEquals(removeCount,pm.getRemoveCount());
  shutdownProcessManagerNoWait(pm);
}
