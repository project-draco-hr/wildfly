{
  NamingEnumeration<SearchResult> searchEnumeration=null;
  try {
    SearchControls searchControls=new SearchControls();
    if (recursive) {
      SECURITY_LOGGER.trace("Performing recursive search");
      searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);
    }
 else {
      SECURITY_LOGGER.trace("Performing single level search");
      searchControls.setSearchScope(SearchControls.ONELEVEL_SCOPE);
    }
    if (usernameLoad == null) {
      searchControls.setReturningAttributes(new String[]{userDnAttribute});
    }
 else {
      searchControls.setReturningAttributes(new String[]{userDnAttribute,usernameLoad});
    }
    searchControls.setTimeLimit(searchTimeLimit);
    Object[] filterArguments=new Object[]{suppliedName};
    String filter=userNameAttribute != null ? "(" + userNameAttribute + "={0})" : advancedFilter;
    SECURITY_LOGGER.tracef("Searching for user '%s' using filter '%s'.",suppliedName,filter);
    searchEnumeration=connectionHandler.getConnection().search(baseDn,filter,filterArguments,searchControls);
    try {
      if (searchEnumeration.hasMore() == false) {
        SECURITY_LOGGER.tracef("User '%s' not found in directory.",suppliedName);
        throw MESSAGES.userNotFoundInDirectory(suppliedName);
      }
    }
 catch (    LdapReferralException e) {
      Object into=e.getReferralInfo();
      Object resolved=e.getResolvedObj();
      Context context=e.getReferralContext();
      System.out.println("Had a referral.");
    }
    String distinguishedUserDN=null;
    String username=usernameLoad == null ? suppliedName : null;
    SearchResult result=searchEnumeration.next();
    Attributes attributes=result.getAttributes();
    if (attributes != null) {
      Attribute dn=attributes.get(userDnAttribute);
      if (dn != null) {
        distinguishedUserDN=(String)dn.get();
      }
      if (usernameLoad != null) {
        Attribute usernameAttr=attributes.get(usernameLoad);
        if (usernameAttr != null) {
          username=(String)usernameAttr.get();
          SECURITY_LOGGER.tracef("Converted username '%s' to '%s'",suppliedName,username);
        }
      }
    }
    if (distinguishedUserDN == null) {
      if (result.isRelative() == true) {
        distinguishedUserDN=result.getName() + ("".equals(baseDn) ? "" : "," + baseDn);
      }
 else {
        String name=result.getName();
        SECURITY_LOGGER.tracef("Can't follow referral for authentication: %s",name);
        throw MESSAGES.nameNotFound(suppliedName);
      }
    }
    if (username == null) {
      throw MESSAGES.usernameNotLoaded(suppliedName);
    }
    SECURITY_LOGGER.tracef("DN '%s' found for user '%s'",distinguishedUserDN,username);
    return new LdapEntry(username,distinguishedUserDN);
  }
  finally {
    if (searchEnumeration != null) {
      try {
        searchEnumeration.close();
      }
 catch (      Exception ignored) {
      }
    }
  }
}
