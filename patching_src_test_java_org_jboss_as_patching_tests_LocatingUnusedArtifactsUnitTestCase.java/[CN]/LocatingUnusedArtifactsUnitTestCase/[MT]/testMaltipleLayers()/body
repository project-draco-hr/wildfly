{
  final PatchingTestBuilder builder=createDefaultBuilder("layer2","layer1","base");
  final byte[] standaloneHash=new byte[20];
  final byte[] moduleHash=new byte[20];
  final PatchingTestStepBuilder cp1=builder.createStepBuilder();
  cp1.setPatchId("CP1").upgradeIdentity(PRODUCT_VERSION,PRODUCT_VERSION).upgradeElement("base-CP1","base",false).addModuleWithRandomContent("org.jboss.test",moduleHash).getParent().addFileWithRandomContent(standaloneHash,FILE_ONE);
  apply(cp1);
  final PatchingTestStepBuilder cp2=builder.createStepBuilder();
  cp2.setPatchId("CP2").upgradeIdentity(PRODUCT_VERSION,PRODUCT_VERSION).upgradeElement("layer2-CP2","layer2",false).addModuleWithRandomContent("org.jboss.test",null).getParent().upgradeElement("layer1-CP2","layer1",false).addModuleWithRandomContent("org.jboss.test",null).getParent().updateFileWithRandomContent(Arrays.copyOf(standaloneHash,standaloneHash.length),standaloneHash,FILE_ONE);
  apply(cp2);
  final PatchingTestStepBuilder cp3=builder.createStepBuilder();
  cp3.setPatchId("CP3").upgradeIdentity(PRODUCT_VERSION,PRODUCT_VERSION).removeFile(Arrays.copyOf(standaloneHash,standaloneHash.length),FILE_ONE);
  apply(cp3);
  final Context ctx=getContext(false);
  removeRollbackXml(ctx,"CP3");
  PatchingGarbageLocator garbageLocator=new PatchingGarbageLocator(ctx.getInstallationManager());
  final List<File> inactiveHistory=garbageLocator.getInactiveHistory();
  List<String> inactivePaths=Arrays.asList(new String[]{getExpectedHistoryDir(ctx,"CP1"),getExpectedHistoryDir(ctx,"CP2")});
  assertEqualPaths(inactivePaths,inactiveHistory);
  final List<File> inactiveOverlays=garbageLocator.getInactiveOverlays();
  inactivePaths=Arrays.asList(new String[]{getExpectedOverlayDir(ctx,"layer2","CP2"),getExpectedOverlayDir(ctx,"layer1","CP2"),getExpectedOverlayDir(ctx,"base","CP1")});
  assertEqualPaths(inactivePaths,inactiveOverlays);
  garbageLocator.deleteInactiveContent();
  garbageLocator.reset();
  assertTrue(garbageLocator.getInactiveHistory().isEmpty());
  assertTrue(garbageLocator.getInactiveOverlays().isEmpty());
  PatchingHistoryRoot.State history=PatchingHistoryRoot.getInstance().getState(ctx);
  PatchArtifact.State patch=history.getLastAppliedPatch(ctx);
  assertNotNull(patch);
  assertEquals("CP3",patch.getPatchId());
  assertEquals(PatchType.CUMULATIVE,patch.getType());
  assertHistoryExists(getExpectedHistoryDir(ctx,"CP3"),ctx,patch,true,true,false);
  assertNoPrevious(ctx,patch);
}
