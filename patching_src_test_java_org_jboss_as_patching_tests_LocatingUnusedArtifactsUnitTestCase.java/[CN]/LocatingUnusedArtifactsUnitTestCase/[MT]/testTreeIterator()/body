{
  installOneOffCpOneOff();
  final Context ctx=getContext();
  final List<String> historyDirs=new ArrayList<String>();
  final List<String> moduleDirs=new ArrayList<String>();
  final List<String> bundleDirs=new ArrayList<String>();
  PatchingHistoryTree activeDirsHandler=Builder.getInstance().addHandler(PatchHistoryDir.getInstance(),new ArtifactStateHandler<PatchHistoryDir.State>(){
    @Override public void handle(    Context ctx,    PatchHistoryDir.State state){
      historyDirs.add(state.getDirectory().getName());
    }
  }
).addHandler(PatchElementProviderArtifact.getInstance(),new ArtifactStateHandler<PatchElementProviderArtifact.State>(){
    @Override public void handle(    Context ctx,    PatchElementProviderArtifact.State state){
      if (state.getBundlesDir() != null) {
        bundleDirs.add(state.getBundlesDir().getName());
      }
      if (state.getModulesDir() != null) {
        moduleDirs.add(state.getModulesDir().getName());
      }
    }
  }
).build();
  final TreeIterator tree=activeDirsHandler.treeIterator(ctx);
  assertTrue(tree.hasNext());
  assertTrue(historyDirs.isEmpty());
  assertTrue(moduleDirs.isEmpty());
  assertTrue(bundleDirs.isEmpty());
  tree.handleNext();
  assertTrue(historyDirs.contains("oneOff2"));
  assertTrue(moduleDirs.isEmpty());
  assertTrue(bundleDirs.isEmpty());
  assertTrue(tree.hasNext());
  tree.handleNext();
  assertEquals(1,historyDirs.size());
  assertTrue(moduleDirs.contains("base-oneOff2"));
  assertTrue(bundleDirs.isEmpty());
  assertTrue(tree.hasNext());
  tree.handleNext();
  assertTrue(historyDirs.contains("cp1"));
  assertEquals(1,moduleDirs.size());
  assertTrue(bundleDirs.isEmpty());
  assertTrue(tree.hasNext());
  tree.handleNext();
  assertEquals(2,historyDirs.size());
  assertTrue(moduleDirs.contains("base-cp1"));
  assertTrue(bundleDirs.isEmpty());
  assertTrue(tree.hasNext());
  tree.handleNext();
  assertTrue(historyDirs.contains("oneOff1"));
  assertEquals(2,moduleDirs.size());
  assertTrue(bundleDirs.isEmpty());
  assertTrue(tree.hasNext());
  tree.handleNext();
  assertEquals(3,historyDirs.size());
  assertTrue(moduleDirs.contains("base-oneOff1"));
  assertTrue(bundleDirs.isEmpty());
  assertFalse(tree.hasNext());
}
