{
  try {
    PatchConfig patchConfig=parsePatchConfig();
    createTempStructure(patchConfig);
    this.oldStructure=DistributionStructure.Factory.create(patchConfig.getAppliesTo().iterator().next());
    this.newStructure=DistributionStructure.Factory.create(patchConfig.getResultingVersion());
    if (patchConfig.isGenerateByDiff()) {
      analyzeDifferences(patchConfig);
    }
 else {
      prepareDifferences(patchConfig);
    }
    try {
      preparePatchXml(patchConfig);
    }
 catch (    IOException e) {
      throw new RuntimeException("Failed creating patch.xml file",e);
    }
    copyContent();
    ZipUtils.zip(tmp,patchFile);
  }
  finally {
    IoUtils.recursiveDelete(tmp);
  }
}
