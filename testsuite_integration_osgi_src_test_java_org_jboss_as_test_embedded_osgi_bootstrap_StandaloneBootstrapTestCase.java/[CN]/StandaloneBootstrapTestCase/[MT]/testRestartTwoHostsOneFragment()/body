{
  FrameworkFactory factory=new EmbeddedFrameworkFactory();
  Framework framework=factory.newFramework(getFrameworkProperties());
  try {
    framework.start();
    BundleContext syscontext=framework.getBundleContext();
    Bundle hostA=installBundle(syscontext,getHostA());
    Bundle fragA=installBundle(syscontext,getFragmentA());
    Bundle hostB=installBundle(syscontext,getHostB());
    hostB.start();
    Assert.assertEquals(Bundle.INSTALLED,hostA.getState());
    Assert.assertEquals(Bundle.INSTALLED,fragA.getState());
    Assert.assertEquals(Bundle.ACTIVE,hostB.getState());
    framework.stop();
    framework.waitForStop(5000);
    framework.start();
    syscontext=framework.getBundleContext();
    PackageAdmin packageAdmin=getPackageAdmin(syscontext);
    hostA=packageAdmin.getBundles(BUNDLE_A,null)[0];
    fragA=packageAdmin.getBundles(FRAGMENT_A,null)[0];
    hostB=packageAdmin.getBundles(BUNDLE_B,null)[0];
    Assert.assertEquals(Bundle.INSTALLED,hostA.getState());
    Assert.assertEquals(Bundle.INSTALLED,fragA.getState());
    hostB.uninstall();
    fragA.uninstall();
    hostA.uninstall();
  }
  finally {
    framework.stop();
    framework.waitForStop(5000);
  }
}
