{
  PathAddress address=context.getCurrentAddress();
  Resource resource=context.readResource(PathAddress.EMPTY_ADDRESS);
  if (resource.getChildTypes().isEmpty()) {
    context.removeResource(PathAddress.EMPTY_ADDRESS);
  }
 else {
    for (    String childType : resource.getChildTypes()) {
      for (      final Resource.ResourceEntry entry : resource.getChildren(childType)) {
        if (!entry.isRuntime()) {
          PathElement path=entry.getPathElement();
          OperationStepHandler childHandler=context.getResourceRegistration().getOperationHandler(PathAddress.pathAddress(path),ModelDescriptionConstants.REMOVE);
          PathAddress childAddress=address.append(path);
          context.addStep(Util.createRemoveOperation(childAddress),childHandler,OperationContext.Stage.MODEL);
        }
      }
    }
    OperationStepHandler handler=new OperationStepHandler(){
      @Override public void execute(      OperationContext context,      ModelNode operation) throws OperationFailedException {
        Resource resource=context.readResource(PathAddress.EMPTY_ADDRESS);
        if (resource.getChildTypes().isEmpty()) {
          context.removeResource(PathAddress.EMPTY_ADDRESS);
        }
 else {
          context.addStep(operation,this,OperationContext.Stage.MODEL);
        }
      }
    }
;
    context.addStep(operation,handler,OperationContext.Stage.MODEL);
  }
}
