{
  Configuration overrides=new Configuration();
  List<AdditionalDependency> additionalDeps=new LinkedList<AdditionalDependency>();
  processCacheModelNode(model,overrides,additionalDeps);
  PathAddress cacheAddress=PathAddress.pathAddress(operation.get(OP_ADDR));
  PathAddress containerAddress=cacheAddress.subAddress(0,cacheAddress.size() - 1);
  String cacheName=cacheAddress.getLastElement().getValue();
  String containerName=containerAddress.getLastElement().getValue();
  ServiceName containerServiceName=EmbeddedCacheManagerService.getServiceName(containerName);
  ServiceName cacheServiceName=containerServiceName.append(cacheName);
  ServiceName cacheConfigurationServiceName=CacheConfigurationService.getServiceName(containerName,cacheName);
  Resource rootResource=context.getRootResource();
  ModelNode container=rootResource.navigate(containerAddress).getModel();
  String defaultCache=container.require(ModelKeys.DEFAULT_CACHE).asString();
  StartMode startMode=operation.hasDefined(ModelKeys.START) ? StartMode.valueOf(operation.get(ModelKeys.START).asString()) : StartMode.LAZY;
  String jndiName=CacheContainerAdd.getContainerJNDIName(container,containerName);
  final ContextNames.BindInfo bindInfo=ContextNames.bindInfoFor(jndiName);
  CacheConfigurationService.CacheConfigurationHelperImpl helper=new CacheConfigurationService.CacheConfigurationHelperImpl(cacheName);
  ServiceTarget target=context.getServiceTarget();
  CacheConfigurationService cacheConfigurationService=new CacheConfigurationService(cacheName,overrides,helper);
  ServiceBuilder<Configuration> builder1=target.addService(cacheConfigurationServiceName,cacheConfigurationService);
  builder1.addDependency(containerServiceName,CacheContainer.class,helper.getCacheContainerInjector());
  builder1.addDependency(EmbeddedCacheManagerDefaultsService.SERVICE_NAME,EmbeddedCacheManagerDefaults.class,helper.getDefaultsInjector());
  builder1.addDependency(ServiceBuilder.DependencyType.OPTIONAL,TxnServices.JBOSS_TXN_TRANSACTION_MANAGER,TransactionManager.class,helper.getTransactionManagerInjector());
  builder1.addDependency(ServiceBuilder.DependencyType.OPTIONAL,TxnServices.JBOSS_TXN_SYNCHRONIZATION_REGISTRY,TransactionSynchronizationRegistry.class,helper.getTransactionSynchronizationRegistryInjector());
  builder1.addDependency(bindInfo.getBinderServiceName());
  for (  AdditionalDependency dep : additionalDeps) {
    if (dep.hasInjector()) {
      builder1.addDependency(dep.getName(),dep.getType(),dep.getTarget());
    }
 else {
      builder1.addDependency(dep.getName());
    }
  }
  builder1.setInitialMode(ServiceController.Mode.ON_DEMAND);
  if (cacheName.equals(defaultCache)) {
    builder1.addAliases(CacheConfigurationService.getServiceName(containerName,null));
  }
  newControllers.add(builder1.install());
  log.debug("cache configuration service for " + cacheName + " installed for container "+ containerName);
  CacheService<Object,Object> cacheService=new CacheService<Object,Object>(cacheName);
  ServiceBuilder<Cache<Object,Object>> builder2=target.addService(cacheServiceName,cacheService);
  builder2.addDependency(containerServiceName,CacheContainer.class,cacheService.getCacheContainerInjector());
  builder2.addDependency(cacheConfigurationServiceName);
  builder2.setInitialMode(startMode.getMode());
  if (cacheName.equals(defaultCache)) {
    builder2.addAliases(CacheService.getServiceName(containerName,null));
  }
  if (startMode.getMode() == ServiceController.Mode.ACTIVE) {
    builder2.addListener(verificationHandler);
  }
  newControllers.add(builder2.install());
  log.debug("cache service for cache " + cacheName + " installed for container "+ containerName);
}
