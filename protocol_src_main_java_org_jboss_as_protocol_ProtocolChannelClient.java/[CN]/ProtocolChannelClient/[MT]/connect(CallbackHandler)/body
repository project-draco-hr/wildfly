{
  if (connection != null) {
    throw MESSAGES.alreadyConnected();
  }
  OptionMap map=OptionMap.create(SASL_POLICY_NOANONYMOUS,Boolean.FALSE);
  CallbackHandler actualHandler=handler != null ? handler : new AnonymousCallbackHandler();
  WrapperCallbackHandler wrapperHandler=new WrapperCallbackHandler(actualHandler);
  IoFuture<Connection> future=endpoint.connect(uri,map,wrapperHandler);
  try {
    this.connection=future.get();
  }
 catch (  CancellationException e) {
    throw MESSAGES.connectWasCancelled();
  }
catch (  IOException e) {
    throw MESSAGES.couldNotConnect(uri,e);
  }
  return connection;
}
