{
  log.tracef("Install deployment: %s",dep);
  Bundle bundle=null;
  String contextName=DeploymentHolderService.getContextName(dep);
  DeploymentPlanBuilder builder=deploymentManager.newDeploymentPlan();
  try {
    ServiceTarget serviceTarget=serviceContainer.subTarget();
    DeploymentHolderService.addService(serviceTarget,contextName,dep);
    InputStream inputStream=dep.getRoot().openStream();
    builder=builder.add(contextName,inputStream).andDeploy();
    DeploymentPlan plan=builder.build();
    DeploymentAction deployAction=builder.getLastAction();
    executeDeploymentPlan(plan,deployAction);
    ServiceName serviceNameOne=BundleInstallService.getServiceName(contextName);
    ServiceController<BundleInstallService> controllerOne=(ServiceController<BundleInstallService>)serviceContainer.getService(serviceNameOne);
    FutureServiceValue<BundleInstallService> futureOne=new FutureServiceValue<BundleInstallService>(controllerOne);
    BundleInstallService serviceOne=futureOne.get(5,TimeUnit.SECONDS);
    ServiceName serviceNameTwo=serviceOne.getInstalledBundleName();
    ServiceController<Bundle> controllerTwo=(ServiceController<Bundle>)serviceContainer.getService(serviceNameTwo);
    FutureServiceValue<Bundle> futureTwo=new FutureServiceValue<Bundle>(controllerTwo);
    bundle=futureTwo.get(5,TimeUnit.SECONDS);
  }
 catch (  RuntimeException rte) {
    throw rte;
  }
catch (  BundleException ex) {
    throw ex;
  }
catch (  Exception ex) {
    throw new BundleException("Cannot deploy bundle: " + dep,ex);
  }
 finally {
    DeploymentHolderService.removeService(serviceContainer,contextName);
  }
  if (bundle == null)   throw new IllegalStateException("Cannot find bundle: " + contextName);
  return bundle;
}
