{
  final SecurityContext securityContext=exchange.getAttachment(SecurityContext.ATTACHMENT_KEY);
  Subject useSubject=null;
  if (securityContext != null) {
    final Account account=securityContext.getAuthenticatedAccount();
    if (account instanceof SubjectAccount) {
      PrivilegedAction<Subject> copyAction=new PrivilegedAction<Subject>(){
        @Override public Subject run(){
          final Subject subject=((SubjectAccount)account).getSubject();
          final Subject copySubject=new Subject();
          copySubject.getPrincipals().addAll(subject.getPrincipals());
          copySubject.getPrivateCredentials().addAll(subject.getPrivateCredentials());
          copySubject.getPublicCredentials().addAll(subject.getPublicCredentials());
          SocketAddress address=exchange.getConnection().getPeerAddress();
          if (address instanceof InetSocketAddress) {
            copySubject.getPrincipals().add(new InetAddressPrincipal(((InetSocketAddress)address).getAddress()));
          }
          copySubject.getPrincipals().add(new AccessMechanismPrincipal(AccessMechanism.HTTP));
          copySubject.setReadOnly();
          return copySubject;
        }
      }
;
      useSubject=WildFlySecurityManager.isChecking() ? AccessController.doPrivileged(copyAction) : copyAction.run();
    }
  }
  handleRequest(exchange,useSubject);
}
