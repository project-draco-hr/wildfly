{
  StringBuffer sb=new StringBuffer();
  sb.append(scheme);
  sb.append((host == null) ? "" : host);
  if (port != -1) {
    sb.append(':').append(port);
  }
  if (dn != null) {
    sb.append('/').append(urlEncode(dn.getName(),false));
    if ((attributes.size() != 0) || forceScopeRendering || ((scope != SearchScope.OBJECT) || (filter != null) || (extensionList.size() != 0))) {
      sb.append('?');
      boolean isFirst=true;
      for (      String attribute : attributes) {
        if (isFirst) {
          isFirst=false;
        }
 else {
          sb.append(',');
        }
        sb.append(urlEncode(attribute,false));
      }
    }
    if (forceScopeRendering) {
      sb.append('?');
      sb.append(scope.getLdapUrlValue());
    }
 else {
      if ((scope != SearchScope.OBJECT) || (filter != null) || (extensionList.size() != 0)) {
        sb.append('?');
switch (scope) {
case ONELEVEL:
case SUBTREE:
          sb.append(scope.getLdapUrlValue());
        break;
default :
      break;
  }
  if ((filter != null) || ((extensionList.size() != 0))) {
    sb.append("?");
    if (filter != null) {
      sb.append(urlEncode(filter,false));
    }
    if ((extensionList.size() != 0)) {
      sb.append('?');
      boolean isFirst=true;
      if (extensionList.size() != 0) {
        for (        Extension extension : extensionList) {
          if (!isFirst) {
            sb.append(',');
          }
 else {
            isFirst=false;
          }
          if (extension.isCritical) {
            sb.append('!');
          }
          sb.append(urlEncode(extension.type,false));
          if (extension.value != null) {
            sb.append('=');
            sb.append(urlEncode(extension.value,true));
          }
        }
      }
    }
  }
}
}
}
 else {
sb.append('/');
}
return sb.toString();
}
