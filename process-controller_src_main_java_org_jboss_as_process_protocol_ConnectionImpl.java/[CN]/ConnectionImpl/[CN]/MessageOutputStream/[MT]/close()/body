{
synchronized (lock) {
    if (sender != this) {
      return;
    }
    sender=null;
    lock.notify();
    if (writeDone)     throw ProcessLogger.ROOT_LOGGER.writeChannelClosed();
    if (readDone) {
      readExecutor.execute(new Runnable(){
        @Override public void run(){
          safeHandleFinished();
        }
      }
);
    }
    ProcessLogger.PROTOCOL_CONNECTION_LOGGER.tracef("Sending end of message");
    out.write(ProtocolConstants.CHUNK_END);
  }
}
