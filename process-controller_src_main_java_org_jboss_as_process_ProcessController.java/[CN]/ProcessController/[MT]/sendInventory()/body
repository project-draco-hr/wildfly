{
synchronized (lock) {
    for (    Connection connection : managedConnections) {
      try {
        final OutputStream os=connection.writeMessage();
        try {
          os.write(Protocol.PROCESS_INVENTORY);
          final Collection<ManagedProcess> processCollection=processes.values();
          StreamUtils.writeInt(os,processCollection.size());
          for (          ManagedProcess process : processCollection) {
            StreamUtils.writeUTFZBytes(os,process.getProcessName());
            os.write(process.getAuthKey());
            StreamUtils.writeBoolean(os,process.isRunning());
          }
          os.close();
        }
  finally {
          StreamUtils.safeClose(os);
        }
      }
 catch (      IOException e) {
        ROOT_LOGGER.failedToWriteMessage(" PROCESS_INVENTORY",e);
        removeManagedConnection(connection);
      }
    }
  }
}
