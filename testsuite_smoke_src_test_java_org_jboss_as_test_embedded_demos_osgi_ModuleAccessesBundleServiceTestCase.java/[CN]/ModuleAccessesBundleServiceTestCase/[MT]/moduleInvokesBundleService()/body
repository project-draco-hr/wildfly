{
  JavaArchive apiArchive=getAPIModuleArchive();
  String apiDeploymentName=getRemoteRuntime().deploy(apiArchive);
  assertNotNull("Deployment name not null",apiDeploymentName);
  try {
    registerModule(ModuleIdentifier.create("deployment." + apiDeploymentName));
    OSGiBundle targetBundle=getRemoteRuntime().installBundle(getTargetBundleArchive());
    assertBundleState(Bundle.INSTALLED,targetBundle.getState());
    try {
      targetBundle.start();
      assertBundleState(Bundle.ACTIVE,targetBundle.getState());
      String clientDeploymentName=getRemoteRuntime().deploy(getClientModuleArchive());
      assertNotNull("Deployment name not null",clientDeploymentName);
      try {
        State state=getServiceState(EchoInvokerService.SERVICE_NAME,State.UP,5000);
        assertEquals("EchoInvokerService is UP",State.UP,state);
      }
  finally {
        getRemoteRuntime().undeploy(clientDeploymentName);
      }
    }
  finally {
      targetBundle.uninstall();
    }
  }
  finally {
    getRemoteRuntime().undeploy(apiDeploymentName);
  }
}
