{
  final Map<URL,Index> annotationIndexes=new HashMap<URL,Index>();
  boolean convertVFS=false;
  for (  PersistenceUnitMetadata pu : puHolder.getPersistenceUnits()) {
    String enableVFS=pu.getProperties().getProperty(Configuration.JPA_ENABLE_VFS_URLS);
    if (enableVFS != null && Boolean.parseBoolean(enableVFS) == false) {
      convertVFS=true;
    }
  }
  do {
    for (    ResourceRoot root : DeploymentUtils.allResourceRoots(deploymentUnit)) {
      final Index index=root.getAttachment(Attachments.ANNOTATION_INDEX);
      if (index != null) {
        try {
          JPA_LOGGER.tracef("adding '%s' to annotation index map",root.getRoot().toURL());
          annotationIndexes.put(root.getRoot().toURL(),index);
          if (convertVFS) {
            annotationIndexes.put(root.getRoot().getPhysicalFile().toURI().toURL(),index);
          }
        }
 catch (        MalformedURLException e) {
          throw new RuntimeException(e);
        }
catch (        IOException e) {
          throw new RuntimeException(e);
        }
      }
    }
    deploymentUnit=deploymentUnit.getParent();
  }
 while (deploymentUnit != null);
  for (  PersistenceUnitMetadata pu : puHolder.getPersistenceUnits()) {
    pu.setAnnotationIndex(annotationIndexes);
  }
}
