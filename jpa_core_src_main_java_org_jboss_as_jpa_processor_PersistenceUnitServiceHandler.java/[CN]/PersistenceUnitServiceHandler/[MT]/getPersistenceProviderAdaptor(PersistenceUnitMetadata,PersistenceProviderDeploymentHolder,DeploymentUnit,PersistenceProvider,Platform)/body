{
  String adaptorModule=pu.getProperties().getProperty(Configuration.ADAPTER_MODULE);
  PersistenceProviderAdaptor adaptor=null;
  if (persistenceProviderDeploymentHolder != null) {
    adaptor=persistenceProviderDeploymentHolder.getAdapter();
  }
  if (adaptor == null) {
    adaptor=getPerDeploymentSharedPersistenceProviderAdaptor(deploymentUnit,adaptorModule,provider);
    if (adaptor == null) {
      try {
        if (adaptorModule != null) {
          adaptor=PersistenceProviderAdaptorLoader.loadPersistenceAdapterModule(adaptorModule,platform);
        }
 else {
          adaptor=PersistenceProviderAdaptorLoader.loadPersistenceAdapter(provider,platform);
        }
      }
 catch (      ModuleLoadException e) {
        throw new DeploymentUnitProcessingException("persistence provider adapter module load error " + adaptorModule,e);
      }
      adaptor=savePerDeploymentSharedPersistenceProviderAdaptor(deploymentUnit,adaptorModule,adaptor,provider);
    }
  }
  if (adaptor == null) {
    throw JpaMessages.MESSAGES.failedToGetAdapter(pu.getPersistenceProviderClassName());
  }
  return adaptor;
}
