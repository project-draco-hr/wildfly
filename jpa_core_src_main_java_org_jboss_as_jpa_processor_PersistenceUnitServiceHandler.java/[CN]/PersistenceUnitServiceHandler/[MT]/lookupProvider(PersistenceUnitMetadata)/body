{
  String persistenceProviderModule=pu.getProperties().getProperty(Configuration.PROVIDER_MODULE);
  String persistenceProviderClassName=pu.getPersistenceProviderClassName();
  if (persistenceProviderClassName == null) {
    persistenceProviderClassName=Configuration.PROVIDER_CLASS_DEFAULT;
  }
  if (persistenceProviderModule == null) {
    persistenceProviderModule=Configuration.getProviderModuleNameFromProviderClassName(persistenceProviderClassName);
  }
  PersistenceProvider provider=getProviderByName(pu,persistenceProviderModule);
  if (provider == null) {
    if (persistenceProviderModule != null) {
      try {
        PersistenceProviderLoader.loadProviderModuleByName(persistenceProviderModule);
        provider=getProviderByName(pu,persistenceProviderModule);
      }
 catch (      ModuleLoadException e) {
        throw JpaMessages.MESSAGES.cannotLoadPersistenceProviderModule(e,persistenceProviderModule,persistenceProviderClassName);
      }
    }
  }
  if (provider == null)   throw JpaMessages.MESSAGES.persistenceProviderNotFound(persistenceProviderClassName);
  return provider;
}
