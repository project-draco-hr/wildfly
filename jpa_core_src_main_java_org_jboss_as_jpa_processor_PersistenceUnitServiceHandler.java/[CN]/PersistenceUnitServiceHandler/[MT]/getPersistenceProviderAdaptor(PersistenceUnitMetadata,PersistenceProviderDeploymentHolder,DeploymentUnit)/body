{
  String adaptorModule=pu.getProperties().getProperty(Configuration.ADAPTER_MODULE);
  PersistenceProviderAdaptor adaptor=null;
  if (persistenceProviderDeploymentHolder != null) {
    adaptor=persistenceProviderDeploymentHolder.getAdapter();
  }
  if (adaptor == null) {
    if (adaptorModule == null && (pu.getPersistenceProviderClassName() == null || pu.getPersistenceProviderClassName().equals(Configuration.PROVIDER_CLASS_DEFAULT))) {
      adaptorModule=Configuration.ADAPTER_MODULE_DEFAULT;
    }
    adaptor=getPerDeploymentSharedPersistenceProviderAdaptor(deploymentUnit,adaptorModule);
    if (adaptor == null) {
      try {
        adaptor=PersistenceProviderAdaptorLoader.loadPersistenceAdapterModule(adaptorModule);
      }
 catch (      ModuleLoadException e) {
        throw new DeploymentUnitProcessingException("persistence provider adapter module load error " + adaptorModule,e);
      }
      adaptor=savePerDeploymentSharedPersistenceProviderAdaptor(deploymentUnit,adaptorModule,adaptor);
    }
  }
  if (adaptor == null) {
    throw JpaMessages.MESSAGES.failedToGetAdapter(pu.getPersistenceProviderClassName());
  }
  return adaptor;
}
