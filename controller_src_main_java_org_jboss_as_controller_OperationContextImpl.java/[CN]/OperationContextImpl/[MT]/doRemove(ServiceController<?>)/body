{
  final Step removalStep=activeStep;
  controller.addListener(new AbstractServiceListener<Object>(){
    public void listenerAdded(    final ServiceController<?> controller){
      final Map<ServiceName,ServiceController<?>> map=realRemovingControllers;
synchronized (map) {
        map.put(controller.getName(),controller);
        controller.setMode(ServiceController.Mode.REMOVE);
      }
    }
    public void transition(    final ServiceController<?> controller,    final ServiceController.Transition transition){
switch (transition) {
case REMOVING_to_REMOVED:
case REMOVING_to_DOWN:
{
          final Map<ServiceName,ServiceController<?>> map=realRemovingControllers;
synchronized (map) {
            ServiceName name=controller.getName();
            if (map.get(name) == controller) {
              map.remove(controller.getName());
              removalSteps.put(name,removalStep);
              map.notifyAll();
            }
          }
          break;
        }
    }
  }
}
);
}
