{
  final ApplicationPolicy applicationPolicy=createApplicationPolicy(context,securityDomain,model);
  final JSSESecurityDomain jsseSecurityDomain=createJSSESecurityDomain(context,securityDomain,model);
  final String cacheType=getAuthenticationCacheType(model);
  final SecurityDomainService securityDomainService=new SecurityDomainService(securityDomain,applicationPolicy,jsseSecurityDomain,cacheType);
  final ServiceTarget target=context.getServiceTarget();
  ServiceBuilder<SecurityDomainContext> builder=target.addService(SecurityDomainService.SERVICE_NAME.append(securityDomain),securityDomainService).addDependency(SecurityManagementService.SERVICE_NAME,ISecurityManagement.class,securityDomainService.getSecurityManagementInjector()).addDependency(JaasConfigurationService.SERVICE_NAME,Configuration.class,securityDomainService.getConfigurationInjector());
  if ("infinispan".equals(cacheType)) {
    builder.addDependency(CacheContainerServiceName.CACHE_CONTAINER.getServiceName(CACHE_CONTAINER_NAME),Object.class,securityDomainService.getCacheManagerInjector());
  }
  builder.setInitialMode(ServiceController.Mode.ACTIVE).install();
  final ModelNode elytronRealm=SecurityDomainResourceDefinition.EXPORT_ELYTRON_REALM.resolveModelAttribute(context,model);
  if (elytronRealm.isDefined()) {
    final ServiceName realmServiceName=context.getCapabilityServiceName(Capabilities.SECURITY_REALM_CAPABILITY,elytronRealm.asString(),SecurityRealm.class);
    final DomainContextRealmService domainContextRealmService=new DomainContextRealmService();
    target.addService(realmServiceName,domainContextRealmService).addDependency(SecurityDomainService.SERVICE_NAME.append(securityDomain),SecurityDomainContext.class,domainContextRealmService.getSecurityDomainContextInjector()).setInitialMode(ServiceController.Mode.ACTIVE).install();
  }
}
