{
  log.infof("Activating OSGi Subsystem");
  String value=SystemPropertyActions.getProperty("jboss.protocol.handler.modules","org.jboss.osgi.framework");
  if (!value.equals("org.jboss.osgi.framework"))   value=value + "|org.jboss.osgi.framework";
  System.setProperty("jboss.protocol.handler.modules",value);
  Activation policy=subsystemState.getActivationPolicy();
  Mode initialMode=(policy == Activation.LAZY ? Mode.ON_DEMAND : Mode.AUTOMATIC);
  BatchBuilder batchBuilder=updateContext.getBatchBuilder();
  Configuration.addService(batchBuilder,subsystemState);
  BundleManagerService.addService(batchBuilder,initialMode);
  FrameworkService.addService(batchBuilder,initialMode);
  PackageAdminService.addService(batchBuilder);
  new OSGiDeploymentActivator().activate(batchBuilder);
}
