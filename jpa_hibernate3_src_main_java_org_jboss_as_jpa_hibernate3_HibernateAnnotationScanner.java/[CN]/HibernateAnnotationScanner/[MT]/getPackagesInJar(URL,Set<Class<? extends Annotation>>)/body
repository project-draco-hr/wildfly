{
  log.tracef("getPackagesInJar url=%s annotations=%s",jartoScan.getPath(),annotationsToLookFor);
  Set<Class<?>> resultClasses=new HashSet<Class<?>>();
  if (annotationsToLookFor.size() > 0) {
    resultClasses=getClassesInJar(jartoScan,annotationsToLookFor);
  }
 else {
    PersistenceUnitMetadata pu=persistenceUnitMetadataTLS.get();
    if (pu == null) {
      throw new RuntimeException("Missing PersistenceUnitMetadataImpl (thread local wasn't set)");
    }
    Index index=getJarFileIndex(jartoScan,pu);
    if (index == null) {
      throw new RuntimeException("Missing annotation index to scan entity classes");
    }
    if (jartoScan == null) {
      throw new IllegalArgumentException("Null jar to scan url");
    }
    Collection<ClassInfo> allClasses=index.getKnownClasses();
    for (    ClassInfo classInfo : allClasses) {
      String className=classInfo.name().toString();
      try {
        resultClasses.add(pu.getClassLoader().loadClass(className));
      }
 catch (      ClassNotFoundException e) {
        throw new RuntimeException("could not load entity class '" + className + "' with PersistenceUnitInfo.getNewTempClassLoader()",e);
      }
    }
  }
  Map<String,Package> uniquePackages=new HashMap<String,Package>();
  for (  Class classWithAnnotation : resultClasses) {
    Package classPackage=classWithAnnotation.getPackage();
    if (classPackage != null) {
      log.tracef("getPackagesInJar found package %s",classPackage);
      uniquePackages.put(classPackage.getName(),classPackage);
    }
  }
  return new HashSet<Package>(uniquePackages.values());
}
