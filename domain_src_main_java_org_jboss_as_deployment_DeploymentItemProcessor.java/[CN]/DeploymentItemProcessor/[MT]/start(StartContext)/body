{
  final ServiceController<?> controller=context.getController();
  final ServiceContainer serviceContainer=controller.getServiceContainer();
  final DeploymentUnitContextImpl deploymentUnitContext=this.deploymentUnitContext;
  final BatchBuilder batchBuilder=serviceContainer.batchBuilder();
  batchBuilder.addDependency(controller.getName());
  final DeploymentItemContext deploymentItemContext=new DeploymentItemContextImpl(module,batchBuilder);
  final ClassLoader currentCl=getContextClassLoader();
  setContextClassLoader(module.getClassLoader());
  try {
    DeploymentModuleLoaderSelector.CURRENT_MODULE_LOADER.set(module.getModuleLoader());
    try {
      final Collection<DeploymentItem> deploymentItems=deploymentUnitContext.getDeploymentItems();
      for (      DeploymentItem deploymentItem : deploymentItems) {
        deploymentItem.install(deploymentItemContext);
      }
    }
  finally {
      DeploymentModuleLoaderSelector.CURRENT_MODULE_LOADER.set(null);
    }
  }
  finally {
    setContextClassLoader(currentCl);
  }
  try {
    batchBuilder.install();
  }
 catch (  ServiceRegistryException e) {
    throw new StartException("Failed to install deployment batch for " + deploymentUnitContext.getName(),e);
  }
}
