{
  final ServiceController<?> controller=context.getController();
  final ServiceContainer serviceContainer=controller.getServiceContainer();
  final DeploymentUnitContextImpl deploymentUnitContext=this.deploymentUnitContext;
  final BatchBuilder batchBuilder=serviceContainer.batchBuilder();
  if (deploymentListener != null)   batchBuilder.addListener(deploymentListener);
  batchBuilder.addDependency(controller.getName());
  final ClassLoader currentCl=getContextClassLoader();
  if (module != null) {
    setContextClassLoader(module.getClassLoader());
    DeploymentModuleLoaderSelector.CURRENT_MODULE_LOADER.set(module.getModuleLoader());
  }
  try {
    try {
      final Collection<DeploymentItem> deploymentItems=deploymentUnitContext.getDeploymentItems();
      for (      DeploymentItem deploymentItem : deploymentItems) {
        final BatchBuilder subBatchBuilder=batchBuilder.subBatchBuilder();
        final DeploymentItemContext deploymentItemContext=new DeploymentItemContextImpl(module,subBatchBuilder);
        deploymentItem.install(deploymentItemContext);
      }
    }
  finally {
      DeploymentModuleLoaderSelector.CURRENT_MODULE_LOADER.set(null);
    }
  }
  finally {
    setContextClassLoader(currentCl);
  }
  try {
    batchBuilder.install();
  }
 catch (  ServiceRegistryException e) {
    throw new StartException("Failed to install deployment batch for " + deploymentUnitContext.getName(),e);
  }
}
