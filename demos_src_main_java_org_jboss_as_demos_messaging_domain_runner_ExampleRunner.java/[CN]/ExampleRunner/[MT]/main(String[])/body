{
  DomainDeploymentUtils utils=null;
  try {
    utils=new DomainDeploymentUtils("messaging-mbean.sar",Test.class.getPackage());
    utils.deploy();
    ObjectName objectName=new ObjectName("jboss:name=test,type=messaging");
    System.out.println("Accessing server-one");
    System.out.println();
    MBeanServerConnection mbeanServer=utils.getServerOneConnection();
    Thread.sleep(1000);
    System.out.println("Sending message: Test");
    mbeanServer.invoke(objectName,"sendMessage",new Object[]{"Test"},new String[]{"java.lang.String"});
    Thread.sleep(1000);
    List<String> msgs=(List<String>)mbeanServer.invoke(objectName,"readMessages",new Object[]{"Test"},new String[]{"java.lang.String"});
    System.out.println("Received messages: " + msgs);
    System.out.println("Accessing server-two");
    System.out.println();
    mbeanServer=utils.getServerTwoConnection();
    Thread.sleep(1000);
    System.out.println("Sending message: Test");
    mbeanServer.invoke(objectName,"sendMessage",new Object[]{"Test"},new String[]{"java.lang.String"});
    Thread.sleep(1000);
    msgs=(List<String>)mbeanServer.invoke(objectName,"readMessages",new Object[]{"Test"},new String[]{"java.lang.String"});
    System.out.println("Received messages: " + msgs);
  }
  finally {
    utils.undeploy();
    safeClose(utils);
  }
}
