{
  final MessageDigest jarDigest=MessageDigest.getInstance("SHA1");
  final MessageDigest digest=MessageDigest.getInstance("SHA1");
  final JarInputStream in=new JarInputStream(new BufferedInputStream(new FileInputStream(file)));
  try {
    JarEntry entry;
    while ((entry=in.getNextJarEntry()) != null) {
      if (entry.isDirectory()) {
        continue;
      }
      final String name=entry.getName();
      if (name.startsWith("META-INF/")) {
        if (name.endsWith(".SF") || name.endsWith(".DSA"))         continue;
      }
      if (name.equals("META-INF/INDEX.LIST")) {
        continue;
      }
      if (name.startsWith("META-INF/maven/") && name.endsWith("/pom.properties")) {
        continue;
      }
      digest.reset();
      final byte[] buf=new byte[4096];
      int l;
      while ((l=in.read(buf)) > 0) {
        digest.update(buf,0,l);
      }
      final byte[] d=digest.digest();
      jarDigest.update(d);
    }
  }
  finally {
    in.close();
  }
  return jarDigest.digest();
}
