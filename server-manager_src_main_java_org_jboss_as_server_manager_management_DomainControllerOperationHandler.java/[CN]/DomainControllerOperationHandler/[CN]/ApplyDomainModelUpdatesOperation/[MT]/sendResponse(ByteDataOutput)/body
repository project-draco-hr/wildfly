{
  List<DomainUpdateResult<?>> responses=new ArrayList<DomainUpdateResult<?>>(updates.size());
  for (  AbstractDomainModelUpdate<?> update : updates) {
    responses.add(processUpdate(update));
  }
  try {
    output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATES_RESULT_COUNT);
    output.writeInt(responses.size());
    for (    DomainUpdateResult<?> response : responses) {
      output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT);
      if (response.getDomainFailure() != null) {
        output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
        marshal(output,response.getDomainFailure());
      }
 else {
        output.writeByte(ManagementProtocol.APPLY_UPDATE_RESULT_DOMAIN_MODEL_SUCCESS);
        output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_HOST_FAILURE_COUNT);
        Map<String,UpdateFailedException> hostFailures=response.getHostFailures();
        if (hostFailures == null || hostFailures.size() == 0) {
          output.writeInt(0);
        }
 else {
          output.writeInt(hostFailures.size());
          for (          Map.Entry<String,UpdateFailedException> entry : hostFailures.entrySet()) {
            output.writeByte(ManagementProtocol.PARAM_HOST_NAME);
            output.writeUTF(entry.getKey());
            output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
            marshal(output,entry.getValue());
          }
        }
        output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_SERVER_FAILURE_COUNT);
        Map<ServerIdentity,Throwable> serverFailures=response.getServerFailures();
        if (serverFailures == null || serverFailures.size() == 0) {
          output.writeInt(0);
        }
 else {
          output.writeInt(serverFailures.size());
          for (          Map.Entry<ServerIdentity,Throwable> entry : serverFailures.entrySet()) {
            ServerIdentity identity=entry.getKey();
            output.writeByte(ManagementProtocol.PARAM_HOST_NAME);
            output.writeUTF(identity.getHostName());
            output.writeByte(ManagementProtocol.PARAM_SERVER_GROUP_NAME);
            output.writeUTF(identity.getServerGroupName());
            output.writeByte(ManagementProtocol.PARAM_SERVER_NAME);
            output.writeUTF(identity.getServerName());
            output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
            marshal(output,entry.getValue());
          }
        }
        output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_SERVER_RESULT_COUNT);
        Map<ServerIdentity,?> serverResults=response.getServerResults();
        if (serverResults == null || serverResults.size() == 0) {
          output.writeInt(0);
        }
 else {
          output.writeInt(serverResults.size());
          for (          Map.Entry<ServerIdentity,?> entry : serverFailures.entrySet()) {
            ServerIdentity identity=entry.getKey();
            output.writeByte(ManagementProtocol.PARAM_HOST_NAME);
            output.writeUTF(identity.getHostName());
            output.writeByte(ManagementProtocol.PARAM_SERVER_GROUP_NAME);
            output.writeUTF(identity.getServerGroupName());
            output.writeByte(ManagementProtocol.PARAM_SERVER_NAME);
            output.writeUTF(identity.getServerName());
            output.writeByte(ManagementProtocol.PARAM_APPLY_SERVER_MODEL_UPDATE_RESULT_RETURN);
            marshal(output,entry.getValue());
          }
        }
      }
    }
  }
 catch (  Exception e) {
    throw new ManagementException("Unable to send domain model update response.",e);
  }
}
