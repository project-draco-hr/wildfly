{
  DomainUpdateApplierResponse response=processUpdate();
  try {
    output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT);
    if (response.getDomainFailure() != null) {
      output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
      marshal(output,response.getDomainFailure());
    }
 else {
      output.writeByte(ManagementProtocol.APPLY_UPDATE_RESULT_DOMAIN_MODEL_SUCCESS);
      output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_HOST_FAILURE_COUNT);
      Map<String,UpdateFailedException> hostFailures=response.getHostFailures();
      if (hostFailures == null || hostFailures.size() == 0) {
        output.writeInt(0);
      }
 else {
        output.writeInt(hostFailures.size());
        for (        Map.Entry<String,UpdateFailedException> entry : hostFailures.entrySet()) {
          output.writeByte(ManagementProtocol.PARAM_HOST_NAME);
          output.writeUTF(entry.getKey());
          output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
          marshal(output,entry.getValue());
        }
      }
      output.writeByte(ManagementProtocol.PARAM_APPLY_UPDATE_RESULT_SERVER_COUNT);
      List<ServerIdentity> servers=response.getServers();
      if (servers == null || servers.size() == 0) {
        output.writeInt(0);
      }
 else {
        output.writeInt(servers.size());
        for (        ServerIdentity server : servers) {
          output.writeByte(ManagementProtocol.PARAM_HOST_NAME);
          output.writeUTF(server.getHostName());
          output.writeByte(ManagementProtocol.PARAM_SERVER_GROUP_NAME);
          output.writeUTF(server.getServerGroupName());
          output.writeByte(ManagementProtocol.PARAM_SERVER_NAME);
          output.writeUTF(server.getServerName());
        }
      }
    }
  }
 catch (  Exception e) {
    throw new ManagementException("Unable to send domain model update response.",e);
  }
}
