{
  final PathAddress address=PathAddress.pathAddress(operation.get(OP_ADDR));
  final String name=address.getLastElement().getValue();
  protocolStackSanityCheck(name,model);
  List<Property> orderedProtocols=getOrderedProtocolPropertyList(model);
  ModelNode transport=model.get(ModelKeys.TRANSPORT,ModelKeys.TRANSPORT_NAME);
  ModelNode resolvedValue=null;
  final String type=(resolvedValue=TransportResourceDefinition.TYPE.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final boolean shared=TransportResourceDefinition.SHARED.resolveModelAttribute(context,transport).asBoolean();
  final String machine=(resolvedValue=TransportResourceDefinition.MACHINE.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String rack=(resolvedValue=TransportResourceDefinition.RACK.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String site=(resolvedValue=TransportResourceDefinition.SITE.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String timerExecutor=(resolvedValue=TransportResourceDefinition.TIMER_EXECUTOR.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String threadFactory=(resolvedValue=TransportResourceDefinition.THREAD_FACTORY.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String diagnosticsSocketBinding=(resolvedValue=TransportResourceDefinition.DIAGNOSTICS_SOCKET_BINDING.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String defaultExecutor=(resolvedValue=TransportResourceDefinition.DEFAULT_EXECUTOR.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String oobExecutor=(resolvedValue=TransportResourceDefinition.OOB_EXECUTOR.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  final String transportSocketBinding=(resolvedValue=TransportResourceDefinition.SOCKET_BINDING.resolveModelAttribute(context,transport)).isDefined() ? resolvedValue.asString() : null;
  Transport transportConfig=new Transport(type);
  transportConfig.setShared(shared);
  transportConfig.setTopology(site,rack,machine);
  initProtocolProperties(context,transport,transportConfig);
  ProtocolStack stackConfig=new ProtocolStack(name,transportConfig);
  List<Map.Entry<Protocol,String>> protocolSocketBindings=new ArrayList<Map.Entry<Protocol,String>>(orderedProtocols.size());
  for (  Property protocolProperty : orderedProtocols) {
    ModelNode protocol=protocolProperty.getValue();
    final String protocolType=(resolvedValue=ProtocolResourceDefinition.TYPE.resolveModelAttribute(context,protocol)).isDefined() ? resolvedValue.asString() : null;
    Protocol protocolConfig=new Protocol(protocolType);
    initProtocolProperties(context,protocol,protocolConfig);
    stackConfig.getProtocols().add(protocolConfig);
    final String protocolSocketBinding=(resolvedValue=ProtocolResourceDefinition.SOCKET_BINDING.resolveModelAttribute(context,protocol)).isDefined() ? resolvedValue.asString() : null;
    protocolSocketBindings.add(new AbstractMap.SimpleImmutableEntry<Protocol,String>(protocolConfig,protocolSocketBinding));
  }
  ServiceTarget target=context.getServiceTarget();
  ServiceController<ChannelFactory> cfsController=installChannelFactoryService(target,name,diagnosticsSocketBinding,defaultExecutor,oobExecutor,timerExecutor,threadFactory,transportSocketBinding,protocolSocketBindings,transportConfig,stackConfig,verificationHandler);
  if (newControllers != null) {
    newControllers.add(cfsController);
  }
}
