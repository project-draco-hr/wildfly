{
  AtomicStampedReference<State> stateRef=ServerControllerImpl.this.state;
  int newStamp=ServerControllerImpl.this.stamp.incrementAndGet();
  int[] receiver=new int[1];
  for (; ; ) {
    State was=stateRef.get(receiver);
    if (was == State.STARTING) {
      break;
    }
    if (stateRef.compareAndSet(was,State.RESTART_REQUIRED,receiver[0],newStamp)) {
      ourStamp=newStamp;
      break;
    }
  }
}
