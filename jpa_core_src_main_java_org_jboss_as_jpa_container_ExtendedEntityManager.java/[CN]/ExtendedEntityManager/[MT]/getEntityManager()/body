{
  isInTx=TransactionUtil.getInstance().isInTx();
  if (isInTx) {
    EntityManager existing=TransactionUtil.getInstance().getTransactionScopedEntityManager(puScopedName);
    if (existing != null && existing != this) {
      throw MESSAGES.cannotUseExtendedPersistenceTransaction(puScopedName,existing,this);
    }
 else     if (existing == null) {
      TransactionUtil.getInstance().registerExtendedUnderlyingWithTransaction(puScopedName,this,underlyingEntityManager);
    }
  }
  return underlyingEntityManager;
}
