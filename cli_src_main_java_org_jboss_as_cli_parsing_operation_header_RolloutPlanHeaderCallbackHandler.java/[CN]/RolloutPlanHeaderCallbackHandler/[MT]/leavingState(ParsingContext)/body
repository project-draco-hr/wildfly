{
  final String id=ctx.getState().getId();
  if (id.equals(HeaderValueState.ID)) {
    handler.header(header);
  }
 else   if (PropertyValueState.ID.equals(id)) {
    final String value=buffer.length() == 0 ? null : buffer.toString().trim();
    if (value == null || value.isEmpty()) {
      throw new CommandFormatException("Property '" + name + "' is missing value at index "+ ctx.getLocation());
    }
    if (group == null) {
      if ("id".equals(name)) {
        header.setPlanRef(lastChunkIndex,value);
      }
 else {
        header.addProperty(name,value,lastChunkIndex);
      }
    }
 else {
      group.addProperty(name,value,lastChunkIndex);
      if (!ctx.isEndOfContent()) {
        group.propertySeparator(ctx.getLocation());
      }
    }
  }
 else   if (PropertyState.ID.equals(id)) {
    if (name == null && buffer.length() > 0) {
      if (group != null) {
        group.addProperty(buffer.toString().trim(),lastChunkIndex);
      }
 else {
        header.addProperty(buffer.toString().trim(),lastChunkIndex);
      }
      buffer.setLength(0);
    }
 else {
      name=null;
      buffer.setLength(0);
    }
  }
 else   if (ServerGroupNameState.ID.equals(id)) {
    final String groupName=buffer.toString().trim();
    if (groupName.isEmpty()) {
      throw new CommandFormatException("Empty group name at index " + ctx.getLocation());
    }
    group.setGroupName(groupName,lastChunkIndex);
  }
 else   if (ServerGroupState.ID.equals(id)) {
    if (concurrent) {
      header.addConcurrentGroup(group);
      concurrent=false;
    }
 else {
      header.addGroup(group);
    }
    group=null;
  }
 else   if (!ctx.isEndOfContent() && PropertyListState.ID.equals(id)) {
    if (group != null) {
      group.propertyListEnd(ctx.getLocation());
    }
 else {
      header.propertyListEnd(ctx.getLocation());
    }
  }
}
