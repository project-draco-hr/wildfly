{
  Resource res=Resource.Factory.create();
  ModelNode value=new ModelNode();
  Set<String> allFields=model.keys();
  for (  String name : reg.getAttributeNames(PathAddress.EMPTY_ADDRESS)) {
    if (includeUndefined) {
      value.get(name).set(model.get(name));
    }
 else {
      if (model.hasDefined(name)) {
        value.get(name).set(model.get(name));
      }
    }
    allFields.remove(name);
  }
  if (!value.isDefined() && model.isDefined() && reg.getChildAddresses(PathAddress.EMPTY_ADDRESS).size() == 0) {
    value.setEmptyObject();
  }
  res.writeModel(value);
  for (  PathElement path : reg.getChildAddresses(PathAddress.EMPTY_ADDRESS)) {
    ImmutableManagementResourceRegistration sub=reg.getSubModel(PathAddress.pathAddress(path));
    if (path.isWildcard()) {
      ModelNode subModel=model.get(path.getKey());
      if (subModel.isDefined()) {
        for (        Property p : subModel.asPropertyList()) {
          if (p.getValue().isDefined()) {
            res.registerChild(PathElement.pathElement(path.getKey(),p.getName()),modelToResource(sub,p.getValue(),includeUndefined));
          }
        }
      }
    }
 else {
      ModelNode subModel=model.get(path.getKeyValuePair());
      if (subModel.isDefined()) {
        res.registerChild(path,modelToResource(sub,subModel,includeUndefined));
      }
    }
    allFields.remove(path.getKey());
  }
  if (!allFields.isEmpty()) {
    throw new RuntimeException("Model contains fields that are not know in definition, fields: " + allFields);
  }
  return res;
}
