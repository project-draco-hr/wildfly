{
  directoryService=DSAnnotationProcessor.getDirectoryService();
  final String hostname=Utils.getSecondaryTestAddress(managementClient);
  final Map<String,String> map=new HashMap<String,String>();
  map.put("hostname",hostname);
  map.put("ldapPort",Integer.toString(LDAP_PORT));
  map.put("ldapsPort",Integer.toString(LDAPS_PORT));
  final String ldifContent=StrSubstitutor.replace(IOUtils.toString(LdapExtLoginModuleTestCase.class.getResourceAsStream(LdapExtLoginModuleTestCase.class.getSimpleName() + ".ldif"),"UTF-8"),map);
  LOGGER.debug(ldifContent);
  final SchemaManager schemaManager=directoryService.getSchemaManager();
  try {
    for (    LdifEntry ldifEntry : new LdifReader(IOUtils.toInputStream(ldifContent))) {
      directoryService.getAdminSession().add(new DefaultEntry(schemaManager,ldifEntry.getEntry()));
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
    throw e;
  }
  final ManagedCreateLdapServer createLdapServer=new ManagedCreateLdapServer((CreateLdapServer)AnnotationUtils.getInstance(CreateLdapServer.class));
  FileOutputStream fos=new FileOutputStream(KEYSTORE_FILE);
  IOUtils.copy(getClass().getResourceAsStream(KEYSTORE_FILENAME),fos);
  fos.close();
  createLdapServer.setKeyStore(KEYSTORE_FILE.getAbsolutePath());
  fixTransportAddress(createLdapServer,Utils.getSecondaryTestAddress(managementClient,false));
  ldapServer=ServerAnnotationProcessor.instantiateLdapServer(createLdapServer,directoryService);
  ldapServer.start();
}
