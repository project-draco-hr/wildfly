{
  ClassLoader origTCCL=SecurityActions.getContextClassLoader();
  JournalType jtype=configuration.getJournalType();
  if (jtype == JournalType.ASYNCIO) {
    boolean supportsAIO=AIOSequentialFileFactory.isSupported();
    if (supportsAIO == false) {
      log.warn("AIO wasn't located on this platform, it will fall back to using pure Java NIO. If your platform is Linux, install LibAIO to enable the AIO journal");
      configuration.setJournalType(JournalType.NIO);
    }
  }
  configuration.setBindingsDirectory(paths.get("bindings"));
  configuration.setLargeMessagesDirectory("largemessages");
  configuration.setJournalDirectory(paths.get("journal"));
  configuration.setPagingDirectory(paths.get("paging"));
  try {
    Collection<TransportConfiguration> acceptors=configuration.getAcceptorConfigurations();
    Collection<TransportConfiguration> connectors=configuration.getConnectorConfigurations().values();
    if (connectors != null) {
      for (      TransportConfiguration tc : connectors) {
        Object socketRef=tc.getParams().remove(SOCKET_REF);
        if (socketRef != null) {
          String name=socketRef.toString();
          SocketBinding binding=socketBindings.get(name);
          if (binding == null) {
            throw new StartException("Failed to find SocketBinding for connector: " + tc.getName());
          }
          tc.getParams().put(HOST,binding.getSocketAddress().getHostName());
          tc.getParams().put(PORT,"" + binding.getSocketAddress().getPort());
        }
      }
    }
    if (acceptors != null) {
      for (      TransportConfiguration tc : acceptors) {
        Object socketRef=tc.getParams().remove(SOCKET_REF);
        if (socketRef != null) {
          String name=socketRef.toString();
          SocketBinding binding=socketBindings.get(name);
          if (binding == null) {
            throw new StartException("Failed to find SocketBinding for connector: " + tc.getName());
          }
          tc.getParams().put(HOST,binding.getSocketAddress().getHostName());
          tc.getParams().put(PORT,"" + binding.getSocketAddress().getPort());
        }
      }
    }
    server=new HornetQServerImpl(configuration);
    ClassLoader loader=getClass().getClassLoader();
    SecurityActions.setContextClassLoader(loader);
    log.info("Starting the HornetQServer...");
    server.start();
  }
 catch (  Exception e) {
    throw new StartException("Failed to start service",e);
  }
 finally {
    SecurityActions.setContextClassLoader(origTCCL);
  }
}
