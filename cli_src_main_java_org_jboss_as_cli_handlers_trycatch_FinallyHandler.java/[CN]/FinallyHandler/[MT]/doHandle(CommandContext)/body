{
  final TryBlock tryBlock=TryBlock.get(ctx);
  final BatchManager batchManager=ctx.getBatchManager();
  if (!batchManager.isBatchActive()) {
    if (tryBlock.isInTry()) {
      throw new CommandLineException("try block did not activate batch mode.");
    }
 else {
      throw new CommandLineException("catch block did not activate batch mode.");
    }
  }
  final Batch batch=batchManager.getActiveBatch();
  if (batch.size() == 0) {
    if (tryBlock.isInTry()) {
      throw new CommandLineException("try block is empty.");
    }
 else {
      throw new CommandLineException("catch block is empty.");
    }
  }
  if (tryBlock.isInTry()) {
    tryBlock.setTryRequest(batch.toRequest());
  }
 else {
    tryBlock.setCatchRequest(batch.toRequest());
  }
  tryBlock.setInFinally();
  batchManager.discardActiveBatch();
  batchManager.activateNewBatch();
}
