{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final ModuleSpecification moduleSpec=deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_SPECIFICATION);
  final Map<ModuleIdentifier,EEModuleDescription> modules=new HashMap<ModuleIdentifier,EEModuleDescription>();
  final List<EEModuleDescription> descriptions=new ArrayList<EEModuleDescription>();
  final EEModuleDescription eeModuleDescription=deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
  descriptions.add(eeModuleDescription);
  buildModuleMap(deploymentUnit,modules);
  for (  final ModuleDependency dependency : moduleSpec.getAllDependencies()) {
    final EEModuleDescription desc=modules.get(dependency.getIdentifier());
    if (desc != null) {
      descriptions.add(desc);
    }
  }
  final EEApplicationClasses classes=new EEApplicationClasses(descriptions);
  deploymentUnit.putAttachment(Attachments.EE_APPLICATION_CLASSES_DESCRIPTION,classes);
}
