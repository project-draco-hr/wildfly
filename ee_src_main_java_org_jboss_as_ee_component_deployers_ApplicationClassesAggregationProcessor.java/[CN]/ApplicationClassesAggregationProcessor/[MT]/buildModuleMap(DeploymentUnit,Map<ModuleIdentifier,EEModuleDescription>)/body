{
  if (deploymentUnit.getParent() == null) {
    final List<DeploymentUnit> subDeployments=deploymentUnit.getAttachmentList(org.jboss.as.server.deployment.Attachments.SUB_DEPLOYMENTS);
    for (    final DeploymentUnit sub : subDeployments) {
      final EEModuleDescription subDescription=sub.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
      final ModuleIdentifier identifier=sub.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_IDENTIFIER);
      if (subDescription != null && identifier != null) {
        modules.put(identifier,subDescription);
      }
    }
  }
 else {
    final DeploymentUnit parent=deploymentUnit.getParent();
    final List<DeploymentUnit> subDeployments=parent.getAttachmentList(org.jboss.as.server.deployment.Attachments.SUB_DEPLOYMENTS);
    final EEModuleDescription parentDesc=parent.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
    final ModuleIdentifier parentIdentifier=parent.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_IDENTIFIER);
    if (parentDesc != null && parentIdentifier != null) {
      modules.put(parentIdentifier,parentDesc);
    }
    for (    final DeploymentUnit sub : subDeployments) {
      if (sub != deploymentUnit) {
        final EEModuleDescription subDescription=sub.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
        final ModuleIdentifier identifier=sub.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_IDENTIFIER);
        if (subDescription != null && identifier != null) {
          modules.put(identifier,subDescription);
        }
      }
    }
  }
}
