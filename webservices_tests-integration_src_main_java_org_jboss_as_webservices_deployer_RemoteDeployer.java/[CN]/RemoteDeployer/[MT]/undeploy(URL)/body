{
synchronized (archiveCounters) {
    String k=archiveURL.toString();
    if (archiveCounters.containsKey(k)) {
      int count=archiveCounters.get(k);
      if (count > 1) {
        archiveCounters.put(k,(count - 1));
        return;
      }
 else {
        archiveCounters.remove(k);
      }
    }
 else {
      LOGGER.warn("Trying to undeploy archive " + archiveURL + " which is not currently deployed!");
      return;
    }
    final ModelControllerClient client=newModelControllerClient();
    final ServerDeploymentManager deploymentManager=newDeploymentManager(client);
    final DeploymentPlanBuilder builder=deploymentManager.newDeploymentPlan();
    final String uniqueName=url2Id.get(archiveURL);
    if (uniqueName != null) {
      final DeploymentPlan plan=builder.undeploy(uniqueName).remove(uniqueName).build();
      final DeploymentAction deployAction=builder.getLastAction();
      try {
        executeDeploymentPlan(plan,deployAction,client,deploymentManager);
      }
  finally {
        url2Id.remove(archiveURL);
      }
    }
  }
}
