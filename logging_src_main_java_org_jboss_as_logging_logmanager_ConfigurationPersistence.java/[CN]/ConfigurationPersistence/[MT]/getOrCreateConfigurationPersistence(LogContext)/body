{
  final Logger root=logContext.getLogger(CommonAttributes.ROOT_LOGGER_NAME);
  final ConfigurationPersistence result;
synchronized (LOCK) {
    Configurator configurator=root.getAttachment(Configurator.ATTACHMENT_KEY);
    if (configurator == null) {
      configurator=new ConfigurationPersistence(logContext);
      Configurator existing=root.attachIfAbsent(Configurator.ATTACHMENT_KEY,configurator);
      if (existing != null) {
        configurator=existing;
      }
    }
    if (configurator instanceof ConfigurationPersistence) {
      result=(ConfigurationPersistence)configurator;
    }
 else     if (configurator instanceof PropertyConfigurator) {
      result=new ConfigurationPersistence((PropertyConfigurator)configurator);
      root.attach(Configurator.ATTACHMENT_KEY,result);
    }
 else {
      LoggingLogger.ROOT_LOGGER.replacingConfigurator(configurator);
      result=new ConfigurationPersistence(logContext);
      root.attach(Configurator.ATTACHMENT_KEY,result);
    }
  }
  return result;
}
