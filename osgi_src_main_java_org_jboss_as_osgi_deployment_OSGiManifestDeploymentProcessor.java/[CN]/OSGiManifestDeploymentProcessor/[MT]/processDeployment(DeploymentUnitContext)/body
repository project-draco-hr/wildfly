{
  Deployment deployment=DeploymentAttachment.getDeploymentAttachment(context);
  if (deployment != null)   return;
  VirtualFile virtualFile=VirtualFileAttachment.getVirtualFileAttachment(context);
  Manifest manifest=ManifestAttachment.getManifestAttachment(context);
  if (manifest == null) {
    try {
      manifest=VFSUtils.getManifest(virtualFile);
      if (manifest != null)       ManifestAttachment.attachManifest(context,manifest);
    }
 catch (    IOException ex) {
      throw new DeploymentUnitProcessingException("Cannot read manifest from: " + virtualFile);
    }
  }
  if (BundleInfo.isValidateBundleManifest(manifest)) {
    try {
      BundleInfo info=BundleInfo.createBundleInfo(AbstractVFS.adapt(virtualFile));
      deployment=DeploymentFactory.createDeployment(info);
      BundleInfoAttachment.attachBundleInfo(context,info);
      DeploymentAttachment.attachDeployment(context,deployment);
    }
 catch (    BundleException ex) {
      throw new DeploymentUnitProcessingException("Cannot create bundle deployment from: " + virtualFile);
    }
  }
}
