{
  String cluster="ejb";
  String nodeNameFormat="%s/%s";
  String nodeName1=String.format(nodeNameFormat,NODE_1,cluster);
  String nodeName2=String.format(nodeNameFormat,NODE_2,cluster);
  ContextSelector<EJBClientContext> selector=EJBClientContextSelector.setup(CLIENT_PROPERTIES);
  try {
    ViewChangeListener listener=context.lookupStateless(ViewChangeListenerBean.class,ViewChangeListener.class);
    listener.establishView(cluster,NODE_1,NODE_2);
    ClusterTopologyRetriever bean=context.lookupStateless(ClusterTopologyRetrieverBean.class,ClusterTopologyRetriever.class);
    ClusterTopology topology=bean.getClusterTopology();
    assertEquals(2,topology.getNodes().size());
    assertTrue(topology.getNodes().contains(nodeName1));
    assertTrue(topology.getNodes().contains(nodeName2));
    assertFalse(topology.getRemoteNodes().toString() + " should not contain " + topology.getLocalNode(),topology.getRemoteNodes().contains(topology.getLocalNode()));
    undeploy(DEPLOYMENT_2);
    listener.establishView(cluster,NODE_1);
    topology=bean.getClusterTopology();
    assertEquals(1,topology.getNodes().size());
    assertTrue(topology.getNodes().contains(nodeName1));
    assertEquals(nodeName1,topology.getLocalNode());
    assertTrue(topology.getRemoteNodes().toString(),topology.getRemoteNodes().isEmpty());
    deploy(DEPLOYMENT_2);
    listener.establishView(cluster,NODE_1,NODE_2);
    topology=bean.getClusterTopology();
    assertEquals(2,topology.getNodes().size());
    assertTrue(topology.getNodes().contains(nodeName1));
    assertTrue(topology.getNodes().contains(nodeName2));
    assertFalse(topology.getRemoteNodes().toString() + " should not contain " + topology.getLocalNode(),topology.getRemoteNodes().contains(topology.getLocalNode()));
    stop(CONTAINER_1);
    listener.establishView(cluster,NODE_2);
    topology=bean.getClusterTopology();
    assertEquals(1,topology.getNodes().size());
    assertTrue(topology.getNodes().contains(nodeName2));
    assertEquals(nodeName2,topology.getLocalNode());
    assertTrue(topology.getRemoteNodes().toString(),topology.getRemoteNodes().isEmpty());
    start(CONTAINER_1);
    listener.establishView(cluster,NODE_1,NODE_2);
    topology=bean.getClusterTopology();
    assertEquals(2,topology.getNodes().size());
    assertTrue(topology.getNodes().contains(nodeName1));
    assertTrue(topology.getNodes().contains(nodeName2));
    assertFalse(topology.getRemoteNodes().toString() + " should not contain " + topology.getLocalNode(),topology.getRemoteNodes().contains(topology.getLocalNode()));
  }
  finally {
    if (selector != null) {
      EJBClientContext.setSelector(selector);
    }
  }
}
