{
  List<DeploymentAspect> aspects=getDeploymentAspects();
  ClassLoader origClassLoader=SecurityActions.getContextClassLoader();
  Deployment dep=null;
  try {
    SecurityActions.setContextClassLoader(ClassLoaderProvider.getDefaultProvider().getServerIntegrationClassLoader());
    WSDeploymentBuilder.getInstance().build(unit);
    dep=unit.getAttachment(WSAttachmentKeys.DEPLOYMENT_KEY);
    dep.addAttachment(ServiceTarget.class,target);
    DeploymentAspectManager dam=new DeploymentAspectManagerImpl();
    dam.setDeploymentAspects(aspects);
    dam.deploy(dep);
    for (    Endpoint ep : dep.getService().getEndpoints()) {
      ep.setState(EndpointState.STOPPED);
      ep.setInvocationHandler(new InvocationHandlerJAXWS());
      ep.setState(EndpointState.STARTED);
    }
  }
  finally {
    if (dep != null) {
      dep.removeAttachment(ServiceTarget.class);
    }
    SecurityActions.setContextClassLoader(origClassLoader);
  }
  Deployment deployment=unit.getAttachment(WSAttachmentKeys.DEPLOYMENT_KEY);
  deployment.addAttachment(CommonWebDeployment.class,startWebApp(host,unit));
  return deployment.getService().getEndpoints();
}
