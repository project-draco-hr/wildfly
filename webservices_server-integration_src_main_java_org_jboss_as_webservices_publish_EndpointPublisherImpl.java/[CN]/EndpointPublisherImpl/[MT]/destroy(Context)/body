{
  Deployment deployment=context.getEndpoints().get(0).getService().getDeployment();
  List<DeploymentAspect> aspects=DeploymentAspectsProvider.getSortedDeploymentAspects();
  try {
    stopWebApp(deployment.getAttachment(StandardContext.class));
  }
  finally {
    ClassLoader origClassLoader=SecurityActions.getContextClassLoader();
    try {
      SecurityActions.setContextClassLoader(ClassLoaderProvider.getDefaultProvider().getServerIntegrationClassLoader());
      DeploymentAspectManager dam=new DeploymentAspectManagerImpl();
      dam.setDeploymentAspects(aspects);
      dam.undeploy(deployment);
    }
  finally {
      SecurityActions.setContextClassLoader(origClassLoader);
    }
  }
}
