{
  List<Endpoint> eps=context.getEndpoints();
  if (eps == null || eps.isEmpty()) {
    return;
  }
  Deployment deployment=eps.get(0).getService().getDeployment();
  List<DeploymentAspect> aspects=DeploymentAspectsProvider.getSortedDeploymentAspects();
  try {
    stopWebApp(deployment.getAttachment(StandardContext.class));
  }
  finally {
    ClassLoader origClassLoader=SecurityActions.getContextClassLoader();
    try {
      SecurityActions.setContextClassLoader(ClassLoaderProvider.getDefaultProvider().getServerIntegrationClassLoader());
      final ServiceTarget target=deployment.getAttachment(ServiceTarget.class);
      if (target == null) {
        SPIProvider spiProvider=SPIProviderResolver.getInstance().getProvider();
        EndpointRegistryFactory factory=spiProvider.getSPI(EndpointRegistryFactory.class);
        EndpointRegistry registry=factory.getEndpointRegistry();
        for (        final Endpoint endpoint : deployment.getService().getEndpoints()) {
          registry.unregister(endpoint);
        }
      }
      DeploymentAspectManager dam=new DeploymentAspectManagerImpl();
      dam.setDeploymentAspects(aspects);
      dam.undeploy(deployment);
    }
  finally {
      SecurityActions.setContextClassLoader(origClassLoader);
    }
  }
}
