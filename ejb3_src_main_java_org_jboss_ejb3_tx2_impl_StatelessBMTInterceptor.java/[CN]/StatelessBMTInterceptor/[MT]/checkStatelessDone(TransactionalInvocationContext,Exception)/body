{
  int status=Status.STATUS_NO_TRANSACTION;
  TransactionManager tm=this.getTransactionManager();
  try {
    status=tm.getStatus();
  }
 catch (  SystemException sex) {
    log.error("Failed to get status",sex);
  }
switch (status) {
case Status.STATUS_ACTIVE:
case Status.STATUS_COMMITTING:
case Status.STATUS_MARKED_ROLLBACK:
case Status.STATUS_PREPARING:
case Status.STATUS_ROLLING_BACK:
    try {
      tm.rollback();
    }
 catch (    Exception sex) {
      log.error("Failed to rollback",sex);
    }
case Status.STATUS_PREPARED:
  String msg="Application error: BMT stateless bean " + getComponentName() + " should complete transactions before"+ " returning (ejb1.1 spec, 11.6.1)";
log.error(msg);
throw new EJBException(msg);
}
if (ex != null) throw this.handleException(invocation,ex);
}
