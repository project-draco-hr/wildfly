{
  final ArchiveDeployment dep;
  if (unit.hasAttachment(DEPLOYMENT_KEY)) {
    dep=(ArchiveDeployment)unit.getAttachment(DEPLOYMENT_KEY);
  }
 else {
    try {
      dep=this.newDeployment(unit);
    }
 catch (    DeploymentUnitProcessingException e) {
      throw new RuntimeException(e);
    }
    propagateAttachments(unit,dep);
  }
  this.build(dep,unit);
}
