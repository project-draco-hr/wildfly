{
  deployer.deploy(CONFIG_ADMIN_BUNDLE_B);
  try {
    Bundle bundle=packageAdmin.getBundles(CONFIG_ADMIN_BUNDLE_B,null)[0];
    Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundle.getState());
    BundleContext context=bundle.getBundleContext();
    ConfigAdmin configAdmin=getConfigAdmin(context);
    ConfigurationAdmin configurationAdmin=getConfigurationAdmin(context);
    Configuration config=configurationAdmin.getConfiguration(CONFIG_ADMIN_BUNDLE_B);
    try {
      Assert.assertEquals("bar",config.getProperties().get("foo"));
      Dictionary<String,String> modelProps=configAdmin.getConfiguration(CONFIG_ADMIN_BUNDLE_B);
      Assert.assertEquals("bar",modelProps.get("foo"));
      ServiceReference sref=context.getServiceReference(ConfiguredService.class.getName());
      ConfiguredService service=(ConfiguredService)context.getService(sref);
      Assert.assertTrue(service.awaitUpdate(3,TimeUnit.SECONDS));
      Assert.assertEquals("bar",service.getProperties().get("foo"));
    }
  finally {
      config.delete();
    }
  }
  finally {
    deployer.undeploy(CONFIG_ADMIN_BUNDLE_B);
  }
}
