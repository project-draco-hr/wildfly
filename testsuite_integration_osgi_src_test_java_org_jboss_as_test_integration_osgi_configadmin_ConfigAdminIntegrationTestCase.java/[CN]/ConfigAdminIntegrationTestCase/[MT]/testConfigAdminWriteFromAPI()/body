{
  InputStream input=deployer.getDeployment(CONFIG_ADMIN_BUNDLE_A);
  Bundle bundle=syscontext.installBundle(CONFIG_ADMIN_PID_B,input);
  try {
    bundle.start();
    Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,bundle.getState());
    BundleContext context=bundle.getBundleContext();
    ConfigAdmin configAdmin=getConfigAdmin(context);
    ConfigurationAdmin configurationAdmin=FrameworkUtils.waitForService(context,ConfigurationAdmin.class);
    final CountDownLatch latch=new CountDownLatch(1);
    ConfigAdminListener listener=new ConfigAdminListener(){
      @Override public void configurationModified(      String pid,      Dictionary<String,String> props){
        if (props != null)         latch.countDown();
      }
      @Override public Set<String> getPIDs(){
        return Collections.singleton(CONFIG_ADMIN_PID_B);
      }
    }
;
    configAdmin.addListener(listener);
    Dictionary<String,String> props=new Hashtable<String,String>();
    props.put("foo","bar");
    configAdmin.putConfiguration(CONFIG_ADMIN_PID_B,props);
    try {
      Assert.assertTrue(latch.await(3,TimeUnit.SECONDS));
      Configuration config=configurationAdmin.getConfiguration(CONFIG_ADMIN_PID_B);
      Assert.assertEquals("bar",config.getProperties().get("foo"));
      ServiceReference sref=context.getServiceReference(ConfiguredService.class.getName());
      ConfiguredService service=(ConfiguredService)context.getService(sref);
      Assert.assertTrue(service.awaitUpdate(3,TimeUnit.SECONDS));
      Assert.assertEquals("bar",service.getProperties().get("foo"));
    }
  finally {
      configAdmin.removeConfiguration(CONFIG_ADMIN_PID_B);
      configAdmin.removeListener(listener);
    }
  }
  finally {
    bundle.uninstall();
  }
}
