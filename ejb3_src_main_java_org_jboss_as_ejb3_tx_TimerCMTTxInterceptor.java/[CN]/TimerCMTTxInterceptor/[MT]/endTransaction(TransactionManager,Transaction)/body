{
  try {
    boolean rolledBack=false;
    try {
      if (tx.getStatus() == Status.STATUS_MARKED_ROLLBACK) {
        rolledBack=true;
      }
    }
 catch (    SystemException e) {
      throw new RuntimeException(e);
    }
    super.endTransaction(tm,tx);
    if (rolledBack && EXCEPTION.get() == null) {
      throw new TimerTransactionRolledBackException("Timer invocation failed, transaction rolled back");
    }
  }
  finally {
    EXCEPTION.remove();
  }
}
