{
  final String path=file.getValue(ctx.getParsedCommandLine());
  final BatchManager batchManager=ctx.getBatchManager();
  if (batchManager.isBatchActive()) {
    if (path != null) {
      throw new CommandFormatException("--file is not allowed in the batch mode.");
    }
    final Batch batch=batchManager.getActiveBatch();
    List<BatchedCommand> currentBatch=batch.getCommands();
    if (currentBatch.isEmpty()) {
      batchManager.discardActiveBatch();
      throw new CommandFormatException("The batch is empty.");
    }
    return batch.toRequest();
  }
  if (path != null) {
    final File f=new File(path);
    if (!f.exists()) {
      throw new CommandFormatException("File " + f.getAbsolutePath() + " does not exist.");
    }
    final File currentDir=ctx.getCurrentDir();
    final File baseDir=f.getParentFile();
    if (baseDir != null) {
      ctx.setCurrentDir(baseDir);
    }
    BufferedReader reader=null;
    try {
      reader=new BufferedReader(new FileReader(f));
      String line=reader.readLine();
      batchManager.activateNewBatch();
      final Batch batch=batchManager.getActiveBatch();
      while (line != null) {
        batch.add(ctx.toBatchedCommand(line));
        line=reader.readLine();
      }
      return batch.toRequest();
    }
 catch (    IOException e) {
      throw new CommandFormatException("Failed to read file " + f.getAbsolutePath(),e);
    }
catch (    CommandFormatException e) {
      throw new CommandFormatException("Failed to create batch from " + f.getAbsolutePath(),e);
    }
 finally {
      batchManager.discardActiveBatch();
      if (baseDir != null) {
        ctx.setCurrentDir(currentDir);
      }
      if (reader != null) {
        try {
          reader.close();
        }
 catch (        IOException e) {
        }
      }
    }
  }
  throw new CommandFormatException("Without arguments the command can be executed only in the batch mode.");
}
