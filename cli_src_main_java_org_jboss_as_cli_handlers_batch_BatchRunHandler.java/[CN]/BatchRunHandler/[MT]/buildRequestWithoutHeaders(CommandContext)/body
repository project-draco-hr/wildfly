{
  final BatchManager batchManager=ctx.getBatchManager();
  if (!batchManager.isBatchActive()) {
    throw new CommandFormatException("No active batch.");
  }
  final Batch batch=batchManager.getActiveBatch();
  List<BatchedCommand> currentBatch=batch.getCommands();
  if (currentBatch.isEmpty()) {
    batchManager.discardActiveBatch();
    throw new CommandFormatException("The batch is empty.");
  }
  return batch.toRequest();
}
