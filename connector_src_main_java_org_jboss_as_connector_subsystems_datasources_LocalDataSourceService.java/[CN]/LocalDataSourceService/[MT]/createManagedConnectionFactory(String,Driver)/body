{
  final LocalManagedConnectionFactory managedConnectionFactory=new LocalManagedConnectionFactory();
  managedConnectionFactory.setDriver(driver);
  managedConnectionFactory.setJndiName(jndiName);
  managedConnectionFactory.setSpy(true);
  if (dataSourceConfig.getConnectionProperties() != null) {
    managedConnectionFactory.setConnectionProperties(buildConfigPropsString(dataSourceConfig.getConnectionProperties()));
  }
  if (dataSourceConfig.getConnectionUrl() != null) {
    managedConnectionFactory.setConnectionURL(dataSourceConfig.getConnectionUrl());
  }
  if (dataSourceConfig.getNewConnectionSql() != null) {
    managedConnectionFactory.setNewConnectionSQL(dataSourceConfig.getNewConnectionSql());
  }
  if (dataSourceConfig.getTransactionIsolation() != null) {
    managedConnectionFactory.setTransactionIsolation(dataSourceConfig.getTransactionIsolation().name());
  }
  if (dataSourceConfig.getUrlDelimiter() != null) {
    managedConnectionFactory.setURLDelimiter(dataSourceConfig.getUrlDelimiter());
  }
  if (dataSourceConfig.getUrlSelectorStrategyClassName() != null) {
    managedConnectionFactory.setUrlSelectorStrategyClassName(dataSourceConfig.getUrlSelectorStrategyClassName());
  }
  final DsSecurity security=dataSourceConfig.getSecurity();
  if (security != null) {
    if (security.getUserName() != null) {
      managedConnectionFactory.setUserName(security.getUserName());
    }
    if (security.getPassword() != null) {
      managedConnectionFactory.setPassword(security.getPassword());
    }
  }
  final TimeOut timeOut=dataSourceConfig.getTimeOut();
  if (timeOut != null) {
    if (timeOut.getUseTryLock() != null) {
      managedConnectionFactory.setUseTryLock(timeOut.getUseTryLock().intValue());
    }
    if (timeOut.getQueryTimeout() != null) {
      managedConnectionFactory.setQueryTimeout(timeOut.getQueryTimeout().intValue());
    }
  }
  final Statement statement=dataSourceConfig.getStatement();
  if (statement != null) {
    if (statement.getTrackStatements() != null) {
      managedConnectionFactory.setTrackStatements(statement.getTrackStatements().name());
    }
    if (statement.isSharePreparedStatements() != null) {
      managedConnectionFactory.setSharePreparedStatements(statement.isSharePreparedStatements());
    }
    if (statement.getPreparedStatementsCacheSize() != null) {
      managedConnectionFactory.setPreparedStatementCacheSize(statement.getPreparedStatementsCacheSize().intValue());
    }
  }
  final Validation validation=dataSourceConfig.getValidation();
  if (validation != null) {
    if (validation.isValidateOnMatch()) {
      managedConnectionFactory.setValidateOnMatch(validation.isValidateOnMatch());
    }
    if (validation.getCheckValidConnectionSql() != null) {
      managedConnectionFactory.setCheckValidConnectionSQL(validation.getCheckValidConnectionSql());
    }
    final JdbcAdapterExtension validConnectionChecker=validation.getValidConnectionChecker();
    if (validConnectionChecker != null) {
      if (validConnectionChecker.getClassName() != null) {
        managedConnectionFactory.setValidConnectionCheckerClassName(validConnectionChecker.getClassName());
      }
      if (validConnectionChecker.getConfigPropertiesMap() != null) {
        managedConnectionFactory.setValidConnectionCheckerProperties(buildConfigPropsString(validConnectionChecker.getConfigPropertiesMap()));
      }
    }
    final JdbcAdapterExtension exceptionSorter=validation.getExceptionSorter();
    if (exceptionSorter != null) {
      if (exceptionSorter.getClassName() != null) {
        managedConnectionFactory.setExceptionSorterClassName(exceptionSorter.getClassName());
      }
      if (exceptionSorter.getConfigPropertiesMap() != null) {
        managedConnectionFactory.setExceptionSorterProperties(buildConfigPropsString(exceptionSorter.getConfigPropertiesMap()));
      }
    }
    final JdbcAdapterExtension staleConnectionChecker=validation.getStaleConnectionChecker();
    if (staleConnectionChecker != null) {
      if (staleConnectionChecker.getClassName() != null) {
        managedConnectionFactory.setStaleConnectionCheckerClassName(staleConnectionChecker.getClassName());
      }
      if (staleConnectionChecker.getConfigPropertiesMap() != null) {
        managedConnectionFactory.setStaleConnectionCheckerProperties(buildConfigPropsString(staleConnectionChecker.getConfigPropertiesMap()));
      }
    }
  }
  return managedConnectionFactory;
}
