{
  final SecurityRolesMetaData roleMappings=new SecurityRolesMetaData();
  final EjbJarMetaData ejbJarMetaData=deploymentUnit.getAttachment(EjbDeploymentAttachmentKeys.EJB_JAR_METADATA);
  if (ejbJarMetaData != null) {
    final AssemblyDescriptorMetaData assemblyDescriptorMetaData=ejbJarMetaData.getAssemblyDescriptor();
    if (assemblyDescriptorMetaData == null) {
      return;
    }
    final List<SecurityRoleMetaData> securityRoleMetaDatas=assemblyDescriptorMetaData.getAny(SecurityRoleMetaData.class);
    if (securityRoleMetaDatas != null) {
      for (      SecurityRoleMetaData securityRoleMetaData : securityRoleMetaDatas) {
        roleMappings.add(securityRoleMetaData);
      }
    }
  }
  DeploymentUnit parent=deploymentUnit.getParent();
  if (parent != null) {
    final EarMetaData earMetaData=parent.getAttachment(Attachments.EAR_METADATA);
    final JBossAppMetaData jbossAppMetaData=parent.getAttachment(Attachments.JBOSS_APP_METADATA);
    if (earMetaData != null || jbossAppMetaData != null) {
      if (earMetaData != null && jbossAppMetaData == null) {
        SecurityRolesMetaData earSecurityRolesMetaData=earMetaData.getSecurityRoles();
        if (earSecurityRolesMetaData != null) {
          SecurityRolesMetaDataMerger.merge(roleMappings,roleMappings,earSecurityRolesMetaData);
        }
      }
      if (earMetaData == null && jbossAppMetaData != null) {
        SecurityRolesMetaData jbossAppSecurityRolesMetaData=jbossAppMetaData.getSecurityRoles();
        if (jbossAppSecurityRolesMetaData != null) {
          SecurityRolesMetaDataMerger.merge(roleMappings,roleMappings,jbossAppSecurityRolesMetaData);
        }
      }
      if (earMetaData != null && jbossAppMetaData != null) {
        SecurityRolesMetaData earSecurityRolesMetaData=earMetaData.getSecurityRoles();
        SecurityRolesMetaData jbossAppSecurityRolesMetaData=jbossAppMetaData.getSecurityRoles();
        SecurityRolesMetaData earLevelMergedSecurityRolesMD=new SecurityRolesMetaData();
        SecurityRolesMetaDataMerger.merge(earLevelMergedSecurityRolesMD,jbossAppSecurityRolesMetaData,earSecurityRolesMetaData);
        SecurityRolesMetaDataMerger.merge(roleMappings,roleMappings,earLevelMergedSecurityRolesMD);
      }
    }
  }
  ejbComponentDescription.setSecurityRoles(roleMappings);
}
