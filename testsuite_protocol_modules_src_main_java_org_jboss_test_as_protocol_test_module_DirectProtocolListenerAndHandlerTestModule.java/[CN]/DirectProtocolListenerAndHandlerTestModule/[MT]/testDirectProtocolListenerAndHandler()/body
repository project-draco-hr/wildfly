{
  MockServerManagerProcess serverManager=MockServerManagerProcess.create();
  TestServerManagerMessageHandler managerMessageHandler=new TestServerManagerMessageHandler();
  TestDirectServerManagerCommunicationListener managerListener=TestDirectServerManagerCommunicationListener.create(serverManager,InetAddress.getLocalHost(),0,10,managerMessageHandler);
  TestServerSideMessageHandler serverMessageHandler=new TestServerSideMessageHandler();
  DirectServerSideCommunicationHandler serverHandler=DirectServerSideCommunicationHandler.create("Test",InetAddress.getLocalHost(),managerListener.getSmPort(),serverMessageHandler);
  byte[] sent=ServerManagerProtocolCommand.SERVER_AVAILABLE.createCommandBytes(null);
  serverHandler.sendMessage(sent);
  compare(sent,managerMessageHandler.awaitAndReadMessage().getMessage());
  DirectServerManagerCommunicationHandler managerHandler=managerListener.getManagerHandler("Test");
  sent=ServerManagerProtocolCommand.START_SERVER.createCommandBytes("ABCD".getBytes());
  managerHandler.sendMessage(sent);
  compare(sent,serverMessageHandler.awaitAndReadMessage());
  sent=ServerManagerProtocolCommand.SERVER_STARTED.createCommandBytes(null);
  serverHandler.sendMessage(sent);
  compare(sent,managerMessageHandler.awaitAndReadMessage().getMessage());
  sent=ServerManagerProtocolCommand.STOP_SERVER.createCommandBytes(null);
  managerHandler.sendMessage(sent);
  compare(sent,serverMessageHandler.awaitAndReadMessage());
  sent=ServerManagerProtocolCommand.SERVER_STOPPED.createCommandBytes(null);
  serverHandler.sendMessage(sent);
  compare(sent,managerMessageHandler.awaitAndReadMessage().getMessage());
  serverHandler.shutdown();
  waitForClose(serverHandler,managerHandler,5000);
}
