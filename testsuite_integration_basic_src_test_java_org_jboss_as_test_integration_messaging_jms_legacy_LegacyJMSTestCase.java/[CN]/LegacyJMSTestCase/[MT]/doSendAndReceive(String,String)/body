{
  Destination destination=(Destination)remoteContext.lookup(destinationLoookup);
  assertNotNull(destination);
  ConnectionFactory cf=(ConnectionFactory)remoteContext.lookup(connectionFactoryLookup);
  assertNotNull(cf);
  try (JMSContext producerContext=cf.createContext("guest","guest");JMSContext consumerContext=cf.createContext("guest","guest")){
    final CountDownLatch latch=new CountDownLatch(1);
    final List<String> result=new ArrayList<String>();
    final int num=10;
    JMSConsumer consumer=consumerContext.createConsumer(destination);
    consumer.setMessageListener(new MessageListener(){
      @Override public void onMessage(      Message message){
        TextMessage msg=(TextMessage)message;
        try {
          System.err.println("<<< Receiving " + msg.getText());
          result.add(msg.getText());
          if (result.size() == num) {
            latch.countDown();
          }
        }
 catch (        JMSException e) {
          e.printStackTrace();
        }
      }
    }
);
    JMSProducer producer=producerContext.createProducer();
    for (int i=0; i < num; i++) {
      String text="Test" + i;
      System.err.println(">>> Sending " + text);
      producer.send(destination,text);
    }
    assertTrue(latch.await(3,SECONDS));
    assertEquals(num,result.size());
    for (int i=0; i < result.size(); i++) {
      assertEquals("Messages received : " + result,"Test" + i,result.get(i));
    }
  }
 }
