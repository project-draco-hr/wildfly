{
  BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
  ServiceName resolvedBundle=bundleManager.getServiceName(bundle,Bundle.RESOLVED);
  ServiceName serviceName=depUnit.getServiceName().append("Activate");
  BundleActivateService service=new BundleActivateService(depUnit);
  ServiceBuilder<XBundle> builder=serviceTarget.addService(serviceName,service);
  builder.addDependency(resolvedBundle,XBundle.class,service.injectedBundle);
  OSGiMetaData metadata=depUnit.getAttachment(OSGiConstants.OSGI_METADATA_KEY);
  if (metadata != null && metadata.getBundleActivator() != null) {
    String activatorClass=metadata.getBundleActivator();
    EEModuleDescription moduleDescription=depUnit.getAttachment(EE_MODULE_DESCRIPTION);
    for (    ComponentDescription componentDescription : moduleDescription.getComponentDescriptions()) {
      if (activatorClass.equals(componentDescription.getComponentClassName())) {
        ServiceName startServiceName=componentDescription.getStartServiceName();
        builder.addDependency(startServiceName,Component.class,service.injectedComponent);
      }
    }
  }
  return builder.install();
}
