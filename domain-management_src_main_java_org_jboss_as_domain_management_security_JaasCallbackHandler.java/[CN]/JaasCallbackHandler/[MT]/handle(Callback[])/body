{
  if (callbacks.length == 1 && callbacks[0] instanceof AuthorizeCallback) {
    AuthorizeCallback acb=(AuthorizeCallback)callbacks[0];
    boolean authorized=acb.getAuthenticationID().equals(acb.getAuthorizationID());
    if (authorized == false) {
      SECURITY_LOGGER.tracef("Checking 'AuthorizeCallback', authorized=false, authenticationID=%s, authorizationID=%s.",acb.getAuthenticationID(),acb.getAuthorizationID());
    }
    acb.setAuthorized(authorized);
    return;
  }
  NameCallback nameCallBack=null;
  VerifyPasswordCallback verifyPasswordCallback=null;
  SubjectCallback subjectCallback=null;
  for (  Callback current : callbacks) {
    if (current instanceof NameCallback) {
      nameCallBack=(NameCallback)current;
    }
 else     if (current instanceof RealmCallback) {
    }
 else     if (current instanceof VerifyPasswordCallback) {
      verifyPasswordCallback=(VerifyPasswordCallback)current;
    }
 else     if (current instanceof SubjectCallback) {
      subjectCallback=(SubjectCallback)current;
    }
 else {
      throw new UnsupportedCallbackException(current);
    }
  }
  if (nameCallBack == null) {
    SECURITY_LOGGER.trace("No username supplied in Callbacks.");
    throw MESSAGES.noUsername();
  }
  final String userName=nameCallBack.getDefaultName();
  if (userName == null || userName.length() == 0) {
    SECURITY_LOGGER.trace("NameCallback either has no username or is 0 length.");
    throw MESSAGES.noUsername();
  }
  if (verifyPasswordCallback == null || verifyPasswordCallback.getPassword() == null) {
    SECURITY_LOGGER.trace("No password to verify.");
    throw MESSAGES.noPassword();
  }
  final char[] password=verifyPasswordCallback.getPassword().toCharArray();
  Subject subject=subjectCallback != null && subjectCallback.getSubject() != null ? subjectCallback.getSubject() : new Subject();
  ServerSecurityManager securityManager;
  if ((securityManager=securityManagerValue.getOptionalValue()) != null) {
    try {
      securityManager.push(name,userName,password,subject);
      securityManager.authenticate();
      verifyPasswordCallback.setVerified(true);
      subject.getPrivateCredentials().add(new PasswordCredential(userName,password));
      if (subjectCallback != null) {
        subjectCallback.setSubject(subject);
      }
    }
 catch (    SecurityException e) {
      SECURITY_LOGGER.debug("Failed to verify password in JAAS callbackhandler " + this.name,e);
      verifyPasswordCallback.setVerified(false);
    }
 finally {
      securityManager.pop();
    }
  }
 else {
    try {
      LoginContext ctx=new LoginContext(name,subject,new CallbackHandler(){
        public void handle(        Callback[] callbacks) throws IOException, UnsupportedCallbackException {
          for (          Callback current : callbacks) {
            if (current instanceof NameCallback) {
              NameCallback ncb=(NameCallback)current;
              ncb.setName(userName);
            }
 else             if (current instanceof PasswordCallback) {
              PasswordCallback pcb=(PasswordCallback)current;
              pcb.setPassword(password);
            }
 else {
              throw new UnsupportedCallbackException(current);
            }
          }
        }
      }
);
      ctx.login();
      verifyPasswordCallback.setVerified(true);
      subject.getPrivateCredentials().add(new PasswordCredential(userName,password));
      if (subjectCallback != null) {
        subjectCallback.setSubject(subject);
      }
    }
 catch (    LoginException e) {
      SECURITY_LOGGER.debug("Login failed in JAAS callbackhandler " + this.name,e);
      verifyPasswordCallback.setVerified(false);
    }
  }
}
