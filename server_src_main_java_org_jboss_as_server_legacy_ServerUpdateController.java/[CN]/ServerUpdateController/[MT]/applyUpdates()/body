{
  if (updates.size() == 0) {
    transition(false);
    return;
  }
  BatchBuilder batchBuilder=serviceContainer.batchBuilder();
  UpdateContext updateContext=new SimpleUpdateContext(serviceContainer,batchBuilder);
  for (  ServerModelUpdateTuple<?,?> update : updates) {
    logger.debugf("Applying update %s",update.getUpdate().toString());
    if (status != Status.ACTIVE) {
      update.handleCancellation();
      continue;
    }
    boolean appliedToModel=false;
    ServerModelUpdateTuple<Object,?> rollbackTuple=null;
    try {
      rollbackTuple=update.getRollbackTuple(serverModel);
      serverModel.update(update.getUpdate());
      appliedToModel=true;
      if (allowRuntimeUpdates) {
        update.applyUpdate(updateContext);
      }
 else {
        updateComplete();
      }
      if (allowOverallRollback && rollbackTuple != null) {
        rollbacks.add(0,rollbackTuple);
      }
    }
 catch (    Exception e) {
      update.handleFailure(e);
      if (rollbackTuple != null) {
        if (appliedToModel) {
          try {
            if (allowRuntimeUpdates) {
              rollbackTuple.applyUpdate(updateContext);
            }
            serverModel.update(rollbackTuple.getUpdate());
          }
 catch (          UpdateFailedException e1) {
            rollbackTuple.handleFailure(e1);
          }
        }
      }
    }
  }
  if (status == Status.ACTIVE) {
    try {
      batchBuilder.install();
    }
 catch (    ServiceRegistryException e) {
      handleRollback();
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debugf("%s update(s) applied",updates.size());
  }
}
