{
  final String name=getPlugInName();
  final AuthenticationPlugIn<Credential> ap=getPlugInLoader().loadAuthenticationPlugIn(name);
  if (ap instanceof PlugInConfigurationSupport) {
    PlugInConfigurationSupport pcf=(PlugInConfigurationSupport)ap;
    try {
      pcf.init(getConfiguration(),sharedState);
    }
 catch (    IOException e) {
      throw MESSAGES.unableToInitialisePlugIn(name,e.getMessage());
    }
  }
  return new CallbackHandler(){
    public void handle(    Callback[] callbacks) throws IOException, UnsupportedCallbackException {
      final String realmName=getRealmName();
      List<Callback> toRespondTo=new LinkedList<Callback>();
      String userName=null;
      Credential credential=null;
      for (      Callback current : callbacks) {
        if (current instanceof AuthorizeCallback) {
          toRespondTo.add(current);
        }
 else         if (current instanceof NameCallback) {
          NameCallback nameCallback=(NameCallback)current;
          userName=nameCallback.getDefaultName();
          Identity identity=ap.loadIdentity(userName,realmName);
          if (identity != null) {
            credential=identity.getCredential();
          }
        }
 else         if (current instanceof PasswordCallback) {
          toRespondTo.add(current);
        }
 else         if (current instanceof DigestHashCallback) {
          toRespondTo.add(current);
        }
 else         if (current instanceof VerifyPasswordCallback) {
          toRespondTo.add(current);
        }
 else         if (current instanceof RealmCallback) {
          String realm=((RealmCallback)current).getDefaultText();
          if (realmName.equals(realm) == false) {
            throw MESSAGES.invalidRealm(realm,realmName);
          }
        }
 else {
          throw new UnsupportedCallbackException(current);
        }
      }
      for (      Callback current : toRespondTo) {
        if (current instanceof AuthorizeCallback) {
          AuthorizeCallback acb=(AuthorizeCallback)current;
          boolean authorized=acb.getAuthenticationID().equals(acb.getAuthorizationID());
          if (authorized == false) {
            SECURITY_LOGGER.tracef("Checking 'AuthorizeCallback', authorized=false, authenticationID=%s, authorizationID=%s.",acb.getAuthenticationID(),acb.getAuthorizationID());
          }
          acb.setAuthorized(authorized);
        }
 else         if (current instanceof PasswordCallback) {
          if (credential == null) {
            SECURITY_LOGGER.tracef("User '%s' not found.",userName);
            throw new UserNotFoundException(userName);
          }
          if (credential instanceof PasswordCredential) {
            ((PasswordCallback)current).setPassword(((PasswordCredential)credential).getPassword());
          }
 else {
            throw new UnsupportedCallbackException(current);
          }
        }
 else         if (current instanceof DigestHashCallback) {
          if (credential == null) {
            SECURITY_LOGGER.tracef("User '%s' not found.",userName);
            throw new UserNotFoundException(userName);
          }
          if (credential instanceof DigestCredential) {
            ((DigestHashCallback)current).setHexHash(((DigestCredential)credential).getHash());
          }
 else           if (credential instanceof PasswordCredential) {
            UsernamePasswordHashUtil hashUtil=getHashUtil();
            String hash;
synchronized (hashUtil) {
              hash=hashUtil.generateHashedHexURP(userName,realmName,((PasswordCredential)credential).getPassword());
            }
            ((DigestHashCallback)current).setHexHash(hash);
          }
 else {
            throw new UnsupportedCallbackException(current);
          }
        }
 else         if (current instanceof VerifyPasswordCallback) {
          if (credential == null) {
            SECURITY_LOGGER.tracef("User '%s' not found.",userName);
            throw new UserNotFoundException(userName);
          }
          VerifyPasswordCallback vpc=(VerifyPasswordCallback)current;
          if (credential instanceof PasswordCredential) {
            boolean verified=Arrays.equals(((PasswordCredential)credential).getPassword(),vpc.getPassword().toCharArray());
            if (verified == false) {
              SECURITY_LOGGER.tracef("Password verification failed for user '%s'",userName);
            }
            vpc.setVerified(verified);
          }
 else           if (credential instanceof DigestCredential) {
            UsernamePasswordHashUtil hashUtil=getHashUtil();
            String hash;
synchronized (hashUtil) {
              hash=hashUtil.generateHashedHexURP(userName,realmName,vpc.getPassword().toCharArray());
            }
            String expected=((DigestCredential)credential).getHash();
            boolean verified=expected.equals(hash);
            if (verified == false) {
              SECURITY_LOGGER.tracef("Digest verification failed for user '%s'",userName);
            }
            vpc.setVerified(verified);
          }
 else           if (credential instanceof ValidatePasswordCredential) {
            boolean verified=((ValidatePasswordCredential)credential).validatePassword(vpc.getPassword().toCharArray());
            if (verified == false) {
              SECURITY_LOGGER.tracef("Delegated verification failed for user '%s'",userName);
            }
            vpc.setVerified(verified);
          }
        }
      }
    }
  }
;
}
