{
  if (processName == null) {
    throw new IllegalArgumentException("processName is null");
  }
  if (authKey == null) {
    throw new IllegalArgumentException("authKey is null");
  }
  if (cmd == null) {
    throw new IllegalArgumentException("cmd is null");
  }
  if (workingDir == null) {
    throw new IllegalArgumentException("workingDir is null");
  }
  if (env == null) {
    throw new IllegalArgumentException("env is null");
  }
  if (cmd.length < 1) {
    throw new IllegalArgumentException("cmd must have at least one entry");
  }
  if (authKey.length != 16) {
    throw new IllegalArgumentException("Authentication key must be 16 bytes long");
  }
  final OutputStream os=connection.writeMessage();
  try {
    os.write(Protocol.ADD_PROCESS);
    writeUTFZBytes(os,processName);
    os.write(authKey);
    writeInt(os,cmd.length);
    for (    String c : cmd) {
      writeUTFZBytes(os,c);
    }
    writeInt(os,env.size());
    for (    String key : env.keySet()) {
      writeUTFZBytes(os,key);
      writeUTFZBytes(os,env.get(key));
    }
    writeUTFZBytes(os,workingDir);
    os.close();
  }
  finally {
    safeClose(os);
  }
}
