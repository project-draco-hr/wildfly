{
  try {
    byte[] hash=null;
    String failure=validator.validate(operation);
    if (failure == null) {
      hash=operation.get(HASH).asBytes();
      if (!deploymentRepository.hasDeploymentContent(hash)) {
        failure=String.format("No deployment content with hash %s is available in the deployment content repository.",HashUtil.bytesToHexString(hash));
      }
    }
    if (failure == null) {
      ModelNode rootModel=context.getSubModel();
      ModelNode deployments=rootModel.get(DEPLOYMENT);
      String name=operation.require(NAME).asString();
      String toReplace=operation.require(TO_REPLACE).asString();
      ModelNode replaceNode=has(deployments,toReplace) ? deployments.get(toReplace) : null;
      if (has(deployments,name)) {
        failure=String.format("Deployment with name %s already exists",name);
      }
 else       if (replaceNode == null) {
        failure=String.format("No deployment with name %s found",toReplace);
      }
      if (failure == null) {
        boolean start=replaceNode.get(START).asBoolean();
        String runtimeName=has(operation,RUNTIME_NAME) ? operation.get(RUNTIME_NAME).asString() : name;
        ModelNode deployNode=new ModelNode();
        deployNode.get(NAME).set(name);
        deployNode.get(RUNTIME_NAME).set(runtimeName);
        deployNode.get(HASH).set(hash);
        deployNode.get(START).set(start);
        deployments.get(name).set(deployNode);
        deployments.remove(toReplace);
        ModelNode compensatingOp=operation.clone();
        compensatingOp.get(NAME).set(toReplace);
        compensatingOp.get(RUNTIME_NAME).set(replaceNode.get(RUNTIME_NAME));
        compensatingOp.get(HASH).set(replaceNode.get(HASH));
        compensatingOp.get(START).set(start);
        compensatingOp.get(TO_REPLACE).set(name);
        if (start) {
          DeploymentHandlerUtil.replace(deployNode,toReplace,context,resultHandler,compensatingOp);
        }
 else {
          resultHandler.handleResultComplete(compensatingOp);
        }
      }
    }
    if (failure != null) {
      resultHandler.handleFailed(new ModelNode().set(failure));
    }
  }
 catch (  Exception e) {
    resultHandler.handleFailed(new ModelNode().set(e.getLocalizedMessage()));
  }
  return Cancellable.NULL;
}
