{
  MDC.put("process","process controller");
  String javaHome=System.getProperty("java.home",".");
  String jvmName=javaHome + "/bin/java";
  String jbossHome=System.getProperty("jboss.home.dir",".");
  String modulePath=System.getProperty("jboss.module.path","modules");
  String bootJar="jboss-modules.jar";
  String logModule="org.jboss.logmanager";
  String bootModule=HOST_CONTROLLER_MODULE;
  String bindAddress="127.0.0.1";
  int bindPort=0;
  final List<String> javaOptions=new ArrayList<String>();
  final List<String> smOptions=new ArrayList<String>();
  OUT:   for (int i=0; i < args.length; i++) {
    String arg=args[i];
    if ("-jvm".equals(arg)) {
      jvmName=args[++i];
    }
 else     if ("-jboss-home".equals(arg)) {
      jbossHome=args[++i];
    }
 else     if ("-mp".equals(arg)) {
      modulePath=args[++i];
    }
 else     if ("-jar".equals(arg)) {
      bootJar=args[++i];
    }
 else     if ("-logmodule".equals(arg)) {
      logModule=args[++i];
    }
 else     if ("-bind-addr".equals(arg)) {
      bindAddress=args[++i];
    }
 else     if ("-bind-port".equals(arg)) {
      bindPort=Integer.parseInt(args[++i]);
    }
 else     if ("--".equals(arg)) {
      for (i++; i < args.length; i++) {
        arg=args[i];
        if ("--".equals(arg)) {
          for (i++; i < args.length; i++) {
            arg=args[i];
            smOptions.add(arg);
          }
          break OUT;
        }
 else {
          javaOptions.add(arg);
        }
      }
      break OUT;
    }
 else {
      throw new IllegalArgumentException("Bad option: " + arg);
    }
  }
  Handler consoleHandler=null;
  final Logger rootLogger=Logger.getLogger("");
  for (  Handler handler : rootLogger.getHandlers()) {
    if (handler instanceof ConsoleHandler) {
      if (consoleHandler != null) {
        rootLogger.removeHandler(handler);
      }
 else {
        consoleHandler=handler;
        ((ConsoleHandler)consoleHandler).setWriter(new SynchronizedWriter(System.out));
      }
    }
  }
  final ProtocolServer.Configuration configuration=new ProtocolServer.Configuration();
  if (bindAddress != null) {
    configuration.setBindAddress(new InetSocketAddress(bindAddress,bindPort));
  }
 else {
    configuration.setBindAddress(new InetSocketAddress(bindPort));
  }
  configuration.setBindAddress(new InetSocketAddress(InetAddress.getLocalHost(),0));
  configuration.setSocketFactory(ServerSocketFactory.getDefault());
  configuration.setThreadFactory(Executors.defaultThreadFactory());
  configuration.setReadExecutor(Executors.newCachedThreadPool());
  final ProcessController processController=new ProcessController(configuration,System.out,System.err);
  final InetSocketAddress boundAddress=processController.getServer().getBoundAddress();
  final List<String> initialCommand=new ArrayList<String>();
  initialCommand.add(jvmName);
  initialCommand.add("-D" + "jboss.home.dir=" + jbossHome);
  initialCommand.add("-Xrunjdwp:transport=dt_socket,address=8787,server=y,suspend=n");
  initialCommand.addAll(javaOptions);
  initialCommand.add("-jar");
  initialCommand.add(bootJar);
  initialCommand.add("-mp");
  initialCommand.add(modulePath);
  initialCommand.add("-logmodule");
  initialCommand.add(logModule);
  initialCommand.add(bootModule);
  initialCommand.add(CommandLineConstants.INTERPROCESS_PC_ADDRESS);
  initialCommand.add(boundAddress.getHostName());
  initialCommand.add(CommandLineConstants.INTERPROCESS_PC_PORT);
  initialCommand.add(Integer.toString(boundAddress.getPort()));
  initialCommand.addAll(smOptions);
  processController.addProcess(HOST_CONTROLLER_PROCESS_NAME,initialCommand,Collections.<String,String>emptyMap(),jbossHome,true);
  processController.startProcess(HOST_CONTROLLER_PROCESS_NAME);
  final Thread shutdownThread=new Thread(new Runnable(){
    public void run(){
      processController.shutdown();
    }
  }
,"Shutdown thread");
  shutdownThread.setDaemon(false);
  Runtime.getRuntime().addShutdownHook(shutdownThread);
}
