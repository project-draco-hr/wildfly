{
  MDC.put("process","process controller");
  String javaHome=SecurityActions.getSystemProperty("java.home",".");
  String jvmName=javaHome + "/bin/java";
  String jbossHome=SecurityActions.getSystemProperty("jboss.home.dir",".");
  String modulePath=null;
  String bootJar=null;
  String jaxpModule="javax.xml.jaxp-provider";
  String bootModule=HOST_CONTROLLER_MODULE;
  final PCSocketConfig pcSocketConfig=new PCSocketConfig();
  String currentWorkingDir=SecurityActions.getSystemProperty("user.dir");
  final List<String> javaOptions=new ArrayList<String>();
  final List<String> smOptions=new ArrayList<String>();
  OUT:   for (int i=0; i < args.length; i++) {
    String arg=args[i];
    if ("-jvm".equals(arg)) {
      jvmName=args[++i];
    }
 else     if ("-jboss-home".equals(arg)) {
      jbossHome=args[++i];
    }
 else     if ("-mp".equals(arg)) {
      modulePath=args[++i];
    }
 else     if ("-jar".equals(arg)) {
      bootJar=args[++i];
    }
 else     if ("-jaxpmodule".equals(arg)) {
      jaxpModule=args[++i];
    }
 else     if ("--".equals(arg)) {
      for (i++; i < args.length; i++) {
        arg=args[i];
        if ("--".equals(arg)) {
          for (i++; i < args.length; i++) {
            arg=args[i];
            if (CommandLineConstants.HELP.equals(arg) || CommandLineConstants.SHORT_HELP.equals(arg) || CommandLineConstants.OLD_HELP.equals(arg)) {
              usage();
              return null;
            }
 else             if (CommandLineConstants.VERSION.equals(arg) || CommandLineConstants.SHORT_VERSION.equals(arg) || CommandLineConstants.OLD_VERSION.equals(arg)|| CommandLineConstants.OLD_SHORT_VERSION.equals(arg)) {
              System.out.println(new ProductConfig(Module.getBootModuleLoader(),jbossHome).getPrettyVersionString());
              return null;
            }
 else             if (pcSocketConfig.processPCSocketConfigArgument(arg,args,i)) {
              if (pcSocketConfig.isParseFailed()) {
                return null;
              }
              i+=pcSocketConfig.getArgIncrement();
            }
 else {
              smOptions.add(arg);
            }
          }
          break OUT;
        }
 else         if (pcSocketConfig.processPCSocketConfigArgument(arg,args,i)) {
          if (pcSocketConfig.isParseFailed()) {
            return null;
          }
          i+=pcSocketConfig.getArgIncrement();
        }
 else {
          javaOptions.add(arg);
        }
      }
      break OUT;
    }
 else     if (pcSocketConfig.processPCSocketConfigArgument(arg,args,i)) {
      if (pcSocketConfig.isParseFailed()) {
        return null;
      }
      i+=pcSocketConfig.getArgIncrement();
    }
 else {
      throw MESSAGES.invalidOption(arg);
    }
  }
  if (modulePath == null) {
    modulePath=SecurityActions.getSystemProperty("jboss.module.path",jbossHome + File.separator + "modules");
  }
  if (bootJar == null) {
    bootJar=jbossHome + File.separator + "jboss-modules.jar";
  }
  Handler consoleHandler=null;
  final Logger rootLogger=Logger.getLogger("");
  for (  Handler handler : rootLogger.getHandlers()) {
    if (handler instanceof ConsoleHandler) {
      if (consoleHandler != null) {
        rootLogger.removeHandler(handler);
      }
 else {
        consoleHandler=handler;
        ((ConsoleHandler)consoleHandler).setWriter(new SynchronizedWriter(System.out));
      }
    }
  }
  final ProtocolServer.Configuration configuration=new ProtocolServer.Configuration();
  configuration.setBindAddress(new InetSocketAddress(pcSocketConfig.getBindAddress(),pcSocketConfig.getBindPort()));
  configuration.setSocketFactory(ServerSocketFactory.getDefault());
  final ThreadFactory threadFactory=new JBossThreadFactory(new ThreadGroup("ProcessController-threads"),Boolean.FALSE,null,"%G - %t",null,null,AccessController.getContext());
  configuration.setThreadFactory(threadFactory);
  configuration.setReadExecutor(Executors.newCachedThreadPool(threadFactory));
  final ProcessController processController=new ProcessController(configuration,System.out,System.err);
  final InetSocketAddress boundAddress=processController.getServer().getBoundAddress();
  final List<String> initialCommand=new ArrayList<String>();
  initialCommand.add(jvmName);
  initialCommand.add("-D[" + HOST_CONTROLLER_PROCESS_NAME + "]");
  initialCommand.addAll(javaOptions);
  initialCommand.add("-jar");
  initialCommand.add(bootJar);
  initialCommand.add("-mp");
  initialCommand.add(modulePath);
  initialCommand.add("-jaxpmodule");
  initialCommand.add(jaxpModule);
  initialCommand.add(bootModule);
  initialCommand.add(CommandLineConstants.PROCESS_CONTROLLER_BIND_ADDR);
  initialCommand.add(boundAddress.getHostName());
  initialCommand.add(CommandLineConstants.PROCESS_CONTROLLER_BIND_PORT);
  initialCommand.add(Integer.toString(boundAddress.getPort()));
  initialCommand.addAll(smOptions);
  initialCommand.add("-D" + "jboss.home.dir=" + jbossHome);
  processController.addProcess(HOST_CONTROLLER_PROCESS_NAME,initialCommand,Collections.<String,String>emptyMap(),currentWorkingDir,true,true);
  processController.startProcess(HOST_CONTROLLER_PROCESS_NAME);
  final Thread shutdownThread=new Thread(new Runnable(){
    public void run(){
      processController.shutdown();
    }
  }
,"Shutdown thread");
  shutdownThread.setDaemon(false);
  Runtime.getRuntime().addShutdownHook(shutdownThread);
  return processController;
}
