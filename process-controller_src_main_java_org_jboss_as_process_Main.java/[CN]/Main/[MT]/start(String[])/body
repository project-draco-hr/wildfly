{
  MDC.put("process","process controller");
  String javaHome=System.getProperty("java.home",".");
  String jvmName=javaHome + "/bin/java";
  String jbossHome=System.getProperty("jboss.home.dir",".");
  String modulePath=null;
  String bootJar=null;
  String logModule="org.jboss.logmanager";
  String jaxpModule="javax.xml.jaxp-provider";
  String bootModule=HOST_CONTROLLER_MODULE;
  String bindAddress="127.0.0.1";
  int bindPort=0;
  String currentWorkingDir=System.getProperty("user.dir");
  final List<String> javaOptions=new ArrayList<String>();
  final List<String> smOptions=new ArrayList<String>();
  OUT:   for (int i=0; i < args.length; i++) {
    String arg=args[i];
    if ("-jvm".equals(arg)) {
      jvmName=args[++i];
    }
 else     if ("-jboss-home".equals(arg)) {
      jbossHome=args[++i];
    }
 else     if ("-mp".equals(arg)) {
      modulePath=args[++i];
    }
 else     if ("-jar".equals(arg)) {
      bootJar=args[++i];
    }
 else     if ("-logmodule".equals(arg)) {
      logModule=args[++i];
    }
 else     if ("-jaxpmodule".equals(arg)) {
      jaxpModule=args[++i];
    }
 else     if (CommandLineConstants.BIND_ADDR.equals(arg) || CommandLineConstants.OLD_BIND_ADDR.equals(arg)) {
      bindAddress=args[++i];
    }
 else     if (arg.startsWith(CommandLineConstants.BIND_ADDR)) {
      String addr=parseValue(arg,CommandLineConstants.BIND_ADDR);
      if (addr == null) {
        return null;
      }
      bindAddress=addr;
    }
 else     if (arg.startsWith(CommandLineConstants.OLD_BIND_ADDR)) {
      String addr=parseValue(arg,CommandLineConstants.OLD_BIND_ADDR);
      if (addr == null) {
        return null;
      }
      bindAddress=addr;
    }
 else     if (arg.startsWith(CommandLineConstants.BIND_PORT)) {
      String port=parseValue(arg,CommandLineConstants.BIND_PORT);
      if (port == null) {
        return null;
      }
      bindPort=Integer.parseInt(port);
    }
 else     if (arg.startsWith(CommandLineConstants.OLD_BIND_PORT)) {
      String port=parseValue(arg,CommandLineConstants.OLD_BIND_PORT);
      if (port == null) {
        return null;
      }
      bindPort=Integer.parseInt(port);
    }
 else     if (CommandLineConstants.BIND_PORT.equals(arg) || CommandLineConstants.OLD_BIND_PORT.equals(arg)) {
      bindPort=Integer.parseInt(args[++i]);
    }
 else     if ("--".equals(arg)) {
      for (i++; i < args.length; i++) {
        arg=args[i];
        if ("--".equals(arg)) {
          for (i++; i < args.length; i++) {
            arg=args[i];
            if (CommandLineConstants.HELP.equals(arg) || CommandLineConstants.SHORT_HELP.equals(arg) || CommandLineConstants.OLD_HELP.equals(arg)) {
              usage();
              return null;
            }
 else             if (CommandLineConstants.VERSION.equals(arg) || CommandLineConstants.SHORT_VERSION.equals(arg) || CommandLineConstants.OLD_VERSION.equals(arg)) {
              System.out.println("\nJBoss Application Server " + getVersionString());
              return null;
            }
            smOptions.add(arg);
          }
          break OUT;
        }
 else {
          javaOptions.add(arg);
        }
      }
      break OUT;
    }
 else {
      throw MESSAGES.invalidOption(arg);
    }
  }
  if (modulePath == null) {
    modulePath=System.getProperty("jboss.module.path",jbossHome + File.separator + "modules");
  }
  if (bootJar == null) {
    bootJar=jbossHome + File.separator + "jboss-modules.jar";
  }
  Handler consoleHandler=null;
  final Logger rootLogger=Logger.getLogger("");
  for (  Handler handler : rootLogger.getHandlers()) {
    if (handler instanceof ConsoleHandler) {
      if (consoleHandler != null) {
        rootLogger.removeHandler(handler);
      }
 else {
        consoleHandler=handler;
        ((ConsoleHandler)consoleHandler).setWriter(new SynchronizedWriter(System.out));
      }
    }
  }
  final ProtocolServer.Configuration configuration=new ProtocolServer.Configuration();
  if (bindAddress != null) {
    configuration.setBindAddress(new InetSocketAddress(bindAddress,bindPort));
  }
 else {
    configuration.setBindAddress(new InetSocketAddress(bindPort));
  }
  configuration.setBindAddress(new InetSocketAddress(InetAddress.getLocalHost(),0));
  configuration.setSocketFactory(ServerSocketFactory.getDefault());
  final ThreadFactory threadFactory=new JBossThreadFactory(new ThreadGroup("ProcessController-threads"),Boolean.FALSE,null,"%G - %t",null,null,AccessController.getContext());
  configuration.setThreadFactory(threadFactory);
  configuration.setReadExecutor(Executors.newCachedThreadPool(threadFactory));
  final ProcessController processController=new ProcessController(configuration,System.out,System.err);
  final InetSocketAddress boundAddress=processController.getServer().getBoundAddress();
  final List<String> initialCommand=new ArrayList<String>();
  initialCommand.add(jvmName);
  initialCommand.addAll(javaOptions);
  initialCommand.add("-jar");
  initialCommand.add(bootJar);
  initialCommand.add("-mp");
  initialCommand.add(modulePath);
  initialCommand.add("-logmodule");
  initialCommand.add(logModule);
  initialCommand.add("-jaxpmodule");
  initialCommand.add(jaxpModule);
  initialCommand.add(bootModule);
  initialCommand.add(CommandLineConstants.INTERPROCESS_PC_ADDRESS);
  initialCommand.add(boundAddress.getHostName());
  initialCommand.add(CommandLineConstants.INTERPROCESS_PC_PORT);
  initialCommand.add(Integer.toString(boundAddress.getPort()));
  initialCommand.addAll(smOptions);
  initialCommand.add("-D" + "jboss.home.dir=" + jbossHome);
  processController.addProcess(HOST_CONTROLLER_PROCESS_NAME,initialCommand,Collections.<String,String>emptyMap(),currentWorkingDir,true);
  processController.startProcess(HOST_CONTROLLER_PROCESS_NAME);
  final Thread shutdownThread=new Thread(new Runnable(){
    public void run(){
      processController.shutdown();
    }
  }
,"Shutdown thread");
  shutdownThread.setDaemon(false);
  Runtime.getRuntime().addShutdownHook(shutdownThread);
  return processController;
}
