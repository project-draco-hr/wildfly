{
  EJB ejb=injectionPoint.getAnnotated().getAnnotation(EJB.class);
  if (ejb == null) {
    throw new RuntimeException("@Ejb annotation not found on " + injectionPoint.getMember());
  }
  if (injectionPoint.getMember() instanceof Method && ((Method)injectionPoint.getMember()).getParameterTypes().length != 1) {
    throw new IllegalArgumentException("Injection point represents a method which doesn't follow JavaBean conventions (must have exactly one parameter) " + injectionPoint);
  }
  if (!ejb.lookup().equals("")) {
    final ServiceName ejbServiceName=ContextNames.serviceNameOfContext(moduleDescription.getApplicationName(),moduleDescription.getModuleName(),moduleDescription.getModuleName(),ejb.lookup());
    ServiceController<?> controller=serviceRegistry.getRequiredService(ejbServiceName);
    ManagedReferenceFactory factory=(ManagedReferenceFactory)controller.getValue();
    return factory.getReference().getInstance();
  }
 else   if (applicationDescription != null) {
    final Set<ViewDescription> viewService;
    if (ejb.beanName().isEmpty()) {
      if (ejb.beanInterface() != Object.class) {
        viewService=applicationDescription.getComponentsForViewName(ejb.beanInterface().getName());
      }
 else {
        viewService=applicationDescription.getComponentsForViewName(getType(injectionPoint.getType()).getName());
      }
    }
 else {
      if (ejb.beanInterface() != Object.class) {
        viewService=applicationDescription.getComponents(ejb.beanName(),ejb.beanInterface().getName(),deploymentRoot);
      }
 else {
        viewService=applicationDescription.getComponents(ejb.beanName(),getType(injectionPoint.getType()).getName(),deploymentRoot);
      }
    }
    if (viewService.isEmpty()) {
      throw new RuntimeException("Could not resolve @Ejb reference " + ejb);
    }
 else     if (viewService.size() > 1) {
      throw new RuntimeException("More than 1 ejb found for @Ejb reference " + ejb);
    }
    final ViewDescription viewDescription=viewService.iterator().next();
    final ServiceController<?> controller=serviceRegistry.getRequiredService(viewDescription.getServiceName());
    final ComponentView view=(ComponentView)controller.getValue();
    return view.createInstance().createProxy();
  }
 else {
    throw new RuntimeException("No EjbLookup registry has been provided CDI @EJB injection " + injectionPoint);
  }
}
