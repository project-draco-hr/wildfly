{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  boolean resolveProperties=Util.shouldResolveJBoss(deploymentUnit);
  final PropertyResolver propertyResolver=deploymentUnit.getAttachment(org.jboss.as.ee.metadata.property.Attachments.FINAL_PROPERTY_RESOLVER);
  final Set<VirtualFile> files=dataSources(deploymentUnit);
  for (  VirtualFile f : files) {
    InputStream xmlStream=null;
    try {
      xmlStream=new FileInputStream(f.getPhysicalFile());
      DsXmlParser parser=new DsXmlParser(propertyResolver);
      parser.setSystemPropertiesResolved(resolveProperties);
      DataSources dataSources=parser.parse(xmlStream);
      if (dataSources != null) {
        for (        DataSource ds : dataSources.getDataSource()) {
          if (ds.getDriver() == null) {
            throw MESSAGES.FailedDeployDriverNotSpecified(ds.getJndiName());
          }
        }
        deploymentUnit.addToAttachmentList(DATA_SOURCES_ATTACHMENT_KEY,dataSources);
      }
    }
 catch (    Exception e) {
      throw new DeploymentUnitProcessingException(e.getMessage(),e);
    }
 finally {
      VFSUtils.safeClose(xmlStream);
    }
  }
}
