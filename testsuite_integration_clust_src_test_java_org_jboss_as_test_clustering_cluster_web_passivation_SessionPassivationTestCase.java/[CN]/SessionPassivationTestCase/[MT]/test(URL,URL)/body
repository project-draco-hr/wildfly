{
  DefaultHttpClient client1=org.jboss.as.test.http.util.HttpClientUtils.relaxedCookieHttpClient();
  DefaultHttpClient client2=org.jboss.as.test.http.util.HttpClientUtils.relaxedCookieHttpClient();
  String session1=null;
  String session2=null;
  try {
    HttpResponse response=client1.execute(new HttpGet(SessionOperationServlet.createSetURI(baseURL1,"a","1")));
    try {
      Assert.assertFalse(response.containsHeader(SessionOperationServlet.ACTIVATED_SESSIONS));
      Assert.assertFalse(response.containsHeader(SessionOperationServlet.PASSIVATED_SESSIONS));
      session1=response.getFirstHeader(SessionOperationServlet.SESSION_ID).getValue();
    }
  finally {
      HttpClientUtils.closeQuietly(response);
    }
    response=client2.execute(new HttpGet(SessionOperationServlet.createSetURI(baseURL1,"a","2")));
    try {
      Assert.assertTrue(response.containsHeader(SessionOperationServlet.SESSION_ID));
      Assert.assertFalse(response.containsHeader(SessionOperationServlet.ACTIVATED_SESSIONS));
      Assert.assertFalse(response.containsHeader(SessionOperationServlet.PASSIVATED_SESSIONS));
      session2=response.getFirstHeader(SessionOperationServlet.SESSION_ID).getValue();
    }
  finally {
      HttpClientUtils.closeQuietly(response);
    }
    Thread.sleep(500);
    response=client2.execute(new HttpGet(SessionOperationServlet.createGetURI(baseURL1,"a")));
    try {
      Assert.assertTrue(response.containsHeader(SessionOperationServlet.RESULT));
      Assert.assertEquals("2",response.getFirstHeader(SessionOperationServlet.RESULT).getValue());
      Assert.assertFalse(response.containsHeader(SessionOperationServlet.ACTIVATED_SESSIONS));
      Assert.assertTrue(response.containsHeader(SessionOperationServlet.PASSIVATED_SESSIONS));
      Assert.assertEquals(session1,response.getFirstHeader(SessionOperationServlet.PASSIVATED_SESSIONS).getValue());
    }
  finally {
      HttpClientUtils.closeQuietly(response);
    }
    response=client1.execute(new HttpGet(SessionOperationServlet.createGetURI(baseURL1,"a")));
    try {
      Assert.assertTrue(response.containsHeader(SessionOperationServlet.RESULT));
      Assert.assertEquals("1",response.getFirstHeader(SessionOperationServlet.RESULT).getValue());
      Assert.assertTrue(response.containsHeader(SessionOperationServlet.ACTIVATED_SESSIONS));
      Assert.assertFalse(response.containsHeader(SessionOperationServlet.PASSIVATED_SESSIONS));
      Assert.assertEquals(session1,response.getFirstHeader(SessionOperationServlet.ACTIVATED_SESSIONS).getValue());
    }
  finally {
      HttpClientUtils.closeQuietly(response);
    }
    Thread.sleep(500);
    response=client1.execute(new HttpGet(SessionOperationServlet.createGetURI(baseURL1,"a")));
    try {
      Assert.assertTrue(response.containsHeader(SessionOperationServlet.RESULT));
      Assert.assertEquals("1",response.getFirstHeader(SessionOperationServlet.RESULT).getValue());
      Assert.assertFalse(response.containsHeader(SessionOperationServlet.ACTIVATED_SESSIONS));
      Assert.assertTrue(response.containsHeader(SessionOperationServlet.PASSIVATED_SESSIONS));
      Assert.assertEquals(session2,response.getFirstHeader(SessionOperationServlet.PASSIVATED_SESSIONS).getValue());
    }
  finally {
      HttpClientUtils.closeQuietly(response);
    }
  }
  finally {
    HttpClientUtils.closeQuietly(client1);
    HttpClientUtils.closeQuietly(client2);
  }
}
