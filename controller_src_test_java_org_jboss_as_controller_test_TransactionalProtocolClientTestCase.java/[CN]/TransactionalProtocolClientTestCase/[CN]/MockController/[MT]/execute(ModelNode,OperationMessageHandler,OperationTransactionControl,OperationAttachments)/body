{
  lock.lock();
  try {
    if (handler != null) {
      try {
        handler.execute(operation,messageHandler,attachments);
      }
 catch (      Exception e) {
        throw new RuntimeException(e);
      }
    }
    control.operationPrepared(new OperationTransaction(){
      @Override public void commit(){
        action.setResult(OperationContext.ResultAction.KEEP);
      }
      @Override public void rollback(){
        action.setResult(OperationContext.ResultAction.ROLLBACK);
      }
    }
,SUCCESS);
    return getAction() == OperationContext.ResultAction.KEEP ? SUCCESS : FAILURE;
  }
  finally {
    lock.unlock();
  }
}
