{
  Deployment deployment=OSGiDeploymentAttachment.getAttachment(phaseContext);
  if (deployment != null)   return;
  String resName="META-INF/jbosgi-xservice.properties";
  VirtualFile virtualFile=phaseContext.getAttachment(Attachments.DEPLOYMENT_ROOT);
  VirtualFile xserviceFile=virtualFile.getChild(resName);
  if (xserviceFile.exists()) {
    try {
      OSGiMetaData metadata=OSGiMetaDataBuilder.load(xserviceFile.openStream());
      String location=virtualFile.getPathName();
      String symbolicName=metadata.getBundleSymbolicName();
      Version version=metadata.getBundleVersion();
      deployment=DeploymentFactory.createDeployment(AbstractVFS.adapt(virtualFile),location,symbolicName,version);
      deployment.addAttachment(OSGiMetaData.class,metadata);
      OSGiMetaDataAttachment.attachOSGiMetaData(phaseContext,metadata);
      OSGiDeploymentAttachment.attachDeployment(phaseContext,deployment);
    }
 catch (    IOException ex) {
      throw new DeploymentUnitProcessingException("Cannot parse: " + xserviceFile);
    }
  }
}
