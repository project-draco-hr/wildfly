{
  JavaArchive apiArchive=getAPIModuleArchive();
  assertNull("Bundle null",executeDeploy(apiArchive));
  ModuleIdentifier apiId=ModuleIdentifier.create("test." + apiArchive.getName());
  assertNotNull("Module not null",loadModule(apiId));
  Bundle apiBundle=getBundleManager().installBundle(apiId);
  assertBundleState(Bundle.INSTALLED,apiBundle.getState());
  assertLoadClass(apiBundle,Echo.class.getName());
  JavaArchive targetArchive=getTargetBundleArchive();
  Bundle targetBundle=executeDeploy(targetArchive);
  assertBundleState(Bundle.INSTALLED,targetBundle.getState());
  targetBundle.start();
  assertBundleState(Bundle.ACTIVE,targetBundle.getState());
  JavaArchive clientArchive=getClientModuleArchive();
  assertNull("Bundle null",executeDeploy(clientArchive));
  ModuleIdentifier clientId=ModuleIdentifier.create("test." + clientArchive.getName());
  assertNotNull("Module not null",loadModule(clientId));
  registerClientService(clientId);
  String result=invokeClientService(clientId,"hello world");
  assertEquals("hello world",result);
  executeUndeploy(clientArchive);
  targetBundle.uninstall();
  assertBundleState(Bundle.UNINSTALLED,targetBundle.getState());
  apiBundle.uninstall();
  assertBundleState(Bundle.UNINSTALLED,apiBundle.getState());
}
