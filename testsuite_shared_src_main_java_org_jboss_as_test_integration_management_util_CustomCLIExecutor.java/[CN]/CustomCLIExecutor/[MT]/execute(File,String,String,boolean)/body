{
  String cliOutput;
  String jbossDist=System.getProperty("jboss.dist");
  if (jbossDist == null) {
    fail("jboss.dist system property is not set");
  }
  final String modulePath=System.getProperty("module.path");
  if (modulePath == null) {
    fail("module.path system property is not set");
  }
  final ProcessBuilder builder=new ProcessBuilder();
  builder.redirectErrorStream(true);
  final List<String> command=new ArrayList<String>();
  command.add(TestSuiteEnvironment.getJavaPath());
  TestSuiteEnvironment.getIpv6Args(command);
  if (cliConfigFile != null) {
    command.add("-Djboss.cli.config=" + cliConfigFile.getAbsolutePath());
  }
 else {
    command.add("-Djboss.cli.config=" + jbossDist + File.separator+ "bin"+ File.separator+ "jboss-cli.xml");
  }
  command.add("-jar");
  command.add(jbossDist + File.separatorChar + "jboss-modules.jar");
  command.add("-mp");
  command.add(modulePath);
  command.add("org.jboss.as.cli");
  command.add("-c");
  command.add("--controller=" + controller);
  command.add(operation);
  builder.command(command);
  Process cliProc=null;
  try {
    cliProc=builder.start();
  }
 catch (  IOException e) {
    fail("Failed to start CLI process: " + e.getLocalizedMessage());
  }
  final InputStream cliStream=cliProc.getInputStream();
  final StringBuilder cliOutBuf=new StringBuilder();
  boolean wait=true;
  int runningTime=0;
  int exitCode=0;
  do {
    try {
      Thread.sleep(STATUS_CHECK_INTERVAL);
    }
 catch (    InterruptedException e) {
    }
    runningTime+=STATUS_CHECK_INTERVAL;
    readStream(cliOutBuf,cliStream);
    try {
      exitCode=cliProc.exitValue();
      wait=false;
      readStream(cliOutBuf,cliStream);
    }
 catch (    IllegalThreadStateException e) {
    }
    if (runningTime >= CLI_PROC_TIMEOUT) {
      readStream(cliOutBuf,cliStream);
      cliProc.destroy();
      wait=false;
    }
  }
 while (wait);
  cliOutput=cliOutBuf.toString();
  if (logFailure && exitCode != 0) {
    LOGGER.info("Command's output: '" + cliOutput + "'");
    try {
      int bytesTotal=cliProc.getErrorStream().available();
      if (bytesTotal > 0) {
        final byte[] bytes=new byte[bytesTotal];
        cliProc.getErrorStream().read(bytes);
        LOGGER.info("Command's error log: '" + new String(bytes) + "'");
      }
 else {
        LOGGER.info("No output data for the command.");
      }
    }
 catch (    IOException e) {
      fail("Failed to read command's error output: " + e.getLocalizedMessage());
    }
  }
  return exitCode + ": " + cliOutput;
}
