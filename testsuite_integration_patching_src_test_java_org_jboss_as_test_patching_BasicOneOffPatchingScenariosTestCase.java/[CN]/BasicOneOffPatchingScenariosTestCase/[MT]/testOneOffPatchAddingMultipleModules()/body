{
  File tempDir=mkdir(new File(System.getProperty("java.io.tmpdir")),randomString());
  String patchID=randomString();
  String layerPatchID=randomString();
  File oneOffPatchDir=mkdir(tempDir,patchID);
  final String moduleName1="org.wildfly.awesomemodule1";
  final String modulePath1=PATCHES_PATH + FILE_SEPARATOR + layerPatchID+ FILE_SEPARATOR+ moduleName1.replace(".",FILE_SEPARATOR)+ FILE_SEPARATOR+ "main";
  final String moduleName2="org.wildfly.awesomemodul2";
  final String modulePath2=PATCHES_PATH + FILE_SEPARATOR + layerPatchID+ FILE_SEPARATOR+ moduleName2.replace(".",FILE_SEPARATOR)+ FILE_SEPARATOR+ "main";
  final ResourceItem resourceItem1=new ResourceItem("testFile1","content1".getBytes());
  final ResourceItem resourceItem2=new ResourceItem("testFile2","content2".getBytes());
  ContentModification moduleAdded1=ContentModificationUtils.addModule(oneOffPatchDir,layerPatchID,moduleName1,resourceItem1,resourceItem2);
  ContentModification moduleAdded2=ContentModificationUtils.addModule(oneOffPatchDir,layerPatchID,moduleName2,resourceItem1,resourceItem2);
  ProductConfig productConfig=new ProductConfig(PRODUCT,AS_VERSION,"main");
  Patch oneOffPatch=PatchBuilder.create().setPatchId(patchID).setDescription("A one-off patch adding multiple modules.").oneOffPatchIdentity(productConfig.getProductName(),productConfig.getProductVersion()).getParent().oneOffPatchElement(layerPatchID,"base",false).setDescription("New modules for the base layer").addContentModification(moduleAdded1).addContentModification(moduleAdded2).getParent().build();
  createPatchXMLFile(oneOffPatchDir,oneOffPatch);
  File zippedPatch=createZippedPatchFile(oneOffPatchDir,patchID);
  controller.start(CONTAINER);
  CliUtilsForPatching.applyPatch(zippedPatch.getAbsolutePath());
  Assert.assertTrue("server should be in restart-required mode",CliUtilsForPatching.doesServerRequireRestart());
  controller.stop(CONTAINER);
  controller.start(CONTAINER);
  Assert.assertTrue("The patch " + patchID + " should be listed as installed",CliUtilsForPatching.getInstalledPatches().contains(patchID));
  Assert.assertTrue("The file " + resourceItem1.getItemName() + " should exist",new File(modulePath1 + FILE_SEPARATOR + resourceItem1.getItemName()).exists());
  Assert.assertTrue("The file " + resourceItem2.getItemName() + " should exist",new File(modulePath1 + FILE_SEPARATOR + resourceItem2.getItemName()).exists());
  Assert.assertTrue("The file " + resourceItem1.getItemName() + " should exist",new File(modulePath2 + FILE_SEPARATOR + resourceItem1.getItemName()).exists());
  Assert.assertTrue("The file " + resourceItem2.getItemName() + " should exist",new File(modulePath2 + FILE_SEPARATOR + resourceItem2.getItemName()).exists());
  CliUtilsForPatching.rollbackPatch(patchID);
  Assert.assertTrue("server should be in restart-required mode",CliUtilsForPatching.doesServerRequireRestart());
  controller.stop(CONTAINER);
  controller.start(CONTAINER);
  Assert.assertFalse("The patch " + patchID + " NOT should be listed as installed",CliUtilsForPatching.getInstalledPatches().contains(patchID));
  Assert.assertFalse("The file " + resourceItem1.getItemName() + "should have been deleted",new File(modulePath1 + FILE_SEPARATOR + resourceItem1.getItemName()).exists());
  Assert.assertFalse("The file " + resourceItem2.getItemName() + "should have been deleted",new File(modulePath1 + FILE_SEPARATOR + resourceItem2.getItemName()).exists());
  Assert.assertFalse("The file " + resourceItem1.getItemName() + "should have been deleted",new File(modulePath2 + FILE_SEPARATOR + resourceItem1.getItemName()).exists());
  Assert.assertFalse("The file " + resourceItem2.getItemName() + "should have been deleted",new File(modulePath2 + FILE_SEPARATOR + resourceItem2.getItemName()).exists());
  CliUtilsForPatching.applyPatch(zippedPatch.getAbsolutePath());
  Assert.assertTrue("server should be in restart-required mode",CliUtilsForPatching.doesServerRequireRestart());
  controller.stop(CONTAINER);
  controller.start(CONTAINER);
  controller.start(CONTAINER);
  Assert.assertTrue("The patch " + patchID + " should be listed as installed",CliUtilsForPatching.getInstalledPatches().contains(patchID));
  Assert.assertTrue("The file " + resourceItem1.getItemName() + " should exist",new File(modulePath1 + FILE_SEPARATOR + resourceItem1.getItemName()).exists());
  Assert.assertTrue("The file " + resourceItem2.getItemName() + " should exist",new File(modulePath1 + FILE_SEPARATOR + resourceItem2.getItemName()).exists());
  Assert.assertTrue("The file " + resourceItem1.getItemName() + " should exist",new File(modulePath2 + FILE_SEPARATOR + resourceItem1.getItemName()).exists());
  Assert.assertTrue("The file " + resourceItem2.getItemName() + " should exist",new File(modulePath2 + FILE_SEPARATOR + resourceItem2.getItemName()).exists());
  controller.stop(CONTAINER);
}
