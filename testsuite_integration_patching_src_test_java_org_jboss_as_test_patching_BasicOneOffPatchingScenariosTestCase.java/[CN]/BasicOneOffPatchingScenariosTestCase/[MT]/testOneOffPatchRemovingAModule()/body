{
  String patchID=randomString();
  String layerPatchID=randomString();
  File oneOffPatchDir=mkdir(tempDir,patchID);
  final String moduleName="org.wildfly.test." + randomString();
  Module module=new Module.Builder(moduleName).build();
  File moduleDir=module.writeToDisk(new File(MODULES_PATH));
  File patchModuleDir=newFile(new File(PATCHES_PATH),layerPatchID);
  patchModuleDir=newFile(patchModuleDir,moduleName.split("\\."));
  File moduleXml=newFile(patchModuleDir,"main","module.xml");
  ContentModification moduleRemoved=ContentModificationUtils.removeModule(moduleName,moduleDir);
  ProductConfig productConfig=new ProductConfig(PRODUCT,AS_VERSION,"main");
  Patch oneOffPatch=PatchBuilder.create().setPatchId(patchID).setDescription("A one-off patch removing a module.").oneOffPatchIdentity(productConfig.getProductName(),productConfig.getProductVersion()).getParent().oneOffPatchElement(layerPatchID,"base",false).setDescription("Remove module").addContentModification(moduleRemoved).getParent().build();
  createPatchXMLFile(oneOffPatchDir,oneOffPatch);
  File zippedPatch=createZippedPatchFile(oneOffPatchDir,patchID);
  controller.start(CONTAINER);
  Assert.assertTrue("Patch should be accepted",CliUtilsForPatching.applyPatch(zippedPatch.getAbsolutePath()));
  Assert.assertTrue("server should be in restart-required mode",CliUtilsForPatching.doesServerRequireRestart());
  controller.stop(CONTAINER);
  controller.start(CONTAINER);
  Assert.assertTrue("The patch " + patchID + " should be listed as installed",CliUtilsForPatching.getInstalledPatches().contains(patchID));
  Assert.assertTrue("The file " + moduleXml.getName() + " should exist",moduleXml.exists());
  try {
    List<String> paths=CliUtilsForPatching.getResourceLoaderPathsForModule(moduleName,true);
    Assert.fail("Module " + moduleName + " should have been removed by the patch");
  }
 catch (  RuntimeException expected) {
  }
  Assert.assertTrue("Rollback should be accepted",CliUtilsForPatching.rollbackPatch(patchID));
  Assert.assertTrue("server should be in restart-required mode",CliUtilsForPatching.doesServerRequireRestart());
  controller.stop(CONTAINER);
  controller.start(CONTAINER);
  CliUtilsForPatching.getResourceLoaderPathsForModule(moduleName,true);
  Assert.assertFalse("The patch " + patchID + " NOT should be listed as installed",CliUtilsForPatching.getInstalledPatches().contains(patchID));
  CliUtilsForPatching.getResourceLoaderPathsForModule(moduleName,true);
  Assert.assertTrue("Patch should be accepted",CliUtilsForPatching.applyPatch(zippedPatch.getAbsolutePath()));
  Assert.assertTrue("server should be in restart-required mode",CliUtilsForPatching.doesServerRequireRestart());
  controller.stop(CONTAINER);
  controller.start(CONTAINER);
  Assert.assertTrue("The patch " + patchID + " should be listed as installed",CliUtilsForPatching.getInstalledPatches().contains(patchID));
  Assert.assertTrue("The file " + moduleXml.getName() + " should exist",moduleXml.exists());
  try {
    CliUtilsForPatching.getResourceLoaderPathsForModule(moduleName,true);
    Assert.fail("Module " + moduleName + " should have been removed by the patch");
  }
 catch (  RuntimeException expected) {
  }
  controller.stop(CONTAINER);
}
