{
  ensureFrameworkActive();
  int initial=FrameworkManagement.getFrameworkStartLevel(getControllerClient());
  try {
    assertEquals(1,initial);
    deployer.deploy("test-bundle2");
    Long testBundleId=FrameworkManagement.getBundleId(getControllerClient(),"test-bundle2",Version.parseVersion("1.2.3.something"));
    assertTrue(testBundleId > 0);
    assertTrue(FrameworkManagement.bundleStart(getControllerClient(),testBundleId));
    ModelNode resultMap=FrameworkManagement.getBundleInfo(getControllerClient(),testBundleId);
    assertEquals("ACTIVE",resultMap.get(ModelConstants.STATE).asString());
    assertTrue(FrameworkManagement.setFrameworkStartLevel(getControllerClient(),0));
    if (!waitForBundleStateAfterStartLevelChange("RESOLVED",testBundleId,10000)) {
      fail("Bundle not RESOLVED");
    }
  }
  finally {
    assertTrue(FrameworkManagement.setFrameworkStartLevel(getControllerClient(),initial));
  }
}
