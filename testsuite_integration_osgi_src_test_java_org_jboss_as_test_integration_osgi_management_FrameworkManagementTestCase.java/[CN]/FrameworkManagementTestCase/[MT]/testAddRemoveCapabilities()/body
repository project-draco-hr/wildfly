{
  ensureFrameworkActive();
  String capabilityName="org.jboss.test.testcap" + System.currentTimeMillis();
  String basedir=System.getProperty("jboss.dist");
  File targetdir=new File(basedir + "/bundles/" + capabilityName.replace(".","/")+ "/main");
  targetdir.mkdirs();
  File bundleFile=new File(targetdir,"testcapabilitybundle.jar");
  JavaArchive capabilityBundle=createTestBundle("capability-bundle","1.0.1");
  capabilityBundle.as(ZipExporter.class).exportTo(bundleFile);
  FrameworkManagement.addCapability(getControllerClient(),capabilityName,1);
  assertTrue(FrameworkManagement.listCapabilities(getControllerClient()).contains(capabilityName));
  Long capBundleId=FrameworkManagement.getBundleId(getControllerClient(),"capability-bundle",Version.parseVersion("1.0.1"));
  assertEquals("The capability bundle should not yet be added to the system, this requires a restart",new Long(-1),capBundleId);
  FrameworkManagement.removeCapability(getControllerClient(),capabilityName);
  assertFalse(FrameworkManagement.listCapabilities(getControllerClient()).contains(capabilityName));
  bundleFile.delete();
}
