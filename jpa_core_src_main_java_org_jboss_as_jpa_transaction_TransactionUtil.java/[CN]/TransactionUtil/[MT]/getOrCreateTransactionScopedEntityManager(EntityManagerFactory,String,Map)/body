{
  EntityManager entityManager=getEntityManagerInTransactionRegistry(scopedPuName);
  if (entityManager == null) {
    entityManager=EntityManagerUtil.createEntityManager(emf,properties);
    if (JPA_LOGGER.isDebugEnabled())     JPA_LOGGER.debugf("%s: created entity manager session %s",getEntityManagerDetails(entityManager),getTransaction().toString());
    registerSynchronization(entityManager,scopedPuName,true);
    putEntityManagerInTransactionRegistry(scopedPuName,entityManager);
    entityManager.joinTransaction();
  }
 else {
    if (JPA_LOGGER.isDebugEnabled()) {
      JPA_LOGGER.debugf("%s: reuse entity manager session already in tx %s",getEntityManagerDetails(entityManager),getTransaction().toString());
    }
  }
  return entityManager;
}
