{
  EntityManager entityManager=getEntityManagerInTransactionRegistry(scopedPuName);
  if (entityManager == null) {
    entityManager=EntityManagerUtil.createEntityManager(emf,properties);
    if (log.isDebugEnabled())     log.debug(getEntityManagerDetails(entityManager) + ": created entity manager session " + getTransaction().toString());
    registerSynchronization(entityManager,scopedPuName,true);
    putEntityManagerInTransactionRegistry(scopedPuName,entityManager);
    entityManager.joinTransaction();
  }
 else {
    if (log.isDebugEnabled()) {
      log.debug(getEntityManagerDetails(entityManager) + ": reuse entity manager session already in tx" + getTransaction().toString());
    }
  }
  return entityManager;
}
