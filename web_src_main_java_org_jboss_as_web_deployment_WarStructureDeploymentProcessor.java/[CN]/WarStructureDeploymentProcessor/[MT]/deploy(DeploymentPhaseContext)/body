{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (!isWarDeployment(deploymentUnit)) {
    return;
  }
  final ResourceRoot deploymentResourceRoot=phaseContext.getDeploymentUnit().getAttachment(Attachments.DEPLOYMENT_ROOT);
  final VirtualFile deploymentRoot=deploymentResourceRoot.getRoot();
  if (deploymentRoot == null) {
    return;
  }
  deploymentResourceRoot.putAttachment(Attachments.INDEX_RESOURCE_ROOT,false);
  final MountHandle mountHandle=deploymentResourceRoot.getMountHandle();
  try {
    final ClassPathEntry[] entries=createClassPathEntries(deploymentRoot,mountHandle);
    final DeploymentStructure structure=new DeploymentStructure(entries);
    deploymentUnit.putAttachment(DeploymentStructure.ATTACHMENT_KEY,structure);
    final ServiceTarget target=phaseContext.getServiceTarget();
    final ServiceName sName=phaseContext.getPhaseServiceName().append("war","structure");
    target.addService(sName,new DeploymentStructureService(structure)).addDependency(phaseContext.getPhaseServiceName()).install();
    target.addDependency(sName);
    final ResourceRoot[] resourceRoots=createResourceRoots(deploymentUnit.getAttachment(DeploymentStructure.ATTACHMENT_KEY));
    for (    ResourceRoot root : resourceRoots) {
      deploymentUnit.addToAttachmentList(Attachments.RESOURCE_ROOTS,root);
    }
  }
 catch (  Exception e) {
    throw new DeploymentUnitProcessingException(e);
  }
  final WarMetaData warMetaData=new WarMetaData();
  warMetaData.setSharedWebMetaData(sharedWebMetaData);
  deploymentUnit.putAttachment(WarMetaData.ATTACHMENT_KEY,warMetaData);
  final TldsMetaData tldsMetaData=new TldsMetaData();
  tldsMetaData.setSharedTlds(sharedTldsMetaData);
  deploymentUnit.putAttachment(TldsMetaData.ATTACHMENT_KEY,tldsMetaData);
}
