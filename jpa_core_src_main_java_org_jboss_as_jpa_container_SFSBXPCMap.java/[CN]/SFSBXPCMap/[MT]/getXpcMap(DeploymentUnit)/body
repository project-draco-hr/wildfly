{
  final DeploymentUnit top=deploymentUnit.getParent() == null ? deploymentUnit : deploymentUnit.getParent();
  SFSBXPCMap sfsbMap=top.getAttachment(SFSBXPCMap.ATTACHMENT_KEY);
  if (sfsbMap == null) {
synchronized (top) {
      PerApplicationKeyWrapper perApplicationKeyWrapper=top.getAttachment(SFSBXPCMap.DU_REF_TO_APPLICATION);
      if (perApplicationKeyWrapper == null) {
        perApplicationKeyWrapper=new PerApplicationKeyWrapper(getApplicationDeploymentBagKeyName(top));
        top.putAttachment(SFSBXPCMap.DU_REF_TO_APPLICATION,perApplicationKeyWrapper);
      }
      sfsbMap=top.getAttachment(SFSBXPCMap.ATTACHMENT_KEY);
      if (sfsbMap == null) {
        top.putAttachment(SFSBXPCMap.ATTACHMENT_KEY,sfsbMap=new SFSBXPCMap());
        perDeploymentBag.put(perApplicationKeyWrapper,new WeakReference<SFSBXPCMap>(sfsbMap));
      }
    }
  }
  return sfsbMap;
}
