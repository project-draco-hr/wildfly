{
  if (!(entityManager instanceof ExtendedEntityManager)) {
    throw MESSAGES.parameterMustBeAbstractEntityManager("XPC");
  }
  Set<ExtendedEntityManager> xpcSet=contextToXPCMap.get(beanContextHandle);
  if (xpcSet == null) {
    xpcSet=new HashSet<ExtendedEntityManager>();
    xpcSet.add((ExtendedEntityManager)entityManager);
    Object existingSet=contextToXPCMap.put(beanContextHandle,xpcSet);
    if (existingSet != null) {
      throw MESSAGES.multipleThreadsInvokingSfsb(beanContextHandle);
    }
  }
 else {
    xpcSet.add((ExtendedEntityManager)entityManager);
  }
  List<SFSBContextHandle> sfsbList=XPCToContextMap.get(entityManager);
  if (sfsbList == null) {
    sfsbList=new ArrayList<SFSBContextHandle>();
    Object existingList=XPCToContextMap.put((ExtendedEntityManager)entityManager,sfsbList);
    if (existingList != null) {
      throw MESSAGES.multipleThreadsUsingEntityManager(entityManager);
    }
  }
  sfsbList.add(beanContextHandle);
}
