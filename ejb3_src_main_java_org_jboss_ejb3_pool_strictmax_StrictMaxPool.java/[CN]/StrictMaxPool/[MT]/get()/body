{
  try {
    boolean acquired=semaphore.tryAcquire(timeout,timeUnit);
    if (!acquired)     throw new EJBException("Failed to acquire a permit within " + timeout + " "+ timeUnit);
  }
 catch (  InterruptedException e) {
    throw new EJBException("Acquire semaphore was interrupted");
  }
synchronized (pool) {
    if (!pool.isEmpty()) {
      return pool.removeFirst();
    }
  }
  T bean=null;
  try {
    ++inUse;
    bean=create();
  }
  finally {
    if (bean == null) {
      --inUse;
      semaphore.release();
    }
  }
  return bean;
}
