{
  if (!writable.compareAndSet(true,false)) {
    throw new IllegalStateException();
  }
  try {
    final PatchableTarget.TargetInfo identityInfo=identity.loadTargetInfo();
    final InstallationModificationImpl.InstallationState state=this.state;
    return new InstallationModificationImpl(identityInfo,identity.getVersion(),state){
      @Override public void complete(){
        try {
          final InstallationState newState=internalComplete();
          callback.completed();
          InstallationManagerImpl.this.state=newState;
          writable.set(true);
        }
 catch (        Exception e) {
          cancel();
          throw new RuntimeException(e);
        }
      }
      @Override public void cancel(){
        try {
          callback.canceled();
        }
  finally {
          writable.set(true);
        }
      }
    }
;
  }
 catch (  Exception e) {
    writable.set(true);
    throw new RuntimeException(e);
  }
}
