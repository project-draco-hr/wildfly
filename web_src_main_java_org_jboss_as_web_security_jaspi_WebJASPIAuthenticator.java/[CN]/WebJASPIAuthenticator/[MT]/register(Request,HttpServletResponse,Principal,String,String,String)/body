{
  if (log.isTraceEnabled()) {
    String name=(principal == null) ? "none" : principal.getName();
    log.tracef("Authenticated '%s' with type '" + authType + "'",name,authType);
  }
  request.setAuthType(authType);
  request.setUserPrincipal(principal);
  Session session=request.getSessionInternal(false);
  if (cache) {
    if (session != null) {
      session.setAuthType(authType);
      session.setPrincipal(principal);
      if (username != null)       session.setNote(Constants.SESS_USERNAME_NOTE,username);
 else       session.removeNote(Constants.SESS_USERNAME_NOTE);
      if (password != null)       session.setNote(Constants.SESS_PASSWORD_NOTE,password);
 else       session.removeNote(Constants.SESS_PASSWORD_NOTE);
    }
  }
  if (sso == null)   return;
  String ssoId=(String)request.getNote(Constants.REQ_SSOID_NOTE);
  if (ssoId == null) {
    ssoId=generateSessionId(new Random());
    Cookie cookie=new Cookie(Constants.SINGLE_SIGN_ON_COOKIE,ssoId);
    cookie.setMaxAge(-1);
    cookie.setPath("/");
    cookie.setSecure(request.isSecure());
    String ssoDomain=sso.getCookieDomain();
    if (ssoDomain != null) {
      cookie.setDomain(ssoDomain);
    }
    response.addCookie(cookie);
    sso.register(ssoId,principal,authType,username,password);
    request.setNote(Constants.REQ_SSOID_NOTE,ssoId);
  }
 else {
    sso.update(ssoId,principal,authType,username,password);
  }
  if (session == null)   session=request.getSessionInternal(true);
  sso.associate(ssoId,session);
}
