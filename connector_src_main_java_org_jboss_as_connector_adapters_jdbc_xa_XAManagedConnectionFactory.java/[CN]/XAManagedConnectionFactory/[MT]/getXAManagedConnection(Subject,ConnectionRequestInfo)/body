{
  XAConnection xaConnection=null;
  Properties props=getConnectionProperties(subject,cri);
  try {
    final String user=props.getProperty("user");
    final String password=props.getProperty("password");
    xaConnection=(user != null) ? getXADataSource().getXAConnection(user,password) : getXADataSource().getXAConnection();
    return newXAManagedConnection(props,xaConnection);
  }
 catch (  Throwable e) {
    try {
      if (xaConnection != null)       xaConnection.close();
    }
 catch (    Throwable ignored) {
    }
    throw new ResourceException("Could not create connection",e);
  }
}
