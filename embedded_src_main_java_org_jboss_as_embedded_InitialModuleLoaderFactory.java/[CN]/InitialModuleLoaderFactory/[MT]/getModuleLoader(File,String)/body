{
  if (modulePath == null)   throw MESSAGES.nullVar("modulePath");
  if (modulePath.isDirectory() == false)   throw MESSAGES.invalidModulePath(modulePath.getAbsolutePath());
  String oldClassPath=WildFlySecurityManager.getPropertyPrivileged("java.class.path",null);
  try {
    WildFlySecurityManager.clearPropertyPrivileged("java.class.path");
    WildFlySecurityManager.setPropertyPrivileged("module.path",modulePath.getAbsolutePath());
    StringBuffer packages=new StringBuffer("org.jboss.modules," + InitialModuleLoaderFactory.class.getPackage().getName());
    packages.append(",org.jboss.as.controller.client,org.jboss.dmr");
    if (systemPackages != null) {
      for (      String packageName : systemPackages)       packages.append("," + packageName);
    }
    WildFlySecurityManager.setPropertyPrivileged("jboss.modules.system.pkgs",packages.toString());
    ModuleLoader moduleLoader=Module.getBootModuleLoader();
    return moduleLoader;
  }
  finally {
    WildFlySecurityManager.setPropertyPrivileged("java.class.path",oldClassPath);
  }
}
