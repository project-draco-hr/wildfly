{
  if (modulePath == null || modulePath.isDirectory() == false)   throw MESSAGES.invalidModulePath(modulePath);
  String oldClassPath=SecurityActions.getSystemProperty("java.class.path");
  try {
    SecurityActions.clearSystemProperty("java.class.path");
    SecurityActions.setSystemProperty("module.path",modulePath.getAbsolutePath());
    StringBuffer packages=new StringBuffer("org.jboss.modules," + InitialModuleLoaderFactory.class.getPackage().getName());
    packages.append(",org.jboss.as.controller.client,org.jboss.dmr");
    if (systemPackages != null) {
      for (      String packageName : systemPackages)       packages.append("," + packageName);
    }
    SecurityActions.setSystemProperty("jboss.modules.system.pkgs",packages.toString());
    ModuleLoader moduleLoader=Module.getBootModuleLoader();
    return moduleLoader;
  }
  finally {
    SecurityActions.setSystemProperty("java.class.path",oldClassPath);
  }
}
