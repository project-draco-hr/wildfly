{
  if (line == null || line.isEmpty()) {
    throw new OperationFormatException("The line is null or empty.");
  }
  final DefaultCallbackHandler originalParsedArguments=this.parsedCmd;
  final String originalCmdLine=this.cmdLine;
  try {
    this.parsedCmd=new DefaultCallbackHandler();
    resetArgs(line);
    if (parsedCmd.getFormat() == OperationFormat.INSTANCE) {
      final ModelNode request=this.parsedCmd.toOperationRequest(this);
      StringBuilder op=new StringBuilder();
      op.append(prefixFormatter.format(parsedCmd.getAddress()));
      op.append(line.substring(line.indexOf(':')));
      return request;
    }
    final CommandHandler handler=cmdRegistry.getCommandHandler(parsedCmd.getOperationName());
    if (handler == null) {
      throw new OperationFormatException("No command handler for '" + parsedCmd.getOperationName() + "'.");
    }
    if (batchMode) {
      if (!handler.isBatchMode(this)) {
        throw new OperationFormatException("The command is not allowed in a batch.");
      }
    }
 else     if (!(handler instanceof OperationCommand)) {
      throw new OperationFormatException("The command does not translate to an operation request.");
    }
    return ((OperationCommand)handler).buildRequest(this);
  }
  finally {
    this.parsedCmd=originalParsedArguments;
    this.cmdLine=originalCmdLine;
  }
}
