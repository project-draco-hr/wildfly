{
  if (line.isEmpty() || line.charAt(0) == '#') {
    return;
  }
  int i=line.length() - 1;
  while (i > 0 && line.charAt(i) <= ' ') {
    if (line.charAt(--i) == '\\') {
      break;
    }
  }
  if (line.charAt(i) == '\\') {
    if (lineBuffer == null) {
      lineBuffer=new StringBuilder();
    }
    lineBuffer.append(line,0,i);
    lineBuffer.append(' ');
    return;
  }
 else   if (lineBuffer != null) {
    lineBuffer.append(line);
    line=lineBuffer.toString();
    lineBuffer=null;
  }
  resetArgs(line);
  try {
    if (parsedCmd.getFormat() == OperationFormat.INSTANCE) {
      final ModelNode request=parsedCmd.toOperationRequest(this);
      if (isBatchMode()) {
        StringBuilder op=new StringBuilder();
        op.append(getNodePathFormatter().format(parsedCmd.getAddress()));
        op.append(line.substring(line.indexOf(':')));
        DefaultBatchedCommand batchedCmd=new DefaultBatchedCommand(op.toString(),request);
        Batch batch=getBatchManager().getActiveBatch();
        batch.add(batchedCmd);
        printLine("#" + batch.size() + " "+ batchedCmd.getCommand());
      }
 else {
        set("OP_REQ",request);
        try {
          operationHandler.handle(this);
        }
  finally {
          set("OP_REQ",null);
        }
      }
    }
 else {
      final String cmdName=parsedCmd.getOperationName();
      CommandHandler handler=cmdRegistry.getCommandHandler(cmdName.toLowerCase());
      if (handler != null) {
        if (isBatchMode() && handler.isBatchMode(this)) {
          if (!(handler instanceof OperationCommand)) {
            throw new CommandLineException("The command is not allowed in a batch.");
          }
 else {
            try {
              ModelNode request=((OperationCommand)handler).buildRequest(this);
              BatchedCommand batchedCmd=new DefaultBatchedCommand(line,request);
              Batch batch=getBatchManager().getActiveBatch();
              batch.add(batchedCmd);
              printLine("#" + batch.size() + " "+ batchedCmd.getCommand());
            }
 catch (            CommandFormatException e) {
              throw new CommandFormatException("Failed to add to batch '" + line + "'",e);
            }
          }
        }
 else {
          handler.handle(this);
        }
      }
 else {
        throw new CommandLineException("Unexpected command '" + line + "'. Type 'help --commands' for the list of supported commands.");
      }
    }
  }
 catch (  CommandLineException e) {
    throw e;
  }
catch (  Throwable t) {
    throw new CommandLineException("Failed to handle '" + line + "'",t);
  }
 finally {
    cmdLine=null;
  }
}
