{
  if (line.isEmpty()) {
    throw new IllegalArgumentException("Null command line.");
  }
  final DefaultCallbackHandler originalParsedArguments=this.parsedCmd;
  try {
    this.parsedCmd=tmpBatched;
    resetArgs(line);
  }
 catch (  CommandFormatException e) {
    this.parsedCmd=originalParsedArguments;
    throw e;
  }
  if (parsedCmd.getFormat() == OperationFormat.INSTANCE) {
    try {
      ModelNode request=this.parsedCmd.toOperationRequest(this);
      StringBuilder op=new StringBuilder();
      op.append(prefixFormatter.format(parsedCmd.getAddress()));
      op.append(line.substring(line.indexOf(':')));
      return new DefaultBatchedCommand(op.toString(),request);
    }
  finally {
      this.parsedCmd=originalParsedArguments;
    }
  }
  CommandHandler handler=cmdRegistry.getCommandHandler(parsedCmd.getOperationName());
  if (handler == null) {
    throw new OperationFormatException("No command handler for '" + parsedCmd.getOperationName() + "'.");
  }
  if (!handler.isBatchMode()) {
    throw new OperationFormatException("The command is not allowed in a batch.");
  }
  try {
    final ModelNode request=((OperationCommand)handler).buildRequest(this);
    return new DefaultBatchedCommand(line,request);
  }
  finally {
    this.parsedCmd=originalParsedArguments;
  }
}
