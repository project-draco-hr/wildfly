{
  FileInputStream fis=null;
  FileOutputStream fos=null;
  try {
    KeyStore theTrustStore=KeyStore.getInstance("JKS");
    File trustStoreFile=new File(trustStore);
    if (trustStoreFile.exists()) {
      fis=new FileInputStream(trustStoreFile);
      theTrustStore.load(fis,trustStorePassword.toCharArray());
      StreamUtils.safeClose(fis);
      fis=null;
    }
 else {
      theTrustStore.load(null);
    }
    for (    Certificate current : chain) {
      if (current instanceof X509Certificate) {
        X509Certificate x509Current=(X509Certificate)current;
        theTrustStore.setCertificateEntry(x509Current.getSubjectX500Principal().getName(),x509Current);
      }
    }
    fos=new FileOutputStream(trustStoreFile);
    theTrustStore.store(fos,trustStorePassword.toCharArray());
  }
 catch (  GeneralSecurityException e) {
    throw new IllegalStateException("Unable to operate on trust store.",e);
  }
catch (  IOException e) {
    throw new IllegalStateException("Unable to operate on trust store.",e);
  }
 finally {
    StreamUtils.safeClose(fis);
    StreamUtils.safeClose(fos);
  }
  delegate=null;
}
