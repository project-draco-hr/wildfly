{
  final HeaderMap requestHeaders=exchange.getRequestHeaders();
  final HeaderMap responseHeaders=exchange.getResponseHeaders();
  String referrer=responseHeaders.getFirst(REFERER);
  String protocol=exchange.getRequestScheme();
  String host=null;
  if (referrer != null) {
    try {
      URI uri=new URI(referrer);
      protocol=uri.getScheme();
      host=uri.getHost() + portPortion(protocol,uri.getPort());
    }
 catch (    URISyntaxException e) {
    }
  }
  if (host == null) {
    host=requestHeaders.getFirst(HOST);
    if (host == null) {
      exchange.setResponseCode(StatusCodes.INTERNAL_SERVER_ERROR);
      return;
    }
  }
  String userAgent=requestHeaders.getFirst(USER_AGENT);
  boolean opera=userAgent != null && userAgent.contains("Opera");
  boolean win=!opera && userAgent != null && userAgent.contains("MSIE");
  String rawQuery=exchange.getQueryString();
  boolean exit=rawQuery != null && rawQuery.contains(EXIT);
  if (win) {
    responseHeaders.add(LOCATION,protocol + "://" + host+ "/");
    exchange.setResponseCode(StatusCodes.TEMPORARY_REDIRECT);
  }
 else {
    String authorization=requestHeaders.getFirst(AUTHORIZATION);
    boolean digest=true;
    Map<String,Deque<String>> parameters=exchange.getQueryParameters();
    if (parameters.containsKey(MECHANISM)) {
      digest=!BASIC.equals(parameters.get(MECHANISM).getFirst());
    }
    if (authorization != null && authorization.length() > BASIC.length() && BASIC.equalsIgnoreCase(authorization.substring(0,BASIC.length()))) {
      digest=false;
      ByteBuffer decode=FlexBase64.decode(authorization.substring(6));
      authorization=new String(decode.array(),decode.arrayOffset(),decode.limit(),UTF_8);
    }
    if (authorization == null || !authorization.contains("enter-login-here")) {
      if (!exit) {
        responseHeaders.add(LOCATION,protocol + "://enter-login-here:blah@" + host+ "/logout?"+ EXIT+ "&"+ MECHANISM+ "="+ (digest ? DIGEST : BASIC));
        exchange.setResponseCode(StatusCodes.TEMPORARY_REDIRECT);
        return;
      }
      mechanism(opera,digest).sendChallenge(exchange,null);
      String reply="<html><script type='text/javascript'>window.location=\"" + protocol + "://"+ host+ "/\";</script></html>";
      exchange.setResponseCode(StatusCodes.UNAUTHORIZED);
      exchange.getResponseSender().send(reply,IoCallback.END_EXCHANGE);
      return;
    }
    responseHeaders.add(LOCATION,protocol + "://" + host+ "/");
    exchange.setResponseCode(StatusCodes.TEMPORARY_REDIRECT);
  }
}
