{
  ClassLoader origTCCL=SecurityActions.getContextClassLoader();
  JournalType jtype=configuration.getJournalType();
  if (jtype == JournalType.ASYNCIO) {
    boolean supportsAIO=AIOSequentialFileFactory.isSupported();
    if (supportsAIO == false) {
      ROOT_LOGGER.aioWarning();
      configuration.setJournalType(JournalType.NIO);
    }
  }
  configuration.setFileDeploymentEnabled(false);
  configuration.setLogDelegateFactoryClassName(LOGGING_FACTORY);
  configuration.setBindingsDirectory(paths.get("bindings"));
  configuration.setLargeMessagesDirectory(paths.get("largemessages"));
  configuration.setJournalDirectory(paths.get("journal"));
  configuration.setPagingDirectory(paths.get("paging"));
  try {
    Collection<TransportConfiguration> acceptors=configuration.getAcceptorConfigurations();
    Collection<TransportConfiguration> connectors=configuration.getConnectorConfigurations().values();
    Collection<BroadcastGroupConfiguration> broadcastGroups=configuration.getBroadcastGroupConfigurations();
    Map<String,DiscoveryGroupConfiguration> discoveryGroups=configuration.getDiscoveryGroupConfigurations();
    if (connectors != null) {
      for (      TransportConfiguration tc : connectors) {
        Object socketRef=tc.getParams().remove(SOCKET_REF);
        if (socketRef != null) {
          String name=socketRef.toString();
          String host;
          int port;
          OutboundSocketBinding binding=outboundSocketBindings.get(name);
          if (binding == null) {
            final SocketBinding socketBinding=socketBindings.get(name);
            if (socketBinding == null) {
              throw MESSAGES.failedToFindConnectorSocketBinding(tc.getName());
            }
            InetSocketAddress sa=socketBinding.getSocketAddress();
            host=sa.getAddress().getHostName();
            port=sa.getPort();
          }
 else {
            host=binding.getDestinationAddress().getHostName();
            port=binding.getDestinationPort();
          }
          tc.getParams().put(HOST,host);
          tc.getParams().put(PORT,String.valueOf(port));
        }
      }
    }
    if (acceptors != null) {
      for (      TransportConfiguration tc : acceptors) {
        Object socketRef=tc.getParams().remove(SOCKET_REF);
        if (socketRef != null) {
          String name=socketRef.toString();
          SocketBinding binding=socketBindings.get(name);
          if (binding == null) {
            throw MESSAGES.failedToFindConnectorSocketBinding(tc.getName());
          }
          InetSocketAddress socketAddress=binding.getSocketAddress();
          tc.getParams().put(HOST,socketAddress.getAddress().getHostAddress());
          tc.getParams().put(PORT,"" + socketAddress.getPort());
        }
      }
    }
    if (broadcastGroups != null) {
      final List<BroadcastGroupConfiguration> newConfigs=new ArrayList<BroadcastGroupConfiguration>();
      for (      final BroadcastGroupConfiguration config : broadcastGroups) {
        final String name=config.getName();
        final SocketBinding binding=groupBindings.get("broadcast" + name);
        if (binding == null) {
          throw MESSAGES.failedToFindBroadcastSocketBinding(name);
        }
        newConfigs.add(BroadcastGroupAdd.createBroadcastGroupConfiguration(name,config,binding));
      }
      configuration.getBroadcastGroupConfigurations().clear();
      configuration.getBroadcastGroupConfigurations().addAll(newConfigs);
    }
    if (discoveryGroups != null) {
      configuration.setDiscoveryGroupConfigurations(new HashMap<String,DiscoveryGroupConfiguration>());
      for (      final Map.Entry<String,DiscoveryGroupConfiguration> entry : discoveryGroups.entrySet()) {
        final String name=entry.getKey();
        final SocketBinding binding=groupBindings.get("discovery" + name);
        if (binding == null) {
          throw MESSAGES.failedToFindDiscoverySocketBinding(name);
        }
        final DiscoveryGroupConfiguration config=DiscoveryGroupAdd.createDiscoveryGroupConfiguration(name,entry.getValue(),binding);
        configuration.getDiscoveryGroupConfigurations().put(name,config);
      }
    }
    HornetQSecurityManagerAS7 hornetQSecurityManagerAS7=new HornetQSecurityManagerAS7(securityDomainContextValue.getValue());
    server=new HornetQServerImpl(configuration,mbeanServer.getOptionalValue(),hornetQSecurityManagerAS7);
    if (ConfigurationImpl.DEFAULT_CLUSTER_PASSWORD.equals(server.getConfiguration().getClusterPassword())) {
      server.getConfiguration().setClusterPassword(java.util.UUID.randomUUID().toString());
    }
  }
 catch (  Exception e) {
    throw MESSAGES.failedToStartService(e);
  }
 finally {
    SecurityActions.setContextClassLoader(origTCCL);
  }
}
