{
  ModelVersion version140=ModelVersion.create(1,4);
  KernelServicesBuilder builder=createKernelServicesBuilder(AdditionalInitialization.MANAGEMENT).setSubsystemXml(getSubsystemXml());
  LegacyKernelServicesInitializer legacyInitializer=builder.createLegacyKernelServicesBuilder(null,controllerVersion,version140);
  for (  String mavenResourceURL : mavenResourceURLs) {
    legacyInitializer.addMavenResourceURL(mavenResourceURL);
  }
  legacyInitializer.configureReverseControllerCheck(null,new FixReverseControllerModel140());
  KernelServices mainServices=builder.build();
  KernelServices legacyServices=mainServices.getLegacyServices(version140);
  Assert.assertNotNull(legacyServices);
  Assert.assertTrue("main services did not boot",mainServices.isSuccessfulBoot());
  Assert.assertTrue(legacyServices.isSuccessfulBoot());
  checkSubsystemModelTransformation(mainServices,version140,new VirtualNodesTransformedModelProblem());
  PathAddress pa=PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,InfinispanExtension.SUBSYSTEM_NAME),PathElement.pathElement(CacheContainerResourceDefinition.CONTAINER_PATH.getKey(),"container"),PathElement.pathElement(DistributedCacheResourceDefinition.DISTRIBUTED_CACHE_PATH.getKey(),"cache"));
  ModelNode addOp=Util.createAddOperation(pa);
  addOp.get(DistributedCacheResourceDefinition.VIRTUAL_NODES.getName()).set(4);
  addOp.get(CacheResourceDefinition.STATISTICS.getName()).set(true);
  OperationTransformer.TransformedOperation transformedOperation=mainServices.transformOperation(version140,addOp);
  Assert.assertFalse(transformedOperation.getTransformedOperation().has(DistributedCacheResourceDefinition.VIRTUAL_NODES.getName()));
  Assert.assertEquals(24,transformedOperation.getTransformedOperation().get(DistributedCacheResourceDefinition.SEGMENTS.getName()).asInt());
  ModelNode result=new ModelNode();
  result.get(OUTCOME).set(SUCCESS);
  result.get(RESULT);
  Assert.assertFalse(transformedOperation.rejectOperation(result));
  Assert.assertEquals(result,transformedOperation.transformResult(result));
  ModelNode writeOp=Util.createEmptyOperation(WRITE_ATTRIBUTE_OPERATION,pa);
  writeOp.get(NAME).set(DistributedCacheResourceDefinition.VIRTUAL_NODES.getName());
  writeOp.get(VALUE).set(4);
  transformedOperation=mainServices.transformOperation(version140,writeOp);
  Assert.assertEquals(DistributedCacheResourceDefinition.SEGMENTS.getName(),transformedOperation.getTransformedOperation().get(NAME).asString());
  Assert.assertEquals(24,transformedOperation.getTransformedOperation().get(VALUE).asInt());
  Assert.assertFalse(transformedOperation.rejectOperation(result));
  Assert.assertEquals(result,transformedOperation.transformResult(result));
}
