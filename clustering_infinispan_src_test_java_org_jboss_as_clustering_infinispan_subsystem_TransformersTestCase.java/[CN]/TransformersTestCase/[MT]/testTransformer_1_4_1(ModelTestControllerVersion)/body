{
  ModelVersion version141=ModelVersion.create(1,4,1);
  KernelServicesBuilder builder=createKernelServicesBuilder(AdditionalInitialization.MANAGEMENT).setSubsystemXml(getSubsystemXml());
  builder.createLegacyKernelServicesBuilder(null,controllerVersion,version141).addMavenResourceURL("org.jboss.as:jboss-as-clustering-infinispan:7.2.0.Final").addMavenResourceURL("org.infinispan:infinispan-core:5.3.0.Final").addMavenResourceURL("org.infinispan:infinispan-cachestore-jdbc:5.3.0.Final").configureReverseControllerCheck(null,new FixReverseControllerModel141());
  KernelServices mainServices=builder.build();
  KernelServices legacyServices=mainServices.getLegacyServices(version141);
  Assert.assertNotNull(legacyServices);
  Assert.assertTrue("main services did not boot",mainServices.isSuccessfulBoot());
  Assert.assertTrue(legacyServices.isSuccessfulBoot());
  checkSubsystemModelTransformation(mainServices,version141);
  PathAddress pa=PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,InfinispanExtension.SUBSYSTEM_NAME),PathElement.pathElement(CacheContainerResourceDefinition.CONTAINER_PATH.getKey(),"container"),PathElement.pathElement(DistributedCacheResourceDefinition.DISTRIBUTED_CACHE_PATH.getKey(),"cache"));
  ModelNode addOp=Util.createAddOperation(pa);
  addOp.get(DistributedCacheResourceDefinition.VIRTUAL_NODES.getName()).set(1);
  addOp.get(CacheResourceDefinition.STATISTICS.getName()).set(true);
  OperationTransformer.TransformedOperation transformedOperation=mainServices.transformOperation(version141,addOp);
  Assert.assertFalse(transformedOperation.getTransformedOperation().has(DistributedCacheResourceDefinition.VIRTUAL_NODES.getName()));
  Assert.assertEquals(6,transformedOperation.getTransformedOperation().get(DistributedCacheResourceDefinition.SEGMENTS.getName()).asInt());
  ModelNode result=new ModelNode();
  result.get(OUTCOME).set(SUCCESS);
  result.get(RESULT);
  Assert.assertFalse(transformedOperation.rejectOperation(result));
  Assert.assertEquals(result,transformedOperation.transformResult(result));
  ModelNode writeOp=Util.createEmptyOperation(WRITE_ATTRIBUTE_OPERATION,pa);
  writeOp.get(NAME).set(DistributedCacheResourceDefinition.VIRTUAL_NODES.getName());
  writeOp.get(VALUE).set(1);
  transformedOperation=mainServices.transformOperation(version141,writeOp);
  Assert.assertEquals(DistributedCacheResourceDefinition.SEGMENTS.getName(),transformedOperation.getTransformedOperation().get(NAME).asString());
  Assert.assertEquals(6,transformedOperation.getTransformedOperation().get(VALUE).asInt());
  Assert.assertFalse(transformedOperation.rejectOperation(result));
  Assert.assertEquals(result,transformedOperation.transformResult(result));
}
