{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
  final Deployment deployment=OSGiDeploymentAttachment.getDeployment(deploymentUnit);
  final String contextName=deploymentUnit.getName();
  final OSGiDeploymentService service=new OSGiDeploymentService(deployment);
  ServiceBuilder<Deployment> serviceBuilder=serviceTarget.addService(getServiceName(contextName),service);
  serviceBuilder.addDependency(BundleContextService.SERVICE_NAME,BundleContext.class,service.injectedBundleContext);
  serviceBuilder.addDependency(BundleManagerService.SERVICE_NAME,BundleManager.class,service.injectedBundleManager);
  serviceBuilder.addDependency(Services.JBOSS_DEPLOYMENT.append(contextName));
  serviceBuilder.addDependency(PackageAdminService.SERVICE_NAME);
  serviceBuilder.setInitialMode(Mode.ACTIVE);
  serviceBuilder.addListener(listener);
  serviceBuilder.install();
}
