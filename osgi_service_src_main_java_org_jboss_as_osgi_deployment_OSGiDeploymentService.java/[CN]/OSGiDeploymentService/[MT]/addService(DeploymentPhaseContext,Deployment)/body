{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final OSGiDeploymentService service=new OSGiDeploymentService(deployment);
  final String contextName=deploymentUnit.getName();
  final ServiceName serviceName=getServiceName(contextName);
  final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
  ServiceBuilder<Deployment> serviceBuilder=serviceTarget.addService(serviceName,service);
  serviceBuilder.addDependency(BundleContextService.SERVICE_NAME,BundleContext.class,service.injectedBundleContext);
  serviceBuilder.addDependency(BundleManagerService.SERVICE_NAME,BundleManager.class,service.injectedBundleManager);
  serviceBuilder.addDependency(Services.deploymentUnitName(contextName));
  serviceBuilder.addDependency(PackageAdminService.SERVICE_NAME);
  serviceBuilder.setInitialMode(Mode.ACTIVE);
  serviceBuilder.addListener(listener);
  serviceBuilder.install();
}
