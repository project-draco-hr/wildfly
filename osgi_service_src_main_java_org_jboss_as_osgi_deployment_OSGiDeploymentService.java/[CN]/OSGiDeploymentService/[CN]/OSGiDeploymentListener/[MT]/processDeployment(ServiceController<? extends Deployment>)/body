{
  controller.removeListener(this);
  Set<Deployment> bundlesToStart=null;
synchronized (this) {
    pendingDeployments.remove(controller.getValue());
    if (pendingDeployments.isEmpty()) {
      bundlesToStart=new HashSet<Deployment>(startedDeployments);
      startedDeployments.clear();
    }
  }
  if (bundlesToStart != null) {
    ServiceContainer serviceContainer=controller.getServiceContainer();
    PackageAdmin packageAdmin=PackageAdminService.getServiceValue(serviceContainer);
    StartLevel startLevel=StartLevelService.getServiceValue(serviceContainer);
    for (    Deployment dep : bundlesToStart) {
      Bundle bundle=dep.getAttachment(Bundle.class);
      if (packageAdmin.getBundleType(bundle) != PackageAdmin.BUNDLE_TYPE_FRAGMENT) {
        boolean autoStart=dep.isAutoStart();
        String contextName=DeploymentHolderService.getContextName(dep);
        ServiceName serviceName=DeploymentHolderService.getServiceName(contextName);
        ServiceController<?> holderService=serviceContainer.getService(serviceName);
        if (holderService != null) {
          Deployment initiatingDeployment=(Deployment)holderService.getValue();
          autoStart=initiatingDeployment.isAutoStart();
          Integer startlevel=initiatingDeployment.getStartLevel();
          if (startlevel != null)           startLevel.setBundleStartLevel(bundle,startlevel);
        }
        if (autoStart) {
          log.tracef("Starting bundle: %s",bundle);
          try {
            bundle.start();
          }
 catch (          BundleException ex) {
            log.errorf(ex,"Cannot start bundle: %s",bundle);
          }
        }
      }
    }
  }
}
