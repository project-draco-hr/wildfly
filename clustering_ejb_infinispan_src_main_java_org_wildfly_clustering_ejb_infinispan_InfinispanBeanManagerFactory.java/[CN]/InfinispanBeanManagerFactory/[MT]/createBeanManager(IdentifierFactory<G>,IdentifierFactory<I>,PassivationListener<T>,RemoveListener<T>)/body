{
  MarshallingContext context=new SimpleMarshallingContextFactory().createMarshallingContext(this.configuration.getMarshallingConfigurationRepository(),this.configuration.getBeanContext().getClassLoader());
  MarshalledValueFactory<MarshallingContext> factory=new SimpleMarshalledValueFactory(context);
  Cache<G,BeanGroupEntry<I,T>> groupCache=this.configuration.getCache();
  org.infinispan.configuration.cache.Configuration config=groupCache.getCacheConfiguration();
  BeanGroupFactory<G,I,T> groupFactory=new InfinispanBeanGroupFactory<>(groupCache,factory,context);
  Configuration<G,G,BeanGroupEntry<I,T>,BeanGroupFactory<G,I,T>> groupConfiguration=new SimpleConfiguration<>(groupCache,groupFactory,groupIdentifierFactory);
  Cache<BeanKey<I>,BeanEntry<G>> beanCache=this.configuration.getCache();
  final String beanName=this.configuration.getBeanContext().getBeanName();
  final boolean evictionAllowed=config.persistence().usingStores();
  final boolean passivationEnabled=evictionAllowed && config.persistence().passivation();
  final boolean persistent=config.clustering().cacheMode().isClustered() || (evictionAllowed && !passivationEnabled);
  boolean lockOnRead=config.transaction().transactionMode().isTransactional() && (config.transaction().lockingMode() == LockingMode.PESSIMISTIC) && (config.locking().isolationLevel() == IsolationLevel.REPEATABLE_READ);
  BeanFactory<G,I,T> beanFactory=new InfinispanBeanFactory<>(beanName,groupFactory,lockOnRead ? beanCache.getAdvancedCache().withFlags(Flag.FORCE_WRITE_LOCK) : beanCache,this.configuration.getBeanContext().getTimeout(),persistent ? passivationListener : null);
  Configuration<I,BeanKey<I>,BeanEntry<G>,BeanFactory<G,I,T>> beanConfiguration=new SimpleConfiguration<>(beanCache,beanFactory,beanIdentifierFactory);
  final NodeFactory<Address> nodeFactory=this.configuration.getNodeFactory();
  final Registry<String,?> registry=this.configuration.getRegistry();
  final KeyAffinityServiceFactory affinityFactory=this.configuration.getKeyAffinityServiceFactory();
  final CommandDispatcherFactory dispatcherFactory=this.configuration.getCommandDispatcherFactory();
  final Time timeout=this.configuration.getBeanContext().getTimeout();
  final ScheduledExecutorService scheduler=this.configuration.getScheduler();
  final ExpirationConfiguration<T> expiration=new ExpirationConfiguration<T>(){
    @Override public Time getTimeout(){
      return timeout;
    }
    @Override public RemoveListener<T> getRemoveListener(){
      return removeListener;
    }
    @Override public ScheduledExecutorService getExecutor(){
      return scheduler;
    }
  }
;
  final Executor executor=this.configuration.getExecutor();
  final BeanPassivationConfiguration passivationConfig=this.configuration.getPassivationConfiguration();
  final PassivationConfiguration<T> passivation=new PassivationConfiguration<T>(){
    @Override public PassivationListener<T> getPassivationListener(){
      return passivationListener;
    }
    @Override public boolean isEvictionAllowed(){
      return evictionAllowed;
    }
    @Override public boolean isPersistent(){
      return persistent;
    }
    @Override public BeanPassivationConfiguration getConfiguration(){
      return passivationConfig;
    }
    @Override public Executor getExecutor(){
      return executor;
    }
  }
;
  InfinispanBeanManagerConfiguration<T> configuration=new InfinispanBeanManagerConfiguration<T>(){
    @Override public String getBeanName(){
      return beanName;
    }
    @Override public KeyAffinityServiceFactory getAffinityFactory(){
      return affinityFactory;
    }
    @Override public Registry<String,?> getRegistry(){
      return registry;
    }
    @Override public NodeFactory<Address> getNodeFactory(){
      return nodeFactory;
    }
    @Override public CommandDispatcherFactory getCommandDispatcherFactory(){
      return dispatcherFactory;
    }
    @Override public ExpirationConfiguration<T> getExpirationConfiguration(){
      return expiration;
    }
    @Override public PassivationConfiguration<T> getPassivationConfiguration(){
      return passivation;
    }
  }
;
  return new InfinispanBeanManager<>(configuration,beanConfiguration,groupConfiguration);
}
