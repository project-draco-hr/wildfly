{
  final PathAddress rootAddress=PathAddress.pathAddress(PathAddress.pathAddress(operation.require(OP_ADDR)).getLastElement());
  final ModelNode wsSubsystemAddress=rootAddress.toModelNode();
  final ModelNode wsSubsystem=context.readModel(PathAddress.EMPTY_ADDRESS);
  final ModelNode result=context.getResult();
  final ModelNode subsystemAdd=getSubsystemAddOperation(wsSubsystemAddress,wsSubsystem);
  result.add(subsystemAdd);
  if (wsSubsystem.hasDefined(ENDPOINT_CONFIG)) {
    final ModelNode endpointConfigs=wsSubsystem.get(ENDPOINT_CONFIG);
    for (    final String configName : endpointConfigs.keys()) {
      final ModelNode endpointConfig=endpointConfigs.get(configName);
      final ModelNode endpointConfigAddress=wsSubsystemAddress.clone().add(ENDPOINT_CONFIG,configName);
      final ModelNode endpointConfigAdd=getEndpointConfigAddOperation(endpointConfigAddress);
      result.add(endpointConfigAdd);
      if (endpointConfig.hasDefined(PRE_HANDLER_CHAIN)) {
        final ModelNode preHandlerChains=endpointConfig.get(PRE_HANDLER_CHAIN);
        for (        final String preHandlerChainName : preHandlerChains.keys()) {
          final ModelNode preHandlerChain=preHandlerChains.get(preHandlerChainName);
          final ModelNode preHandlerChainAddress=endpointConfigAddress.clone().add(PRE_HANDLER_CHAIN,preHandlerChainName);
          final ModelNode preHandlerChainAdd=getHandlerChainAddOperation(preHandlerChainAddress,preHandlerChain);
          result.add(preHandlerChainAdd);
          if (preHandlerChain.hasDefined(HANDLER)) {
            final ModelNode handlers=preHandlerChain.get(HANDLER);
            for (            final String handlerName : handlers.keys()) {
              final ModelNode handler=handlers.get(handlerName);
              final ModelNode handlerAddress=preHandlerChainAddress.clone().add(HANDLER,handlerName);
              final ModelNode handlerAdd=getHandlerAddOperation(handlerAddress,handler);
              result.add(handlerAdd);
            }
          }
        }
      }
      if (endpointConfig.hasDefined(POST_HANDLER_CHAIN)) {
        final ModelNode postHandlerChains=endpointConfig.get(POST_HANDLER_CHAIN);
        for (        final String postHandlerChainName : postHandlerChains.keys()) {
          final ModelNode postHandlerChain=postHandlerChains.get(postHandlerChainName);
          final ModelNode postHandlerChainAddress=endpointConfigAddress.clone().add(POST_HANDLER_CHAIN,postHandlerChainName);
          final ModelNode postHandlerChainAdd=getHandlerChainAddOperation(postHandlerChainAddress,postHandlerChain);
          result.add(postHandlerChainAdd);
          if (postHandlerChain.hasDefined(HANDLER)) {
            final ModelNode handlers=postHandlerChain.get(HANDLER);
            for (            final String handlerName : handlers.keys()) {
              final ModelNode handler=handlers.get(handlerName);
              final ModelNode handlerAddress=postHandlerChainAddress.clone().add(HANDLER,handlerName);
              final ModelNode handlerAdd=getHandlerAddOperation(handlerAddress,handler);
              result.add(handlerAdd);
            }
          }
        }
      }
      if (endpointConfig.hasDefined(PROPERTY)) {
        final ModelNode properties=endpointConfig.get(PROPERTY);
        for (        final String propertyName : properties.keys()) {
          final ModelNode property=properties.get(propertyName);
          final ModelNode propertyAddress=endpointConfigAddress.clone().add(PROPERTY,propertyName);
          final ModelNode propertyAdd=getPropertyAddOperation(propertyAddress,property);
          result.add(propertyAdd);
        }
      }
    }
  }
  context.completeStep();
}
