{
  DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  OSGiMetaData metadata=depUnit.getAttachment(OSGiConstants.OSGI_METADATA_KEY);
  Deployment dep=BundleLifecycleIntegration.getDeployment(depUnit.getName());
  if (metadata == null && dep != null) {
    metadata=dep.getAttachment(IntegrationConstants.OSGI_METADATA_KEY);
  }
  Manifest manifest=depUnit.getAttachment(Attachments.OSGI_MANIFEST);
  if (metadata == null && manifest != null) {
    metadata=OSGiMetaDataBuilder.load(manifest);
  }
  if (metadata != null) {
    depUnit.putAttachment(OSGiConstants.OSGI_METADATA_KEY,metadata);
    phaseContext.addDependency(FrameworkBootstrapService.SERVICE_NAME,AttachmentKey.create(Void.class));
  }
}
