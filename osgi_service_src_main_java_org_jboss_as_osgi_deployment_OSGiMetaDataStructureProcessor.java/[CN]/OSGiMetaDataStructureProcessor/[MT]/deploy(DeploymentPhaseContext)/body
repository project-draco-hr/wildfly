{
  DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  if (depUnit.hasAttachment(OSGiConstants.OSGI_METADATA_KEY))   return;
  Deployment dep=BundleLifecycleIntegration.getDeployment(depUnit.getName());
  if (dep != null) {
    OSGiMetaData metadata=dep.getAttachment(OSGiMetaData.class);
    if (metadata != null) {
      depUnit.putAttachment(OSGiConstants.OSGI_METADATA_KEY,metadata);
      return;
    }
  }
  Manifest manifest=depUnit.getAttachment(Attachments.OSGI_MANIFEST);
  if (manifest != null) {
    OSGiMetaData metadata=OSGiMetaDataBuilder.load(manifest);
    depUnit.putAttachment(OSGiConstants.OSGI_METADATA_KEY,metadata);
  }
}
