{
  final ClassLoader oldTCCL=SecurityActions.getContextClassLoader();
  try {
    SecurityActions.setContextClassLoader(oldTCCL);
    if (configuration == null) {
      ConstraintMapping mapping=new ConstraintMapping();
      HibernateValidatorConfiguration config=Validation.byProvider(HibernateValidator.class).providerResolver(new JbossProviderResolver()).configure();
      config.addMapping(mapping);
      ValidatorFactory factory=config.buildValidatorFactory();
      return factory;
    }
 else {
      return configuration.buildValidatorFactory();
    }
  }
  finally {
    SecurityActions.setContextClassLoader(oldTCCL);
  }
}
