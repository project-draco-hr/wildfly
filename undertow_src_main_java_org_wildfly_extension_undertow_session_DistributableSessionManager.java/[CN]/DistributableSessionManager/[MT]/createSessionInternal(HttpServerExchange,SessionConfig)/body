{
  if (maxActiveAllowed != -1 && calcActiveSessions() >= maxActiveAllowed) {
    log.tracef("createSession(): active sessions = %d and max allowed sessions = %d",calcActiveSessions(),maxActiveAllowed);
    processExpires();
    if (calcActiveSessions() >= maxActiveAllowed) {
      rejectedCounter.incrementAndGet();
      throw MESSAGES.tooManyActiveSessions(maxActiveAllowed);
    }
  }
  ClusteredSession<O> session=createEmptyClusteredSession();
  if (session != null) {
    session.setNew(true);
    session.setCreationTime(System.currentTimeMillis());
    session.setMaxInactiveInterval(this.maxInactiveInterval);
    session.setValid(true);
    String clearInvalidated=null;
    String sessionId=config.findSessionId(serverExchange);
    if (sessionId != null) {
      clearInvalidated=sessionId;
      if (sessions.containsKey(sessionId)) {
        throw UndertowMessages.MESSAGES.sessionAlreadyExists(sessionId);
      }
    }
 else {
      sessionId=generateSessionId();
    }
    config.setSessionId(serverExchange,sessionId);
    session.setId(sessionId);
    getDistributedCacheManager().sessionCreated(session.getRealId());
    session.tellNew(ClusteredSessionNotificationCause.CREATE,serverExchange);
    log.tracef("Created a ClusteredSession with id: %s",sessionId);
    createdCounter.incrementAndGet();
    SessionReplicationContext.bindSession(session,snapshotManager);
    if (clearInvalidated != null) {
      SessionInvalidationTracker.clearInvalidatedSession(this);
    }
  }
  return session;
}
