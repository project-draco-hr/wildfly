{
  JavaArchive archive=getTargetModuleArchive();
  assertNull("Bundle null",executeDeploy(archive));
  ModuleIdentifier moduleId=ModuleIdentifier.create("test." + support.getDeploymentName(archive));
  assertNotNull("Module not null",loadModule(moduleId));
  registerTargetService(moduleId);
  Bundle targetBundle=getBundleManager().installBundle(moduleId);
  assertBundleState(Bundle.INSTALLED,targetBundle.getState());
  archive=getBundleArchive();
  Bundle clientBundle=executeDeploy(archive);
  assertBundleState(Bundle.INSTALLED,clientBundle.getState());
  clientBundle.start();
  assertBundleState(Bundle.ACTIVE,clientBundle.getState());
  String result=invokeTargetService(clientBundle,"hello world");
  assertEquals("hello world",result);
  targetBundle.uninstall();
  assertBundleState(Bundle.UNINSTALLED,targetBundle.getState());
  clientBundle.uninstall();
  assertBundleState(Bundle.UNINSTALLED,clientBundle.getState());
}
