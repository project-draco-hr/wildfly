{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Boolean computeCompositeIndex=deploymentUnit.getAttachment(Attachments.COMPUTE_COMPOSITE_ANNOTATION_INDEX);
  if (computeCompositeIndex != null && !computeCompositeIndex) {
    return;
  }
  final List<ResourceRoot> allResourceRoots=new ArrayList<ResourceRoot>();
  final Boolean processChildren=deploymentUnit.getAttachment(Attachments.PROCESS_CHILD_ANNOTATION_INDEX);
  if (processChildren == null || processChildren) {
    final List<ResourceRoot> resourceRoots=deploymentUnit.getAttachment(Attachments.RESOURCE_ROOTS);
    if (resourceRoots != null) {
      allResourceRoots.addAll(resourceRoots);
    }
  }
  allResourceRoots.add(deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT));
  List<Index> indexes=new ArrayList<Index>(allResourceRoots.size());
  for (  ResourceRoot resourceRoot : allResourceRoots) {
    Index index=resourceRoot.getAttachment(Attachments.ANNOTATION_INDEX);
    if (index != null) {
      indexes.add(index);
    }
  }
  deploymentUnit.putAttachment(Attachments.COMPOSITE_ANNOTATION_INDEX,new CompositeIndex(indexes));
}
