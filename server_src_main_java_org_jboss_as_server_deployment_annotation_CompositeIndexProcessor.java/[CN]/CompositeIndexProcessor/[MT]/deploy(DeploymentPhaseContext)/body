{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Boolean computeCompositeIndex=deploymentUnit.getAttachment(Attachments.COMPUTE_COMPOSITE_ANNOTATION_INDEX);
  if (computeCompositeIndex != null && !computeCompositeIndex) {
    return;
  }
  final List<ModuleIdentifier> additionalModuleIndexes=deploymentUnit.getAttachmentList(Attachments.ADDITIONAL_ANNOTATION_INDEXES);
  final List<Index> indexes=new ArrayList<Index>();
  for (  final ModuleIdentifier moduleIdentifier : additionalModuleIndexes) {
    try {
      Module module=Module.getBootModuleLoader().loadModule(moduleIdentifier);
      final CompositeIndex additionalIndex=ModuleIndexBuilder.buildCompositeIndex(module);
      if (additionalIndex != null) {
        indexes.addAll(additionalIndex.indexes);
      }
 else {
        ServerLogger.DEPLOYMENT_LOGGER.noCompositeIndex(module.getIdentifier(),ModuleIndexBuilder.INDEX_LOCATION);
      }
    }
 catch (    ModuleLoadException e) {
      throw new DeploymentUnitProcessingException(e);
    }
  }
  final List<ResourceRoot> allResourceRoots=new ArrayList<ResourceRoot>();
  final List<ResourceRoot> resourceRoots=deploymentUnit.getAttachmentList(Attachments.RESOURCE_ROOTS);
  for (  ResourceRoot resourceRoot : resourceRoots) {
    if (!SubDeploymentMarker.isSubDeployment(resourceRoot) && ModuleRootMarker.isModuleRoot(resourceRoot)) {
      allResourceRoots.add(resourceRoot);
    }
  }
  allResourceRoots.addAll(handleClassPathItems(deploymentUnit));
  final ResourceRoot deploymentRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  if (ModuleRootMarker.isModuleRoot(deploymentRoot)) {
    allResourceRoots.add(deploymentRoot);
  }
  for (  ResourceRoot resourceRoot : allResourceRoots) {
    Index index=resourceRoot.getAttachment(Attachments.ANNOTATION_INDEX);
    if (index != null) {
      indexes.add(index);
    }
  }
  deploymentUnit.putAttachment(Attachments.COMPOSITE_ANNOTATION_INDEX,new CompositeIndex(indexes));
}
