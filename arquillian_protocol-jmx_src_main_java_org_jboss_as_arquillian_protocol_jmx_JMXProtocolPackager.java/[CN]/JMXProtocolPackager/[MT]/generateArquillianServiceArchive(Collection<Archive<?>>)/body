{
  final JavaArchive archive=ShrinkWrap.create(JavaArchive.class,"arquillian-service");
  log.debugf("Generating: %s",archive.getName());
  archive.addPackage(ArquillianService.class.getPackage());
  archive.addPackage(AbstractJMXProtocol.class.getPackage());
  archive.addClasses(ServerSetup.class,ServerSetupTask.class,ManagementClient.class,Authentication.class,NetworkUtils.class);
  final Set<String> loadableExtensions=new HashSet<String>();
  final String loadableExtensionsPath="META-INF/services/" + RemoteLoadableExtension.class.getName();
  for (  Archive<?> aux : auxArchives) {
    Node node=aux.get(loadableExtensionsPath);
    if (node != null) {
      BufferedReader br=new BufferedReader(new InputStreamReader(node.getAsset().openStream()));
      try {
        String line=br.readLine();
        while (line != null) {
          loadableExtensions.add(line);
          line=br.readLine();
        }
      }
 catch (      IOException ex) {
      }
    }
    log.debugf("Merging archive: %s",aux);
    archive.merge(aux);
  }
  loadableExtensions.add(JMXProtocolEndpointExtension.class.getName());
  loadableExtensions.add(InContainerManagementClientExtension.class.getName());
  archive.setManifest(new Asset(){
    public InputStream openStream(){
      ManifestBuilder builder=ManifestBuilder.newInstance();
      StringBuffer dependencies=new StringBuffer();
      dependencies.append("org.jboss.as.jmx,");
      dependencies.append("org.jboss.as.server,");
      dependencies.append("org.jboss.as.controller-client,");
      dependencies.append("org.jboss.as.osgi,");
      dependencies.append("org.jboss.jandex,");
      dependencies.append("org.jboss.logging,");
      dependencies.append("org.jboss.modules,");
      dependencies.append("org.jboss.dmr,");
      dependencies.append("org.jboss.msc,");
      dependencies.append("org.jboss.osgi.framework,");
      dependencies.append("org.osgi.core,");
      dependencies.append("org.jboss.as.security-util");
      builder.addManifestHeader("Dependencies",dependencies.toString());
      return builder.openStream();
    }
  }
);
  String serviceActivatorPath="META-INF/services/" + ServiceActivator.class.getName();
  final URL serviceActivatorURL=this.getClass().getClassLoader().getResource("arquillian-service/" + serviceActivatorPath);
  if (serviceActivatorURL == null) {
    throw new RuntimeException("No arquillian-service/" + serviceActivatorPath + " found by classloader: "+ this.getClass().getClassLoader());
  }
  archive.addAsResource(new UrlAsset(serviceActivatorURL),serviceActivatorPath);
  archive.addAsResource(new Asset(){
    public InputStream openStream(){
      ByteArrayOutputStream baos=new ByteArrayOutputStream();
      try {
        Properties props=new Properties();
        props.setProperty(Constants.BUNDLE_SYMBOLICNAME,"arquillian-service");
        StringBuilder builder=new StringBuilder();
        builder.append("org.jboss.arquillian.container.test.api,org.jboss.arquillian.junit,");
        builder.append("org.jboss.arquillian.osgi,org.jboss.arquillian.test.api,");
        builder.append("org.jboss.as.arquillian.api,org.jboss.as.arquillian.container,org.jboss.as.osgi,");
        builder.append("org.jboss.shrinkwrap.api,org.jboss.shrinkwrap.api.asset,org.jboss.shrinkwrap.api.spec,");
        builder.append("org.junit,org.junit.runner");
        props.setProperty(Constants.EXPORT_PACKAGE,builder.toString());
        props.store(baos,null);
      }
 catch (      IOException ex) {
        throw new IllegalStateException("Cannot write osgi metadata",ex);
      }
      return new ByteArrayInputStream(baos.toByteArray());
    }
  }
,"META-INF/jbosgi-xservice.properties");
  archive.delete(ArchivePaths.create(loadableExtensionsPath));
  archive.addAsResource(new Asset(){
    @Override public InputStream openStream(){
      ByteArrayOutputStream baos=new ByteArrayOutputStream();
      PrintWriter pw=new PrintWriter(new OutputStreamWriter(baos));
      for (      String line : loadableExtensions) {
        pw.println(line);
      }
      pw.close();
      return new ByteArrayInputStream(baos.toByteArray());
    }
  }
,loadableExtensionsPath);
  log.debugf("Loadable extensions: %s",loadableExtensions);
  log.tracef("Archive content: %s\n%s",archive,archive.toString(true));
  return archive;
}
