{
  final Archive<?> appArchive=testDeployment.getApplicationArchive();
  if (archiveHolder.getArchive() == null) {
    final Collection<Archive<?>> auxArchives=testDeployment.getAuxiliaryArchives();
    JavaArchive archive=generateArquillianServiceArchive(auxArchives);
    archiveHolder.setArchive(archive);
  }
  addModulesManifestDependencies(appArchive);
  archiveHolder.addPreparedDeployment(appArchive);
  return appArchive;
}
