{
  final Archive<?> appArchive=testDeployment.getApplicationArchive();
  if (archiveHolder.getArchive() == null) {
    try {
      Collection<Archive<?>> auxArchives=testDeployment.getAuxiliaryArchives();
      JavaArchive archive=generateArquillianServiceArchive(auxArchives);
      archiveHolder.setArchive(archive);
    }
 catch (    Exception ex) {
      throw new IllegalStateException("Cannot generate arquillian service",ex);
    }
  }
  addModulesManifestDependencies(appArchive);
  archiveHolder.addPreparedDeployment(testDeployment.getDeploymentName());
  return appArchive;
}
