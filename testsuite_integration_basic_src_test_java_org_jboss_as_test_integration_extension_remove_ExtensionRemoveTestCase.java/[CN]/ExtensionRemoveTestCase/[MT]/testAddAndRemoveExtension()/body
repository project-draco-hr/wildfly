{
  File testModuleRoot=new File(getModulePath(),MODULE_NAME);
  deleteRecursively(testModuleRoot);
  createTestModule(testModuleRoot);
  try {
    ModelControllerClient client=ModelControllerClient.Factory.create(InetAddress.getByName("localhost"),9999,getCallbackHandler());
    try {
      Assert.assertFalse(readResource(client).get(EXTENSION,MODULE_NAME).isDefined());
      Assert.assertFalse(readResourceDescription(client).get(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME).isDefined());
      Assert.assertFalse(readResource(client).get(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME).isDefined());
      executeOperation(client,ADD,PathAddress.pathAddress(PathElement.pathElement(EXTENSION,MODULE_NAME)));
      Assert.assertTrue(readResource(client).get(EXTENSION,MODULE_NAME).isDefined());
      Assert.assertTrue(readResourceDescription(client).get(CHILDREN,SUBSYSTEM,MODEL_DESCRIPTION,TestExtension.SUBSYSTEM_NAME).isDefined());
      Assert.assertFalse(readResource(client).get(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME).isDefined());
      executeOperation(client,ADD,PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME)));
      executeOperation(client,ADD,PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME),PathElement.pathElement("child","one")));
      Assert.assertTrue(readResource(client).get(EXTENSION,MODULE_NAME).isDefined());
      Assert.assertTrue(readResourceDescription(client).get(CHILDREN,SUBSYSTEM,MODEL_DESCRIPTION,TestExtension.SUBSYSTEM_NAME).isDefined());
      Assert.assertTrue(readResource(client).get(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME).isDefined());
      executeOperation(client,REMOVE,PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME),PathElement.pathElement("child","one")));
      executeOperation(client,REMOVE,PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME)));
      Assert.assertTrue(readResource(client).get(EXTENSION,MODULE_NAME).isDefined());
      Assert.assertTrue(readResourceDescription(client).get(CHILDREN,SUBSYSTEM,MODEL_DESCRIPTION,TestExtension.SUBSYSTEM_NAME).isDefined());
      Assert.assertFalse(readResource(client).get(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME).isDefined());
      executeOperation(client,REMOVE,PathAddress.pathAddress(PathElement.pathElement(EXTENSION,MODULE_NAME)));
      Assert.assertFalse(readResource(client).get(EXTENSION,MODULE_NAME).isDefined());
      Assert.assertFalse(readResourceDescription(client).get(CHILDREN,SUBSYSTEM,MODEL_DESCRIPTION,TestExtension.SUBSYSTEM_NAME).isDefined());
      Assert.assertFalse(readResource(client).get(SUBSYSTEM,TestExtension.SUBSYSTEM_NAME).isDefined());
    }
  finally {
      IoUtils.safeClose(client);
    }
  }
  finally {
    deleteRecursively(testModuleRoot);
  }
}
