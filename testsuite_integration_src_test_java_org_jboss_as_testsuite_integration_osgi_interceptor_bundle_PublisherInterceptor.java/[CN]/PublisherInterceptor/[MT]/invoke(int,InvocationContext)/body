{
  HttpMetadata metadata=context.getAttachment(HttpMetadata.class);
  if (state == Bundle.STARTING) {
    String servletName=metadata.getServletName();
    try {
      log.info("Publish HttpMetadata: " + metadata);
      Bundle bundle=context.getBundle();
      Class<?> servletClass=bundle.loadClass(servletName);
      HttpServlet servlet=(HttpServlet)servletClass.newInstance();
      ClassLoader ctxLoader=Thread.currentThread().getContextClassLoader();
      try {
        HttpService httpService=getHttpService(context,true);
        httpService.registerServlet("/example-interceptor/servlet",servlet,null,null);
      }
  finally {
        Thread.currentThread().setContextClassLoader(ctxLoader);
      }
    }
 catch (    RuntimeException rte) {
      throw rte;
    }
catch (    Exception ex) {
      throw new LifecycleInterceptorException("Cannot publish: " + servletName,ex);
    }
  }
 else   if (state == Bundle.STOPPING) {
    log.info("Unpublish HttpMetadata: " + metadata);
    ClassLoader ctxLoader=Thread.currentThread().getContextClassLoader();
    try {
      HttpService httpService=getHttpService(context,false);
      if (httpService != null)       httpService.unregister("/servlet");
    }
  finally {
      Thread.currentThread().setContextClassLoader(ctxLoader);
    }
  }
}
