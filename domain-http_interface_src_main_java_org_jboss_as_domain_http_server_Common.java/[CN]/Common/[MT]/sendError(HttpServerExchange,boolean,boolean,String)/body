{
  if (encode) {
    try {
      ModelNode response=new ModelNode();
      response.set(msg);
      ByteArrayOutputStream bout=new ByteArrayOutputStream();
      response.writeBase64(bout);
      byte[] bytes=bout.toByteArray();
      exchange.getResponseHeaders().put(Headers.CONTENT_TYPE,APPLICATION_DMR_ENCODED + ";" + UTF_8);
      exchange.getResponseHeaders().put(Headers.CONTENT_LENGTH,String.valueOf(bytes.length));
      exchange.setResponseCode(500);
      exchange.getResponseSender().send(new String(bytes),IoCallback.END_EXCHANGE);
    }
 catch (    IOException e) {
      sendError(exchange,isGet,false,msg);
    }
  }
 else {
    byte[] bytes=msg.getBytes();
    exchange.getResponseHeaders().put(Headers.CONTENT_TYPE,TEXT_PLAIN + ";" + UTF_8);
    exchange.getResponseHeaders().put(Headers.CONTENT_LENGTH,String.valueOf(bytes.length));
    exchange.setResponseCode(500);
    exchange.getResponseSender().send(msg,IoCallback.END_EXCHANGE);
  }
}
