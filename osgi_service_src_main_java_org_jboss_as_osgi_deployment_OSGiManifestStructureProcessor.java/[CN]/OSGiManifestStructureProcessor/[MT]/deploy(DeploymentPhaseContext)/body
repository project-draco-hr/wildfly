{
  DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  Manifest manifest=depUnit.getAttachment(Attachments.OSGI_MANIFEST);
  if (manifest != null)   return;
  Deployment dep=BundleLifecycleIntegration.getDeployment(depUnit.getName());
  if (dep != null) {
    manifest=dep.getAttachment(IntegrationConstants.MANIFEST_KEY);
  }
  ResourceRoot deploymentRoot=depUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  if (manifest == null && deploymentRoot != null) {
    manifest=deploymentRoot.getAttachment(Attachments.MANIFEST);
  }
  if (OSGiManifestBuilder.isValidBundleManifest(manifest)) {
    depUnit.putAttachment(Attachments.OSGI_MANIFEST,manifest);
    depUnit.putAttachment(OSGiConstants.DEPLOYMENT_TYPE_KEY,DeploymentType.Bundle);
  }
}
