{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  if (depUnit.hasAttachment(Attachments.OSGI_MANIFEST))   return;
  Deployment dep=BundleLifecycleIntegration.getDeployment(depUnit.getName());
  if (dep != null) {
    Manifest manifest=dep.getAttachment(Manifest.class);
    if (manifest != null) {
      depUnit.putAttachment(Attachments.OSGI_MANIFEST,manifest);
      return;
    }
  }
  final ResourceRoot deploymentRoot=depUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  if (deploymentRoot == null)   return;
  Manifest manifest=deploymentRoot.getAttachment(Attachments.MANIFEST);
  if (OSGiManifestBuilder.isValidBundleManifest(manifest)) {
    depUnit.putAttachment(Attachments.OSGI_MANIFEST,manifest);
  }
}
