{
  if (service == null) {
    if (context == null) {
      log.warnf("BundleContext not injected");
      context=getBundleContextFromClass(ConfigurationAdmin.class);
    }
    final CountDownLatch latch=new CountDownLatch(1);
    ServiceTracker tracker=new ServiceTracker(context,ConfigurationAdmin.class.getName(),null){
      @Override public Object addingService(      ServiceReference sref){
        service=(ConfigurationAdmin)super.addingService(sref);
        log.infof("Adding service: %s",service);
        latch.countDown();
        return service;
      }
      @Override public void removedService(      ServiceReference sref,      Object instance){
        super.removedService(sref,service);
        log.infof("Removing service: %s",service);
        service=null;
      }
    }
;
    tracker.open();
    try {
      if (!latch.await(10,TimeUnit.SECONDS)) {
        throw new IllegalStateException("Timeout getting ConfigurationAdmin service");
      }
    }
 catch (    InterruptedException ex) {
    }
  }
  return service;
}
