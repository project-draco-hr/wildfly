{
  Object pk;
  PersistentContext pctx=(PersistentContext)ctx.getPersistenceContext();
  if (ctx.getPrimaryKey() == null) {
    pk=entityBridge.extractPrimaryKeyFromInstance(ctx);
    if (pk == null) {
      throw new CreateException("Primary key for created instance is null.");
    }
    pctx.setPk(pk);
  }
 else {
    try {
      pctx.flush();
    }
 catch (    SQLException e) {
      if ("23000".equals(e.getSQLState())) {
        throw new DuplicateKeyException("Unique key violation or invalid foreign key value: pk=" + ctx.getPrimaryKey());
      }
 else {
        throw new CreateException("Failed to create instance: pk=" + ctx.getPrimaryKey() + ", state="+ e.getSQLState()+ ", msg="+ e.getMessage());
      }
    }
    pk=ctx.getPrimaryKey();
  }
  return pk;
}
