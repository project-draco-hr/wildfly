{
  try {
    final ModuleIdentifier serverModuleId=ModuleIdentifier.create("org.jboss.as.server");
    final Module serverModule=moduleLoader.loadModule(serverModuleId);
    final ModuleClassLoader serverModuleClassLoader=serverModule.getClassLoader();
    Class<?> embeddedStandAloneServerFactoryClass=serverModuleClassLoader.loadClass("org.jboss.as.server.EmbeddedStandAloneServerFactory");
    Method createMethod=embeddedStandAloneServerFactoryClass.getMethod("create",File.class,ModuleLoader.class,Properties.class,Map.class);
    final StandaloneServer standaloneServer=(StandaloneServer)createMethod.invoke(null,jbossHomeDir,moduleLoader,systemProps,systemEnv);
    return standaloneServer;
  }
 catch (  ModuleLoadException e) {
    throw new RuntimeException(e);
  }
catch (  ClassNotFoundException e) {
    throw new RuntimeException(e);
  }
catch (  NoSuchMethodException e) {
    throw new RuntimeException(e);
  }
catch (  InvocationTargetException e) {
    throw new RuntimeException(e);
  }
catch (  IllegalAccessException e) {
    throw new RuntimeException(e);
  }
}
