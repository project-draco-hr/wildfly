{
  setupVfsModule(moduleLoader);
  setupLoggingSystem(moduleLoader);
  SecurityActions.setSystemProperty(SYSPROP_KEY_JBOSS_HOME_DIR,jbossHomeDir.getAbsolutePath());
  final Module embeddedModule;
  try {
    embeddedModule=moduleLoader.loadModule(ModuleIdentifier.create(MODULE_ID_EMBEDDED));
  }
 catch (  final ModuleLoadException mle) {
    throw MESSAGES.moduleLoaderError(mle,MODULE_ID_EMBEDDED,moduleLoader);
  }
  final ModuleClassLoader embeddedModuleCL=embeddedModule.getClassLoader();
  final Class<?> embeddedServerFactoryClass;
  final Class<?> standaloneServerClass;
  try {
    embeddedServerFactoryClass=embeddedModuleCL.loadClass(EmbeddedStandAloneServerFactory.class.getName());
    standaloneServerClass=embeddedModuleCL.loadClass(StandaloneServer.class.getName());
  }
 catch (  final ClassNotFoundException cnfe) {
    throw MESSAGES.cannotLoadEmbeddedServerFactory(cnfe,EmbeddedStandAloneServerFactory.class.getName());
  }
  final Method createServerMethod;
  try {
    createServerMethod=embeddedServerFactoryClass.getMethod("create",File.class,ModuleLoader.class,Properties.class,Map.class);
  }
 catch (  final NoSuchMethodException nsme) {
    throw MESSAGES.cannotGetReflectiveMethod(nsme,"create",embeddedServerFactoryClass.getName());
  }
  Object standaloneServerImpl;
  try {
    standaloneServerImpl=createServerMethod.invoke(null,jbossHomeDir,moduleLoader,SecurityActions.getSystemProperties(),SecurityActions.getSystemEnvironment());
  }
 catch (  final InvocationTargetException ite) {
    throw MESSAGES.cannotCreateStandaloneServer(ite.getCause(),createServerMethod);
  }
catch (  final IllegalAccessException iae) {
    throw MESSAGES.cannotCreateStandaloneServer(iae,createServerMethod);
  }
  return new StandaloneServerIndirection(standaloneServerClass,standaloneServerImpl);
}
