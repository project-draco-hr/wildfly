{
  State continuingState=new PromptPasswordState(theConsole,stateValues);
  if (stateValues.isSilentOrNonInteractive() == false) {
    theConsole.printf(NEW_LINE);
    theConsole.printf(MESSAGES.enterNewUserDetails());
    theConsole.printf(NEW_LINE);
    stateValues.setPassword(null);
    theConsole.printf(MESSAGES.realmPrompt(stateValues.getRealm()));
    String temp=theConsole.readLine(" : ");
    if (temp == null) {
      theConsole.printf(NEW_LINE);
      return null;
    }
    if (temp.length() > 0) {
      stateValues.setRealm(temp);
    }
    String existingUsername=stateValues.getUserName();
    String usernamePrompt=existingUsername == null ? MESSAGES.usernamePrompt() : MESSAGES.usernamePrompt(existingUsername);
    theConsole.printf(usernamePrompt);
    temp=theConsole.readLine(" : ");
    if (temp != null && temp.length() > 0) {
      existingUsername=temp;
    }
    if (temp == null || existingUsername == null || existingUsername.length() == 0) {
      return new ErrorState(theConsole,MESSAGES.noUsernameExiting());
    }
    stateValues.setUserName(existingUsername);
    if (stateValues.getKnownUsers().contains(stateValues.getUserName())) {
      State duplicateContinuing=stateValues.isSilentOrNonInteractive() ? null : new PromptNewUserState(theConsole,stateValues);
      if (stateValues.isSilentOrNonInteractive()) {
        continuingState=new ErrorState(theConsole,MESSAGES.duplicateUser(stateValues.getUserName()),duplicateContinuing,stateValues);
      }
 else {
        String message=MESSAGES.aboutToUpdateUser(stateValues.getUserName());
        String prompt=MESSAGES.isCorrectPrompt();
        stateValues.setExistingUser(true);
        continuingState=new ConfirmationChoice(theConsole,message,prompt,continuingState,duplicateContinuing);
      }
    }
  }
  return continuingState;
}
