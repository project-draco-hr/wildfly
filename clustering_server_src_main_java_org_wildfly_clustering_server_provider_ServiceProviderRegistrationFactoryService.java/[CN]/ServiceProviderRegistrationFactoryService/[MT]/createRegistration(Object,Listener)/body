{
  if (this.listeners.putIfAbsent(service,listener) != null) {
    throw new IllegalArgumentException(service.toString());
  }
  final Node node=this.group.getLocalNode();
  Operation<Set<Node>> operation=new Operation<Set<Node>>(){
    @Override public Set<Node> invoke(    Cache<Object,Set<Node>> cache){
      Set<Node> nodes=new HashSet<>(Collections.singleton(node));
      Set<Node> existing=cache.putIfAbsent(service,nodes);
      if (existing != null) {
        if (existing.add(node)) {
          cache.getAdvancedCache().withFlags(Flag.IGNORE_RETURN_VALUES).replace(service,existing);
        }
      }
      return (existing != null) ? existing : nodes;
    }
  }
;
  this.invoker.invoke(this.cache,operation);
  return new ServiceProviderRegistration(){
    @Override public Object getService(){
      return service;
    }
    @Override public Set<Node> getProviders(){
      return ServiceProviderRegistrationFactoryService.this.getProviders(service);
    }
    @Override public void close(){
      if (ServiceProviderRegistrationFactoryService.this.listeners.remove(service) != null) {
        final Node node=ServiceProviderRegistrationFactoryService.this.group.getLocalNode();
        Operation<Void> operation=new Operation<Void>(){
          @Override public Void invoke(          Cache<Object,Set<Node>> cache){
            Set<Node> nodes=cache.get(service);
            if ((nodes != null) && nodes.remove(node)) {
              if (nodes.isEmpty()) {
                cache.remove(service);
              }
 else {
                cache.replace(service,nodes);
              }
            }
            return null;
          }
        }
;
        ServiceProviderRegistrationFactoryService.this.invoker.invoke(ServiceProviderRegistrationFactoryService.this.cache,operation,Flag.IGNORE_RETURN_VALUES);
      }
    }
  }
;
}
