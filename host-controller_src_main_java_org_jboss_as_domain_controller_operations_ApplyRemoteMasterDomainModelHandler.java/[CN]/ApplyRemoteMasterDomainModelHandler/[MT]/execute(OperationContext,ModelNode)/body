{
  final ModelNode domainModel=operation.get(DOMAIN_MODEL);
  final ModelNode startRoot=Resource.Tools.readModel(context.readResourceFromRoot(PathAddress.EMPTY_ADDRESS));
  final Set<String> ourServerGroups=getOurServerGroups(context);
  final Map<String,Set<byte[]>> deploymentHashes=new HashMap<String,Set<byte[]>>();
  final Set<String> relevantDeployments=new HashSet<String>();
  final Set<byte[]> requiredContent=new HashSet<byte[]>();
  final Resource rootResource=context.readResourceForUpdate(PathAddress.EMPTY_ADDRESS);
  clearDomain(rootResource);
  if (!context.isBooting()) {
    authorizerConfiguration.reset();
  }
  List<ModelNode> addOps=new ArrayList<ModelNode>();
  for (  final ModelNode resourceDescription : domainModel.asList()) {
    final PathAddress resourceAddress=PathAddress.pathAddress(resourceDescription.require(ReadMasterDomainModelUtil.DOMAIN_RESOURCE_ADDRESS));
    if (ignoredResourceRegistry.isResourceExcluded(resourceAddress)) {
      continue;
    }
    if (resourceAddress.size() == 1 && resourceAddress.getElement(0).getKey().equals(EXTENSION)) {
      continue;
    }
    ModelNode resourceModel=resourceDescription.get(ReadMasterDomainModelUtil.DOMAIN_RESOURCE_MODEL);
    final Resource resource=getResource(resourceAddress,rootResource,resourceModel,context,addOps);
    if (resource != null && resourceAddress.size() == 1) {
      PathElement pe=resourceAddress.getElement(0);
      String peKey=pe.getKey();
      if (peKey.equals(DEPLOYMENT)) {
        ModelNode model=resource.getModel();
        String id=resourceAddress.getElement(0).getValue();
        if (model.hasDefined(CONTENT)) {
          for (          ModelNode contentItem : model.get(CONTENT).asList()) {
            if (contentItem.hasDefined(HASH)) {
              Set<byte[]> hashes=deploymentHashes.get(id);
              if (hashes == null) {
                hashes=new HashSet<byte[]>();
                deploymentHashes.put(id,hashes);
              }
              hashes.add(contentItem.get(HASH).asBytes());
              if (hostControllerEnvironment.isBackupDomainFiles()) {
                relevantDeployments.add(pe.getValue());
              }
            }
          }
        }
      }
 else       if (peKey.equals(MANAGEMENT_CLIENT_CONTENT)) {
        ModelNode model=resource.getModel();
        if (model.hasDefined(HASH)) {
          requiredContent.add(model.get(HASH).asBytes());
        }
      }
    }
 else     if (resourceAddress.size() == 2 && resourceAddress.getElement(0).getKey().equals(SERVER_GROUP) && ourServerGroups.contains(resourceAddress.getElement(0).getValue()) && resourceAddress.getElement(1).getKey().equals(DEPLOYMENT)) {
      relevantDeployments.add(resourceAddress.getElement(1).getValue());
    }
  }
  for (  String id : relevantDeployments) {
    Set<byte[]> hashes=deploymentHashes.remove(id);
    if (hashes != null) {
      requiredContent.addAll(hashes);
    }
  }
  for (  byte[] hash : requiredContent) {
    fileRepository.getDeploymentFiles(hash);
  }
  if (!context.isBooting()) {
    context.addStep(new OperationStepHandler(){
      @Override public void execute(      OperationContext context,      ModelNode operation) throws OperationFailedException {
        makeAffectedServersRestartRequired(context,startRoot);
        context.completeStep(OperationContext.RollbackHandler.NOOP_ROLLBACK_HANDLER);
      }
    }
,OperationContext.Stage.MODEL,true);
  }
  ImmutableManagementResourceRegistration registry=context.getResourceRegistration();
  for (int i=addOps.size() - 1; i >= 0; i--) {
    ModelNode subOperation=addOps.get(i);
    PathAddress stepAddress=PathAddress.pathAddress(subOperation.get(OP_ADDR));
    String stepOpName=subOperation.require(OP).asString();
    OperationStepHandler stepHandler=registry.getOperationHandler(stepAddress,stepOpName);
    if (stepHandler == null) {
      ImmutableManagementResourceRegistration child=registry.getSubModel(stepAddress);
      if (child == null) {
        throw new IllegalStateException(ControllerLogger.ROOT_LOGGER.noSuchResourceType(stepAddress));
      }
 else {
        throw new IllegalStateException(ControllerLogger.ROOT_LOGGER.noHandlerForOperation(stepOpName,stepAddress));
      }
    }
    context.addStep(subOperation,stepHandler,OperationContext.Stage.MODEL,true);
  }
  context.stepCompleted();
}
