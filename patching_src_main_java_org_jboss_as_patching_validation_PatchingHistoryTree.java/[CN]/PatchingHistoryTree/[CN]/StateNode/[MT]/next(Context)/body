{
  while (childIndex < node.children.size()) {
    final ArtifactTreeNode<S,? extends Artifact.State> child=node.children.get(childIndex++);
    final Artifact.State childState=child.artifact.getState(state,ctx);
    if (childState != null) {
      if (child.handler == null) {
        final StateNode<S,? extends Artifact.State> next=new StateNode(child,childState,state,ctx);
        next.previous=this;
        return next.next(ctx);
      }
      final StateNode<S,? extends Artifact.State> next=new StateNode(child,childState,state,ctx);
      next.previous=this;
      return next;
    }
  }
  if (collection) {
    final ArtifactCollectionState<?> col=(ArtifactCollectionState<?>)state;
    if (col.hasNext(ctx)) {
      col.next(ctx);
      childIndex=0;
      return next(ctx);
    }
  }
  if (previous == null) {
    return null;
  }
  return previous.next(ctx);
}
