{
  stateValues.setKnownGroups(new HashMap<String,String>());
  if (stateValues.getOptions().getGroupProperties() != null && stateValues.getOptions().getUserProperties() == null) {
    return new ErrorState(theConsole,MESSAGES.groupPropertiesButNoUserProperties(stateValues.getOptions().getGroupProperties()),null,stateValues);
  }
  List<File> foundFiles=new ArrayList<File>(2);
  String fileName=stateValues.getOptions().getUserProperties();
  fileName=fileName == null ? stateValues.getFileMode() == FileMode.MANAGEMENT ? MGMT_USERS_PROPERTIES : APPLICATION_USERS_PROPERTIES : fileName;
  if (!findFiles(foundFiles,fileName)) {
    return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(fileName),null,stateValues);
  }
  fileName=stateValues.getOptions().getGroupProperties();
  if (fileName != null || stateValues.getFileMode() != FileMode.UNDEFINED) {
    boolean groupFileMandatory=true;
    List<File> foundGroupFiles=new ArrayList<File>(2);
    if (fileName == null && stateValues.getFileMode() == FileMode.APPLICATION) {
      fileName=APPLICATION_ROLES_PROPERTIES;
    }
 else     if (fileName == null) {
      fileName=MGMT_GROUPS_PROPERTIES;
      groupFileMandatory=false;
    }
    fileName=fileName == null ? APPLICATION_ROLES_PROPERTIES : fileName;
    if (!findFiles(foundGroupFiles,fileName) && groupFileMandatory) {
      return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(fileName),null,stateValues);
    }
    stateValues.setGroupFiles(foundGroupFiles);
    try {
      stateValues.setKnownGroups(loadAllGroups(foundGroupFiles));
    }
 catch (    Exception e) {
      return new ErrorState(theConsole,MESSAGES.propertiesFileNotFound(fileName),null,stateValues);
    }
  }
  stateValues.setUserFiles(foundFiles);
  String realmName=null;
  Set<String> foundUsers=new HashSet<String>();
  for (  File current : stateValues.getUserFiles()) {
    UserPropertiesFileLoader pfl=null;
    try {
      pfl=loadUsersFile(current);
      foundUsers.addAll(pfl.getProperties().stringPropertyNames());
      if (realmName == null) {
        realmName=pfl.getRealmName();
      }
 else {
        String nextRealm=pfl.getRealmName();
        if (realmName.equals(nextRealm) == false) {
          return new ErrorState(theConsole,MESSAGES.multipleRealmsDetected(realmName,nextRealm),null,stateValues);
        }
      }
      pfl.stop(null);
      pfl=null;
    }
 catch (    IOException e) {
      return new ErrorState(theConsole,MESSAGES.unableToLoadUsers(current.getAbsolutePath(),e.getMessage()),null,stateValues);
    }
 finally {
      if (pfl != null) {
        pfl.stop(null);
        pfl=null;
      }
    }
  }
  if (realmName != null) {
    if (stateValues.getRealmMode() == RealmMode.USER_SUPPLIED && realmName.equals(stateValues.getRealm()) == false) {
      return new ErrorState(theConsole,MESSAGES.userRealmNotMatchDiscovered(stateValues.getRealm(),realmName),null,stateValues);
    }
    stateValues.setRealm(realmName);
    stateValues.setRealmMode(RealmMode.DISCOVERED);
  }
  stateValues.setKnownUsers(foundUsers);
  return stateValues.isInteractive() ? new PromptRealmState(theConsole,stateValues) : new PromptNewUserState(theConsole,stateValues);
}
