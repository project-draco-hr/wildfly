{
  final PatchingTestBuilder builder=createDefaultBuilder();
  final PatchingTestStepBuilder step1=builder.createStepBuilder();
  step1.oneOffPatchIdentity(PRODUCT_VERSION).setPatchId("patch1").oneOffPatchElement("base-patch-001","base",false).addModuleWithRandomContent("test.module",null).getParent().addFileWithRandomContent(null,"test","file");
  final File overlays=builder.getFile(MODULES_BASE);
  final File file=new File(overlays,".overlays");
  Assert.assertTrue(file.mkdirs());
  try {
    apply(step1);
    tree(builder.getRoot());
    Assert.fail();
  }
 catch (  Exception e) {
    Assert.assertFalse(builder.hasFile("test","file"));
    Assert.assertFalse(new File(overlays,"base-patch-001").exists());
  }
}
