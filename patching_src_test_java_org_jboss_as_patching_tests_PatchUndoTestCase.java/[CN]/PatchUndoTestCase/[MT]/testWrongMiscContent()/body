{
  final PatchingTestBuilder builder=createDefaultBuilder();
  ContentModificationUtils.addMisc(builder.getRoot(),"oo2","test-content","wrong-content");
  final MiscContentItem item=new MiscContentItem("wrong-content",new String[0],WRONG_HASH);
  final ContentModification wrongModification=new ContentModification(item,IoUtils.NO_CONTENT,ModificationType.ADD);
  final PatchingTestStepBuilder step1=builder.createStepBuilder();
  step1.oneOffPatchIdentity(PRODUCT_VERSION).setPatchId("oo2").oneOffPatchElement("base-patch-002","base",false).addModuleWithRandomContent("other.test",null).getParent().addFileWithRandomContent(null,"test","content").addContentModification(wrongModification);
  try {
    apply(step1);
    Assert.fail("should have failed");
  }
 catch (  PatchingException e) {
    Assert.assertFalse(builder.hasFile("test","content"));
    Assert.assertFalse(builder.hasFile("wrong-content"));
    final InstalledIdentity identity=loadInstallationManager();
    final PatchableTarget base=identity.getLayer("base");
    Assert.assertFalse(base.getDirectoryStructure().getModulePatchDirectory("base-patch-002").exists());
    Assert.assertFalse(identity.getInstalledImage().getPatchHistoryDir("oo2").exists());
  }
}
