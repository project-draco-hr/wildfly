{
  EntityManager entityManager=TransactionUtil.getTransactionScopedEntityManager(puScopedName);
  if (entityManager == null) {
    entityManager=createEntityManager(emf,properties,synchronizationType);
    if (JPA_LOGGER.isDebugEnabled())     JPA_LOGGER.debugf("%s: created entity manager session %s",TransactionUtil.getEntityManagerDetails(entityManager),TransactionUtil.getTransaction().toString());
    TransactionUtil.registerSynchronization(entityManager,scopedPuName);
    TransactionUtil.putEntityManagerInTransactionRegistry(scopedPuName,entityManager);
  }
 else {
    testForMixedSyncronizationTypes(entityManager,puScopedName,synchronizationType);
    if (JPA_LOGGER.isDebugEnabled()) {
      JPA_LOGGER.debugf("%s: reuse entity manager session already in tx %s",TransactionUtil.getEntityManagerDetails(entityManager),TransactionUtil.getTransaction().toString());
    }
  }
  return entityManager;
}
