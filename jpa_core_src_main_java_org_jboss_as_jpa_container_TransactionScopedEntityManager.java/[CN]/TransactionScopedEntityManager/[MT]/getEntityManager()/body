{
  EntityManager result;
  boolean isInTx;
  isInTx=TransactionUtil.isInTx();
  if (isInTx) {
    result=TransactionUtil.getOrCreateTransactionScopedEntityManager(emf,puScopedName,properties);
  }
 else {
    result=NonTxEmCloser.get(puScopedName);
    if (result == null) {
      result=EntityManagerUtil.createEntityManager(emf,properties);
      NonTxEmCloser.add(puScopedName,result);
    }
  }
  return result;
}
