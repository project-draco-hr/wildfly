{
  boolean cancelled=false;
  if (state.get() == State.RUNNING) {
    if (cancellable.cancel()) {
      cancelled=state.compareAndSet(State.RUNNING,State.CANCELLED);
    }
    if (!cancelled) {
      if (mayInterruptIfRunning) {
        runner.interrupt();
      }
      if (state.compareAndSet(State.RUNNING,State.DONE)) {
        exception.set(new CancellationException());
      }
    }
  }
synchronized (this) {
    notifyAll();
  }
  return cancelled;
}
