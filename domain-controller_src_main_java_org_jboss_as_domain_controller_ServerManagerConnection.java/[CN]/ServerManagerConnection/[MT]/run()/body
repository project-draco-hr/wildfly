{
  Unmarshaller unmarshaller=null;
  try {
    final InputStream inputStream=socket.getInputStream();
    unmarshaller=MARSHALLER_FACTORY.createUnmarshaller(CONFIG);
    for (; ; ) {
      if (!socket.isConnected())       break;
      unmarshaller.start(Marshalling.createByteInput(inputStream));
      byte commandByte=unmarshaller.readByte();
      ProtocolCommand command=ProtocolCommand.commandFor(commandByte);
      if (command == null) {
        throw new RuntimeException("Invalid command byte received: " + commandByte);
      }
      command.execute(id,socket,unmarshaller);
    }
  }
 catch (  Throwable t) {
    throw new RuntimeException(t);
  }
 finally {
    safeClose(unmarshaller);
    if (socket != null) {
      try {
        socket.close();
      }
 catch (      Throwable ignored) {
      }
    }
  }
}
