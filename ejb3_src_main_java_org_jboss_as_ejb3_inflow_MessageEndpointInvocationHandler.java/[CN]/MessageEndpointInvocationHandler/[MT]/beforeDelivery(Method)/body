{
  final Thread thread=Thread.currentThread();
  if (getSecurityManager() == null) {
    previousClassLoader=thread.getContextClassLoader();
    thread.setContextClassLoader(getApplicationClassLoader());
  }
 else {
    previousClassLoader=doPrivileged(new SetContextClassLoaderAction(getApplicationClassLoader()));
  }
  try {
    final TransactionManager tm=getTransactionManager();
    previousTx=tm.suspend();
    boolean isTransacted=service.isDeliveryTransacted(method);
    if (isTransacted) {
      tm.begin();
      currentTx=tm.getTransaction();
      if (xaRes != null)       currentTx.enlistResource(xaRes);
    }
  }
 catch (  Throwable t) {
    if (getSecurityManager() == null) {
      thread.setContextClassLoader(previousClassLoader);
    }
 else {
      doPrivileged(new SetContextClassLoaderAction(previousClassLoader));
    }
    throw new ApplicationServerInternalException(t);
  }
}
