{
  controller.start(CONTAINER_1);
  deployer.deploy(DEPLOYMENT_1);
  controller.start(CONTAINER_2);
  deployer.deploy(DEPLOYMENT_2);
  previousSelector=EJBClientContextSelector.setup("cluster/ejb3/stateless/jboss-ejb-client.properties");
  ViewChangeListener listener=directory.lookupStateless(ViewChangeListenerBean.class,ViewChangeListener.class);
  this.establishView(listener,NODE_1,NODE_2);
  StatefulRemoteHome home=directory.lookupHome(StatefulBean.class,StatefulRemoteHome.class);
  StatefulRemote remote=home.create();
  for (int i=0; i < 25; i++) {
    remote.incrementNumber();
  }
  controller.stop(CONTAINER_1);
  this.establishView(listener,NODE_2);
  int x=remote.getNumber();
  controller.start(CONTAINER_1);
  this.establishView(listener,NODE_1,NODE_2);
  int y=remote.getNumber();
  deployer.undeploy(DEPLOYMENT_2);
  controller.stop(CONTAINER_2);
  this.establishView(listener,NODE_1);
  int z=remote.getNumber();
  deployer.undeploy(DEPLOYMENT_1);
  controller.stop(CONTAINER_1);
  Assert.assertEquals(25,x);
  Assert.assertEquals(25,y);
  Assert.assertEquals(25,z);
}
