{
  final VirtualFile deploymentRoot=phaseContext.getAttachment(Attachments.DEPLOYMENT_ROOT);
  if (deploymentRoot == null || !deploymentRoot.exists())   return;
  final String deploymentRootName=deploymentRoot.getName();
  if (!deploymentRootName.endsWith(".rar")) {
    return;
  }
  VirtualFile serviceXmlFile=deploymentRoot.getChild("/META-INF/ra.xml");
  InputStream xmlStream=null;
  Connector result=null;
  try {
    if (serviceXmlFile != null && serviceXmlFile.exists()) {
      xmlStream=serviceXmlFile.openStream();
      result=(new RaParser()).parse(xmlStream);
      if (result == null)       throw new DeploymentUnitProcessingException("Failed to parse service xml [" + serviceXmlFile + "]");
    }
    File root=deploymentRoot.getPhysicalFile();
    URL url=root.toURI().toURL();
    String deploymentName=deploymentRoot.getName().substring(0,deploymentRoot.getName().indexOf(".rar"));
    ConnectorXmlDescriptor xmlDescriptor=new ConnectorXmlDescriptor(result,root,url,deploymentName);
    phaseContext.getDeploymentUnitContext().putAttachment(ConnectorXmlDescriptor.ATTACHMENT_KEY,xmlDescriptor);
  }
 catch (  Exception e) {
    throw new DeploymentUnitProcessingException("Failed to parse service xml [" + serviceXmlFile + "]",e);
  }
 finally {
    VFSUtils.safeClose(xmlStream);
  }
}
