{
  final VirtualFile deploymentRoot=phaseContext.getDeploymentUnit().getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
  if (deploymentRoot == null || !deploymentRoot.exists())   return;
  final String deploymentRootName=deploymentRoot.getLowerCaseName();
  if (!deploymentRootName.endsWith(".rar")) {
    return;
  }
  VirtualFile serviceXmlFile=deploymentRoot.getChild("/META-INF/ra.xml");
  InputStream xmlStream=null;
  Connector result=null;
  try {
    if (serviceXmlFile != null && serviceXmlFile.exists()) {
      xmlStream=serviceXmlFile.openStream();
      result=(new RaParser()).parse(xmlStream);
      if (result == null)       throw MESSAGES.failedToParseServiceXml(serviceXmlFile);
    }
    File root=deploymentRoot.getPhysicalFile();
    URL url=root.toURI().toURL();
    String deploymentName=deploymentRootName.substring(0,deploymentRootName.indexOf(".rar"));
    ConnectorXmlDescriptor xmlDescriptor=new ConnectorXmlDescriptor(result,root,url,deploymentName);
    phaseContext.getDeploymentUnit().putAttachment(ConnectorXmlDescriptor.ATTACHMENT_KEY,xmlDescriptor);
  }
 catch (  Exception e) {
    throw MESSAGES.failedToParseServiceXml(e,serviceXmlFile);
  }
 finally {
    VFSUtils.safeClose(xmlStream);
  }
}
