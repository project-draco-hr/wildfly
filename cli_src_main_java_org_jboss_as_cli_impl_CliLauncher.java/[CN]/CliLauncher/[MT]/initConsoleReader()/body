{
  final String bindingsName;
  final String osName=SecurityActions.getSystemProperty("os.name").toLowerCase();
  if (osName.indexOf("windows") >= 0) {
    bindingsName="keybindings/jline-windows-bindings.properties";
  }
 else   if (osName.startsWith("mac")) {
    bindingsName="keybindings/jline-mac-bindings.properties";
  }
 else {
    bindingsName="keybindings/jline-default-bindings.properties";
  }
  ClassLoader cl=SecurityActions.getClassLoader(CommandLineMain.class);
  InputStream bindingsIs=cl.getResourceAsStream(bindingsName);
  if (bindingsIs == null) {
    System.err.println("Failed to locate key bindings for OS '" + osName + "': "+ bindingsName);
    try {
      return new jline.ConsoleReader();
    }
 catch (    IOException e) {
      throw new IllegalStateException("Failed to initialize console reader",e);
    }
  }
 else {
    try {
      final InputStream in=new FileInputStream(FileDescriptor.in);
      String encoding=SecurityActions.getSystemProperty("jline.WindowsTerminal.output.encoding");
      if (encoding == null) {
        encoding=SecurityActions.getSystemProperty("file.encoding");
      }
      final Writer out=new PrintWriter(new OutputStreamWriter(System.out,encoding));
      return new jline.ConsoleReader(in,out,bindingsIs);
    }
 catch (    Exception e) {
      throw new IllegalStateException("Failed to initialize console reader",e);
    }
 finally {
      StreamUtils.safeClose(bindingsIs);
    }
  }
}
