{
  if (retVal instanceof Proxy) {
    EJBLocator<? extends Object> locator;
    try {
      locator=(EJBLocator<? extends Object>)EJBClient.getLocatorFor(retVal);
    }
 catch (    Exception e) {
      locator=null;
    }
    if (locator != null) {
      final ModuleDeployment module=deploymentRepository.getModules().get(new DeploymentModuleIdentifier(locator.getAppName(),locator.getModuleName(),locator.getDistinctName()));
      if (module == null) {
        throw new RuntimeException("Could not locate EJB for " + locator);
      }
      final EjbDeploymentInformation ejb=module.getEjbs().get(locator.getBeanName());
      if (ejb == null) {
        throw new RuntimeException("Could not locate EJB for " + locator);
      }
      final EjbIIOPService factory=ejb.getIorFactory();
      if (factory == null) {
        throw new RuntimeException("EJB " + locator + " is not exposed via IIOP");
      }
      retVal=factory.referenceForLocator(locator);
    }
  }
  return retVal;
}
