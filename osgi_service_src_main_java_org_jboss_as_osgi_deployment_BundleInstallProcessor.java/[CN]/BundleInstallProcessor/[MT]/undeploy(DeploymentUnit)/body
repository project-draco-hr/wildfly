{
  XBundleRevision brev=depUnit.getAttachment(OSGiConstants.BUNDLE_REVISION_KEY);
  if (brev == null)   return;
  XBundle bundle=brev.getBundle();
  BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
  if (uninstallRequired(depUnit,brev)) {
    try {
      int options=getUninstallOptions(bundleManager);
      bundleManager.uninstallBundle(bundle,options);
    }
 catch (    BundleException ex) {
      Deployment dep=depUnit.getAttachment(OSGiConstants.DEPLOYMENT_KEY);
      LOGGER.errorFailedToUninstallDeployment(ex,dep);
    }
  }
 else {
    BundleWiring wiring=brev.getWiringSupport().getWiring(false);
    if (wiring == null || !wiring.isInUse()) {
      bundleManager.removeRevision(brev,0);
    }
  }
}
