{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final Deployment deployment=depUnit.getAttachment(OSGiConstants.DEPLOYMENT_KEY);
  if (deployment == null)   return;
  ServiceController<? extends XBundleRevision> controller;
  try {
    BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
    BundleContext syscontext=depUnit.getAttachment(OSGiConstants.SYSTEM_CONTEXT_KEY);
    if (deploymentTracker.hasDeploymentName(depUnit.getName())) {
      restoreStorageState(phaseContext,deployment);
    }
    controller=bundleManager.createBundleRevision(syscontext,deployment,phaseContext.getServiceTarget(),null);
  }
 catch (  BundleException ex) {
    throw new DeploymentUnitProcessingException(ex);
  }
  phaseContext.addDeploymentDependency(controller.getName(),OSGiConstants.BUNDLE_REVISION_KEY);
  depUnit.putAttachment(BUNDLE_STATE_KEY,BundleState.INSTALLED);
}
