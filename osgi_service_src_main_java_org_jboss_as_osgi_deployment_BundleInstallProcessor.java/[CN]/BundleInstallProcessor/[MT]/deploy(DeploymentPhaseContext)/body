{
  final DeploymentUnit depUnit=context.getDeploymentUnit();
  final Deployment deployment=OSGiDeploymentAttachment.getDeployment(depUnit);
  if (deployment != null) {
    if (frameworkActivated.compareAndSet(false,true)) {
      activateFramework(context);
    }
    ServiceName serviceName;
    if (deploymentTracker.isClosed() == false && deploymentTracker.removeDeploymentName(depUnit.getName())) {
      serviceName=PersistentBundleInstallService.addService(deploymentTracker,context,deployment);
      deploymentTracker.registerPersistentBundleInstallService(serviceName);
    }
 else {
      serviceName=BundleInstallService.addService(context,deployment);
    }
    depUnit.putAttachment(INSTALL_SERVICE_NAME_KEY,serviceName);
  }
}
