{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final String contextName=deploymentUnit.getName();
  Deployment deployment=OSGiDeploymentAttachment.getDeployment(deploymentUnit);
  if (deployment == null) {
    ServiceRegistry serviceRegistry=phaseContext.getServiceRegistry();
    ServiceController<Deployment> controller=DeploymentHolderService.getDeployment(serviceRegistry,contextName);
    if (controller != null) {
      deployment=controller.getValue();
      controller.setMode(Mode.REMOVE);
    }
  }
  BundleInfo info=BundleInfoAttachment.getBundleInfo(deploymentUnit);
  if (deployment == null && info != null) {
    deployment=DeploymentFactory.createDeployment(info);
    deployment.addAttachment(BundleInfo.class,info);
    deployment.setAutoStart(true);
    OSGiDeploymentAttachment.attachDeployment(deploymentUnit,deployment);
  }
  OSGiMetaData metadata=OSGiMetaDataAttachment.getOSGiMetaData(deploymentUnit);
  if (deployment == null && metadata != null) {
    String symbolicName=metadata.getBundleSymbolicName();
    Version version=metadata.getBundleVersion();
    VirtualFile virtualFile=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
    deployment=DeploymentFactory.createDeployment(AbstractVFS.adapt(virtualFile),contextName,symbolicName,version);
    deployment.setAutoStart(true);
    deployment.addAttachment(OSGiMetaData.class,metadata);
    OSGiDeploymentAttachment.attachDeployment(deploymentUnit,deployment);
  }
  XModule resModule=XModuleAttachment.getXModuleAttachment(deploymentUnit);
  if (deployment == null && resModule != null) {
    String symbolicName=resModule.getName();
    Version version=resModule.getVersion();
    VirtualFile virtualFile=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
    deployment=DeploymentFactory.createDeployment(AbstractVFS.adapt(virtualFile),contextName,symbolicName,version);
    deployment.setAutoStart(true);
    deployment.addAttachment(XModule.class,resModule);
    OSGiDeploymentAttachment.attachDeployment(deploymentUnit,deployment);
  }
  if (deployment != null) {
    BundleInstallService.addService(phaseContext,deployment);
  }
}
