{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final Deployment deployment=depUnit.getAttachment(OSGiConstants.DEPLOYMENT_KEY);
  if (deployment == null)   return;
  ServiceName serviceName;
  try {
    final BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
    if (deploymentTracker.hasDeploymentName(depUnit.getName())) {
      restoreStorageState(phaseContext,deployment);
    }
    serviceName=bundleManager.installBundle(deployment,null);
  }
 catch (  BundleException ex) {
    throw new DeploymentUnitProcessingException(ex);
  }
  phaseContext.addDeploymentDependency(serviceName,OSGiConstants.BUNDLE_KEY);
  if (deploymentTracker.isComplete() == false) {
    phaseContext.addDeploymentDependency(INITIAL_DEPLOYMENTS_COMPLETE,AttachmentKey.create(Object.class));
  }
  depUnit.putAttachment(BUNDLE_STATE_KEY,BundleState.INSTALLED);
  depUnit.putAttachment(BUNDLE_INSTALL_SERVICE,serviceName);
}
