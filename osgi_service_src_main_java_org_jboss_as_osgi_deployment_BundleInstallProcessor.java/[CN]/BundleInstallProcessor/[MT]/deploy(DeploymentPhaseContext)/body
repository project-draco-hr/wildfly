{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final Deployment deployment=depUnit.getAttachment(OSGiConstants.DEPLOYMENT_KEY);
  if (deployment == null)   return;
  ServiceName serviceName;
  try {
    BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
    BundleContext syscontext=depUnit.getAttachment(OSGiConstants.SYSTEM_CONTEXT_KEY);
    if (deploymentTracker.hasDeploymentName(depUnit.getName())) {
      restoreStorageState(phaseContext,deployment);
    }
    serviceName=bundleManager.installBundle(syscontext,deployment,phaseContext.getServiceTarget(),null);
  }
 catch (  BundleException ex) {
    throw new DeploymentUnitProcessingException(ex);
  }
  phaseContext.addDeploymentDependency(serviceName,OSGiConstants.BUNDLE_KEY);
  depUnit.putAttachment(BUNDLE_STATE_KEY,BundleState.INSTALLED);
  depUnit.putAttachment(BUNDLE_INSTALL_SERVICE,serviceName);
}
