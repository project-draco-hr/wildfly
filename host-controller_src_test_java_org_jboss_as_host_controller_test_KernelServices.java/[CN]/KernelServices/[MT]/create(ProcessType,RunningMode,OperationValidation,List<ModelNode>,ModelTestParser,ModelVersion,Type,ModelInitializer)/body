{
  ServiceContainer container=ServiceContainer.Factory.create("test" + counter.incrementAndGet());
  ServiceTarget target=container.subTarget();
  StringConfigurationPersister persister=new StringConfigurationPersister(bootOperations,testParser);
  RunningModeControl runningModeControl=type == Type.HOST ? new HostRunningModeControl(runningMode,RestartMode.HC_ONLY) : new RunningModeControl(runningMode);
  ModelTestModelControllerService svc=new TestModelControllerService(processType,runningModeControl,persister,validateOperations,type,modelInitializer);
  ServiceBuilder<ModelController> builder=target.addService(Services.JBOSS_SERVER_CONTROLLER,svc);
  builder.install();
  svc.waitForSetup();
  ModelController controller=svc.getValue();
  KernelServices kernelServices=new KernelServices(container,controller,persister,svc.getRootRegistration(),new OperationValidator(svc.getRootRegistration()),legacyModelVersion,svc.isSuccessfulBoot(),svc.getBootError());
  return kernelServices;
}
