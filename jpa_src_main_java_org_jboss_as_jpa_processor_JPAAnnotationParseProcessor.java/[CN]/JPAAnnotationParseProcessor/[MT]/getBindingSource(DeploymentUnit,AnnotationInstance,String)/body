{
  String scopedPuName=getScopedPuName(deploymentUnit,annotation);
  ServiceName puServiceName=getPuServiceName(scopedPuName);
  if (isPersistenceContext(annotation)) {
    AnnotationValue pcType=annotation.value("type");
    PersistenceContextType type=(pcType == null || PersistenceContextType.TRANSACTION.name().equals(pcType.asString())) ? PersistenceContextType.TRANSACTION : PersistenceContextType.EXTENDED;
    Map properties;
    AnnotationValue value=annotation.value("properties");
    AnnotationInstance[] props=value != null ? value.asNestedArray() : null;
    if (props != null) {
      properties=new HashMap();
      for (int source=0; source < props.length; source++) {
        properties.put(props[source].value("name"),props[source].value("value"));
      }
    }
 else {
      properties=null;
    }
    return new PersistenceContextInjectionSource(type,properties,puServiceName,deploymentUnit,scopedPuName,injectionTypeName);
  }
 else {
    return new PersistenceUnitInjectionSource(puServiceName,deploymentUnit,scopedPuName,injectionTypeName);
  }
}
