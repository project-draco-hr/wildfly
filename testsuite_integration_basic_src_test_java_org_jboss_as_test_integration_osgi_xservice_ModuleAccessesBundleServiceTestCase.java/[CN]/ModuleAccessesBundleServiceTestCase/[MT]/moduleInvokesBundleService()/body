{
  deployer.deploy(TARGET_BUNDLE_NAME);
  try {
    ServiceReference sref=systemContext.getServiceReference(PackageAdmin.class.getName());
    PackageAdmin packageAdmin=(PackageAdmin)systemContext.getService(sref);
    Bundle[] bundles=packageAdmin.getBundles(TARGET_BUNDLE_NAME,null);
    assertNotNull("Bundles not null",bundles);
    assertEquals("One Bundle",1,bundles.length);
    final Bundle targetBundle=bundles[0];
    if (targetBundle.getState() != Bundle.ACTIVE) {
      final CountDownLatch startedLatch=new CountDownLatch(1);
      systemContext.addBundleListener(new BundleListener(){
        public void bundleChanged(        BundleEvent event){
          Bundle auxBundle=event.getBundle();
          if (targetBundle.equals(auxBundle) && BundleEvent.STARTED == event.getType()) {
            startedLatch.countDown();
          }
        }
      }
);
      startedLatch.await(5,TimeUnit.SECONDS);
    }
    Assert.assertEquals(Bundle.ACTIVE,targetBundle.getState());
    deployer.deploy(CLIENT_MODULE_NAME);
    try {
      ServiceName clientService=ServiceName.parse("jboss.osgi.example.invoker.service");
      assertServiceState(clientService,State.UP,5000);
    }
  finally {
      deployer.undeploy(CLIENT_MODULE_NAME);
    }
  }
  finally {
    deployer.undeploy(TARGET_BUNDLE_NAME);
  }
}
