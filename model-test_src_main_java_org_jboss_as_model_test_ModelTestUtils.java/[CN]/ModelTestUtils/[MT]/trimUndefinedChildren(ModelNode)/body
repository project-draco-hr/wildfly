{
  ModelNode copy=model.clone();
  for (  String key : new HashSet<String>(copy.keys())) {
    if (!copy.hasDefined(key)) {
      copy.remove(key);
    }
 else     if (copy.get(key).getType() == ModelType.OBJECT) {
      boolean undefined=true;
      for (      ModelNode mn : model.get(key).asList()) {
        Property p=mn.asProperty();
        if (p.getValue().getType() != ModelType.OBJECT) {
          continue;
        }
        for (        String subKey : new HashSet<String>(p.getValue().keys())) {
          if (copy.get(key,p.getName()).hasDefined(subKey)) {
            undefined=false;
            break;
          }
 else {
            copy.get(key,p.getName()).remove(subKey);
          }
        }
        if (undefined) {
          copy.get(key).remove(p.getName());
          if (!copy.hasDefined(key)) {
            copy.remove(key);
          }
 else           if (copy.get(key).getType() == ModelType.OBJECT) {
            if (copy.get(key).keys().size() == 0) {
              copy.remove(key);
            }
          }
        }
      }
    }
  }
  return copy;
}
