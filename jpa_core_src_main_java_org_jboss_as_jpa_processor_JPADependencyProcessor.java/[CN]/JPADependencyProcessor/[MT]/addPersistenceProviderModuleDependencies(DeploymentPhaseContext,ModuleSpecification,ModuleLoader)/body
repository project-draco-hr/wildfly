{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final ResourceRoot deploymentRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  int defaultProviderCount=0;
  Set<String> moduleDependencies=new HashSet<String>();
  for (  ResourceRoot resourceRoot : DeploymentUtils.allResourceRoots(deploymentUnit)) {
    PersistenceUnitMetadataHolder holder=resourceRoot.getAttachment(PersistenceUnitMetadataHolder.PERSISTENCE_UNITS);
    defaultProviderCount+=loadPersistenceUnits(moduleLoader,deploymentUnit,moduleDependencies,holder);
  }
  if (defaultProviderCount > 0) {
    moduleDependencies.add(Configuration.PROVIDER_MODULE_DEFAULT);
    log.info("added (default provider) " + Configuration.PROVIDER_MODULE_DEFAULT + " dependency to application deployment (since "+ defaultProviderCount+ " PU(s) didn't specify "+ Configuration.PROVIDER_MODULE+ ")");
  }
  for (  String dependency : moduleDependencies) {
    addDependency(moduleSpecification,moduleLoader,ModuleIdentifier.create(dependency));
    log.info("added " + dependency + " dependency to application deployment");
  }
}
