{
  final ModuleSpecification moduleSpecification=deploymentUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
  try {
    final Module module=moduleLoader.loadModule(HIBERNATE_3_PROVIDER);
    final URL url=module.getClassLoader().getResource(HIBERNATE3_PROVIDER_ADAPTOR.replace('.','/') + ".class");
    final String path=url.getPath();
    final String baseJarUrl=path.substring(0,path.lastIndexOf("!"));
    final URL jarUrl=new URL(baseJarUrl);
    JarFile jarFile=new JarFile(jarUrl.getFile());
    moduleSpecification.addResourceLoader(ResourceLoaderSpec.createResourceLoaderSpec(ResourceLoaders.createJarResourceLoader("hibernate3integration",jarFile)));
  }
 catch (  ModuleLoadException e) {
    throw new RuntimeException("Could not load module " + HIBERNATE_3_PROVIDER + " to add hibernate 3 adaptor to deployment",e);
  }
catch (  MalformedURLException e) {
    throw new RuntimeException("Could not add hibernate 3 integration module to deployment",e);
  }
catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
