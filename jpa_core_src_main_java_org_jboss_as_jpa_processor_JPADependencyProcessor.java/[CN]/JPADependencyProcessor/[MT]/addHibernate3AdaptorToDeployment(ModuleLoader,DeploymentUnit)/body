{
  final ModuleSpecification moduleSpecification=deploymentUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
  try {
    final Module module=moduleLoader.loadModule(HIBERNATE_3_PROVIDER);
    final URL url=module.getClassLoader().getResource(HIBERNATE3_PROVIDER_ADAPTOR.replace('.','/') + ".class");
    final URLConnection connection=url.openConnection();
    if (!(connection instanceof JarURLConnection)) {
      throw new RuntimeException("Could not add hibernate 3 integration module to deployment, did not get expected JarUrlConnection, got " + connection);
    }
    final JarFile jarFile=((JarURLConnection)connection).getJarFile();
    moduleSpecification.addResourceLoader(ResourceLoaderSpec.createResourceLoaderSpec(ResourceLoaders.createJarResourceLoader("hibernate3integration",jarFile)));
    addDependency(moduleSpecification,moduleLoader,JBOSS_AS_NAMING_ID);
    addDependency(moduleSpecification,moduleLoader,JBOSS_JANDEX_ID);
  }
 catch (  ModuleLoadException e) {
    throw new RuntimeException("Could not load module " + HIBERNATE_3_PROVIDER + " to add hibernate 3 adaptor to deployment",e);
  }
catch (  MalformedURLException e) {
    throw new RuntimeException("Could not add hibernate 3 integration module to deployment",e);
  }
catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
