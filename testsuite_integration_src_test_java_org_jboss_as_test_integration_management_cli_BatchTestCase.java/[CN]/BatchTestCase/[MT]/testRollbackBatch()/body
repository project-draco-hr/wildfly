{
  cli.sendLine("batch");
  cli.sendLine("deploy " + warFiles[0].getAbsolutePath(),true);
  cli.sendLine("deploy " + warFiles[2].getAbsolutePath(),true);
  assertTrue("Batch command executed prematurely.",testRequestFail("deployment0/SimpleServlet"));
  assertTrue("Batch command executed prematurely.",testRequestFail("deployment2/SimpleServlet"));
  cli.sendLine("run-batch");
  String line=cli.readLine(WAIT_TIMEOUT);
  assertTrue("Batch did not fail.",line.contains("Failed to execute batch"));
  assertTrue("Rollback failed.",testRequestFail("deployment0/SimpleServlet"));
  assertTrue(testRequestFail("deployment2/SimpleServlet"));
  cli.sendLine("discard-batch");
  cli.sendLine("deploy " + warFiles[0].getAbsolutePath(),true);
  line=cli.readLine(1000);
  assertTrue("Deployment failed: " + line,line.indexOf("deployed successfully") >= 0);
  String response=HttpRequest.get(getBaseURL(url) + "deployment0/SimpleServlet",10,TimeUnit.SECONDS);
  assertTrue("Invalid response: " + response,response.indexOf("SimpleServlet") >= 0);
  cli.sendLine("undeploy deployment0.war");
  assertTrue("Undeploy failed.",testRequestFail("deployment0/SimpleServlet"));
}
