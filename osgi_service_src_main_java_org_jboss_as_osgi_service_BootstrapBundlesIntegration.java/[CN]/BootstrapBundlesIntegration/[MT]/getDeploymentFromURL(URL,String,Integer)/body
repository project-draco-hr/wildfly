{
  BundleInfo info=BundleInfo.createBundleInfo(AbstractVFS.toVirtualFile(bundleURL),location);
  Deployment dep=DeploymentFactory.createDeployment(info);
  int startlevel=level != null ? level.intValue() : 0;
  if (startlevel > 0) {
    dep.setStartLevel(level.intValue());
    dep.setAutoStart(true);
  }
  BundleStorage storageProvider=injectedStorageProvider.getValue();
  Long bundleId=injectedEnvironment.getValue().nextResourceIdentifier(null,dep.getSymbolicName());
  StorageState storageState=storageProvider.createStorageState(bundleId,location,startlevel,null);
  dep.addAttachment(StorageState.class,storageState);
  return dep;
}
