{
  final PatchingTestBuilder test=createDefaultBuilder();
  final File existing=test.getFile(FILE_EXISTING);
  touch(existing);
  dump(existing,randomString());
  final byte[] existingHash=hashFile(existing);
  final byte[] resultingHash=Arrays.copyOf(existingHash,existingHash.length);
  final PatchingTestStepBuilder oop1=test.createStepBuilder();
  oop1.setPatchId("oop1").oneOffPatchIdentity(PRODUCT_VERSION).oneOffPatchElement("base-oop1","base",false).addModuleWithRandomContent("org.jboss.test",null).getParent().addFileWithRandomContent(resultingHash,FILE_EXISTING);
  ;
  apply(oop1,ContentVerificationPolicy.OVERRIDE_ALL);
  Assert.assertTrue(test.hasFile(FILE_EXISTING));
  final byte[] moduleHash=new byte[20];
  final PatchingTestStepBuilder cp1=test.createStepBuilder();
  cp1.setPatchId("CP1").upgradeIdentity(PRODUCT_VERSION,PRODUCT_VERSION).upgradeElement("base-CP1","base",false).addModuleWithRandomContent("org.jboss.test",moduleHash).getParent();
  apply(cp1,ContentVerificationPolicy.OVERRIDE_ALL);
  Assert.assertTrue(test.hasFile(FILE_EXISTING));
  rollback(cp1);
  rollback(oop1);
  Assert.assertTrue(test.hasFile(FILE_EXISTING));
}
