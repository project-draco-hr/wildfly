{
  final PatchingTestBuilder builder=createDefaultBuilder();
  final byte[] moduleHashOne=new byte[20];
  final byte[] moduleHashTwo=new byte[20];
  final PatchingTestStepBuilder cp1=builder.createStepBuilder();
  cp1.setPatchId("CP1").upgradeIdentity(PRODUCT_VERSION,PRODUCT_VERSION).upgradeElement("base-CP1","base",false).addModuleWithRandomContent("org.jboss.test",moduleHashOne);
  apply(cp1);
  final PatchingTestStepBuilder cp2=builder.createStepBuilder();
  cp2.setPatchId("CP2").upgradeIdentity(PRODUCT_VERSION,PRODUCT_VERSION).upgradeElement("base-CP2","base",false).addModuleWithRandomContent("org.jboss.test.two",moduleHashTwo);
  apply(cp2);
  InstalledIdentity identity=loadInstallationManager();
  PatchStepAssertions.assertModule("base-CP2",identity.getLayer("base"),"org.jboss.test","main");
  PatchStepAssertions.assertModule("base-CP2",identity.getLayer("base"),"org.jboss.test.two","main");
  final PatchingTestStepBuilder cp3=builder.createStepBuilder();
  cp3.setPatchId("CP3").upgradeIdentity(PRODUCT_VERSION,PRODUCT_VERSION).upgradeElement("base-CP3","base",false).removeModule("org.jboss.test.two","main",moduleHashTwo);
  apply(cp3);
  identity=loadInstallationManager();
  PatchStepAssertions.assertModule("base-CP3",identity.getLayer("base"),"org.jboss.test","main");
  PatchStepAssertions.assertModule("base-CP3",identity.getLayer("base"),"org.jboss.test.two","main");
  rollback(cp3);
  identity=loadInstallationManager();
  PatchStepAssertions.assertModule("base-CP2",identity.getLayer("base"),"org.jboss.test","main");
  PatchStepAssertions.assertModule("base-CP2",identity.getLayer("base"),"org.jboss.test.two","main");
  rollback(cp2);
  identity=loadInstallationManager();
  PatchStepAssertions.assertModule("base-CP1",identity.getLayer("base"),"org.jboss.test","main");
  rollback(cp1);
}
