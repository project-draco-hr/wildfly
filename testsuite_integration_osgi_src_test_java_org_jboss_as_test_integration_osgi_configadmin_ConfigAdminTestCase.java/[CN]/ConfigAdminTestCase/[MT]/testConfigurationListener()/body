{
  final AtomicInteger invocationCount=new AtomicInteger();
  final CountDownLatch[] latches=new CountDownLatch[]{new CountDownLatch(1),new CountDownLatch(1)};
  final Dictionary[] dictionaries=new Dictionary[2];
  ConfigAdminListener listener=new ConfigAdminListener(){
    @Override public void configurationModified(    String pid,    Dictionary<String,String> props){
      int index=invocationCount.getAndIncrement();
      if (index < 2) {
        dictionaries[index]=props;
        latches[index].countDown();
      }
    }
    @Override public Set<String> getPIDs(){
      return Collections.singleton(PID_B);
    }
  }
;
  ConfigAdmin configAdmin=getConfigAdmin();
  configAdmin.addListener(listener);
  Assert.assertTrue(latches[0].await(3,TimeUnit.SECONDS));
  Assert.assertNull("First invocation with null, but was: " + dictionaries[0],dictionaries[0]);
  Dictionary<String,String> config=new Hashtable<String,String>();
  config.put("foo","bar");
  configAdmin.putConfiguration(PID_B,config);
  try {
    Assert.assertTrue(latches[1].await(3,TimeUnit.SECONDS));
    Assert.assertNotNull("Second invocation not null",dictionaries[1]);
    Assert.assertEquals("bar",dictionaries[1].get("foo"));
  }
  finally {
    configAdmin.removeConfiguration(PID_B);
    configAdmin.removeListener(listener);
  }
}
