{
  final PathAddress opAddress=PathAddress.pathAddress(operation.get(OP_ADDR));
  if (!expectedSteps.contains(opAddress) && failOnUnexpected) {
    if (opAddress.size() == 2) {
      if (opAddress.getElement(0).getKey().equals(HOST) && opAddress.getElement(1).getKey().equals(SERVER) && (operation.get(OP).asString().equals(ADD) || operation.get(OP).asString().equals(REMOVE))) {
        return;
      }
    }
    fail("Should not have added step for: " + opAddress);
  }
  expectedSteps.remove(opAddress);
  List<OperationAndHandler> stageList=addedSteps.get(stage);
  if (stageList == null) {
    stageList=new ArrayList<OperationAndHandler>();
    addedSteps.put(stage,stageList);
  }
  OperationAndHandler oah=new OperationAndHandler(operation,step);
  if (addFirst) {
    stageList.add(0,oah);
  }
 else {
    stageList.add(oah);
  }
}
