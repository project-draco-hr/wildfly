{
  log.debugf("Adding content with name %s",name);
  byte[] sha1Bytes=null;
  File tmp=File.createTempFile(name,"tmp",repoRoot);
  FileOutputStream fos=new FileOutputStream(tmp);
synchronized (messageDigest) {
    messageDigest.reset();
    try {
      DigestOutputStream dos=new DigestOutputStream(fos,messageDigest);
      BufferedInputStream bis=new BufferedInputStream(stream);
      byte[] bytes=new byte[8192];
      int read;
      while ((read=bis.read(bytes)) > 0) {
        dos.write(bytes,0,read);
      }
    }
  finally {
      try {
        fos.close();
      }
 catch (      Exception ignored) {
      }
    }
    sha1Bytes=messageDigest.digest();
  }
  String sha1=bytesToHexString(sha1Bytes);
  String partA=sha1.substring(0,2);
  String partB=sha1.substring(2);
  File base=new File(repoRoot,partA);
  validateDir(base);
  File realDir=new File(base,partB);
  if (!realDir.exists() && !realDir.mkdirs()) {
    throw new IllegalStateException("Cannot create directory " + realDir.getAbsolutePath());
  }
  File realFile=new File(realDir,CONTENT);
  if (realFile.exists()) {
    if (!tmp.delete()) {
      tmp.deleteOnExit();
    }
    log.debugf("Content with name %s was already present in repository at location %s",name,realFile.getAbsolutePath());
  }
 else {
    moveTempToPermanent(tmp,realFile);
    log.infof("Content with name %s added at location %s",name,realFile.getAbsolutePath());
  }
  return sha1Bytes;
}
