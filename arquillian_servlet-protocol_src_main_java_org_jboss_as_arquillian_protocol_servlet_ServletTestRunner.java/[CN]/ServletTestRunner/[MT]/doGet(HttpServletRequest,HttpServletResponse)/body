{
  String outputMode=OUTPUT_MODE_HTML;
  try {
    String className=null;
    String methodName=null;
    if (request.getParameter(PARA_OUTPUT_MODE) != null) {
      outputMode=request.getParameter(PARA_OUTPUT_MODE);
    }
    className=request.getParameter(PARA_CLASS_NAME);
    if (className == null) {
      throw new IllegalArgumentException(PARA_CLASS_NAME + " must be specified");
    }
    methodName=request.getParameter(PARA_METHOD_NAME);
    if (methodName == null) {
      throw new IllegalArgumentException(PARA_METHOD_NAME + " must be specified");
    }
    WebConversationFactory.setThreadLocals(request);
    try {
      MBeanServer mbeanServer=ManagementFactory.getPlatformMBeanServer();
      ObjectName name=new ObjectName("jboss.arquillian:service=jmx-test-runner");
      TestResult testResult=(TestResult)mbeanServer.invoke(name,"runTestMethod",new Object[]{className,methodName,new HashMap<String,String>()},new String[]{String.class.getName(),String.class.getName(),Map.class.getName()});
      if (OUTPUT_MODE_SERIALIZED.equalsIgnoreCase(outputMode)) {
        writeObject(testResult,response);
      }
 else {
        response.setContentType("text/html");
        response.setStatus(HttpServletResponse.SC_OK);
        PrintWriter writer=response.getWriter();
        writer.write("<html>\n");
        writer.write("<head><title>TCK Report</title></head>\n");
        writer.write("<body>\n");
        writer.write("<h2>Configuration</h2>\n");
        writer.write("<table>\n");
        writer.write("<tr>\n");
        writer.write("<td><b>Method</b></td><td><b>Status</b></td>\n");
        writer.write("</tr>\n");
        writer.write("</table>\n");
        writer.write("<h2>Tests</h2>\n");
        writer.write("<table>\n");
        writer.write("<tr>\n");
        writer.write("<td><b>Method</b></td><td><b>Status</b></td>\n");
        writer.write("</tr>\n");
        writer.write("</table>\n");
        writer.write("</body>\n");
      }
    }
  finally {
      WebConversationFactory.removeThreadLocals();
    }
  }
 catch (  Exception e) {
    if (OUTPUT_MODE_SERIALIZED.equalsIgnoreCase(outputMode)) {
      writeObject(createFailedResult(e),response);
    }
 else {
      response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,e.getMessage());
    }
  }
}
