{
  boolean ok=false;
  final Connection connection=connectionManager.connect();
  try {
    channelHandler.executeRequest(new ServerRegisterRequest(),null,callback);
    channelHandler.getAttachments().attach(TransactionalProtocolClient.SEND_SUBJECT,Boolean.TRUE);
    channelHandler.addHandlerFactory(new TransactionalProtocolOperationHandler(controller,channelHandler));
    ok=true;
  }
  finally {
    if (!ok) {
      connection.close();
    }
  }
}
