{
  ServiceName deploymentServiceName=DeploymentService.getServiceName(context.getName());
  Deployment deployment=DeploymentAttachment.getDeploymentAttachment(context);
  deployment.addAttachment(ServiceName.class,deploymentServiceName);
  BatchBuilder batchBuilder=context.getBatchBuilder();
  OSGiDeploymentService service=new OSGiDeploymentService(deployment);
  ServiceName serviceName=OSGiDeploymentService.SERVICE_NAME.append(deploymentServiceName.getSimpleName());
  BatchServiceBuilder<Deployment> serviceBuilder=batchBuilder.addService(serviceName,service);
  serviceBuilder.addDependency(FrameworkService.SERVICE_NAME,BundleContext.class,service.injectedContext);
  serviceBuilder.addDependency(PackageAdminService.SERVICE_NAME);
  serviceBuilder.addDependency(deploymentServiceName);
  serviceBuilder.setInitialMode(Mode.IMMEDIATE);
  if (enableListener)   serviceBuilder.addListener(listener);
}
