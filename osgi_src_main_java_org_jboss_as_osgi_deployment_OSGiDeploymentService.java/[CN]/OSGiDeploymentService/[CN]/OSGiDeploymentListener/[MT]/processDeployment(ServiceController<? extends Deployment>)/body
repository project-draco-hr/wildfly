{
  controller.removeListener(this);
  Set<Deployment> bundlesToStart=null;
synchronized (this) {
    pendingDeployments.remove(controller.getValue());
    if (pendingDeployments.isEmpty()) {
      bundlesToStart=new HashSet<Deployment>(startedDeployments);
      startedDeployments.clear();
    }
  }
  if (bundlesToStart != null) {
    ServiceContainer serviceContainer=controller.getServiceContainer();
    PackageAdmin packageAdmin=PackageAdminService.getServiceValue(serviceContainer);
    for (    Deployment deployment : bundlesToStart) {
      Bundle bundle=deployment.getAttachment(Bundle.class);
      if (packageAdmin.getBundleType(bundle) != PackageAdmin.BUNDLE_TYPE_FRAGMENT) {
        log.tracef("Starting bundle: %s",bundle);
        try {
          bundle.start();
        }
 catch (        BundleException ex) {
          log.errorf(ex,"Cannot start bundle: %s",bundle);
        }
      }
    }
  }
}
