{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final DeploymentUnit parentDeploymentUnit=deploymentUnit.getParent();
  final ServiceName ejbClientContextServiceName;
  if (parentDeploymentUnit != null) {
    ejbClientContextServiceName=parentDeploymentUnit.getAttachment(EjbDeploymentAttachmentKeys.EJB_CLIENT_CONTEXT_SERVICE_NAME);
  }
 else {
    ejbClientContextServiceName=deploymentUnit.getAttachment(EjbDeploymentAttachmentKeys.EJB_CLIENT_CONTEXT_SERVICE_NAME);
  }
  if (ejbClientContextServiceName == null) {
    throw new IllegalStateException("Deployment unit " + deploymentUnit + " doesn't contain the service name for EJB client context");
  }
  logger.debug("Using " + ejbClientContextServiceName + " as the EJB client context service for deployment unit "+ deploymentUnit);
  phaseContext.addDeploymentDependency(ejbClientContextServiceName,EjbDeploymentAttachmentKeys.EJB_CLIENT_CONTEXT);
}
