{
  final KernelServices kernelServices=boot();
  final PathAddress consoleHandler=createConsoleHandlerAddress("CONSOLE2");
  ModelNode op=SubsystemOperations.createAddOperation(consoleHandler.toModelNode());
  op.get(CommonAttributes.LEVEL.getName()).set("INFO");
  op.get(CommonAttributes.FORMATTER.getName()).set("%d{HH:mm:ss,SSS} %-5p [%c] (%t) CONSOLE2: %s%E%n");
  ModelNode result=kernelServices.executeOperation(op);
  Assert.assertTrue(SubsystemOperations.getFailureDescriptionAsString(result),SubsystemOperations.isSuccessfulOutcome(result));
  final PathAddress loggerAddress=createLoggerAddress("org.jboss.as.logging");
  op=SubsystemOperations.createOperation(CommonAttributes.ADD_HANDLER_OPERATION_NAME,loggerAddress.toModelNode());
  op.get(CommonAttributes.HANDLER_NAME.getName()).set(consoleHandler.getLastElement().getValue());
  result=kernelServices.executeOperation(op);
  Assert.assertTrue(SubsystemOperations.getFailureDescriptionAsString(result),SubsystemOperations.isSuccessfulOutcome(result));
  final ModelNode validSubsystemModel=getSubsystemModel(kernelServices);
  final CompositeOperationBuilder operationBuilder=CompositeOperationBuilder.create();
  final PathAddress fileHandlerAddress=createFileHandlerAddress("fail-fh");
  final ModelNode fileHandlerOp=SubsystemOperations.createAddOperation(fileHandlerAddress.toModelNode());
  fileHandlerOp.get(CommonAttributes.FILE.getName(),PathResourceDefinition.RELATIVE_TO.getName()).set("jboss.server.log.dir");
  fileHandlerOp.get(CommonAttributes.FILE.getName(),PathResourceDefinition.PATH.getName()).set("fail-fh.log");
  fileHandlerOp.get(CommonAttributes.AUTOFLUSH.getName()).set(true);
  operationBuilder.addStep(fileHandlerOp);
  final PathAddress testLoggerAddress=createLoggerAddress(PROFILE_NAME,"test");
  final ModelNode testLoggerOp=SubsystemOperations.createAddOperation(testLoggerAddress.toModelNode());
  operationBuilder.addStep(testLoggerOp);
  operationBuilder.addStep(SubsystemOperations.createRemoveOperation(consoleHandler.toModelNode()));
  operationBuilder.addStep(SubsystemOperations.createWriteAttributeOperation(loggerAddress.toModelNode(),CommonAttributes.HANDLERS,new ModelNode().setEmptyList().add("fail-fh")));
  result=kernelServices.executeOperation(operationBuilder.build().getOperation());
  Assert.assertFalse("The add operation should have failed, but was successful: " + result,SubsystemOperations.isSuccessfulOutcome(result));
  final ModelNode currentModel=getSubsystemModel(kernelServices);
  compare(validSubsystemModel,currentModel);
  final ConfigurationPersistence config=ConfigurationPersistence.getConfigurationPersistence(LogContext.getLogContext());
  compare(currentModel,config);
}
