{
  log.infof("Activating deployment: %s",deploymentName);
  MountHandle handle=null;
  try {
    final ServerDeploymentRepository deploymentRepo=getDeploymentRepository(serviceContainer);
    final VirtualFile deploymentRoot=VFS.getChild("content/" + runtimeName);
    try {
      Closeable mount=deploymentRepo.mountDeploymentContent(deploymentName,runtimeName,deploymentHash,deploymentRoot);
      handle=new MountHandle(mount);
    }
 catch (    IOException e) {
      throw new RuntimeException("Failed to mount deployment archive",e);
    }
    final ServiceTarget target=context.getServiceTarget();
    DeploymentService deploymentService=new DeploymentService(handle);
    ServiceBuilder<Void> serviceBuilder=target.addService(deploymentServiceName,deploymentService);
    final BatchBuilder deploymentSubBatch=target.batchBuilder();
    deploymentSubBatch.addDependency(deploymentServiceName);
    deploymentSubBatch.addListener(new DeploymentFailureListener(deploymentServiceName));
    final DeploymentUnitContext deploymentUnitContext=new DeploymentUnitContextImpl(deploymentServiceName.getSimpleName(),deploymentSubBatch,serviceBuilder);
    deploymentUnitContext.putAttachment(Attachments.DEPLOYMENT_ROOT,deploymentRoot);
    deploymentUnitContext.putAttachment(MountHandle.ATTACHMENT_KEY,handle);
    try {
      Manifest manifest=VFSUtils.getManifest(deploymentRoot);
      if (manifest != null)       deploymentUnitContext.putAttachment(Attachments.MANIFEST,manifest);
    }
 catch (    IOException e) {
      throw new RuntimeException("Failed to get manifest for deployment " + deploymentRoot,e);
    }
    final ServiceController<?> deploymentChainController=serviceContainer.getService(DeploymentChain.SERVICE_NAME);
    final DeploymentChain deploymentChain=(DeploymentChain)deploymentChainController.getValue();
    log.debugf("Executing deployment '%s' with chain: %s",deploymentName,deploymentChain);
    if (deploymentChain == null)     throw new RuntimeException("Failed determine the deployment chain for deployment root: " + deploymentRoot);
    try {
      deploymentChain.deploy(deploymentUnitContext);
      serviceBuilder.install();
      deploymentSubBatch.install();
    }
 catch (    DeploymentUnitProcessingException e) {
      throw new RuntimeException("Failed to process deployment chain.",e);
    }
  }
 catch (  Throwable t) {
    VFSUtils.safeClose(handle);
    if (t instanceof RuntimeException) {
      throw (RuntimeException)t;
    }
    throw new RuntimeException("Failed to activate deployment unit " + deploymentName,t);
  }
}
