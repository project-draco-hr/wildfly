{
  if (instance.isDiscarded()) {
    return;
  }
  if (instance.getPrimaryKey() == null)   return;
  final CacheEntry cacheEntry=cache.get(instance.getPrimaryKey());
  if (cacheEntry == null) {
    throw EjbLogger.ROOT_LOGGER.entityBeanInstanceNotFoundInCache(instance);
  }
  if (cacheEntry.replacedInstance != null) {
    if (instance == cacheEntry.replacedInstance) {
      if (success) {
        cacheEntry.instance=cacheEntry.replacedInstance;
      }
 else       if (cacheEntry.instance.isDiscarded()) {
        cache.remove(instance.getPrimaryKey());
        return;
      }
      cacheEntry.replacedInstance=null;
    }
  }
  if (!success && instance.isRemoved()) {
    instance.setRemoved(false);
  }
  if (cacheEntry.referenceCount.decrementAndGet() == 0) {
    final Object pk=instance.getPrimaryKey();
    try {
      instance.passivate();
      component.releaseEntityBeanInstance(instance);
    }
  finally {
      cache.remove(pk);
    }
  }
}
