{
  if (instance.isDiscarded()) {
    return;
  }
  if (instance.getPrimaryKey() == null)   return;
  final CacheEntry cacheEntry=cache.get(instance.getPrimaryKey());
  if (cacheEntry == null) {
    throw new IllegalArgumentException("Instance [" + instance + "] not found in cache");
  }
  if (cacheEntry.replacedInstance != null) {
    if (instance == cacheEntry.replacedInstance) {
      if (success) {
        cacheEntry.instance=cacheEntry.replacedInstance;
      }
 else       if (cacheEntry.instance.isDiscarded()) {
        cache.remove(instance.getPrimaryKey());
        return;
      }
      cacheEntry.replacedInstance=null;
    }
  }
  if (cacheEntry.referenceCount.decrementAndGet() == 0) {
    if (!success && instance.isRemoved()) {
      instance.setRemoved(false);
    }
    instance.passivate();
    component.getPool().release(instance);
    cache.remove(instance.getPrimaryKey());
  }
 else   if (instance.isRemoved() && success) {
    component.getPool().release(instance);
    cache.remove(instance.getPrimaryKey());
  }
}
