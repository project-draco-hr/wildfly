{
  Connection c=null;
  PreparedStatement ps=null;
  boolean throwRuntimeExceptions=entity.getMetaData().getThrowRuntimeExceptions();
  if (throwRuntimeExceptions) {
    try {
      c=entity.getDataSource().getConnection();
    }
 catch (    SQLException sqle) {
      javax.ejb.EJBException ejbe=new javax.ejb.EJBException("Could not get a connection; " + sqle);
      ejbe.initCause(sqle);
      throw ejbe;
    }
  }
  try {
    if (log.isDebugEnabled()) {
      log.debug("Executing SQL: " + insertSQL);
    }
    if (!throwRuntimeExceptions) {
      c=entity.getDataSource().getConnection();
    }
    ps=prepareStatement(c,insertSQL,ctx);
    int index=1;
    for (int fieldInd=0; fieldInd < insertFields.length; ++fieldInd) {
      index=insertFields[fieldInd].setInstanceParameters(ps,index,ctx);
    }
    int rowsAffected=executeInsert(index,ps,ctx);
    if (rowsAffected != 1) {
      throw CmpMessages.MESSAGES.expectedOneRow(rowsAffected,ctx.getPrimaryKey());
    }
  }
 catch (  SQLException e) {
    if (exceptionProcessor != null && exceptionProcessor.isDuplicateKey(e)) {
      throw CmpMessages.MESSAGES.uniqueKeyViolationInvalidFk(ctx.getPrimaryKey());
    }
 else {
      throw CmpMessages.MESSAGES.couldNotCreateEntity(e);
    }
  }
 finally {
    JDBCUtil.safeClose(ps);
    JDBCUtil.safeClose(c);
  }
  for (int fieldInd=0; fieldInd < insertFields.length; ++fieldInd) {
    insertFields[fieldInd].setClean(ctx);
  }
}
