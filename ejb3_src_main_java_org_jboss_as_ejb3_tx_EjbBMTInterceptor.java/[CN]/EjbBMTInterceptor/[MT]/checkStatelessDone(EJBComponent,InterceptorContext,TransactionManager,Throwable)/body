{
  int status=Status.STATUS_NO_TRANSACTION;
  try {
    status=tm.getStatus();
  }
 catch (  SystemException sex) {
    log.error("Failed to get status",sex);
  }
switch (status) {
case Status.STATUS_ACTIVE:
case Status.STATUS_COMMITTING:
case Status.STATUS_MARKED_ROLLBACK:
case Status.STATUS_PREPARING:
case Status.STATUS_ROLLING_BACK:
    try {
      tm.rollback();
    }
 catch (    Exception sex) {
      log.error("Failed to rollback",sex);
    }
case Status.STATUS_PREPARED:
  String msg="EJB 3.1 FR 13.3.3: BMT bean " + component.getComponentName() + " should complete transaction before returning.";
log.error(msg);
if (ex instanceof Exception) {
throw new EJBException(msg,(Exception)ex);
}
 else {
throw new EJBException(msg,new RuntimeException(ex));
}
}
if (ex != null) throw this.handleException(invocation,ex);
}
