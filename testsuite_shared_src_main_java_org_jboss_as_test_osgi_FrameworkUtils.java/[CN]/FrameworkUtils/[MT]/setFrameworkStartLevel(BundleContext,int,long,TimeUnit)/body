{
  final FrameworkStartLevel startLevel=context.getBundle().adapt(FrameworkStartLevel.class);
  if (level != startLevel.getStartLevel()) {
    final CountDownLatch latch=new CountDownLatch(1);
    FrameworkListener listener=new FrameworkListener(){
      public void frameworkEvent(      FrameworkEvent event){
        if (event.getType() == FrameworkEvent.STARTLEVEL_CHANGED && level == startLevel.getStartLevel()) {
          latch.countDown();
        }
      }
    }
;
    startLevel.setStartLevel(level,listener);
    if (latch.await(timeout,units) == false)     throw new TimeoutException("Timeout changing start level");
  }
}
