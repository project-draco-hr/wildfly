{
  final String depname=archive.getName();
  TestServerDeploymentRepository.getServiceValue(serviceContainer).registerDeploymentArchive(depname,archive);
  BatchedWork work=new BatchedWork(){
    public void execute(    BatchBuilder batchBuilder) throws Exception {
      ServerGroupDeploymentElement depElement=new ServerGroupDeploymentElement(depname,depname,BLANK_SHA1,true);
      ServerDeploymentTestSupport.deploy(depElement,batchBuilder,serviceContainer);
    }
  }
;
  Bundle result=null;
  List<ServiceName> depServiceNames=runWithLatchedBatch(work);
  for (  ServiceName sname : depServiceNames) {
    if (sname.getCanonicalName().startsWith(OSGiDeploymentService.SERVICE_NAME.getCanonicalName())) {
      ServiceController<?> controller=serviceContainer.getRequiredService(sname);
      result=((Deployment)controller.getValue()).getAttachment(Bundle.class);
    }
  }
  return result;
}
