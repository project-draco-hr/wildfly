{
  final BatchBuilderSupport batchBuilder=new BatchBuilderSupport(serviceContainer.batchBuilder());
  final CountDownLatch latch=new CountDownLatch(1);
  final AtomicBoolean completed=new AtomicBoolean(false);
  Runnable finishTask=new Runnable(){
    public void run(){
      completed.set(true);
      latch.countDown();
    }
  }
;
  final TestServiceListener listener=new TestServiceListener(finishTask,batchBuilder.getInitialModes());
  batchBuilder.addListener(listener);
  work.execute(batchBuilder);
  batchBuilder.install();
  listener.finishBatch();
  latch.await(5L,TimeUnit.SECONDS);
  if (!completed.get()) {
    List<ServiceName> notstartedServices=new ArrayList<ServiceName>(listener.registeredServices);
    for (    ServiceName aux : listener.startedServices)     notstartedServices.remove(aux);
    StringBuffer message=new StringBuffer("Did not install services within 5 seconds.");
    message.append("\n registered services: " + listener.registeredServices);
    message.append("\n on-demand services: " + listener.initialModes.get(Mode.ON_DEMAND));
    message.append("\n started services: " + listener.startedServices);
    message.append("\n failed services: " + listener.failedServices);
    message.append("\n not-started services: " + notstartedServices);
    fail(message.toString());
  }
  return Collections.unmodifiableList(listener.registeredServices);
}
