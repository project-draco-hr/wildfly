{
  if (org.apache.tomcat.util.Constants.ENABLE_MODELER) {
    final MBeanServer mbeanServer=this.mbeanServer.getOptionalValue();
    if (mbeanServer != null) {
      Registry.getRegistry(null,null).setMBeanServer(mbeanServer);
    }
  }
  System.setProperty("catalina.home",pathManagerInjector.getValue().getPathEntry(tempPathName).resolvePath());
  final StandardServer server=new StandardServer();
  final StandardService service=new StandardService();
  service.setName(JBOSS_WEB);
  service.setServer(server);
  server.addService(service);
  final Engine engine=new StandardEngine();
  engine.setName(JBOSS_WEB);
  engine.setService(service);
  engine.setDefaultHost(defaultHost);
  if (instanceId != null) {
    engine.setJvmRoute(instanceId);
  }
  try {
    Valve valve=WebValve.createValve("/home/jfclere/jbossweb_sandbox/valves/valves.jar","org.apache.coyote.Mytest.TestValve",this.getClass().getClassLoader());
    ((StandardEngine)engine).addValve(valve);
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
  service.setContainer(engine);
  if (useNative) {
    final AprLifecycleListener apr=new AprLifecycleListener();
    apr.setSSLEngine("on");
    server.addLifecycleListener(apr);
  }
  server.addLifecycleListener(new JasperListener());
  try {
    server.init();
    server.start();
  }
 catch (  Exception e) {
    throw new StartException(MESSAGES.errorStartingWeb(),e);
  }
  this.server=server;
  this.service=service;
  this.engine=engine;
}
