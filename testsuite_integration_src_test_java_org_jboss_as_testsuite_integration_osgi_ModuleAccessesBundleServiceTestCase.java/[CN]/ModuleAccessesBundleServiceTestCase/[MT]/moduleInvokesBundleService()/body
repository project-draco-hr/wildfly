{
  Archive<?> targetArchive=deploymentProvider.getClientDeployment(TARGET_BUNDLE_NAME);
  String targetDeploymentName=archiveDeployer.deploy(targetArchive);
  assertNotNull("Deployment name not null",targetDeploymentName);
  try {
    ServiceReference sref=systemContext.getServiceReference(PackageAdmin.class.getName());
    PackageAdmin packageAdmin=(PackageAdmin)systemContext.getService(sref);
    Bundle[] bundles=packageAdmin.getBundles(TARGET_BUNDLE_NAME,null);
    assertNotNull("Bundles not null",bundles);
    assertEquals("One Bundle",1,bundles.length);
    final Bundle targetBundle=bundles[0];
    if (targetBundle.getState() != Bundle.ACTIVE) {
      final CountDownLatch startedLatch=new CountDownLatch(1);
      systemContext.addBundleListener(new BundleListener(){
        public void bundleChanged(        BundleEvent event){
          Bundle auxBundle=event.getBundle();
          if (targetBundle.equals(auxBundle) && BundleEvent.STARTED == event.getType()) {
            startedLatch.countDown();
          }
        }
      }
);
      if (startedLatch.await(2000,TimeUnit.MILLISECONDS) == false) {
        fail("Timeout starting: " + targetBundle);
      }
    }
    OSGiTestHelper.assertBundleState(Bundle.ACTIVE,targetBundle.getState());
    Archive<?> clientArchive=deploymentProvider.getClientDeployment(CLIENT_MODULE_NAME);
    String clientDeploymentName=archiveDeployer.deploy(clientArchive);
    assertNotNull("Deployment name not null",clientDeploymentName);
    try {
      ServiceName clientService=ServiceName.parse("jboss.osgi.example.invoker.service");
      assertServiceState(clientService,State.UP,5000);
    }
  finally {
      archiveDeployer.undeploy(clientDeploymentName);
    }
  }
  finally {
    archiveDeployer.undeploy(targetDeploymentName);
  }
}
