{
  final ClassLoader oldTCCL=SecurityActions.getThreadContextClassLoader();
  try {
    SecurityActions.setThreadContextClassLoader(classLoader);
    if (configuration == null) {
      ConstraintMapping mapping=new ConstraintMapping();
      HibernateValidatorConfiguration config=Validation.byProvider(HibernateValidator.class).providerResolver(new JBossProviderResolver()).configure();
      config.addMapping(mapping);
      ValidatorFactory factory=config.buildValidatorFactory();
      return factory;
    }
 else {
      return configuration.buildValidatorFactory();
    }
  }
  finally {
    SecurityActions.setThreadContextClassLoader(oldTCCL);
  }
}
