{
  Set<String> hosts=getHosts(hostUtils[0]);
  Assert.assertTrue(hosts.contains(HOSTS[0]));
  Assert.assertTrue(hosts.contains(HOSTS[1]));
  Assert.assertTrue(hosts.contains(HOSTS[2]));
  log.info("Stopping the domain controller on failover-h1.");
  hostUtils[0].stop();
  log.info("Domain controller on failover-h1 stopped.");
  hosts=getHosts(hostUtils[1]);
  Assert.assertTrue(hosts.contains(HOSTS[1]));
  Assert.assertEquals(hosts.size(),1);
  ModelNode becomeMasterOp=new ModelNode();
  becomeMasterOp.get(ModelDescriptionConstants.ADDRESS).add(ModelDescriptionConstants.HOST,"failover-h2");
  becomeMasterOp.get(ModelDescriptionConstants.OP).set("write-local-domain-controller");
  hostUtils[1].executeForResult(becomeMasterOp);
  ModelNode restartOp=new ModelNode();
  restartOp.get(ModelDescriptionConstants.ADDRESS).add(ModelDescriptionConstants.HOST,"failover-h2");
  restartOp.get(ModelDescriptionConstants.OP).set("reload");
  restartOp.get(ModelDescriptionConstants.RESTART_SERVERS).set(false);
  log.info("Reloading failover-h2 to act as the domain controller.");
  hostUtils[1].executeAwaitConnectionClosed(restartOp);
  waitUntilHostControllerReady(hostUtils[1]);
  ModelNode changeMasterOp=new ModelNode();
  changeMasterOp.get(ModelDescriptionConstants.ADDRESS).add(ModelDescriptionConstants.HOST,HOSTS[2]);
  changeMasterOp.get(ModelDescriptionConstants.OP).set("write-remote-domain-controller");
  changeMasterOp.get(ModelDescriptionConstants.HOST).set("${jboss.test.host.slave.address}");
  changeMasterOp.get(ModelDescriptionConstants.PORT).set(MGMT_PORTS[1]);
  changeMasterOp.get(ModelDescriptionConstants.SECURITY_REALM).set("ManagementRealm");
  hostUtils[2].executeForResult(changeMasterOp);
  restartOp=new ModelNode();
  restartOp.get(ModelDescriptionConstants.ADDRESS).add(ModelDescriptionConstants.HOST,HOSTS[2]);
  restartOp.get(ModelDescriptionConstants.OP).set("reload");
  restartOp.get(ModelDescriptionConstants.RESTART_SERVERS).set(false);
  log.info("Reloading failover-h3 to register to new domain controller.");
  hostUtils[2].executeAwaitConnectionClosed(restartOp);
  waitUntilHostControllerReady(hostUtils[2]);
  Operation deployOp=buildDeployOperation();
  hostUtils[1].executeForResult(deployOp);
  hosts=getHosts(hostUtils[1]);
  Assert.assertTrue(hosts.contains(HOSTS[1]));
  Assert.assertTrue(hosts.contains(HOSTS[2]));
  Assert.assertEquals(hosts.size(),2);
  String testUrl=new URL("http",slaveAddress,8080 + SERVER_PORT_OFFSETS[2],"/SimpleServlet/SimpleServlet").toString();
  Assert.assertTrue(WebUtil.testHttpURL(testUrl));
  ModelNode stopOp=new ModelNode();
  stopOp.get(ModelDescriptionConstants.ADDRESS).add(ModelDescriptionConstants.HOST,HOSTS[2]);
  stopOp.get(ModelDescriptionConstants.ADDRESS).add(ModelDescriptionConstants.SERVER_CONFIG,SERVERS[2]);
  stopOp.get(ModelDescriptionConstants.OP).set(ModelDescriptionConstants.STOP);
  hostUtils[1].executeForResult(stopOp);
  DomainTestUtils.waitUntilState(hostUtils[1].getDomainClient(),HOSTS[2],SERVERS[2],"STOPPED");
  Assert.assertFalse(WebUtil.testHttpURL(testUrl));
}
