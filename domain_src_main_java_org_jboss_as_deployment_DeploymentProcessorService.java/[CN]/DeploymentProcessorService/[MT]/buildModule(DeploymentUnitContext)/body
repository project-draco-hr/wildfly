{
  final ModuleConfig moduleConfig=deploymentUnitContext.getAttachment(ModuleConfig.ATTACHMENT_KEY);
  if (moduleConfig == null)   return null;
  final ModuleSpec.Builder specBuilder=ModuleSpec.build(moduleConfig.getIdentifier());
  for (  ModuleConfig.ResourceRoot resource : moduleConfig.getResources()) {
    specBuilder.addRoot(resource.getRootName(),new VFSResourceLoader(specBuilder.getIdentifier(),resource.getRoot()));
  }
  final ModuleConfig.Dependency[] dependencies=moduleConfig.getDependencies();
  for (  ModuleConfig.Dependency dependency : dependencies) {
    specBuilder.addDependency(dependency.getIdentifier()).setExport(dependency.isExport()).setOptional(dependency.isOptional());
  }
  final ModuleSpec moduleSpec=specBuilder.create();
  return moduleLoader.loadModule(moduleConfig.getIdentifier());
}
