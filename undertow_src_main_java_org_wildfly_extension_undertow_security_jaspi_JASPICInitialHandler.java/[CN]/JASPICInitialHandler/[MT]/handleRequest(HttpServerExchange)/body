{
  final ServletRequestContext requestContext=exchange.getAttachment(ServletRequestContext.ATTACHMENT_KEY);
  final JASPIServerAuthenticationManager sam=createJASPIAuthenticationManager();
  final GenericMessageInfo messageInfo=createMessageInfo(exchange,exchange.getSecurityContext());
  final String applicationIdentifier=buildApplicationIdentifier(requestContext);
  final JASPICallbackHandler cbh=new JASPICallbackHandler();
  UndertowLogger.ROOT_LOGGER.debugf("validateRequest for layer [%s] and applicationContextIdentifier [%s]",JASPI_HTTP_SERVLET_LAYER,applicationIdentifier);
  Account cachedAccount=null;
  final JASPICSecurityContext jaspicSecurityContext=(JASPICSecurityContext)exchange.getSecurityContext();
  final AuthenticatedSessionManager sessionManager=exchange.getAttachment(AuthenticatedSessionManager.ATTACHMENT_KEY);
  if (sessionManager != null) {
    AuthenticatedSessionManager.AuthenticatedSession authSession=sessionManager.lookupSession(exchange);
    if (authSession != null) {
      cachedAccount=authSession.getAccount();
      if (cachedAccount != null) {
        jaspicSecurityContext.setCachedAuthenticatedAccount(cachedAccount);
      }
    }
  }
  boolean isValid=sam.isValid(messageInfo,new Subject(),JASPI_HTTP_SERVLET_LAYER,applicationIdentifier,cbh);
  jaspicSecurityContext.setCachedAuthenticatedAccount(null);
  exchange.putAttachment(JASPICAttachment.ATTACHMENT_KEY,new JASPICAttachment(isValid,requestContext,sam,messageInfo,applicationIdentifier,cbh,cachedAccount));
  ServletRequestContext servletRequestContext=exchange.getAttachment(ServletRequestContext.ATTACHMENT_KEY);
  servletRequestContext.setServletRequest((HttpServletRequest)messageInfo.getRequestMessage());
  servletRequestContext.setServletResponse((HttpServletResponse)messageInfo.getResponseMessage());
  secureResponse(exchange,sam,messageInfo,cbh);
  next.handleRequest(exchange);
}
