{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
  if (!JaxrsDeploymentMarker.isJaxrsDeployment(deploymentUnit)) {
    return;
  }
  final WarMetaData warMetaData=deploymentUnit.getAttachment(WarMetaData.ATTACHMENT_KEY);
  final JBossWebMetaData webdata=warMetaData.getMergedJBossWebMetaData();
  final ResteasyDeploymentData resteasy=deploymentUnit.getAttachment(JaxrsAttachments.RESTEASY_DEPLOYMENT_DATA);
  if (resteasy == null)   return;
  if (!resteasy.getScannedResourceClasses().isEmpty()) {
    StringBuffer buf=null;
    for (    String resource : resteasy.getScannedResourceClasses()) {
      if (buf == null) {
        buf=new StringBuffer();
        buf.append(resource);
      }
 else {
        buf.append(",").append(resource);
      }
    }
    String resources=buf.toString();
    log.debug("Adding JAX-RS resource classes: " + resources);
    setContextParameter(webdata,ResteasyContextParameters.RESTEASY_SCANNED_RESOURCES,resources);
  }
  if (!resteasy.getScannedProviderClasses().isEmpty()) {
    StringBuffer buf=null;
    for (    String provider : resteasy.getScannedProviderClasses()) {
      if (buf == null) {
        buf=new StringBuffer();
        buf.append(provider);
      }
 else {
        buf.append(",").append(provider);
      }
    }
    String providers=buf.toString();
    log.debug("Adding JAX-RS provider classes: " + providers);
    setContextParameter(webdata,ResteasyContextParameters.RESTEASY_SCANNED_PROVIDERS,providers);
  }
  if (!resteasy.getScannedJndiComponentResources().isEmpty()) {
    StringBuffer buf=null;
    for (    String resource : resteasy.getScannedJndiComponentResources()) {
      if (buf == null) {
        buf=new StringBuffer();
        buf.append(resource);
      }
 else {
        buf.append(",").append(resource);
      }
    }
    String providers=buf.toString();
    log.debug("Adding JAX-RS jndi component resource classes: " + providers);
    setContextParameter(webdata,ResteasyContextParameters.RESTEASY_SCANNED_JNDI_RESOURCES,providers);
  }
  try {
    module.getClassLoader().loadClass(CDI_INJECTOR_FACTORY_CLASS);
    if (WeldDeploymentMarker.isPartOfWeldDeployment(deploymentUnit)) {
      log.debug("Found CDI, adding injector factory class");
      setContextParameter(webdata,"resteasy.injector.factory",CDI_INJECTOR_FACTORY_CLASS);
      final DeploymentUnit parent=deploymentUnit.getParent() == null ? deploymentUnit : deploymentUnit.getParent();
synchronized (parent) {
        boolean found=false;
        final List<Metadata<Extension>> extensions=parent.getAttachmentList(WeldAttachments.PORTABLE_EXTENSIONS);
        for (        Metadata<Extension> extension : extensions) {
          if (extension.getValue() instanceof ResteasyCdiExtension) {
            found=true;
            break;
          }
        }
        if (!found) {
          final ClassLoader classLoader=SecurityActions.getContextClassLoader();
          try {
            SecurityActions.setContextClassLoader(ResteasyCdiExtension.class.getClassLoader());
            final ResteasyCdiExtension ext=new ResteasyCdiExtension();
            Metadata<Extension> metadata=new Metadata<Extension>(){
              @Override public Extension getValue(){
                return ext;
              }
              @Override public String getLocation(){
                return "org.jboss.as.jaxrs.JaxrsExtension";
              }
            }
;
            parent.addToAttachmentList(WeldAttachments.PORTABLE_EXTENSIONS,metadata);
          }
  finally {
            SecurityActions.setContextClassLoader(classLoader);
          }
        }
      }
    }
  }
 catch (  ClassNotFoundException ignored) {
  }
  if (!resteasy.isUnwrappedExceptionsParameterSet()) {
    setContextParameter(webdata,ResteasyContextParameters.RESTEASY_UNWRAPPED_EXCEPTIONS,"javax.ejb.EJBException");
  }
  if (resteasy.hasBootClasses() || resteasy.isDispatcherCreated())   return;
  if (resteasy.getScannedApplicationClass() == null && resteasy.getScannedJndiComponentResources().isEmpty() && resteasy.getScannedProviderClasses().isEmpty() && resteasy.getScannedResourceClasses().isEmpty())   return;
  boolean useScannedClass=false;
  String servletName;
  if (resteasy.getScannedApplicationClass() == null) {
    JBossServletMetaData servlet=new JBossServletMetaData();
    servlet.setName(JAX_RS_SERVLET_NAME);
    servlet.setServletClass(HttpServlet30Dispatcher.class.getName());
    addServlet(webdata,servlet);
    servletName=JAX_RS_SERVLET_NAME;
  }
 else {
    ParamValueMetaData param=findInitParam(webdata,SERVLET_INIT_PARAM);
    if (param != null) {
      servletName=param.getParamValue();
      setContextParameter(webdata,"javax.ws.rs.Application",servletName);
    }
 else {
      ParamValueMetaData contextParam=findContextParam(webdata,"javax.ws.rs.Application");
      if (contextParam == null) {
        setContextParameter(webdata,"javax.ws.rs.Application",resteasy.getScannedApplicationClass().getName());
        useScannedClass=true;
        servletName=resteasy.getScannedApplicationClass().getName();
      }
 else {
        servletName=contextParam.getParamValue();
      }
    }
  }
  boolean mappingSet=false;
  if (useScannedClass) {
    JBossServletMetaData servlet=new JBossServletMetaData();
    servlet.setName(servletName);
    servlet.setServletClass(HttpServlet30Dispatcher.class.getName());
    addServlet(webdata,servlet);
    if (!servletMappingsExist(webdata,servletName)) {
      List<String> patterns=new ArrayList<String>();
      if (resteasy.getScannedApplicationClass().isAnnotationPresent(ApplicationPath.class)) {
        ApplicationPath path=resteasy.getScannedApplicationClass().getAnnotation(ApplicationPath.class);
        String pathValue=path.value().trim();
        if (!pathValue.startsWith("/")) {
          pathValue="/" + pathValue;
        }
        String prefix=pathValue;
        if (pathValue.endsWith("/")) {
          pathValue+="*";
        }
 else {
          pathValue+="/*";
        }
        patterns.add(pathValue);
        setContextParameter(webdata,"resteasy.servlet.mapping.prefix",prefix);
        mappingSet=true;
      }
 else {
        throw new DeploymentUnitProcessingException("No Servlet mappings found for JAX-RS application: " + servletName + " either annotate it with @ApplicationPath or add a servlet-mapping in web.xml");
      }
      ServletMappingMetaData mapping=new ServletMappingMetaData();
      mapping.setServletName(servletName);
      mapping.setUrlPatterns(patterns);
      if (webdata.getServletMappings() == null) {
        webdata.setServletMappings(new ArrayList<ServletMappingMetaData>());
      }
      webdata.getServletMappings().add(mapping);
    }
  }
  if (!mappingSet) {
    final List<ServletMappingMetaData> mappings=webdata.getServletMappings();
    if (mappings != null) {
      for (      final ServletMappingMetaData mapping : mappings) {
        if (mapping.getServletName().equals(servletName)) {
          if (mapping.getUrlPatterns() != null) {
            for (            String pattern : mapping.getUrlPatterns()) {
              if (mappingSet) {
                log.errorf("More than one mapping found for JAX-RS servlet: %s the second mapping %s will not work",servletName,pattern);
              }
 else {
                mappingSet=true;
                String realPattern=pattern;
                if (realPattern.endsWith("*")) {
                  realPattern=realPattern.substring(0,realPattern.length() - 1);
                }
                setContextParameter(webdata,"resteasy.servlet.mapping.prefix",realPattern);
              }
            }
          }
        }
      }
    }
  }
}
