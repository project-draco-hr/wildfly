{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Module module=deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE);
  if (module == null) {
    return;
  }
  final EJBClientContext ejbClientContext=this.getEJBClientContext(phaseContext);
  final ServiceController<TCCLEJBClientContextSelectorService> tcclEJBClientContextSelectorServiceController=(ServiceController<TCCLEJBClientContextSelectorService>)phaseContext.getServiceRegistry().getService(TCCLEJBClientContextSelectorService.TCCL_BASED_EJB_CLIENT_CONTEXT_SELECTOR_SERVICE_NAME);
  if (tcclEJBClientContextSelectorServiceController != null) {
    final TCCLEJBClientContextSelectorService tcclBasedEJBClientContextSelector=tcclEJBClientContextSelectorServiceController.getValue();
    logger.debug("Registering EJB client context " + ejbClientContext + " for classloader "+ module.getClassLoader());
    tcclBasedEJBClientContextSelector.registerEJBClientContext(ejbClientContext,module.getClassLoader());
  }
  final EEModuleDescription moduleDescription=deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
  if (moduleDescription == null) {
    return;
  }
  final ServiceName clientContextService=getEJBClientContextServiceName(phaseContext);
  for (  final ComponentDescription component : moduleDescription.getComponentDescriptions()) {
    component.addDependency(clientContextService,ServiceBuilder.DependencyType.REQUIRED);
  }
}
