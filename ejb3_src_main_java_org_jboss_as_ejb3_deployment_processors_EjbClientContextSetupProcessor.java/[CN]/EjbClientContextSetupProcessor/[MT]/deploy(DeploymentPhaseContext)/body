{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Module module=deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE);
  if (module == null) {
    return;
  }
  final EJBClientContext context=deploymentUnit.getAttachment(EjbDeploymentAttachmentKeys.EJB_CLIENT_CONTEXT);
  final ServiceController<TCCLBasedEJBClientContextSelector> tcclEJBClientContextSelectorServiceController=(ServiceController<TCCLBasedEJBClientContextSelector>)phaseContext.getServiceRegistry().getService(TCCLBasedEJBClientContextSelector.TCCL_BASED_EJB_CLIENT_CONTEXT_SELECTOR_SERVICE_NAME);
  if (tcclEJBClientContextSelectorServiceController != null) {
    final TCCLBasedEJBClientContextSelector tcclBasedEJBClientContextSelector=tcclEJBClientContextSelectorServiceController.getValue();
    tcclBasedEJBClientContextSelector.registerEJBClientContext(context,module.getClassLoader());
  }
  final EjbClientContextSetupAction setupAction=new EjbClientContextSetupAction(context);
  deploymentUnit.addToAttachmentList(Attachments.SETUP_ACTIONS,setupAction);
  deploymentUnit.addToAttachmentList(org.jboss.as.ee.component.Attachments.EE_SETUP_ACTIONS,setupAction);
}
