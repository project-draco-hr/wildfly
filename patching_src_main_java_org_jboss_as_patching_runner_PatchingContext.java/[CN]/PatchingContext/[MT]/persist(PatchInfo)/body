{
  final String cumulativeID=newPatchInfo.getCumulativeID();
  final DirectoryStructure environment=structure;
  final File cumulative=environment.getCumulativeLink();
  final File cumulativeRefs=environment.getCumulativeRefs(cumulativeID);
  if (!cumulative.exists()) {
    final File metadata=environment.getPatchesMetadata();
    if (!metadata.exists() && !metadata.mkdirs()) {
      throw PatchMessages.MESSAGES.cannotCreateDirectory(metadata.getAbsolutePath());
    }
  }
  if (!cumulativeRefs.exists()) {
    final File references=cumulativeRefs.getParentFile();
    if (!references.exists() && !references.mkdirs()) {
      throw PatchMessages.MESSAGES.cannotCreateDirectory(references.getAbsolutePath());
    }
  }
  PatchUtils.writeRef(cumulative,cumulativeID);
  PatchUtils.writeRefs(cumulativeRefs,newPatchInfo.getPatchIDs());
  return newPatchInfo;
}
