{
  PathAddress stackAddress=PathAddress.pathAddress(operation.get(OP_ADDR));
  String stackName=stackAddress.getLastElement().getValue();
  ServiceName serviceName=ChannelFactoryService.getServiceName(stackName);
  Channel channel=null;
  try {
    ServiceController<?> controller=context.getServiceRegistry(false).getRequiredService(serviceName);
    ChannelFactory factory=ServiceContainerHelper.getValue(controller,ChannelFactory.class);
    channel=factory.createChannel(UUID.randomUUID().toString());
    List<Protocol> protocols=channel.getProtocolStack().getProtocols();
    Collections.reverse(protocols);
    ProtocolStack stack=new ProtocolStack();
    stack.addProtocols(protocols);
    context.getResult().set(stack.printProtocolSpecAsXML());
    context.completeStep();
  }
 catch (  Exception e) {
    throw new OperationFailedException(e.getLocalizedMessage(),e);
  }
 finally {
    if (channel != null) {
      channel.close();
    }
  }
}
