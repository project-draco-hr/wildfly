{
  PathAddress stackAddress=PathAddress.pathAddress(operation.get(OP_ADDR));
  String stackName=stackAddress.getLastElement().getValue();
  ServiceRegistry registry=context.getServiceRegistry(false);
  ServiceName serviceName=ChannelFactoryService.getServiceName(stackName);
  try {
    ServiceController<?> controller=registry.getRequiredService(serviceName);
    controller.setMode(ServiceController.Mode.ACTIVE);
    try {
      ChannelFactory factory=ServiceContainerHelper.getValue(controller,ChannelFactory.class);
      Channel channel=factory.createChannel(UUID.randomUUID().toString());
      try {
        List<Protocol> protocols=channel.getProtocolStack().getProtocols();
        Collections.reverse(protocols);
        ProtocolStack stack=new ProtocolStack();
        stack.addProtocols(protocols);
        context.getResult().set(stack.printProtocolSpecAsXML());
        context.completeStep(OperationContext.RollbackHandler.NOOP_ROLLBACK_HANDLER);
      }
  finally {
        channel.close();
      }
    }
  finally {
      controller.setMode(ServiceController.Mode.ON_DEMAND);
    }
  }
 catch (  Exception e) {
    throw new OperationFailedException(e.getLocalizedMessage(),e);
  }
}
