{
  exchange.setResponseCode(status);
  final HeaderMap responseHeaders=exchange.getResponseHeaders();
  final String contentType=operationParameter.isEncode() ? Common.APPLICATION_DMR_ENCODED : Common.APPLICATION_JSON;
  responseHeaders.put(Headers.CONTENT_TYPE,contentType + ";" + Common.UTF_8);
  writeCacheHeaders(exchange,status,operationParameter);
  if (operationParameter.isGet() && status == 200) {
    response=response.get(RESULT);
    try {
      int length=getResponseLength(response,operationParameter);
      responseHeaders.put(Headers.CONTENT_LENGTH,length);
    }
 catch (    IOException e) {
      ROOT_LOGGER.errorf(e,"Unable to get length for '%s'",operationParameter);
    }
  }
  OutputStream out=new ChannelOutputStream(exchange.getResponseChannel());
  PrintWriter print=new PrintWriter(out);
  try {
    try {
      if (operationParameter.isEncode()) {
        response.writeBase64(out);
      }
 else {
        response.writeJSONString(print,!operationParameter.isPretty());
      }
    }
  finally {
      print.flush();
      try {
        out.flush();
      }
  finally {
        IoUtils.safeClose(print);
        IoUtils.safeClose(out);
      }
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
