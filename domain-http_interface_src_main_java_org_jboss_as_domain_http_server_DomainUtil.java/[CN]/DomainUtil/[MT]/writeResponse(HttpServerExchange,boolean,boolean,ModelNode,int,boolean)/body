{
  final String contentType=encode ? Common.APPLICATION_DMR_ENCODED : Common.APPLICATION_JSON;
  exchange.getResponseHeaders().put(Headers.CONTENT_TYPE,contentType + ";" + Common.UTF_8);
  exchange.setResponseCode(status);
  if (isGet && status == 200) {
    response=response.get(RESULT);
  }
  OutputStream out=new ChannelOutputStream(exchange.getResponseChannel());
  PrintWriter print=new PrintWriter(out);
  try {
    try {
      if (encode) {
        response.writeBase64(out);
      }
 else {
        response.writeJSONString(print,!pretty);
      }
    }
  finally {
      print.flush();
      try {
        out.flush();
      }
  finally {
        IoUtils.safeClose(print);
        IoUtils.safeClose(out);
      }
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
