{
  DigestContext context=getOrCreateNegotiationContext(httpExchange);
  if (context.isAuthenticated()) {
    return new Authenticator.Success(context.getPrincipal());
  }
  Headers requestHeaders=httpExchange.getRequestHeaders();
  if (requestHeaders.containsKey(AUTHORIZATION_HEADER) == false) {
    Headers responseHeaders=httpExchange.getResponseHeaders();
    responseHeaders.add(WWW_AUTHENTICATE_HEADER,CHALLENGE + " " + createChallenge(context,false));
    return new Authenticator.Retry(UNAUTHORIZED);
  }
  String authorizationHeader=requestHeaders.getFirst(AUTHORIZATION_HEADER);
  if (authorizationHeader.startsWith(CHALLENGE + " ") == false) {
    throw MESSAGES.invalidAuthorizationHeader();
  }
  String challenge=authorizationHeader.substring(CHALLENGE.length() + 1);
  Map<String,String> challengeParameters=parseDigestChallenge(challenge);
  HttpPrincipal principal=validateUser(httpExchange,challengeParameters);
  if (principal == null) {
    if (challengeParameters.containsKey(NONCE)) {
      context.useNonce(challengeParameters.get(NONCE));
    }
    Headers responseHeaders=httpExchange.getResponseHeaders();
    responseHeaders.add(WWW_AUTHENTICATE_HEADER,CHALLENGE + " " + createChallenge(context,false));
    return new Authenticator.Retry(UNAUTHORIZED);
  }
  if (context.useNonce(challengeParameters.get(NONCE))) {
    context.principal=principal;
    return new Authenticator.Success(principal);
  }
  Headers responseHeaders=httpExchange.getResponseHeaders();
  responseHeaders.add(WWW_AUTHENTICATE_HEADER,CHALLENGE + " " + createChallenge(context,true));
  return new Authenticator.Retry(UNAUTHORIZED);
}
