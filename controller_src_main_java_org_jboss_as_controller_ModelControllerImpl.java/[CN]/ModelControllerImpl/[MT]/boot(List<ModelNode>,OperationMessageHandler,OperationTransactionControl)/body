{
  final OperationContextImpl context=new OperationContextImpl(this,controllerType,EnumSet.noneOf(OperationContextImpl.ContextFlag.class),handler,null,model,control,processState,bootingFlag.get());
  final ModelNode result=new ModelNode().setEmptyList();
  result.setEmptyList();
  boolean sawExtensionAdd=false;
  List<ParsedOp> postExtensionOps=null;
  ParallelBootOperationStepHandler parallelSubsystemHandler=controllerType == OperationContext.Type.SERVER ? new ParallelBootOperationStepHandler(rootRegistration,processState,result) : null;
  boolean registeredParallelHandler=false;
  for (  ModelNode bootOp : bootList) {
    final ParsedOp parsedOp=new ParsedOp(bootOp,result.add());
    if (postExtensionOps != null) {
      if (parsedOp.isExtensionAdd()) {
        final OperationStepHandler stepHandler=rootRegistration.getOperationHandler(parsedOp.address,parsedOp.operationName);
        context.addStep(result.add(),bootOp,stepHandler,OperationContext.Stage.MODEL);
      }
 else {
        if (parallelSubsystemHandler == null || !parallelSubsystemHandler.addSubsystemOperation(parsedOp)) {
          postExtensionOps.add(parsedOp);
        }
 else         if (!registeredParallelHandler) {
          ModelNode op=Util.getEmptyOperation("parallel-subsystem-boot",new ModelNode().setEmptyList());
          postExtensionOps.add(new ParsedOp(op,parallelSubsystemHandler,result.add()));
          registeredParallelHandler=true;
        }
      }
    }
 else {
      final OperationStepHandler stepHandler=rootRegistration.getOperationHandler(parsedOp.address,parsedOp.operationName);
      if (!sawExtensionAdd && stepHandler == null) {
        String msg=String.format("No handler for operation %s at address %s",parsedOp.operationName,parsedOp.address);
        log.error(msg);
        context.setRollbackOnly();
        break;
      }
 else       if (stepHandler instanceof ExtensionAddHandler) {
        context.addStep(parsedOp.response,bootOp,stepHandler,OperationContext.Stage.MODEL);
        sawExtensionAdd=true;
      }
 else       if (!sawExtensionAdd) {
        context.addStep(result.add(),bootOp,stepHandler,OperationContext.Stage.MODEL);
      }
 else {
        postExtensionOps=new ArrayList<ParsedOp>();
        if (parallelSubsystemHandler == null || !parallelSubsystemHandler.addSubsystemOperation(parsedOp)) {
          postExtensionOps.add(parsedOp);
        }
 else         if (!registeredParallelHandler) {
          ModelNode op=Util.getEmptyOperation("parallel-subsystem-boot",new ModelNode().setEmptyList());
          postExtensionOps.add(new ParsedOp(op,parallelSubsystemHandler,result.add()));
          registeredParallelHandler=true;
        }
      }
    }
  }
  if (context.completeStep() == OperationContext.ResultAction.KEEP && postExtensionOps != null) {
    final OperationContextImpl postExtContext=new OperationContextImpl(this,controllerType,EnumSet.noneOf(OperationContextImpl.ContextFlag.class),handler,null,model,control,processState,bootingFlag.get());
    for (    ParsedOp parsedOp : postExtensionOps) {
      final OperationStepHandler stepHandler=parsedOp.handler == null ? rootRegistration.getOperationHandler(parsedOp.address,parsedOp.operationName) : parsedOp.handler;
      if (stepHandler == null) {
        String msg=String.format("No handler for operation %s at address %s",parsedOp.operationName,parsedOp.address);
        log.error(msg);
        postExtContext.setRollbackOnly();
        break;
      }
 else {
        postExtContext.addStep(parsedOp.response,parsedOp.operation,stepHandler,OperationContext.Stage.MODEL);
      }
    }
    postExtContext.completeStep();
  }
}
