{
  if (deploymentUnit.getParent() == null) {
    final List<DeploymentUnit> subDeployments=deploymentUnit.getAttachmentList(org.jboss.as.server.deployment.Attachments.SUB_DEPLOYMENTS);
    for (    final DeploymentUnit sub : subDeployments) {
      final ModuleIdentifier identifier=sub.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_IDENTIFIER);
      if (identifier != null) {
        modules.put(identifier,sub);
      }
    }
  }
 else {
    final DeploymentUnit parent=deploymentUnit.getParent();
    final List<DeploymentUnit> subDeployments=parent.getAttachmentList(org.jboss.as.server.deployment.Attachments.SUB_DEPLOYMENTS);
    final ModuleIdentifier parentIdentifier=parent.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_IDENTIFIER);
    if (parentIdentifier != null) {
      modules.put(parentIdentifier,parent);
    }
    for (    final DeploymentUnit sub : subDeployments) {
      if (sub != deploymentUnit) {
        final ModuleIdentifier identifier=sub.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_IDENTIFIER);
        if (identifier != null) {
          modules.put(identifier,sub);
        }
      }
    }
  }
}
