{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final ModuleSpecification moduleSpec=deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE_SPECIFICATION);
  final Map<ModuleIdentifier,DeploymentUnit> deployments=new HashMap<ModuleIdentifier,DeploymentUnit>();
  deploymentUnit.addToAttachmentList(Attachments.ACCESSIBLE_SUB_DEPLOYMENTS,deploymentUnit);
  buildModuleMap(deploymentUnit,deployments);
  for (  final ModuleDependency dependency : moduleSpec.getAllDependencies()) {
    final DeploymentUnit sub=deployments.get(dependency.getIdentifier());
    if (sub != null) {
      deploymentUnit.addToAttachmentList(Attachments.ACCESSIBLE_SUB_DEPLOYMENTS,sub);
    }
  }
}
