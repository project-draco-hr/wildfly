{
  return new ParsingStateCallbackHandler(){
    private int nameValueSeparator=-1;
    private String name;
    final StringBuilder buffer=new StringBuilder();
    @Override public void enteredState(    ParsingContext ctx) throws OperationFormatException {
      final String id=ctx.getState().getId();
      if (id.equals(CommandNameState.ID)) {
        handler.addressOperationSeparator(ctx.getLocation());
      }
 else       if (id.equals(PropertyListState.ID)) {
        handler.propertyListStart(ctx.getLocation());
      }
 else       if (ArgumentValueState.ID.equals(id)) {
        if (buffer.length() > 0) {
          name=buffer.toString().trim();
          buffer.setLength(0);
          nameValueSeparator=ctx.getLocation();
        }
      }
    }
    @Override public void leavingState(    ParsingContext ctx) throws CommandFormatException {
      final String id=ctx.getState().getId();
      if (id.equals(PropertyListState.ID)) {
        if (!ctx.isEndOfContent()) {
          handler.propertyListEnd(ctx.getLocation());
        }
      }
 else       if (ArgumentState.ID.equals(id)) {
        if (this.name != null) {
          final String value=buffer.toString().trim();
          if (value.length() > 0) {
            handler.property(this.name,value,nameValueSeparator);
          }
 else {
            handler.propertyName(this.name);
            if (nameValueSeparator != -1) {
              handler.propertyNameValueSeparator(nameValueSeparator);
            }
          }
        }
 else {
          handler.propertyName(buffer.toString().trim());
          if (nameValueSeparator != -1) {
            handler.propertyNameValueSeparator(nameValueSeparator);
          }
        }
        if (!ctx.isEndOfContent()) {
          handler.propertySeparator(ctx.getLocation());
        }
        buffer.setLength(0);
        name=null;
        nameValueSeparator=-1;
      }
 else       if (ArgumentValueState.ID.equals(id)) {
        if (name == null) {
          handler.property(null,buffer.toString().trim(),-1);
          buffer.setLength(0);
          if (!ctx.isEndOfContent()) {
            handler.propertySeparator(ctx.getLocation());
          }
        }
      }
 else       if (CommandNameState.ID.equals(id)) {
        handler.operationName(buffer.toString().trim());
        buffer.setLength(0);
      }
 else       if (NodeState.ID.equals(id)) {
        char ch=ctx.getCharacter();
        if (buffer.length() == 0) {
          if (ch == '/') {
            handler.rootNode();
            handler.nodeSeparator(ctx.getLocation());
          }
        }
 else {
          if (ch == '=') {
            handler.nodeType(buffer.toString().trim());
            handler.nodeTypeNameSeparator(ctx.getLocation());
          }
 else           if (ch == ':') {
            handler.nodeName(buffer.toString().trim());
          }
 else {
            final String value=buffer.toString().trim();
            if (".".equals(value)) {
            }
 else             if ("..".equals(value)) {
              handler.parentNode();
            }
 else             if (".type".equals(value)) {
              handler.nodeType();
            }
 else {
              if (ch == '/') {
                if ("".equals(value)) {
                  handler.rootNode();
                }
 else {
                  handler.nodeName(value);
                }
              }
 else {
                handler.nodeTypeOrName(value);
              }
            }
            if (ch == '/') {
              handler.nodeSeparator(ctx.getLocation());
            }
          }
        }
        buffer.setLength(0);
      }
 else       if (OutputTargetState.ID.equals(id)) {
        handler.outputTarget(buffer.toString().trim());
        buffer.setLength(0);
      }
    }
    @Override public void character(    ParsingContext ctx) throws OperationFormatException {
      buffer.append(ctx.getCharacter());
    }
  }
;
}
