{
  if (logConfigurator != null)   logConfigurator.run();
  log.infof("Starting server \"%s\"",serverName);
  final ServiceContainer container=ServiceContainer.Factory.create();
  final ServerStartupListener serverStartupListener=new ServerStartupListener(createListenerCallback());
  final BatchBuilder bootBatchBuilder=container.batchBuilder();
  bootBatchBuilder.addListener(serverStartupListener);
  final ServiceActivatorContext serviceActivatorContext=new ServiceActivatorContext(){
    public BatchBuilder getBatchBuilder(){
      return bootBatchBuilder;
    }
  }
;
  final BatchServiceBuilder<Void> builder=bootBatchBuilder.addService(ServiceName.JBOSS.append("as","server"),Service.NULL);
  builder.setInitialMode(ServiceController.Mode.IMMEDIATE);
  for (  ServiceActivator service : this.startServices) {
    service.activate(serviceActivatorContext);
  }
  for (  ServiceActivator service : startServices) {
    service.activate(serviceActivatorContext);
  }
  try {
    bootBatchBuilder.install();
  }
 catch (  ServiceRegistryException e) {
    throw new IllegalStateException("Failed to install boot services",e);
  }
  final BatchBuilder batchBuilder=container.batchBuilder();
  batchBuilder.addListener(serverStartupListener);
  final ServerModel serverModel=new ServerModel(serverName,portOffset);
  final Properties systemProperties=System.getProperties();
  final ServerEnvironment environment=new ServerEnvironment(systemProperties,serverName,false);
  log.info("Activating core services");
  ServerEnvironmentService.addService(environment,batchBuilder);
  ServerDeploymentRepositoryImpl.addService(batchBuilder);
  ShutdownHandlerImpl.addService(batchBuilder);
  ServerModelService.addService(serverModel,batchBuilder);
  ServerDeploymentManagerImpl.addService(serverModel,container,batchBuilder);
  ServerConfigurationPersisterImpl.addService(serverModel,batchBuilder);
  batchBuilder.addService(SocketBindingManager.SOCKET_BINDING_MANAGER,new SocketBindingManagerService(portOffset)).setInitialMode(ServiceController.Mode.ON_DEMAND);
  batchBuilder.addService(ClassifyingModuleLoaderService.SERVICE_NAME,new ClassifyingModuleLoaderService());
  final DeploymentModuleLoaderService deploymentModuleLoaderService=new DeploymentModuleLoaderService(new DeploymentModuleLoaderImpl());
  batchBuilder.addService(DeploymentModuleLoaderService.SERVICE_NAME,deploymentModuleLoaderService).addDependency(ClassifyingModuleLoaderService.SERVICE_NAME,ClassifyingModuleLoaderService.class,new ClassifyingModuleLoaderInjector("deployment",deploymentModuleLoaderService));
  new JarDeploymentActivator().activate(new ServiceActivatorContext(){
    public BatchBuilder getBatchBuilder(){
      return batchBuilder;
    }
  }
);
  for (  AbstractServerModelUpdate<?> update : updates) {
    try {
      serverModel.update(update);
    }
 catch (    UpdateFailedException e) {
      throw new IllegalStateException("Failed to start server",e);
    }
  }
  try {
    batchBuilder.install();
  }
 catch (  ServiceRegistryException e) {
    throw new IllegalStateException("Failed to start server",e);
  }
  final BatchBuilder updatesBatchBuilder=container.batchBuilder();
  updatesBatchBuilder.addListener(serverStartupListener);
  final UpdateContext context=new UpdateContext(){
    public BatchBuilder getBatchBuilder(){
      return updatesBatchBuilder;
    }
    public ServiceContainer getServiceContainer(){
      return container;
    }
  }
;
  for (  AbstractServerModelUpdate<?> update : updates) {
    update.applyUpdateBootAction(context);
  }
  try {
    serverStartupListener.finish();
    updatesBatchBuilder.install();
  }
 catch (  ServiceRegistryException e) {
    throw new IllegalStateException("Failed to install boot services",e);
  }
}
