{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final EEModuleDescription moduleDescription=deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);
  final Module module=deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.MODULE);
  final DeploymentClassIndex classIndex=deploymentUnit.getAttachment(org.jboss.as.server.deployment.Attachments.CLASS_INDEX);
  if (moduleDescription == null) {
    return;
  }
  if (module == null) {
    return;
  }
  final Set<ServiceName> failed=new HashSet<ServiceName>();
  final EEModuleConfiguration moduleConfiguration=new EEModuleConfiguration(moduleDescription);
  deploymentUnit.putAttachment(Attachments.EE_MODULE_CONFIGURATION,moduleConfiguration);
  final Iterator<ComponentDescription> iterator=moduleDescription.getComponentDescriptions().iterator();
  while (iterator.hasNext()) {
    final ComponentDescription componentDescription=iterator.next();
    logger.debug("Configuring component class: " + componentDescription.getComponentClassName() + " named "+ componentDescription.getComponentName());
    final ComponentConfiguration componentConfiguration;
    try {
      componentConfiguration=componentDescription.createConfiguration(classIndex.classIndex(componentDescription.getComponentClassName()));
      for (      final ComponentConfigurator componentConfigurator : componentDescription.getConfigurators()) {
        componentConfigurator.configure(phaseContext,componentDescription,componentConfiguration);
      }
      moduleConfiguration.addComponentConfiguration(componentConfiguration);
    }
 catch (    Exception e) {
      if (componentDescription.isOptional()) {
        logger.warnf(e,"Not installing optional component %s due to exception",componentDescription.getComponentName());
        failed.add(componentDescription.getStartServiceName());
        failed.add(componentDescription.getCreateServiceName());
        failed.add(componentDescription.getServiceName());
        iterator.remove();
      }
 else {
        throw new DeploymentUnitProcessingException("Could not configure component " + componentDescription.getComponentName(),e);
      }
    }
  }
  deploymentUnit.putAttachment(Attachments.FAILED_COMPONENTS,Collections.synchronizedSet(failed));
}
