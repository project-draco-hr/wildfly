{
  PersistenceProviderAdaptor adaptor=PersistenceProviderAdapterRegistry.getPersistenceProviderAdaptor(pu.getPersistenceProviderClassName());
  adaptor.beforeCreateContainerEntityManagerFactory(pu);
  AccessController.doPrivileged(new SetContextLoaderAction(com.arjuna.ats.jbossatx.jta.TransactionManagerService.class.getClassLoader()));
  try {
    return provider.createContainerEntityManagerFactory(pu,properties.getValue());
  }
  finally {
    try {
      AccessController.doPrivileged(CLEAR_ACTION);
    }
  finally {
      try {
        adaptor.afterCreateContainerEntityManagerFactory(pu);
      }
  finally {
        pu.setAnnotationIndex(null);
        pu.setTempClassloader(null);
      }
    }
  }
}
