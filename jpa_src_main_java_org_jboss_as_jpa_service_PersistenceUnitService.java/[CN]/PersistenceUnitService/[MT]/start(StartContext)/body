{
  try {
    PersistenceProvider provider=lookupProvider(pu.getPersistenceProviderClassName());
    pu.setJtaDataSource(jtaDataSource.getOptionalValue());
    pu.setNonJtaDataSource(nonJtaDataSource.getOptionalValue());
    this.entityManagerFactory=createContainerEntityManagerFactory(provider);
    register(this);
  }
  finally {
    pu.setTempClassloader(null);
  }
}
