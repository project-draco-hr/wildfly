{
  final ModelNode compensatingOperation=new ModelNode();
  compensatingOperation.get(OP).set(REMOVE);
  compensatingOperation.get(OP_ADDR).set(operation.require(OP_ADDR));
  String bindingName=operation.get(REQUEST_PROPERTIES,CORE_ENVIRONMENT).require(BINDING).asString();
  String recoveryBindingName=operation.get(REQUEST_PROPERTIES,RECOVERY_ENVIRONMENT).require(BINDING).asString();
  String recoveryStatusBindingName=operation.get(REQUEST_PROPERTIES,RECOVERY_ENVIRONMENT).require(STATUS_BINDING).asString();
  String nodeIdentifier=operation.get(REQUEST_PROPERTIES,CORE_ENVIRONMENT).has(NODE_IDENTIFIER) ? operation.get(REQUEST_PROPERTIES,CORE_ENVIRONMENT,NODE_IDENTIFIER).asString() : "1";
  boolean coordinatorEnableStatistics=operation.get(REQUEST_PROPERTIES,COORDINATOR_ENVIRONMENT,ENABLE_STATISTICS).asBoolean();
  String objectStorePathRef="jboss.server.data.dir";
  String objectStorePath="tx-object-store";
  int maxPorts=10;
  int coordinatorDefaultTimeout=300;
  if (context instanceof NewRuntimeOperationContext) {
    final NewRuntimeOperationContext updateContext=(NewRuntimeOperationContext)context;
    final ServiceTarget target=updateContext.getServiceTarget();
    final XATerminatorService xaTerminatorService=new XATerminatorService();
    target.addService(TxnServices.JBOSS_TXN_XA_TERMINATOR,xaTerminatorService).setInitialMode(Mode.ACTIVE).install();
    final ArjunaTransactionManagerService transactionManagerService=new ArjunaTransactionManagerService(nodeIdentifier,maxPorts,coordinatorEnableStatistics,coordinatorDefaultTimeout);
    target.addService(TxnServices.JBOSS_TXN_ARJUNA_TRANSACTION_MANAGER,transactionManagerService).addDependency(DependencyType.OPTIONAL,ServiceName.JBOSS.append("iiop","orb"),ORB.class,transactionManagerService.getOrbInjector()).addDependency(TxnServices.JBOSS_TXN_XA_TERMINATOR,JBossXATerminator.class,transactionManagerService.getXaTerminatorInjector()).addDependency(SocketBinding.JBOSS_BINDING_NAME.append(recoveryBindingName),SocketBinding.class,transactionManagerService.getRecoveryBindingInjector()).addDependency(SocketBinding.JBOSS_BINDING_NAME.append(recoveryStatusBindingName),SocketBinding.class,transactionManagerService.getStatusBindingInjector()).addDependency(SocketBinding.JBOSS_BINDING_NAME.append(bindingName),SocketBinding.class,transactionManagerService.getSocketProcessBindingInjector()).addDependency(AbstractPathService.pathNameOf(INTERNAL_OBJECTSTORE_PATH),String.class,transactionManagerService.getPathInjector()).setInitialMode(Mode.ACTIVE).install();
    TransactionManagerService.addService(target);
    UserTransactionService.addService(target);
    RelativePathService.addService(INTERNAL_OBJECTSTORE_PATH,objectStorePath,objectStorePathRef,target);
  }
  final ModelNode subModel=context.getSubModel();
  subModel.get(CORE_ENVIRONMENT,BINDING).set(operation.get(REQUEST_PROPERTIES,CORE_ENVIRONMENT).require(BINDING));
  subModel.get(CORE_ENVIRONMENT,NODE_IDENTIFIER).set(operation.get(REQUEST_PROPERTIES,CORE_ENVIRONMENT,NODE_IDENTIFIER));
  subModel.get(RECOVERY_ENVIRONMENT,BINDING).set(operation.get(REQUEST_PROPERTIES,RECOVERY_ENVIRONMENT).require(BINDING));
  subModel.get(RECOVERY_ENVIRONMENT,STATUS_BINDING).set(operation.get(REQUEST_PROPERTIES,RECOVERY_ENVIRONMENT,STATUS_BINDING));
  subModel.get(COORDINATOR_ENVIRONMENT,ENABLE_STATISTICS).set(operation.get(REQUEST_PROPERTIES,COORDINATOR_ENVIRONMENT,ENABLE_STATISTICS));
  resultHandler.handleResultComplete(compensatingOperation);
  return Cancellable.NULL;
}
