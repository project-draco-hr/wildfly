{
  if (containerConfig.getUsername() != null) {
    Authentication.username=containerConfig.getUsername();
    Authentication.password=containerConfig.getPassword();
  }
  DomainClient domainClient=DomainClient.Factory.create(containerConfig.getManagementAddress(),containerConfig.getManagementPort(),Authentication.getCallbackHandler());
  managementClient=new ManagementClient(domainClient,containerConfig.getManagementAddress().getHostAddress(),containerConfig.getManagementPort());
  managementClientInst.set(managementClient);
  ArchiveDeployer archiveDeployer=new ArchiveDeployer(domainClient.getDeploymentManager());
  archiveDeployerInst.set(archiveDeployer);
  try {
    startInternal();
  }
 catch (  LifecycleException e) {
    safeCloseClient();
    throw e;
  }
  ContainerRegistry registry=containerRegistryInstance.get();
  Map<String,String> containerNameMap=containerConfig.getContainerNameMap();
  Map<String,String> modeMap=containerConfig.getContainerModeMap();
  Domain domain=managementClient.createDomain(containerNameMap);
  domainInst.set(domain);
  waitForStart(domain,managementClient);
  for (  ServerGroup serverGroup : domain.getServerGroups()) {
    Container serverContainer=createServerGroupContainer(registry,archiveDeployer,domain,serverGroup,containerConfig.getServerGroupOperationTimeoutInSeconds());
    String mode=mapMode(modeMap,serverContainer.getName());
    if (mode != null) {
      serverContainer.getContainerConfiguration().setMode(mode);
    }
    setupEvent.fire(new SetupContainer(serverContainer));
    serverContainer.setState(Container.State.STARTED);
  }
  for (  Server server : domain.getServers()) {
    Container serverContainer=createServerContainer(registry,server,containerConfig.getServerOperationTimeoutInSeconds());
    String mode=mapMode(modeMap,serverContainer.getName());
    if (mode != null) {
      serverContainer.getContainerConfiguration().setMode(mode);
    }
    String serverStatus=managementClient.getServerState(server);
    setupEvent.fire(new SetupContainer(serverContainer));
    if (serverStatus.equals("STARTED")) {
      serverContainer.setState(Container.State.STARTED);
    }
 else {
      serverContainer.setState(Container.State.STOPPED);
    }
  }
}
