{
  setDomainConfigDir("standard");
  TestProcessHandlerFactory processHandlerFactory=new TestProcessHandlerFactory(false,true);
  QueuedNewConnectionListener newConnectionListener=new QueuedNewConnectionListener();
  final TestProcessManager pm=TestProcessManager.create(processHandlerFactory,InetAddress.getLocalHost(),0,newConnectionListener);
  newConnectionListener.assertWaitForConnection("ServerManager");
  MockServerManagerProcess sm=assertGetServerManager(processHandlerFactory);
  sm.addServerToPm("Server:server-one",pm.getPort());
  sm.startServerInPm("Server:server-one");
  newConnectionListener.assertWaitForConnection("Server:server-one");
  assertReadServerCommand(sm,"Server:server-one",ServerToServerManagerProtocolCommand.SERVER_AVAILABLE);
  ServerModel cfg=getServer("standard","server-one");
  sm.sendMessageToServer("Server:server-one",ServerManagerToServerProtocolCommand.START_SERVER,cfg);
  assertReadServerCommand(sm,"Server:server-one",ServerToServerManagerProtocolCommand.SERVER_STARTED);
  sm.crashServerManager(1);
  sm.stop();
  newConnectionListener.assertWaitForConnection("ServerManager");
  sm=assertGetServerManager(processHandlerFactory);
  sm.sendReconnectServersToProcessManager();
  Command<ServerToServerManagerProtocolCommand> cmd=assertReadServerCommand(sm,"Server:server-one",ServerToServerManagerProtocolCommand.SERVER_RECONNECT_STATUS);
  ServerState state=ServerManagerProtocolUtils.unmarshallCommandData(ServerState.class,cmd);
  Assert.assertSame(ServerState.STARTED,state);
  new Thread(new Runnable(){
    public void run(){
      pm.shutdown();
    }
  }
).start();
  assertReadPmCommand(sm,OutgoingPmCommand.SHUTDOWN_SERVERS.toString());
  sm.sendMessageToServer("Server:server-one",ServerManagerToServerProtocolCommand.STOP_SERVER);
  assertReadServerCommand(sm,"Server:server-one",ServerToServerManagerProtocolCommand.SERVER_STOPPED);
  sm.stopServerInPm("Server:server-one");
  sm.removeServerFromPm("Server:server-one");
  sm.sendServersShutdownToProcessManager();
  assertReadPmCommand(sm,OutgoingPmCommand.SHUTDOWN.toString());
  sm.stop();
}
