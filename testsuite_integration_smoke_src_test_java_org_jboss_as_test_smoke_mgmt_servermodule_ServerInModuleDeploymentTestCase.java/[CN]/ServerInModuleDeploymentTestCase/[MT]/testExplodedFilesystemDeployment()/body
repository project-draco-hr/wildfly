{
  final File deployDir=createDeploymentDir("exploded-deployments");
  ModelControllerClient client=managementClient.getControllerClient();
  final String scannerName="exploded";
  addDeploymentScanner(deployDir,client,scannerName,false);
  final JavaArchive archive=ShrinkWrap.create(JavaArchive.class,"test-deployment.sar").addPackage(Simple.class.getPackage()).addAsManifestResource(ServerInModuleDeploymentTestCase.class.getPackage(),"jboss-service.xml","jboss-service.xml");
  final File dir=new File("target/archives");
  dir.mkdirs();
  archive.as(ExplodedExporter.class).exportExploded(deployDir);
  final File deployed=new File(deployDir,"test-deployment.sar.deployed");
  Assert.assertFalse(deployed.exists());
  testDeployments(client,true,new DeploymentExecutor(){
    @Override public void initialDeploy() throws IOException {
      final File dodeploy=new File(deployDir,"test-deployment.sar.dodeploy");
      final OutputStream out=new BufferedOutputStream(new FileOutputStream(dodeploy));
      try {
        out.write("test-deployment.sar".getBytes());
      }
  finally {
        StreamUtils.safeClose(out);
      }
      Assert.assertTrue(dodeploy.exists());
      for (int i=0; i < TIMEOUT / BACKOFF; i++) {
        if (deployed.exists()) {
          break;
        }
        try {
          Thread.sleep(BACKOFF);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          throw new RuntimeException(e);
        }
      }
      Assert.assertTrue(deployed.exists());
    }
    @Override public void fullReplace() throws IOException {
      final File dodeploy=new File(deployDir,"test-deployment.sar.dodeploy");
      final File isdeploying=new File(deployDir,"test-deployment.sar.isdeploying");
      for (int i=0; i < TIMEOUT / BACKOFF; i++) {
        if (!dodeploy.exists() && !isdeploying.exists()) {
          break;
        }
        try {
          Thread.sleep(BACKOFF);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          break;
        }
      }
      if (dodeploy.exists()) {
        Assert.fail("initialDeploy step did not complete in a reasonably timely fashion");
      }
      initialDeploy();
    }
    @Override public void undeploy(){
      final File dodeploy=new File(deployDir,"test-deployment.sar.dodeploy");
      final File isdeploying=new File(deployDir,"test-deployment.sar.isdeploying");
      final File undeployed=new File(deployDir,"test-deployment.sar.undeployed");
      for (int i=0; i < TIMEOUT / BACKOFF; i++) {
        if (!dodeploy.exists() && !isdeploying.exists() && deployed.exists()) {
          break;
        }
        try {
          Thread.sleep(BACKOFF);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          break;
        }
      }
      if (dodeploy.exists() || !deployed.exists()) {
        Assert.fail("fullReplace step did not complete in a reasonably timely fashion");
      }
      deployed.delete();
      for (int i=0; i < TIMEOUT / BACKOFF; i++) {
        if (undeployed.exists()) {
          break;
        }
        try {
          Thread.sleep(BACKOFF);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          break;
        }
      }
      if (!undeployed.exists()) {
        Assert.fail("undeploy step did not complete in a reasonably timely fashion");
      }
    }
  }
);
}
