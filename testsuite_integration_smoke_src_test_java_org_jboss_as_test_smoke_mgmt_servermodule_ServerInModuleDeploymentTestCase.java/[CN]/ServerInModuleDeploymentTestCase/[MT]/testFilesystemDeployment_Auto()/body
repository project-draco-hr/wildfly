{
  final JavaArchive archive=ShrinkWrapUtils.createJavaArchive("servermodule/test-deployment.sar",Simple.class.getPackage());
  final File dir=new File("target/archives");
  dir.mkdirs();
  final File file=new File(dir,"test-deployment.sar");
  archive.as(ZipExporter.class).exportTo(file,true);
  final File deployDir=createDeploymentDir("auto-deployments");
  ModelControllerClient client=managementClient.getControllerClient();
  final String scannerName="autoZips";
  addDeploymentScanner(deployDir,client,scannerName,true);
  final File target=new File(deployDir,"test-deployment.sar");
  final File deployed=new File(deployDir,"test-deployment.sar.deployed");
  Assert.assertFalse(target.exists());
  testDeployments(client,true,new DeploymentExecutor(){
    @Override public void initialDeploy() throws IOException {
      final InputStream in=new BufferedInputStream(new FileInputStream(file));
      try {
        final OutputStream out=new BufferedOutputStream(new FileOutputStream(target));
        try {
          int i=in.read();
          while (i != -1) {
            out.write(i);
            i=in.read();
          }
        }
  finally {
          StreamUtils.safeClose(out);
        }
      }
  finally {
        StreamUtils.safeClose(in);
      }
      Assert.assertTrue(file.exists());
    }
    @Override public void fullReplace() throws IOException {
      final File isdeploying=new File(deployDir,"test-deployment.sar.isdeploying");
      for (int i=0; i < 500; i++) {
        if (!isdeploying.exists()) {
          break;
        }
        try {
          Thread.sleep(10);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          break;
        }
      }
      if (isdeploying.exists()) {
        Assert.fail("initialDeploy step did not complete in a reasonably timely fashion");
      }
      initialDeploy();
    }
    @Override public void undeploy(){
      final File isdeploying=new File(deployDir,"test-deployment.sar.isdeploying");
      for (int i=0; i < 500; i++) {
        if (!isdeploying.exists() && deployed.exists()) {
          break;
        }
        try {
          Thread.sleep(10);
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          break;
        }
      }
      if (!deployed.exists()) {
        Assert.fail("fullReplace step did not complete in a reasonably timely fashion");
      }
      target.delete();
    }
  }
);
}
