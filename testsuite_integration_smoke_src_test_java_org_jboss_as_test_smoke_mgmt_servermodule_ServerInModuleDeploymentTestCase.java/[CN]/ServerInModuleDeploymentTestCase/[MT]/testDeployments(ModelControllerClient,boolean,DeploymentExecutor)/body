{
  final JMXConnector connector=JMXConnectorFactory.connect(managementClient.getRemoteJMXURL());
  try {
    final MBeanServerConnection mbeanServer=connector.getMBeanServerConnection();
    final ObjectName name=new ObjectName("jboss.test:service=testdeployments");
    try {
      Set<String> initialHashes=null;
      if (!fromFile) {
        initialHashes=getAllDeploymentHashesFromContentDir(true);
      }
      deploymentExecutor.initialDeploy();
      Assert.assertNotNull(mbeanServer.getMBeanInfo(name));
      Set<String> currentHashes=null;
      String initialDeploymentHash=null;
      if (!fromFile) {
        currentHashes=getAllDeploymentHashesFromContentDir(false);
        currentHashes.removeAll(initialHashes);
        Assert.assertEquals(1,currentHashes.size());
        initialDeploymentHash=currentHashes.iterator().next();
      }
      deploymentExecutor.fullReplace();
      Assert.assertNotNull(mbeanServer.getMBeanInfo(name));
      if (!fromFile) {
        currentHashes=getAllDeploymentHashesFromContentDir(false);
        Assert.assertFalse(currentHashes.contains(initialDeploymentHash));
        currentHashes.removeAll(initialHashes);
        Assert.assertEquals(1,currentHashes.size());
      }
      deploymentExecutor.undeploy();
      try {
        long start=System.currentTimeMillis();
        while (System.currentTimeMillis() - start < 10000) {
          mbeanServer.getMBeanInfo(name);
          Thread.sleep(100);
        }
        Assert.fail("Should not have found MBean");
      }
 catch (      Exception expected) {
      }
      if (!fromFile) {
        Assert.assertEquals(initialHashes,getAllDeploymentHashesFromContentDir(false));
      }
    }
  finally {
    }
  }
  finally {
    IoUtils.safeClose(connector);
  }
}
