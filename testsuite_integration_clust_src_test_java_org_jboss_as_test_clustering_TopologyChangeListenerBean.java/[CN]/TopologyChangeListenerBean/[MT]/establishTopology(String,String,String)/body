{
  Set<String> expectedMembers=new TreeSet<>();
  if (nodes != null) {
    for (    String name : nodes) {
      expectedMembers.add(name + "/" + containerName);
    }
  }
  ServiceRegistry registry=CurrentServiceContainer.getServiceContainer();
  ServiceName name=ServiceName.JBOSS.append("infinispan",containerName,cacheName);
  Cache<?,?> cache=ServiceContainerHelper.findValue(registry,name);
  if (cache == null) {
    throw new IllegalStateException(String.format("Failed to locate %s",name));
  }
  cache.addListener(this);
  try {
    long start=System.currentTimeMillis();
    long now=start;
    long timeout=start + TIMEOUT;
synchronized (this) {
      Set<String> members=getMembers(cache);
      while (!expectedMembers.equals(members)) {
        System.out.println(String.format("%s != %s, waiting for a topology change event...",expectedMembers,members));
        this.wait(timeout - now);
        now=System.currentTimeMillis();
        if (now >= timeout) {
          throw new InterruptedException(String.format("Cache %s/%s failed to establish view %s within %d ms.  Current view is: %s",containerName,cacheName,expectedMembers,TIMEOUT,members));
        }
        members=getMembers(cache);
      }
      System.out.println(String.format("Cache %s/%s successfully established view %s within %d ms.",containerName,cacheName,expectedMembers,now - start));
    }
  }
  finally {
    cache.removeListener(this);
  }
}
