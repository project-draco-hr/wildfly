{
  setupCleanDirectories(jbossHomeDir,systemProps);
  StandaloneServer standaloneServer=new StandaloneServer(){
    private ServiceContainer serviceContainer;
    @Override public void start() throws ServerStartException {
      try {
        ServerEnvironment serverEnviromment=Main.determineEnvironment(new String[0],systemProps,systemEnv);
        Bootstrap bootstrap=Bootstrap.Factory.newInstance();
        Bootstrap.Configuration configuration=new Bootstrap.Configuration();
        configuration.setServerEnvironment(serverEnviromment);
        configuration.setModuleLoader(moduleLoader);
        Future<ServiceContainer> future=bootstrap.startup(configuration,Collections.<ServiceActivator>emptyList());
        serviceContainer=future.get();
      }
 catch (      RuntimeException rte) {
        throw rte;
      }
catch (      Exception ex) {
        throw new ServerStartException(ex);
      }
    }
    @Override public void stop(){
      if (serviceContainer != null) {
        try {
          serviceContainer.shutdown();
          serviceContainer.awaitTermination();
        }
 catch (        RuntimeException rte) {
          throw rte;
        }
catch (        Exception ex) {
          ex.printStackTrace();
        }
      }
    }
  }
;
  return standaloneServer;
}
