{
  setupCleanDirectories(jbossHomeDir,systemProps);
  StandaloneServer standaloneServer=new StandaloneServer(){
    private ServiceContainer serviceContainer;
    private ServerDeploymentManager serverDeploymentManager;
    private Context context;
    private ModelControllerClient modelControllerClient;
    @Override public void deploy(    File file) throws IOException, ExecutionException, InterruptedException {
      execute(serverDeploymentManager.newDeploymentPlan().add(file.getName(),VFSUtils.createJarFileInputStream(VFS.getChild(file.toURI()))).andDeploy().build());
    }
    private ServerDeploymentPlanResult execute(    DeploymentPlan deploymentPlan) throws ExecutionException, InterruptedException {
      return serverDeploymentManager.execute(deploymentPlan).get();
    }
    @Override public Context getContext(){
      return ifSet(context,"Server has not been started");
    }
    @Override public ModelControllerClient getModelControllerClient(){
      return modelControllerClient;
    }
    @Override public void start() throws ServerStartException {
      try {
        ServerEnvironment serverEnviromment=Main.determineEnvironment(new String[0],systemProps,systemEnv,ServerEnvironment.LaunchType.EMBEDDED);
        Bootstrap bootstrap=Bootstrap.Factory.newInstance();
        Bootstrap.Configuration configuration=new Bootstrap.Configuration();
        final QName rootElement=new QName(Namespace.CURRENT.getUriString(),"server");
        final StandaloneXml parser=new StandaloneXml(Module.getBootModuleLoader());
        configuration.setConfigurationPersister(new TransientConfigurationPersister(serverEnviromment.getServerConfigurationFile(),rootElement,parser,parser));
        configuration.setServerEnvironment(serverEnviromment);
        configuration.setModuleLoader(moduleLoader);
        Future<ServiceContainer> future=bootstrap.startup(configuration,Collections.<ServiceActivator>emptyList());
        serviceContainer=future.get();
        final Value<ServerController> serverControllerService=(Value<ServerController>)serviceContainer.getRequiredService(Services.JBOSS_SERVER_CONTROLLER);
        final ServerController controller=serverControllerService.getValue();
        serverDeploymentManager=new ModelControllerServerDeploymentManager(controller);
        modelControllerClient=new ModelControllerToModelControllerClientAdapter(controller);
        context=new InitialContext();
      }
 catch (      RuntimeException rte) {
        throw rte;
      }
catch (      Exception ex) {
        throw new ServerStartException(ex);
      }
    }
    @Override public void stop(){
      if (context != null) {
        try {
          context.close();
          context=null;
        }
 catch (        NamingException e) {
          e.printStackTrace();
        }
      }
      serverDeploymentManager=null;
      if (serviceContainer != null) {
        try {
          serviceContainer.shutdown();
          serviceContainer.awaitTermination();
        }
 catch (        RuntimeException rte) {
          throw rte;
        }
catch (        Exception ex) {
          ex.printStackTrace();
        }
      }
    }
    @Override public void undeploy(    File file) throws ExecutionException, InterruptedException {
      execute(serverDeploymentManager.newDeploymentPlan().undeploy(file.getName()).andRemoveUndeployed().build());
    }
  }
;
  return standaloneServer;
}
