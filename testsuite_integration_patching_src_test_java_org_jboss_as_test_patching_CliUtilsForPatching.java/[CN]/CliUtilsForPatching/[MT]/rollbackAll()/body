{
  CLIWrapper cli=null;
  boolean success=true;
  final String infoCommand="patch info --distribution=%s";
  final String rollbackCommand="patch rollback --patch-id=%s --distribution=%s --reset-configuration=true";
  try {
    cli=new CLIWrapper(false);
    String command=String.format(infoCommand,PatchingTestUtil.AS_DISTRIBUTION);
    logger.info("----- sending command to CLI: " + command + " -----");
    cli.sendLine(command);
    String response=cli.readOutput();
    ModelNode responseNode=ModelNode.fromJSONString(response);
    String cumulativePatchId=responseNode.get("result").get("cumulative-patch-id").asString();
    if (!cumulativePatchId.equalsIgnoreCase(BASE)) {
      success=success && cli.sendLine(String.format(rollbackCommand,cumulativePatchId,PatchingTestUtil.AS_DISTRIBUTION),true);
    }
    cli.sendLine(String.format(infoCommand,PatchingTestUtil.AS_DISTRIBUTION));
    response=cli.readOutput();
    responseNode=ModelNode.fromJSONString(response);
    List<ModelNode> patchesList=responseNode.get("result").get("patches").asList();
    for (    ModelNode n : patchesList) {
      success=success && cli.sendLine(String.format(rollbackCommand,n.asString(),PatchingTestUtil.AS_DISTRIBUTION),true);
    }
    return success;
  }
  finally {
    if (cli != null) {
      cli.quit();
    }
  }
}
