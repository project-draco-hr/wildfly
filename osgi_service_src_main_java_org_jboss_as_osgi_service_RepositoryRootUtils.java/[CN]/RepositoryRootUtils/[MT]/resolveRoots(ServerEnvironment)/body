{
  final File jbossHome=environment.getHomeDir();
  final File bundlesDir=environment.getBundlesDir();
  if (bundlesDir.isDirectory() == false) {
    throw MESSAGES.illegalStateArtifactBaseLocation(bundlesDir);
  }
  final File modulesDir=new File(bundlesDir.getParent() + File.separator + "modules");
  if (modulesDir.isDirectory() == false) {
    throw MESSAGES.illegalStateArtifactBaseLocation(modulesDir);
  }
  final DirectoryStructure structure=DirectoryStructure.createDefault(jbossHome);
  if (structure.getCumulativeLink().exists()) {
    final String ref=readRef(structure.getCumulativeLink());
    final List<String> patches=readRefs(structure.getCumulativeRefs(ref));
    final List<File> path=new ArrayList<File>(patches.size() + 1);
    for (    final String patch : patches) {
      path.add(structure.getBundlesPatchDirectory(patch));
    }
    path.add(structure.getBundlesPatchDirectory(ref));
    path.add(bundlesDir);
    path.add(modulesDir);
    return path.toArray(new File[path.size()]);
  }
 else {
    return new File[]{bundlesDir,modulesDir};
  }
}
