{
  String protocol=toFinish.getProtocol();
  String host=toFinish.getHost();
  int port=toFinish.getPort();
  if (protocol == null) {
    if (config.isUseLegacyOverride() && port == 9999) {
      protocol="remoting";
    }
 else {
      protocol=config.getDefaultControllerProtocol();
    }
  }
  if (host == null) {
    throw new CommandLineException("null host encountered");
  }
  if (port < 0) {
    if ("remote".equals(protocol) || "remoting".equals(protocol)) {
      port=9999;
    }
 else     if ("http-remoting".equals(protocol)) {
      port=9990;
    }
 else     if ("https-remoting".equals(protocol)) {
      port=9993;
    }
 else {
      throw new CommandLineException("Unexpected protocol '" + protocol + "'");
    }
  }
  return new ControllerAddress(protocol,host,port);
}
