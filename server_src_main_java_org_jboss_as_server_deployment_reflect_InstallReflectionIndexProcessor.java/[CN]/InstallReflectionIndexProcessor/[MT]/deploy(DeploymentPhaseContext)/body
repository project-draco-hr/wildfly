{
  DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  BundleState bundleState=deploymentUnit.getAttachment(Attachments.BUNDLE_STATE_KEY);
  Module module=deploymentUnit.getAttachment(Attachments.MODULE);
  if (module == null && bundleState == BundleState.INSTALLED) {
    DEPLOYMENT_LOGGER.warnCannotInstallReflectionIndexForUnresolvedBundle(deploymentUnit.getName());
    return;
  }
  if (module == null) {
    throw MESSAGES.nullModuleAttachment(deploymentUnit);
  }
  if (deploymentUnit.getParent() == null) {
    final DeploymentReflectionIndex index=DeploymentReflectionIndex.create();
    deploymentUnit.putAttachment(Attachments.REFLECTION_INDEX,index);
    deploymentUnit.putAttachment(Attachments.PROXY_REFLECTION_INDEX,new ProxyMetadataSource(index));
    deploymentUnit.putAttachment(Attachments.CLASS_INDEX,new DeploymentClassIndex(index,module));
  }
 else {
    final DeploymentReflectionIndex index=deploymentUnit.getParent().getAttachment(Attachments.REFLECTION_INDEX);
    deploymentUnit.putAttachment(Attachments.REFLECTION_INDEX,index);
    deploymentUnit.putAttachment(Attachments.PROXY_REFLECTION_INDEX,deploymentUnit.getParent().getAttachment(Attachments.PROXY_REFLECTION_INDEX));
    deploymentUnit.putAttachment(Attachments.CLASS_INDEX,new DeploymentClassIndex(index,module));
  }
}
