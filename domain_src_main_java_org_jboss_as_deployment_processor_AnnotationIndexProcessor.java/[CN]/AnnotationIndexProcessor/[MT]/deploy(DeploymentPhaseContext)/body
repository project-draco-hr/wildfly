{
  if (phaseContext.getAttachment(Attachments.ANNOTATION_INDEX) != null)   return;
  final VirtualFile virtualFile=phaseContext.getDeploymentUnitContext().getAttachment(Attachments.DEPLOYMENT_ROOT);
  final Indexer indexer=new Indexer();
  try {
    final List<VirtualFile> classChildren=virtualFile.getChildren(new SuffixMatchFilter(".class",VisitorAttributes.RECURSE_LEAVES_ONLY));
    for (    VirtualFile classFile : classChildren) {
      InputStream inputStream=null;
      try {
        inputStream=classFile.openStream();
        indexer.index(inputStream);
      }
  finally {
        VFSUtils.safeClose(inputStream);
      }
    }
    final Index index=indexer.complete();
    phaseContext.putAttachment(Attachments.ANNOTATION_INDEX,index);
  }
 catch (  Throwable t) {
    throw new DeploymentUnitProcessingException("Failed to index deployment root for annotations",t);
  }
}
