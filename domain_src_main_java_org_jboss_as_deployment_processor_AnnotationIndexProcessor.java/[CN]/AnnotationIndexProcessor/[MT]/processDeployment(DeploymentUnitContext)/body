{
  if (context.getAttachment(ATTACHMENT_KEY) != null)   return;
  final VirtualFile virtualFile=getVirtualFileAttachment(context);
  final Indexer indexer=new Indexer();
  try {
    final List<VirtualFile> classChildren=virtualFile.getChildren(new SuffixMatchFilter(".class",VisitorAttributes.RECURSE_LEAVES_ONLY));
    for (    VirtualFile classFile : classChildren) {
      InputStream inputStream=null;
      try {
        inputStream=classFile.openStream();
        indexer.index(inputStream);
      }
  finally {
        VFSUtils.safeClose(inputStream);
      }
    }
    final Index index=indexer.complete();
    context.putAttachment(ATTACHMENT_KEY,index);
  }
 catch (  Throwable t) {
    throw new DeploymentUnitProcessingException("Failed to index deployment root for annotations",t);
  }
}
