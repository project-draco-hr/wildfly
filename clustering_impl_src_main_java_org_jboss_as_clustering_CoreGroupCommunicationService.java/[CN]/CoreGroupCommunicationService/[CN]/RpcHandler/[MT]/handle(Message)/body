{
  Object body=null;
  Object retval=null;
  Object handler=null;
  boolean trace=CoreGroupCommunicationService.this.log.isTraceEnabled();
  String service=null;
  byte[] request_bytes=null;
  if (trace) {
    CoreGroupCommunicationService.this.log.tracef("Partition %s received msg",CoreGroupCommunicationService.this.getGroupName());
  }
  if (req == null || req.getRawBuffer() == null) {
    CoreGroupCommunicationService.this.log.nullPartitionMessage(CoreGroupCommunicationService.this.getGroupName());
    return null;
  }
  try {
    Object wrapper=CoreGroupCommunicationService.this.objectFromByteBufferInternal(null,req.getRawBuffer(),req.getOffset(),req.getLength());
    if (wrapper == null || !(wrapper instanceof Object[])) {
      CoreGroupCommunicationService.this.log.invalidPartitionMessageWrapper(CoreGroupCommunicationService.this.getGroupName());
      return null;
    }
    Object[] temp=(Object[])wrapper;
    service=(String)temp[0];
    request_bytes=(byte[])temp[1];
    handler=CoreGroupCommunicationService.this.rpcHandlers.get(service);
    if (handler == null) {
      if (trace) {
        CoreGroupCommunicationService.this.log.tracef("Partition %s no rpc handler registered under service %s",CoreGroupCommunicationService.this.getGroupName(),service);
      }
      return new NoHandlerForRPC();
    }
  }
 catch (  Exception e) {
    CoreGroupCommunicationService.this.log.partitionFailedUnserialing(e,CoreGroupCommunicationService.this.getGroupName(),req);
    return null;
  }
  WeakReference<ClassLoader> weak=CoreGroupCommunicationService.this.clmap.get(service);
  ClassLoader serviceLoader=(weak != null) ? weak.get() : null;
  if (serviceLoader == null) {
    serviceLoader=CoreGroupCommunicationService.class.getClassLoader();
  }
  try {
    body=CoreGroupCommunicationService.this.objectFromByteBufferInternal(serviceLoader,request_bytes,0,request_bytes.length);
  }
 catch (  Exception e) {
    CoreGroupCommunicationService.this.log.partitionFailedExtractingMessageBody(e,CoreGroupCommunicationService.this.getGroupName());
    return null;
  }
  if (body == null || !(body instanceof MethodCall)) {
    CoreGroupCommunicationService.this.log.invalidPartitionMessage(CoreGroupCommunicationService.this.getGroupName());
    return null;
  }
  MethodCall method_call=(MethodCall)body;
  String methodName=method_call.getName();
  if (trace) {
    CoreGroupCommunicationService.this.log.tracef("full methodName: %s",methodName);
  }
  int idx=methodName.lastIndexOf('.');
  String handlerName=methodName.substring(0,idx);
  String newMethodName=methodName.substring(idx + 1);
  if (trace) {
    CoreGroupCommunicationService.this.log.tracef("handlerName: %s methodName: %s",handlerName,newMethodName);
    CoreGroupCommunicationService.this.log.tracef("Handle: %s",methodName);
  }
  method_call.setName(newMethodName);
  try {
    retval=method_call.invoke(handler);
    if (weak != null) {
      byte[] retbytes=CoreGroupCommunicationService.this.objectToByteBufferResponseInternal(retval);
      retval=new HAServiceResponse(handlerName,retbytes);
    }
    if (trace) {
      CoreGroupCommunicationService.this.log.tracef("rpc call return value: %s",retval);
    }
  }
 catch (  Throwable t) {
    if (trace) {
      CoreGroupCommunicationService.this.log.tracef(t,"Partition %s rpc call threw exception",CoreGroupCommunicationService.this.getGroupName());
    }
    retval=t;
  }
  return retval;
}
