{
  return new SystemDeployerService(context){
    @Override protected Bundle installBundle(    Deployment dep) throws BundleException {
      log.tracef("Install deployment: %s",dep);
      Bundle bundle=null;
      String contextName=InstallBundleInitiatorService.getContextName(dep);
      DeploymentPlanBuilder builder=deploymentManager.newDeploymentPlan();
      try {
        ServiceContainer serviceContainer=getBundleManager().getServiceContainer();
        BatchBuilder batchBuilder=serviceContainer.batchBuilder();
        InstallBundleInitiatorService.addService(batchBuilder,contextName,dep);
        OSGiDeploymentLatchService.addService(batchBuilder,contextName);
        batchBuilder.install();
        InputStream inputStream=dep.getRoot().openStream();
        builder=builder.add(contextName,inputStream).andDeploy();
        DeploymentPlan plan=builder.build();
        DeploymentAction deployAction=builder.getLastAction();
        executeDeploymentPlan(plan,deployAction);
        final CountDownLatch latch=new CountDownLatch(1);
        ServiceName serviceName=OSGiDeploymentLatchService.getServiceName(contextName);
        ServiceController<?> controller=serviceContainer.getService(serviceName);
        controller.addListener(new AbstractServiceListener<Object>(){
          @Override public void listenerAdded(          ServiceController<? extends Object> controller){
            if (controller.getState() == State.UP)             serviceStarted(controller);
 else             if (controller.getState() == State.START_FAILED)             serviceFailed(controller,controller.getStartException());
          }
          @Override public void serviceStarted(          ServiceController<? extends Object> controller){
            log.tracef("Service started: %s",controller.getName());
            controller.removeListener(this);
            controller.setMode(Mode.REMOVE);
            latch.countDown();
          }
          @Override public void serviceFailed(          ServiceController<? extends Object> controller,          StartException reason){
            log.tracef(reason,"Service failed: %s",controller.getName());
            controller.removeListener(this);
            controller.setMode(Mode.REMOVE);
            latch.countDown();
          }
        }
);
        latch.await(10,TimeUnit.SECONDS);
        if (controller.getState() == State.START_FAILED)         throw controller.getStartException();
        if (controller.getState() != State.UP)         throw new BundleException("OSGiDeploymentService not available: " + serviceName);
        Deployment bundleDep=(Deployment)controller.getValue();
        bundle=bundleDep.getAttachment(Bundle.class);
      }
 catch (      RuntimeException rte) {
        throw rte;
      }
catch (      BundleException ex) {
        throw ex;
      }
catch (      Exception ex) {
        throw new BundleException("Cannot deploy bundle: " + dep,ex);
      }
      if (bundle == null)       throw new IllegalStateException("Cannot find bundle: " + contextName);
      return bundle;
    }
    @Override protected void uninstallBundle(    Deployment dep,    Bundle bundle) throws BundleException {
      try {
        String contextName=InstallBundleInitiatorService.getContextName(dep);
        ServiceName serviceName=OSGiDeploymentService.getServiceName(contextName);
        if (getBundleManager().getServiceContainer().getService(serviceName) == null)         getBundleManager().uninstallBundle(dep);
        serviceName=Services.JBOSS_DEPLOYMENT.append(contextName);
        if (getBundleManager().getServiceContainer().getService(serviceName) == null)         log.warnf("Cannot find deployment service: %s",serviceName);
        DeploymentPlanBuilder builder=deploymentManager.newDeploymentPlan();
        builder=builder.undeploy(contextName).remove(contextName);
        DeploymentPlan plan=builder.build();
        DeploymentAction removeAction=builder.getLastAction();
        executeDeploymentPlan(plan,removeAction);
      }
 catch (      RuntimeException rte) {
        throw rte;
      }
catch (      Exception ex) {
        throw new BundleException("Cannot undeploy bundle: " + dep,ex);
      }
    }
  }
;
}
