{
  String jbossHome=System.getenv("JBOSS_HOME");
  if (jbossHome == null) {
    return new ErrorState(MESSAGES.jbossHomeNotSet(),null,values);
  }
  List<File> foundFiles=new ArrayList<File>(2);
  final String fileName=values.management ? MGMT_USERS_PROPERTIES : APPLICATION_USERS_PROPERTIES;
  if (!findFiles(jbossHome,foundFiles,fileName)) {
    return new ErrorState(MESSAGES.propertiesFileNotFound(fileName),null,values);
  }
  if (!values.management) {
    List<File> foundRoleFiles=new ArrayList<File>(2);
    if (!findFiles(jbossHome,foundRoleFiles,APPLICATION_ROLES_PROPERTIES)) {
      return new ErrorState(MESSAGES.propertiesFileNotFound(APPLICATION_ROLES_PROPERTIES),null,values);
    }
    roleFiles=foundRoleFiles;
  }
  propertiesFiles=foundFiles;
  Set<String> foundUsers=new HashSet<String>();
  for (  File current : propertiesFiles) {
    try {
      foundUsers.addAll(loadUserNames(current));
    }
 catch (    IOException e) {
      return new ErrorState(MESSAGES.unableToLoadUsers(current.getAbsolutePath(),e.getMessage()),null,values);
    }
  }
  knownUsers=foundUsers;
  if (values == null) {
    return new PromptNewUserState();
  }
 else {
    return new PromptNewUserState(values);
  }
}
