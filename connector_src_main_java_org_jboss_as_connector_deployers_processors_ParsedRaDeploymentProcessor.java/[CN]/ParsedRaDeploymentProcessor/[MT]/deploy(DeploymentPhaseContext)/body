{
  final ConnectorXmlDescriptor connectorXmlDescriptor=phaseContext.getDeploymentUnit().getAttachment(ConnectorXmlDescriptor.ATTACHMENT_KEY);
  if (connectorXmlDescriptor == null) {
    return;
  }
  final IronJacamarXmlDescriptor ironJacamarXmlDescriptor=phaseContext.getAttachment(IronJacamarXmlDescriptor.ATTACHMENT_KEY);
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
  if (module == null)   throw new DeploymentUnitProcessingException("Failed to get module attachment for " + phaseContext.getDeploymentUnit());
  final ClassLoader classLoader=module.getClassLoader();
  Connector cmd=connectorXmlDescriptor != null ? connectorXmlDescriptor.getConnector() : null;
  final IronJacamar ijmd=ironJacamarXmlDescriptor != null ? ironJacamarXmlDescriptor.getIronJacamar() : null;
  try {
    Annotations annotator=new Annotations();
    Map<ResourceRoot,Index> indexes=AnnotationIndexUtils.getAnnotationIndexes(deploymentUnit);
    for (    Entry<ResourceRoot,Index> entry : indexes.entrySet()) {
      AnnotationRepository repository=new JandexAnnotationRepositoryImpl(entry.getValue(),classLoader);
      cmd=annotator.merge(cmd,repository,classLoader);
    }
    if (cmd != null) {
      cmd.validate();
      cmd=(new Merger()).mergeConnectorWithCommonIronJacamar(ijmd,cmd);
    }
    final ResourceAdapterDeploymentService raDeployementService=new ResourceAdapterDeploymentService(connectorXmlDescriptor,cmd,ijmd,module);
    final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
    serviceTarget.addService(ConnectorServices.RESOURCE_ADAPTER_SERVICE_PREFIX.append(connectorXmlDescriptor.getDeploymentName()),raDeployementService).addDependency(ConnectorServices.IRONJACAMAR_MDR,MetadataRepository.class,raDeployementService.getMdrInjector()).addDependency(ConnectorServices.RA_REPOSISTORY_SERVICE,ResourceAdapterRepository.class,raDeployementService.getRaRepositoryInjector()).addDependency(ConnectorServices.RESOURCE_ADAPTER_REGISTRY_SERVICE,ResourceAdapterDeploymentRegistry.class,raDeployementService.getRegistryInjector()).addDependency(ConnectorServices.JNDI_STRATEGY_SERVICE,JndiStrategy.class,raDeployementService.getJndiInjector()).addDependency(TxnServices.JBOSS_TXN_ARJUNA_TRANSACTION_MANAGER,com.arjuna.ats.jbossatx.jta.TransactionManagerService.class,raDeployementService.getTxmInjector()).addDependency(ConnectorServices.CONNECTOR_CONFIG_SERVICE,ConnectorSubsystemConfiguration.class,raDeployementService.getConfigInjector()).addDependency(NamingService.SERVICE_NAME).setInitialMode(Mode.ACTIVE).install();
  }
 catch (  Throwable t) {
    throw new DeploymentUnitProcessingException(t);
  }
}
