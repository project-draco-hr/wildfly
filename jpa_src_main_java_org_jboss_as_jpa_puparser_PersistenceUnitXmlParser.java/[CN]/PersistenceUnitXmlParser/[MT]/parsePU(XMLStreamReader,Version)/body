{
  PersistenceUnitMetadata pu=new PersistenceUnitMetadata();
  List<String> classes=new ArrayList<String>(1);
  List<String> jarfiles=new ArrayList<String>(1);
  List<String> mappingFiles=new ArrayList<String>(1);
  Properties properties=new Properties();
  pu.setTransactionType(PersistenceUnitTransactionType.JTA);
  pu.setValidationMode(ValidationMode.AUTO);
  pu.setSharedCacheMode(SharedCacheMode.UNSPECIFIED);
  pu.setPersistenceProviderClassName("org.hibernate.ejb.HibernatePersistence");
  if (version.equals(Version.JPA_1_0)) {
    pu.setPersistenceXMLSchemaVersion("1.0");
  }
 else {
    pu.setPersistenceXMLSchemaVersion("2.0");
  }
  final int count=reader.getAttributeCount();
  for (int i=0; i < count; i++) {
    final String value=reader.getAttributeValue(i);
    if (traceEnabled) {
      log.trace("parse persistence.xml: attribute value(" + i + ") = "+ value);
    }
    final String attributeNamespace=reader.getAttributeNamespace(i);
    if (attributeNamespace != null && !attributeNamespace.isEmpty()) {
      continue;
    }
    final Attribute attribute=Attribute.forName(reader.getAttributeLocalName(i));
switch (attribute) {
case NAME:
      pu.setPersistenceUnitName(value);
    break;
case TRANSACTIONTYPE:
  if (value.equalsIgnoreCase("RESOURCE_LOCAL"))   pu.setTransactionType(PersistenceUnitTransactionType.RESOURCE_LOCAL);
break;
default :
throw unexpectedAttribute(reader,i);
}
}
while (reader.hasNext() && reader.nextTag() != END_ELEMENT) {
final Element element=Element.forName(reader.getLocalName());
if (traceEnabled) {
log.trace("parse persistence.xml: element=" + element.getLocalName());
}
switch (element) {
case CLASS:
classes.add(reader.getElementText());
break;
case DESCRIPTION:
final String description=reader.getElementText();
break;
case EXCLUDEUNLISTEDCLASSES:
String text=reader.getElementText();
if (text == null || text.isEmpty()) {
pu.setExcludeUnlistedClasses(true);
}
 else {
pu.setExcludeUnlistedClasses(Boolean.valueOf(text));
}
break;
case JARFILE:
String file=reader.getElementText();
jarfiles.add(file);
break;
case JTADATASOURCE:
pu.setJtaDataSourceName(reader.getElementText());
break;
case NONJTADATASOURCE:
pu.setNonJtaDataSourceName(reader.getElementText());
break;
case MAPPINGFILE:
mappingFiles.add(reader.getElementText());
break;
case PROPERTIES:
parseProperties(reader,properties);
break;
case PROVIDER:
pu.setPersistenceProviderClassName(reader.getElementText());
break;
case SHAREDCACHEMODE:
String cm=reader.getElementText();
pu.setSharedCacheMode(SharedCacheMode.valueOf(cm));
break;
case VALIDATIONMODE:
String validationMode=reader.getElementText();
pu.setValidationMode(ValidationMode.valueOf(validationMode));
break;
default :
throw unexpectedElement(reader);
}
}
if (traceEnabled) {
log.trace("parse persistence.xml: reached ending persistence-unit tag");
}
pu.setManagedClassNames(classes);
pu.setJarFiles(jarfiles);
pu.setMappingFiles(mappingFiles);
pu.setProperties(properties);
return pu;
}
