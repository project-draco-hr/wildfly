{
  DomainUpdateApplierResponse response=processUpdate();
  final Marshaller marshaller=getMarshaller();
  marshaller.start(createByteOutput(output));
  marshaller.writeByte(DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT);
  if (response.getDomainFailure() != null) {
    marshaller.writeByte(DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
    marshaller.writeObject(response.getDomainFailure());
  }
 else {
    marshaller.writeByte(DomainClientProtocol.APPLY_UPDATE_RESULT_DOMAIN_MODEL_SUCCESS);
    marshaller.writeByte(DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_HOST_FAILURE_COUNT);
    Map<String,UpdateFailedException> hostFailures=response.getHostFailures();
    if (hostFailures == null || hostFailures.size() == 0) {
      marshaller.writeInt(0);
    }
 else {
      marshaller.writeInt(hostFailures.size());
      for (      Map.Entry<String,UpdateFailedException> entry : hostFailures.entrySet()) {
        marshaller.writeByte(DomainClientProtocol.PARAM_HOST_NAME);
        marshaller.writeUTF(entry.getKey());
        marshaller.writeByte(DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_EXCEPTION);
        marshaller.writeObject(entry.getValue());
      }
    }
    marshaller.writeByte(DomainClientProtocol.PARAM_APPLY_UPDATE_RESULT_SERVER_COUNT);
    List<ServerIdentity> servers=response.getServers();
    if (servers == null || servers.size() == 0) {
      marshaller.writeInt(0);
    }
 else {
      marshaller.writeInt(servers.size());
      for (      ServerIdentity server : servers) {
        marshaller.writeByte(DomainClientProtocol.PARAM_HOST_NAME);
        marshaller.writeUTF(server.getHostName());
        marshaller.writeByte(DomainClientProtocol.PARAM_SERVER_GROUP_NAME);
        marshaller.writeUTF(server.getServerGroupName());
        marshaller.writeByte(DomainClientProtocol.PARAM_SERVER_NAME);
        marshaller.writeUTF(server.getServerName());
      }
    }
  }
  marshaller.finish();
}
