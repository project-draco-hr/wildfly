{
  StringConfigurationPersister persister=new StringConfigurationPersister(Collections.<ModelNode>emptyList(),testParser);
  ExtensionRegistry outputExtensionRegistry=new ExtensionRegistry(ProcessType.EMBEDDED_SERVER,new RunningModeControl(RunningMode.NORMAL));
  outputExtensionRegistry.setSubsystemParentResourceRegistrations(MOCK_RESOURCE_REG,MOCK_RESOURCE_REG);
  outputExtensionRegistry.setWriterRegistry(persister);
  Extension extension=mainExtension.getClass().newInstance();
  extension.initialize(outputExtensionRegistry.getExtensionContext("Test"));
  ConfigurationPersister.PersistenceResource resource=persister.store(model,Collections.<PathAddress>emptySet());
  resource.commit();
  return persister.marshalled;
}
