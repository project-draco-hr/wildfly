{
  if (ignoredChildAddresses == null) {
    ignoredChildAddresses=Collections.<PathAddress>emptySet();
  }
 else {
    PathAddress subsystem=PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,mainSubsystemName));
    Assert.assertFalse("Cannot exclude removal of subsystem itself",ignoredChildAddresses.contains(subsystem));
  }
  Resource rootResource=grabRootResource(kernelServices);
  List<PathAddress> addresses=new ArrayList<PathAddress>();
  PathAddress pathAddress=PathAddress.pathAddress(PathElement.pathElement(SUBSYSTEM,mainSubsystemName));
  Resource subsystemResource=rootResource.getChild(pathAddress.getLastElement());
  Assert.assertNotNull(subsystemResource);
  addresses.add(pathAddress);
  getAllChildAddressesForRemove(pathAddress,addresses,subsystemResource);
  ModelNode composite=new ModelNode();
  composite.get(OP).set(CompositeOperationHandler.NAME);
  composite.get(OP_ADDR).setEmptyList();
  composite.get("rollback-on-runtime-failure").set(true);
  for (ListIterator<PathAddress> iterator=addresses.listIterator(addresses.size()); iterator.hasPrevious(); ) {
    PathAddress cur=iterator.previous();
    if (!ignoredChildAddresses.contains(cur)) {
      ModelNode remove=new ModelNode();
      remove.get(OP).set(REMOVE);
      remove.get(OP_ADDR).set(cur.toModelNode());
      composite.get("steps").add(remove);
    }
  }
  ModelNode result=kernelServices.executeOperation(composite);
  ModelNode model=kernelServices.readWholeModel().get(SUBSYSTEM,mainSubsystemName);
  Assert.assertFalse("Subsystem resources were not removed " + model,model.isDefined());
}
