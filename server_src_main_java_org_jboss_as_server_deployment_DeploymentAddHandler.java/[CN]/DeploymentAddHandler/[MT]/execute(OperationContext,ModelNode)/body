{
  if (!operation.hasDefined(PERSISTENT.getName())) {
    operation.get(PERSISTENT.getName()).set(true);
  }
  final Resource resource=context.createResource(PathAddress.EMPTY_ADDRESS);
  ModelNode newModel=resource.getModel();
  for (  AttributeDefinition def : SERVER_ADD_ATTRIBUTES) {
    if (!def.getName().equals(CONTENT_ALL.getName())) {
      def.validateAndSet(operation,newModel);
    }
 else {
      def.validateOperation(operation);
    }
  }
  ModelNode content=operation.require(CONTENT_ALL.getName());
  ModelNode contentItemNode=content.require(0);
  final ModelNode opAddr=operation.get(OP_ADDR);
  PathAddress address=PathAddress.pathAddress(opAddr);
  final String name=address.getLastElement().getValue();
  final String runtimeName=operation.hasDefined(RUNTIME_NAME.getName()) ? operation.get(RUNTIME_NAME.getName()).asString() : name;
  newModel.get(RUNTIME_NAME.getName()).set(runtimeName);
  final DeploymentHandlerUtil.ContentItem contentItem;
  if (contentItemNode.hasDefined(CONTENT_HASH.getName())) {
    byte[] hash=contentItemNode.require(CONTENT_HASH.getName()).asBytes();
    contentItem=addFromHash(hash,name,context);
  }
 else   if (hasValidContentAdditionParameterDefined(contentItemNode)) {
    contentItem=addFromContentAdditionParameter(context,contentItemNode);
    contentItemNode=new ModelNode();
    contentItemNode.get(CONTENT_HASH.getName()).set(contentItem.getHash());
    content=new ModelNode();
    content.add(contentItemNode);
  }
 else {
    contentItem=addUnmanaged(contentItemNode);
  }
  newModel.get(CONTENT_ALL.getName()).set(content);
  if (ENABLED.resolveModelAttribute(context,newModel).asBoolean() && context.isNormalServer()) {
    DeploymentHandlerUtil.deploy(context,runtimeName,name,vaultReader,contentItem);
  }
  context.completeStep();
}
