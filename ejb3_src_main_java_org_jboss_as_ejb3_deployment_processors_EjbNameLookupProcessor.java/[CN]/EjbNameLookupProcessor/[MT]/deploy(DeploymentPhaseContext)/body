{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final DeploymentUnit parent=deploymentUnit.getParent() == null ? deploymentUnit : deploymentUnit.getParent();
  final List<DeploymentUnit> subDeployments=parent.getAttachmentList(Attachments.SUB_DEPLOYMENTS);
  if (deploymentUnit.getParent() == null && !subDeployments.isEmpty()) {
    return;
  }
  final Set<DeploymentUnit> allDeploymentUnits=new HashSet<DeploymentUnit>();
  allDeploymentUnits.add(parent);
  allDeploymentUnits.addAll(subDeployments);
  final EjbLookup.Builder builder=EjbLookup.builder(deploymentUnit);
  for (  final DeploymentUnit deployment : allDeploymentUnits) {
    final Module module=deployment.getAttachment(Attachments.MODULE);
    if (module == null) {
      continue;
    }
    final ModuleClassLoader classLoader=module.getClassLoader();
    final EEModuleDescription eeModuleDescription=deployment.getAttachment(org.jboss.as.ee.component.Attachments.EE_MODULE_DESCRIPTION);
    for (    final ComponentDescription componentDescription : eeModuleDescription.getComponentDescriptions()) {
      if (componentDescription instanceof EJBComponentDescription) {
        builder.addEjb(deployment,(EJBComponentDescription)componentDescription,classLoader);
      }
    }
  }
  deploymentUnit.putAttachment(EjbDeploymentAttachmentKeys.EJB_LOOKUP,builder.build());
}
