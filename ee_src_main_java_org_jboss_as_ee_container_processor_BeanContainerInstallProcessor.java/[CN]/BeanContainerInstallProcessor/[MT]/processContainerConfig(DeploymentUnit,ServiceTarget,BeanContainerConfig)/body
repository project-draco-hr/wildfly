{
  final BeanContainerFactory containerFactory=containerConfig.getContainerFactory();
  final ResourceInjectionResolver resolver=containerFactory.getResourceInjectionResolver();
  final List<ResourceInjection> injections=new ArrayList<ResourceInjection>(containerConfig.getResourceInjectionConfigs().length);
  final Set<ResourceInjectionResolver.ResolverDependency<?>> resourceDependencies=new HashSet<ResourceInjectionResolver.ResolverDependency<?>>();
  for (  ResourceInjectionConfiguration resourceConfiguration : containerConfig.getResourceInjectionConfigs()) {
    final ResourceInjectionResolver.ResolverResult result=resolver.resolve(deploymentUnit,containerConfig,resourceConfiguration);
    resourceDependencies.addAll(result.getDependencies());
    injections.add(result.getInjection());
    if (result.shouldBind()) {
      resourceDependencies.add(bindResource(serviceTarget,result));
    }
  }
  final MethodInterceptorFactory methodInterceptorFactory=containerFactory.getMethodInterceptorFactory();
  final List<MethodInterceptor> interceptors=new ArrayList<MethodInterceptor>(containerConfig.getMethodInterceptorConfigs().length);
  for (  MethodInterceptorConfiguration interceptorConfiguration : containerConfig.getMethodInterceptorConfigs()) {
    final List<ResourceInjection> interceptorInjections=new ArrayList<ResourceInjection>(interceptorConfiguration.getResourceConfigurations().size());
    for (    ResourceInjectionConfiguration resourceConfiguration : interceptorConfiguration.getResourceConfigurations()) {
      final ResourceInjectionResolver.ResolverResult result=resolver.resolve(deploymentUnit,containerConfig,resourceConfiguration);
      resourceDependencies.addAll(result.getDependencies());
      interceptorInjections.add(result.getInjection());
      if (result.shouldBind()) {
        resourceDependencies.add(bindResource(serviceTarget,result));
      }
    }
    interceptors.add(methodInterceptorFactory.createInterceptor(deploymentUnit,interceptorConfiguration,interceptorInjections));
  }
  final BeanContainerFactory.ConstructedBeanContainer constructedContainer=containerFactory.createBeanContainer(deploymentUnit,containerConfig,injections,interceptors);
  final ServiceName beanEnvContextServiceName=constructedContainer.getEnvContextServiceName().append(containerConfig.getName());
  final ContextService actualBeanContext=new ContextService(containerConfig.getName());
  serviceTarget.addService(beanEnvContextServiceName,actualBeanContext).addDependency(constructedContainer.getEnvContextServiceName(),Context.class,actualBeanContext.getParentContextInjector()).install();
  final ServiceName bindContextServiceName=constructedContainer.getBindContextServiceName();
  final Reference containerFactoryReference=ServiceReferenceObjectFactory.createReference(constructedContainer.getContainerServiceName(),BeanContainerObjectFactory.class);
  final ResourceBinder<Reference> factoryBinder=new ResourceBinder<Reference>(constructedContainer.getBindName(),Values.immediateValue(containerFactoryReference));
  final ServiceName referenceBinderName=bindContextServiceName.append(constructedContainer.getBindName());
  serviceTarget.addService(referenceBinderName,factoryBinder).addDependency(bindContextServiceName,Context.class,factoryBinder.getContextInjector()).setInitialMode(ServiceController.Mode.ON_DEMAND).install();
  final ServiceBuilder<?> serviceBuilder=serviceTarget.addService(constructedContainer.getContainerServiceName(),new BeanContainerService(constructedContainer.getBeanContainer())).addDependency(referenceBinderName).setInitialMode(ServiceController.Mode.ACTIVE);
  for (  ResourceInjectionResolver.ResolverDependency<?> resolverDependency : resourceDependencies) {
    addDependency(serviceBuilder,resolverDependency);
  }
  serviceBuilder.install();
}
