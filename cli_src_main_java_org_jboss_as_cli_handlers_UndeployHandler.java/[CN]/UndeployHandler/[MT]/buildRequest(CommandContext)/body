{
  ModelNode composite=new ModelNode();
  composite.get("operation").set("composite");
  composite.get("address").setEmptyList();
  ModelNode steps=composite.get("steps");
  final ParsedArguments args=ctx.getParsedArguments();
  final String name=this.name.getValue(args);
  if (name == null) {
    throw new OperationFormatException("Required argument name are missing.");
  }
  DefaultOperationRequestBuilder builder;
  if (ctx.isDomainMode()) {
    final List<String> serverGroups;
    if (allServerGroups.isPresent(args)) {
      serverGroups=Util.getServerGroups(ctx.getModelControllerClient());
    }
 else {
      String serverGroupsStr=this.serverGroups.getValue(args);
      if (serverGroupsStr == null) {
        new OperationFormatException("Either --all-server-groups or --server-groups must be specified.");
      }
      serverGroups=Arrays.asList(serverGroupsStr.split(","));
    }
    if (serverGroups.isEmpty()) {
      new OperationFormatException("No server group is available.");
    }
    for (    String group : serverGroups) {
      ModelNode groupStep=Util.configureDeploymentOperation(DEPLOYMENT_UNDEPLOY_OPERATION,name,group);
      steps.add(groupStep);
    }
    for (    String group : serverGroups) {
      ModelNode groupStep=Util.configureDeploymentOperation(DEPLOYMENT_REMOVE_OPERATION,name,group);
      steps.add(groupStep);
    }
  }
 else {
    builder=new DefaultOperationRequestBuilder();
    builder.setOperationName("undeploy");
    builder.addNode("deployment",name);
    steps.add(builder.buildRequest());
  }
  builder=new DefaultOperationRequestBuilder();
  builder.setOperationName("remove");
  builder.addNode("deployment",name);
  steps.add(builder.buildRequest());
  return composite;
}
