{
  SessionManagerConfiguration config=this.config.getSessionManagerConfiguration();
  Module module=config.getModule();
  MarshallingContext marshallingContext=new SimpleMarshallingContextFactory().createMarshallingContext(new SessionAttributeMarshallingContext(module),module.getClassLoader());
  MarshalledValueFactory<MarshallingContext> factory=new SimpleMarshalledValueFactory(marshallingContext);
switch (config.getAttributePersistenceStrategy()) {
case FINE:
{
      Cache<String,FineSessionCacheEntry<L>> sessionCache=this.config.getCache();
      Cache<SessionAttributeCacheKey,MarshalledValue<Object,MarshallingContext>> attributeCache=this.config.getCache();
      Marshaller<Object,MarshalledValue<Object,MarshallingContext>> marshaller=new MarshalledValueMarshaller<>(factory,marshallingContext);
      return new FineSessionFactory<>(sessionCache,attributeCache,context,marshaller,localContextFactory);
    }
case COARSE:
{
    Cache<String,CoarseSessionCacheEntry<L>> sessionCache=this.config.getCache();
    Cache<SessionAttributesCacheKey,MarshalledValue<Map<String,Object>,MarshallingContext>> attributesCache=this.config.getCache();
    Marshaller<Map<String,Object>,MarshalledValue<Map<String,Object>,MarshallingContext>> marshaller=new MarshalledValueMarshaller<>(factory,marshallingContext);
    return new CoarseSessionFactory<>(sessionCache,attributesCache,context,marshaller,localContextFactory);
  }
default :
{
  throw new IllegalStateException();
}
}
}
