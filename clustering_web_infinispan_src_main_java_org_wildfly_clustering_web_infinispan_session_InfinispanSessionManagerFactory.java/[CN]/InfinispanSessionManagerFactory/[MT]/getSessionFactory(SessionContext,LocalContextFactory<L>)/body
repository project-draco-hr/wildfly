{
  MarshallingContext marshallingContext=new SimpleMarshallingContextFactory().createMarshallingContext(new SessionAttributeMarshallingContext(this.module),this.module.getClassLoader());
  MarshalledValueFactory<MarshallingContext> factory=new SimpleMarshalledValueFactory(marshallingContext);
switch (this.metaData.getReplicationConfig().getReplicationGranularity()) {
case ATTRIBUTE:
{
      Cache<String,FineSessionCacheEntry<L>> sessionCache=this.cache.getValue();
      Cache<SessionAttributeCacheKey,MarshalledValue<Object,MarshallingContext>> attributeCache=this.cache.getValue();
      SessionAttributeMarshaller<Object,MarshalledValue<Object,MarshallingContext>> marshaller=new MarshalledValueSessionAttributeMarshaller<>(factory,marshallingContext);
      return new FineSessionFactory<>(sessionCache,attributeCache,this.invoker,context,marshaller,localContextFactory);
    }
case SESSION:
{
    Cache<String,CoarseSessionCacheEntry<L>> sessionCache=this.cache.getValue();
    Cache<SessionAttributesCacheKey,MarshalledValue<Map<String,Object>,MarshallingContext>> attributesCache=this.cache.getValue();
    SessionAttributeMarshaller<Map<String,Object>,MarshalledValue<Map<String,Object>,MarshallingContext>> marshaller=new MarshalledValueSessionAttributeMarshaller<>(factory,marshallingContext);
    return new CoarseSessionFactory<>(sessionCache,attributesCache,this.invoker,context,marshaller,localContextFactory);
  }
default :
{
  throw InfinispanWebMessages.MESSAGES.unknownReplicationGranularity(this.metaData.getReplicationConfig().getReplicationGranularity());
}
}
}
