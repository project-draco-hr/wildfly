{
  MarshallingContext marshallingContext=new MarshallingContext(this.context);
  MarshalledValueFactory<MarshallingContext> factory=new SimpleMarshalledValueFactory(marshallingContext);
switch (this.metaData.getReplicationConfig().getReplicationGranularity()) {
case ATTRIBUTE:
{
      @SuppressWarnings("unchecked") Cache<String,FineSessionCacheEntry<L>> sessionCache=(Cache<String,FineSessionCacheEntry<L>>)cache;
      @SuppressWarnings("unchecked") Cache<SessionAttributeCacheKey,MarshalledValue<Object,MarshallingContext>> attributeCache=(Cache<SessionAttributeCacheKey,MarshalledValue<Object,MarshallingContext>>)cache;
      SessionAttributeMarshaller<Object,MarshalledValue<Object,MarshallingContext>> marshaller=new MarshalledValueSessionAttributeMarshaller<>(factory,marshallingContext);
      return new FineSessionFactory<L>(sessionCache,attributeCache,this.invoker,context,marshaller,localContextFactory);
    }
case SESSION:
{
    @SuppressWarnings("unchecked") Cache<String,CoarseSessionCacheEntry<L>> sessionCache=(Cache<String,CoarseSessionCacheEntry<L>>)cache;
    @SuppressWarnings("unchecked") Cache<SessionAttributesCacheKey,MarshalledValue<Map<String,Object>,MarshallingContext>> attributesCache=(Cache<SessionAttributesCacheKey,MarshalledValue<Map<String,Object>,MarshallingContext>>)cache;
    SessionAttributeMarshaller<Map<String,Object>,MarshalledValue<Map<String,Object>,MarshallingContext>> marshaller=new MarshalledValueSessionAttributeMarshaller<>(factory,marshallingContext);
    return new CoarseSessionFactory<L>(sessionCache,attributesCache,this.invoker,context,marshaller,localContextFactory);
  }
default :
{
  throw InfinispanWebMessages.MESSAGES.unknownReplicationGranularity(this.metaData.getReplicationConfig().getReplicationGranularity());
}
}
}
