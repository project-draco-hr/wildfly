{
  Configuration config=this.config.getCache().getCacheConfiguration();
  boolean transactional=config.transaction().transactionMode().isTransactional();
  boolean lockOnWrite=transactional && (config.transaction().lockingMode() == LockingMode.PESSIMISTIC);
  boolean lockOnRead=lockOnWrite && (config.locking().isolationLevel() == IsolationLevel.REPEATABLE_READ);
  boolean requireMarshallable=config.clustering().cacheMode().needsStateTransfer() || config.persistence().usingStores();
  SessionMetaDataFactory<InfinispanSessionMetaData<L>,L> metaDataFactory=new InfinispanSessionMetaDataFactory<>(this.config.getCache(),transactional,lockOnRead,lockOnWrite);
  return new InfinispanSessionFactory<>(metaDataFactory,this.createSessionAttributesFactory(lockOnRead,requireMarshallable),localContextFactory);
}
