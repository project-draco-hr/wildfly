{
  final Batcher batcher=new InfinispanBatcher(this.cache.getValue());
  final IdentifierFactory<String> factory=new AffinityIdentifierFactory<>(identifierFactory,this.cache.getValue(),this.affinityFactory.getValue());
  final Cache<String,?> cache=this.cache.getValue();
  final CommandDispatcherFactory dispatcherFactory=this.dispatcherFactory.getValue();
  final NodeFactory<Address> nodeFactory=this.nodeFactory.getValue();
  final int maxActiveSessions=this.config.getMaxActiveSessions();
  InfinispanSessionManagerConfiguration config=new InfinispanSessionManagerConfiguration(){
    @Override public SessionContext getSessionContext(){
      return context;
    }
    @Override public Cache<String,?> getCache(){
      return cache;
    }
    @Override public IdentifierFactory<String> getIdentifierFactory(){
      return factory;
    }
    @Override public Batcher getBatcher(){
      return batcher;
    }
    @Override public CommandDispatcherFactory getCommandDispatcherFactory(){
      return dispatcherFactory;
    }
    @Override public NodeFactory<Address> getNodeFactory(){
      return nodeFactory;
    }
    @Override public int getMaxActiveSessions(){
      return maxActiveSessions;
    }
  }
;
  return new InfinispanSessionManager<>(this.getSessionFactory(context,localContextFactory),config);
}
