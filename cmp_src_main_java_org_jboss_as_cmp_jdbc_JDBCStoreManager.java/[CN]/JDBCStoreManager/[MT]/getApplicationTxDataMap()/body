{
  Map<Transaction,Map<Object,Object>> txDataMap=(Map<Transaction,Map<Object,Object>>)deploymentUnit.getAttachment(TX_DATA_MAP);
  if (txDataMap == null) {
    txDataMap=new HashMap<Transaction,Map<Object,Object>>();
    deploymentUnit.putAttachment(TX_DATA_MAP,txDataMap);
  }
  try {
    Transaction tx=tm.getTransaction();
    if (tx == null) {
      return null;
    }
    Map<Object,Object> txMap=txDataMap.get(tx);
    if (txMap == null) {
      int status=tx.getStatus();
      if (status == Status.STATUS_ACTIVE || status == Status.STATUS_PREPARING) {
        txMap=new HashMap<Object,Object>();
        txDataMap.put(tx,txMap);
      }
    }
    return txMap;
  }
 catch (  EJBException e) {
    throw e;
  }
catch (  Exception e) {
    throw new EJBException("Error getting application tx data map.",e);
  }
}
