{
  Archive<?> targetArchive=deploymentProvider.getClientDeployment(TARGET_MODULE_NAME);
  String targetDeploymentName=archiveDeployer.deploy(targetArchive);
  assertNotNull("Deployment name not null",targetDeploymentName);
  try {
    ServiceName targetService=ServiceName.parse("jboss.osgi.example.target.service");
    assertServiceState(targetService,State.UP,5000);
    Bundle targetBundle=registerModule(ModuleIdentifier.create("deployment." + targetDeploymentName));
    try {
      assertEquals("Bundle INSTALLED",Bundle.INSTALLED,targetBundle.getState());
      InputStream input=deploymentProvider.getClientDeploymentAsStream(CLIENT_BUNDLE_NAME);
      Bundle clientBundle=context.installBundle(CLIENT_BUNDLE_NAME,input);
      assertEquals("Bundle INSTALLED",Bundle.INSTALLED,clientBundle.getState());
      try {
        clientBundle.start();
        assertEquals("Bundle ACTIVE",Bundle.ACTIVE,clientBundle.getState());
      }
  finally {
        clientBundle.uninstall();
      }
    }
  finally {
      targetBundle.uninstall();
    }
  }
  finally {
    archiveDeployer.undeploy(targetDeploymentName);
  }
}
