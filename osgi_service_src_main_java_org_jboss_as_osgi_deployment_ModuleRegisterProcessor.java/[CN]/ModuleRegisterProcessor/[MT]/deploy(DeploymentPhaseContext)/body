{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final XBundle bundle=depUnit.getAttachment(Attachments.INSTALLED_BUNDLE);
  final Module module=depUnit.getAttachment(Attachments.MODULE);
  final ModuleSpecification moduleSpecification=depUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
  if (bundle == null && module != null && moduleSpecification.isPrivateModule() == false) {
    LOGGER.infoRegisterModule(module.getIdentifier());
    try {
      final BundleContext context=depUnit.getAttachment(Attachments.SYSTEM_CONTEXT);
      XBundleRevisionBuilderFactory factory=new XBundleRevisionBuilderFactory(){
        @Override public XBundleRevision createResource(){
          return new AbstractBundleRevisionAdaptor(context,module);
        }
      }
;
      OSGiMetaData metadata=depUnit.getAttachment(Attachments.OSGI_METADATA);
      XEnvironment env=depUnit.getAttachment(OSGiConstants.ENVIRONMENT_KEY);
      XResourceBuilder builder=XBundleRevisionBuilderFactory.create(factory);
      if (metadata != null) {
        builder.loadFrom(metadata);
      }
 else {
        builder.loadFrom(module);
      }
      XBundleRevision brev=(XBundleRevision)builder.getResource();
      env.installResources(brev);
      depUnit.putAttachment(OSGiConstants.REGISTERED_MODULE_KEY,brev);
    }
 catch (    Throwable th) {
      throw MESSAGES.deploymentFailedToRegisterModule(th,module);
    }
  }
}
