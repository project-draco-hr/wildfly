{
synchronized (tx) {
    TransactionLocalSynchronization result=synchronizationsByTransaction.get(tx);
    if (result == null && create == true) {
      result=new TransactionLocalSynchronization(tx);
      try {
        tx.registerSynchronization(result);
      }
 catch (      RollbackException e) {
        throw new IllegalStateException("Transaction already rolled back or marked for rollback");
      }
catch (      SystemException e) {
        throw new RuntimeException("Error registering transaction synchronization with " + tx,e);
      }
      synchronizationsByTransaction.put(tx,result);
    }
    return result;
  }
}
