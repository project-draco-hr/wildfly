{
  final String deploymentName=PathAddress.pathAddress(operation.require(OP_ADDR)).getLastElement().getValue();
  final ModelNode root=context.getModel();
  if (root.hasDefined(SERVER_GROUP)) {
    List<String> badGroups=new ArrayList<String>();
    for (    Property prop : root.get(SERVER_GROUP).asPropertyList()) {
      ModelNode sg=prop.getValue();
      if (sg.hasDefined(DEPLOYMENT) && sg.get(DEPLOYMENT).has(deploymentName)) {
        badGroups.add(prop.getName());
      }
    }
    if (badGroups.size() > 0) {
      String msg=String.format("Cannot remove deployment %s from the domain as it is still used by server groups %s",deploymentName,badGroups);
      throw new OperationFailedException(new ModelNode().set(msg));
    }
  }
  super.performRemove(context,operation,model);
}
