{
  BundleContext context=getBundleContext();
  ServiceReference sref=context.getServiceReference(StartLevel.class.getName());
  StartLevel startLevel=(StartLevel)context.getService(sref);
  final CountDownLatch latch=new CountDownLatch(1);
  context.addFrameworkListener(new FrameworkListener(){
    public void frameworkEvent(    FrameworkEvent event){
      if (event.getType() == FrameworkEvent.STARTLEVEL_CHANGED) {
        latch.countDown();
      }
    }
  }
);
  startLevel.setStartLevel(level);
  if (latch.await(timeout,units) == false)   throw new TimeoutException("Timeout changing start level");
}
