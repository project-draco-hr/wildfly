{
  ModelControllerClient client=FrameworkUtils.waitForService(context,ModelControllerClient.class);
  ServerDeploymentHelper server=new ServerDeploymentHelper(client);
  InputStream input=deployer.getDeployment(GOOD_FRAGMENT);
  String fragmentName=server.deploy("bundle-fragment-attached",input);
  Bundle fragment=context.getBundle(GOOD_FRAGMENT);
  Assert.assertEquals("Bundle INSTALLED",Bundle.INSTALLED,fragment.getState());
  input=deployer.getDeployment(GOOD_BUNDLE);
  String hostName=server.deploy("bundle-host-attached",input);
  Bundle host=context.getBundle(GOOD_BUNDLE);
  Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,host.getState());
  Assert.assertEquals("Bundle RESOLVED",Bundle.RESOLVED,fragment.getState());
  Class<?> clazz=host.loadClass("org.jboss.as.test.integration.osgi.deployment.bundle.AttachedType");
  Assert.assertNotNull("Class not null",clazz);
  Assert.assertSame(host,((BundleReference)clazz.getClassLoader()).getBundle());
  server.undeploy(fragmentName);
  Assert.assertEquals("Bundle UNINSTALLED",Bundle.UNINSTALLED,fragment.getState());
  server.undeploy(hostName);
  Assert.assertEquals("Bundle UNINSTALLED",Bundle.UNINSTALLED,host.getState());
}
