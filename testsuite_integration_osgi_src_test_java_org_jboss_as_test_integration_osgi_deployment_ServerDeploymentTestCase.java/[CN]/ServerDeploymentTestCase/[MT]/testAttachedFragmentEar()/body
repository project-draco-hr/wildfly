{
  ModelControllerClient client=FrameworkUtils.waitForService(context,ModelControllerClient.class);
  ServerDeploymentHelper server=new ServerDeploymentHelper(client);
  InputStream input=deployer.getDeployment(GOOD_FRAGMENT_EAR);
  String earName=server.deploy(GOOD_FRAGMENT_EAR,input);
  Bundle fragment=packageAdmin.getBundles(GOOD_FRAGMENT,null)[0];
  Assert.assertEquals("Bundle RESOLVED",Bundle.RESOLVED,fragment.getState());
  Bundle host=packageAdmin.getBundles(GOOD_BUNDLE,null)[0];
  Assert.assertEquals("Bundle ACTIVE",Bundle.ACTIVE,host.getState());
  Class<?> clazz=host.loadClass("org.jboss.as.test.integration.osgi.deployment.bundle.AttachedType");
  Assert.assertNotNull("Class not null",clazz);
  Assert.assertSame(host,((BundleReference)clazz.getClassLoader()).getBundle());
  server.undeploy(earName);
  Assert.assertEquals("Bundle UNINSTALLED",Bundle.UNINSTALLED,fragment.getState());
  Assert.assertEquals("Bundle UNINSTALLED",Bundle.UNINSTALLED,host.getState());
}
