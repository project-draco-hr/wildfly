{
  stopped=true;
  Map<String,ProcessInfo> processInfoMap=determineRunningProcesses();
  for (  String serverProcessName : processInfoMap.keySet()) {
    if (ManagedServer.isServerProcess(serverProcessName)) {
      String serverName=ManagedServer.getServerName(serverProcessName);
      stopServer(serverName,gracefulTimeout);
    }
  }
  if (blockUntilStopped) {
synchronized (shutdownCondition) {
      for (; ; ) {
        int count=0;
        try {
          processInfoMap=determineRunningProcesses();
        }
 catch (        RuntimeException e) {
          return;
        }
        for (        ManagedServer server : servers.values()) {
          final ProcessInfo info=processInfoMap.get(server.getServerProcessName());
switch (server.getState()) {
case FAILED:
case MAX_FAILED:
case STOPPED:
            break;
default :
          if (info != null) {
            count++;
          }
      }
    }
    if (count == 0) {
      break;
    }
    try {
      shutdownCondition.wait(500);
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      break;
    }
  }
}
}
}
