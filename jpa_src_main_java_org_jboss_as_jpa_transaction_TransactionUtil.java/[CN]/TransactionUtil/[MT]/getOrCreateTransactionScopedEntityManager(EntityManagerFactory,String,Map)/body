{
  EntityManager rtnSession=getPC(puScopedName);
  if (rtnSession == null) {
    rtnSession=EntityManagerUtil.createEntityManager(emf,properties);
    Transaction tx=getTransaction();
    if (log.isDebugEnabled())     log.debug(getEntityManagerDetails(rtnSession) + ": created entity managersession " + tx.toString());
    try {
      tx.registerSynchronization(new SessionSynchronization(rtnSession,tx,true,puScopedName));
    }
 catch (    RollbackException e) {
      throw new RuntimeException(e);
    }
catch (    SystemException e) {
      throw new RuntimeException(e);
    }
    setPC(puScopedName,rtnSession);
    rtnSession.joinTransaction();
  }
 else {
    if (log.isDebugEnabled()) {
      Transaction tx=getTransaction();
      log.debug(getEntityManagerDetails(rtnSession) + ": reuse entity managersession already in tx" + tx.toString());
    }
  }
  return rtnSession;
}
