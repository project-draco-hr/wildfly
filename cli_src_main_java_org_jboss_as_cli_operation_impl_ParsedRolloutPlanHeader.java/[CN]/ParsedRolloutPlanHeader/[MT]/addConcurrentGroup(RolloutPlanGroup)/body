{
  if (group == null) {
    throw new IllegalArgumentException("group is null");
  }
  if (planRef != null) {
    throw new IllegalStateException("Groups can't be added if the plan ref is specified.");
  }
  int lastIndex=groups == null ? -1 : groups.size() - 1;
  if (lastIndex < 0) {
    throw new IllegalStateException("There must be a group before a concurrent group can be added.");
  }
  RolloutPlanGroup lastGroup=groups.get(lastIndex);
  if (lastGroup instanceof ConcurrentRolloutPlanGroup) {
    ((ConcurrentRolloutPlanGroup)lastGroup).addGroup(group);
  }
 else {
    ConcurrentRolloutPlanGroup concurrent=new ConcurrentRolloutPlanGroup();
    concurrent.addGroup(lastGroup);
    concurrent.addGroup(group);
    groups.set(lastIndex,concurrent);
  }
  this.lastGroup=group;
}
