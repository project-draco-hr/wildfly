{
  ManagedDomainContainerConfiguration config=getContainerConfiguration();
  if (isServerRunning()) {
    if (config.isAllowConnectingToRunningServer()) {
      return;
    }
 else {
      failDueToRunning();
    }
  }
  try {
    List<String> additionalJavaOptsCmd=createAdditionalJavaOptsCmd(config);
    final String jbossHomeDir=config.getJbossHome();
    String serverBaseDir=getSystemPropertyValue(additionalJavaOptsCmd,"jboss.server.base.dir",jbossHomeDir + File.separatorChar + SERVER_BASE_DIR);
    if (config.isSetupCleanServerBaseDir() || config.getCleanServerBaseDir() != null) {
      final File cleanServerDirectories=setupCleanServerDirectories(serverBaseDir,jbossHomeDir,config.getCleanServerBaseDir());
      replaceSystemPropertyValue(additionalJavaOptsCmd,"jboss.server.base.dir",cleanServerDirectories.toString());
    }
    List<String> loggingOptsCmd=createLoggingOptsCmd(additionalJavaOptsCmd,jbossHomeDir,serverBaseDir);
    List<String> cmd=createCommandLine(config,additionalJavaOptsCmd,loggingOptsCmd);
    log.info("Starting container with: " + cmd.toString());
    ProcessBuilder processBuilder=new ProcessBuilder(cmd);
    processBuilder.redirectErrorStream(true);
    process=processBuilder.start();
    new Thread(new ConsoleConsumer()).start();
    final Process proc=process;
    shutdownThread=new Thread(new Runnable(){
      @Override public void run(){
        if (proc != null) {
          proc.destroy();
          try {
            proc.waitFor();
          }
 catch (          InterruptedException e) {
            throw new RuntimeException(e);
          }
        }
      }
    }
);
    Runtime.getRuntime().addShutdownHook(shutdownThread);
    long startupTimeout=getContainerConfiguration().getStartupTimeoutInSeconds();
    long timeout=startupTimeout * 1000;
    boolean serverAvailable=false;
    long sleep=1000;
    while (timeout > 0 && serverAvailable == false) {
      long before=System.currentTimeMillis();
      serverAvailable=getManagementClient().isDomainInRunningState();
      timeout-=(System.currentTimeMillis() - before);
      if (!serverAvailable) {
        if (processHasDied(proc))         break;
        Thread.sleep(sleep);
        timeout-=sleep;
        sleep=Math.max(sleep / 2,100);
      }
    }
    if (!serverAvailable) {
      destroyProcess();
      throw new TimeoutException(String.format("Managed Domain server was not started within [%d] s",config.getStartupTimeoutInSeconds()));
    }
  }
 catch (  Exception e) {
    throw new LifecycleException("Could not start container",e);
  }
}
