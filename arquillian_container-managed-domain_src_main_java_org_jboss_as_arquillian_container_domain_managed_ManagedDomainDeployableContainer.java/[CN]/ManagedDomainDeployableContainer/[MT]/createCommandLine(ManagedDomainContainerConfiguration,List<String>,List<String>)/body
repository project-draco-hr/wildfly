{
  final String jbossHomeDir=config.getJbossHome();
  String modulesPath=config.getModulePath();
  if (modulesPath == null || modulesPath.isEmpty()) {
    modulesPath=jbossHomeDir + File.separatorChar + "modules";
  }
  File modulesDir=new File(modulesPath);
  if (modulesDir.isDirectory() == false)   throw new IllegalStateException("Cannot find: " + modulesDir);
  String bundlesPath=modulesDir.getParent() + File.separator + "bundles";
  File bundlesDir=new File(bundlesPath);
  if (bundlesDir.isDirectory() == false)   throw new IllegalStateException("Cannot find: " + bundlesDir);
  File modulesJar=new File(jbossHomeDir + File.separatorChar + "jboss-modules.jar");
  if (!modulesJar.exists())   throw new IllegalStateException("Cannot find: " + modulesJar);
  List<String> cmd=new ArrayList<String>();
  String javaExec=config.getJavaHome() + File.separatorChar + "bin"+ File.separatorChar+ "java";
  if (config.getJavaHome().contains(" ")) {
    javaExec="\"" + javaExec + "\"";
  }
  cmd.add(javaExec);
  cmd.addAll(additionalJavaOptsCmd);
  if (config.isEnableAssertions()) {
    cmd.add("-ea");
  }
  cmd.add("-Djboss.home.dir=" + jbossHomeDir);
  cmd.addAll(loggingOptsCmd);
  cmd.add("-Djboss.bundles.dir=" + bundlesDir.getCanonicalPath());
  cmd.add("-Djboss.domain.default.config=" + config.getDomainConfig());
  cmd.add("-Djboss.host.default.config=" + config.getHostConfig());
  cmd.add("-jar");
  cmd.add(modulesJar.getAbsolutePath());
  cmd.add("-mp");
  cmd.add(modulesPath);
  cmd.add("org.jboss.as.process-controller");
  cmd.add("-jboss-home");
  cmd.add(jbossHomeDir);
  cmd.add("-jvm");
  cmd.add(javaExec);
  cmd.add("--");
  cmd.addAll(loggingOptsCmd);
  cmd.add("--");
  cmd.add("-default-jvm");
  cmd.add(javaExec);
  return cmd;
}
