{
  setSystemProperty("org.jboss.as.ejb3.EMBEDDED","true");
  String jbossHomeKey="jboss.home";
  String jbossHomeProp=System.getProperty(jbossHomeKey);
  if (jbossHomeProp == null)   throw MESSAGES.systemPropertyNotFound(jbossHomeKey);
  File jbossHomeDir=new File(jbossHomeProp);
  if (jbossHomeDir.isDirectory() == false)   throw MESSAGES.invalidJBossHome(jbossHomeProp);
  final boolean barren=Boolean.getBoolean("org.jboss.as.embedded.ejb3.BARREN");
  final StandaloneServer server;
  if (barren)   server=EmbeddedServerFactory.create(jbossHomeProp,null,null,"org.jboss.logmanager");
 else   server=EmbeddedServerFactory.create(Module.getContextModuleLoader(),jbossHomeDir);
  try {
    server.start();
    final JBossStandaloneEJBContainer container=new JBossStandaloneEJBContainer(server);
    boolean okay=false;
    try {
      container.init(properties);
      okay=true;
      return container;
    }
  finally {
      if (!okay)       container.close();
    }
  }
 catch (  RuntimeException e) {
    throw e;
  }
catch (  Exception e) {
    throw new EJBException(e);
  }
}
