{
  final JavaArchive archive=getSimpleArchive("module-with-xmodule");
  DeploymentUnitProcessor processor=new DeploymentUnitProcessor(){
    @Override public void processDeployment(    DeploymentUnitContext context) throws DeploymentUnitProcessingException {
      XResolverFactory factory=XResolverFactory.getInstance(getClass().getClassLoader());
      XModuleBuilder builder=factory.newModuleBuilder();
      builder.createModule(archive.getName(),Version.parseVersion("1.0.0"),0);
      builder.addBundleCapability("module-with-xmodule",Version.parseVersion("1.0.0"));
      XModuleAttachment.attachXModule(context,builder.getModule());
    }
  }
;
  getDeploymentChain().addProcessor(processor,40);
  Bundle bundle=executeDeploy(archive);
  assertNotNull("Bundle not null",bundle);
  assertBundleState(Bundle.INSTALLED,bundle.getState());
  bundle.start();
  assertBundleState(Bundle.ACTIVE,bundle.getState());
  assertLoadClass(bundle,A.class.getName());
  bundle.uninstall();
  assertBundleState(Bundle.UNINSTALLED,bundle.getState());
  getDeploymentChain().removeProcessor(processor,40);
}
