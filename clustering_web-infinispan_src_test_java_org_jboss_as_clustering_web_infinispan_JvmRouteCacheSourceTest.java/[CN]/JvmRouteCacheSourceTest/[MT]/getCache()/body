{
  ServiceRegistry registry=mock(ServiceRegistry.class);
  ServiceController<EmbeddedCacheManager> controller=mock(ServiceController.class);
  LocalDistributableSessionManager manager=mock(LocalDistributableSessionManager.class);
  Cache<Object,Object> cache=mock(Cache.class);
  EmbeddedCacheManager container=mock(EmbeddedCacheManager.class);
  ServiceNameProvider provider=mock(ServiceNameProvider.class);
  ReplicationConfig config=new ReplicationConfig();
  config.setCacheName("test-cache");
  String engine="engine";
  ServiceName name=ServiceName.JBOSS.append("infinispan");
  CacheSource source=new JvmRouteCacheSource(provider);
  when(manager.getReplicationConfig()).thenReturn(config);
  when(provider.getServiceName(same(config))).thenReturn(name);
  when((ServiceController<EmbeddedCacheManager>)registry.getRequiredService(name)).thenReturn(controller);
  when(controller.getValue()).thenReturn(container);
  when(manager.getEngineName()).thenReturn(engine);
  when(container.cacheExists(engine)).thenReturn(false,true);
  when(container.getCache(engine)).thenReturn(cache);
  when(container.defineConfiguration(engine,CacheContainer.DEFAULT_CACHE_NAME,new Configuration())).thenReturn(new Configuration()).thenThrow(new AssertionError());
  assertSame(cache,source.getCache(registry,manager));
  assertSame(cache,source.getCache(registry,manager));
}
