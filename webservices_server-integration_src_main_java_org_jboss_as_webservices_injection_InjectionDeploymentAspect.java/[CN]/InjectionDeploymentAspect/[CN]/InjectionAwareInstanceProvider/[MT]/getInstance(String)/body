{
  Object instance=cache.get(className);
  if (instance != null)   return instance;
  if (className.equals(endpointClass)) {
    if (!isEjb3Endpoint) {
      final ServiceName endpointComponentName=getEndpointComponentServiceName();
      final ServiceController<BasicComponent> endpointController=getComponentController(endpointComponentName);
      if (endpointController != null) {
        final BasicComponent endpointComponent=endpointController.getValue();
        final ComponentInstance endpointComponentInstance=endpointComponent.createInstance(delegate.getInstance(className));
        return cacheAndGet(endpointComponentInstance.getInstance());
      }
    }
  }
 else {
    final ServiceName handlerComponentName=getHandlerComponentServiceName(className);
    final ServiceController<BasicComponent> handlerComponentController=getComponentController(handlerComponentName);
    if (handlerComponentController != null) {
      final BasicComponent handlerComponent=handlerComponentController.getValue();
      final ComponentInstance handlerComponentInstance=handlerComponent.createInstance(delegate.getInstance(className));
      return cacheAndGet(handlerComponentInstance.getInstance());
    }
  }
  return cacheAndGet(delegate.getInstance(className));
}
