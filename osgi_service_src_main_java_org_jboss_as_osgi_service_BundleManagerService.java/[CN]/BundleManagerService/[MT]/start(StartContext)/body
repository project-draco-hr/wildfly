{
  log.debugf("Starting OSGi BundleManager");
  try {
    String handlerModules=SecurityActions.getSystemProperty("jboss.protocol.handler.modules");
    if (handlerModules == null)     SecurityActions.setSystemProperty("jboss.protocol.handler.modules","org.jboss.osgi.framework");
    Map<String,Object> props=new HashMap<String,Object>(subsystemState.getProperties());
    setupIntegrationProperties(context,props);
    bundleManager=new BundleManager(props);
    bundleManager.addPlugin(SystemModuleProviderPlugin.class,new FrameworkModuleProvider(bundleManager));
    ServiceContainer serviceContainer=context.getController().getServiceContainer();
    ServerDeploymentManager deploymentManager=new ModelControllerServerDeploymentManager(injectedServerController.getValue());
    DeployerServicePluginIntegration plugin=new DeployerServicePluginIntegration(bundleManager,serviceContainer,deploymentManager);
    bundleManager.addPlugin(DeployerServicePlugin.class,plugin);
    ServiceModuleLoader moduleLoader=injectedServiceModuleLoader.getValue();
    bundleManager.addPlugin(ModuleLoaderPlugin.class,new ModuleLoaderPluginImpl(bundleManager,moduleLoader));
  }
 catch (  Throwable t) {
    throw new StartException("Failed to create BundleManager",t);
  }
}
