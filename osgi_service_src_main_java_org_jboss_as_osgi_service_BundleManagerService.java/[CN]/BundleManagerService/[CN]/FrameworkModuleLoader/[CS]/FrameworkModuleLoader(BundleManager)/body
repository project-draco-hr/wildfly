{
  ModuleLoader moduleLoader=Module.getSystemModuleLoader();
  Module frameworkModule=moduleLoader.loadModule(ModuleIdentifier.create("org.jboss.osgi.framework"));
  ModuleIdentifier frameworkIdentifier=ModuleIdentifier.create("org.jboss.osgi.framework.extended");
  ModuleSpec.Builder builder=ModuleSpec.build(frameworkIdentifier);
  PathFilter all=PathFilters.acceptAll();
  ModuleIdentifier moduleId=frameworkModule.getIdentifier();
  DependencySpec moduleDep=DependencySpec.createModuleDependencySpec(all,all,moduleLoader,moduleId,false);
  builder.addDependency(moduleDep);
  String modulesProps=(String)bundleManager.getProperty(SubsystemState.PROP_JBOSS_OSGI_SYSTEM_MODULES);
  if (modulesProps != null) {
    for (    String moduleProp : modulesProps.split(",")) {
      moduleId=ModuleIdentifier.create(moduleProp.trim());
      moduleDep=DependencySpec.createModuleDependencySpec(all,all,moduleLoader,moduleId,false);
      builder.addDependency(moduleDep);
    }
  }
  PathFilter exp=PathFilters.in(bundleManager.getPlugin(SystemPackagesPlugin.class).getExportedPaths());
  moduleDep=DependencySpec.createModuleDependencySpec(all,exp,moduleLoader,ModuleIdentifier.SYSTEM,false);
  builder.addDependency(moduleDep);
  moduleSpec=builder.create();
}
