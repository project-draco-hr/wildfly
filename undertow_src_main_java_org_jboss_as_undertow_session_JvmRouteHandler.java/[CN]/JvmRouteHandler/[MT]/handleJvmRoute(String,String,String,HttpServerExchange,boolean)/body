{
  String newId=null;
  Map.Entry<String,String> sessionEntry=this.manager.parse(sessionId);
  String realId=sessionEntry.getKey();
  String sessionJvmRoute=sessionEntry.getValue();
  if (sessionJvmRoute == null) {
    newId=this.manager.createSessionId(realId,jvmRoute);
  }
 else   if (!jvmRoute.equals(sessionJvmRoute)) {
    if (log.isTraceEnabled()) {
      log.tracef("handleJvmRoute(): We have detected a failover with different jvmRoute. old one: %s, new one: %s. Will reset the session id.",sessionJvmRoute,jvmRoute);
    }
    newId=this.manager.createSessionId(realId,this.manager.locateJvmRoute(realId));
  }
  if (newId != null) {
    resetSessionId(exchange,sessionId,newId);
  }
  if (setCookie) {
    if (newId == null) {
      String requestedJvmRoute=(requestedId != null) ? this.manager.parse(requestedId).getValue() : null;
      if (!jvmRoute.equals(requestedJvmRoute)) {
        if (log.isTraceEnabled()) {
          log.tracef("handleJvmRoute(): We have detected a failover with different jvmRoute. received one: %s, new one: %s. Will reset the session id.",requestedJvmRoute,jvmRoute);
        }
        newId=this.manager.createSessionId(realId,this.manager.locateJvmRoute(realId));
      }
    }
    if (newId != null) {
      final HttpServletRequestImpl request=HttpServletRequestImpl.getRequestImpl(exchange.getAttachment(HttpServletRequestImpl.ATTACHMENT_KEY));
      request.getServletContext().getSessionCookieConfig().setSessionId(exchange,newId);
    }
  }
}
