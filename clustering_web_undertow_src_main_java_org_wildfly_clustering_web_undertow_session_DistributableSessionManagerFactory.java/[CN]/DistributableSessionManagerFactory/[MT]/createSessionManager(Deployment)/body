{
  SessionContext context=new UndertowSessionContext(deployment);
  IdentifierFactory<String> factory=new IdentifierFactoryAdapter(new SecureRandomSessionIdGenerator());
  final SessionManager<LocalSessionContext,Batch> manager=this.factory.createSessionManager(context,factory,new LocalSessionContextFactory());
  DeploymentInfo info=deployment.getDeploymentInfo();
  ThreadSetupAction action=new ThreadSetupAction(){
    @Override public Handle setup(    HttpServerExchange exchange){
      return new Handle(){
        @Override public void tearDown(){
          Batch batch=manager.getBatcher().suspendBatch();
          if (batch != null) {
            UndertowLogger.REQUEST_LOGGER.tracef("Suspending residual active batch: %s",batch);
          }
        }
      }
;
    }
  }
;
  info.addThreadSetupAction(action);
  return new DistributableSessionManager(info.getDeploymentName(),manager);
}
