{
  if (!(entityManager instanceof AbstractEntityManager)) {
    throw new RuntimeException("internal error, XPC needs to be a AbstractEntityManager so that we can get metadata");
  }
  List<WeakReference<EntityManager>> xpcList=contextToXPCMap.get(beanContextHandle);
  if (xpcList == null) {
    xpcList=Collections.synchronizedList(new ArrayList<WeakReference<EntityManager>>());
    xpcList.add(new WeakReference(entityManager));
    List<WeakReference<EntityManager>> existingList=contextToXPCMap.putIfAbsent(beanContextHandle,xpcList);
    if (existingList != null) {
      xpcList=existingList;
      xpcList.add(new WeakReference(entityManager));
    }
  }
 else {
    xpcList.add(new WeakReference(entityManager));
  }
  List<SFSBContextHandle> sfsbList=Collections.synchronizedList(new ArrayList<SFSBContextHandle>());
  sfsbList.add(beanContextHandle);
  sfsbList=XPCToContextMap.putIfAbsent(entityManager,sfsbList);
  if (null != sfsbList) {
    sfsbList.add(beanContextHandle);
  }
}
