{
  if (!(entityManager instanceof AbstractEntityManager)) {
    throw new RuntimeException("internal error, XPC needs to be a AbstractEntityManager so that we can get metadata");
  }
  List<EntityManager> xpcList=contextToXPCMap.get(beanContextHandle);
  if (xpcList == null) {
    xpcList=new ArrayList<EntityManager>();
    xpcList.add(entityManager);
    Object existingList=contextToXPCMap.put(beanContextHandle,xpcList);
    if (existingList != null) {
      throw new RuntimeException("More than one thread is invoking stateful session bean '" + beanContextHandle.getBeanContextHandle() + "' at the same time.");
    }
  }
 else {
    xpcList.add(entityManager);
  }
  List<SFSBContextHandle> sfsbList=XPCToContextMap.get(entityManager);
  if (sfsbList == null) {
    sfsbList=new ArrayList<SFSBContextHandle>();
    Object existingList=XPCToContextMap.put(entityManager,sfsbList);
    if (existingList != null) {
      throw new RuntimeException("More than one thread is using EntityManager instance '" + entityManager + "' at the same time.");
    }
  }
  sfsbList.add(beanContextHandle);
}
