{
  final Headers responseHeaders=http.getResponseHeaders();
  responseHeaders.add("Content-Type",contentType);
  responseHeaders.add("Access-Control-Allow-Origin","*");
  http.sendResponseHeaders(status,0);
  final OutputStream out=http.getResponseBody();
  final PrintWriter print=new PrintWriter(out);
  if (isGet && status == 200)   response=response.get("result");
  try {
    if (encode) {
      response.writeBase64(out);
    }
 else {
      response.writeJSONString(print,!pretty);
    }
  }
  finally {
    print.flush();
    out.flush();
    safeClose(print);
    safeClose(out);
  }
}
