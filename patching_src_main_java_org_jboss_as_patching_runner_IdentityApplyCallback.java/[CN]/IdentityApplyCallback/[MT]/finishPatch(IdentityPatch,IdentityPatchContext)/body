{
  final File historyDir=structure.getInstalledImage().getPatchHistoryDir(patchId);
  if (!historyDir.exists()) {
    historyDir.mkdirs();
  }
  final File cumulativeBackup=new File(historyDir,Constants.CUMULATIVE);
  final File referencesBackup=new File(historyDir,Constants.REFERENCES);
  final File timestamp=new File(historyDir,Constants.TIMESTAMP);
  final IdentityPatchContext.PatchEntry identity=context.getIdentityEntry();
  PatchUtils.writeRef(cumulativeBackup,identity.getCumulativeID());
  PatchUtils.writeRefs(referencesBackup,identity.getPatchIDs());
  PatchUtils.writeRef(timestamp,generateTimestamp());
  final File backupPatchXml=new File(historyDir,PatchXml.PATCH_XML);
  IdentityPatchContext.writePatch(original,backupPatchXml);
  final File rollbackPatchXml=new File(historyDir,Constants.ROLLBACK_XML);
  IdentityPatchContext.writePatch(rollbackPatch,rollbackPatchXml);
  context.backupConfiguration();
}
