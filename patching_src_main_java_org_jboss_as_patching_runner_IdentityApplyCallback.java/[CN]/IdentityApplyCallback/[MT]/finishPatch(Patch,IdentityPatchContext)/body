{
  final File historyDir=structure.getInstalledImage().getPatchHistoryDir(patchId);
  if (!historyDir.exists()) {
    historyDir.mkdirs();
  }
  final File installationInfo=new File(historyDir,Constants.INSTALLATION_METADATA);
  final File timestamp=new File(historyDir,Constants.TIMESTAMP);
  final IdentityPatchContext.PatchEntry identity=context.getIdentityEntry();
  PatchUtils.writeProperties(installationInfo,identity.getProperties());
  PatchUtils.writeRef(timestamp,generateTimestamp());
  final File backupPatchXml=new File(historyDir,PatchXml.PATCH_XML);
  IdentityPatchContext.writePatch(original,backupPatchXml);
  final File rollbackPatchXml=new File(historyDir,Constants.ROLLBACK_XML);
  IdentityPatchContext.writePatch(rollbackPatch,rollbackPatchXml);
  context.backupConfiguration();
}
