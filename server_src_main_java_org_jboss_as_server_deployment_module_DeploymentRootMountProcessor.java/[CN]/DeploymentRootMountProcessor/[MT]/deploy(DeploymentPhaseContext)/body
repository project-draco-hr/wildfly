{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT) != null) {
    return;
  }
  final ServerDeploymentRepository serverDeploymentRepository=deploymentUnit.getAttachment(Attachments.SERVER_DEPLOYMENT_REPOSITORY);
  if (serverDeploymentRepository == null) {
    throw new DeploymentUnitProcessingException("No deployment repository available.");
  }
  final String deploymentName=deploymentUnit.getName();
  final VirtualFile deploymentContents=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_CONTENTS);
  if (deploymentContents == null)   return;
  final VirtualFile deploymentRoot;
  final MountHandle mountHandle;
  if (deploymentContents.isDirectory()) {
    deploymentRoot=deploymentContents;
    mountHandle=null;
  }
 else {
    deploymentRoot=VFS.getChild("content/" + deploymentName);
    boolean failed=false;
    Closeable handle=null;
    try {
      final boolean mountExploded=MountExplodedMarker.isMountExploded(deploymentUnit);
      final MountType type;
      if (mountExploded) {
        type=MountType.EXPANDED;
      }
 else       if (deploymentName.endsWith(".xml")) {
        type=MountType.REAL;
      }
 else {
        type=MountType.ZIP;
      }
      handle=serverDeploymentRepository.mountDeploymentContent(deploymentContents,deploymentRoot,type);
      mountHandle=new MountHandle(handle);
    }
 catch (    IOException e) {
      failed=true;
      throw new DeploymentUnitProcessingException("Failed to mount deployment content",e);
    }
 finally {
      if (failed) {
        VFSUtils.safeClose(handle);
      }
    }
  }
  final ResourceRoot resourceRoot=new ResourceRoot(deploymentRoot,mountHandle);
  ModuleRootMarker.mark(resourceRoot);
  deploymentUnit.putAttachment(Attachments.DEPLOYMENT_ROOT,resourceRoot);
  deploymentUnit.putAttachment(Attachments.MODULE_SPECIFICATION,new ModuleSpecification());
}
