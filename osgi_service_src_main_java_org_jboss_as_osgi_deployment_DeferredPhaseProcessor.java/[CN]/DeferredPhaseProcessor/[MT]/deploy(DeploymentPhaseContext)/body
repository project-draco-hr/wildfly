{
  DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  XBundle bundle=depUnit.getAttachment(OSGiConstants.BUNDLE_KEY);
  if (bundle == null || bundle.isFragment())   return;
  BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
  ServiceName bundleResolve=bundleManager.getServiceName(bundle,Bundle.RESOLVED);
  phaseContext.addDeploymentDependency(bundleResolve,AttachmentKey.create(Object.class));
  XBundleRevision brev=bundle.getBundleRevision();
  ServiceName moduleService=ServiceModuleLoader.moduleServiceName(brev.getModuleIdentifier());
  phaseContext.addDeploymentDependency(moduleService,Attachments.MODULE);
  if (bundle.isResolved() == false) {
    if (depUnit.getParent() == null) {
      depUnit.putAttachment(Attachments.DEFERRED_MODULE_PHASE,Boolean.TRUE);
      depUnit.putAttachment(Attachments.DEFERRED_ACTIVATION_COUNT,new AtomicInteger());
    }
 else {
      LOGGER.warnDeferredModuleNotSupported(depUnit);
    }
  }
}
