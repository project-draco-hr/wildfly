{
  DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  XBundleRevision brev=depUnit.getAttachment(OSGiConstants.BUNDLE_REVISION_KEY);
  if (brev == null || brev.isFragment())   return;
  ServiceName moduleService=ServiceModuleLoader.moduleServiceName(brev.getModuleIdentifier());
  phaseContext.addDeploymentDependency(moduleService,Attachments.MODULE);
  if (brev.getBundle().isResolved() == false) {
    depUnit.putAttachment(Attachments.DEFERRED_ACTIVATION_COUNT,new AtomicInteger());
    DeploymentUtils.addDeferredModule(depUnit);
  }
}
