{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final ResourceRoot deploymentRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  final DeploymentUnit parent=deploymentUnit.getParent();
  final DeploymentUnit topLevelDeployment=parent == null ? deploymentUnit : parent;
  final VirtualFile toplevelRoot=topLevelDeployment.getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
  final ModuleIdentifier moduleIdentifier;
  if (deploymentUnit.getParent() == null) {
    moduleIdentifier=ModuleIdentifier.create(ServiceModuleLoader.MODULE_PREFIX + deploymentUnit.getName());
  }
 else {
    String relativePath=deploymentRoot.getRoot().getPathNameRelativeTo(toplevelRoot);
    moduleIdentifier=ModuleIdentifier.create(ServiceModuleLoader.MODULE_PREFIX + topLevelDeployment.getName() + '.'+ relativePath.replace('/','.'));
  }
  deploymentUnit.putAttachment(Attachments.MODULE_IDENTIFIER,moduleIdentifier);
}
