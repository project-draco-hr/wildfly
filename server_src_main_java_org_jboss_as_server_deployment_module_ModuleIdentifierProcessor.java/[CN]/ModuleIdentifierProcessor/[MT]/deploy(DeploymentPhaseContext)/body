{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  Manifest manifest=deploymentUnit.getAttachment(Attachments.OSGI_MANIFEST);
  if (ManifestHelper.hasMainAttributeValue(manifest,"Fragment-Host")) {
    return;
  }
  final ResourceRoot deploymentRoot=deploymentUnit.getAttachment(Attachments.DEPLOYMENT_ROOT);
  final DeploymentUnit parent=deploymentUnit.getParent();
  final DeploymentUnit topLevelDeployment=parent == null ? deploymentUnit : parent;
  final VirtualFile toplevelRoot=topLevelDeployment.getAttachment(Attachments.DEPLOYMENT_ROOT).getRoot();
  final ModuleIdentifier moduleIdentifier=createModuleIdentifier(deploymentUnit.getName(),deploymentRoot,topLevelDeployment,toplevelRoot,deploymentUnit.getParent() == null);
  deploymentUnit.putAttachment(Attachments.MODULE_IDENTIFIER,moduleIdentifier);
}
