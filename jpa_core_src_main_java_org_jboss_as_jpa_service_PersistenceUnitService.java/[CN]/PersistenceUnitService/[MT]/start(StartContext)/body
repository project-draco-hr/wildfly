{
  try {
    log.infof("starting Persistence Unit Service '%s' ",pu.getScopedPersistenceUnitName());
    PersistenceProvider provider;
    if (persistenceProviderDeploymentHolder != null && persistenceProviderDeploymentHolder.getProvider() != null && persistenceProviderDeploymentHolder.getProvider().getClass().getName().equals(pu.getPersistenceProviderClassName())) {
      provider=persistenceProviderDeploymentHolder.getProvider();
    }
 else {
      provider=lookupProvider(pu.getPersistenceProviderClassName());
    }
    pu.setJtaDataSource(jtaDataSource.getOptionalValue());
    pu.setNonJtaDataSource(nonJtaDataSource.getOptionalValue());
    this.entityManagerFactory=createContainerEntityManagerFactory(provider);
  }
  finally {
    pu.setTempClassloader(null);
  }
}
