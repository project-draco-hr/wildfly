{
  String adaptorModule=pu.getProperties().getProperty(Configuration.ADAPTER_MODULE);
  PersistenceProviderAdaptor adaptor=null;
  if (persistenceProviderDeploymentHolder != null) {
    adaptor=persistenceProviderDeploymentHolder.getAdapter();
  }
  if (adaptor == null) {
    if (adaptorModule != null) {
      adaptor=PersistenceProviderAdapterRegistry.getPersistenceProviderAdaptor(pu.getPersistenceProviderClassName(),adaptorModule);
    }
 else {
      adaptor=PersistenceProviderAdapterRegistry.getPersistenceProviderAdaptor(pu.getPersistenceProviderClassName());
    }
  }
  adaptor.beforeCreateContainerEntityManagerFactory(pu);
  try {
    return provider.createContainerEntityManagerFactory(pu,properties.getValue());
  }
  finally {
    try {
      adaptor.afterCreateContainerEntityManagerFactory(pu);
    }
  finally {
      pu.setAnnotationIndex(null);
      pu.setTempClassloader(null);
    }
  }
}
