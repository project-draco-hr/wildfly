{
  try {
    final Patch patch=patchResolver.resolvePatch(modification.getName(),modification.getVersion());
    if (patch == null) {
      throw PatchLogger.ROOT_LOGGER.failedToResolvePatch(modification.getName(),modification.getVersion());
    }
    final String patchId=patch.getPatchId();
    final Identity identity=patch.getIdentity();
    final String appliesTo=identity.getVersion();
    if (!appliesTo.equals(modification.getVersion())) {
      throw PatchLogger.ROOT_LOGGER.doesNotApply(appliesTo,modification.getVersion());
    }
    if (modification.isApplied(patchId)) {
      throw PatchLogger.ROOT_LOGGER.alreadyApplied(patchId);
    }
    checkUpgradeConditions(identity,modification);
    final File backup=installedImage.getPatchHistoryDir(patchId);
    final IdentityPatchContext context=new IdentityPatchContext(backup,contentProvider,contentPolicy,modification,APPLY,installedImage);
    try {
      return applyPatch(patchId,patch,context);
    }
 catch (    Exception e) {
      PatchLogger.ROOT_LOGGER.debugf(e,"failed to apply patch %s",patchId);
      throw rethrowException(e);
    }
 finally {
      context.cleanup();
    }
  }
  finally {
    contentProvider.cleanup();
  }
}
