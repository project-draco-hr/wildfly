{
  try {
    final Patch patch=patchResolver.resolvePatch(null,modification.getVersion());
    final String patchId=patch.getPatchId();
    final Identity identity=patch.getIdentity();
    final String appliesTo=identity.getVersion();
    if (!appliesTo.equals(modification.getVersion())) {
      throw PatchMessages.MESSAGES.doesNotApply(appliesTo,modification.getVersion());
    }
    if (modification.isApplied(patchId)) {
      throw PatchMessages.MESSAGES.alreadyApplied(patchId);
    }
    checkUpgradeConditions(identity,modification);
    final File backup=installedImage.getPatchHistoryDir(patchId);
    final IdentityPatchContext context=new IdentityPatchContext(backup,contentProvider,contentPolicy,modification,installedImage);
    try {
      return applyPatch(patchId,patch,context);
    }
 catch (    Exception e) {
      throw rethrowException(e);
    }
 finally {
      context.cleanup();
    }
  }
  finally {
    contentProvider.cleanup();
  }
}
