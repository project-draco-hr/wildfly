{
  try {
    final Patch patch=loadPatchInformation(patchID,installedImage);
    for (    final PatchElement patchElement : patch.getElements()) {
      final IdentityPatchContext.PatchEntry entry=context.resolveForElement(patchElement);
      final Map<Location,ContentTaskDefinition> definitions=entry.getDefinitions();
      final Collection<ContentModification> modifications=patchElement.getModifications();
      apply(patchElement.getId(),modifications,definitions,ContentItemFilter.ALL_BUT_MISC);
      final DirectoryStructure structure=entry.getDirectoryStructure();
      final File modulesRoot=structure.getModulePatchDirectory(patchElement.getId());
      final File bundlesRoot=structure.getBundlesPatchDirectory(patchElement.getId());
      final PatchContentLoader loader=PatchContentLoader.create(null,bundlesRoot,modulesRoot);
      context.recordContentLoader(patchElement.getId(),loader);
    }
    final IdentityPatchContext.PatchEntry identity=context.getIdentityEntry();
    final Map<Location,ContentTaskDefinition> definitions=identity.getDefinitions();
    final Collection<ContentModification> modifications=patch.getModifications();
    apply(patchID,modifications,definitions,ContentItemFilter.ALL_BUT_MISC);
  }
 catch (  Exception e) {
    throw rethrowException(e);
  }
}
