{
  final List<PreparedTask> tasks=new ArrayList<PreparedTask>();
  final List<ContentItem> conflicts=new ArrayList<ContentItem>();
  prepareTasks(context.getIdentityEntry(),context,tasks,conflicts);
  for (  final IdentityPatchContext.PatchEntry layer : context.getLayers()) {
    prepareTasks(layer,context,tasks,conflicts);
  }
  for (  final IdentityPatchContext.PatchEntry addOn : context.getAddOns()) {
    prepareTasks(addOn,context,tasks,conflicts);
  }
  if (!conflicts.isEmpty()) {
    throw PatchMessages.MESSAGES.conflictsDetected(conflicts);
  }
  for (  final PreparedTask task : tasks) {
    final ContentItem item=task.getContentItem();
    if (item != null && context.isExcluded(item)) {
      continue;
    }
    task.execute();
  }
  return context.finalize(callback);
}
