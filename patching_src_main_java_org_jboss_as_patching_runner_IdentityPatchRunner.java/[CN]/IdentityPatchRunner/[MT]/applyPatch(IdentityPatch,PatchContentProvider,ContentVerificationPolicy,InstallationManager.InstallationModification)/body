{
  try {
    final String patchId=patch.getPatchId();
    final List<String> appliesTo=patch.getAppliesTo();
    if (!appliesTo.contains(modification.getVersion())) {
      throw PatchMessages.MESSAGES.doesNotApply(appliesTo,modification.getVersion());
    }
    if (modification.getCumulativeID().equals(patchId)) {
      throw PatchMessages.MESSAGES.alreadyApplied(patchId);
    }
    if (modification.getPatchIDs().contains(patchId)) {
      throw PatchMessages.MESSAGES.alreadyApplied(patchId);
    }
    final File backup=installedImage.getPatchHistoryDir(patchId);
    final IdentityPatchContext context=new IdentityPatchContext(backup,contentProvider,contentPolicy,modification,installedImage);
    try {
      return applyPatch(patchId,patch,context);
    }
 catch (    Exception e) {
      throw rethrowException(e);
    }
 finally {
      context.cleanup();
    }
  }
  finally {
    contentProvider.cleanup();
  }
}
