{
  final List<String> invalidation;
  final Identity identity=patch.getIdentity();
  final Patch.PatchType patchType=identity.getPatchType();
  final InstallationManager.InstallationModification modification=context.getModification();
  if (patchType == Patch.PatchType.ONE_OFF) {
    invalidation=Collections.emptyList();
  }
 else {
    invalidation=new ArrayList<String>(modification.getPatchIDs());
  }
  for (  final String rollback : invalidation) {
    rollback(rollback,context);
  }
  for (  final PatchElement element : patch.getElements()) {
    final IdentityPatchContext.PatchEntry target=context.resolveForElement(element);
    final PatchElementProvider provider=element.getProvider();
    final Patch.PatchType elementPatchType=provider.getPatchType();
    final String elementPatchId=element.getId();
    if (target.isApplied(elementPatchId)) {
      throw PatchMessages.MESSAGES.alreadyApplied(elementPatchId);
    }
    checkUpgradeConditions(provider,target);
    apply(elementPatchId,element.getModifications(),target.getDefinitions());
    target.apply(elementPatchId,elementPatchType);
  }
  final IdentityPatchContext.PatchEntry identityEntry=context.getIdentityEntry();
  apply(patchId,patch.getModifications(),identityEntry.getDefinitions());
  identityEntry.apply(patchId,patchType);
  if (patchType == Patch.PatchType.CUMULATIVE) {
    final Identity.IdentityUpgrade upgrade=identity.forType(Patch.PatchType.CUMULATIVE,Identity.IdentityUpgrade.class);
    identityEntry.setResultingVersion(upgrade.getResultingVersion());
  }
  final IdentityApplyCallback callback=new IdentityApplyCallback(patch,identityEntry.getDirectoryStructure());
  try {
    return executeTasks(context,callback);
  }
 catch (  Exception e) {
    callback.operationCancelled(context);
    throw rethrowException(e);
  }
}
