{
  if (Security.getProvider(saslProvider.getName()) == null) {
    Security.insertProviderAt(saslProvider,1);
  }
  final ProtocolChannelClient.Configuration<ManagementChannel> configuration=new ProtocolChannelClient.Configuration<ManagementChannel>();
  try {
    addConfigurationProperties(configuration);
    configuration.setUri(new URI("remote://" + hostName + ":"+ port));
    configuration.setChannelFactory(new ManagementChannelFactory());
    configuration.setConnectTimeoutProperty(CONNECT_TIME_OUT_PROPERTY);
    client=ProtocolChannelClient.create(configuration);
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  boolean ok=false;
  try {
    try {
      client.connect(callbackHandler);
    }
 catch (    ConnectException e) {
      throw new ConnectException("Could not connect to " + configuration.getUri() + " in "+ configuration.getConnectTimeout()+ "ms. "+ "Make sure the server is running and/or consider setting a longer timeout by setting -D"+ CONNECT_TIME_OUT_PROPERTY+ "=<timeout in ms>.");
    }
    channel=client.openChannel("management");
    channel.setOperationHandler(handler);
    channel.startReceiving();
    ok=true;
  }
  finally {
    if (!ok) {
      IoUtils.safeClose(channel);
      IoUtils.safeClose(client);
    }
  }
  return channel;
}
