{
  boolean ok=false;
  try {
synchronized (this) {
      if (connection == null) {
        this.connection=setup.connectSync(callbackHandler,saslOptions,sslContext);
        this.connection.addCloseHandler(new CloseHandler<Connection>(){
          @Override public void handleClose(          Connection closed,          IOException exception){
synchronized (Establishing.this) {
              if (connection == closed) {
                connection=null;
              }
            }
          }
        }
);
      }
      if (channel == null) {
        channel=connection.openChannel(channelName,OptionMap.EMPTY).get();
        channel.addCloseHandler(new CloseHandler<Channel>(){
          @Override public void handleClose(          Channel closed,          IOException exception){
synchronized (Establishing.this) {
              if (channel == closed) {
                channel=null;
              }
            }
          }
        }
);
        channel.receiveMessage(receiver);
      }
      ok=true;
    }
  }
  finally {
    if (!ok) {
      StreamUtils.safeClose(connection);
      StreamUtils.safeClose(channel);
    }
  }
  return channel;
}
