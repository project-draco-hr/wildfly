{
  ClassLoader legacyCl=classLoaderBuilder.build();
  Class<?> clazz=legacyCl.loadClass(extensionClassName != null ? extensionClassName : mainExtension.getClass().getName());
  Assert.assertEquals(legacyCl,clazz.getClassLoader());
  Assert.assertTrue(Extension.class.isAssignableFrom(clazz));
  Extension extension=(Extension)clazz.newInstance();
  XMLMapper xmlMapper=XMLMapper.Factory.create();
  ModelTestParser testParser=new TestParser(mainSubsystemName,extensionParsingRegistry);
  ExtensionRegistry extensionParsingRegistry=new ExtensionRegistry(additionalInit.getProcessType(),new RunningModeControl(additionalInit.getExtensionRegistryRunningMode()));
  xmlMapper.registerRootElement(new QName(TEST_NAMESPACE,"test"),testParser);
  extension.initializeParsers(extensionParsingRegistry.getExtensionParsingContext("Test",xmlMapper));
  return KernelServicesImpl.create(mainSubsystemName,additionalInit,cloneExtensionRegistry(additionalInit),bootOperations,testParser,extension,modelVersion);
}
