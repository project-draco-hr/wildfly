{
  final Resource resource=context.readResourceForUpdate(PathAddress.EMPTY_ADDRESS);
  final ModelNode subModel=resource.getModel();
  ModelNode type=ProtocolResourceDefinition.TYPE.validateOperation(operation);
  PathElement protocolRelativePath=PathElement.pathElement(ModelKeys.PROTOCOL,type.asString());
  if (resource.hasChild(protocolRelativePath)) {
    throw JGroupsLogger.ROOT_LOGGER.protocolAlreadyDefined(protocolRelativePath.toString());
  }
  Resource childResource=context.createResource(PathAddress.pathAddress(protocolRelativePath));
  final ModelNode protocol=childResource.getModel();
  for (  final AttributeDefinition attribute : this.attributes) {
    if (attribute.getName().equals(ModelKeys.PROPERTIES))     continue;
    attribute.validateAndSet(operation,protocol);
  }
  ModelNode protocols=subModel.get(ModelKeys.PROTOCOLS);
  if (!protocols.isDefined()) {
    protocols.setEmptyList();
  }
  protocols.add(type);
  if (operation.hasDefined(ProtocolResourceDefinition.PROPERTIES.getName())) {
    for (    Property property : operation.get(ProtocolResourceDefinition.PROPERTIES.getName()).asPropertyList()) {
      final Resource param=context.createResource(PathAddress.pathAddress(protocolRelativePath,PropertyResourceDefinition.pathElement(property.getName())));
      final ModelNode value=property.getValue();
      if (!value.isDefined()) {
        throw JGroupsLogger.ROOT_LOGGER.propertyNotDefined(property.getName(),protocolRelativePath.toString());
      }
      PropertyResourceDefinition.VALUE.validateAndSet(value,param.getModel());
    }
  }
  reloadRequiredStep(context);
  context.stepCompleted();
}
