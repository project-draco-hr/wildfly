{
  if (method.getName().equals("getConnection") && method.getParameterTypes().length == 0 && delegate instanceof XADataSource) {
    final XADataSource xa=(XADataSource)delegate;
    final XAConnection xacon=xa.getXAConnection();
    final Object transactionKey=synchronizationRegistry.getTransactionKey();
    if (!registeredTransactions.contains(transactionKey)) {
      if (transactionManager.getTransaction() != null && transactionActive(transactionManager.getTransaction().getStatus())) {
        transactionManager.getTransaction().enlistResource(xacon.getXAResource());
        synchronizationRegistry.registerInterposedSynchronization(new Sync(transactionKey));
        registeredTransactions.add(transactionKey);
      }
    }
    return xacon.getConnection();
  }
 else {
    final Object ret=method.invoke(delegate,args);
    return ret;
  }
}
