{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (deploymentUnit.getParent() != null) {
    return;
  }
  final EJBClientDescriptorMetaData ejbClientDescriptorMetaData=deploymentUnit.getAttachment(Attachments.EJB_CLIENT_METADATA);
  if (ejbClientDescriptorMetaData == null) {
    return;
  }
  final ServiceName ejbClientContextServiceName=DescriptorBasedEJBClientContextService.BASE_SERVICE_NAME.append(deploymentUnit.getName());
  final ServiceTarget serviceTarget=phaseContext.getServiceTarget();
  final DescriptorBasedEJBClientContextService service=new DescriptorBasedEJBClientContextService();
  final ServiceBuilder serviceBuilder=serviceTarget.addService(ejbClientContextServiceName,service);
  for (  final String connectionRef : ejbClientDescriptorMetaData.getRemotingReceiverConnectionRefs()) {
    final ServiceName connectionDependencyService=AbstractOutboundConnectionService.OUTBOUND_CONNECTION_BASE_SERVICE_NAME.append(connectionRef);
    service.addRemotingConnectionDependency(serviceBuilder,connectionDependencyService);
  }
  if (!ejbClientDescriptorMetaData.isLocalReceiverExcluded()) {
    final Boolean passByValue=ejbClientDescriptorMetaData.isLocalReceiverPassByValue();
    if (passByValue != null) {
      final ServiceName localEjbReceiverServiceName=passByValue == true ? LocalEjbReceiver.BY_VALUE_SERVICE_NAME : LocalEjbReceiver.BY_REFERENCE_SERVICE_NAME;
      serviceBuilder.addDependency(localEjbReceiverServiceName,LocalEjbReceiver.class,service.getLocalEjbReceiverInjector());
    }
 else {
      serviceBuilder.addDependency(LocalEjbReceiver.DEFAULT_LOCAL_EJB_RECEIVER_SERVICE_NAME,LocalEjbReceiver.class,service.getLocalEjbReceiverInjector());
    }
  }
  serviceBuilder.addDependency(TCCLEJBClientContextSelectorService.TCCL_BASED_EJB_CLIENT_CONTEXT_SELECTOR_SERVICE_NAME);
  serviceBuilder.install();
  logger.debug("Deployment unit " + deploymentUnit + " will use "+ ejbClientContextServiceName+ " as the EJB client context service");
  phaseContext.addDeploymentDependency(ejbClientContextServiceName,EjbDeploymentAttachmentKeys.EJB_CLIENT_CONTEXT);
}
