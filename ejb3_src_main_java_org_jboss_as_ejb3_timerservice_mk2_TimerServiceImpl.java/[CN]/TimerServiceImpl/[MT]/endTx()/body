{
  try {
    Transaction tx=this.transactionManager.getTransaction();
    if (tx == null) {
      throw new IllegalStateException("Transaction cannot be ended since no transaction is in progress");
    }
    if (tx.getStatus() == Status.STATUS_MARKED_ROLLBACK) {
      this.transactionManager.rollback();
    }
 else     if (tx.getStatus() == Status.STATUS_ACTIVE) {
      this.transactionManager.commit();
    }
  }
 catch (  Exception e) {
    throw new RuntimeException("Could not end transaction",e);
  }
}
