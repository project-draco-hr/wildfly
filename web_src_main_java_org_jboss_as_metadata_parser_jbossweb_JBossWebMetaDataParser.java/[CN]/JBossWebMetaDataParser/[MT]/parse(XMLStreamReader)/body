{
  reader.require(START_DOCUMENT,null,null);
  Version version=null;
  while (reader.hasNext() && reader.next() != START_ELEMENT) {
    if (reader.getEventType() == DTD) {
      String dtdLocation=readDTDLocation(reader);
      if (dtdLocation != null) {
        version=Location.getVersion(dtdLocation);
      }
      if (version == null) {
        version=Version.JBOSS_WEB_5_0;
      }
    }
  }
  String schemaLocation=readSchemaLocation(reader);
  if (schemaLocation != null) {
    version=Location.getVersion(schemaLocation);
  }
  if (version == null) {
    version=Version.JBOSS_WEB_6_0;
  }
  JBossWebMetaData wmd=null;
switch (version) {
case JBOSS_WEB_3_0:
    wmd=new JBoss4xDTDWebMetaData();
  break;
case JBOSS_WEB_3_2:
wmd=new JBoss4xDTDWebMetaData();
break;
case JBOSS_WEB_4_0:
wmd=new JBoss4xDTDWebMetaData();
break;
case JBOSS_WEB_4_2:
wmd=new JBoss4xDTDWebMetaData();
break;
case JBOSS_WEB_5_0:
wmd=new JBoss50DTDWebMetaData();
break;
case JBOSS_WEB_5_1:
wmd=new JBoss50WebMetaData();
break;
case JBOSS_WEB_6_0:
wmd=new JBoss60WebMetaData();
break;
}
final int count=reader.getAttributeCount();
for (int i=0; i < count; i++) {
final String value=reader.getAttributeValue(i);
if (reader.getAttributeNamespace(i) != null) {
continue;
}
final Attribute attribute=Attribute.forName(reader.getAttributeLocalName(i));
switch (attribute) {
case VERSION:
{
wmd.setVersion(value);
break;
}
default :
throw unexpectedAttribute(reader,i);
}
}
while (reader.hasNext() && reader.nextTag() != END_ELEMENT) {
final Element element=Element.forName(reader.getLocalName());
switch (element) {
case CONTEXT_ROOT:
wmd.setContextRoot(reader.getElementText());
break;
case VIRTUAL_HOST:
List<String> virtualHosts=wmd.getVirtualHosts();
if (virtualHosts == null) {
virtualHosts=new ArrayList<String>();
wmd.setVirtualHosts(virtualHosts);
virtualHosts.add(reader.getElementText());
}
 else {
throw duplicateNamedElement(reader,Element.VIRTUAL_HOST.toString());
}
break;
case ANNOTATION:
JBossAnnotationsMetaData annotations=wmd.getAnnotations();
if (annotations == null) {
annotations=new JBossAnnotationsMetaData();
wmd.setAnnotations(annotations);
}
annotations.add(JBossAnnotationMetaDataParser.parse(reader));
break;
default :
throw unexpectedElement(reader);
}
}
return wmd;
}
