{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final ServiceName puServiceName=depUnit.getAttachment(JpaAttachments.PERSISTENCE_UNIT_SERVICE_KEY);
  final XBundleRevision brev=depUnit.getAttachment(OSGiConstants.BUNDLE_REVISION_KEY);
  if (brev == null || puServiceName == null)   return;
  BundleContext syscontext=depUnit.getAttachment(OSGiConstants.SYSTEM_CONTEXT_KEY);
  BundleListener listener=new SynchronousBundleListener(){
    @Override public void bundleChanged(    BundleEvent event){
      if (event.getBundle() == brev.getBundle() && event.getType() == BundleEvent.STARTED) {
        BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
        EntityManagerFactoryRegistration.addService(phaseContext.getServiceTarget(),bundleManager,puServiceName,brev);
      }
    }
  }
;
  syscontext.addBundleListener(listener);
  depUnit.putAttachment(BUNDLE_LISTENER_KEY,listener);
}
