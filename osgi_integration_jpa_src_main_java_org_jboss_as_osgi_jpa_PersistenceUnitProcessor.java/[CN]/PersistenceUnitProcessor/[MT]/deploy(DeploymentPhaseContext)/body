{
  final DeploymentUnit depUnit=phaseContext.getDeploymentUnit();
  final ServiceName puServiceName=depUnit.getAttachment(JpaAttachments.PERSISTENCE_UNIT_SERVICE_KEY);
  final XBundle bundle=depUnit.getAttachment(OSGiConstants.BUNDLE_KEY);
  if (bundle == null || puServiceName == null)   return;
  BundleContext syscontext=depUnit.getAttachment(OSGiConstants.SYSTEM_CONTEXT_KEY);
  BundleListener listener=new SynchronousBundleListener(){
    @Override public void bundleChanged(    BundleEvent event){
      if (event.getBundle() == bundle && event.getType() == BundleEvent.STARTED) {
        BundleManager bundleManager=depUnit.getAttachment(OSGiConstants.BUNDLE_MANAGER_KEY);
        EntityManagerFactoryRegistration.addService(phaseContext.getServiceTarget(),bundleManager,puServiceName,bundle);
      }
    }
  }
;
  syscontext.addBundleListener(listener);
  depUnit.putAttachment(BUNDLE_LISTENER_KEY,listener);
}
