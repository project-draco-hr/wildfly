{
  final SecurityContext securityContext=doPrivileged(securityContext());
  if (securityContext == null)   throw new IllegalStateException("No security context established");
  Principal principal=securityContext.getIncomingRunAs();
  if (principal == null)   principal=getPrincipal(securityContext.getSubjectInfo().getAuthenticatedSubject());
  if (principal == null)   throw new IllegalStateException("No principal available");
  return principal;
}
