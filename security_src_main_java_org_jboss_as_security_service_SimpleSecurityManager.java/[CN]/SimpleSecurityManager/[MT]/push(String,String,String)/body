{
  final SecurityContext previous=SecurityContextAssociation.getSecurityContext();
  contexts.push(previous);
  SecurityContext current=SecurityFactory.establishSecurityContext(securityDomain);
  if (previous != null) {
    current.setSubjectInfo(previous.getSubjectInfo());
    current.setIncomingRunAs(previous.getOutgoingRunAs());
  }
  RunAs currentRunAs=current.getIncomingRunAs();
  boolean trusted=currentRunAs != null && currentRunAs instanceof RunAsIdentity;
  if (trusted == false) {
    boolean authenticated=authenticate(current);
    if (authenticated == false) {
      throw new SecurityException("Invalid User");
    }
  }
  if (runAs != null) {
    RunAs runAsIdentity=new RunAsIdentity(runAs,null);
    current.setOutgoingRunAs(runAsIdentity);
  }
 else   if (previous != null && previous.getOutgoingRunAs() != null) {
    current.setOutgoingRunAs(previous.getOutgoingRunAs());
  }
}
