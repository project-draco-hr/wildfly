{
  if (synchronizing || instances.isEmpty()) {
    return;
  }
  synchronizing=true;
  Thread currentThread=Thread.currentThread();
  CmpEntityBeanContext context=null;
  try {
    int i=0;
    while (i < instances.size()) {
      final CmpEntityBeanContext instance=instances.get(i++);
      if (TxUtils.isRollback(tx)) {
        return;
      }
      context=instance;
      context.getTxAssociation().invokeEjbStore(currentThread,context);
    }
    for (    CmpEntityBeanContext instance : instances) {
      if (TxUtils.isRollback(tx)) {
        return;
      }
      context=instance;
      context.getTxAssociation().synchronize(currentThread,tx,context);
    }
  }
 catch (  Exception causeByException) {
    try {
      tx.setRollbackOnly();
    }
 catch (    Exception e) {
      CmpLogger.ROOT_LOGGER.exceptionRollingBackTx(tx,e);
    }
    if (causeByException instanceof EJBException) {
      throw (EJBException)causeByException;
    }
    throw CmpMessages.MESSAGES.failedToStoreEntity(((context == null || context.getPrimaryKeyUnchecked() == null) ? "<null>" : context.getPrimaryKeyUnchecked().toString()),causeByException);
  }
 finally {
    synchronizing=false;
  }
}
