{
  if (compareAndSetState(0,1)) {
    permitHolder.set(permit);
    return true;
  }
 else   if (permitHolder.get().equals(permit)) {
    for (; ; ) {
      int current=getState();
      int next=current + 1;
      if (next < 0)       throw new Error("Maximum lock count exceeded");
      if (compareAndSetState(current,next)) {
        return true;
      }
    }
  }
  return false;
}
