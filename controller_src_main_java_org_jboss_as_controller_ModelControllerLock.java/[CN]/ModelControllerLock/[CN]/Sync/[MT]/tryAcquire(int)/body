{
  final int c=getState();
  if (c == 0) {
    if (compareAndSetState(0,1)) {
      this.permit=permit;
      return true;
    }
  }
 else   if (this.permit.equals(permit)) {
    for (; ; ) {
      int current=getState();
      int next=current + 1;
      if (next < 0)       throw new Error("Maximum lock count exceeded");
      if (compareAndSetState(current,next)) {
        return true;
      }
    }
  }
  return false;
}
