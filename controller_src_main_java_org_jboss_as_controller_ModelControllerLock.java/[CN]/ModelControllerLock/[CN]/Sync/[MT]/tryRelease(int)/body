{
  final Object value=permitHolder.get();
  if (value == null) {
    throw new IllegalStateException();
  }
  if (value.equals(permit)) {
    for (; ; ) {
      int current=getState();
      int next=current - 1;
      if (next < 0)       throw new IllegalStateException();
      if (compareAndSetState(current,next)) {
        if (next == 0) {
          permitHolder.compareAndSet(value,null);
          return true;
        }
 else {
          return false;
        }
      }
    }
  }
  return false;
}
