{
  if (this.permit == null) {
    throw new IllegalStateException();
  }
  if (this.permit.equals(permit)) {
    for (; ; ) {
      int current=getState();
      int next=current - 1;
      if (next < 0)       throw new IllegalStateException();
      if (compareAndSetState(current,next)) {
        if (next == 0) {
          this.permit=null;
          return true;
        }
 else {
          return false;
        }
      }
    }
  }
  return false;
}
