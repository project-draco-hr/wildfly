{
  log.infof("Starting OSGi Framework");
  try {
    ServiceContainer serviceContainer=context.getController().getServiceContainer();
    Map<String,Object> props=new HashMap<String,Object>(subsystemState.getProperties());
    setupIntegrationProperties(context,props);
    FrameworkBuilder builder=new FrameworkBuilder(props);
    builder.setServiceContainer(serviceContainer);
    builder.addProvidedService(DeployerServiceProvider.SERVICE_NAME);
    builder.addProvidedService(FrameworkModuleProvider.SERVICE_NAME);
    builder.addProvidedService(ModuleLoaderProvider.SERVICE_NAME);
    framework=builder.build();
    framework.start();
    BundleContext systemContext=framework.getBundleContext();
    MBeanServer mbeanServer=injectedMBeanServer.getValue();
    systemContext.registerService(MBeanServer.class.getName(),mbeanServer,null);
    systemContext.registerService(ServiceContainer.class.getName(),serviceContainer,null);
  }
 catch (  Throwable t) {
    throw new StartException("Failed to start OSGi Framework: " + framework,t);
  }
}
