{
  try {
    List<Deployment> deployments=new ArrayList<Deployment>();
    for (    OSGiModule moduleMetaData : subsystemState.getModules()) {
      ModuleIdentifier identifier=moduleMetaData.getIdentifier();
      Deployment dep=createDeployment(identifier);
      dep.setAutoStart(moduleMetaData.isStart());
      deployments.add(dep);
    }
    final BundleContext systemContext=injectedBundleContext.getValue();
    final FrameworkExt bundleManager=injectedBundleManager.getValue();
    DeployerService service=new SystemDeployerService(systemContext){
      @Override protected Bundle installBundle(      Deployment dep) throws BundleException {
        return bundleManager.installBundle(dep);
      }
    }
;
    service.deploy(deployments.toArray(new Deployment[deployments.size()]));
  }
 catch (  BundleException ex) {
    throw new StartException("Failed to auto install bundles",ex);
  }
}
