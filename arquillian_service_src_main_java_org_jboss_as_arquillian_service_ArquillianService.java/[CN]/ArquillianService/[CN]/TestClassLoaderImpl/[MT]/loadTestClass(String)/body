{
  Class<?> result=null;
  ArquillianConfig arqConfig=getConfig(className);
  if (arqConfig != null) {
    if (arqConfig.getTestClasses().contains(className)) {
      DeploymentUnit context=arqConfig.getDeploymentUnitContext();
      Module module=context.getAttachment(ModuleDeploymentProcessor.MODULE_ATTACHMENT_KEY);
      if (module != null) {
        result=module.getClassLoader().loadClass(className);
      }
      if (result == null) {
        Deployment dep=OSGiDeploymentAttachment.getAttachment(context);
        if (dep != null) {
          Bundle bundle=dep.getAttachment(Bundle.class);
          result=bundle.loadClass(className);
          BundleAssociation.setBundle(bundle);
          BundleContext sysContext=getSystemBundleContext();
          BundleContextAssociation.setBundleContext(sysContext);
          result=bundle.loadClass(className);
        }
      }
    }
  }
  if (result == null)   throw new ClassNotFoundException(className);
  return result;
}
