{
  ArquillianConfig arqConfig=getConfig(className);
  if (arqConfig != null) {
    if (arqConfig.getTestClasses().contains(className)) {
      DeploymentUnit depunit=arqConfig.getDeploymentUnitContext();
      Module module=depunit.getAttachment(Attachments.MODULE);
      Deployment osgidep=OSGiDeploymentAttachment.getDeployment(depunit);
      if (module != null && osgidep != null)       throw new IllegalStateException("Found MODULE attachment for Bundle deployment: " + depunit);
      if (module != null)       return module.getClassLoader().loadClass(className);
      if (osgidep != null) {
        Bundle bundle=osgidep.getAttachment(Bundle.class);
        BundleAssociation.setBundle(bundle);
        BundleContext sysContext=getSystemBundleContext();
        BundleContextAssociation.setBundleContext(sysContext);
        return bundle.loadClass(className);
      }
    }
  }
  throw new ClassNotFoundException(className);
}
