{
  final JBossServiceXmlDescriptor serviceXmlDescriptor=phaseContext.getAttachment(JBossServiceXmlDescriptor.ATTACHMENT_KEY);
  if (serviceXmlDescriptor == null) {
    return;
  }
  final Module module=phaseContext.getAttachment(ModuleDeploymentProcessor.MODULE_ATTACHMENT_KEY);
  if (module == null)   throw new DeploymentUnitProcessingException("Failed to get module attachment for deployment: " + phaseContext.getName());
  final ClassLoader classLoader=module.getClassLoader();
  final Value<ClassLoader> classLoaderValue=Values.immediateValue(classLoader);
  final JBossServiceXmlDescriptor.ControllerMode controllerMode=serviceXmlDescriptor.getControllerMode();
  final List<JBossServiceConfig> serviceConfigs=serviceXmlDescriptor.getServiceConfigs();
  final BatchBuilder batchBuilder=phaseContext.getBatchBuilder();
  for (  final JBossServiceConfig serviceConfig : serviceConfigs) {
    addService(batchBuilder,serviceConfig,classLoaderValue);
  }
}
