{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final JBossServiceXmlDescriptor serviceXmlDescriptor=deploymentUnit.getAttachment(JBossServiceXmlDescriptor.ATTACHMENT_KEY);
  if (serviceXmlDescriptor == null) {
    return;
  }
  final Module module=deploymentUnit.getAttachment(Attachments.MODULE);
  if (module == null)   throw new DeploymentUnitProcessingException("Failed to get module attachment for " + phaseContext.getDeploymentUnit());
  final ClassLoader classLoader=module.getClassLoader();
  final Value<ClassLoader> classLoaderValue=Values.immediateValue(classLoader);
  final JBossServiceXmlDescriptor.ControllerMode controllerMode=serviceXmlDescriptor.getControllerMode();
  final List<JBossServiceConfig> serviceConfigs=serviceXmlDescriptor.getServiceConfigs();
  final ServiceTarget target=phaseContext.getServiceTarget();
  for (  final JBossServiceConfig serviceConfig : serviceConfigs) {
    addService(target,serviceConfig,classLoaderValue);
  }
}
