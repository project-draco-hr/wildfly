{
  final Reference reference=(Reference)obj;
  final ServiceNameRefAdr nameAdr=(ServiceNameRefAdr)reference.get("srof");
  if (nameAdr == null) {
    throw MESSAGES.invalidContextReference("srof");
  }
  final ServiceName serviceName=(ServiceName)nameAdr.getContent();
  final ServiceController<?> controller;
  try {
    controller=serviceRegistry.getRequiredService(serviceName);
  }
 catch (  ServiceNotFoundException e) {
    throw MESSAGES.cannotResolveService(serviceName);
  }
  final StabilityMonitor monitor=new StabilityMonitor();
  monitor.addController(controller);
  try {
    monitor.awaitStability();
  }
 catch (  InterruptedException e) {
    throw MESSAGES.threadInterrupt(serviceName);
  }
 finally {
    monitor.removeController(controller);
  }
switch (controller.getState()) {
case UP:
    return getObjectInstance(controller.getValue(),obj,name,nameCtx,environment);
case START_FAILED:
  throw MESSAGES.cannotResolveService(serviceName,getClass().getName(),"START_FAILED");
case REMOVED:
throw MESSAGES.cannotResolveService(serviceName,getClass().getName(),"START_FAILED");
}
throw MESSAGES.cannotResolveServiceBug(serviceName,getClass().getName(),controller.getState().toString());
}
