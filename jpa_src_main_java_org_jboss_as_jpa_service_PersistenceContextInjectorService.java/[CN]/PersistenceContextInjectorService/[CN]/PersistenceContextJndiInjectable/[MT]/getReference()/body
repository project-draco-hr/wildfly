{
  PersistenceUnitService service=(PersistenceUnitService)deploymentUnit.getServiceRegistry().getRequiredService(puServiceName).getValue();
  EntityManagerFactory emf=service.getEntityManagerFactory();
  if (type.equals(PersistenceContextType.TRANSACTION)) {
    return new ValueManagedReference(new ImmediateValue<Object>(new TransactionScopedEntityManager(unitName,properties,emf)));
  }
 else {
    return new ValueManagedReference(new ImmediateValue<Object>(new ExtendedEntityManager(null)));
  }
}
