{
  SecurityContext sc=null;
  if (exchange != null) {
    sc=exchange.getAttachment(UndertowSecurityAttachments.SECURITY_CONTEXT_ATTACHMENT);
  }
  if (sc == null) {
    sc=SecurityActions.createSecurityContext(securityDomain);
    if (exchange != null) {
      exchange.putAttachment(UndertowSecurityAttachments.SECURITY_CONTEXT_ATTACHMENT,sc);
    }
  }
  SecurityActions.setSecurityContextOnAssociation(sc);
  final MappingManager mappingManager=securityDomainContext.getMappingManager();
  if (mappingManager != null) {
    if (WildFlySecurityManager.isChecking()) {
      WildFlySecurityManager.doUnchecked(new PrivilegedAction<Object>(){
        @Override public Object run(){
          MappingContext<RoleGroup> mc=mappingManager.getMappingContext(MappingType.ROLE.name());
          if (mc != null && mc.hasModules()) {
            SecurityRolesAssociation.setSecurityRoles(principleVsRoleMap);
          }
          return null;
        }
      }
);
    }
 else {
      MappingContext<RoleGroup> mc=mappingManager.getMappingContext(MappingType.ROLE.name());
      if (mc != null && mc.hasModules()) {
        SecurityRolesAssociation.setSecurityRoles(principleVsRoleMap);
      }
    }
  }
  return TEAR_DOWN_ACTION;
}
