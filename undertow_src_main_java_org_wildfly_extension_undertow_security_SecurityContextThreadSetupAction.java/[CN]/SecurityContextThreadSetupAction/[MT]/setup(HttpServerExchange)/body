{
  if (exchange == null) {
    return null;
  }
  SecurityContext sc=exchange.getAttachment(UndertowSecurityAttachments.SECURITY_CONTEXT_ATTACHMENT);
  if (sc == null) {
    sc=SecurityActions.createSecurityContext(securityDomain);
    exchange.putAttachment(UndertowSecurityAttachments.SECURITY_CONTEXT_ATTACHMENT,sc);
  }
  SecurityActions.setSecurityContextOnAssociation(sc);
  final MappingManager mappingManager=securityDomainContext.getMappingManager();
  if (mappingManager != null) {
    MappingContext<RoleGroup> mc=mappingManager.getMappingContext(MappingType.ROLE.name());
    if (mc != null && mc.hasModules()) {
      SecurityRolesAssociation.setSecurityRoles(principleVsRoleMap);
    }
  }
  return TEAR_DOWN_ACTION;
}
