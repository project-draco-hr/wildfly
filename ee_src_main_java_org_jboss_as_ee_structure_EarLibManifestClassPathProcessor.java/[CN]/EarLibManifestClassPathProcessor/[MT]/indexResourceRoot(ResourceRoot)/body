{
  final VirtualFile virtualFile=resourceRoot.getRoot();
  final Indexer indexer=new Indexer();
  try {
    final VisitorAttributes visitorAttributes=new VisitorAttributes();
    visitorAttributes.setLeavesOnly(true);
    final List<VirtualFile> classChildren=virtualFile.getChildren(new SuffixMatchFilter(".class",visitorAttributes));
    for (    VirtualFile classFile : classChildren) {
      InputStream inputStream=null;
      try {
        inputStream=classFile.openStream();
        indexer.index(inputStream);
      }
 catch (      Exception e) {
        logger.warn("Could not index class " + classFile.getPathNameRelativeTo(virtualFile) + " in archive '"+ virtualFile+ "'",e);
      }
 finally {
        VFSUtils.safeClose(inputStream);
      }
    }
    final Index index=indexer.complete();
    resourceRoot.putAttachment(Attachments.ANNOTATION_INDEX,index);
    logger.tracef("Generated index for archive %s",virtualFile);
  }
 catch (  Throwable t) {
    throw new DeploymentUnitProcessingException("Failed to index deployment root for annotations",t);
  }
}
