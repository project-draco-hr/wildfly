{
  if (context.hasFailureDescription()) {
    context.setRollbackOnly();
    context.completeStep();
    return;
  }
  boolean pushToServers=!domainOperationContext.hasHostLevelFailures();
  if (pushToServers) {
    ModelNode ourResult=domainOperationContext.getCoordinatorResult();
    if (ourResult.has(FAILURE_DESCRIPTION)) {
      if (trace) {
        HOST_CONTROLLER_LOGGER.tracef("coordinator failed: %s",ourResult);
      }
      pushToServers=false;
      domainOperationContext.setCompleteRollback(true);
    }
 else {
      if (trace) {
        HOST_CONTROLLER_LOGGER.tracef("coordinator succeeded: %s",ourResult);
      }
      for (      ModelNode hostResult : domainOperationContext.getHostControllerResults().values()) {
        if (hostResult.has(FAILURE_DESCRIPTION)) {
          if (trace) {
            HOST_CONTROLLER_LOGGER.tracef("host failed: %s",hostResult);
          }
          pushToServers=false;
          domainOperationContext.setCompleteRollback(true);
          break;
        }
      }
    }
  }
  if (pushToServers) {
    domainOperationContext.setCompleteRollback(false);
    final Map<ServerIdentity,ServerRolloutTaskHandler.ServerExecutedRequest> submittedTasks=new HashMap<ServerIdentity,ServerRolloutTaskHandler.ServerExecutedRequest>();
    final List<ServerRolloutTaskHandler.ServerPreparedResponse> preparedResults=new ArrayList<ServerRolloutTaskHandler.ServerPreparedResponse>();
    final ServerRolloutTaskHandler rolloutHandler=new ServerRolloutTaskHandler(submittedTasks,preparedResults);
    try {
      pushToServers(context,rolloutHandler);
      context.completeStep();
    }
  finally {
      boolean completeRollback=domainOperationContext.isCompleteRollback();
      final String localHostName=domainOperationContext.getLocalHostInfo().getLocalHostName();
      for (      final ServerRolloutTaskHandler.ServerPreparedResponse preparedResult : preparedResults) {
        boolean rollback=completeRollback || domainOperationContext.isServerGroupRollback(preparedResult.getServerGroupName());
        if (!preparedResult.finalizeTransaction(!rollback)) {
          final ServerIdentity identity=preparedResult.getServerIdentity();
          try {
            final ModelNode result=preparedResult.getPreparedOperation().getPreparedResult();
            ProxyController proxy=hostProxies.get(identity.getHostName());
            if (proxy == null) {
              if (localHostName.equals(identity.getHostName())) {
                proxy=serverProxies.get(identity.getServerName());
                if (proxy == null) {
                  if (trace) {
                    HOST_CONTROLLER_LOGGER.tracef("No proxy for %s",identity);
                  }
                  continue;
                }
              }
            }
            final Future<ModelNode> future=executorService.submit(new ServerRequireRestartTask(identity,proxy,result));
            submittedTasks.put(identity,new ServerRolloutTaskHandler.ServerExecutedRequest(identity,future));
          }
 catch (          Exception ignore) {
          }
        }
      }
      boolean interrupted=false;
      try {
        for (        Map.Entry<ServerIdentity,ServerRolloutTaskHandler.ServerExecutedRequest> entry : submittedTasks.entrySet()) {
          Future<ModelNode> future=entry.getValue().getFinalResult();
          try {
            ModelNode finalResult=future.isCancelled() ? getCancelledResult() : future.get();
            domainOperationContext.addServerResult(entry.getKey(),finalResult);
          }
 catch (          InterruptedException e) {
            interrupted=true;
            HOST_CONTROLLER_LOGGER.interruptedAwaitingFinalResponse(entry.getKey().getServerName(),entry.getKey().getHostName());
          }
catch (          ExecutionException e) {
            HOST_CONTROLLER_LOGGER.caughtExceptionAwaitingFinalResponse(e.getCause(),entry.getKey().getServerName(),entry.getKey().getHostName());
          }
        }
      }
  finally {
        if (interrupted) {
          Thread.currentThread().interrupt();
        }
      }
    }
  }
 else {
    reportHostFailures(context,operation);
    context.completeStep();
  }
}
