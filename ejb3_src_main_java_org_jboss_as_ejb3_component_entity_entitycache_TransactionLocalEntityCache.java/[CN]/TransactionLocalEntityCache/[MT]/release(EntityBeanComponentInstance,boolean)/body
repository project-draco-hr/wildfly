{
  if (instance.isDiscarded()) {
    return;
  }
  if (instance.getPrimaryKey() == null) {
    return;
  }
  if (!success && instance.isRemoved()) {
    instance.setRemoved(false);
  }
  final Object key=transactionSynchronizationRegistry.getTransactionKey();
  if (key == null) {
    instance.passivate();
    component.releaseEntityBeanInstance(instance);
    return;
  }
  final Map<Object,CacheEntry> map=cache.get(key);
  if (map != null) {
    final CacheEntry cacheEntry=map.get(instance.getPrimaryKey());
    if (cacheEntry == null) {
      throw EjbLogger.EJB3_LOGGER.entityBeanInstanceNotFoundInCache(instance);
    }
    if (cacheEntry.referenceCount.decrementAndGet() <= 0) {
      final Object pk=instance.getPrimaryKey();
      try {
        instance.passivate();
        component.releaseEntityBeanInstance(instance);
      }
  finally {
        map.remove(pk);
      }
    }
  }
}
