{
  deployer.undeploy(DEPLOYMENT_2);
  controller.stop(CONTAINER_2);
  DefaultHttpClient client=HttpClientUtils.relaxedCookieHttpClient();
  String url1=baseURL1.toString() + "service";
  String url2=baseURL2.toString() + "service";
  System.out.println("URLs are: " + url1 + ", "+ url2);
  try {
    HttpResponse response=client.execute(new HttpGet(url1));
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(NODE_1,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    controller.start(CONTAINER_2);
    deployer.deploy(DEPLOYMENT_2);
    response=tryGet(client,url1);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(MyServiceContextListener.PREFERRED_NODE,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    response=tryGet(client,url2);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(MyServiceContextListener.PREFERRED_NODE,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    controller.stop(CONTAINER_2);
    response=tryGet(client,url1);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(NODE_1,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    controller.start(CONTAINER_2);
    response=tryGet(client,url1);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(MyServiceContextListener.PREFERRED_NODE,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    response=tryGet(client,url2);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(MyServiceContextListener.PREFERRED_NODE,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    controller.stop(CONTAINER_1);
    response=tryGet(client,url2);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(NODE_2,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    controller.start(CONTAINER_1);
    response=tryGet(client,url1);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(MyServiceContextListener.PREFERRED_NODE,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
    response=tryGet(client,url2);
    Assert.assertEquals(HttpServletResponse.SC_OK,response.getStatusLine().getStatusCode());
    Assert.assertEquals(MyServiceContextListener.PREFERRED_NODE,response.getFirstHeader("node").getValue());
    response.getEntity().getContent().close();
  }
  finally {
    client.getConnectionManager().shutdown();
    deployer.undeploy(DEPLOYMENT_1);
    controller.stop(CONTAINER_1);
    deployer.undeploy(DEPLOYMENT_2);
    controller.stop(CONTAINER_2);
  }
}
