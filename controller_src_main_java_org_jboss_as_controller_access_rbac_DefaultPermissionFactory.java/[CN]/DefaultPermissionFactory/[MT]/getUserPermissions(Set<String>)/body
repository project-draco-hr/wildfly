{
  configureRolePermissions(false);
  ManagementPermissionCollection simple=null;
  Map<Action.ActionEffect,CombinationManagementPermission> combined=null;
  for (  String roleName : roles) {
    if (combinationPolicy == CombinationPolicy.REJECTING && simple != null) {
      throw ControllerMessages.MESSAGES.illegalMultipleRoles();
    }
    ManagementPermissionCollection role;
synchronized (this) {
      role=permissionsByRole.get(getOfficialForm(roleName));
    }
    if (role == null) {
      throw ControllerMessages.MESSAGES.unknownRole(roleName);
    }
    if (simple == null) {
      simple=role;
    }
 else {
      if (combined == null) {
        combined=new HashMap<Action.ActionEffect,CombinationManagementPermission>();
        Enumeration<Permission> permissionEnumeration=simple.elements();
        while (permissionEnumeration.hasMoreElements()) {
          ManagementPermission mperm=(ManagementPermission)permissionEnumeration.nextElement();
          Action.ActionEffect actionEffect=mperm.getActionEffect();
          CombinationManagementPermission cmp=new CombinationManagementPermission(combinationPolicy,actionEffect);
          cmp.addUnderlyingPermission(mperm);
          combined.put(actionEffect,cmp);
        }
      }
      Enumeration<Permission> permissionEnumeration=role.elements();
      while (permissionEnumeration.hasMoreElements()) {
        ManagementPermission mperm=(ManagementPermission)permissionEnumeration.nextElement();
        Action.ActionEffect actionEffect=mperm.getActionEffect();
        CombinationManagementPermission cmp=combined.get(actionEffect);
        if (cmp == null) {
          cmp=new CombinationManagementPermission(combinationPolicy,actionEffect);
          combined.put(actionEffect,cmp);
        }
        cmp.addUnderlyingPermission(mperm);
      }
    }
  }
  PermissionCollection result;
  if (combined == null) {
    result=simple != null ? simple : NO_PERMISSIONS;
  }
 else {
    result=new ManagementPermissionCollection(CombinationManagementPermission.class);
    for (    CombinationManagementPermission cmp : combined.values()) {
      result.add(cmp);
    }
  }
  return result;
}
