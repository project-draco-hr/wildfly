{
  if (permissionsByRole.containsKey(roleName)) {
    throw new IllegalStateException(String.format("role %s is already registered",roleName));
  }
  ManagementPermissionCollection baseCollection=permissionsByRole.get(base.toString());
  if (baseCollection == null) {
    throw new IllegalArgumentException(String.format("Unknown base role %s",base));
  }
  ManagementPermissionCollection scopedPermissions=null;
  Enumeration<Permission> permissionEnumeration=baseCollection.elements();
  while (permissionEnumeration.hasMoreElements()) {
    ManagementPermission basePerm=(ManagementPermission)permissionEnumeration.nextElement();
    ManagementPermission scopedPerm=basePerm.createScopedPermission(constraint);
    if (scopedPermissions == null) {
      scopedPermissions=(ManagementPermissionCollection)scopedPerm.newPermissionCollection();
    }
    scopedPermissions.add(scopedPerm);
  }
  permissionsByRole.put(roleName,scopedPermissions);
  scopedBaseMap.put(roleName,new ScopedBase(base,constraint));
}
