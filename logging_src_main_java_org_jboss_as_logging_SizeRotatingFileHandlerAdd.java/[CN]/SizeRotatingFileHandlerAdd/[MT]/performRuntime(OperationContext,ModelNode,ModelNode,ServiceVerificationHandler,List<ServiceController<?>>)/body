{
  final PathAddress address=PathAddress.pathAddress(operation.get(OP_ADDR));
  final String name=address.getLastElement().getValue();
  final ServiceTarget serviceTarget=context.getServiceTarget();
  try {
    final SizeRotatingFileHandlerService service=new SizeRotatingFileHandlerService();
    if (operation.hasDefined(APPEND))     service.setAppend(operation.get(APPEND).asBoolean());
    final ServiceBuilder<Handler> serviceBuilder=serviceTarget.addService(LogServices.handlerName(name),service);
    if (operation.hasDefined(FILE)) {
      final HandlerFileService fileService=new HandlerFileService(operation.get(FILE,PATH).asString());
      final ServiceBuilder<?> fileBuilder=serviceTarget.addService(LogServices.handlerFileName(name),fileService);
      if (operation.get(FILE).hasDefined(CommonAttributes.RELATIVE_TO)) {
        fileBuilder.addDependency(AbstractPathService.pathNameOf(operation.get(FILE,RELATIVE_TO).asString()),String.class,fileService.getRelativeToInjector());
      }
      fileBuilder.setInitialMode(ServiceController.Mode.ACTIVE).install();
      serviceBuilder.addDependency(LogServices.handlerFileName(name),String.class,service.getFileNameInjector());
    }
    service.setLevel(Level.parse(operation.get(LEVEL).asString()));
    final Boolean autoFlush=operation.get(AUTOFLUSH).asBoolean();
    if (autoFlush != null)     service.setAutoflush(autoFlush.booleanValue());
    if (operation.hasDefined(ENCODING))     service.setEncoding(operation.get(ENCODING).asString());
    service.setFormatterSpec(AbstractFormatterSpec.Factory.create(operation));
    if (operation.hasDefined(MAX_BACKUP_INDEX))     service.setMaxBackupIndex(operation.get(MAX_BACKUP_INDEX).asInt());
    long rotateSize=DEFAULT_ROTATE_SIZE;
    if (operation.hasDefined(ROTATE_SIZE)) {
      try {
        rotateSize=LoggingSubsystemParser.parseSize(operation.get(ROTATE_SIZE).asString());
      }
 catch (      Throwable t) {
        throw new OperationFailedException(new ModelNode().set(t.getLocalizedMessage()));
      }
    }
    service.setRotateSize(rotateSize);
    serviceBuilder.addListener(verificationHandler);
    serviceBuilder.setInitialMode(ServiceController.Mode.ACTIVE);
    newControllers.add(serviceBuilder.install());
  }
 catch (  Throwable t) {
    throw new OperationFailedException(new ModelNode().set(t.getLocalizedMessage()));
  }
}
