{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final WeldDeploymentMetadata cdiDeploymentMetadata=deploymentUnit.getAttachment(WeldDeploymentMetadata.ATTACHMENT_KEY);
  if (!WeldDeploymentMarker.isWeldDeployment(deploymentUnit)) {
    return;
  }
  boolean isolatedModule=WarDeploymentMarker.isWarDeployment(deploymentUnit);
  log.info("Processing CDI deployment: " + phaseContext.getDeploymentUnit().getName());
  final Map<ResourceRoot,Index> indexes=AnnotationIndexUtils.getAnnotationIndexes(deploymentUnit);
  final Module module=phaseContext.getDeploymentUnit().getAttachment(Attachments.MODULE);
  boolean rootArchiveFound=false;
  if (cdiDeploymentMetadata != null) {
    for (    BeanArchiveMetadata beanArchiveMetadata : cdiDeploymentMetadata.getBeanArchiveMetadata()) {
      BeanDeploymentArchiveImpl bda=createBeanDeploymentArchive(indexes.get(beanArchiveMetadata.getResourceRoot()),beanArchiveMetadata,module,isolatedModule);
      BeanDeploymentArchiveImpl.attachToDeployment(deploymentUnit,bda);
      if (beanArchiveMetadata.isDeploymentRoot()) {
        rootArchiveFound=true;
        BeanDeploymentArchiveImpl.attachRootArchiveToDeployment(deploymentUnit,bda);
      }
    }
  }
  if (!rootArchiveFound) {
    BeanDeploymentArchiveImpl bda=new BeanDeploymentArchiveImpl(Collections.<String>emptySet(),BeansXml.EMPTY_BEANS_XML,module,deploymentUnit.getName(),isolatedModule);
    BeanDeploymentArchiveImpl.attachToDeployment(deploymentUnit,bda);
    BeanDeploymentArchiveImpl.attachRootArchiveToDeployment(deploymentUnit,bda);
  }
}
