{
  HttpSession session=req.getSession(true);
  Stateful bean=(Stateful)session.getAttribute("bean");
  if (bean == null) {
    try {
      bean=new LocalEJBDirectory("stateful").lookupStateful(StatefulBean.class,Stateful.class);
    }
 catch (    NamingException e) {
      throw new ServletException(e);
    }
  }
  String command=req.getParameter("command");
  log.info(StatefulServlet.class.getName() + ": command = " + command);
  String answer=null;
  if ("createEmployee".equals(command)) {
    bean.createEmployee("Tom Brady","New England Patriots",1);
    answer=bean.getEmployee(1).getName();
  }
 else   if ("getEmployee".equals(command)) {
    Employee employee=bean.getEmployee(1);
    if (employee == null) {
      throw new ServletException("couldn't load Employee entity (with id=1) from database");
    }
    answer=employee.getName();
  }
 else   if ("deleteEmployee".equals(command)) {
    bean.deleteEmployee(1);
    answer=command;
  }
 else   if ("getEmployeesInSecondLevelCache".equals(command)) {
    long count=bean.getEmployeesInMemory();
    if (count == -1) {
      throw new ServletException("couldn't get number of employees in second level cache");
    }
    answer="" + count;
  }
 else   if ("getSecondBeanEmployee".equals(command)) {
    Employee employee=bean.getSecondBeanEmployee(1);
    answer=employee.getName();
  }
 else   if ("destroy".equals(command)) {
    bean.destroy();
    answer=command;
  }
 else   if ("flush".equals(command)) {
    bean.flush();
  }
 else   if ("echo".equals(command)) {
    bean.echo(req.getParameter("message"));
  }
 else   if ("clear".equals(command)) {
    bean.clear();
  }
 else   if ("deleteEmployeeViaJDBC".equals(command)) {
    int deleted=bean.executeNativeSQL("delete from Employee where id=1");
    if (deleted < 1) {
      throw new ServletException("couldn't delete entity in database, deleted row count =" + deleted);
    }
  }
 else {
    throw new ServletException("unknown command name=" + command);
  }
  if (answer != null) {
    resp.setHeader("answer",answer);
  }
  resp.getWriter().write("Success");
  session.setAttribute("bean",bean);
  log.info(StatefulServlet.class.getName() + ": command = " + command+ " finished");
}
