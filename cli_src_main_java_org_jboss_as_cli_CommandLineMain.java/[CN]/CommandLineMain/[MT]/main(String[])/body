{
  final jline.ConsoleReader console=new jline.ConsoleReader();
  console.setUseHistory(true);
  console.addCompletor(new CommandCompleter(handlers.keySet()));
  final CommandContextImpl cmdCtx=new CommandContextImpl(console);
  SecurityActions.addShutdownHook(new Thread(new Runnable(){
    @Override public void run(){
      StreamUtils.safeClose(cmdCtx.client);
      cmdCtx.log("closed");
    }
  }
));
  console.addCompletor(new OperationRequestCompleter(cmdCtx));
  cmdCtx.log("You are disconnected at the moment." + " Type 'connect' to connect to the server or" + " 'help' for the list of supported commands.");
  while (!cmdCtx.terminate) {
    String line=console.readLine("[" + cmdCtx.getPrefixFormatter().format(cmdCtx.getPrefix()) + "] ");
    if (line.isEmpty()) {
      continue;
    }
    if (isOperation(line)) {
      final String opReq;
      if (line.startsWith("./")) {
        opReq=line.substring(2);
      }
 else {
        opReq=line;
      }
      cmdCtx.cmdArgs=opReq;
      operationHandler.handle(cmdCtx);
    }
 else {
      String cmd=line.toLowerCase();
      cmdCtx.cmdArgs=null;
      for (int i=0; i < cmd.length(); ++i) {
        if (Character.isWhitespace(cmd.charAt(i))) {
          cmdCtx.cmdArgs=cmd.substring(i + 1).trim();
          cmd=cmd.substring(0,i);
        }
      }
      CommandHandler handler=handlers.get(cmd);
      if (handler != null) {
        handler.handle(cmdCtx);
      }
 else {
        cmdCtx.log("Unexpected command '" + line + "'. Type 'help' for the list of supported commands.");
      }
    }
  }
}
