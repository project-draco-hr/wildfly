{
  final jline.ConsoleReader console=new jline.ConsoleReader();
  console.setUseHistory(true);
  final CommandContextImpl cmdCtx=new CommandContextImpl(console);
  SecurityActions.addShutdownHook(new Thread(new Runnable(){
    @Override public void run(){
      StreamUtils.safeClose(cmdCtx.client);
      cmdCtx.log("closed");
    }
  }
));
  cmdCtx.log("You are disconnected at the moment." + " Type /connect to connect to the server or" + " /help for the list of supported commands.");
  while (!cmdCtx.terminate) {
    String line=console.readLine("[" + cmdCtx.getPrefixFormatter().format(cmdCtx.getPrefix()) + "] ");
    if (line.isEmpty()) {
      continue;
    }
    if (line.charAt(0) == '/') {
      String cmd=line.substring(1).toLowerCase();
      cmdCtx.cmdArgs=null;
      for (int i=0; i < cmd.length(); ++i) {
        if (Character.isWhitespace(cmd.charAt(i))) {
          cmdCtx.cmdArgs=cmd.substring(i + 1).trim();
          cmd=cmd.substring(0,i);
        }
      }
      CommandHandler handler=handlers.get(cmd);
      if (handler != null) {
        handler.handle(cmdCtx);
      }
 else {
        cmdCtx.log("Unexpected command '" + line + "'. Type /help for the list of supported commands.");
      }
    }
 else {
      cmdCtx.cmdArgs=line;
      operationHandler.handle(cmdCtx);
    }
  }
}
