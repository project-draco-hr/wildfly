{
  if (line.isEmpty()) {
    return;
  }
  if (line.charAt(0) == '#') {
    return;
  }
  if (isOperation(line)) {
    cmdCtx.resetArgs(line);
    DefaultOperationRequestBuilder builder=new DefaultOperationRequestBuilder(cmdCtx.getPrefix());
    ModelNode request;
    try {
      cmdCtx.getOperationRequestParser().parse(line,builder);
      request=builder.buildRequest();
    }
 catch (    CommandFormatException e) {
      cmdCtx.printLine(e.getLocalizedMessage());
      return;
    }
    if (cmdCtx.isBatchMode()) {
      StringBuilder op=new StringBuilder();
      op.append(cmdCtx.getPrefixFormatter().format(builder.getAddress()));
      op.append(line.substring(line.indexOf(':')));
      DefaultBatchedCommand batchedCmd=new DefaultBatchedCommand(op.toString(),request);
      Batch batch=cmdCtx.getBatchManager().getActiveBatch();
      batch.add(batchedCmd);
      cmdCtx.printLine("#" + batch.size() + " "+ batchedCmd.getCommand());
    }
 else {
      cmdCtx.set("OP_REQ",request);
      if (builder.getOutputTarget() != null) {
        cmdCtx.setOutputTarget(builder.getOutputTarget());
      }
      try {
        cmdCtx.operationHandler.handle(cmdCtx);
      }
  finally {
        cmdCtx.setOutputTarget(null);
        cmdCtx.set("OP_REQ",null);
      }
    }
  }
 else {
    try {
      cmdCtx.parseArgs(line);
    }
 catch (    CommandFormatException e1) {
      cmdCtx.printLine(e1.getLocalizedMessage());
      return;
    }
    CommandHandler handler=cmdRegistry.getCommandHandler(cmdCtx.cmd.toLowerCase());
    if (handler != null) {
      if (cmdCtx.isBatchMode() && handler.isBatchMode()) {
        if (!(handler instanceof OperationCommand)) {
          cmdCtx.printLine("The command is not allowed in a batch.");
        }
 else {
          try {
            ModelNode request=((OperationCommand)handler).buildRequest(cmdCtx);
            BatchedCommand batchedCmd=new DefaultBatchedCommand(line,request);
            Batch batch=cmdCtx.getBatchManager().getActiveBatch();
            batch.add(batchedCmd);
            cmdCtx.printLine("#" + batch.size() + " "+ batchedCmd.getCommand());
          }
 catch (          CommandFormatException e) {
            cmdCtx.printLine("Failed to add to batch: " + e.getLocalizedMessage());
          }
        }
      }
 else {
        if (cmdCtx.parsedCmd.getOutputTarget() != null) {
          cmdCtx.setOutputTarget(cmdCtx.parsedCmd.getOutputTarget());
        }
        try {
          handler.handle(cmdCtx);
        }
 catch (        CommandFormatException e) {
          cmdCtx.printLine(e.getLocalizedMessage());
        }
 finally {
          cmdCtx.setOutputTarget(null);
        }
      }
      cmdCtx.resetArgs(null);
    }
 else {
      cmdCtx.printLine("Unexpected command '" + line + "'. Type 'help' for the list of supported commands.");
    }
  }
}
