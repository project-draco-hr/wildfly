{
  if (line.isEmpty()) {
    return;
  }
  if (isOperation(line)) {
    cmdCtx.setArgs(null,line);
    if (cmdCtx.isBatchMode()) {
      OperationRequestAddress address=new DefaultOperationRequestAddress(cmdCtx.getPrefix());
      DefaultOperationCallbackHandler handler=new DefaultOperationCallbackHandler(address);
      try {
        cmdCtx.getOperationRequestParser().parse(line,handler);
        if (!handler.hasOperationName()) {
          cmdCtx.printLine("The request is missing the operation name");
        }
 else {
          StringBuilder op=new StringBuilder();
          op.append(cmdCtx.getPrefixFormatter().format(handler.getAddress()));
          op.append(line.substring(line.indexOf(':')));
          cmdCtx.addToBatch(op.toString());
        }
      }
 catch (      CommandFormatException e) {
        cmdCtx.printLine(e.getLocalizedMessage());
      }
    }
 else {
      cmdCtx.operationHandler.handle(cmdCtx);
    }
  }
 else {
    String cmd=line;
    String cmdArgs=null;
    for (int i=0; i < cmd.length(); ++i) {
      if (Character.isWhitespace(cmd.charAt(i))) {
        cmdArgs=cmd.substring(i + 1).trim();
        cmd=cmd.substring(0,i);
        break;
      }
    }
    cmdCtx.setArgs(cmd,cmdArgs);
    CommandHandler handler=cmdRegistry.getCommandHandler(cmd.toLowerCase());
    if (handler != null) {
      if (cmdCtx.isBatchMode() && handler.isBatchMode()) {
        cmdCtx.addToBatch(line);
      }
 else {
        handler.handle(cmdCtx);
      }
    }
 else {
      cmdCtx.printLine("Unexpected command '" + line + "'. Type 'help' for the list of supported commands.");
    }
  }
}
