{
  final State state=stateUpdater.getAndSet(this,State.ROLLBACK_ONLY);
  if (state == State.COMPLETED || state == State.ROLLBACK_ONLY) {
    return false;
  }
  PatchingTaskContext.Mode currentMode=this.mode;
  mode=PatchingTaskContext.Mode.UNDO;
  final PatchContentLoader loader=PatchContentLoader.create(miscBackup,null,null);
  undoChanges(identityEntry,loader);
  if (state == State.INVALIDATE || currentMode == PatchingTaskContext.Mode.ROLLBACK) {
    final PatchingTaskContext.Mode mode=currentMode == PatchingTaskContext.Mode.APPLY ? PatchingTaskContext.Mode.ROLLBACK : PatchingTaskContext.Mode.APPLY;
    for (    final File file : moduleInvalidations) {
      try {
        PatchModuleInvalidationUtils.processFile(file,mode);
      }
 catch (      Exception e) {
        PatchLogger.ROOT_LOGGER.debugf(e,"failed to restore state for %s",file);
      }
    }
  }
  return true;
}
