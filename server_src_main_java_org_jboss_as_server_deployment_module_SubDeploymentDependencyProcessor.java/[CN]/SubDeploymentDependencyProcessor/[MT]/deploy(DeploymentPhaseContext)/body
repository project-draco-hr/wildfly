{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  final DeploymentUnit parent=deploymentUnit.getParent();
  if (parent == null) {
    return;
  }
  final ModuleSpecification moduleSpec=deploymentUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
  final AttachmentList<DeploymentUnit> subDeployments=parent.getAttachment(Attachments.SUB_DEPLOYMENTS);
  final ModuleLoader moduleLoader=deploymentUnit.getAttachment(Attachments.SERVICE_MODULE_LOADER);
  final ModuleIdentifier parentModule=parent.getAttachment(Attachments.MODULE_IDENTIFIER);
  if (parentModule != null) {
    moduleSpec.addDependency(new ModuleDependency(moduleLoader,parentModule,false,false,true));
  }
  for (  DeploymentUnit subDeployment : subDeployments) {
    if (subDeployment.getServiceName().equals(deploymentUnit.getServiceName())) {
      continue;
    }
    if (PrivateSubDeploymentMarker.isPrivate(subDeployment)) {
      continue;
    }
    ModuleDependency moduleDependency=new ModuleDependency(moduleLoader,subDeployment.getAttachment(Attachments.MODULE_IDENTIFIER),false,false,true);
    moduleSpec.addDependency(moduleDependency);
  }
}
