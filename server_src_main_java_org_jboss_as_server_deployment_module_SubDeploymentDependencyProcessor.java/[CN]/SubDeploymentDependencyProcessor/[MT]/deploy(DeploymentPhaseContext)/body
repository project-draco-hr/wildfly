{
  final DeploymentUnit deploymentUnit=phaseContext.getDeploymentUnit();
  if (deploymentUnit.getParent() == null) {
    return;
  }
  final ModuleSpecification moduleSpec=deploymentUnit.getAttachment(Attachments.MODULE_SPECIFICATION);
  final AttachmentList<DeploymentUnit> subDeployments=deploymentUnit.getParent().getAttachment(Attachments.SUB_DEPLOYMENTS);
  final ModuleLoader moduleLoader=deploymentUnit.getAttachment(Attachments.SERVICE_MODULE_LOADER);
  for (  DeploymentUnit subDeployment : subDeployments) {
    if (subDeployment.getServiceName().equals(deploymentUnit.getServiceName())) {
      continue;
    }
    if (PrivateSubDeploymentMarker.isPrivate(subDeployment)) {
      continue;
    }
    ModuleDependency moduleDependency=new ModuleDependency(moduleLoader,subDeployment.getAttachment(Attachments.MODULE_IDENTIFIER),false,false,true);
    moduleSpec.addDependency(moduleDependency);
  }
}
